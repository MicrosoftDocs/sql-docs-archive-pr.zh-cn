---
title: CDC 控制任务 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
f1_keywords:
- sql12.ssis.designer.cdccontroltask.f1
ms.assetid: 6404dc7f-550c-47cc-b901-c072742f430a
author: chugugrace
ms.author: chugu
ms.openlocfilehash: 36f98a02842353fd5196432738f4ebd8b2efb46c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87585936"
---
# <a name="cdc-control-task"></a><span data-ttu-id="e4f9a-102">CDC 控制任务</span><span class="sxs-lookup"><span data-stu-id="e4f9a-102">CDC Control Task</span></span>
  <span data-ttu-id="e4f9a-103">CDC 控制任务用于控制变更数据捕获 (CDC) 包的生命周期。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-103">The CDC Control task is used to control the life cycle of change data capture (CDC) packages.</span></span> <span data-ttu-id="e4f9a-104">它处理 CDC 包与初始加载包的同步以及在运行 CDC 包时处理的日志序列号 (LSN) 范围的管理。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-104">It handles CDC package synchronization with the initial load package, the management of Log Sequence Number (LSN) ranges that are processed in a run of a CDC package.</span></span> <span data-ttu-id="e4f9a-105">此外，CDC 控制任务还处理错误情况和恢复。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-105">In addition, the CDC Control task deals with error scenarios and recovery.</span></span>  
  
 <span data-ttu-id="e4f9a-106">CDC 控制任务在 SSIS 包变量中维护 CDC 包的状态，并且还可以将其保存在某一数据库表中，以便跨多个包激活和在一起执行某一公共 CDC 进程的多个包之间（例如，一个任务可负责初始加载，而另一个任务则用于滴送处理更新）维护该状态。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-106">The CDC Control task maintains the state of the CDC package in an SSIS package variable and it can also persist it in a database table so that the state is maintained across package activations and between multiple packages that together perform a common CDC process (for example, one task may be responsible for the initial loading and the other for the trickle-feed updates).</span></span>  
  
 <span data-ttu-id="e4f9a-107">CDC 控制任务支持两组操作。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-107">The CDC Control task supports two groups of operations.</span></span> <span data-ttu-id="e4f9a-108">一组处理初始加载和更改处理的同步，另一组为 LSN 包的运行管理 CDC 的更改处理范围并且跟踪成功处理的情况。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-108">One group handles the synchronization of initial load and change processing, and the other manages the change-processing range of LSNs for a run of a CDC package and keeps track of what was processed successfully.</span></span>  
  
 <span data-ttu-id="e4f9a-109">下列操作处理初始加载和更改处理的同步：</span><span class="sxs-lookup"><span data-stu-id="e4f9a-109">The following operations handle the synchronization of initial load and change processing:</span></span>  
  
|<span data-ttu-id="e4f9a-110">Operation</span><span class="sxs-lookup"><span data-stu-id="e4f9a-110">Operation</span></span>|<span data-ttu-id="e4f9a-111">说明</span><span class="sxs-lookup"><span data-stu-id="e4f9a-111">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="e4f9a-112">ResetCdcState</span><span class="sxs-lookup"><span data-stu-id="e4f9a-112">ResetCdcState</span></span>|<span data-ttu-id="e4f9a-113">此操作用于重置与当前 CDC 上下文相关联的持久的 CDC 状态。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-113">This operation is used to reset the persistent CDC state associated with the current CDC context.</span></span> <span data-ttu-id="e4f9a-114">在此操作运行后，来自 LSN-timestamp `sys.fn_cdc_get_max_lsn` 表的当前最大 LSN 将成为下一处理范围的起始范围。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-114">After this operation is run, the current maximum LSN from the LSN-timestamp `sys.fn_cdc_get_max_lsn` table becomes the start of the range for the next processing range.</span></span> <span data-ttu-id="e4f9a-115">此操作要求到源数据库的连接。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-115">This operation requires a connection to the source database.</span></span>|  
|<span data-ttu-id="e4f9a-116">MarkInitialLoadStart</span><span class="sxs-lookup"><span data-stu-id="e4f9a-116">MarkInitialLoadStart</span></span>|<span data-ttu-id="e4f9a-117">此操作用于初始加载包的开头，以便在初始加载包开始读取源表之前记录源数据库中的当前 LSN。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-117">This operation is used at the beginning of an initial-load package to record the current LSN in the source database before the initial-load package starts reading the source tables.</span></span> <span data-ttu-id="e4f9a-118">此操作要求到源数据库的连接以便调用 `sys.fn_cdc_get_max_lsn`。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-118">This requires a connection to the source database to call `sys.fn_cdc_get_max_lsn`.</span></span><br /><br /> <span data-ttu-id="e4f9a-119">如果在 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] CDC（也就是说，不是 Oracle）上工作时选择 MarkInitialLoadStart，则在连接管理器中指定的用户必须是 db_owner 或 sysadmin。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-119">If you select MarkInitialLoadStart when working on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] CDC (that is, not Oracle) the user specified in the connection manager must be either  db_owner or sysadmin.</span></span>|  
|<span data-ttu-id="e4f9a-120">MarkInitialLoadEnd</span><span class="sxs-lookup"><span data-stu-id="e4f9a-120">MarkInitialLoadEnd</span></span>|<span data-ttu-id="e4f9a-121">此操作用于初始加载包的末尾，以便在初始加载包完成读取源表之后记录源数据库中的当前 LSN。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-121">This operation is used at the end of an initial-load package to record the current LSN in the source database after the initial-load package finished reading the source tables.</span></span> <span data-ttu-id="e4f9a-122">此 LSN 通过以下方式确定：首先记录此操作发生时的当前时间，然后在 CDC 数据库的 `cdc.lsn_time_`mapping 表中进行查询以便查找在该时间后发生的更改。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-122">This LSN is determined by recording the current time when this operation occurred and then querying the `cdc.lsn_time_`mapping table in the CDC database looking for a change that occurred after that time.</span></span><br /><br /> <span data-ttu-id="e4f9a-123">如果在 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] CDC（也就是说，不是 Oracle）上工作时选择 MarkInitialLoadEnd，则在连接管理器中指定的用户必须是 db_owner 或 sysadmin。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-123">If you select MarkInitialLoadEnd when working on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] CDC (that is , not Oracle) the user specified in the connection manager must be either  db_owner or sysadmin.</span></span>|  
|<span data-ttu-id="e4f9a-124">MarkCdcStart</span><span class="sxs-lookup"><span data-stu-id="e4f9a-124">MarkCdcStart</span></span>|<span data-ttu-id="e4f9a-125">在从快照数据库生成初始加载时使用此操作。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-125">This operation is used when then the initial load is made from a snapshot database.</span></span> <span data-ttu-id="e4f9a-126">在此情况下，更改处理应在快照 LSN 后立即开始。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-126">In this case, the change processing should start immediately after the snapshot LSN.</span></span> <span data-ttu-id="e4f9a-127">您可以指定要使用的快照数据库的名称并且 CDC 控制任务将查询 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 以找到快照 LSN。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-127">You can specify the name of the snapshot database to use and the CDC Control task queries [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] for the snapshot LSN.</span></span> <span data-ttu-id="e4f9a-128">您还可以选择直接指定快照 LSN。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-128">You also have the option to directly specify the snapshot LSN.</span></span><br /><br /> <span data-ttu-id="e4f9a-129">如果在 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] CDC（也就是说，不是 Oracle）上工作时选择 MarkCdcStart，则在连接管理器中指定的用户必须是 db_owner 或 sysadmin。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-129">If you select MarkCdcStart when working on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] CDC (that is , not Oracle) the user specified in the connection manager must be either  db_owner or sysadmin.</span></span>|  
  
 <span data-ttu-id="e4f9a-130">下列操作用于管理处理范围：</span><span class="sxs-lookup"><span data-stu-id="e4f9a-130">The following operations are used to manage the processing range:</span></span>  
  
|<span data-ttu-id="e4f9a-131">Operation</span><span class="sxs-lookup"><span data-stu-id="e4f9a-131">Operation</span></span>|<span data-ttu-id="e4f9a-132">说明</span><span class="sxs-lookup"><span data-stu-id="e4f9a-132">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="e4f9a-133">GetProcessingRange</span><span class="sxs-lookup"><span data-stu-id="e4f9a-133">GetProcessingRange</span></span>|<span data-ttu-id="e4f9a-134">在调用使用 CDC 源数据流的数据流之前使用此操作。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-134">This operation is used before invoking the data flow that uses the CDC Source data flow.</span></span> <span data-ttu-id="e4f9a-135">此操作建立 CDC 源数据流在调用时读取的 LSN 的范围。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-135">It establishes a range of LSNs that the CDC Source data flow reads when invoked.</span></span> <span data-ttu-id="e4f9a-136">该范围存储于一个 SSIS 包变量中，在数据流处理期间 CDC 源将使用该变量。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-136">The range is stored in an SSIS package variable that is used by the CDC Source during data-flow processing.</span></span><br /><br /> <span data-ttu-id="e4f9a-137">有关存储的状态的详细信息，请参阅 [定义状态变量](../data-flow/define-a-state-variable.md)。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-137">For more information about the states that are stored, see [Define a State Variable](../data-flow/define-a-state-variable.md).</span></span>|  
|<span data-ttu-id="e4f9a-138">MarkProcessedRange</span><span class="sxs-lookup"><span data-stu-id="e4f9a-138">MarkProcessedRange</span></span>|<span data-ttu-id="e4f9a-139">此操作在每次 CDC 运行后（在 CDC 数据流成功完成后）执行，以便记录在 CDC 运行中完全处理的上一个 LSN。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-139">: This operation is executed after each CDC run (after the CDC data flow is completed successfully) to record the last LSN that was fully processed in the CDC run.</span></span> <span data-ttu-id="e4f9a-140">下一次执行 GetProcessingRange 时，此位置将是处理范围的起始位置。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-140">The next time GetProcessingRange is executed, this position is the start of the processing range.</span></span>|  
  
## <a name="handling-cdc-state-persistency"></a><span data-ttu-id="e4f9a-141">处理 CDC 状态持久性</span><span class="sxs-lookup"><span data-stu-id="e4f9a-141">Handling CDC State Persistency</span></span>  
 <span data-ttu-id="e4f9a-142">此 CDC 控制任务维护激活之间的持久性状态。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-142">The CDC Control task maintains a persistent state between activations.</span></span> <span data-ttu-id="e4f9a-143">在 CDC 状态中存储的信息用于确定和维护 CDC 包的处理范围以及用于检测到错误条件。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-143">The information stored in the CDC state is used to determine and maintain the processing range for the CDC package and for detecting error conditions.</span></span> <span data-ttu-id="e4f9a-144">该持久性状态以字符串的形式存储。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-144">The persistent state is stored as a string.</span></span> <span data-ttu-id="e4f9a-145">有关详细信息，请参阅 [定义状态变量](../data-flow/define-a-state-variable.md)。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-145">For more information, see [Define a State Variable](../data-flow/define-a-state-variable.md).</span></span>  
  
 <span data-ttu-id="e4f9a-146">CDC 控制任务支持两种类型的状态持久性</span><span class="sxs-lookup"><span data-stu-id="e4f9a-146">The CDC Control task supports two types of state persistency</span></span>  
  
-   <span data-ttu-id="e4f9a-147">手动状态持久性：在此情况中，该 CDC 控制任务管理在某个包变量中存储的状态，但包开发人员必须在调用 CDC 控制前从持久性状态中读取该变量，然后在最后调用 CDC 控制并且 CDC 运行完成后将该变量写回到该持久性存储区中。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-147">Manual State Persistency: In this case, the CDC Control task manages the state stored in a package variable but the package developer must read the variable from a persistent store before calling the CDC Control and then write it back to that persistent store after the CDC Control is last called and the CDC run completes.</span></span>  
  
-   <span data-ttu-id="e4f9a-148">自动状态持久性：CDC 状态存储在数据库中的表中。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-148">Automatic State Persistency: The CDC state is stored in a table in a database.</span></span> <span data-ttu-id="e4f9a-149">该状态根据在 **“要用于存储状态的表”** 属性中命名的表中的 **StateName** 属性提供的名称存储，该表位于用于存储状态的所选连接管理器中。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-149">The state is stored under a name provided in the **StateName** property in a table named in the **Table to Use for Storing State** property, which is located in a selected connection manager for storing the state.</span></span> <span data-ttu-id="e4f9a-150">默认管理器是源连接管理器，但通常的做法是使其成为目标连接管理器。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-150">The default is the source connection manager but the common practice is for it to be the target connection manager.</span></span> <span data-ttu-id="e4f9a-151">该 CDC 控制任务更新状态表中的状态值，并且该值作为环境事务的一部分提交。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-151">The CDC Control task updates the state value in the state table and this is committed as part of the ambient transaction.</span></span>  
  
## <a name="error-handling"></a><span data-ttu-id="e4f9a-152">错误处理</span><span class="sxs-lookup"><span data-stu-id="e4f9a-152">Error Handling</span></span>  
 <span data-ttu-id="e4f9a-153">该 CDC 控制任务可在以下情况下报告错误：</span><span class="sxs-lookup"><span data-stu-id="e4f9a-153">The CDC Control task may report an error when:</span></span>  
  
-   <span data-ttu-id="e4f9a-154">它无法读取持久性的 CDC 状态或者在持久性状态更新失败时。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-154">It fails to read the persistent CDC state or when updating the persistent state fails.</span></span>  
  
-   <span data-ttu-id="e4f9a-155">它无法从源数据库读取当前 LSN 信息。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-155">It fails to read the current LSN information from the source database.</span></span>  
  
-   <span data-ttu-id="e4f9a-156">读取的 CDC 状态不一致。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-156">The CDC state read is not consistent.</span></span>  
  
 <span data-ttu-id="e4f9a-157">在所有这些情况下，该 CDC 控制任务报告一个可以处理的错误，SSIS 可使用标准方式处理控制流错误。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-157">In all of these cases, the CDC Control task reports an error that can be handled in the standard way SSIS handles control-flow errors.</span></span>  
  
 <span data-ttu-id="e4f9a-158">在未调用标记处理的范围的情况下在另一个获取处理范围操作后直接调用获取处理范围操作时，该 CDC 控制任务还可能会报告一个警告。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-158">The CDC Control task may also report a warning when the Get Processing Range operation is invoked directly after another Get Processing Range operation without Mark Processed Range being called.</span></span> <span data-ttu-id="e4f9a-159">这指示以前的运行失败或其他 CDC 包可能正在使用相同的 CDC 状态名称运行。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-159">This is an indication that the previous run failed or that another CDC package may be running using the same CDC state name.</span></span>  
  
## <a name="configuring-the-cdc-control-task"></a><span data-ttu-id="e4f9a-160">配置 CDC 控制任务</span><span class="sxs-lookup"><span data-stu-id="e4f9a-160">Configuring the CDC Control Task</span></span>  
 <span data-ttu-id="e4f9a-161">可以通过 SSIS 设计器或以编程方式来设置属性。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-161">You can set properties through SSIS Designer or programmatically.</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="e4f9a-162">本节内容</span><span class="sxs-lookup"><span data-stu-id="e4f9a-162">In This Section</span></span>  
  
-   [<span data-ttu-id="e4f9a-163">CDC 控制任务编辑器</span><span class="sxs-lookup"><span data-stu-id="e4f9a-163">CDC Control Task Editor</span></span>](../cdc-control-task-editor.md)  
  
-   [<span data-ttu-id="e4f9a-164">CDC 控制任务自定义属性</span><span class="sxs-lookup"><span data-stu-id="e4f9a-164">CDC Control Task Custom Properties</span></span>](cdc-control-task-custom-properties.md)  
  
## <a name="related-tasks"></a><span data-ttu-id="e4f9a-165">Related Tasks</span><span class="sxs-lookup"><span data-stu-id="e4f9a-165">Related Tasks</span></span>  
 [<span data-ttu-id="e4f9a-166">定义状态变量</span><span class="sxs-lookup"><span data-stu-id="e4f9a-166">Define a State Variable</span></span>](../data-flow/define-a-state-variable.md)  
  
## <a name="related-content"></a><span data-ttu-id="e4f9a-167">相关内容</span><span class="sxs-lookup"><span data-stu-id="e4f9a-167">Related Content</span></span>  
  
-   <span data-ttu-id="e4f9a-168">social.technet.microsoft.com 上的技术文章 [安装 Microsoft SQL Server 2012 Change Data Capture for Oracle by Attunity](https://go.microsoft.com/fwlink/?LinkId=252958)。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-168">Technical article, [Installing Microsoft SQL Server 2012 Change Data Capture for Oracle by Attunity](https://go.microsoft.com/fwlink/?LinkId=252958), on social.technet.microsoft.com.</span></span>  
  
-   <span data-ttu-id="e4f9a-169">social.technet.microsoft.com 上的技术文章 [解决 Microsoft Change Data Capture for Oracle by Attunity 中的配置问题](https://go.microsoft.com/fwlink/?LinkId=252960)。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-169">Technical article, [Troubleshoot Configuration Issues in Microsoft Change Data Capture for Oracle by Attunity](https://go.microsoft.com/fwlink/?LinkId=252960), on social.technet.microsoft.com.</span></span>  
  
-   <span data-ttu-id="e4f9a-170">social.technet.microsoft.com 上的技术文章 [解决 Microsoft Change Data Capture for Oracle by Attunity 中的 CDC 实例错误问题](https://go.microsoft.com/fwlink/?LinkId=252961)。</span><span class="sxs-lookup"><span data-stu-id="e4f9a-170">Technical article, [Troubleshoot CDC Instance Errors in Microsoft Change Data Capture for Oracle by Attunity](https://go.microsoft.com/fwlink/?LinkId=252961), on social.technet.microsoft.com.</span></span>  
  
  

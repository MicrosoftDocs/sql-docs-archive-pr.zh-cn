---
title: 在 Integration Services 包中执行 MERGE | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- MERGE statement [SQL Server]
ms.assetid: 7e44a5c2-e6d6-4fe2-a079-4f95ccdb147b
author: chugugrace
ms.author: chugu
ms.openlocfilehash: cc6de738d44b91a9e2a4885978ba4a46dfede8cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87580809"
---
# <a name="merge-in-integration-services-packages"></a><span data-ttu-id="661df-102">在 Integration Services 包中执行 MERGE</span><span class="sxs-lookup"><span data-stu-id="661df-102">MERGE in Integration Services Packages</span></span>
  <span data-ttu-id="661df-103">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)]的当前版本中，执行 SQL 任务中的 SQL 语句可以包含 MERGE 语句。</span><span class="sxs-lookup"><span data-stu-id="661df-103">In the current release of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], the SQL statement in an Execute SQL task can contain a MERGE statement.</span></span> <span data-ttu-id="661df-104">使用此 MERGE 语句可以在一个语句中完成多个 INSERT、UPDATE 和 DELETE 操作。</span><span class="sxs-lookup"><span data-stu-id="661df-104">This MERGE statement enables you to accomplish multiple INSERT, UPDATE, and DELETE operations in a single statement.</span></span>  
  
 <span data-ttu-id="661df-105">若要在包中使用 MERGE 语句，请执行下列步骤：</span><span class="sxs-lookup"><span data-stu-id="661df-105">To use the MERGE statement in a package, follow these steps:</span></span>  
  
-   <span data-ttu-id="661df-106">创建用于将源数据加载、转换和保存到临时表的数据流任务。</span><span class="sxs-lookup"><span data-stu-id="661df-106">Create a Data Flow task that loads, transforms, and saves the source data to a temporary or staging table.</span></span>  
  
-   <span data-ttu-id="661df-107">创建包含 MERGE 语句的执行 SQL 任务。</span><span class="sxs-lookup"><span data-stu-id="661df-107">Create an Execute SQL task that contains the MERGE statement.</span></span>  
  
-   <span data-ttu-id="661df-108">将数据流任务连接到执行 SQL 任务，并将临时表中的数据用作 MERGE 语句的输入。</span><span class="sxs-lookup"><span data-stu-id="661df-108">Connect the Data Flow task to the Execute SQL task, and use the data in the staging table as the input for the MERGE statement.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="661df-109">尽管在此方案中，MERGE 语句通常需要临时表，但 MERGE 语句的性能通常优于由查找转换执行的逐行查找的性能。</span><span class="sxs-lookup"><span data-stu-id="661df-109">Although a MERGE statement typically requires a staging table in this scenario, the performance of the MERGE statement usually exceeds that of the row-by-row lookup performed by the Lookup transformation.</span></span> <span data-ttu-id="661df-110">当查找表很大以致需要有足够多的内存供查找转换缓存其引用表时，MERGE 也非常有用。</span><span class="sxs-lookup"><span data-stu-id="661df-110">MERGE is also useful when the large size of a lookup table would test the memory that is available to the Lookup transformation for caching its reference table.</span></span>  
  
 <span data-ttu-id="661df-111">本主题的其余部分将讨论 MERGE 语句的一些其他用法。</span><span class="sxs-lookup"><span data-stu-id="661df-111">The remainder of this topic discusses some additional uses for the MERGE statement.</span></span>  
  
 <span data-ttu-id="661df-112">有关支持使用 MERGE 语句的示例目标组件，请参阅 CodePlex 社区示例 [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215)（MERGE 目标）。</span><span class="sxs-lookup"><span data-stu-id="661df-112">For a sample destination component that supports the use of the MERGE statement, see the CodePlex community sample, [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215).</span></span>  
  
## <a name="using-merge"></a><span data-ttu-id="661df-113">使用 MERGE</span><span class="sxs-lookup"><span data-stu-id="661df-113">Using MERGE</span></span>  
 <span data-ttu-id="661df-114">通常，当需要应用包括从一个表到另一个表的插入、更新和删除等更改时，可使用 MERGE 语句。</span><span class="sxs-lookup"><span data-stu-id="661df-114">Typically, you use the MERGE statement when you want to apply changes that include inserts, updates, and deletions from one table to another table.</span></span> <span data-ttu-id="661df-115">在 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]之前，此过程需要一个查找转换和多个 OLE DB 命令转换。</span><span class="sxs-lookup"><span data-stu-id="661df-115">Prior to [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], this process required both a Lookup transformation and multiple OLE DB Command transformations.</span></span> <span data-ttu-id="661df-116">查找转换执行逐行查找，以确定每一行是新行还是经过更改的行。</span><span class="sxs-lookup"><span data-stu-id="661df-116">The Lookup transformation performed a row-by-row lookup to determine whether each row was new or changed.</span></span> <span data-ttu-id="661df-117">OLE DB 命令转换然后会执行必要的 INSERT、UPDATE 和 DELETE 操作。</span><span class="sxs-lookup"><span data-stu-id="661df-117">The OLE DB Command transformations then performed the necessary INSERT, UPDATE, and DELETE operations.</span></span> <span data-ttu-id="661df-118">从 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]开始，一个 MERGE 语句即可替代查找转换和相应的 OLE DB 命令转换。</span><span class="sxs-lookup"><span data-stu-id="661df-118">Beginning in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], a single MERGE statement can replace both the Lookup transformation and the corresponding OLE DB Command transformations.</span></span>  
  
### <a name="merge-with-incremental-loads"></a><span data-ttu-id="661df-119">用于增量加载的 MERGE</span><span class="sxs-lookup"><span data-stu-id="661df-119">MERGE with Incremental Loads</span></span>  
 <span data-ttu-id="661df-120">变更数据捕获功能是 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] 中的新增功能，使用该功能可以方便可靠地对数据仓库执行增量加载。</span><span class="sxs-lookup"><span data-stu-id="661df-120">The change data capture functionality that is new in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] makes it easier to perform incremental loads reliably to a data warehouse.</span></span> <span data-ttu-id="661df-121">除了使用参数化的 OLE DB 命令转换来执行插入和更新之外，还可以使用 MERGE 语句来合并这两项操作。</span><span class="sxs-lookup"><span data-stu-id="661df-121">As an alternative to using parameterized OLE DB Command transformations to perform the inserts and the updates, you can use the MERGE statement to combine both operations.</span></span>  
  
 <span data-ttu-id="661df-122">有关详细信息，请参阅 [将变更应用到目标](../change-data-capture/apply-the-changes-to-the-destination.md)。</span><span class="sxs-lookup"><span data-stu-id="661df-122">For more information, see [Apply the Changes to the Destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span></span>  
  
#### <a name="merge-in-other-scenarios"></a><span data-ttu-id="661df-123">在其他情况下的 MERGE</span><span class="sxs-lookup"><span data-stu-id="661df-123">MERGE in Other Scenarios</span></span>  
 <span data-ttu-id="661df-124">在以下情况下，可以在 [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] 包的外部或内部使用 MERGE 语句。</span><span class="sxs-lookup"><span data-stu-id="661df-124">In the following scenarios, you can use the MERGE statement either outside or inside an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package.</span></span> <span data-ttu-id="661df-125">不过，从多个异类源加载此数据以及随后合并和清除该数据通常都需要 [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] 包。</span><span class="sxs-lookup"><span data-stu-id="661df-125">However, an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package is often required to load this data from multiple heterogeneous sources, and then to combine and cleanse the data.</span></span> <span data-ttu-id="661df-126">因此，为了使用方便和便于维护，可以考虑在包中使用 MERGE 语句。</span><span class="sxs-lookup"><span data-stu-id="661df-126">Therefore, you might consider using the MERGE statement in a package for convenience and ease of maintenance.</span></span>  
  
##### <a name="track-buying-habits"></a><span data-ttu-id="661df-127">跟踪购买习惯</span><span class="sxs-lookup"><span data-stu-id="661df-127">Track Buying Habits</span></span>  
 <span data-ttu-id="661df-128">数据仓库中的 FactBuyingHabits 表会跟踪客户购买指定产品的最后日期。</span><span class="sxs-lookup"><span data-stu-id="661df-128">The FactBuyingHabits table in the data warehouse tracks the last date on which a customer bought a given product.</span></span> <span data-ttu-id="661df-129">该表由 ProductID、CustomerID 和 PurchaseDate 列组成。</span><span class="sxs-lookup"><span data-stu-id="661df-129">The table consists of ProductID, CustomerID and PurchaseDate columns.</span></span> <span data-ttu-id="661df-130">事务性数据库每周都会生成一个包括该周采购情况的 PurchaseRecords 表。</span><span class="sxs-lookup"><span data-stu-id="661df-130">Every week, the transactional database generates a PurchaseRecords table that includes the purchases made during that week.</span></span> <span data-ttu-id="661df-131">目标是使用一个 MERGE 语句将 PurchaseRecords 表中的信息合并到 FactBuyingHabits 表中。</span><span class="sxs-lookup"><span data-stu-id="661df-131">The objective is to use a single MERGE statement to merge the information in the PurchaseRecords table into the FactBuyingHabits table.</span></span> <span data-ttu-id="661df-132">对于不存在的产品-客户对，MERGE 语句将插入新行。</span><span class="sxs-lookup"><span data-stu-id="661df-132">For product-customer pairs that do not exist, the MERGE statement inserts new rows.</span></span> <span data-ttu-id="661df-133">对于已存在的产品-客户对，MERGE 语句会更新最近的购买日期。</span><span class="sxs-lookup"><span data-stu-id="661df-133">For product-customer pairs that exist, the MERGE statement updates the most recent date-of-purchase.</span></span>  
  
###### <a name="track-price-history"></a><span data-ttu-id="661df-134">跟踪价格历史记录</span><span class="sxs-lookup"><span data-stu-id="661df-134">Track Price History</span></span>  
 <span data-ttu-id="661df-135">DimBook 表表示某书商库存中的图书列表，并标识每本书的价格历史记录。</span><span class="sxs-lookup"><span data-stu-id="661df-135">The DimBook table represents the list of books in the inventory of a book seller and identifies the price history of each book.</span></span> <span data-ttu-id="661df-136">此表包括以下列：ISBN、ProductID、Price、Shelf 和 IsCurrent。</span><span class="sxs-lookup"><span data-stu-id="661df-136">This table has these columns: ISBN, ProductID, Price, Shelf, and IsCurrent.</span></span> <span data-ttu-id="661df-137">此表还将书的每个价格显示为一行。</span><span class="sxs-lookup"><span data-stu-id="661df-137">This table also has one row for each price the book has had.</span></span> <span data-ttu-id="661df-138">其中一行显示的是当前价格。</span><span class="sxs-lookup"><span data-stu-id="661df-138">One of these rows contains the current price.</span></span> <span data-ttu-id="661df-139">为了指示哪一行包含当前价格，该行的 IsCurrent 列的值设置为 1。</span><span class="sxs-lookup"><span data-stu-id="661df-139">To indicate which row contains the current price, the value of the IsCurrent column for that row is set to 1.</span></span>  
  
 <span data-ttu-id="661df-140">该数据库每周会生成一个 WeeklyChanges 表，其中包含该周的价格更改以及该周添加的新书。</span><span class="sxs-lookup"><span data-stu-id="661df-140">Every week, the database generates a WeeklyChanges table that contains price changes for the week and new books that were added during the week.</span></span> <span data-ttu-id="661df-141">使用一个 MERGE 语句可以将 WeeklyChanges 表中的更改应用到 DimBook 表中。</span><span class="sxs-lookup"><span data-stu-id="661df-141">By using a single MERGE statement, you can apply the changes in the WeeklyChanges table to the DimBook table.</span></span> <span data-ttu-id="661df-142">MERGE 语句会为新添加的书插入新行，对于价格已更改的现有书的行，MERGE 语句会将这些行的 IsCurrent 列更新为 0。</span><span class="sxs-lookup"><span data-stu-id="661df-142">The MERGE statement inserts new rows for newly-added books, and updates the IsCurrent column to 0 for rows of existing books whose prices have changed.</span></span> <span data-ttu-id="661df-143">MERGE 语句还会为价格已更改的书插入新行，并会将这些新行的 IsCurrent 列的值设置为 1。</span><span class="sxs-lookup"><span data-stu-id="661df-143">The MERGE statement also inserts new rows for books whose prices have changed, and for these new rows, sets the value of the IsCurrent column to 1.</span></span>  
  
### <a name="merge-a-table-with-new-data-against-the-old-table"></a><span data-ttu-id="661df-144">将具有新数据的表与旧表合并</span><span class="sxs-lookup"><span data-stu-id="661df-144">Merge a Table with New Data Against the Old Table</span></span>  
 <span data-ttu-id="661df-145">该数据库使用“开放式架构”（即，包含各属性的名称-值对的表）对对象的属性进行建模。</span><span class="sxs-lookup"><span data-stu-id="661df-145">The database models the properties of an object by using an "open schema," that is, a table contains name-value pairs for each property.</span></span> <span data-ttu-id="661df-146">Properties 表具有三列：EntityID、PropertyID 和 Value。</span><span class="sxs-lookup"><span data-stu-id="661df-146">The Properties table has three columns: EntityID, PropertyID, and Value.</span></span> <span data-ttu-id="661df-147">NewProperties 表是 Properties 表的更新版本，应与 Properties 表保持同步。</span><span class="sxs-lookup"><span data-stu-id="661df-147">A NewProperties table that is a newer version of the table has to be synchronized with the Properties table.</span></span> <span data-ttu-id="661df-148">若要同步这两个表，可以使用一个 MERGE 语句执行以下操作：</span><span class="sxs-lookup"><span data-stu-id="661df-148">To synchronize these two tables, you can use a single MERGE statement to perform the following operations:</span></span>  
  
-   <span data-ttu-id="661df-149">从 Properties 表中删除 NewProperties 表中不存在的属性。</span><span class="sxs-lookup"><span data-stu-id="661df-149">Delete properties from the Properties table if they are absent from the NewProperties table.</span></span>  
  
-   <span data-ttu-id="661df-150">使用 NewProperties 表中找到的新值更新 Properties 表中的属性值。</span><span class="sxs-lookup"><span data-stu-id="661df-150">Update values for properties that are in the Properties table with new values found in the NewProperties table.</span></span>  
  
-   <span data-ttu-id="661df-151">插入在 NewProperties 表中存在但在 Properties 表中不存在的新属性。</span><span class="sxs-lookup"><span data-stu-id="661df-151">Insert new properties for properties that are in the NewProperties table but are not found in the Properties table.</span></span>  
  
 <span data-ttu-id="661df-152">此方法在类似复制方案的方案中非常有用，此方案的目标是使两台服务器上的两个表中的数据保持一致。</span><span class="sxs-lookup"><span data-stu-id="661df-152">This approach is useful in scenarios that resemble replication scenarios, where the objective is to keep data in two tables on two servers synchronized.</span></span>  
  
### <a name="track-inventory"></a><span data-ttu-id="661df-153">跟踪库存</span><span class="sxs-lookup"><span data-stu-id="661df-153">Track Inventory</span></span>  
 <span data-ttu-id="661df-154">Inventory 数据库具有一个 ProductsInventory 表，该表具有 ProductID 列和 StockOnHand 列。</span><span class="sxs-lookup"><span data-stu-id="661df-154">The Inventory database has a ProductsInventory table that has ProductID and StockOnHand columns.</span></span> <span data-ttu-id="661df-155">具有 ProductID、CustomerID 和 Quantity 列的 Shipments 表跟踪对客户的产品发货情况。</span><span class="sxs-lookup"><span data-stu-id="661df-155">A Shipments table with ProductID, CustomerID, and Quantity columns tracks shipments of products to customers.</span></span> <span data-ttu-id="661df-156">ProductInventory 表应根据 Shipments 表中的信息每天更新。</span><span class="sxs-lookup"><span data-stu-id="661df-156">The ProductInventory table has to be updated daily based on information in the Shipments table.</span></span> <span data-ttu-id="661df-157">根据发货情况，一个 MERGE 语句可以降低 ProductInventory 表中的库存。</span><span class="sxs-lookup"><span data-stu-id="661df-157">A single MERGE statement can reduce the inventory in the ProductInventory table based on the shipments made.</span></span> <span data-ttu-id="661df-158">如果某产品的库存已降低为 0，该 MERGE 语句还可以从 ProductInventory 表中删除该产品行。</span><span class="sxs-lookup"><span data-stu-id="661df-158">If the inventory for a product has been reduced to 0, that MERGE statement can also delete that product row from the ProductInventory table.</span></span>  
  
  

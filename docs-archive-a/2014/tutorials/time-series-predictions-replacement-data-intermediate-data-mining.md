---
title: 使用替换数据 (中级数据挖掘教程) 的时序预测 |Microsoft Docs
ms.custom: ''
ms.date: 04/27/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: analysis-services
ms.topic: conceptual
ms.assetid: a23a6e1d-1d49-41ea-8314-925dc8e4df5e
author: minewiskan
ms.author: owend
manager: kfile
ms.openlocfilehash: c96b70775105ea9446810ac3b064ae7cb07d4337
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87577120"
---
# <a name="time-series-predictions-using-replacement-data-intermediate-data-mining-tutorial"></a><span data-ttu-id="f303a-102">使用替换数据进行时序预测（数据挖掘中级教程）</span><span class="sxs-lookup"><span data-stu-id="f303a-102">Time Series Predictions using Replacement Data (Intermediate Data Mining Tutorial)</span></span>
  <span data-ttu-id="f303a-103">在本任务中，您将基于全球范围内的销售额数据生成新模型。</span><span class="sxs-lookup"><span data-stu-id="f303a-103">In this task, you will build a new model based on worldwide sales data.</span></span> <span data-ttu-id="f303a-104">然后，将创建一个将全球范围内的销售额模型应用于某个单独区域的预测查询。</span><span class="sxs-lookup"><span data-stu-id="f303a-104">Then, you will create a prediction query that applies the worldwide sales model to one of the individual regions.</span></span>  
  
## <a name="building-a-general-model"></a><span data-ttu-id="f303a-105">生成通用模型</span><span class="sxs-lookup"><span data-stu-id="f303a-105">Building a General Model</span></span>  
 <span data-ttu-id="f303a-106">记住您对原始挖掘模型的结果分析揭示在某些区域和产品系列上存在较大的差异。</span><span class="sxs-lookup"><span data-stu-id="f303a-106">Remember that your analysis of the results of the original mining model revealed big differences between regions and between product lines.</span></span> <span data-ttu-id="f303a-107">例如，M200 型号在北美的销售很强，而 T1000 型号的销售则不是这样。</span><span class="sxs-lookup"><span data-stu-id="f303a-107">For example, sales in North America were strong for the M200 model, while sales of the T1000 model did not do as well.</span></span> <span data-ttu-id="f303a-108">不过，分析非常复杂，因为某些序列没有太多数据，或在不同时间点启动数据。</span><span class="sxs-lookup"><span data-stu-id="f303a-108">However, the analysis is complicated by the fact that some series didn't have much data, or data started at a different point in time.</span></span> <span data-ttu-id="f303a-109">还缺少一些数据。</span><span class="sxs-lookup"><span data-stu-id="f303a-109">Some data was also missing.</span></span>  
  
 <span data-ttu-id="f303a-110">![预测 M200 和 T1000 数量的序列](../../2014/tutorials/media/6series-defaultforecasting.gif "预测 M200 和 T1000 数量的序列")</span><span class="sxs-lookup"><span data-stu-id="f303a-110">![Series predicting M200 and T1000 quantity](../../2014/tutorials/media/6series-defaultforecasting.gif "Series predicting M200 and T1000 quantity")</span></span>  
  
 <span data-ttu-id="f303a-111">为了解决某些数据质量问题，您决定将全球范围内的销售额数据合并，并使用一般销售趋势集来生成可应用于预测任何区域未来销售额的模型。</span><span class="sxs-lookup"><span data-stu-id="f303a-111">To address some of the data quality issues, you decide to merge the data from sales around the world, and use that set of general sales trends to build a model that can be applied to predict future sales in any region.</span></span>  
  
 <span data-ttu-id="f303a-112">创建预测时，您将使用通过定型全球范围内的销售额数据生成的模式，但是将用每个区域的销售额数据替换历史数据点。</span><span class="sxs-lookup"><span data-stu-id="f303a-112">When you create predictions, you will use the pattern that is generated by training on worldwide sales data, but you will replace the historical data points with the sales data for each individual region.</span></span> <span data-ttu-id="f303a-113">那样就保留了趋势的形状，但是使预测值与每个区域和型号的历史销售额数字一致。</span><span class="sxs-lookup"><span data-stu-id="f303a-113">That way, the shape of the trend is preserved but the predicted values are aligned with the historical sales figures for each region and model.</span></span>  
  
## <a name="performing-cross-prediction-with-a-time-series-model"></a><span data-ttu-id="f303a-114">使用时序模型执行交叉预测</span><span class="sxs-lookup"><span data-stu-id="f303a-114">Performing Cross-Prediction with a Time Series Model</span></span>  
 <span data-ttu-id="f303a-115">使用使用一个序列中的数据预测另一个序列中的趋势的过程称为交叉预测。</span><span class="sxs-lookup"><span data-stu-id="f303a-115">The process of using data from one series to predict trends in another series is called cross-prediction.</span></span> <span data-ttu-id="f303a-116">可以在很多方案中使用交叉预测：例如，您可能决定电话销售额是总体经济活动的合适预测因子，将对电视销售额定型的模型应用到一般经济数据。</span><span class="sxs-lookup"><span data-stu-id="f303a-116">You can use cross-prediction in many scenarios: for example, you might decide that television sales are a good predictor of overall economic activity, and apply a model trained on television sales to general economic data.</span></span>  
  
 <span data-ttu-id="f303a-117">在 SQL Server 的数据挖掘中，通过在函数 REPLACE_MODEL_CASES 的参数内使用参数来执行交叉预测， [PredictTimeSeries &#40;DMX&#41;](/sql/dmx/predicttimeseries-dmx)。</span><span class="sxs-lookup"><span data-stu-id="f303a-117">In SQL Server Data Mining, you perform cross-prediction by using the parameter REPLACE_MODEL_CASES within the arguments to the function, [PredictTimeSeries &#40;DMX&#41;](/sql/dmx/predicttimeseries-dmx).</span></span>  
  
 <span data-ttu-id="f303a-118">在下一个任务中，您将学习如何使用 REPLACE_MODEL_CASES。</span><span class="sxs-lookup"><span data-stu-id="f303a-118">In the next task, you will learn how to use REPLACE_MODEL_CASES.</span></span> <span data-ttu-id="f303a-119">您将使用合并的全球范围内的销售额数据来生成模型，然后创建将通用模型映射到替换数据的预测查询。</span><span class="sxs-lookup"><span data-stu-id="f303a-119">You will use the merged world sales data to build a model, and then create a prediction query that maps the general model to the replacement data.</span></span>  
  
 <span data-ttu-id="f303a-120">假定您现在已熟悉如何生成数据挖掘模型，因此简化了生成模型的说明。</span><span class="sxs-lookup"><span data-stu-id="f303a-120">It is assumed that you are familiar with how to build data mining models by now, and so the instructions for building the model has been simplified.</span></span>  
  
#### <a name="to-build-a-mining-structure-and-mining-model-using-the-aggregated-data"></a><span data-ttu-id="f303a-121">使用聚合数据生成挖掘结构和挖掘模型</span><span class="sxs-lookup"><span data-stu-id="f303a-121">To build a mining structure and mining model using the aggregated data</span></span>  
  
1.  <span data-ttu-id="f303a-122">在**解决方案资源管理器**中，右键单击 "**挖掘结构**"，然后选择 "**新建挖掘结构**" 以启动数据挖掘向导。</span><span class="sxs-lookup"><span data-stu-id="f303a-122">In **Solution Explorer**, right-click **Mining Structures**, and then select **New Mining Structure** to start the Data Mining Wizard.</span></span>  
  
2.  <span data-ttu-id="f303a-123">在数据挖掘向导中，进行以下选择：</span><span class="sxs-lookup"><span data-stu-id="f303a-123">In the Data Mining Wizard, make the following selections:</span></span>  
  
    -   <span data-ttu-id="f303a-124">算法：Microsoft 时序</span><span class="sxs-lookup"><span data-stu-id="f303a-124">Algorithm: Microsoft Time Series</span></span>  
  
    -   <span data-ttu-id="f303a-125">使用在此高级课程中早些时候生成的数据源作为模型的源。</span><span class="sxs-lookup"><span data-stu-id="f303a-125">Use the data source that you built earlier in this advanced lesson as the source for the model.</span></span> <span data-ttu-id="f303a-126">请参阅[高级时序预测 &#40;中级数据挖掘教程&#41;](../../2014/tutorials/advanced-time-series-predictions-intermediate-data-mining-tutorial.md)。</span><span class="sxs-lookup"><span data-stu-id="f303a-126">See [Advanced Time Series Predictions &#40;Intermediate Data Mining Tutorial&#41;](../../2014/tutorials/advanced-time-series-predictions-intermediate-data-mining-tutorial.md).</span></span>  
  
         <span data-ttu-id="f303a-127">数据源视图：`AllRegions`</span><span class="sxs-lookup"><span data-stu-id="f303a-127">Data source view: `AllRegions`</span></span>  
  
    -   <span data-ttu-id="f303a-128">为序列键和时间键选择以下列：</span><span class="sxs-lookup"><span data-stu-id="f303a-128">Choose the following columns for the series key and time key:</span></span>  
  
         <span data-ttu-id="f303a-129">关键时间： ReportingDate</span><span class="sxs-lookup"><span data-stu-id="f303a-129">Key time: ReportingDate</span></span>  
  
         <span data-ttu-id="f303a-130">密钥：区域</span><span class="sxs-lookup"><span data-stu-id="f303a-130">Key: Region</span></span>  
  
    -   <span data-ttu-id="f303a-131">为 `Input` 和 `Predict` 选择以下列：</span><span class="sxs-lookup"><span data-stu-id="f303a-131">Choose the following columns for `Input` and `Predict`:</span></span>  
  
         <span data-ttu-id="f303a-132">SumQty</span><span class="sxs-lookup"><span data-stu-id="f303a-132">SumQty</span></span>  
  
         <span data-ttu-id="f303a-133">SumAmt</span><span class="sxs-lookup"><span data-stu-id="f303a-133">SumAmt</span></span>  
  
         <span data-ttu-id="f303a-134">AvgAmt</span><span class="sxs-lookup"><span data-stu-id="f303a-134">AvgAmt</span></span>  
  
         <span data-ttu-id="f303a-135">AvgQty</span><span class="sxs-lookup"><span data-stu-id="f303a-135">AvgQty</span></span>  
  
    -   <span data-ttu-id="f303a-136">对于 "**挖掘结构名称**"，请键入：`All Regions`</span><span class="sxs-lookup"><span data-stu-id="f303a-136">For **Mining structure name**, type: `All Regions`</span></span>  
  
    -   <span data-ttu-id="f303a-137">对于 "**挖掘模型名称**"，请键入：`All Regions`</span><span class="sxs-lookup"><span data-stu-id="f303a-137">For **Mining model name**, type: `All Regions`</span></span>  
  
3.  <span data-ttu-id="f303a-138">处理新结构和新模型。</span><span class="sxs-lookup"><span data-stu-id="f303a-138">Process the new structure and the new model.</span></span>  
  
#### <a name="to-build-the-prediction-query-and-map-the-replacement-data"></a><span data-ttu-id="f303a-139">生成预测查询并映射替换数据</span><span class="sxs-lookup"><span data-stu-id="f303a-139">To build the prediction query and map the replacement data</span></span>  
  
1.  <span data-ttu-id="f303a-140">如果模型尚未打开，请双击 AllRegions 结构，并在数据挖掘设计器中单击 "**挖掘模型预测**" 选项卡。</span><span class="sxs-lookup"><span data-stu-id="f303a-140">If the model is not already open, double-click the AllRegions structure, and in Data Mining Designer, click the **Mining Model Prediction** tab.</span></span>  
  
2.  <span data-ttu-id="f303a-141">在 "**挖掘模型**" 窗格中，应该已选择模型 AllRegions。</span><span class="sxs-lookup"><span data-stu-id="f303a-141">In the **Mining Model** pane, the model AllRegions should already be selected.</span></span> <span data-ttu-id="f303a-142">如果未选择此选项，请单击 "**选择模型**"，然后选择模型 AllRegions。</span><span class="sxs-lookup"><span data-stu-id="f303a-142">If it is not selected, click **Select Model**, and then select the model, AllRegions.</span></span>  
  
3.  <span data-ttu-id="f303a-143">在 "**选择输入表 (s) **窗格中，单击"**选择事例表**"。</span><span class="sxs-lookup"><span data-stu-id="f303a-143">In the **Select Input Table(s)** pane, click **Select Case Table**.</span></span>  
  
4.  <span data-ttu-id="f303a-144">在 "**选择表**" 对话框中，将 "数据源" 更改为 "T1000 太平洋区域"，然后单击 **"确定"**。</span><span class="sxs-lookup"><span data-stu-id="f303a-144">In the **Select Table** dialog box, change the data source to T1000 Pacific Region, and then click **OK**.</span></span>  
  
5.  <span data-ttu-id="f303a-145">右键单击挖掘模型和输入数据之间的联接线，然后选择 "**修改连接**"。</span><span class="sxs-lookup"><span data-stu-id="f303a-145">Right-click the join line between the mining model and the input data and select **Modify Connections**.</span></span> <span data-ttu-id="f303a-146">如下所示将数据源视图中的数据映射到模型：</span><span class="sxs-lookup"><span data-stu-id="f303a-146">Map the data in the data source view to the model as follows:</span></span>  
  
    1.  <span data-ttu-id="f303a-147">验证挖掘模型中的 ReportingDate 列是否已映射到输入数据中的 ReportingDate 列。</span><span class="sxs-lookup"><span data-stu-id="f303a-147">Verify that the ReportingDate column in the mining model is mapped to the ReportingDate column in the input data.</span></span>  
  
    2.  <span data-ttu-id="f303a-148">在 "**修改映射**" 对话框的 "模型列 AvgQty" 行中，单击 "**表列**"，然后选择 "T1000"。</span><span class="sxs-lookup"><span data-stu-id="f303a-148">In the **Modify Mapping** dialog box, in the row for the model column AvgQty, click under **Table Column** and then select T1000 Pacific.Quantity.</span></span> <span data-ttu-id="f303a-149">单击“确定”  。</span><span class="sxs-lookup"><span data-stu-id="f303a-149">Click **OK**.</span></span>  
  
         <span data-ttu-id="f303a-150">此步骤将在用于预测平均数量的模型中创建的列映射到用于销售数量的 T1000 系列的实际数据。</span><span class="sxs-lookup"><span data-stu-id="f303a-150">This step maps the column you created in the model for predicting average quantity to the actual data from the T1000 series for sales quantity.</span></span>  
  
    3.  <span data-ttu-id="f303a-151">不要将模型中的列区域映射到任何输入列。</span><span class="sxs-lookup"><span data-stu-id="f303a-151">Do not map the column Region in the model to any input column.</span></span>  
  
         <span data-ttu-id="f303a-152">因为该模型聚合所有系列上的数据，所以，对于 T1000 Pacific 之类的系列值没有匹配项，并且在预测查询运行时将引发错误。</span><span class="sxs-lookup"><span data-stu-id="f303a-152">Because the model aggregated the data across all series, there is no match for the series values such as T1000 Pacific, and an error is raised when the prediction query runs.</span></span>  
  
6.  <span data-ttu-id="f303a-153">现在，您将生成预测查询。</span><span class="sxs-lookup"><span data-stu-id="f303a-153">Now you will build the prediction query.</span></span>  
  
     <span data-ttu-id="f303a-154">首先，将一个列添加到结果，这些结果输出模型的 AllRegions 标签以及预测。</span><span class="sxs-lookup"><span data-stu-id="f303a-154">First, add a column to the results that outputs the AllRegions label from the model together with the predictions.</span></span> <span data-ttu-id="f303a-155">这样您知道了结果基于通用模型。</span><span class="sxs-lookup"><span data-stu-id="f303a-155">This way you know that the results were based on the general model.</span></span>  
  
    1.  <span data-ttu-id="f303a-156">在网格中，单击 "**源**" 下的第一个空行，然后选择 "AllRegions 挖掘模型"。</span><span class="sxs-lookup"><span data-stu-id="f303a-156">In the grid, click the first empty row, under **Source**, and then select AllRegions mining model.</span></span>  
  
    2.  <span data-ttu-id="f303a-157">对于 "**字段**"，选择 "区域"。</span><span class="sxs-lookup"><span data-stu-id="f303a-157">For **Field**, select Region.</span></span>  
  
    3.  <span data-ttu-id="f303a-158">对于 "**别名**"，已**使用类型模型**。</span><span class="sxs-lookup"><span data-stu-id="f303a-158">For **Alias**, type **Model Used**.</span></span>  
  
7.  <span data-ttu-id="f303a-159">接下来，向结果中添加另一个标签，以便您可以看到该预测针对哪个系列。</span><span class="sxs-lookup"><span data-stu-id="f303a-159">Next, add another label to the results, so that you can see which series the prediction is for.</span></span>  
  
    1.  <span data-ttu-id="f303a-160">单击一个空行，然后在 "**源**" 下选择 "**自定义表达式**"。</span><span class="sxs-lookup"><span data-stu-id="f303a-160">Click an empty row, and under **Source**, select **Custom Expression**.</span></span>  
  
    2.  <span data-ttu-id="f303a-161">在 "**别名**" 列中，键入**ModelRegion**。</span><span class="sxs-lookup"><span data-stu-id="f303a-161">In the **Alias** column, type **ModelRegion**.</span></span>  
  
    3.  <span data-ttu-id="f303a-162">在 "**条件/参数**" 列中，键入 `'T1000 Pacific'` 。</span><span class="sxs-lookup"><span data-stu-id="f303a-162">In the **Criteria/Argument** column, type `'T1000 Pacific'`.</span></span>  
  
8.  <span data-ttu-id="f303a-163">现在您将设置交叉预测函数。</span><span class="sxs-lookup"><span data-stu-id="f303a-163">Now you will set up the cross-prediction function.</span></span>  
  
    1.  <span data-ttu-id="f303a-164">单击一个空行，然后在 "**源**" 下，选择 "**预测函数**"。</span><span class="sxs-lookup"><span data-stu-id="f303a-164">Click an empty row, and under **Source**, select **Prediction Function**.</span></span>  
  
    2.  <span data-ttu-id="f303a-165">在 "**字段**" 列中，选择**PredictTimeSeries**。</span><span class="sxs-lookup"><span data-stu-id="f303a-165">In the **Field** column, select **PredictTimeSeries**.</span></span>  
  
    3.  <span data-ttu-id="f303a-166">对于 "**别名**"，键入**预测值**。</span><span class="sxs-lookup"><span data-stu-id="f303a-166">For **Alias**, type **Predicted Values**.</span></span>  
  
    4.  <span data-ttu-id="f303a-167">通过使用拖放操作，将字段 AvgQty 从 "**挖掘模型**" 窗格拖到 "**条件/参数**" 列。</span><span class="sxs-lookup"><span data-stu-id="f303a-167">Drag the field AvgQty from the **Mining Model** pane into the **Criteria/Argument** column by using the drag and drop operation.</span></span>  
  
    5.  <span data-ttu-id="f303a-168">在 "**条件/参数**" 列中，键入以下文本：`,5, REPLACE_MODEL_CASES`</span><span class="sxs-lookup"><span data-stu-id="f303a-168">In the **Criteria/Argument** column, after the field name, type the following text: `,5, REPLACE_MODEL_CASES`</span></span>  
  
         <span data-ttu-id="f303a-169">"**条件/参数**" 文本框的完整文本应该如下所示：`[AllRegions].[AvgQty],5,REPLACE_MODEL_CASES`</span><span class="sxs-lookup"><span data-stu-id="f303a-169">The complete text of the **Criteria/Argument** text box should be as follows: `[AllRegions].[AvgQty],5,REPLACE_MODEL_CASES`</span></span>  
  
9. <span data-ttu-id="f303a-170">单击 "**结果**"。</span><span class="sxs-lookup"><span data-stu-id="f303a-170">Click **Results**.</span></span>  
  
## <a name="creating-the-cross-prediction-query-in-dmx"></a><span data-ttu-id="f303a-171">在 DMX 中创建交叉预测查询</span><span class="sxs-lookup"><span data-stu-id="f303a-171">Creating the Cross-Prediction Query in DMX</span></span>  
 <span data-ttu-id="f303a-172">您可能注意到一个交叉预测问题：即要将通用模型应用到不同数据序列（如北美区域的 T1000 产品型号），必须为每个序列创建不同查询，以便您可以将每组输入映射到该模型。</span><span class="sxs-lookup"><span data-stu-id="f303a-172">You might have noticed a problem with cross-prediction: namely, that to apply the general model to a different data series, such as the T1000 product model in the North America region, you must create a different query for each series, so that you can map the each set of inputs to the model.</span></span>  
  
 <span data-ttu-id="f303a-173">但是，不用在设计器中生成查询，您可以切换到 DMX 视图并编辑创建的 DMX 语句。</span><span class="sxs-lookup"><span data-stu-id="f303a-173">However, rather than building the query in the designer, you can switch to DMX view and edit the DMX statement that you created.</span></span> <span data-ttu-id="f303a-174">例如，下面的 DMX 语句表示您刚创建的查询：</span><span class="sxs-lookup"><span data-stu-id="f303a-174">For example, the following DMX statement represents the query that you just built:</span></span>  
  
```  
SELECT  
      ([All Regions].[Region]) as [Model Used],  
      ('T-1000 Pacific') as [ModelRegion],  
      (PredictTimeSeries([All Regions].[Avg Qty],5, REPLACE_MODEL_CASES)) as [Predicted Quantity]  
     FROM [All Regions]  
PREDICTION JOIN  
    OPENQUERY([Adventure Works DW2003R2], 'SELECT [ReportingDate] FROM  
      (  
       SELECT  ReportingDate, ModelRegion, Quantity, Amount   
       FROM dbo.vTimeSeries   
       WHERE (ModelRegion = N''T1000 Pacific'')  
       ) as [T1000 Pacific]    ')   
    AS t  
ON   
[All Regions].[Reporting Date] = t.[ReportingDate]   
AND   
[All Regions].[Avg Qty] = t.[Quantity]  
```  
  
 <span data-ttu-id="f303a-175">若要将此语句应用于其他模型，只需编辑查询语句，替换筛选条件和更新与每个结果关联的标签。</span><span class="sxs-lookup"><span data-stu-id="f303a-175">To apply this to a different model, you simply edit the query statement to replace the filter condition and to update the labels associated with each result.</span></span>  
  
 <span data-ttu-id="f303a-176">例如，如果通过将“Pacific”替换为“North America”来更改筛选条件和列标签，您将基于通用模型中的模式得到 T1000 产品在北美洲的预测。</span><span class="sxs-lookup"><span data-stu-id="f303a-176">For example, if you change the filter conditions and column labels by replacing 'Pacific' with 'North America', you will get predictions for the T1000 product in North America, based on the patterns in the general model.</span></span>  
  
## <a name="next-task-in-lesson"></a><span data-ttu-id="f303a-177">课程中的下一个任务</span><span class="sxs-lookup"><span data-stu-id="f303a-177">Next Task in Lesson</span></span>  
 [<span data-ttu-id="f303a-178">&#40;中级数据挖掘教程比较预测模型的预测&#41;</span><span class="sxs-lookup"><span data-stu-id="f303a-178">Comparing Predictions for Forecasting Models &#40;Intermediate Data Mining Tutorial&#41;</span></span>](../../2014/tutorials/comparing-predictions-for-forecasting-models-intermediate-data-mining-tutorial.md)  
  
## <a name="see-also"></a><span data-ttu-id="f303a-179">另请参阅</span><span class="sxs-lookup"><span data-stu-id="f303a-179">See Also</span></span>  
 <span data-ttu-id="f303a-180">[时序模型查询示例](../../2014/analysis-services/data-mining/time-series-model-query-examples.md) </span><span class="sxs-lookup"><span data-stu-id="f303a-180">[Time Series Model Query Examples](../../2014/analysis-services/data-mining/time-series-model-query-examples.md) </span></span>  
 [<span data-ttu-id="f303a-181">PredictTimeSeries (DMX)</span><span class="sxs-lookup"><span data-stu-id="f303a-181">PredictTimeSeries &#40;DMX&#41;</span></span>](/sql/dmx/predicttimeseries-dmx)  
  
  

---
title: SQL Server 托管备份到 Azure：互操作性和共存 |Microsoft Docs
description: 本文介绍 SQL Server 2014 中的多项功能 Microsoft Azure 互操作性和共存 SQL Server 托管备份。
ms.custom: ''
ms.date: 03/07/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 78fb78ed-653f-45fe-a02a-a66519bfee1b
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: 2e2839fc4755fe47504e42e5058a5da117888900
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87690020"
---
# <a name="sql-server-managed-backup-to-azure-interoperability-and-coexistence"></a><span data-ttu-id="740b8-103">SQL Server 托管备份到 Azure：互操作性和共存</span><span class="sxs-lookup"><span data-stu-id="740b8-103">SQL Server Managed Backup to Azure: Interoperability and Coexistence</span></span>
  <span data-ttu-id="740b8-104">本主题介绍[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]与 [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] 中若干功能的互操作性和共存情况。</span><span class="sxs-lookup"><span data-stu-id="740b8-104">This topic describes [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] interoperability and coexistence with several features in [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="740b8-105">这些功能包括以下各项：AlwaysOn 可用性组、数据库镜像、备份维护计划、日志传送、即席备份、分离数据库和删除数据库。</span><span class="sxs-lookup"><span data-stu-id="740b8-105">These features include the following: AlwaysOn Availability Groups, Database Mirroring, Backup Maintenance Plans, Log Shipping, Ad hoc backups, Detach Database, and Drop Database.</span></span>  
  
### <a name="alwayson-availability-groups"></a><span data-ttu-id="740b8-106">AlwaysOn 可用性组</span><span class="sxs-lookup"><span data-stu-id="740b8-106">AlwaysOn Availability Groups</span></span>  
 <span data-ttu-id="740b8-107">配置为支持 Azure 的解决方案的 AlwaysOn 可用性组 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="740b8-107">AlwaysOn Availability Groups that are configured as an Azure-only solution supported for [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="740b8-108">不支持仅本地或混合 AlwaysOn 可用性组配置。</span><span class="sxs-lookup"><span data-stu-id="740b8-108">On-premises only, or Hybrid AlwaysOn Availability Group configurations are not supported.</span></span> <span data-ttu-id="740b8-109">有关详细信息和其他注意事项，请参阅为[可用性组设置 SQL Server 托管备份到 Azure](../../2014/database-engine/setting-up-sql-server-managed-backup-to-windows-azure-for-availability-groups.md)</span><span class="sxs-lookup"><span data-stu-id="740b8-109">For more information and other considerations, see [Setting up SQL Server Managed Backup to Azure for Availability Groups](../../2014/database-engine/setting-up-sql-server-managed-backup-to-windows-azure-for-availability-groups.md)</span></span>  
  
### <a name="database-mirroring"></a><span data-ttu-id="740b8-110">数据库镜像</span><span class="sxs-lookup"><span data-stu-id="740b8-110">Database Mirroring</span></span>  
 <span data-ttu-id="740b8-111">仅主体数据库上支持[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="740b8-111">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is supported only on the principal database.</span></span> <span data-ttu-id="740b8-112">如果将主体数据库和镜像数据库都配置为使用[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]，则跳过镜像数据库，不进行备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-112">If both the principal and the mirror are configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], the mirrored database is skipped and will not be backed up.</span></span> <span data-ttu-id="740b8-113">但是，在故障转移的情况下，[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]将在镜像完成角色切换并联机后开始备份过程。</span><span class="sxs-lookup"><span data-stu-id="740b8-113">However, in the event of a failover, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will start the backup process after the mirror has completed role switching and is online.</span></span> <span data-ttu-id="740b8-114">在这种情况下，备份将存储在新的容器中。</span><span class="sxs-lookup"><span data-stu-id="740b8-114">The backups will be stored in a new container in this case.</span></span> <span data-ttu-id="740b8-115">如果未将镜像配置为使用[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]，则在进行故障转移的情况下，不进行任何备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-115">If the mirror is not configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], in the event of a failover, no backups are taken.</span></span> <span data-ttu-id="740b8-116">建议同时在主体和镜像上配置[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]，以便在进行故障转移的情况下可继续备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-116">We recommend that you configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] on both the principal and the mirror so backups continue in the event of a failover.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="740b8-117">如果要在具有[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]默认设置的实例上创建镜像数据库，则最好禁用[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]实例默认值，以使这些设置不应用于镜像数据库，然后在配置主体和镜像后重新启用实例默认值。</span><span class="sxs-lookup"><span data-stu-id="740b8-117">If you are creating a mirrored database on an instance with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] default settings, it may be preferable to disable [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] instance defaults, so they are not applied to the mirrored database, and then re-enable the instance defaults after configuring the Principal and the Mirror.</span></span>  
  
### <a name="maintenance-plan"></a><span data-ttu-id="740b8-118">维护计划</span><span class="sxs-lookup"><span data-stu-id="740b8-118">Maintenance Plan</span></span>  
 <span data-ttu-id="740b8-119">在不支持启用[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]时，可使用维护计划来创建备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-119">Using Maintenance Plans for creating backups for a database when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is enabled is not supported.</span></span> <span data-ttu-id="740b8-120">此时，维护计划将导致日志链中断，而 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 可能无法支持在还原过程中保证数据库得以恢复。</span><span class="sxs-lookup"><span data-stu-id="740b8-120">Maintenance plans will cause broken log chain and [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] may not be able to support a guaranteed recoverability of the database during restore.</span></span> <span data-ttu-id="740b8-121">在实例级别启用[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]后，也适用这一规则。</span><span class="sxs-lookup"><span data-stu-id="740b8-121">This also applies when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is enabled at the instance level.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="740b8-122">为同一数据库或实例配置 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 后，支持具有仅复制备份的维护计划。</span><span class="sxs-lookup"><span data-stu-id="740b8-122">Maintenance Plans with Copy Only backups is supported with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configured for the same database or instance.</span></span>  
  
### <a name="log-shipping"></a><span data-ttu-id="740b8-123">日志传送</span><span class="sxs-lookup"><span data-stu-id="740b8-123">Log Shipping</span></span>  
 <span data-ttu-id="740b8-124">无法为同一数据库同时配置日志传送和 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="740b8-124">You cannot configure Log Shipping and [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the same database at the same time.</span></span> <span data-ttu-id="740b8-125">这样做会影响使用任一功能时数据库可复原性。</span><span class="sxs-lookup"><span data-stu-id="740b8-125">Doing so will affect the recoverability of the database using either functionality.</span></span>  
  
### <a name="ad-hoc-backups-using-transact-sql-and-sql-server-management-studio"></a><span data-ttu-id="740b8-126">使用 Transact-SQL 和 SQL Server Management Studio 的即席备份</span><span class="sxs-lookup"><span data-stu-id="740b8-126">Ad Hoc Backups Using Transact-SQL and SQL Server Management Studio</span></span>  
 <span data-ttu-id="740b8-127">即席备份或一次性备份是在[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]外部使用 Transact-SQL 或 SQL Server Management Studio 创建的。根据它所使用的备份类型和存储介质，它可能会影响[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]进程。</span><span class="sxs-lookup"><span data-stu-id="740b8-127">Ad hoc or one time backups created outside [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] using Transact-SQL or SQL Server Management Studio may affect the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] process depending on the type of backup and the storage media used.</span></span> <span data-ttu-id="740b8-128">将备份记录到与使用的 Azure 存储帐户不同的 Azure 存储帐户 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ，或者将其与 Azure Blob 存储服务的任何其他目标相比，将导致日志链中断。</span><span class="sxs-lookup"><span data-stu-id="740b8-128">Log backups to a different Azure storage account than what [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using, or any other destination than the Azure Blob storage service, will cause a log chain break.</span></span> <span data-ttu-id="740b8-129">建议使用[smart_admin。 sp_backup_on_demand &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql)存储过程在已启用的数据库上启动备份 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="740b8-129">We recommend that you use the [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql) stored procedure to initiate a backup on databases that have [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled.</span></span> <span data-ttu-id="740b8-130">可使用此存储过程启动完整数据库备份或日志备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-130">You can initiate either a full database or log backup using this stored procedure.</span></span>  
  
### <a name="drop-database-and-detach-database"></a><span data-ttu-id="740b8-131">删除数据库和分离数据库</span><span class="sxs-lookup"><span data-stu-id="740b8-131">Drop Database and Detach Database</span></span>  
 <span data-ttu-id="740b8-132">如果分离或删除了启用[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]的数据库，虽然无法进行其他备份，但先前的备份仍保留在存储中，直到保持期结束，之后将清除这些备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-132">If a database that has [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled is detached or dropped, although no additional backups are possible, the previous backups remain in the storage until the retention period has elapsed, at which point the backups will be purged.</span></span>  
  
### <a name="changes-to-recovery-model"></a><span data-ttu-id="740b8-133">对恢复模式的更改</span><span class="sxs-lookup"><span data-stu-id="740b8-133">Changes to Recovery Model</span></span>  
  
-   <span data-ttu-id="740b8-134">如果将数据库的恢复模式从 "**简单**" 更改为 "**完整**" 或 "**大容量日志**"，则可以选择 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 为数据库配置。</span><span class="sxs-lookup"><span data-stu-id="740b8-134">If you change the recovery model of a database from **Simple** to **Full** or **Bulk-Logged**, you have the option of configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span> <span data-ttu-id="740b8-135">[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]会将数据库视为新的数据库。</span><span class="sxs-lookup"><span data-stu-id="740b8-135">This will be considered like a new database from [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] perspective.</span></span>  
  
-   <span data-ttu-id="740b8-136">如果将数据库的恢复模式从**完整**或**大容量日志**更改为**简单**，则已 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 启用，将不再计划备份操作。</span><span class="sxs-lookup"><span data-stu-id="740b8-136">If you change the recovery model of a database from **Full** or **Bulk-Logged** to **Simple**, that has [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled, backup operations will no longer be scheduled.</span></span> <span data-ttu-id="740b8-137">保持期设置仍将有效，并且备份文件仍将保留在存储帐户中，直到保持期结束。</span><span class="sxs-lookup"><span data-stu-id="740b8-137">The retention period setting will still be active and backup files will remain in the storage account until the retention period has elapsed.</span></span> <span data-ttu-id="740b8-138">如果要保留备份，则我们建议将文件下载到其他存储帐户或本地位置。</span><span class="sxs-lookup"><span data-stu-id="740b8-138">If you want to retain the backups, we recommend that you download the files either to a different storage account or to an on-premises location.</span></span> <span data-ttu-id="740b8-139">如果恢复模式恢复为**完全**或**大容量日志记录**，则会保留配置设置，并可重复使用这些设置。</span><span class="sxs-lookup"><span data-stu-id="740b8-139">The configuration settings are retained and can be reused if the recovery model is set back to **Full** or **Bulk-Logged** again.</span></span>  
  
### <a name="log-backups-using-other-backup-tools-or-custom-scripts"></a><span data-ttu-id="740b8-140">使用其他备份工具或自定义脚本进行日志备份</span><span class="sxs-lookup"><span data-stu-id="740b8-140">Log Backups Using Other Backup Tools or Custom Scripts</span></span>  
 <span data-ttu-id="740b8-141">配置为对同一数据库执行日志备份的任何两个备份都将导致备份日志链中断。</span><span class="sxs-lookup"><span data-stu-id="740b8-141">Any two backups that are configured to perform log backups on the same database will cause break in the backup log chain.</span></span> <span data-ttu-id="740b8-142">尽管 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 将尝试通过在检测到备份链中断时安排完整备份而补救备份链中断的情况，但这意味着持续不断地定期中断，并由两个竞争的工具执行日志备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-142">Although [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to remedy the break in the backup chain by scheduling full backups when a break in chain is detected, this means keeping up continuously with periodic breaks and log backups performed by two competing tools.</span></span> <span data-ttu-id="740b8-143">这还有可能影响数据库的可恢复性，因为任何工具都不会有一整套备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-143">This can also potentially affect the recoverability of the database since no one tool can be expected to have a full set of backup in sequence.</span></span> <span data-ttu-id="740b8-144">尽管这一点适用于执行日志备份的任何两个功能或工具，但如下所述，强调特定的示例仍很有用。</span><span class="sxs-lookup"><span data-stu-id="740b8-144">Although this applies to any two features or tools performing log backups,, it is useful to call out specific examples as described below.</span></span> <span data-ttu-id="740b8-145">这也是配置维护计划或日志传送问题的基础，如本主题的前面几节所述。</span><span class="sxs-lookup"><span data-stu-id="740b8-145">This is also the basis for the issues with configuring maintenance plans or log shipping as described in earlier sections of this topic.</span></span>  
  
 <span data-ttu-id="740b8-146">**Data Protection Manager (DPM) 备份：** Microsoft Data Protection Manager 允许执行完整备份和增量备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-146">**Data Protection Manager (DPM) based backups:** Microsoft Data Protection Manager allows you to do full and incremental backups.</span></span> <span data-ttu-id="740b8-147">增量备份是在创建 T 日志备份之后执行日志截断的日志备份。</span><span class="sxs-lookup"><span data-stu-id="740b8-147">The incremental backups are log backups that do perform a log truncation after creating a T-log backup.</span></span> <span data-ttu-id="740b8-148">因此，不支持为同一数据库同时配置 DPM 和 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="740b8-148">So configuring both DPM and [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the same database is not supported.</span></span>  
  
 <span data-ttu-id="740b8-149">**第三方工具或脚本：** 执行日志备份的任何第三方工具或脚本导致日志截断与不兼容 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ，并且不受支持。</span><span class="sxs-lookup"><span data-stu-id="740b8-149">**Third Party Tools or Scripts:** Any third party tool or scripts that perform log backups causing log truncation is incompatible with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], and is not supported.</span></span>  
  
 <span data-ttu-id="740b8-150">如果已 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 为数据库实例启用了，并且想要获取即席备份，则可以[smart_admin 使用 Sp_backup_on_demand &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql)存储过程，如前面部分所述。</span><span class="sxs-lookup"><span data-stu-id="740b8-150">If you have [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] enabled for a database instance, and you want to take an ad hoc backup you can either use the [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql) stored procedure as described in the earlier section.</span></span> <span data-ttu-id="740b8-151">如果还需要在 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 之外定期安排备份，则可使用“仅复制备份”。</span><span class="sxs-lookup"><span data-stu-id="740b8-151">If you also have a need to schedule or un backups periodically outside of [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], you can use the Copy Only Backup.</span></span>  <span data-ttu-id="740b8-152">有关详细信息，请参阅[仅复制备份 (SQL Server)](../relational-databases/backup-restore/copy-only-backups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="740b8-152">For more information, see [Copy-Only Backups &#40;SQL Server&#41;](../relational-databases/backup-restore/copy-only-backups-sql-server.md).</span></span>  
  
  

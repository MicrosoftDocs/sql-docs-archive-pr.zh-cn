---
title: 事务隔离级别内存优化表 |Microsoft Docs
ms.custom: seo-dt-2019
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: 8a6a82bf-273c-40ab-a101-46bd3615db8a
author: stevestein
ms.author: sstein
ms.openlocfilehash: 5ee0ba17dc999c9076ca4622d47db28b8200b851
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87689002"
---
# <a name="transaction-isolation-levels-in-memory-optimized-tables"></a><span data-ttu-id="00524-102">内存优化表中的事务隔离级别</span><span class="sxs-lookup"><span data-stu-id="00524-102">Transaction Isolation Levels in memory-optimized tables</span></span>

  <span data-ttu-id="00524-103">访问内存优化表的事务支持以下隔离级别。</span><span class="sxs-lookup"><span data-stu-id="00524-103">The following isolation levels are supported for transactions that access memory-optimized tables.</span></span>  
  
-   <span data-ttu-id="00524-104">SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="00524-104">SNAPSHOT</span></span>  
  
-   <span data-ttu-id="00524-105">REPEATABLE READ</span><span class="sxs-lookup"><span data-stu-id="00524-105">REPEATABLE READ</span></span>  
  
-   <span data-ttu-id="00524-106">SERIALIZABLE</span><span class="sxs-lookup"><span data-stu-id="00524-106">SERIALIZABLE</span></span>  
  
-   <span data-ttu-id="00524-107">READ COMMITTED</span><span class="sxs-lookup"><span data-stu-id="00524-107">READ COMMITTED</span></span>  
  
 <span data-ttu-id="00524-108">可以在本机编译存储过程的原子块中指定事务隔离级别。</span><span class="sxs-lookup"><span data-stu-id="00524-108">The transaction isolation level can be specified as part of the atomic block of a natively compiled stored procedure.</span></span> <span data-ttu-id="00524-109">有关详细信息，请参阅 [CREATE PROCEDURE (Transact-SQL)](/sql/t-sql/statements/create-procedure-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="00524-109">For more information, see [CREATE PROCEDURE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-procedure-transact-sql).</span></span> <span data-ttu-id="00524-110">在从解释型 [!INCLUDE[tsql](../includes/tsql-md.md)] 访问内存优化表时，可以使用表级提示指定隔离级别。</span><span class="sxs-lookup"><span data-stu-id="00524-110">When accessing memory-optimized tables from interpreted [!INCLUDE[tsql](../includes/tsql-md.md)], the isolation level can be specified using table-level hints.</span></span>  
  
 <span data-ttu-id="00524-111">定义本机编译存储过程时必须指定事务隔离级别。</span><span class="sxs-lookup"><span data-stu-id="00524-111">You must specify the transaction isolation level when you define a natively compiled stored procedure.</span></span> <span data-ttu-id="00524-112">在从解释型 [!INCLUDE[tsql](../includes/tsql-md.md)] 中的用户事务访问内存优化表时，必须使用表级提示指定隔离级别。</span><span class="sxs-lookup"><span data-stu-id="00524-112">You must specify the isolation level in table hints when accessing memory-optimized tables from user transactions in interpreted [!INCLUDE[tsql](../includes/tsql-md.md)].</span></span> <span data-ttu-id="00524-113">有关详细信息，请参阅[包含内存优化表的事务隔离级别的准则](../relational-databases/in-memory-oltp/memory-optimized-tables.md)。</span><span class="sxs-lookup"><span data-stu-id="00524-113">For more information, see [Guidelines for Transaction Isolation Levels with Memory-Optimized Tables](../relational-databases/in-memory-oltp/memory-optimized-tables.md).</span></span>  
  
 <span data-ttu-id="00524-114">自动提交事务对于内存优化表支持隔离级别 READ COMMITTED。</span><span class="sxs-lookup"><span data-stu-id="00524-114">The isolation level READ COMMITTED is supported for memory-optimized tables with autocommit transactions.</span></span> <span data-ttu-id="00524-115">READ COMMITTED 在用户事务或原子块中无效。</span><span class="sxs-lookup"><span data-stu-id="00524-115">READ COMMITTED is not valid in user transactions or in an atomic block.</span></span> <span data-ttu-id="00524-116">显式或隐式用户事务不支持 READ COMMITTED。</span><span class="sxs-lookup"><span data-stu-id="00524-116">READ COMMITTED is not supported with explicit or implicit user transactions.</span></span> <span data-ttu-id="00524-117">具有自动提交事务的内存优化表支持隔离级别 READ_COMMITTED_SNAPSHOT，并且仅在查询未访问任何基于磁盘的表时才支持。</span><span class="sxs-lookup"><span data-stu-id="00524-117">Isolation level READ_COMMITTED_SNAPSHOT is supported for memory-optimized tables with autocommit transactions and only if the query does not access any disk-based tables.</span></span> <span data-ttu-id="00524-118">此外，在 SNAPSHOT 隔离级别下通过解释型 [!INCLUDE[tsql](../includes/tsql-md.md)] 启动的事务不能访问内存优化表。</span><span class="sxs-lookup"><span data-stu-id="00524-118">In addition, transactions that are started using interpreted [!INCLUDE[tsql](../includes/tsql-md.md)] with SNAPSHOT isolation cannot access memory-optimized tables.</span></span> <span data-ttu-id="00524-119">在 REPEATABLE READ 或 SERIALIZABLE 隔离级别下使用解释型 [!INCLUDE[tsql](../includes/tsql-md.md)] 的事务必须使用 SNAPSHOT 隔离级别访问内存优化表。</span><span class="sxs-lookup"><span data-stu-id="00524-119">Transactions that are use interpreted [!INCLUDE[tsql](../includes/tsql-md.md)] with either REPEATABLE READ or SERIALIZABLE isolation must access memory-optimized tables using SNAPSHOT isolation.</span></span> <span data-ttu-id="00524-120">有关此方案的详细信息，请参阅[跨容器事务](cross-container-transactions.md)。</span><span class="sxs-lookup"><span data-stu-id="00524-120">For more information about this scenario, see [Cross-Container Transactions](cross-container-transactions.md).</span></span>  
  
 <span data-ttu-id="00524-121">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] 中的默认隔离级别为 READ COMMITTED。</span><span class="sxs-lookup"><span data-stu-id="00524-121">READ COMMITTED is the default isolation level in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="00524-122">在会话的隔离级别为 READ COMMITED（或更低级别）时，可以执行以下操作之一：</span><span class="sxs-lookup"><span data-stu-id="00524-122">When the isolation level of the session is READ COMMITED (or lower), you can do one of the following:</span></span>  
  
-   <span data-ttu-id="00524-123">显式使用更高的隔离级别来访问内存优化表（例如，WITH (SNAPSHOT)）。</span><span class="sxs-lookup"><span data-stu-id="00524-123">Explicitly use a higher isolation level hint for accessing the memory-optimized table (for example, WITH (SNAPSHOT)).</span></span>  
  
-   <span data-ttu-id="00524-124">指定 `MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT` 设置选项，它将内存优化表的隔离级别设置为 SNAPSHOT（如同向每个内存优化表加入 WITH(SNAPSHOT) 提示）。</span><span class="sxs-lookup"><span data-stu-id="00524-124">Specify the `MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT` set option, which will set the isolation level for memory-optimized tables to SNAPSHOT (as if you included WITH(SNAPSHOT) hints to every memory-optimized table).</span></span> <span data-ttu-id="00524-125">有关的详细信息 `MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT` ，请参阅[ALTER DATABASE SET Options &#40;transact-sql&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options)。</span><span class="sxs-lookup"><span data-stu-id="00524-125">For more information about `MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT`, see [ALTER DATABASE SET Options &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options).</span></span>  
  
 <span data-ttu-id="00524-126">或者，如果会话的隔离级别为 READ COMMITTED，则可以使用自动提交事务。</span><span class="sxs-lookup"><span data-stu-id="00524-126">Alternatively, if the isolation level of the session is READ COMMITTED, you can use autocommit transactions.</span></span>  
  
 <span data-ttu-id="00524-127">以解释型 [!INCLUDE[tsql](../includes/tsql-md.md)] 开头的 SNAPSHOT 事务无法访问内存优化表。</span><span class="sxs-lookup"><span data-stu-id="00524-127">SNAPSHOT transactions started in interpreted [!INCLUDE[tsql](../includes/tsql-md.md)] cannot access memory-optimized tables.</span></span>  
  
 <span data-ttu-id="00524-128">内存优化表所支持的事务隔离级别提供与基于磁盘的表相同的逻辑保证。</span><span class="sxs-lookup"><span data-stu-id="00524-128">The transaction isolation levels supported for memory-optimized tables provide the same logical guarantees as disk-based tables.</span></span> <span data-ttu-id="00524-129">但用于提供隔离级别保证的机制有所不同。</span><span class="sxs-lookup"><span data-stu-id="00524-129">The mechanism used for providing isolation level guarantees is different.</span></span>  
  
 <span data-ttu-id="00524-130">对于基于磁盘的表，将使用锁定实现大多数隔离级别保证，从而防止因阻塞发生冲突。</span><span class="sxs-lookup"><span data-stu-id="00524-130">For disk-based tables, most isolation level guarantees are implemented using locking, which prevent conflicts through blocking.</span></span> <span data-ttu-id="00524-131">对于内存优化表，将使用一种冲突检测机制来提供保证，从而无需使用锁。</span><span class="sxs-lookup"><span data-stu-id="00524-131">For memory-optimized tables, the guarantees are enforced using a conflict detection mechanism, which avoids the need to take locks.</span></span> <span data-ttu-id="00524-132">基于磁盘的表的 SNAPSHOT 隔离属于例外情况。</span><span class="sxs-lookup"><span data-stu-id="00524-132">The exception is SNAPSHOT isolation on disk-based tables.</span></span> <span data-ttu-id="00524-133">该隔离与内存优化表的 SNAPSHOT 隔离类似，也通过冲突检测机制实现。</span><span class="sxs-lookup"><span data-stu-id="00524-133">This is implemented similarly to SNAPSHOT isolation on memory-optimized tables using a conflict detection mechanism.</span></span>  
  
 <span data-ttu-id="00524-134">SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="00524-134">SNAPSHOT</span></span>  
 <span data-ttu-id="00524-135">此隔离级别指定：事务中任何语句所读取的数据都将是在该事务开始时便存在的数据的事务性一致版本。</span><span class="sxs-lookup"><span data-stu-id="00524-135">This isolation level specifies that data read by any statement in a transaction will be the transactionally consistent version of the data that existed at the start of the transaction.</span></span> <span data-ttu-id="00524-136">事务只能识别在其开始之前提交的数据修改。</span><span class="sxs-lookup"><span data-stu-id="00524-136">The transaction can only recognize data modifications that were committed before the start of the transaction.</span></span> <span data-ttu-id="00524-137">在当前事务中执行的语句将看不到在当前事务开始以后由其他事务所做的数据修改。</span><span class="sxs-lookup"><span data-stu-id="00524-137">Data modifications made by other transactions after the start of the current transaction are not visible to statements executing in the current transaction.</span></span> <span data-ttu-id="00524-138">事务中的语句所获取的已提交数据快照对应于该数据在事务开始时的状态。</span><span class="sxs-lookup"><span data-stu-id="00524-138">The statements in a transaction get a snapshot of the committed data as it existed at the start of the transaction.</span></span>  
  
 <span data-ttu-id="00524-139">写操作（更新、插入和删除）始终与其他事务完全隔离。</span><span class="sxs-lookup"><span data-stu-id="00524-139">Write operations (updates, inserts and deletes) are always fully isolated from other transactions.</span></span> <span data-ttu-id="00524-140">因此，SNAPSHOT 事务中的写操作可能与其他事务的写操作发生冲突。</span><span class="sxs-lookup"><span data-stu-id="00524-140">Therefore, the write operations in a SNAPSHOT transaction can conflict with write operations by other transactions.</span></span> <span data-ttu-id="00524-141">如果当前事务尝试更新或删除的行已由当前事务启动后提交的其他事务更新或删除，则当前事务会终止并显示以下错误消息。</span><span class="sxs-lookup"><span data-stu-id="00524-141">When the current transaction attempts to update or delete a row that has been updated or deleted by another transaction that committed after the current transaction started, the transaction terminates with the following error message.</span></span>  
  
 <span data-ttu-id="00524-142">错误 41302。</span><span class="sxs-lookup"><span data-stu-id="00524-142">Error 41302.</span></span> <span data-ttu-id="00524-143">当前事务尝试更新的 X 表中的记录自此事务启动后已更新。</span><span class="sxs-lookup"><span data-stu-id="00524-143">The current transaction attempted to update a record in table X that has been updated since this transaction started.</span></span> <span data-ttu-id="00524-144">该事务已中止。</span><span class="sxs-lookup"><span data-stu-id="00524-144">The transaction was aborted.</span></span>  
  
 <span data-ttu-id="00524-145">如果当前事务尝试插入的行所包含的主键值与在当前事务之前提交的其他事务所插入行的主键值相同，将会发生提交失败并显示以下错误消息。</span><span class="sxs-lookup"><span data-stu-id="00524-145">When the current transaction attempts to insert a row with the same primary key value as a row that was inserted by another transaction that committed before the current transaction, there will be a failure to commit with the following error message.</span></span>  
  
 <span data-ttu-id="00524-146">错误41325。</span><span class="sxs-lookup"><span data-stu-id="00524-146">Error 41325.</span></span> <span data-ttu-id="00524-147">因某个序列化读取验证失败，当前事务无法提交。</span><span class="sxs-lookup"><span data-stu-id="00524-147">The current transaction failed to commit due to a serializable validation failure.</span></span>  
  
 <span data-ttu-id="00524-148">如果一个事务向该事务提交之前已删除的表写入数据，则该事务会终止并显示以下错误消息：</span><span class="sxs-lookup"><span data-stu-id="00524-148">If a transaction writes to a table that is dropped before the transaction commits, the transaction terminates with the following error message:</span></span>  
  
 <span data-ttu-id="00524-149">错误41305。</span><span class="sxs-lookup"><span data-stu-id="00524-149">Error 41305.</span></span> <span data-ttu-id="00524-150">因某个可重复读取验证失败，当前事务无法提交。</span><span class="sxs-lookup"><span data-stu-id="00524-150">The current transaction failed to commit due to a repeatable read validation failure.</span></span>  
  
 <span data-ttu-id="00524-151">REPEATABLE READ</span><span class="sxs-lookup"><span data-stu-id="00524-151">REPEATABLE READ</span></span>  
 <span data-ttu-id="00524-152">此隔离级别包含由 SNAPSHOT 隔离级别提供的保证。</span><span class="sxs-lookup"><span data-stu-id="00524-152">This isolation level includes the guarantees given by SNAPSHOT isolation level.</span></span> <span data-ttu-id="00524-153">此外，REPEATABLE READ 还保证，对于由该事务读取的任何行，在该事务提交时，该行都不会由任何其他事务更改。</span><span class="sxs-lookup"><span data-stu-id="00524-153">In addition, REPEATABLE READ guarantees that for any row that is read by the transaction, at the time the transaction commits the row has not been changed by any other transaction.</span></span> <span data-ttu-id="00524-154">在事务结束之前，该事务中的每个读取操作都是可重复的。</span><span class="sxs-lookup"><span data-stu-id="00524-154">Every read operation in the transaction is repeatable up to the end of the transaction.</span></span>  
  
 <span data-ttu-id="00524-155">如果当前事务读取的任何行已由在当前事务之前提交的其他事务更新，则提交会失败并显示以下错误消息。</span><span class="sxs-lookup"><span data-stu-id="00524-155">If the current transaction has read any row that has then been updated by another transaction that has committed before the current transaction, the commit fails with the following error message.</span></span>  
  
 <span data-ttu-id="00524-156">错误41305。</span><span class="sxs-lookup"><span data-stu-id="00524-156">Error 41305.</span></span> <span data-ttu-id="00524-157">因某个可重复读取验证失败，当前事务无法提交。</span><span class="sxs-lookup"><span data-stu-id="00524-157">The current transaction failed to commit due to a repeatable read validation failure.</span></span>  
  
 <span data-ttu-id="00524-158">SERIALIZABLE</span><span class="sxs-lookup"><span data-stu-id="00524-158">SERIALIZABLE</span></span>  
 <span data-ttu-id="00524-159">此隔离级别包含由 REPEATABLE READ 提供的保证。</span><span class="sxs-lookup"><span data-stu-id="00524-159">This isolation level includes the guarantees given by REPEATABLE READ.</span></span> <span data-ttu-id="00524-160">在获取快照与事务结束之间不会出现任何虚拟行。</span><span class="sxs-lookup"><span data-stu-id="00524-160">No phantom rows have appeared between the snapshot and the end of the transaction.</span></span> <span data-ttu-id="00524-161">虚拟行与选择、更新或删除的筛选条件匹配。</span><span class="sxs-lookup"><span data-stu-id="00524-161">Phantom rows match the filter condition of a select, update, or delete.</span></span>  
  
 <span data-ttu-id="00524-162">事务执行时就好像不存在并发事务。</span><span class="sxs-lookup"><span data-stu-id="00524-162">The transaction is executed as if there are no concurrent transactions.</span></span> <span data-ttu-id="00524-163">所有操作都在单个序列点上发生， (提交时间) 。</span><span class="sxs-lookup"><span data-stu-id="00524-163">All actions virtually occur at a single serialization point (commit time).</span></span>  
  
 <span data-ttu-id="00524-164">如果违反了其中任何一个保证，则该事务无法提交并显示以下错误消息：</span><span class="sxs-lookup"><span data-stu-id="00524-164">If any of these guarantees is violated, the transaction fails to commit with the following error message:</span></span>  
  
 <span data-ttu-id="00524-165">错误41325。</span><span class="sxs-lookup"><span data-stu-id="00524-165">Error 41325.</span></span> <span data-ttu-id="00524-166">因某个序列化读取验证失败，当前事务无法提交。</span><span class="sxs-lookup"><span data-stu-id="00524-166">The current transaction failed to commit due to a serializable validation failure.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="00524-167">另请参阅</span><span class="sxs-lookup"><span data-stu-id="00524-167">See Also</span></span>  
 <span data-ttu-id="00524-168">[了解内存优化表上的事务](../../2014/database-engine/understanding-transactions-on-memory-optimized-tables.md) </span><span class="sxs-lookup"><span data-stu-id="00524-168">[Understanding Transactions on Memory-Optimized Tables](../../2014/database-engine/understanding-transactions-on-memory-optimized-tables.md) </span></span>  
 <span data-ttu-id="00524-169">[具有内存优化表的事务隔离级别的准则](../relational-databases/in-memory-oltp/memory-optimized-tables.md) </span><span class="sxs-lookup"><span data-stu-id="00524-169">[Guidelines for Transaction Isolation Levels with Memory-Optimized Tables](../relational-databases/in-memory-oltp/memory-optimized-tables.md) </span></span>  
 [<span data-ttu-id="00524-170">内存优化表事务重试逻辑准则</span><span class="sxs-lookup"><span data-stu-id="00524-170">Guidelines for Retry Logic for Transactions on Memory-Optimized Tables</span></span>](../../2014/database-engine/guidelines-for-retry-logic-for-transactions-on-memory-optimized-tables.md)  
  
  

---
title: 管理可用性组数据库的登录名和作业 (SQL Server) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], deploying
- Availability Groups [SQL Server], failover
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: d7da14d3-848c-44d4-8e49-d536a1158a61
author: rothja
ms.author: jroth
ms.openlocfilehash: 457f3ef946b5cfaf86a4a19774af63c5d7635882
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87591523"
---
# <a name="management-of-logins-and-jobs-for-the-databases-of-an-availability-group-sql-server"></a><span data-ttu-id="7705e-102">管理可用性组中数据库的登录名和作业 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7705e-102">Management of Logins and Jobs for the Databases of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="7705e-103">您应当定期维护 AlwaysOn 可用性组的每个主数据库及其相应的辅助数据库上的同一组用户登录名和 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] 代理作业。</span><span class="sxs-lookup"><span data-stu-id="7705e-103">You should routinely maintain the same set of user logins and [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] Agent jobs on every primary database of an AlwaysOn availability group and the corresponding secondary databases.</span></span> <span data-ttu-id="7705e-104">在为可用性组承载可用性副本的每个 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] 实例上，必须重新生成这些登录名和作业。</span><span class="sxs-lookup"><span data-stu-id="7705e-104">The logins and jobs must be reproduced on every instance of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] that hosts an availability replica for the availability group.</span></span>  
  
-   <span data-ttu-id="7705e-105">**[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]代理作业**</span><span class="sxs-lookup"><span data-stu-id="7705e-105">**[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] Agent jobs**</span></span>  
  
     <span data-ttu-id="7705e-106">您需要手动将相关作业从承载原始主副本的服务器实例复制到承载原始辅助副本的服务器实例上。</span><span class="sxs-lookup"><span data-stu-id="7705e-106">You need to manually copy relevant jobs from the server instance that hosts the original primary replica to the server instances that host the original secondary replicas.</span></span> <span data-ttu-id="7705e-107">对于所有数据库，您需要在每个相关作业开始时添加逻辑，以使该作业仅在主数据库上执行，也就是说，仅在逻辑副本是数据库的主副本时执行。</span><span class="sxs-lookup"><span data-stu-id="7705e-107">For all databases, you need to add logic at the beginning of each relevant job to make the job execute only on the primary database, that is, only when the local replica is the primary replica for the database.</span></span>  
  
     <span data-ttu-id="7705e-108">承载可用性组的可用性副本的服务器实例的配置可能有所不同，如具有不同的磁带机号等。</span><span class="sxs-lookup"><span data-stu-id="7705e-108">The server instances that host the availability replicas of an availability group might be configured differently, with different tape drive letters or such.</span></span> <span data-ttu-id="7705e-109">每个可用性副本的作业必须允许可能存在的此类差异。</span><span class="sxs-lookup"><span data-stu-id="7705e-109">The jobs for each availability replica must allow for any such differences.</span></span>  
  
     <span data-ttu-id="7705e-110">请注意，备份作业可以使用 [sys.fn_hadr_is_preferred_backup_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) 函数根据可用性组备份首选项，标识本地副本是否为用于备份的首选副本。</span><span class="sxs-lookup"><span data-stu-id="7705e-110">Notice that backup jobs can use the [sys.fn_hadr_is_preferred_backup_replica](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function to identify whether the local replica is the preferred one for backups, according to the availability group backup preferences.</span></span> <span data-ttu-id="7705e-111">使用 [维护计划向导](../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md) 创建的备份作业默认使用此函数。</span><span class="sxs-lookup"><span data-stu-id="7705e-111">Backup jobs created using the [Maintenance Plan Wizard](../relational-databases/maintenance-plans/use-the-maintenance-plan-wizard.md) natively use this function.</span></span> <span data-ttu-id="7705e-112">对于其他备份作业，我们建议您将此函数用作您的备份作业中的一个条件，以便仅在首选副本上执行它们。</span><span class="sxs-lookup"><span data-stu-id="7705e-112">For other backup jobs, we recommend that you use this function as a condition in your backup jobs, so they execute only on the preferred replica.</span></span> <span data-ttu-id="7705e-113">有关详细信息，请参阅[活动辅助副本：辅助副本上的备份 (AlwaysOn 可用性组) ](availability-groups/windows/active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md)。</span><span class="sxs-lookup"><span data-stu-id="7705e-113">For more information, see [Active Secondaries: Backup on Secondary Replicas (AlwaysOn Availability Groups)](availability-groups/windows/active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).</span></span>  
  
-   <span data-ttu-id="7705e-114">**登录名**</span><span class="sxs-lookup"><span data-stu-id="7705e-114">**Logins**</span></span>  
  
     <span data-ttu-id="7705e-115">如果使用的是包含数据库，您可以配置数据库中的包含用户，对于这些用户，您不必在承载辅助副本的服务器实例上创建登录名。</span><span class="sxs-lookup"><span data-stu-id="7705e-115">If you are using contained databases, you can configure contained users in the databases, and for these users, you do not need to create logins on the server instances that host a secondary replica.</span></span> <span data-ttu-id="7705e-116">对于非包含可用性数据库，您需要在承载可用性副本的服务器实例上为这些登录名创建用户。</span><span class="sxs-lookup"><span data-stu-id="7705e-116">For a non-contained availability database, you will need to create users for the logins on the server instances that host the availability replicas.</span></span> <span data-ttu-id="7705e-117">有关详细信息，请参阅 [CREATE USER (Transact-SQL)](/sql/t-sql/statements/create-user-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="7705e-117">For more information, see [CREATE USER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-user-transact-sql).</span></span>  
  
     <span data-ttu-id="7705e-118">如果您的任何应用程序使用 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] 身份验证或本地 Windows 登录名，请参阅本主题后面的 [使用 SQL Server 身份验证或本地 Windows 登录名的应用程序的登录名](../../2014/database-engine/logins-and-jobs-for-availability-group-databases.md#SSauthentication)。</span><span class="sxs-lookup"><span data-stu-id="7705e-118">If any of your applications use [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] Authentication or a local Windows login, see [Logins Of Applications That Use SQL Server Authentication or a Local Windows Login](../../2014/database-engine/logins-and-jobs-for-availability-group-databases.md#SSauthentication), later in this topic.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="7705e-119">在服务器实例上未定义或错误定义了其相应 SQL Server 登录名的数据库用户无法登录到实例。</span><span class="sxs-lookup"><span data-stu-id="7705e-119">A database user for which the SQL Server login is undefined or is incorrectly defined on a server instance cannot log in to the instance.</span></span> <span data-ttu-id="7705e-120">这样的用户被称为此服务器实例上的数据库的“孤立用户” \*\* 。</span><span class="sxs-lookup"><span data-stu-id="7705e-120">Such a user is said to be an *orphaned user* of the database on that server instance.</span></span> <span data-ttu-id="7705e-121">如果给定服务器实例上存在孤立用户，您可以随时设置用户登录名。</span><span class="sxs-lookup"><span data-stu-id="7705e-121">If a user is orphaned on a given server instance, you can set up the user logins at any time.</span></span> <span data-ttu-id="7705e-122">有关详细信息，请参阅 [孤立用户故障排除 (SQL Server)](../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7705e-122">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span></span>  
  
-   <span data-ttu-id="7705e-123">**其他元数据**</span><span class="sxs-lookup"><span data-stu-id="7705e-123">**Additional metadata**</span></span>  
  
     <span data-ttu-id="7705e-124">在承载某一给定可用性组的辅助副本的各服务器实例上，登录名和作业不是需要重新创建的唯一信息。</span><span class="sxs-lookup"><span data-stu-id="7705e-124">Logins and jobs are not the only information that need to be recreated on each of the server instances that hosts an secondary replica for a given availability group.</span></span> <span data-ttu-id="7705e-125">例如，您可能需要重新创建服务器配置设置、凭据、加密的数据、权限、复制设置、Service Broker 应用程序、触发器（在服务器级别）等。</span><span class="sxs-lookup"><span data-stu-id="7705e-125">For example, you might need to recreate server configuration settings, credentials, encrypted data, permissions, replication settings, service broker applications, triggers (at server level), and so forth.</span></span> <span data-ttu-id="7705e-126">有关详细信息，请参阅 [当数据库在其他服务器实例上可用时管理元数据 (SQL Server)](../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7705e-126">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>  
  
##  <a name="logins-of-applications-that-use-sql-server-authentication-or-a-local-windows-login"></a><a name="SSauthentication"></a> <span data-ttu-id="7705e-127">使用 SQL Server 身份验证或本地 Windows 登录名的应用程序的登录名</span><span class="sxs-lookup"><span data-stu-id="7705e-127">Logins Of Applications That Use SQL Server Authentication or a Local Windows Login</span></span>  
 <span data-ttu-id="7705e-128">如果某一应用程序使用 SQL Server 身份验证或本地 Windows 登录名，则不匹配的 SID 可能会阻止该应用程序的登录名在 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]的远程实例上解析。</span><span class="sxs-lookup"><span data-stu-id="7705e-128">If an application uses SQL Server Authentication or a local Windows login, mismatched SIDs can prevent the application's login from resolving on a remote instance of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7705e-129">不匹配的 SID 将导致该登录名成为远程服务器实例上的孤立用户。</span><span class="sxs-lookup"><span data-stu-id="7705e-129">The mismatched SIDs cause the login to become an orphaned user on the remote server instance.</span></span> <span data-ttu-id="7705e-130">当应用程序连接到发生故障转移后的镜像数据库或日志传送数据库，或是连接到从备份初始化的复制订阅服务器数据库时，就可能会发生此问题。</span><span class="sxs-lookup"><span data-stu-id="7705e-130">This issue can occur when an application connects to a mirrored or log shipping database after a failover or to a replication subscriber database that was initialized from a backup.</span></span>  
  
 <span data-ttu-id="7705e-131">为了避免此问题，我们建议您在设置此类应用程序时采取预防措施，以便使用由 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]的远程实例承载的数据库。</span><span class="sxs-lookup"><span data-stu-id="7705e-131">To prevent this issue, we recommend that you take preventative measures when you set up such an application to use a database that is hosted by a remote instance of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7705e-132">预防措施包括将登录名和密码从 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] 的本地实例传输到 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]的远程实例。</span><span class="sxs-lookup"><span data-stu-id="7705e-132">Prevention involves transferring the logins and the passwords from the local instance of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] to the remote instance of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7705e-133">有关如何避免此问题的详细信息，请参阅知识库文章 918992（[如何在 SQL Server 实例间传输登录名和密码](https://support.microsoft.com/kb/918992/)）。</span><span class="sxs-lookup"><span data-stu-id="7705e-133">For more information about how to prevent this issue, see KB article 918992-[How to transfer the logins and the passwords between instances of SQL Server](https://support.microsoft.com/kb/918992/)).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7705e-134">这个问题会影响不同计算机上的 Windows 本地帐户。</span><span class="sxs-lookup"><span data-stu-id="7705e-134">This problem affects Windows local accounts on different computers.</span></span> <span data-ttu-id="7705e-135">但是，这个问题不会在域帐户上发生，因为 SID 在每台计算机上都是相同的。</span><span class="sxs-lookup"><span data-stu-id="7705e-135">However, this problem does not occur for domain accounts because the SID is the same on each of the computers.</span></span>  
  
 <span data-ttu-id="7705e-136">有关详细信息，请参阅 [与数据库镜像和日志传送有关的孤立用户](https://blogs.msdn.com/b/sqlserverfaq/archive/2009/04/13/orphaned-users-with-database-mirroring-and-log-shipping.aspx) （数据库引擎博客）。</span><span class="sxs-lookup"><span data-stu-id="7705e-136">For more information, see [Orphaned Users with Database Mirroring and Log Shipping](https://blogs.msdn.com/b/sqlserverfaq/archive/2009/04/13/orphaned-users-with-database-mirroring-and-log-shipping.aspx) (a Database Engine blog).</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="7705e-137">相关任务</span><span class="sxs-lookup"><span data-stu-id="7705e-137">Related Tasks</span></span>  
  
-   [<span data-ttu-id="7705e-138">创建登录名</span><span class="sxs-lookup"><span data-stu-id="7705e-138">Create a Login</span></span>](../relational-databases/security/authentication-access/create-a-login.md)  
  
-   <span data-ttu-id="7705e-139">[创建数据库用户](../relational-databases/security/authentication-access/create-a-database-user.md)。</span><span class="sxs-lookup"><span data-stu-id="7705e-139">[Create a Database User](../relational-databases/security/authentication-access/create-a-database-user.md).</span></span>  
  
-   [<span data-ttu-id="7705e-140">创建作业</span><span class="sxs-lookup"><span data-stu-id="7705e-140">Create a Job</span></span>](../ssms/agent/create-a-job.md)  
  
-   [<span data-ttu-id="7705e-141">当数据库在其他服务器实例上可用时管理元数据 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7705e-141">Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;</span></span>](../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md)  
  
## <a name="see-also"></a><span data-ttu-id="7705e-142">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7705e-142">See Also</span></span>  
 <span data-ttu-id="7705e-143">[AlwaysOn 可用性组 &#40;SQL Server 概述&#41;](availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7705e-143">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="7705e-144">[包含的数据库](../relational-databases/databases/contained-databases.md) </span><span class="sxs-lookup"><span data-stu-id="7705e-144">[Contained Databases](../relational-databases/databases/contained-databases.md) </span></span>  
 [<span data-ttu-id="7705e-145">创建作业</span><span class="sxs-lookup"><span data-stu-id="7705e-145">Create Jobs</span></span>](../ssms/agent/create-jobs.md)  
  
  

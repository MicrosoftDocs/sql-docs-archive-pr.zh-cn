---
title: SQL Server 托管备份到 Azure 的疑难解答 |Microsoft Docs
description: 本文介绍了一些任务和工具，您可以使用这些任务和工具排查 SQL Server 托管备份到 Microsoft Azure 操作期间可能发生的错误。
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: a34d35b0-48eb-4ed1-9f19-ea14754650da
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: 9c7ed5dd25ed2b02445bfae5eb78ac03b2270552
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87690021"
---
# <a name="troubleshooting-sql-server-managed--backup-to-azure"></a><span data-ttu-id="78ecd-103">排除针对 Azure 的 SQL Server 托管备份的故障</span><span class="sxs-lookup"><span data-stu-id="78ecd-103">Troubleshooting SQL Server Managed  Backup to Azure</span></span>
  <span data-ttu-id="78ecd-104">本主题说明可以用来对[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]操作期间可能发生的错误进行故障排除的任务和工具。</span><span class="sxs-lookup"><span data-stu-id="78ecd-104">This topic describes the tasks and tools you can use to troubleshoot errors that may occur during [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] operations.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="78ecd-105">概述</span><span class="sxs-lookup"><span data-stu-id="78ecd-105">Overview</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="78ecd-106">已内置检查和故障排除，因此，在许多情况下，由[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]进程本身处理内部错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-106">has built in checks and troubleshooting, so in many cases internal failures are taken care of by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] process itself.</span></span>  
  
 <span data-ttu-id="78ecd-107">这种情况的一个示例是删除了备份文件，导致日志链中断，从而影响可恢复性- [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 将确定日志链中的中断，并计划立即执行备份。</span><span class="sxs-lookup"><span data-stu-id="78ecd-107">Example of one such case is a deletion of a backup file resulting in a break of the log chain affecting recoverability - [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will identify the break in log chain and schedule a backup to be taken immediately.</span></span> <span data-ttu-id="78ecd-108">但是，我们仍建议您监视运行状态，并解决所有需要手动干预的错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-108">However we recommend that you monitor the status and address any errors that require manual intervention.</span></span>  
  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="78ecd-109">使用系统存储过程、系统视图和扩展事件来记录事件和错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-109">logs events and errors using system stored procedures, system views and extended events.</span></span> <span data-ttu-id="78ecd-110">系统视图和存储过程提供[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]配置信息、所安排备份的状态以及由扩展事件捕获的错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-110">System views and stored procedures provide [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration information, status of backup scheduled backups, and also the errors captured by Extended Events.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="78ecd-111">使用扩展事件捕获错误以用于故障排除。</span><span class="sxs-lookup"><span data-stu-id="78ecd-111">uses Extended Events to capture the errors to use for troubleshooting.</span></span> <span data-ttu-id="78ecd-112">除了记录事件外，SQL Server 智能管理策略还提供运行状态，电子邮件通知作业使用这种状态来提供错误和问题的通知。</span><span class="sxs-lookup"><span data-stu-id="78ecd-112">In addition to logging events, SQL Server Smart Admin Policies provide a health status which is used by an email notification job to provide notification or errors and issues.</span></span> <span data-ttu-id="78ecd-113">有关详细信息，请参阅[监视 SQL Server 托管备份到 Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md)。</span><span class="sxs-lookup"><span data-stu-id="78ecd-113">For more information see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="78ecd-114">还会使用与手动备份到 Azure 存储 (SQL Server 备份到 URL) 时使用的相同日志记录。</span><span class="sxs-lookup"><span data-stu-id="78ecd-114">also uses the same logging that is used when manually backing up to Azure storage (SQL Server Backup to URL).</span></span> <span data-ttu-id="78ecd-115">有关备份到 URL 相关问题的详细信息，请参阅[SQL Server 备份到 Url 最佳做法和故障排除](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)中的故障排除部分</span><span class="sxs-lookup"><span data-stu-id="78ecd-115">For more information on Backup to URL related issues, see the troubleshooting section in [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)</span></span>  
  
### <a name="general-troubleshooting-steps"></a><span data-ttu-id="78ecd-116">常规故障排除步骤</span><span class="sxs-lookup"><span data-stu-id="78ecd-116">General Troubleshooting Steps</span></span>  
  
1.  <span data-ttu-id="78ecd-117">启用电子邮件通知，开始接收有关错误和警告的电子邮件。</span><span class="sxs-lookup"><span data-stu-id="78ecd-117">Enable Email Notification to start to receive emails for error and warnings.</span></span>  
  
     <span data-ttu-id="78ecd-118">或者，也可定期运行 `smart_admin.fn_get_health_status` 以检查合计的错误和计数。</span><span class="sxs-lookup"><span data-stu-id="78ecd-118">Alternatively, you can also periodically run `smart_admin.fn_get_health_status` to check the aggregated errors and counts.</span></span> <span data-ttu-id="78ecd-119">例如，`number_of_invalid_credential_errors` 是尝试备份但出现凭据无效错误的智能备份的次数。</span><span class="sxs-lookup"><span data-stu-id="78ecd-119">For example, `number_of_invalid_credential_errors` is the number of times smart backup attempted a backup but got invalid credential error.</span></span> <span data-ttu-id="78ecd-120">`Number_of_backup_loops` 和 `number_of_retention_loops` 不是错误；但是，它们指示备份线程和保持线程扫描数据库列表的次数。</span><span class="sxs-lookup"><span data-stu-id="78ecd-120">`Number_of_backup_loops` and `number_of_retention_loops` are not errors; but they indicate the number of times backup thread and retention thread scanned the list of databases.</span></span> <span data-ttu-id="78ecd-121">通常情况下，如果 @begin_time @end_time 未提供和，则该函数显示过去30分钟内的信息，然后，对于这两个列，通常应看到非零值。</span><span class="sxs-lookup"><span data-stu-id="78ecd-121">Typically, when @begin_time and @end_time are not provided, the function is showing the information from last 30 minutes, then we should normally see non-zero values for these two columns.</span></span> <span data-ttu-id="78ecd-122">如果为零，则表示系统过载，甚至系统未响应。</span><span class="sxs-lookup"><span data-stu-id="78ecd-122">If they are zero then it implies system overloaded or even system not responding.</span></span> <span data-ttu-id="78ecd-123">有关详细信息，请参阅本主题后面的 "**系统问题疑难解答**" 一节。</span><span class="sxs-lookup"><span data-stu-id="78ecd-123">For more information, see **Troubleshooting System Issues** section later in this topic.</span></span>  
  
2.  <span data-ttu-id="78ecd-124">检查扩展事件日志，了解错误详细信息和其他相关事件。</span><span class="sxs-lookup"><span data-stu-id="78ecd-124">Review the Extended Event logs to learn more details on the errors and other associated events.</span></span>  
  
3.  <span data-ttu-id="78ecd-125">使用日志中的信息解决问题。</span><span class="sxs-lookup"><span data-stu-id="78ecd-125">Use the information in the logs to resolve the issue.</span></span>  <span data-ttu-id="78ecd-126">如果系统出现问题或错误时，可能需要重新启动服务或 SQL Server 代理。</span><span class="sxs-lookup"><span data-stu-id="78ecd-126">In case of a system issue or error, you may need to restart the service or SQL Server Agent.</span></span>  
  
### <a name="common-causes-of-errors"></a><span data-ttu-id="78ecd-127">常见错误原因</span><span class="sxs-lookup"><span data-stu-id="78ecd-127">Common Causes of Errors</span></span>  
 <span data-ttu-id="78ecd-128">以下是产生故障的常见错误列表：</span><span class="sxs-lookup"><span data-stu-id="78ecd-128">Following is the list of common causes resulting in failures:</span></span>  
  
1.  <span data-ttu-id="78ecd-129">**更改 SQL 凭据：** 如果更改了使用的凭据的名称 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ，或者如果删除了该名称，则 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 将无法进行备份。</span><span class="sxs-lookup"><span data-stu-id="78ecd-129">**Changes to SQL Credential:** If the name of the credential used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is changed or if it is deleted, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will not be able to take backups.</span></span> <span data-ttu-id="78ecd-130">该更改应该应用于[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]配置设置。</span><span class="sxs-lookup"><span data-stu-id="78ecd-130">The change should be applied to [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings.</span></span>  
  
2.  <span data-ttu-id="78ecd-131">对**存储访问密钥值的更改：** 如果更改了 Azure 帐户的存储密钥值，但未使用新值更新 SQL 凭据，则 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 向存储进行身份验证时将会失败，并且无法备份配置为使用此帐户的数据库。</span><span class="sxs-lookup"><span data-stu-id="78ecd-131">**Changes to storage access key values:** If the storage key values are changed for the Azure account, but SQL Credential is not updated with the new values, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will fail when authenticating to the storage, and fails to backup databases configured to use this account.</span></span>  
  
3.  <span data-ttu-id="78ecd-132">**更改 Azure 存储帐户：** 删除或重命名存储帐户时，如果不更改 SQL 凭据，将导致 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 失败，且不会执行任何备份。</span><span class="sxs-lookup"><span data-stu-id="78ecd-132">**Changes to Azure Storage Account:** Deleting or renaming storage account without corresponding changes to the SQL Credential will cause [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to fail and no backups will be taken.</span></span> <span data-ttu-id="78ecd-133">如果删除存储帐户，则务必用有效的存储帐户信息重新配置数据库。</span><span class="sxs-lookup"><span data-stu-id="78ecd-133">If you delete a storage account, ensure that the databases are reconfigured with valid storage account information.</span></span> <span data-ttu-id="78ecd-134">如果重命名了存储帐户或更改了密钥值，请确保这些更改反映在[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]使用的 SQL 凭据中。</span><span class="sxs-lookup"><span data-stu-id="78ecd-134">If a storage account is renamed or the key values are changed, ensure that these changes are reflected in the SQL Credential used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span>  
  
4.  <span data-ttu-id="78ecd-135">**数据库属性的更改：** 更改恢复模式或更改名称可能导致备份失败。</span><span class="sxs-lookup"><span data-stu-id="78ecd-135">**Changes to Database Properties:** Changes to recovery models or changing the name can cause backups to fail.</span></span>  
  
5.  <span data-ttu-id="78ecd-136">对**恢复模式的更改：** 如果数据库的恢复模式从完整或大容量日志更改为简单，则备份将停止，并将跳过这些数据库 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="78ecd-136">**Changes to Recovery Model:** If the recovery model of the database is changed to simple from full or bulk-logged, backups will stop, and the databases will be skipped by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="78ecd-137">有关详细信息，请参阅[SQL Server 托管备份到 Azure：互操作性和共存](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)</span><span class="sxs-lookup"><span data-stu-id="78ecd-137">For more information, see [SQL Server Managed Backup to Azure: Interoperability and Coexistence](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)</span></span>  
  
### <a name="most-common-error-messages-and-solutions"></a><span data-ttu-id="78ecd-138">最常见的错误消息和解决方案</span><span class="sxs-lookup"><span data-stu-id="78ecd-138">Most Common Error Messages and Solutions</span></span>  
  
1.  <span data-ttu-id="78ecd-139">**启用或配置时出现错误 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ：**</span><span class="sxs-lookup"><span data-stu-id="78ecd-139">**Errors when enabling or configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]:**</span></span>  
  
     <span data-ttu-id="78ecd-140">错误： "无法访问存储 URL ...。提供有效的 SQL 凭据 ... "：你可能会看到此错误和其他引用 SQL 凭据的类似错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-140">Error: " Failed to access the storage URL.... Provide a valid SQL Credential..." : You may see this and other similar errors referring to SQL Credentials.</span></span>  <span data-ttu-id="78ecd-141">在这种情况下，请检查提供的 SQL 凭据的名称，以及存储在 SQL 凭据中的信息-存储帐户名称和存储访问密钥，并确保它们是最新的并且有效。</span><span class="sxs-lookup"><span data-stu-id="78ecd-141">In such cases, review the name of the SQL Credential you provided, and also the information stored in the SQL Credential - the storage account name, and the storage access key and make sure that they are current and valid.</span></span>  
  
     <span data-ttu-id="78ecd-142">错误： ".。。无法配置数据库 ...。因为它是系统数据库 "：如果您尝试启用系统数据库，则会看到此错误 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="78ecd-142">Error: "... cannot configure the database....because it is a system database": You will see this error if you try to enable [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a system database.</span></span>  [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="78ecd-143">不支持系统数据库备份。</span><span class="sxs-lookup"><span data-stu-id="78ecd-143">does not support backups for system databases.</span></span>  <span data-ttu-id="78ecd-144">要为系统数据库配置备份，请使用其他 SQL Server 备份计术，如维护计划。</span><span class="sxs-lookup"><span data-stu-id="78ecd-144">To configure backup for a system database use other SQL Server Backup technologies such as maintenance plans.</span></span>  
  
     <span data-ttu-id="78ecd-145">错误： ".。。提供 "保持期 ..."：如果你在首次配置这些值时未指定数据库或实例的保留期，则可能会看到有关保持期的错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-145">Error:" ... Provide a retention period...." : You may see errors regarding the retention period if you either have not specified a retention period for the database or instance when you are configuring these values for the first time.</span></span> <span data-ttu-id="78ecd-146">如果您提供的不是 1 到 30 之间的值，可能也会看到错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-146">You may also see an error if you provide a value other than a number between 1 and 30.</span></span> <span data-ttu-id="78ecd-147">允许对保持期使用的值为 1 到 30 之间的数字。</span><span class="sxs-lookup"><span data-stu-id="78ecd-147">The allowed value for the retention period is a number between 1 and 30.</span></span>  
  
2.  <span data-ttu-id="78ecd-148">**电子邮件通知错误：**</span><span class="sxs-lookup"><span data-stu-id="78ecd-148">**Email Notification Errors:**</span></span>  
  
     <span data-ttu-id="78ecd-149">错误： "数据库邮件未启用 ..."-如果启用电子邮件通知，但未在实例上配置数据库邮件，则会看到此错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-149">Error: "Database Mail is not enabled..." - You will see this error if you enable e-mail notifications, but Database Mail is not configured on the instance.</span></span> <span data-ttu-id="78ecd-150">您必须在实例上配置数据库邮件，才能接收关于[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]运行状态的通知。</span><span class="sxs-lookup"><span data-stu-id="78ecd-150">You must configure Database Mail on the instance to be able to receive notification of the health status of [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="78ecd-151">有关如何启用数据库邮件的信息，请参阅[Configure 数据库邮件](../relational-databases/database-mail/configure-database-mail.md)。</span><span class="sxs-lookup"><span data-stu-id="78ecd-151">For information about how to enable database mail, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span> <span data-ttu-id="78ecd-152">要使用数据库邮件接收通知，您还必须启用 SQL Server 代理。</span><span class="sxs-lookup"><span data-stu-id="78ecd-152">You must also enable SQL Server Agent to use Database Mail for notifications.</span></span> <span data-ttu-id="78ecd-153">有关详细信息，请参阅[开始之前](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin)。</span><span class="sxs-lookup"><span data-stu-id="78ecd-153">For more information, see [Before You Begin](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin).</span></span>  
  
     <span data-ttu-id="78ecd-154">以下是可能看到的与电子邮件通知关联的错误编号的列表：</span><span class="sxs-lookup"><span data-stu-id="78ecd-154">Following is a list of error numbers you might see that are associated with email notifications:</span></span>  
  
    -   <span data-ttu-id="78ecd-155">错误号：45209</span><span class="sxs-lookup"><span data-stu-id="78ecd-155">ErrorNumber: 45209</span></span>  
  
    -   <span data-ttu-id="78ecd-156">错误号：45210</span><span class="sxs-lookup"><span data-stu-id="78ecd-156">ErrorNumber: 45210</span></span>  
  
    -   <span data-ttu-id="78ecd-157">ErrorNumber：45211</span><span class="sxs-lookup"><span data-stu-id="78ecd-157">ErrorNumber: 45211</span></span>  
  
3.  <span data-ttu-id="78ecd-158">**连接错误：**</span><span class="sxs-lookup"><span data-stu-id="78ecd-158">**Connectivity Errors:**</span></span>  
  
    -   <span data-ttu-id="78ecd-159">**与 SQL 连接相关的错误：** 如果连接 SQL Server 实例时出现问题，则会出现这些错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-159">**Errors Related to SQL Connectivity:** These errors happen when there are issues connecting to SQL Server instance.</span></span> <span data-ttu-id="78ecd-160">扩展事件通过管理通道公开这些类型的错误。</span><span class="sxs-lookup"><span data-stu-id="78ecd-160">The extended events expose these type of errors through the admin channel.</span></span> <span data-ttu-id="78ecd-161">以下是两个扩展事件，对于与此类型的连接问题相关的错误，可能看到这些扩展事件：</span><span class="sxs-lookup"><span data-stu-id="78ecd-161">Following are the two extended events that you might see for errors related to this type of connectivity issues:</span></span>  
  
         <span data-ttu-id="78ecd-162">FileRetentionAdminXEvent，其 event_type 为 SqlError。</span><span class="sxs-lookup"><span data-stu-id="78ecd-162">FileRetentionAdminXEvent with event_type = SqlError.</span></span> <span data-ttu-id="78ecd-163">有关此错误的详细信息，请查看该事件的 error_code、error_message 和 stack_trace。</span><span class="sxs-lookup"><span data-stu-id="78ecd-163">For details of this error, look at the error_code, error_message and stack_trace of that event.</span></span> <span data-ttu-id="78ecd-164">Error_code 是 SqlException 的错误号。</span><span class="sxs-lookup"><span data-stu-id="78ecd-164">The error_code is the SqlException's error number.</span></span>  
  
         <span data-ttu-id="78ecd-165">具有以下消息/消息前缀的 SmartBackupAdminXevent：</span><span class="sxs-lookup"><span data-stu-id="78ecd-165">SmartBackupAdminXevent with the following messages/message prefixes:</span></span>  
  
         <span data-ttu-id="78ecd-166">*"配置 SQL Server 托管备份到 Azure 的默认设置时出现内部错误。错误可能是暂时性的。 "*</span><span class="sxs-lookup"><span data-stu-id="78ecd-166">*"An internal error occurred while configuring SQL Server Managed Backup to Azure default settings for instance. Error might be transient."*</span></span>  
  
         <span data-ttu-id="78ecd-167">*"可能遇到 SQL Server 的连接问题。正在跳过当前迭代中的数据库。 "*</span><span class="sxs-lookup"><span data-stu-id="78ecd-167">*"Probably experiencing connectivity issues with SQL Server. Skipping database in the current iteration."*</span></span>  
  
         <span data-ttu-id="78ecd-168">*"查询日志使用情况信息失败。失败可能是暂时性的。正在跳过当前迭代中的数据库。 "*</span><span class="sxs-lookup"><span data-stu-id="78ecd-168">*"Querying log usage info failed. The failure might be transient. Skipping database in the current iteration."*</span></span>  
  
         <span data-ttu-id="78ecd-169">*"加载 SSMBackup2WA 代理元数据时遇到 SQL 异常。失败可能是暂时性的。操作将重试。 "*</span><span class="sxs-lookup"><span data-stu-id="78ecd-169">*"SQL exception encountered while loading SSMBackup2WA agent metadata. The failure might be transient. Operation will be retried."*</span></span>  
  
         <span data-ttu-id="78ecd-170">*"SSMBackup2WA 遇到了 SQL 异常 .。。"*</span><span class="sxs-lookup"><span data-stu-id="78ecd-170">*"SSMBackup2WA encountered SQL exception while ... "*</span></span>  
  
    -   <span data-ttu-id="78ecd-171">**连接到存储帐户出错：**</span><span class="sxs-lookup"><span data-stu-id="78ecd-171">**Errors Connecting to the storage account:**</span></span>  
  
         <span data-ttu-id="78ecd-172">在 event_type 为 XstoreError 的 FileRetentionAdminXEvent 中报告存储异常。</span><span class="sxs-lookup"><span data-stu-id="78ecd-172">Storage exceptions are reported in FileRetentionAdminXEvent with event_type = XstoreError.</span></span> <span data-ttu-id="78ecd-173">有关此错误的详细信息，请查看该事件的 error_message 和 stack_trace。</span><span class="sxs-lookup"><span data-stu-id="78ecd-173">For details of the error, look at the error_message and stack_trace of that event.</span></span>  
  
         <span data-ttu-id="78ecd-174">由于 SQL Server 托管备份使用基础的“备份到 URL”技术，因此与存储连接相关的错误同时适用于两个功能。</span><span class="sxs-lookup"><span data-stu-id="78ecd-174">Since SQL Server Managed Backup uses the underlying Backup to URL technology, the errors related to storage connectivity apply to both the features.</span></span> <span data-ttu-id="78ecd-175">有关故障排除步骤的详细信息，请参阅[SQL Server 备份到 URL 最佳做法和故障排除](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)一文中的 "**故障排除" 一节**。</span><span class="sxs-lookup"><span data-stu-id="78ecd-175">For more information on troubleshooting steps, see **troubleshooting section** of the [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md) article.</span></span>  
  
### <a name="troubleshooting-system-issues"></a><span data-ttu-id="78ecd-176">排除系统问题</span><span class="sxs-lookup"><span data-stu-id="78ecd-176">Troubleshooting System Issues</span></span>  
 <span data-ttu-id="78ecd-177">以下是系统（SQL Server、SQL Server 代理）有问题的一些场景及其对[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]的影响：</span><span class="sxs-lookup"><span data-stu-id="78ecd-177">Following are some scenarios when there is an issue with the system (SQL Server, SQL Server Agent) and its effects on [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]:</span></span>  
  
-   <span data-ttu-id="78ecd-178">**Sqlservr.exe 在运行时停止响应或停止工作 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ：** 如果 SQL Server 停止工作，则 sql 代理将正常关闭， [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] 同时停止，并在 SQL 代理中记录事件。</span><span class="sxs-lookup"><span data-stu-id="78ecd-178">**Sqlservr.exe stops responding or stops working when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is running:** If SQL Server stops working, SQL Agent will gracefully shut down, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] also stops and the events are logged in SQL Agent.out file.</span></span>  
  
     <span data-ttu-id="78ecd-179">如果 SQL Server 停止响应，则在管理通道中记录事件。</span><span class="sxs-lookup"><span data-stu-id="78ecd-179">If SQL Server stops responding, events are logged in the admin channel.</span></span>  <span data-ttu-id="78ecd-180">事件日志的一个示例：</span><span class="sxs-lookup"><span data-stu-id="78ecd-180">An example of the event log:</span></span>  
  
     <span data-ttu-id="78ecd-181">*Sql 错误 (引擎未响应或获取 sqlException： SqlException：* </span><span class="sxs-lookup"><span data-stu-id="78ecd-181">*Sql Error (engine not responding or get sqlException: SqlException:* </span></span>  
     <span data-ttu-id="78ecd-182">*错误代码、消息和 stacktrace 将显示在管理通道 xevent 中，以及一些额外的信息，例如：* </span><span class="sxs-lookup"><span data-stu-id="78ecd-182">*error code, message and stacktrace will be displayed in an admin channel xevent, together with some extra information, such as :* </span></span>  
    <span data-ttu-id="78ecd-183">*"可能遇到 SQL Server 的连接问题。正在当前迭代中跳过数据库 "*</span><span class="sxs-lookup"><span data-stu-id="78ecd-183">*"Probably experiencing connectivity issues with SQL Server. Skipping database in the current iteration"*</span></span>  
  
-   <span data-ttu-id="78ecd-184">**SQL 代理在运行时停止响应或停止工作 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] ：**</span><span class="sxs-lookup"><span data-stu-id="78ecd-184">**SQL Agent stops responding or stops working when [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is running:**</span></span>  
  
     <span data-ttu-id="78ecd-185">如果 SQL 代理停止工作，则[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]也会停止，而管理通道中将记录事件。</span><span class="sxs-lookup"><span data-stu-id="78ecd-185">If SQL Agent stops working, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] also stops and events are logged in the admin channel.</span></span> <span data-ttu-id="78ecd-186">这与 SQL Server 停止响应时的场景类似。</span><span class="sxs-lookup"><span data-stu-id="78ecd-186">This is similar to the scenarios when SQL Server stops responding.</span></span>  
  
     <span data-ttu-id="78ecd-187">如果 SQL 代理停止响应，则[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]将无法继续进行备份操作，而管理通道中将记录事件。</span><span class="sxs-lookup"><span data-stu-id="78ecd-187">If SQL Agent stops responding, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will be unable to continue with backup operations, and events are logged in the admin channel.</span></span> <span data-ttu-id="78ecd-188">事件日志的一个示例：</span><span class="sxs-lookup"><span data-stu-id="78ecd-188">An example of the event log:</span></span>  
  
     <span data-ttu-id="78ecd-189">*作业挂起：请参阅管理通道 xevents* </span><span class="sxs-lookup"><span data-stu-id="78ecd-189">*Job hangs: see admin channel xevents* </span></span>  
    <span data-ttu-id="78ecd-190">*"数据库备份的 DBBackupInfoMsgMaxWaitTime +" 小时内未收到 SQL Server 的进度更新。  SSM 云备份将继续等待。 "*</span><span class="sxs-lookup"><span data-stu-id="78ecd-190">*"A progress update hasn't been received from SQL Server in more than " + Constants.DBBackupInfoMsgMaxWaitTime  + " hours for database backup.   SSM Cloud Backup will continue to wait."*</span></span>  
  
 <span data-ttu-id="78ecd-191">如果已启用电子邮件通知，则将收到一条通知，其中包含**备份循环数**和**保留循环数**。</span><span class="sxs-lookup"><span data-stu-id="78ecd-191">If you have enabled email notification, you will receive a notification which includes **Number of Backup Loops** and **Number of Retention Loops**.</span></span> <span data-ttu-id="78ecd-192">如果通知中返回的其中一列的值为零或两列的值都为零，则可能表示系统未响应。</span><span class="sxs-lookup"><span data-stu-id="78ecd-192">If the value returned in the notification for one or both of these two columns is zero, it could be an indication that the system is not responding.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="78ecd-193">生成报表结果的内部进程，假设引擎诊断日志与 SQL 代理错误日志处于同一位置，默认为在 SQL Server 实例的错误日志所在的文件夹中。</span><span class="sxs-lookup"><span data-stu-id="78ecd-193">The internal processes that generate the results for the report, assumes that the engine diagnostic logs are in the same location of SQL Agent error log, which by default is in the same folder as the error logs of the SQL Server instance.</span></span> <span data-ttu-id="78ecd-194">如果引擎诊断日志移到与 SQL 代理错误日志位置不同的位置，系统就找不到智能备份诊断日志，电子邮件通知中的报表也就可能不正确。</span><span class="sxs-lookup"><span data-stu-id="78ecd-194">If the engine diagnostic logs are moved to a location other than SQL Agent error log location, the system is unable to find the smart backup diagnostic logs, and hence the report in the email notification may not be correct.</span></span> <span data-ttu-id="78ecd-195">例如，你可能会在报告的所有字段中看到值**0** ，包括备份循环数和保留循环数。</span><span class="sxs-lookup"><span data-stu-id="78ecd-195">For example, you might see a value of **0** in all the fields reported including the Number of Backup Loops and Number of Retention Loops.</span></span> <span data-ttu-id="78ecd-196">在这种情况下，诊断日志已移动到其他位置，这不表示系统不响应，只是系统找不到日志。</span><span class="sxs-lookup"><span data-stu-id="78ecd-196">In this case where the diagnostic logs are moved to a different location, it may not mean that the system is not responding, but that the system is unable to find the logs.</span></span> <span data-ttu-id="78ecd-197">首先应确保诊断日志的位置和 SQL 代理错误日志处于同一位置。</span><span class="sxs-lookup"><span data-stu-id="78ecd-197">Ensure that the location of the diagnostic logs and SQL Agent error logs are at the same location first.</span></span> <span data-ttu-id="78ecd-198">若要验证诊断日志的当前位置，可以使用[sys. dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations)。</span><span class="sxs-lookup"><span data-stu-id="78ecd-198">To verify the current location of the diagnostic logs, you can use [sys.dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations).</span></span> <span data-ttu-id="78ecd-199">`path`列返回引擎诊断日志的当前位置。</span><span class="sxs-lookup"><span data-stu-id="78ecd-199">The `path` column returns the current location of the engine diagnostic logs.</span></span>  <span data-ttu-id="78ecd-200">它应与 SQL 代理错误日志位于同一文件夹中。</span><span class="sxs-lookup"><span data-stu-id="78ecd-200">It should be in the same folder as the SQL Agent error logs.</span></span> <span data-ttu-id="78ecd-201">使用 `dbo.sp_get_sqlagent_properties` 存储过程可以获取 SQL 代理错误日志路径。</span><span class="sxs-lookup"><span data-stu-id="78ecd-201">You can get SQL Agent error log path using the `dbo.sp_get_sqlagent_properties` stored procedure.</span></span>  
  
 <span data-ttu-id="78ecd-202">检查扩展事件日志以了解错误的详细信息。</span><span class="sxs-lookup"><span data-stu-id="78ecd-202">Check the extended event logs to see details of the errors.</span></span> <span data-ttu-id="78ecd-203">修复错误或重新启动 SQL Server Agent 以更正该状况。</span><span class="sxs-lookup"><span data-stu-id="78ecd-203">fix the errors, or restart SQL Server Agent to correct the situation.</span></span>  
  
  

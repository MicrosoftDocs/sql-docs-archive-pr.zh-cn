---
title: 将客户端连接到数据库镜像会话 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- partners [SQL Server], connecting clients to
- database mirroring [SQL Server], connecting clients to
- client connections [SQL Server], database mirroring
- connections [SQL Server], database mirroring
ms.assetid: 0d5d2742-2614-43de-9ab9-864addb6299b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 16faa8d02a22fba3e4cfa4cbe0bd6558fc140fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87579770"
---
# <a name="connect-clients-to-a-database-mirroring-session-sql-server"></a><span data-ttu-id="c6839-102">将客户端连接到数据库镜像会话 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="c6839-102">Connect Clients to a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="c6839-103">若要连接到数据库镜像会话，客户端可以使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client 或 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的 .NET Framework 数据访问接口。</span><span class="sxs-lookup"><span data-stu-id="c6839-103">To connect to a database mirroring session, a client can use either [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client or .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="c6839-104">针对 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 数据库进行配置时，这些数据访问接口完全支持数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="c6839-104">When configured for a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database, these data access providers both fully support database mirroring.</span></span> <span data-ttu-id="c6839-105">有关使用镜像数据库的编程注意事项的信息，请参阅 [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="c6839-105">For information about programming considerations for using a mirrored database, see [Using Database Mirroring](../../relational-databases/native-client/features/using-database-mirroring.md).</span></span> <span data-ttu-id="c6839-106">此外，当前主体服务器实例必须可用，并且必须已在服务器实例上创建客户端登录。</span><span class="sxs-lookup"><span data-stu-id="c6839-106">In addition, the current principal server instance must be available and the login of the client must have been created on the server instance.</span></span> <span data-ttu-id="c6839-107">有关详细信息，请参阅 [孤立用户故障排除 (SQL Server)](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="c6839-107">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](../../sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server.md).</span></span> <span data-ttu-id="c6839-108">客户端与数据库镜像会话的连接不涉及见证服务器实例（如果存在）。</span><span class="sxs-lookup"><span data-stu-id="c6839-108">Client connections to a database mirroring session do not involve the witness server instance, if one exists.</span></span>  
  
 ##  <a name="making-the-initial-connection-to-a-database-mirroring-session"></a><a name="InitialConnection"></a> <span data-ttu-id="c6839-109">建立到数据库镜像会话的初始连接</span><span class="sxs-lookup"><span data-stu-id="c6839-109">Making the Initial Connection to a Database Mirroring Session</span></span>  
 <span data-ttu-id="c6839-110">对于到镜像数据库的初始连接，客户端必须提供一个至少提供服务器实例名称的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="c6839-110">For the initial connection to a mirrored database, a client must supply a connection string that minimally supplies the name of a server instance.</span></span> <span data-ttu-id="c6839-111">这个必需的服务器名称应标识当前主体服务器实例，并称为“初始伙伴名称” 。</span><span class="sxs-lookup"><span data-stu-id="c6839-111">This required server name should identify the current principal server instance and is known as the *initial partner name*.</span></span>  
  
 <span data-ttu-id="c6839-112">另外，连接字符串还可以提供另一个服务器实例的名称，此名称应标识当前镜像服务器实例，以便在首次连接尝试期间初始伙伴不可用的情况下使用。</span><span class="sxs-lookup"><span data-stu-id="c6839-112">Optionally, the connection string can also supply the name of another server instance, which should identify the current mirror server instance, for use if the initial partner is unavailable during the first connection attempt.</span></span> <span data-ttu-id="c6839-113">第二个名称称为“故障转移伙伴名称” 。</span><span class="sxs-lookup"><span data-stu-id="c6839-113">The second name is known as the *failover partner name*.</span></span>  
  
 <span data-ttu-id="c6839-114">连接字符串还必须提供数据库名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-114">The connection string must also supply a database name.</span></span> <span data-ttu-id="c6839-115">这是数据访问接口启用故障转移尝试所必需的。</span><span class="sxs-lookup"><span data-stu-id="c6839-115">This is necessary to enable failover attempts by the data access provider.</span></span>  
  
 <span data-ttu-id="c6839-116">接收连接字符串后，数据访问接口将初始伙伴名称和故障转移伙伴名称（如果提供）存储在客户端易失内存的缓存中（对于托管代码，缓存的作用域限定为应用程序域）。</span><span class="sxs-lookup"><span data-stu-id="c6839-116">On receiving a connection string, the data access provider stores the initial partner name and the failover partner name, if supplied, in a cache in the client's volatile memory (for managed code, the cache is scoped to the application domain).</span></span> <span data-ttu-id="c6839-117">缓存后，数据访问接口将从不对初始伙伴名称进行更新。</span><span class="sxs-lookup"><span data-stu-id="c6839-117">Once cached, the initial partner name is never updated by the data access provider.</span></span> <span data-ttu-id="c6839-118">客户端提供故障转移伙伴名称时，数据访问接口还暂时存储此故障转移伙伴名称，以防出现访问接口无法使用初始伙伴名称进行连接的情况。</span><span class="sxs-lookup"><span data-stu-id="c6839-118">When the client supplies the failover partner name, the data access provider also stores this failover partner name temporarily in case the provider cannot connect using the initial partner name.</span></span>  
  
 <span data-ttu-id="c6839-119">数据库镜像会话无法避免与客户端相关的服务器访问问题，例如，客户端计算机出现网络通信问题时。</span><span class="sxs-lookup"><span data-stu-id="c6839-119">A database mirroring session does not protect against server-access problems that are specific to clients, such as when a client computer is having a problems communicating with the network.</span></span> <span data-ttu-id="c6839-120">到镜像数据库的连接尝试也可能会因为各种与数据访问接口无关的原因而失败；例如，连接尝试可能会因为下列情况而失败：主体服务器实例处于不活动状态（如同数据库进行故障转移时发生的情况）或者网络错误。</span><span class="sxs-lookup"><span data-stu-id="c6839-120">A connection attempt to a mirrored database can also fail for a variety of reasons that are unrelated to the data-access provider; for example, a connection attempt can fail because the principal server instance is inactive, as occurs when the database is failing over, or because of a network error.</span></span>  
  
 <span data-ttu-id="c6839-121">尝试连接时，数据访问接口首先使用初始伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-121">When attempting to connect, the data access provider begins by using the initial partner name.</span></span> <span data-ttu-id="c6839-122">如果指定的服务器实例可用并且为当前主体服务器实例，则连接尝试通常都会成功。</span><span class="sxs-lookup"><span data-stu-id="c6839-122">If the specified server instance is available and is the current principal server instance, the connection attempt typically succeeds.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-123">如果镜像会话暂停，则客户端通常连接到主体服务器并下载伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-123">If the mirroring session is paused, the client typically connects to the principal server and the downloads the partner name.</span></span> <span data-ttu-id="c6839-124">但是，在恢复镜像之前，数据库不可用于客户端。</span><span class="sxs-lookup"><span data-stu-id="c6839-124">However, the database is unavailable to the client until mirroring resumes.</span></span>  
  
 <span data-ttu-id="c6839-125">如果此尝试失败，则数据访问接口将尝试使用故障转移伙伴名称（如果可用）。</span><span class="sxs-lookup"><span data-stu-id="c6839-125">If that attempt does not work, the data access provider tries the failover partner name, if available.</span></span> <span data-ttu-id="c6839-126">如果任一伙伴名称都正确标识了当前主体服务器，则数据访问接口通常都会成功打开初始连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-126">If either partner name correctly identifies the current principal server, the data access provider normally succeeds in opening the initial connection.</span></span> <span data-ttu-id="c6839-127">完成此连接后，数据访问接口将下载当前镜像服务器的服务器实例名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-127">On completing this connection, the data access provider downloads the server instance name of the current mirror server.</span></span> <span data-ttu-id="c6839-128">此名称作为故障转移伙伴名称存储在缓存中，从而覆盖客户端提供的故障转移伙伴名称（如果有）。</span><span class="sxs-lookup"><span data-stu-id="c6839-128">This name is stored in the cache as the failover partner name, overwriting the client-supplied failover partner name, if any.</span></span> <span data-ttu-id="c6839-129">此后，.NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 不会更新故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-129">Thereafter, the .NET Framework Data Provider for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] does not update the failover partner name.</span></span> <span data-ttu-id="c6839-130">相反，每当后续连接或连接重置返回不同的伙伴名称时， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client 便会更新高速缓存。</span><span class="sxs-lookup"><span data-stu-id="c6839-130">In contrast, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client updates the cache whenever a subsequent connection or connection reset returns a different partner name.</span></span>  
  
 <span data-ttu-id="c6839-131">下图针对名为 **Db_1**的镜像数据库说明了到初始伙伴 **Partner_A**的客户端连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-131">The following figure illustrates a client connection to the initial partner, **Partner_A**, for a mirrored database named **Db_1**.</span></span> <span data-ttu-id="c6839-132">此图显示的情况是：客户端提供的初始伙伴名称正确标识了当前主体服务器 **Partner_A**。</span><span class="sxs-lookup"><span data-stu-id="c6839-132">This figure shows a case in which the initial partner name supplied by the client correctly identifies the current principal server, **Partner_A**.</span></span> <span data-ttu-id="c6839-133">初始连接尝试成功，数据访问接口在其本地缓存中将镜像服务器（当前为 **Partner_B**）的名称存储为故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-133">The initial connection attempt succeeds, and the data access provider stores the name of the mirror server (currently **Partner_B**) as the failover partner name in the local cache.</span></span> <span data-ttu-id="c6839-134">最后，客户端连接到 **Db_1** 数据库的主体副本。</span><span class="sxs-lookup"><span data-stu-id="c6839-134">Finally, the client connects to the principal copy of the **Db_1** database.</span></span>  
  
 <span data-ttu-id="c6839-135">![初始伙伴为主体的客户端连接](../media/dbm-initial-connection.gif "初始伙伴为主体的客户端连接")</span><span class="sxs-lookup"><span data-stu-id="c6839-135">![Client connection if initial partner is principal](../media/dbm-initial-connection.gif "Client connection if initial partner is principal")</span></span>  
  
 <span data-ttu-id="c6839-136">初始连接尝试可能会失败，例如，因为网络错误或不活动的服务器实例。</span><span class="sxs-lookup"><span data-stu-id="c6839-136">The initial connection attempt may fail, for example, because of a network error or an inactive server instance.</span></span> <span data-ttu-id="c6839-137">由于初始伙伴不可用，因此要让数据访问接口尝试连接到故障转移伙伴，客户端必须在连接字符串中提供故障转移伙伴的名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-137">Because the initial partner is unavailable, for the data access provider to attempt to connect to the failover partner, the client must have supplied the failover partner name in the connection string.</span></span>  
  
 <span data-ttu-id="c6839-138">在这种情况下，如果故障转移伙伴名称不可用，则原始连接尝试将继续，直到网络连接超时或返回错误（与非镜像数据库的情况相同）。</span><span class="sxs-lookup"><span data-stu-id="c6839-138">In that case, if the failover partner name is unavailable, the original connection attempt continues until the network connection timeout or an error is returned (just as for a non-mirrored database).</span></span>  
  
 <span data-ttu-id="c6839-139">连接字符串中提供故障转移伙伴名称时，数据访问接口的行为取决于网络协议和客户端的操作系统，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c6839-139">When the failover partner name is supplied in the connection string, the behavior of the data access provider depends on the network protocol and operating system of the client, as follows:</span></span>  
  
-   <span data-ttu-id="c6839-140">对于 TCP/IP，使用与数据库镜像相关的连接重试算法调整连接尝试。</span><span class="sxs-lookup"><span data-stu-id="c6839-140">For TCP/IP, the connection attempts are regulated by a connection retry algorithm that is specific to database mirroring.</span></span> <span data-ttu-id="c6839-141">连接重试算法确定在给定连接尝试中为打开连接所分配的最长时间（重试时间）。</span><span class="sxs-lookup"><span data-stu-id="c6839-141">The *connection retry algorithm* determines the maximum time (the *retry time*) allotted for opening a connection in a given connection attempt.</span></span>  
  
-   <span data-ttu-id="c6839-142">对于其他网络协议</span><span class="sxs-lookup"><span data-stu-id="c6839-142">For other network protocols</span></span>  
  
     <span data-ttu-id="c6839-143">如果发生错误或者初始伙伴不可用，则初始连接尝试将处于等待状态，直到数据访问接口上的网络连接超时期限过期或登录超时期限过期。</span><span class="sxs-lookup"><span data-stu-id="c6839-143">If an error occurs or if the initial partner is unavailable, the initial connection attempt waits until the network connection timeout period expires or the login timeout period expires on the data access provider.</span></span> <span data-ttu-id="c6839-144">通常，此等待时间大约为 20 至 30 秒。</span><span class="sxs-lookup"><span data-stu-id="c6839-144">Typically, this wait is on the order of 20 to 30 seconds.</span></span> <span data-ttu-id="c6839-145">此后，如果数据访问接口尚未超时，则它会尝试连接到故障转移伙伴。</span><span class="sxs-lookup"><span data-stu-id="c6839-145">Thereafter, if the data access provider has not timed out, it attempts to connect to the failover partner.</span></span> <span data-ttu-id="c6839-146">如果连接超时期限过期而未成功连接或者故障转移伙伴不可用，则连接尝试会失败。</span><span class="sxs-lookup"><span data-stu-id="c6839-146">If the connection timeout period expires before the connection succeeds or the failover partner is unavailable, the connection attempt fails.</span></span> <span data-ttu-id="c6839-147">如果故障转移伙伴在登录超时期限内可用并且现在为主体服务器，则连接尝试通常都会成功。</span><span class="sxs-lookup"><span data-stu-id="c6839-147">If failover partner is available within the login timeout period and is now the principal server, the connection attempt normally succeeds.</span></span>  

  
### <a name="connection-strings-for-a-mirrored-database"></a><span data-ttu-id="c6839-148">镜像数据库的连接字符串</span><span class="sxs-lookup"><span data-stu-id="c6839-148">Connection Strings for a Mirrored Database</span></span>  
 <span data-ttu-id="c6839-149">客户端提供的连接字符串包含数据访问接口用于连接到数据库的信息。</span><span class="sxs-lookup"><span data-stu-id="c6839-149">The connection string supplied by the client contains information that the data access provider uses to connect to the database.</span></span> <span data-ttu-id="c6839-150">本部分介绍了与使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC 驱动程序连接连接到镜像数据库特定相关的关键字。</span><span class="sxs-lookup"><span data-stu-id="c6839-150">This section discusses the keywords that are specifically relevant for connecting to a mirrored database using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC Driver Connection.</span></span>  
  
#### <a name="network-attribute"></a><span data-ttu-id="c6839-151">Network 属性</span><span class="sxs-lookup"><span data-stu-id="c6839-151">Network Attribute</span></span>  
 <span data-ttu-id="c6839-152">连接字符串应包含 **Network** 属性，以指定网络协议。</span><span class="sxs-lookup"><span data-stu-id="c6839-152">The connection string should contain the **Network** attribute to specify the network protocol.</span></span> <span data-ttu-id="c6839-153">这可确保到不同伙伴的连接之间存在指定的网络协议。</span><span class="sxs-lookup"><span data-stu-id="c6839-153">This ensures that the specified network protocol persists between connections to different partners.</span></span> <span data-ttu-id="c6839-154">连接到镜像数据库的最佳协议是 TCP/IP。</span><span class="sxs-lookup"><span data-stu-id="c6839-154">The best protocol for connecting to a mirrored database is TCP/IP.</span></span> <span data-ttu-id="c6839-155">为了确保客户端针对每个到伙伴的连接都请求 TCP/IP，连接字符串提供以下属性：</span><span class="sxs-lookup"><span data-stu-id="c6839-155">To ensure that the client requests TCP/IP for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbmssocn;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c6839-156">建议将 TCP/IP 始终放在客户端协议列表的顶部。</span><span class="sxs-lookup"><span data-stu-id="c6839-156">We recommend keeping TCP/IP at the top of a client's protocol list.</span></span> <span data-ttu-id="c6839-157">不过，如果连接字符串指定了 **Network** 属性，则会替代列表顺序。</span><span class="sxs-lookup"><span data-stu-id="c6839-157">However, if the connection string specifies the **Network** attribute, this overrides the list order.</span></span>  
  
 <span data-ttu-id="c6839-158">另外，为了确保客户端针对每个到伙伴的连接都请求 Named Pipes，连接字符串提供以下属性：</span><span class="sxs-lookup"><span data-stu-id="c6839-158">Alternatively, to ensure that the client requests named pipes for every connection to the partners, a connection string supplies the following attribute:</span></span>  
  
```  
Network=dbnmpntw;   
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c6839-159">由于 Named Pipes 不使用 TCP/IP 重试算法，因此在很多情况下，Named Pipes 连接尝试可能会在连接到镜像数据库之前超时。</span><span class="sxs-lookup"><span data-stu-id="c6839-159">Because named pipes does not use the TCP/IP retry algorithm, in many cases, a named pipes connection attempt may time out before connecting to a mirrored database.</span></span>  
  
#### <a name="server-attribute"></a><span data-ttu-id="c6839-160">Server 属性</span><span class="sxs-lookup"><span data-stu-id="c6839-160">Server Attribute</span></span>  
 <span data-ttu-id="c6839-161">连接字符串必须包含 `Server` 属性以提供初始伙伴名称，该名称应标识当前主体服务器实例。</span><span class="sxs-lookup"><span data-stu-id="c6839-161">The connection string must contain a `Server` attribute that supplies the initial partner name, which should identify the current principal server instance.</span></span>  
  
 <span data-ttu-id="c6839-162">标识服务器实例的最简单方法是指定其名称 *<server_name>* [ **\\** _<SQL_Server_instance_name>_ ]。</span><span class="sxs-lookup"><span data-stu-id="c6839-162">The simplest way to identify the server instance is by specifying its name , *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span> <span data-ttu-id="c6839-163">例如：</span><span class="sxs-lookup"><span data-stu-id="c6839-163">For example:</span></span>  
  
 `Server=Partner_A;`  
  
 <span data-ttu-id="c6839-164">或</span><span class="sxs-lookup"><span data-stu-id="c6839-164">or</span></span>  
  
 `Server=Partner_A\Instance_2;`  
  
 <span data-ttu-id="c6839-165">但是，使用系统名称时，客户端必须执行 DNS 查找以获取服务器的 IP 地址，执行 SQL Server Browser 查询以获取伙伴所在服务器的端口号。</span><span class="sxs-lookup"><span data-stu-id="c6839-165">However, when the system name is used, the client must perform a DNS lookup to obtain the IP address of the server and a SQL Server Browser query to obtain the port number of the server on which the partner resides.</span></span> <span data-ttu-id="c6839-166">通过在 `Server` 属性中指定伙伴的 IP 地址和端口号而不是指定服务器名称，可以跳过这些查找和查询。</span><span class="sxs-lookup"><span data-stu-id="c6839-166">Those lookups and queries can be bypassed by specifying the IP address and port number of the partner in the `Server` attribute, rather than specifying the server name.</span></span> <span data-ttu-id="c6839-167">建议跳过这些查找和查询，以最大程度地降低连接到此伙伴时出现外部延迟的几率。</span><span class="sxs-lookup"><span data-stu-id="c6839-167">This is recommended to minimize the possibility of external delays while connecting to that partner.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-168">如果连接字符串指定命名实例的名称而不是端口，则 SQL Server Browser 查询是必需的。</span><span class="sxs-lookup"><span data-stu-id="c6839-168">A SQL Server Browser query is necessary if the connection string specifies the named instance name and not the port.</span></span>  
  
 <span data-ttu-id="c6839-169">若要指定 IP 地址和端口， `Server` 属性采用以下格式， `Server=` *<ip_address>* `,` *\<port>* ，例如：</span><span class="sxs-lookup"><span data-stu-id="c6839-169">To specify the IP address and port, the `Server` attribute takes the following form, `Server=`*<ip_address>*`,`*\<port>*, for example:</span></span>  
  
```  
Server=123.34.45.56,4724;   
```  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-170">IP 地址可以是 IP 版本 4 (IPv4) 或 IP 版本 6 (IPv6)。</span><span class="sxs-lookup"><span data-stu-id="c6839-170">The IP address can be IP Version 4 (IPv4) or IP Version 6 (IPv6).</span></span>  
  
#### <a name="database-attribute"></a><span data-ttu-id="c6839-171">Database 属性</span><span class="sxs-lookup"><span data-stu-id="c6839-171">Database Attribute</span></span>  
 <span data-ttu-id="c6839-172">此外，连接字符串还必须指定 `Database` 属性以提供镜像数据库的名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-172">In addition, the connection string must specify the `Database` attribute to supply the name of the mirrored database.</span></span> <span data-ttu-id="c6839-173">如果客户端尝试连接时指定的数据库不可用，将引发异常。</span><span class="sxs-lookup"><span data-stu-id="c6839-173">If the database is unavailable when the client attempts to connect, an exception is raised.</span></span>  
  
 <span data-ttu-id="c6839-174">例如，若要明确连接到主体服务器 Partner_A 上的 **AdventureWorks** 数据库，客户端应使用以下连接字符串：</span><span class="sxs-lookup"><span data-stu-id="c6839-174">For example, to expressly connect to the **AdventureWorks** database on the principal server Partner_A, a client uses the following connection string:</span></span>  
  
 `" Server=Partner_A; Database=AdventureWorks "`  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-175">此字符串未包含身份验证信息。</span><span class="sxs-lookup"><span data-stu-id="c6839-175">This string omits authentication information.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c6839-176">将协议前缀与 `Server` () 的属性绑定 `Server=tcp:` *\<servername>* 不兼容**网络**属性，同时在这两个位置指定协议可能会导致错误。</span><span class="sxs-lookup"><span data-stu-id="c6839-176">Bundling the protocol prefix with the `Server` attribute (`Server=tcp:`*\<servername>*) is incompatible with the **Network** attribute, and specifying the protocol in both places will likely result in an error.</span></span> <span data-ttu-id="c6839-177">因此，建议连接字符串使用**Network**属性指定协议，并且仅在属性中指定服务器名称 `Server` (`"Network=dbmssocn; Server=` *\<servername>* `"`) 。</span><span class="sxs-lookup"><span data-stu-id="c6839-177">Therefore, we recommend that a connection string specify the protocol using the **Network** attribute and specify only the server name in the `Server` attribute (`"Network=dbmssocn; Server=`*\<servername>*`"`).</span></span>  
  
#### <a name="failover-partner-attribute"></a><span data-ttu-id="c6839-178">Failover Partner 属性</span><span class="sxs-lookup"><span data-stu-id="c6839-178">Failover Partner Attribute</span></span>  
 <span data-ttu-id="c6839-179">除了初始伙伴名称以外，客户端还可以指定应标识当前镜像服务器实例的故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-179">In addition to the initial partner name, the client can also specify failover partner name, which should identify the current mirror server instance.</span></span> <span data-ttu-id="c6839-180">故障转移伙伴是由 failover partner 属性的某个关键字指定的。</span><span class="sxs-lookup"><span data-stu-id="c6839-180">The failover partner is specified by one of the keywords for the failover partner attribute.</span></span> <span data-ttu-id="c6839-181">具体由该属性的哪个关键字指定取决于您所使用的 API。</span><span class="sxs-lookup"><span data-stu-id="c6839-181">The keyword for this attribute depends on the API that you are using.</span></span> <span data-ttu-id="c6839-182">下表列出了这些关键字：</span><span class="sxs-lookup"><span data-stu-id="c6839-182">The following table lists these keywords:</span></span>  
  
|<span data-ttu-id="c6839-183">API</span><span class="sxs-lookup"><span data-stu-id="c6839-183">API</span></span>|<span data-ttu-id="c6839-184">failover partner 属性的关键字</span><span class="sxs-lookup"><span data-stu-id="c6839-184">Keyword for failover partner attribute</span></span>|  
|---------|--------------------------------------------|  
|<span data-ttu-id="c6839-185">OLE DB 访问接口</span><span class="sxs-lookup"><span data-stu-id="c6839-185">OLE DB Provider</span></span>|`FailoverPartner`|  
|<span data-ttu-id="c6839-186">ODBC 驱动程序</span><span class="sxs-lookup"><span data-stu-id="c6839-186">ODBC Driver</span></span>|`Failover_Partner`|  
|<span data-ttu-id="c6839-187">ActiveX 数据对象 (ADO)</span><span class="sxs-lookup"><span data-stu-id="c6839-187">ActiveX Data Objects (ADO)</span></span>|`Failover Partner`|  
  
 <span data-ttu-id="c6839-188">标识服务器实例的最简单方法是指定其名称 *<server_name>* [ **\\** _<SQL_Server_instance_name>_ ]。</span><span class="sxs-lookup"><span data-stu-id="c6839-188">The simplest way to identify the server instance is by its system name, *<server_name>*[**\\**_<SQL_Server_instance_name>_].</span></span>  
  
 <span data-ttu-id="c6839-189">另外，还可以在 `Failover Partner` 属性中提供 IP 地址和端口号。</span><span class="sxs-lookup"><span data-stu-id="c6839-189">Alternatively, the IP address and port number can be supplied in the `Failover Partner` attribute.</span></span> <span data-ttu-id="c6839-190">如果首次连接到数据库时初始连接尝试失败，则到故障转移伙伴的连接尝试将不会依赖于 DNS 和 SQL Server Browser。</span><span class="sxs-lookup"><span data-stu-id="c6839-190">If the initial connection attempt fails during the first connection to the database, the attempt to connect to the failover partner will be freed from relying on DNS and SQL Server Browser.</span></span> <span data-ttu-id="c6839-191">建立连接后，便会使用故障转移伙伴名称覆盖故障转移伙伴名称，因此，如果发生故障转移，则重定向的连接将需要 DNS 和 SQL Server Browser。</span><span class="sxs-lookup"><span data-stu-id="c6839-191">Once a connection is established, the failover partner name will be overwritten with the failover partner name, so if a failover occurs, the redirected connections will require DNS and SQL Server Browser.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-192">如果仅提供了初始伙伴名称，则应用程序开发人员不需要执行任何操作，也不需要编写除了有关如何重新连接的代码之外的任何代码。</span><span class="sxs-lookup"><span data-stu-id="c6839-192">When only the initial partner name is provided, application developers do not need to take any action or write any code except about how to reconnect.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-193">托管代码应用程序开发人员在 `ConnectionString` 对象的 `SqlConnection` 中提供故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-193">Managed code application developers supply the failover partner name in the `ConnectionString` of the `SqlConnection` object.</span></span> <span data-ttu-id="c6839-194">有关使用此连接字符串的信息，请参阅 ADO.NET 文档（ [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK 中包含此文档）中的“Database Mirroring Support in the .NET Framework Data Provider for SQL Server”。</span><span class="sxs-lookup"><span data-stu-id="c6839-194">For information on using this connection string, see "Database Mirroring Support in the .NET Framework Data Provider for SQL Server" in the ADO.NET documentation, which is part of the [!INCLUDE[msCoName](../../includes/msconame-md.md)] .NET Framework SDK.</span></span>  
  
#### <a name="example-connection-string"></a><span data-ttu-id="c6839-195">连接字符串示例</span><span class="sxs-lookup"><span data-stu-id="c6839-195">Example Connection String</span></span>  
 <span data-ttu-id="c6839-196">例如，为了使用 TCP/IP 显式连接到 Partner_A 或 Partner_B 上的 **AdventureWorks** 数据库，使用 ODBC 驱动程序的客户端应用程序可能会提供以下连接字符串：</span><span class="sxs-lookup"><span data-stu-id="c6839-196">For example, to explicitly connect using TCP/IP to the **AdventureWorks** database on either Partner_A or Partner_B, a client application that uses the ODBC Driver could supply the following connection string:</span></span>  
  
```  
"Server=Partner_A; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
 <span data-ttu-id="c6839-197">另外，客户端还可以使用 IP 地址和端口号标识初始伙伴 Partner_A；例如，如果 IP 地址为 250.65.43.21，端口号为 4734，则连接字符串将为：</span><span class="sxs-lookup"><span data-stu-id="c6839-197">Alternatively, the client could use the IP address and port number to identify the initial partner, Partner_A; for example, if the IP address is 250.65.43.21 and the port number is 4734, the connection string would be:</span></span>  
  
```  
"Server=250.65.43.21,4734; Failover_Partner=Partner_B; Database=AdventureWorks; Network=dbmssocn"  
```  
  
##  <a name="connection-retry-algorithm-for-tcpip-connections"></a><a name="RetryAlgorithm"></a> <span data-ttu-id="c6839-198">连接重试算法（用于 TCP/IP 连接）</span><span class="sxs-lookup"><span data-stu-id="c6839-198">Connection Retry Algorithm (for TCP/IP Connections)</span></span>  
 <span data-ttu-id="c6839-199">对于 TCP/IP 连接，在两个伙伴名称都在缓存中时，数据访问接口遵循连接重试算法。</span><span class="sxs-lookup"><span data-stu-id="c6839-199">For a TCP/IP connection, when both partner names are in the cache, the data access provider adheres to a connection retry algorithm.</span></span> <span data-ttu-id="c6839-200">不论是初次与会话建立连接，还是在中断已建立连接后重新连接，这都适用。</span><span class="sxs-lookup"><span data-stu-id="c6839-200">This is true both for making the initial connection to the session and for reconnecting after losing an established connection.</span></span> <span data-ttu-id="c6839-201">打开连接之后，还需要一些时间完成预登录和登录的步骤。</span><span class="sxs-lookup"><span data-stu-id="c6839-201">Once a connection has been opened, completing the pre-login and login steps takes additional time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-202">打开连接所用的时间可能会超过重试时间，这是由于下列外部因素所致：DNS 查找速度缓慢、域控制器/Kerberos 密钥发行中心 (KDC) 速度缓慢、联系 SQL Server Browser 需要时间、网络阻塞等。</span><span class="sxs-lookup"><span data-stu-id="c6839-202">The time spent in opening a connection can exceed the retry time because of external factors, such as slow DNS lookups, slow domain controller/Kerberos Key Distribution Center (KDC), time spent contacting SQL Server Browser, network congestion, and so forth.</span></span> <span data-ttu-id="c6839-203">此类外部因素可能会阻止客户端连接到镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="c6839-203">Such external factors can prevent a client from connecting to a mirrored database.</span></span> <span data-ttu-id="c6839-204">此外，外部因素还可能会导致打开连接所用的时间长于分配的重试时间。</span><span class="sxs-lookup"><span data-stu-id="c6839-204">Also, external factors can cause a connection to take longer to open than the allotted retry time.</span></span> <span data-ttu-id="c6839-205">有关跳过 DNS 和 SQL Server Browser 以尝试连接到初始伙伴的信息，请参阅本主题前面的 [建立到数据库镜像会话的初始连接](#InitialConnection)。</span><span class="sxs-lookup"><span data-stu-id="c6839-205">For information on bypassing DNS and SQL Server Browser for connection attempt to the initial partner, see [Making the Initial Connection to a Database Mirroring Session](#InitialConnection), earlier in this topic.</span></span>  
  
 <span data-ttu-id="c6839-206">如果连接尝试失败或者重试时间过期而未成功重试，则数据访问接口将尝试使用另一个伙伴。</span><span class="sxs-lookup"><span data-stu-id="c6839-206">If a connection attempt fails or the retry time expires before it succeeds, the data access provider tries the other partner.</span></span> <span data-ttu-id="c6839-207">如果此时未打开连接，则数据访问接口还会尝试使用初始伙伴名称和故障转移伙伴名称，直到连接打开或登录期限超时。默认的登录超时期限为 15 秒。</span><span class="sxs-lookup"><span data-stu-id="c6839-207">If a connection is not opened by this point, the provider alternately tries the initial and failover partner names, until a connection is opened or the login period times out. The default login time-out period is 15 seconds.</span></span> <span data-ttu-id="c6839-208">建议登录超时期限至少为 5 秒。</span><span class="sxs-lookup"><span data-stu-id="c6839-208">We recommend that the login time-out period be at least 5 seconds.</span></span> <span data-ttu-id="c6839-209">如果指定较短的超时期限，则可能导致连接尝试失败。</span><span class="sxs-lookup"><span data-stu-id="c6839-209">Specifying a smaller time-out period might prevent any of the connection attempts from succeeding.</span></span>  
  
 <span data-ttu-id="c6839-210">重试时间为登录期限的某个百分比数。</span><span class="sxs-lookup"><span data-stu-id="c6839-210">The retry time is a percentage of the login period.</span></span> <span data-ttu-id="c6839-211">在后续的每轮中，连接尝试的重试时间会逐渐变大。</span><span class="sxs-lookup"><span data-stu-id="c6839-211">The retry time for a connection attempt is larger in each successive round.</span></span> <span data-ttu-id="c6839-212">在第一轮中，两次尝试的每次重试时间都是总登录时间的 8%。</span><span class="sxs-lookup"><span data-stu-id="c6839-212">In the first round, the retry time for each of the two attempts is 8 percent of the total login period.</span></span> <span data-ttu-id="c6839-213">在后续的每轮中，重试算法会按相同的百分比增加最大重试时间。</span><span class="sxs-lookup"><span data-stu-id="c6839-213">In each successive round, the retry algorithm increases the maximum retry time by the same amount.</span></span> <span data-ttu-id="c6839-214">因此，前八次连接尝试的重试时间如下：</span><span class="sxs-lookup"><span data-stu-id="c6839-214">Thus, the retry times for the first eight connection attempts is as follows:</span></span>  
  
 <span data-ttu-id="c6839-215">8%、8%、16%、16%、24%、24%、32%、32%</span><span class="sxs-lookup"><span data-stu-id="c6839-215">8%, 8%, 16%, 16%, 24%, 24%, 32%, 32%</span></span>  
  
 <span data-ttu-id="c6839-216">重试时间使用以下公式进行计算：</span><span class="sxs-lookup"><span data-stu-id="c6839-216">The retry time is calculated using the following formula:</span></span>  
  
 <span data-ttu-id="c6839-217">RetryTime = PreviousRetryTime +( 0.08 &#42;LoginTimeout) </span><span class="sxs-lookup"><span data-stu-id="c6839-217">_RetryTime_ **=** _PreviousRetryTime_ **+(** 0.08 **&#42;**_LoginTimeout_**)**</span></span>  
  
 <span data-ttu-id="c6839-218">其中， *PreviousRetryTime* 初始值为 0。</span><span class="sxs-lookup"><span data-stu-id="c6839-218">Where *PreviousRetryTime* is initially 0.</span></span>  
  
 <span data-ttu-id="c6839-219">例如，如果使用默认的登录超时期限 15 秒，则 *LoginTimeout* *= 15*。</span><span class="sxs-lookup"><span data-stu-id="c6839-219">For example, if using the default login time-out period of 15 seconds, *LoginTimeout* *= 15*.</span></span> <span data-ttu-id="c6839-220">在这种情况下，前三轮中分配的重试时间如下：</span><span class="sxs-lookup"><span data-stu-id="c6839-220">In this case, the retry times allotted in the first three rounds are as follows:</span></span>  
  
|<span data-ttu-id="c6839-221">Round</span><span class="sxs-lookup"><span data-stu-id="c6839-221">Round</span></span>|<span data-ttu-id="c6839-222">*RetryTime* 计算</span><span class="sxs-lookup"><span data-stu-id="c6839-222">*RetryTime* calculation</span></span>|<span data-ttu-id="c6839-223">每次尝试的重试时间</span><span class="sxs-lookup"><span data-stu-id="c6839-223">Retry time per attempt</span></span>|  
|-----------|-----------------------------|----------------------------|  
|<span data-ttu-id="c6839-224">1</span><span class="sxs-lookup"><span data-stu-id="c6839-224">1</span></span>|<span data-ttu-id="c6839-225">0 +(0.08 &#42; 15)  </span><span class="sxs-lookup"><span data-stu-id="c6839-225">0 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="c6839-226">1.2 秒</span><span class="sxs-lookup"><span data-stu-id="c6839-226">1.2 seconds</span></span>|  
|<span data-ttu-id="c6839-227">2</span><span class="sxs-lookup"><span data-stu-id="c6839-227">2</span></span>|<span data-ttu-id="c6839-228">1.2 +(0.08 &#42; 15)  </span><span class="sxs-lookup"><span data-stu-id="c6839-228">1.2 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="c6839-229">2.4 秒</span><span class="sxs-lookup"><span data-stu-id="c6839-229">2.4 seconds</span></span>|  
|<span data-ttu-id="c6839-230">3</span><span class="sxs-lookup"><span data-stu-id="c6839-230">3</span></span>|<span data-ttu-id="c6839-231">2.4 +(0.08 &#42; 15)  </span><span class="sxs-lookup"><span data-stu-id="c6839-231">2.4 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="c6839-232">3.6 秒</span><span class="sxs-lookup"><span data-stu-id="c6839-232">3.6 seconds</span></span>|  
|<span data-ttu-id="c6839-233">4</span><span class="sxs-lookup"><span data-stu-id="c6839-233">4</span></span>|<span data-ttu-id="c6839-234">3.6 +(0.08 &#42; 15)  </span><span class="sxs-lookup"><span data-stu-id="c6839-234">3.6 **+(** 0.08 **&#42;** 15 **)**</span></span>|<span data-ttu-id="c6839-235">4.8 秒</span><span class="sxs-lookup"><span data-stu-id="c6839-235">4.8 seconds</span></span>|   
  
 <span data-ttu-id="c6839-236">下图说明了这些后续连接尝试的重试时间，每个重试时间均超时。</span><span class="sxs-lookup"><span data-stu-id="c6839-236">The following figure illustrates these retry times for successive connection attempts, each of which times out.</span></span>  
  
 <span data-ttu-id="c6839-237">![15 秒登录超时的最长重试延迟时间](../media/dbm-retry-algorithm.gif "15 秒登录超时的最长重试延迟时间")</span><span class="sxs-lookup"><span data-stu-id="c6839-237">![Maximum retry delays for 15 second login timeout](../media/dbm-retry-algorithm.gif "Maximum retry delays for 15 second login timeout")</span></span>  
  
 <span data-ttu-id="c6839-238">对于默认的登录超时期限，分配给前三轮连接尝试的最长时间为 14.4 秒。</span><span class="sxs-lookup"><span data-stu-id="c6839-238">For the default login time-out period, the maximum time allotted to the first three rounds of connection attempts is 14.4 seconds.</span></span> <span data-ttu-id="c6839-239">如果每次尝试都使用了它的全部分配时间，则在登录期限超时之前仅剩下 0.6 秒的时间。在这种情况下，第四轮的时间会缩短，仅允许使用初始伙伴名称进行最后的快速连接尝试。</span><span class="sxs-lookup"><span data-stu-id="c6839-239">If every attempt were to use all of its allotted time, only 0.6 seconds of time would remain before the login period times out. In that case, the fourth round would be curtailed, allowing only a final quick attempt to connect using the initial partner name.</span></span> <span data-ttu-id="c6839-240">但是，连接尝试可能会在其分配的重试时间内失败，尤其是在稍后的轮次中。</span><span class="sxs-lookup"><span data-stu-id="c6839-240">However, a connection attempt may fail in less than its allotted retry time, particularly in later rounds.</span></span> <span data-ttu-id="c6839-241">例如，接收网络错误可能会导致在重试时间到期之前尝试便已结束。</span><span class="sxs-lookup"><span data-stu-id="c6839-241">For example, receiving a network error can cause an attempt to end before the retry time expires.</span></span> <span data-ttu-id="c6839-242">如果较早的尝试因网络错误而失败，则可以为第四轮（还可能包括更多轮）提供更多的时间。</span><span class="sxs-lookup"><span data-stu-id="c6839-242">If earlier attempts fail due to a network error, additional time would be available for the fourth round and, perhaps, additional rounds.</span></span>  
  
 <span data-ttu-id="c6839-243">尝试失败的另一个原因是服务器实例处于不活动状态，如同服务器实例执行数据库故障转移时发生的情况。</span><span class="sxs-lookup"><span data-stu-id="c6839-243">Another cause of a failed attempt is an inactive server instance, as occurs when a server instance is engaged in failing over its database.</span></span> <span data-ttu-id="c6839-244">在这种情况下，可以利用重试延迟时间来防止客户端因快速进行后续连接尝试而导致伙伴重载。</span><span class="sxs-lookup"><span data-stu-id="c6839-244">In this case, a retry delay is imposed to prevent clients from overloading the partners with a rapid succession of connection attempts.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-245">当两个伙伴名称均可用时，如果登录超时期限无限大，则客户端会交替使用初始伙伴名称和故障转移伙伴名称，无限期地尝试重新连接到服务器。</span><span class="sxs-lookup"><span data-stu-id="c6839-245">When both partner names are available, if the login time-out period is infinite, the client attempts to reconnect to the servers indefinitely, alternating between the initial partner name and the failover partner name.</span></span>  
<span data-ttu-id="c6839-246">)</span><span class="sxs-lookup"><span data-stu-id="c6839-246">)</span></span>  
  
### <a name="retry-delays-during-failover"></a><span data-ttu-id="c6839-247">故障转移期间的重试延迟时间</span><span class="sxs-lookup"><span data-stu-id="c6839-247">Retry Delays During Failover</span></span>  
 <span data-ttu-id="c6839-248">如果客户端尝试连接到进行故障转移的伙伴，则此伙伴会立即做出响应表明它处于不活动状态。</span><span class="sxs-lookup"><span data-stu-id="c6839-248">If a client attempts to connect to a partner that is failing over, the partner immediately responds that it is inactive.</span></span> <span data-ttu-id="c6839-249">在这种情况下，每轮连接尝试都会比分配的重试时间更短暂。</span><span class="sxs-lookup"><span data-stu-id="c6839-249">In this case, each round of connection attempts are much briefer than the allotted retry time.</span></span> <span data-ttu-id="c6839-250">也就是说，在登录期限超时之前会发生多轮连接尝试。为了避免在故障转移期间因一系列快速的连接尝试而导致伙伴重载，数据访问接口在每次重试循环之后增加了短暂的重试延迟时间。</span><span class="sxs-lookup"><span data-stu-id="c6839-250">This means that many rounds of connection attempts could happen before the login period times out. To avoid overloading the partners with a rapid series of connection attempts during a failover, the data access provider adds a brief retry delay after each retry cycle.</span></span> <span data-ttu-id="c6839-251">给定重试延迟时间的长度由重试延迟时间算法确定。</span><span class="sxs-lookup"><span data-stu-id="c6839-251">The length of a given retry delay is determined by the retry-delay algorithm.</span></span> <span data-ttu-id="c6839-252">在第一轮之后，延迟时间为 100 毫秒。</span><span class="sxs-lookup"><span data-stu-id="c6839-252">After the first round, the delay is 100 milliseconds.</span></span> <span data-ttu-id="c6839-253">在接下来三轮的每轮之后，重试延迟时间加倍，分别达到 200、400 和 800。</span><span class="sxs-lookup"><span data-stu-id="c6839-253">After each of the next three rounds, the retry delay doubles-to 200, 400, and 800.</span></span> <span data-ttu-id="c6839-254">对于所有的稍后轮次，重试延迟时间为 1 秒，直到连接尝试成功或超时。</span><span class="sxs-lookup"><span data-stu-id="c6839-254">For all later rounds, the retry delay is 1 second until the connection attempt succeeds or times out.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-255">如果服务器实例停止，则连接请求会立即失败。</span><span class="sxs-lookup"><span data-stu-id="c6839-255">If the server instance is stopped, then the connection request fails immediately.</span></span>  
  
 <span data-ttu-id="c6839-256">下图说明了在手动故障转移（其中伙伴会切换其角色）期间重试延迟时间如何影响连接尝试。</span><span class="sxs-lookup"><span data-stu-id="c6839-256">The following figure illustrates how the retry delay affects connection attempts during a manual failover, in which the partners switch their roles.</span></span> <span data-ttu-id="c6839-257">登录超时期限为 15 秒。</span><span class="sxs-lookup"><span data-stu-id="c6839-257">The login time-out period is 15 seconds.</span></span>  
  
 <span data-ttu-id="c6839-258">![重试延迟时间算法](../media/dbm-retry-delay-algorithm.gif "重试延迟时间算法")</span><span class="sxs-lookup"><span data-stu-id="c6839-258">![Retry-delay algorithm](../media/dbm-retry-delay-algorithm.gif "Retry-delay algorithm")</span></span>  
  
##  <a name="reconnecting-to-a-database-mirroring-session"></a><a name="Reconnecting"></a> <span data-ttu-id="c6839-259">重新连接到数据库镜像会话</span><span class="sxs-lookup"><span data-stu-id="c6839-259">Reconnecting to a Database Mirroring Session</span></span>  
 <span data-ttu-id="c6839-260">如果已建立的到数据库镜像会话的连接因某种原因（例如，由于数据库镜像故障转移）而失败，但应用程序尝试重新连接到初始服务器，则数据访问接口可以尝试使用客户端缓存中存储的故障转移伙伴名称进行重新连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-260">If an established connection to a database mirroring session fails for any reason, for example, due to a database mirroring failover, and the application attempts to reconnect to the initial server, the data access provider can attempt to reconnect using the failover partner name stored in the client's cache.</span></span> <span data-ttu-id="c6839-261">但是，重新连接不是自动进行的，</span><span class="sxs-lookup"><span data-stu-id="c6839-261">Reconnecting is not automatic, however.</span></span> <span data-ttu-id="c6839-262">应用程序必须能够识别错误。</span><span class="sxs-lookup"><span data-stu-id="c6839-262">The application must become aware of the error.</span></span> <span data-ttu-id="c6839-263">然后，应用程序需要关闭失败的连接并使用相同的连接字符串属性打开新连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-263">Then, the application needs to close the failed connection and open a new connection using the same connection string attributes.</span></span> <span data-ttu-id="c6839-264">此时，数据访问接口将连接重定向到故障转移伙伴。</span><span class="sxs-lookup"><span data-stu-id="c6839-264">At this point, the data access provider redirects the connection to the failover partner.</span></span> <span data-ttu-id="c6839-265">如果由此名称标识的服务器实例当前为主体服务器，则连接尝试通常都会成功。</span><span class="sxs-lookup"><span data-stu-id="c6839-265">If the server instance identified by this name is currently the principal server, the connection attempt usually succeeds.</span></span> <span data-ttu-id="c6839-266">如果不确定事务已提交还是回滚，则应用程序必须检查事务的状态，检查方法与重新连接到独立服务器实例时所用的方法相同。</span><span class="sxs-lookup"><span data-stu-id="c6839-266">If it is unclear whether a transaction was committed or rolled back, the application must check on the state of the transaction, in the same way as when reconnecting to a stand-alone server instance.</span></span>  
  
 <span data-ttu-id="c6839-267">重新连接类似于连接字符串为其提供故障转移伙伴名称的初始连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-267">Reconnecting resembles an initial connection for which the connection string supplied a failover partner name.</span></span> <span data-ttu-id="c6839-268">如果首次连接尝试失败，则连接尝试会反复轮流使用初始伙伴名称和故障转移伙伴名称，直到客户端连接到主体服务器或数据访问接口超时。</span><span class="sxs-lookup"><span data-stu-id="c6839-268">If the first connection attempt fails, connection attempts alternate back and forth between the initial partner name and failover partner name until either the client connects to the  principal server or the data access provider times out.</span></span>  
  
> [!NOTE]  
>  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="c6839-269">Native Client 验证它是否连接到主体服务器实例，但不验证此实例是否为连接字符串初始伙伴名称中指定的服务器实例的伙伴。</span><span class="sxs-lookup"><span data-stu-id="c6839-269">Native Client verifies that it connects to a principal server instance but not whether this instance is the partner of server instance specified in the initial partner name of the connection string.</span></span>  
  
 <span data-ttu-id="c6839-270">如果连接使用 TCP/IP，则连接重试算法将确定为每一轮连接尝试所分配的时间。</span><span class="sxs-lookup"><span data-stu-id="c6839-270">If the connections use TCP/IP, the connection retry algorithm determines the amount of time allotted to the connection attempts in each round.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c6839-271">如果客户端与数据库断开连接，则数据访问接口不会尝试重新连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-271">If the client gets disconnected from the database, the data access provider does not attempt to reconnect.</span></span> <span data-ttu-id="c6839-272">客户端必须发出新的连接请求。</span><span class="sxs-lookup"><span data-stu-id="c6839-272">The client must issue a new connection request.</span></span> <span data-ttu-id="c6839-273">同样，如果应用程序因中断连接而关闭，则会丢失已缓存的伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-273">Also, if an application shuts down on losing the connection, it will lose the cached partner names.</span></span> <span data-ttu-id="c6839-274">如果因为主体服务器不可用而中断连接，则应用程序可重新连接到镜像服务器的唯一方法是在其连接字符串中提供故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-274">If the connection was lost because the principal server became unavailable, the only way that the application can reconnect to the mirror server is by supplying the failover partner name in its connection string.</span></span>  
  
  
### <a name="impact-of-redirection-on-a-client-application"></a><span data-ttu-id="c6839-275">重定向对客户端应用程序的影响</span><span class="sxs-lookup"><span data-stu-id="c6839-275">Impact of Redirection on a Client Application</span></span>  
 <span data-ttu-id="c6839-276">故障转移之后，数据访问接口将连接重定向到当前主体服务器实例。</span><span class="sxs-lookup"><span data-stu-id="c6839-276">After a failover, the data access provider redirects the connection to the current principal server instance.</span></span> <span data-ttu-id="c6839-277">但是，重定向对客户端是透明的。</span><span class="sxs-lookup"><span data-stu-id="c6839-277">However, the redirection is transparent to clients.</span></span> <span data-ttu-id="c6839-278">对于客户端，重定向的连接似乎是由初始伙伴名称标识的到服务器实例的连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-278">To a client, a redirected connection appears to be a connection to the server instance identified by the initial partner name.</span></span> <span data-ttu-id="c6839-279">初始伙伴当前为镜像服务器时，客户端似乎可以连接到镜像服务器并更新镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="c6839-279">When the initial partner is currently the mirror server, the client can appear to be connected to the mirror server and updating the mirror database.</span></span> <span data-ttu-id="c6839-280">但实际上，客户端已重定向到故障转移伙伴（当前主体数据库）并更新新的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="c6839-280">Actually, however, the client has been redirected to the failover partner, which is the current principal database, and the client is updating the new principal database.</span></span>  
  
 <span data-ttu-id="c6839-281">重定向到故障转移伙伴之后，客户端在通过 [!INCLUDE[tsql](../../includes/tsql-md.md)] USE 语句以使用其他数据库时可能会出现意外结果。</span><span class="sxs-lookup"><span data-stu-id="c6839-281">After being redirected to the failover partner, a client can experience unexpected results when using a [!INCLUDE[tsql](../../includes/tsql-md.md)] USE statement to use a different database.</span></span> <span data-ttu-id="c6839-282">如果当前主体服务器实例（故障转移伙伴）具有不同于原始主体服务器（初始伙伴）的一组数据库，则会出现这种情况。</span><span class="sxs-lookup"><span data-stu-id="c6839-282">This can happen if the current principal server instance (the failover partner) has a different set of databases than the original principal server (the initial partner).</span></span>  
  
##  <a name="the-impact-of-a-stale-failover-partner-name"></a><a name="StalePartnerName"></a> <span data-ttu-id="c6839-283">已过时故障转移伙伴名称的影响</span><span class="sxs-lookup"><span data-stu-id="c6839-283">The Impact of a Stale Failover Partner Name</span></span>  
 <span data-ttu-id="c6839-284">数据库管理员可以随时更改故障转移伙伴。</span><span class="sxs-lookup"><span data-stu-id="c6839-284">The database administrator can change the failover partner at any time.</span></span> <span data-ttu-id="c6839-285">因此，客户端提供的故障转移伙伴名称可能已过时。</span><span class="sxs-lookup"><span data-stu-id="c6839-285">Therefore, a client-supplied failover partner name might be out of date, or *stale*.</span></span> <span data-ttu-id="c6839-286">例如，假设名为 Partner_B 的故障转移伙伴已由另一个服务器实例 Partner_C 替换。</span><span class="sxs-lookup"><span data-stu-id="c6839-286">For example, consider a failover partner named Partner_B that is replaced by another server instance, Partner_C.</span></span> <span data-ttu-id="c6839-287">现在，如果客户端提供 Partner_B 作为故障转移伙伴名称，则该名称已过时。</span><span class="sxs-lookup"><span data-stu-id="c6839-287">Now, if a client supplies Partner_B as the failover partner name, that name is stale.</span></span> <span data-ttu-id="c6839-288">如果客户端提供的故障转移伙伴名称已过时，数据访问接口的行为与客户端未提供故障转移伙伴名称时的行为相同。</span><span class="sxs-lookup"><span data-stu-id="c6839-288">When the client-supplied failover partner name is stale, the behavior of the data access provider equates to the case in which a failover partner name is not supplied by the client.</span></span>  
  
 <span data-ttu-id="c6839-289">例如，假设客户端使用一个连接字符串连续进行四次连接尝试。</span><span class="sxs-lookup"><span data-stu-id="c6839-289">For example, consider situation in which a client uses one connection string for a series of four connection attempts.</span></span> <span data-ttu-id="c6839-290">在此连接字符串中，初始伙伴名称为 Partner_A，故障转移伙伴名称为 Partner_B：</span><span class="sxs-lookup"><span data-stu-id="c6839-290">In the connection string, the initial partner name is Partner_A, and the failover partner name is Partner_B:</span></span>  
  
```  
"Server=Partner_A; Failover Partner=Partner_B; Database=AdventureWorks"  
```  
  
 <span data-ttu-id="c6839-291">下表显示了四个伙伴配置，并指示了对于每个配置，此连接字符串是否可以用于与客户端进行第一次连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-291">The following table shows four partner configurations and indicates for each whether this connection string works for connecting the client for the first time.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="c6839-292">应用程序可以跟踪配置更改并相应地更改其连接字符串。</span><span class="sxs-lookup"><span data-stu-id="c6839-292">An application can track configuration changes and change its connection string accordingly.</span></span> <span data-ttu-id="c6839-293">这要求使用额外的代码但同时要求减轻管理负担。</span><span class="sxs-lookup"><span data-stu-id="c6839-293">This requires extra code but reduces the administrative burden.</span></span>  
  
|<span data-ttu-id="c6839-294">配置</span><span class="sxs-lookup"><span data-stu-id="c6839-294">Configuration</span></span>|<span data-ttu-id="c6839-295">主体服务器</span><span class="sxs-lookup"><span data-stu-id="c6839-295">Principal server</span></span>|<span data-ttu-id="c6839-296">镜像服务器</span><span class="sxs-lookup"><span data-stu-id="c6839-296">Mirror server</span></span>|<span data-ttu-id="c6839-297">尝试与指定的 Partner_A 和 Partner_B 进行连接时的行为</span><span class="sxs-lookup"><span data-stu-id="c6839-297">Behavior when attempting to connect specifying Partner_A and Partner_B</span></span>|  
|-------------------|----------------------|-------------------|------------------------------------------------------------------------------|  
|<span data-ttu-id="c6839-298">原始镜像配置。</span><span class="sxs-lookup"><span data-stu-id="c6839-298">Original mirroring configuration.</span></span>|<span data-ttu-id="c6839-299">Db_1</span><span class="sxs-lookup"><span data-stu-id="c6839-299">Partner_A</span></span>|<span data-ttu-id="c6839-300">Partner_B</span><span class="sxs-lookup"><span data-stu-id="c6839-300">Partner_B</span></span>|<span data-ttu-id="c6839-301">Partner_A 作为初始伙伴名称保存在缓存中。</span><span class="sxs-lookup"><span data-stu-id="c6839-301">Partner_A is cached as the initial partner name.</span></span> <span data-ttu-id="c6839-302">客户端成功连接到 Partner_A。</span><span class="sxs-lookup"><span data-stu-id="c6839-302">The client succeeds in connecting to Partner_A.</span></span> <span data-ttu-id="c6839-303">客户端下载镜像服务器的名称 Partner_B 并将其保存在缓存中，同时忽略客户端提供的故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-303">The client downloads the name of mirror server, Partner_B, and caches it, ignoring the client-supplied failover partner name.</span></span>|  
|<span data-ttu-id="c6839-304">Partner_A 出现硬件故障，并进行了故障转移（从客户端断开连接）。</span><span class="sxs-lookup"><span data-stu-id="c6839-304">Partner_A experiences a hardware failure, and failover occurs (disconnecting clients).</span></span>|<span data-ttu-id="c6839-305">Partner_B</span><span class="sxs-lookup"><span data-stu-id="c6839-305">Partner_B</span></span>|<span data-ttu-id="c6839-306">none</span><span class="sxs-lookup"><span data-stu-id="c6839-306">none</span></span>|<span data-ttu-id="c6839-307">Partner_A 仍作为初始伙伴名称保存在缓存中，但却使用客户端提供的故障转移伙伴名称 Partner_B 使客户端连接到当前的主体服务器。</span><span class="sxs-lookup"><span data-stu-id="c6839-307">The Partner_A is still cached as the initial partner name, but the client-supplied failover partner name, Partner_B, permits the client to connect to the current principal server.</span></span>|  
|<span data-ttu-id="c6839-308">数据库管理员停止镜像（从客户端断开连接），用 Partner_C 替换 Partner_A，然后重新启动镜像。</span><span class="sxs-lookup"><span data-stu-id="c6839-308">The database administrator stops mirroring (disconnecting clients), replaces Partner_A with Partner_C, and restarts mirroring.</span></span>|<span data-ttu-id="c6839-309">Partner_B</span><span class="sxs-lookup"><span data-stu-id="c6839-309">Partner_B</span></span>|<span data-ttu-id="c6839-310">Partner_C</span><span class="sxs-lookup"><span data-stu-id="c6839-310">Partner_C</span></span>|<span data-ttu-id="c6839-311">客户端尝试连接到 Partner_A 并且连接失败，然后客户端尝试连接到 Partner_B（当前的主体服务器）并成功连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-311">The client attempts to connect to Partner_A and fails; then the client tries Partner_B (the current principal server) and succeeds.</span></span> <span data-ttu-id="c6839-312">数据访问接口下载当前镜像服务器 Partner_C 的名称，并将其缓存为当前故障转移伙伴名称。</span><span class="sxs-lookup"><span data-stu-id="c6839-312">The data access provider downloads the name of the current mirror server, Partner_C, and caches it as the current failover partner name.</span></span>|  
|<span data-ttu-id="c6839-313">手动将服务故障转移到 Partner_C（从客户端断开连接）。</span><span class="sxs-lookup"><span data-stu-id="c6839-313">Service is manually failed over to Partner_C (disconnecting clients).</span></span>|<span data-ttu-id="c6839-314">Partner_C</span><span class="sxs-lookup"><span data-stu-id="c6839-314">Partner_C</span></span>|<span data-ttu-id="c6839-315">Partner_B</span><span class="sxs-lookup"><span data-stu-id="c6839-315">Partner_B</span></span>|<span data-ttu-id="c6839-316">客户端最初尝试连接到 Partner_A，然后又尝试连接到 Partner_B，但均未成功。</span><span class="sxs-lookup"><span data-stu-id="c6839-316">Client attempts to connect to Partner_A initially, and then to Partner_B.</span></span> <span data-ttu-id="c6839-317">最后，连接请求超时，无法成功连接。</span><span class="sxs-lookup"><span data-stu-id="c6839-317">Both names fail, and eventually the connection request times out and fails.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="c6839-318">另请参阅</span><span class="sxs-lookup"><span data-stu-id="c6839-318">See Also</span></span>  
 <span data-ttu-id="c6839-319">[数据库镜像 (SQL Server)](database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="c6839-319">[Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="c6839-320">数据库镜像期间可能出现的故障</span><span class="sxs-lookup"><span data-stu-id="c6839-320">Possible Failures During Database Mirroring</span></span>](possible-failures-during-database-mirroring.md)  
  
  

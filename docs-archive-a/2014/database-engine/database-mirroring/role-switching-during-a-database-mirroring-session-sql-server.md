---
title: 数据库镜像会话期间的角色切换 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- role switching [SQL Server]
- mirroring partners [SQL Server]
- failover [SQL Server]
- failover partners [SQL Server]
- database mirroring [SQL Server], partners
- partners in database mirroring sessions [SQL Server]
- failover [SQL Server], database mirroring
- database mirroring [SQL Server], failover
ms.assetid: a782d60d-0373-4386-bd77-9ec192553700
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 5e16adbad2106d623279edf9d443eae3755c7be5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87690108"
---
# <a name="role-switching-during-a-database-mirroring-session-sql-server"></a><span data-ttu-id="f9368-102">数据库镜像会话期间的角色切换 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f9368-102">Role Switching During a Database Mirroring Session (SQL Server)</span></span>
  <span data-ttu-id="f9368-103">在数据库镜像会话上下文中，通常可以使用一个称为“角色切换” 的过程来互换主体角色和镜像角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-103">Within the context of a database mirroring session, the principal and mirror roles are typically interchangeable in a process known as *role switching*.</span></span> <span data-ttu-id="f9368-104">在角色切换中，镜像服务器充当主体服务器的“故障转移伙伴  ”，接管主体角色，恢复其数据库副本并使其联机以作为新的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-104">In role switching, the mirror server acts as the *failover partner* for the principal server, taking over the principal role, recovering its copy of the database and bringing it online as the new principal database.</span></span> <span data-ttu-id="f9368-105">以前的主体服务器将作为镜像角色（如果可用），并且其数据库将成为新的镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-105">The former principal server, when available, assumes the mirror role, and its database becomes the new mirror database.</span></span> <span data-ttu-id="f9368-106">在可能的情况下，这些角色可以来回切换，以应对多次失败或满足管理的需要。</span><span class="sxs-lookup"><span data-stu-id="f9368-106">Potentially, the roles can switch back and forth either in response to multiple failures or for administrative purposes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f9368-107">本主题假定您熟悉数据库镜像运行模式。</span><span class="sxs-lookup"><span data-stu-id="f9368-107">This topic assumes that you are familiar with the database mirroring operating modes.</span></span> <span data-ttu-id="f9368-108">有关详细信息，请参阅 [Database Mirroring Operating Modes](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-108">For more information, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
 <span data-ttu-id="f9368-109">下图显示了镜像伙伴（ **Partner_A** 和 **Partner_B**）在一系列自动或手动故障转移间切换主体和镜像角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-109">The following illustration shows mirroring partners, **Partner_A** and **Partner_B**, switching the principal and mirror roles over a series of automatic or manual failovers.</span></span>  
  
 <span data-ttu-id="f9368-110">![切换两次角色的伙伴](../media/dbm-roleswitching.gif "切换两次角色的伙伴")</span><span class="sxs-lookup"><span data-stu-id="f9368-110">![Partners switching twice between roles](../media/dbm-roleswitching.gif "Partners switching twice between roles")</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="f9368-111">在角色切换之后，运行于以前主体数据库上的作业必须在新的主体服务器中重新创建，以便能够在新的主体服务器中运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-111">After a role switch, jobs that ran on the former principal database must be recreated on the new principal server to run there.</span></span> <span data-ttu-id="f9368-112">有关详细信息，请参阅[角色切换后登录名和作业的管理 (SQL Server)](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-112">For more information, see [Management of Logins and Jobs After Role Switching &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md).</span></span>  
  
 <span data-ttu-id="f9368-113">有三种角色切换类型：自动故障转移、手动故障转移和强制服务（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="f9368-113">Three types of role switching exist: automatic failover, manual failover, and forced service (with possible data loss).</span></span> <span data-ttu-id="f9368-114">对每种形式的支持取决于会话的运行模式。</span><span class="sxs-lookup"><span data-stu-id="f9368-114">Support for each form depends on the operating mode of the session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f9368-115">如果不熟悉这些运行模式，请参阅 [数据库镜像运行模式](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-115">If you are unfamiliar with these operating modes, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
-   <span data-ttu-id="f9368-116">**手动故障转移**</span><span class="sxs-lookup"><span data-stu-id="f9368-116">**Manual failover**</span></span>  
  
     <span data-ttu-id="f9368-117">高安全性模式支持手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-117">High-safety mode supports manual failover.</span></span> <span data-ttu-id="f9368-118">数据库同步后，数据库所有者可以启动手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-118">Whenever the database is synchronized, the database owner can initiate a manual failover.</span></span>  
  
     <span data-ttu-id="f9368-119">手动故障转移是为进行管理提供的。</span><span class="sxs-lookup"><span data-stu-id="f9368-119">Manual failover is provided for administrative purposes.</span></span> <span data-ttu-id="f9368-120">有关详细信息，请参阅本主题后面的 [手动故障转移](#ManualFailover)。</span><span class="sxs-lookup"><span data-stu-id="f9368-120">For more information, see [Manual Failover](#ManualFailover), later in this topic.</span></span>  
  
-   <span data-ttu-id="f9368-121">**自动故障转移**</span><span class="sxs-lookup"><span data-stu-id="f9368-121">**Automatic failover**</span></span>  
  
     <span data-ttu-id="f9368-122">如果存在见证服务器，则高安全性模式支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-122">In the presence of a witness, high-safety mode supports automatic failover.</span></span> <span data-ttu-id="f9368-123">如果见证服务器和镜像服务器仍然彼此连接，并且数据库已同步，则仅在丢失主体服务器时才发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-123">Automatic failover occurs only on the loss of the principal server when the witness and mirror server are still connected to each other and the database is already synchronized.</span></span> <span data-ttu-id="f9368-124">有关详细信息，请参阅本主题后面的 [自动故障转移](#AutomaticFailover)。</span><span class="sxs-lookup"><span data-stu-id="f9368-124">For more information, see [Automatic Failover](#AutomaticFailover), later in this topic.</span></span>  
  
-   <span data-ttu-id="f9368-125">**强制服务（可能造成数据丢失）**</span><span class="sxs-lookup"><span data-stu-id="f9368-125">**Forced service (with possible data loss)**</span></span>  
  
     <span data-ttu-id="f9368-126">未设置见证服务器或见证服务器不在高性能模式下时，高安全性模式支持强制服务。</span><span class="sxs-lookup"><span data-stu-id="f9368-126">Forcing service is supported in high-safety mode when no witness is set and in high-performance mode.</span></span> <span data-ttu-id="f9368-127">主体服务器丢失时，数据库所有者可以通过强制在镜像服务器上服务以使数据库可用（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="f9368-127">On the loss of the principal server, the database owner can make the database available by forcing service to the mirror server (with possible data loss).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-128">建议您在高性能模式下，将 WITNESS 属性设置为 OFF。</span><span class="sxs-lookup"><span data-stu-id="f9368-128">We recommend that the WITNESS property be set to OFF in high-performance mode.</span></span> <span data-ttu-id="f9368-129">否则，若要使数据库联机，镜像服务器必须连接到见证服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-129">Otherwise, to bring the database online, the mirror server must connected to the witness.</span></span>  
  
     <span data-ttu-id="f9368-130">有关详细信息，请参阅本主题后面的 [强制服务（可能造成数据丢失）](#ForcedService)。</span><span class="sxs-lookup"><span data-stu-id="f9368-130">For more information, see [Forced Service (with Possible Data Loss)](#ForcedService), later in this topic.</span></span>  
  
 <span data-ttu-id="f9368-131">下表概述了在每种运行模式下支持的故障转移形式。</span><span class="sxs-lookup"><span data-stu-id="f9368-131">The following table summarizes which forms of failover are supported under each of the operating modes.</span></span>  
  
||<span data-ttu-id="f9368-132">高性能</span><span class="sxs-lookup"><span data-stu-id="f9368-132">High performance</span></span>|<span data-ttu-id="f9368-133">没有见证服务器的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="f9368-133">High-safety mode without a witness</span></span>|<span data-ttu-id="f9368-134">具有见证服务器的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="f9368-134">High-safety mode with a witness</span></span>|  
|-|----------------------|-----------------------------------------|--------------------------------------|  
|<span data-ttu-id="f9368-135">自动故障转移 (automatic failover)</span><span class="sxs-lookup"><span data-stu-id="f9368-135">Automatic failover</span></span>|<span data-ttu-id="f9368-136">否</span><span class="sxs-lookup"><span data-stu-id="f9368-136">No</span></span>|<span data-ttu-id="f9368-137">否</span><span class="sxs-lookup"><span data-stu-id="f9368-137">No</span></span>|<span data-ttu-id="f9368-138">是</span><span class="sxs-lookup"><span data-stu-id="f9368-138">Yes</span></span>|  
|<span data-ttu-id="f9368-139">手动故障转移</span><span class="sxs-lookup"><span data-stu-id="f9368-139">Manual failover</span></span>|<span data-ttu-id="f9368-140">否</span><span class="sxs-lookup"><span data-stu-id="f9368-140">No</span></span>|<span data-ttu-id="f9368-141">是</span><span class="sxs-lookup"><span data-stu-id="f9368-141">Yes</span></span>|<span data-ttu-id="f9368-142">是</span><span class="sxs-lookup"><span data-stu-id="f9368-142">Yes</span></span>|  
|<span data-ttu-id="f9368-143">强制服务</span><span class="sxs-lookup"><span data-stu-id="f9368-143">Forced service</span></span>|<span data-ttu-id="f9368-144">是</span><span class="sxs-lookup"><span data-stu-id="f9368-144">Yes</span></span>|<span data-ttu-id="f9368-145">是</span><span class="sxs-lookup"><span data-stu-id="f9368-145">Yes</span></span>|<span data-ttu-id="f9368-146">否</span><span class="sxs-lookup"><span data-stu-id="f9368-146">No</span></span>|  
  
 <span data-ttu-id="f9368-147">在角色切换之后，某些元数据必须存在于伙伴双方上，以确保所有的数据库用户均可访问新的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-147">After a role switch, certain metadata must exist on both partners to ensure that all of the database users can access the new principal database.</span></span> <span data-ttu-id="f9368-148">此外，必须对新的主体服务器创建备份作业，以确保数据库继续进行定期备份。</span><span class="sxs-lookup"><span data-stu-id="f9368-148">In addition, backup jobs must be created on the new principal server, to ensure that the database continues to be backed up on its regular schedule.</span></span> <span data-ttu-id="f9368-149">有关详细信息，请参阅[角色切换后登录名和作业的管理 (SQL Server)](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-149">For more information, see [Management of Logins and Jobs After Role Switching &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md).</span></span>  
  
 <span data-ttu-id="f9368-150">在角色切换过程中，数据库镜像功能中断服务的时间取决于角色切换的类型和原因。</span><span class="sxs-lookup"><span data-stu-id="f9368-150">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and on the cause.</span></span> <span data-ttu-id="f9368-151">有关详细信息，请参阅 [估计在角色切换期间服务的中断（数据库镜像）](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-151">For more information, see [Estimate the Interruption of Service During Role Switching &#40;Database Mirroring&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md).</span></span>  
  
##  <a name="manual-failover"></a><a name="ManualFailover"></a> <span data-ttu-id="f9368-152">Manual Failover</span><span class="sxs-lookup"><span data-stu-id="f9368-152">Manual Failover</span></span>  
 <span data-ttu-id="f9368-153">手动故障转移断开客户端与数据库的连接，并反转伙伴的角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-153">Manual failover disconnects the clients from the database and reverses the roles of the partners.</span></span> <span data-ttu-id="f9368-154">仅高安全性模式支持手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-154">Only high-safety mode supports manual failover.</span></span>  
  
  
###  <a name="maintaining-availability-during-upgrades"></a><a name="AvailabilityDuringUpgrades"></a> <span data-ttu-id="f9368-155">升级期间维护可用性</span><span class="sxs-lookup"><span data-stu-id="f9368-155">Maintaining Availability During Upgrades</span></span>  
 <span data-ttu-id="f9368-156">数据库管理员可使用手动故障转移升级硬件或软件，同时不会牺牲可用性。</span><span class="sxs-lookup"><span data-stu-id="f9368-156">The database administrator can use manual failover for upgrading hardware or software without sacrificing availability.</span></span> <span data-ttu-id="f9368-157">若要使用数据库镜像进行软件升级，镜像服务器和/或系统必须已接收到升级程序。</span><span class="sxs-lookup"><span data-stu-id="f9368-157">To use database mirroring for software upgrades, the mirror server and/or system must have already received the upgrades.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f9368-158">数据库镜像应该能够执行滚动升级，但是不能保证可执行此操作，因为将来的更改是未知的。</span><span class="sxs-lookup"><span data-stu-id="f9368-158">Database mirroring should be able to do a rolling upgrade, but this is not guaranteed, because future changes are unknown.</span></span> <span data-ttu-id="f9368-159">有关详细信息，请参阅 [Minimize Downtime for Mirrored Databases When Upgrading Server Instances](upgrading-mirrored-instances.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-159">For more information, see [Minimize Downtime for Mirrored Databases When Upgrading Server Instances](upgrading-mirrored-instances.md).</span></span>  
  
 <span data-ttu-id="f9368-160">下图说明了升级数据库服务器实例时使用手动故障转移维护数据库可用性的实例。</span><span class="sxs-lookup"><span data-stu-id="f9368-160">The following figure illustrates an instance of using manual failover to maintain database availability while you upgrade a database server instance.</span></span> <span data-ttu-id="f9368-161">完成升级后，管理员可以选择重新向原始服务器实例执行故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-161">When the upgrade is completed, an administrator may optionally fail over back to the original server instance.</span></span> <span data-ttu-id="f9368-162">如果管理员希望停止镜像会话并在其他位置使用镜像服务器时，这很有用。</span><span class="sxs-lookup"><span data-stu-id="f9368-162">This is useful when the administrator wants to stop the mirroring session and use the mirror server elsewhere.</span></span> <span data-ttu-id="f9368-163">这样，在更新一系列数据库服务器实例时，可以反复使用一个服务器实例。</span><span class="sxs-lookup"><span data-stu-id="f9368-163">In this way, a single server instance can be used repeatedly when updating a series of database server instances.</span></span>  
  
 <span data-ttu-id="f9368-164">![计划的手动故障转移 ](../media/dbm-failovmanuplanned.gif "计划的手动故障转移")</span><span class="sxs-lookup"><span data-stu-id="f9368-164">![Planned manual failover](../media/dbm-failovmanuplanned.gif "Planned manual failover")</span></span>  
  
###  <a name="conditions-required-for-a-manual-failover"></a><a name="ConditionsForManualFo"></a> <span data-ttu-id="f9368-165">手动故障转移所需条件</span><span class="sxs-lookup"><span data-stu-id="f9368-165">Conditions Required for a Manual Failover</span></span>  
 <span data-ttu-id="f9368-166">手动故障转移需要将事务安全设置为 FULL（即，高安全模式）。</span><span class="sxs-lookup"><span data-stu-id="f9368-166">Manual failover requires transaction safety to be set to FULL (that is, high-safety mode).</span></span> <span data-ttu-id="f9368-167">当伙伴连接在一起并且数据库已同步时，支持手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-167">When the partners are connected and the database is already synchronized, manual failover is supported.</span></span>  
  
###  <a name="how-manual-failover-works"></a><a name="HowManualFoWorks"></a> <span data-ttu-id="f9368-168">手动故障转移的原理</span><span class="sxs-lookup"><span data-stu-id="f9368-168">How Manual Failover Works</span></span>  
 <span data-ttu-id="f9368-169">手动故障转移会启动下列一组操作：</span><span class="sxs-lookup"><span data-stu-id="f9368-169">Manual failover initiates the following sequence of actions:</span></span>  
  
1.  <span data-ttu-id="f9368-170">主体服务器将断开客户端与主体数据库的连接，将日志尾部发送到镜像服务器，并且为了准备切换到镜像角色而将镜像状态设置为 SYNCHRONIZING。</span><span class="sxs-lookup"><span data-stu-id="f9368-170">The principal server disconnects clients from the principal database, sends the tail of the log to the mirror server, and, in preparation for switching to the mirror role, sets the mirroring state to SYNCHRONIZING.</span></span>  
  
2.  <span data-ttu-id="f9368-171">镜像服务器将从主体数据库接收到的最后一个日志记录的日志序列号 (LSN) 记录为故障转移 LSN。</span><span class="sxs-lookup"><span data-stu-id="f9368-171">The mirror server records the log sequence number (LSN) of the last log record received from the principal as the failover LSN.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-172">若要查看此 LSN，请从 [sys.database_mirroring (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql) 中选择 **mirroring_failover_lsn** 列。</span><span class="sxs-lookup"><span data-stu-id="f9368-172">To view this LSN, select the **mirroring_failover_lsn** column from [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
3.  <span data-ttu-id="f9368-173">如果重做队列中有任何等待的日志，则镜像服务器将完成前滚镜像数据库的操作。</span><span class="sxs-lookup"><span data-stu-id="f9368-173">If any log is waiting in the redo queue, the mirror server finishes rolling forward the mirror database.</span></span> <span data-ttu-id="f9368-174">所需时间取决于系统速度、最新工作负荷以及重做队列中的日志量。</span><span class="sxs-lookup"><span data-stu-id="f9368-174">The amount of time required depends on the speed of the system, the recent workload, and the amount of log in the redo queue.</span></span> <span data-ttu-id="f9368-175">对于同步运行模式，可通过限制重做队列的大小调整故障转移时间。</span><span class="sxs-lookup"><span data-stu-id="f9368-175">For a synchronous operating mode, the failover time can be regulated by limiting the size of the redo queue.</span></span> <span data-ttu-id="f9368-176">不过，这会导致主体服务器的速度下降，以便镜像服务器能够与其同步。</span><span class="sxs-lookup"><span data-stu-id="f9368-176">However, this can cause the principal server to slow down to allow the mirror server to keep up.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-177">若要了解重做队列的当前大小，请使用数据库镜像性能对象中的 **Redo Queue** 性能计数器（有关详细信息，请参阅[监视数据库镜像(SQL Server)](database-mirroring-sql-server.md)）。</span><span class="sxs-lookup"><span data-stu-id="f9368-177">To learn the current size of the redo queue, use the **Redo Queue** performance counter in the database mirroring performance object (for more information, see [Monitoring Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span>  
  
4.  <span data-ttu-id="f9368-178">镜像服务器成为新的主体服务器，而以前的主体服务器成为新的镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-178">The mirror server becomes the new principal server, and the former principal server becomes the new mirror server.</span></span>  
  
5.  <span data-ttu-id="f9368-179">新的主体服务器回滚所有未提交的事务并使其数据库副本作为主体数据库联机。</span><span class="sxs-lookup"><span data-stu-id="f9368-179">The new principal server rolls back any uncommitted transactions and brings its copy of the database online as the principal database.</span></span>  
  
6.  <span data-ttu-id="f9368-180">以前的主体角色成为镜像角色，以前的主体数据库成为镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-180">The former principal takes on the mirror role, and the former principal database becomes the mirror database.</span></span> <span data-ttu-id="f9368-181">新的镜像服务器快速重新同步新的镜像数据库与新的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-181">The new mirror server quickly resynchronizes the new mirror database with the new principal database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-182">新的镜像服务器重新同步数据库后，就可以再次执行故障转移，但按反向执行。</span><span class="sxs-lookup"><span data-stu-id="f9368-182">As soon as the new mirror server has resynchronized the databases, failover is again possible, but in the reverse direction.</span></span>  
  
 <span data-ttu-id="f9368-183">执行故障转移后，客户端必须重新连接到当前的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-183">After failover, clients must reconnect to the current principal database.</span></span> <span data-ttu-id="f9368-184">有关详细信息，请参阅 [将客户端连接到数据库镜像会话 (SQL Server)](connect-clients-to-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-184">For more information, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
 <span data-ttu-id="f9368-185">**启动手动故障转移**</span><span class="sxs-lookup"><span data-stu-id="f9368-185">**To initiate manual failover**</span></span>  
  
-   [<span data-ttu-id="f9368-186">手动故障转移数据库镜像会话 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="f9368-186">Manually Fail Over a Database Mirroring Session &#40;SQL Server Management Studio&#41;</span></span>](manually-fail-over-a-database-mirroring-session-sql-server-management-studio.md)  
  
-   <span data-ttu-id="f9368-187">[手动故障转移数据库镜像会话 (Transact-SQL)](manually-fail-over-a-database-mirroring-session-transact-sql.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-187">[Manually Fail Over a Database Mirroring Session &#40;Transact-SQL&#41;](manually-fail-over-a-database-mirroring-session-transact-sql.md).</span></span>  
  
##  <a name="automatic-failover"></a><a name="AutomaticFailover"></a> <span data-ttu-id="f9368-188">Automatic Failover</span><span class="sxs-lookup"><span data-stu-id="f9368-188">Automatic Failover</span></span>  
 <span data-ttu-id="f9368-189">只有在高安全性模式（*具有自动故障转移功能的高安全性模式*）下运行并且具有见证服务器的数据库镜像会话支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-189">Automatic failover is supported only in database mirroring sessions running with a witness in high-safety mode (*high-safety mode with automatic failover*).</span></span> <span data-ttu-id="f9368-190">在具有自动故障转移功能的高安全性模式下，同步数据库后，如果主体数据库变得不可用，则会发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-190">In high-safety mode with automatic failover, once the database is synchronized, if the principal database becomes unavailable, an automatic failover occurs.</span></span> <span data-ttu-id="f9368-191">自动故障转移将导致镜像服务器接管主体服务器的角色，并使其数据库的副本联机以作为主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-191">An automatic failover causes the mirror server to take over the role of principal server and bring its copy of the database online as the principal database.</span></span> <span data-ttu-id="f9368-192">因为每个在主体数据库中提交的事务同时也在镜像数据库中提交，所以需要使数据库保持同步以防止在故障转移过程中丢失数据。</span><span class="sxs-lookup"><span data-stu-id="f9368-192">Requiring that the database be synchronized prevents data loss during failover, because every transaction committed on the principal database is also committed on the mirror database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="f9368-193">为了增强自动故障转移的可靠性，镜像数据库和主体数据库必须驻留在不同的计算机上。</span><span class="sxs-lookup"><span data-stu-id="f9368-193">For automatic failover to improve reliability, the mirror and principal databases must reside on different computers.</span></span>  
  
  
  
###  <a name="conditions-required-for-an-automatic-failover"></a><a name="ConditionsForAutoFo"></a> <span data-ttu-id="f9368-194">自动故障转移所需条件</span><span class="sxs-lookup"><span data-stu-id="f9368-194">Conditions Required for an Automatic Failover</span></span>  
 <span data-ttu-id="f9368-195">自动故障转移需要下列条件：</span><span class="sxs-lookup"><span data-stu-id="f9368-195">Automatic failover requires the following conditions:</span></span>  
  
-   <span data-ttu-id="f9368-196">数据库镜像会话必须在高安全性模式下运行，并且必须处理见证服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-196">The database mirroring session must be running in high-safety mode and must possess a witness.</span></span> <span data-ttu-id="f9368-197">有关详细信息，请参阅 [Database Mirroring Operating Modes](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-197">For more information, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
-   <span data-ttu-id="f9368-198">镜像数据库必须已经同步。</span><span class="sxs-lookup"><span data-stu-id="f9368-198">The mirror database must already be synchronized.</span></span> <span data-ttu-id="f9368-199">这将保证发送到镜像服务器的所有日志都已写入磁盘。</span><span class="sxs-lookup"><span data-stu-id="f9368-199">This guarantees that all of the log sent to the mirror server has been written to disk.</span></span>  
  
-   <span data-ttu-id="f9368-200">主体服务器已中断了与其余数据库镜像配置的通信，而镜像服务器和见证服务器将保留仲裁。</span><span class="sxs-lookup"><span data-stu-id="f9368-200">The principal server has lost communication with the rest of the database mirroring configuration, while the mirror and witness retain quorum.</span></span> <span data-ttu-id="f9368-201">但是，如果所有服务器实例都已中断通信，而见证服务器和镜像服务器稍后重新建立通信，则不会发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-201">If all server instances lose communication, however, and the witness and the mirror server later regain communication, automatic failover does not occur.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-202">有关详细信息，请参阅[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-202">For more information, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
-   <span data-ttu-id="f9368-203">镜像服务器已检测到丢失了主体服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-203">The mirror server has detected the loss of the principal server.</span></span>  
  
     <span data-ttu-id="f9368-204">镜像服务器检测主体服务器故障的方式取决于故障是硬故障还是软故障。</span><span class="sxs-lookup"><span data-stu-id="f9368-204">How the mirror server detects a failure of the principal server depends on whether it is a hard or soft failure.</span></span> <span data-ttu-id="f9368-205">有关详细信息，请参阅 [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-205">For more information, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md).</span></span>  
  
###  <a name="how-automatic-failover-works"></a><a name="HowAutoFoWorks"></a> <span data-ttu-id="f9368-206">自动故障转移的原理</span><span class="sxs-lookup"><span data-stu-id="f9368-206">How Automatic Failover Works</span></span>  
 <span data-ttu-id="f9368-207">在上述条件下，自动故障转移将启动以下操作顺序：</span><span class="sxs-lookup"><span data-stu-id="f9368-207">Under the preceding conditions, automatic failover initiates the following sequence of actions:</span></span>  
  
1.  <span data-ttu-id="f9368-208">如果主体服务器仍在运行中，则将主体数据库的状态更改为 DISCONNECTED 并断开所有客户端与主体数据库的连接。</span><span class="sxs-lookup"><span data-stu-id="f9368-208">If the principal server is still running, it changes the state of the principal database to DISCONNECTED and disconnects all clients from the principal database.</span></span>  
  
2.  <span data-ttu-id="f9368-209">见证服务器和镜像服务器将主体服务器注册为不可用。</span><span class="sxs-lookup"><span data-stu-id="f9368-209">The witness and mirror servers register that the principal server is unavailable.</span></span>  
  
3.  <span data-ttu-id="f9368-210">如果重做队列中有任何等待的日志，则镜像服务器将完成前滚镜像数据库的操作。</span><span class="sxs-lookup"><span data-stu-id="f9368-210">If any log is waiting in the redo queue, the mirror server finishes rolling forward the mirror database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-211">应用日志所需的时间取决于系统的速度、最近的工作负载以及重做队列中的日志量。</span><span class="sxs-lookup"><span data-stu-id="f9368-211">The amount of time required to apply the log depends on the speed of the system, the recent work load, and the amount of log in the redo queue.</span></span>  
  
4.  <span data-ttu-id="f9368-212">前一个镜像数据库作为新的联机主体数据库，恢复通过尽快回滚未提交的事务将这些事务全部清除。</span><span class="sxs-lookup"><span data-stu-id="f9368-212">The former mirror database moves online as the new principal database, and recovery cleans up all uncommitted transactions by rolling them back as quickly as possible.</span></span> <span data-ttu-id="f9368-213">锁将隔离这些事务。</span><span class="sxs-lookup"><span data-stu-id="f9368-213">Locks isolate those transactions.</span></span>  
  
5.  <span data-ttu-id="f9368-214">当前一个主体服务器重新联接到会话时，它将认定其故障转移伙伴现在拥有主体角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-214">When the former principal server rejoins the session, it recognizes that its failover partner now owns the principal role.</span></span> <span data-ttu-id="f9368-215">前一个主体服务器接管镜像角色，并将其数据库作为镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-215">The former principal server takes on the role of mirror, making its database the mirror database.</span></span> <span data-ttu-id="f9368-216">新的镜像服务器会尽快将新的镜像数据库与主体数据库同步。</span><span class="sxs-lookup"><span data-stu-id="f9368-216">The new mirror server synchronizes the new mirror database with the principal database as quickly as possible.</span></span> <span data-ttu-id="f9368-217">新的镜像服务器重新同步数据库后，就可以再次执行故障转移，但按反向执行。</span><span class="sxs-lookup"><span data-stu-id="f9368-217">As soon as the new mirror server has resynchronized the databases, failover is again possible, but in the reverse direction.</span></span>  
  
 <span data-ttu-id="f9368-218">下图说明了自动故障转移的一个实例。</span><span class="sxs-lookup"><span data-stu-id="f9368-218">The following illustration shows a single instance of automatic failover.</span></span>  
  
 <span data-ttu-id="f9368-219">![自动故障转移](../media/dbm-failovauto1round.gif "自动故障转移 (automatic failover)")</span><span class="sxs-lookup"><span data-stu-id="f9368-219">![Automatic failover](../media/dbm-failovauto1round.gif "Automatic failover")</span></span>  
  
 <span data-ttu-id="f9368-220">最初，所有三个服务器都已连接（会话具有完全仲裁）。</span><span class="sxs-lookup"><span data-stu-id="f9368-220">Initially, all three servers are connected (the session has full quorum).</span></span> <span data-ttu-id="f9368-221">**Partner_A** 为主体服务器， **Partner_B** 为镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-221">**Partner_A** is the principal server and **Partner_B** is the mirror server.</span></span> <span data-ttu-id="f9368-222">**Partner_A** （或 **Partner_A**上的主体数据库）变得不可用。</span><span class="sxs-lookup"><span data-stu-id="f9368-222">**Partner_A** (or the principal database on **Partner_A**) becomes unavailable.</span></span> <span data-ttu-id="f9368-223">见证服务器和 **Partner_B** 都将认定主体服务器不可用，会话保留仲裁。</span><span class="sxs-lookup"><span data-stu-id="f9368-223">The witness and **Partner_B** both recognize that the principal is no longer available the session retains quorum.</span></span> <span data-ttu-id="f9368-224">**Partner_B** 变为主体服务器，并将其数据库的副本用作新的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-224">**Partner_B** becomes the principal server and makes its copy of the database available as the new principal database.</span></span> <span data-ttu-id="f9368-225">最后， **Partner_A** 重新连接到会话并发现 **Partner_B** 现在拥有主体角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-225">Eventually, **Partner_A** reconnects to the session and discovers that **Partner_B** now owns the principal role.</span></span> <span data-ttu-id="f9368-226">**Partner_A** 接下来将接管镜像角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-226">**Partner_A** then takes on the mirror role.</span></span>  
  
 <span data-ttu-id="f9368-227">执行故障转移后，客户端必须重新连接到当前的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-227">After failover, clients must reconnect to the current principal database.</span></span> <span data-ttu-id="f9368-228">有关详细信息，请参阅 [将客户端连接到数据库镜像会话 (SQL Server)](connect-clients-to-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-228">For more information, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f9368-229">当发生故障转移时，使用 [!INCLUDE[msCoName](../../includes/msconame-md.md)] 分布式事务处理协调器准备就绪但尚未提交的事务被认为在数据库故障转移后已中止。</span><span class="sxs-lookup"><span data-stu-id="f9368-229">Transactions that have been prepared using the [!INCLUDE[msCoName](../../includes/msconame-md.md)] Distributed Transaction Coordinator but are still not committed when a failover occurs, are considered aborted after the database has failed over.</span></span>  
  
###  <a name="to-disable-automatic-failover-sql-server-management-studio"></a><a name="DisableAutoSSMS"></a> <span data-ttu-id="f9368-230">禁用自动故障转移 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="f9368-230">To Disable Automatic Failover (SQL Server Management Studio)</span></span>  
 <span data-ttu-id="f9368-231">打开“数据库属性镜像”页，并通过选择下列选项之一更改操作模式：</span><span class="sxs-lookup"><span data-stu-id="f9368-231">Open the **Database PropertiesMirroring** page, and change the operating mode by selecting one of the following options:</span></span>  
  
-   <span data-ttu-id="f9368-232">**不带自动故障转移功能的高安全(同步)**</span><span class="sxs-lookup"><span data-stu-id="f9368-232">**High safety without automatic failover (synchronous)**</span></span>  
  
     <span data-ttu-id="f9368-233">在此模式下，数据库继续进行同步，并且可以进行手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-233">In this mode, the database continues to be synchronized, and manual failover remains possible.</span></span>  
  
-   <span data-ttu-id="f9368-234">**高性能(异步)**</span><span class="sxs-lookup"><span data-stu-id="f9368-234">**High performance (asynchronous)**</span></span>  
  
     <span data-ttu-id="f9368-235">在此模式下，镜像数据库可能稍微滞后于主体数据库，并且不可能再进行手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-235">In this mode, the mirror database might lag somewhat behind the principal database, and manual failover is no longer possible.</span></span>  
  
### <a name="to-disable-automatic-failover-using-transact-sql"></a><span data-ttu-id="f9368-236">禁用自动故障转移（使用 Transact-SQL）</span><span class="sxs-lookup"><span data-stu-id="f9368-236">To Disable Automatic Failover (Using Transact-SQL)</span></span>  
 <span data-ttu-id="f9368-237">在数据库镜像会话过程中，数据库所有者可以随时通过关闭见证服务器来禁用自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="f9368-237">At any point in a database mirroring session, the database owner can disable automatic failover by turning off the witness.</span></span>  
  
 <span data-ttu-id="f9368-238">**关闭见证服务器**</span><span class="sxs-lookup"><span data-stu-id="f9368-238">**To turn off the witness**</span></span>  
  
-   [<span data-ttu-id="f9368-239">从数据库镜像会话删除见证服务器 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f9368-239">Remove the Witness from a Database Mirroring Session &#40;SQL Server&#41;</span></span>](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
    > [!NOTE]  
    >  <span data-ttu-id="f9368-240">关闭见证服务器而保留完整事务安全，会将会话置于不带自动故障转移功能的高安全性模式中。</span><span class="sxs-lookup"><span data-stu-id="f9368-240">Turning off the witness while retaining full transaction safety puts the session into high-safety mode without automatic failover.</span></span>  
  
##  <a name="forced-service-with-possible-data-loss"></a><a name="ForcedService"></a> <span data-ttu-id="f9368-241">Forced Service (with Possible Data Loss)</span><span class="sxs-lookup"><span data-stu-id="f9368-241">Forced Service (with Possible Data Loss)</span></span>  
 <span data-ttu-id="f9368-242">数据库镜像提供强制服务（可能造成数据丢失）作为灾难恢复方法，以允许将镜像服务器用作温备用服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-242">Database mirroring provides forcing service (with possible data loss) as a disaster recovery method to allow you to use a mirror server as a warm standby server.</span></span> <span data-ttu-id="f9368-243">仅当主体服务器在镜像会话中与镜像服务器断开连接时，才能强制服务运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-243">Forcing service is possible only if the principal server is disconnected from the mirror server in a mirroring session.</span></span> <span data-ttu-id="f9368-244">因为强制服务运行存在数据丢失的风险，所以应该谨慎使用。</span><span class="sxs-lookup"><span data-stu-id="f9368-244">Because forcing service risks possible data loss, it should be used cautiously and sparingly.</span></span>  
  
 <span data-ttu-id="f9368-245">是否支持强制服务取决于会话的运行模式和状态，如下所示：</span><span class="sxs-lookup"><span data-stu-id="f9368-245">Support for forced service depends on the operating mode and the state of the session, as follows:</span></span>  
  
-   <span data-ttu-id="f9368-246">通常，当主体服务器断开连接时，高性能模式支持强制服务。</span><span class="sxs-lookup"><span data-stu-id="f9368-246">Typically, high-performance mode supports forcing service whenever the principal server is disconnected.</span></span> <span data-ttu-id="f9368-247">但是，高性能模式会话可能存在见证服务器（虽然并非必需）。</span><span class="sxs-lookup"><span data-stu-id="f9368-247">However, though unnecessary, a witness can exist for a high-performance mode session.</span></span> <span data-ttu-id="f9368-248">在这种情况下，强制服务要求镜像服务器和见证服务器相互连接。</span><span class="sxs-lookup"><span data-stu-id="f9368-248">In this case, forcing service requires that the mirror server and witness are connected to each other.</span></span>  
  
-   <span data-ttu-id="f9368-249">当主体服务器断开连接时，不带自动故障转移功能的高安全性模式支持强制服务。</span><span class="sxs-lookup"><span data-stu-id="f9368-249">High-safety mode without automatic failover supports forcing service whenever the principal server is disconnected.</span></span>  
  
-   <span data-ttu-id="f9368-250">当镜像服务器和见证服务器相互连接并且它们都未连接到主体服务器时，具有自动故障转移功能的高安全性模式支持强制服务（只要当镜像服务器上次连接到主体服务器时，不回滚镜像数据库）。</span><span class="sxs-lookup"><span data-stu-id="f9368-250">High-safety mode with automatic failover supports forcing service whenever the mirror server and witness are connected to each other and neither is connected to the principal server (as long as the mirror server was not in the process of rolling back the mirror database when it was last connected to the principal).</span></span>  
  
 <span data-ttu-id="f9368-251">建议仅当您必须立即还原数据库服务并愿意承担数据丢失的风险时，才能强制服务运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-251">We recommend forcing service only if you must restore service to the database immediately and are willing to risk losing data.</span></span> <span data-ttu-id="f9368-252">强制服务的结果相当于删除镜像，但强制服务在恢复镜像时便于重新同步数据库，并且可能存在数据丢失的风险。</span><span class="sxs-lookup"><span data-stu-id="f9368-252">The effect of forcing service is similar to removing mirroring, except that forcing service facilitates resynchronizing the databases when mirroring is resumed, at the risk of possible data loss.</span></span> <span data-ttu-id="f9368-253">强制服务将把主体角色平滑转换给镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-253">Forcing service initiates a smooth transition of the principal role to the mirror database.</span></span> <span data-ttu-id="f9368-254">镜像服务器将担当主体服务器角色并立即向客户端提供数据库的副本。</span><span class="sxs-lookup"><span data-stu-id="f9368-254">The mirror server assumes the role of principal server and immediately serves its copy of the database to clients.</span></span> <span data-ttu-id="f9368-255">新的主体数据库在没有镜像的情况下运行（即公开运行）。</span><span class="sxs-lookup"><span data-stu-id="f9368-255">The new principal database runs without a mirror (that is, it runs exposed).</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="f9368-256">如果主体服务器仅与数据库镜像会话断开连接并且仍在运行，则某些客户端可以继续访问原始主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-256">If the principal server was merely disconnected from the database mirroring session and is still running, some clients might continue to access the original principal database.</span></span> <span data-ttu-id="f9368-257">强制服务之前，必须防止客户端访问原始主体服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-257">Before you force service, it is important to prevent clients from accessing the original principal server.</span></span> <span data-ttu-id="f9368-258">否则，强制服务之后，原始主体数据库和当前主体数据库便会分别进行更新。</span><span class="sxs-lookup"><span data-stu-id="f9368-258">Otherwise, after service is forced, the original principal database and the current principal database could be updated independently of the other.</span></span>  
  
  
  
###  <a name="typical-case-of-forced-service"></a><a name="TypicalCaseFS"></a> <span data-ttu-id="f9368-259">强制服务的典型事例</span><span class="sxs-lookup"><span data-stu-id="f9368-259">Typical Case of Forced Service</span></span>  
 <span data-ttu-id="f9368-260">下图说明了强制服务（可能造成数据丢失）的典型事例。</span><span class="sxs-lookup"><span data-stu-id="f9368-260">The following figure illustrates a typical case of forced service (with possible data loss).</span></span>  
  
 <span data-ttu-id="f9368-261">![可能会丢失数据的强制服务](../media/dbm-forced-service.gif "可能会丢失数据的强制服务")</span><span class="sxs-lookup"><span data-stu-id="f9368-261">![Forcing service with possible data loss](../media/dbm-forced-service.gif "Forcing service with possible data loss")</span></span>  
  
 <span data-ttu-id="f9368-262">在图中，原始主体服务器 **Partner_A**不可用于镜像服务器 **Partner_B**，从而导致镜像数据库断开连接。</span><span class="sxs-lookup"><span data-stu-id="f9368-262">In the figure, the original principal server, **Partner_A**, becomes unavailable to the mirror server, **Partner_B**, causing the mirror database to be disconnected.</span></span> <span data-ttu-id="f9368-263">确定 **Partner_A** 不可用于客户端之后，数据库管理员对 **Partner_B** 进行强制服务，这可能会造成数据丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-263">After ensuring that **Partner_A** is not available to clients, the database administrator forces service, with possible data loss, on **Partner_B**.</span></span> <span data-ttu-id="f9368-264">**Partner_B** 变为主体服务器，并在数据库公开（也就是未镜像）的情况下运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-264">**Partner_B** becomes the principal server and runs with the database *exposed* (that is, unmirrored).</span></span> <span data-ttu-id="f9368-265">此时，客户端可以重新连接到 **Partner_B**。</span><span class="sxs-lookup"><span data-stu-id="f9368-265">At this point, clients can reconnect to **Partner_B**.</span></span>  
  
 <span data-ttu-id="f9368-266">当 **Partner_A** 变得可用时，它会重新连接到新的主体服务器，从而重新加入会话并担当镜像角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-266">When **Partner_A** becomes available, it reconnects to the new principal server, rejoining the session and assuming the mirror role.</span></span> <span data-ttu-id="f9368-267">镜像会话便会立即挂起，而尚未同步新的镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-267">The mirroring session is suspended immediately, without having synchronized the new mirror database.</span></span> <span data-ttu-id="f9368-268">会话挂起之后，数据库管理员可以确定是恢复会话，还是在极特殊情况下删除镜像并尝试对以前主体数据库中的数据进行补救。</span><span class="sxs-lookup"><span data-stu-id="f9368-268">Suspending the session allows the database administrator to decide whether to resume the session or, in extreme cases, remove mirroring and attempt to salvage data from the former principal database.</span></span> <span data-ttu-id="f9368-269">在此事例中，数据库管理员选择恢复镜像。</span><span class="sxs-lookup"><span data-stu-id="f9368-269">In this case, the database administrator chooses to resume mirroring.</span></span> <span data-ttu-id="f9368-270">此时， **Partner_A** 接管镜像服务器的角色并将以前的主体数据库回滚到上次成功同步事务的时间点；如果在强制服务之前，未将所有提交的事务写入镜像服务器上的磁盘，则这些事务将丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-270">At that point, **Partner_A** takes over the role of mirror server and rolls back the former principal database to the point in time of the last successfully synchronized transaction; if any committed transactions were not written to disk on the mirror server before service was forced, they are lost.</span></span> <span data-ttu-id="f9368-271">然后，**Partner_A** 通过应用自以前镜像服务器变为新主体服务器以来对新主体数据库所做的所有更改，前滚新的镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-271">**Partner_A** then rolls forward the new mirror database by applying any changes made on the new principal database since the former mirror server became the new principal server.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f9368-272">虽然高性能模式不需要见证服务器，但如果配置了一个见证服务器，则仅当见证服务器当前连接到镜像服务器时，才可以强制服务运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-272">Although high-performance mode does not require a witness, if one is configured, forcing service is possible only if the witness is currently connected to the mirror server.</span></span>  
  
###  <a name="risks-of-forcing-service"></a><a name="FSrisks"></a> <span data-ttu-id="f9368-273">强制服务的风险</span><span class="sxs-lookup"><span data-stu-id="f9368-273">Risks of Forcing Service</span></span>  
 <span data-ttu-id="f9368-274">一定要注意，强制服务可能会造成数据丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-274">It is essential to understand that forcing service can cause data loss.</span></span> <span data-ttu-id="f9368-275">数据可能会丢失，因为镜像服务器无法与主体服务器进行通信，从而不能保证两个数据库同步。</span><span class="sxs-lookup"><span data-stu-id="f9368-275">Data loss is possible because the mirror server cannot communicate with the principal server and, therefore, cannot guarantee that the two databases are synchronized.</span></span> <span data-ttu-id="f9368-276">强制服务还启动新的恢复分叉。</span><span class="sxs-lookup"><span data-stu-id="f9368-276">Forcing service starts a new recovery fork.</span></span> <span data-ttu-id="f9368-277">因为原始主体数据库和镜像数据库位于不同的恢复分叉上，每个数据库现在包含其他数据库不包含的数据：原始主体数据库包含任何尚未从其发送队列发送到以前的镜像数据库（未发送的日志）的更改；以前的镜像数据库包含任何强制服务之后发生的更改。</span><span class="sxs-lookup"><span data-stu-id="f9368-277">Because the original principal database and mirror database are on different recovery forks, each database now contains data that the other database does not: the original principal database contains whatever changes were not yet sent from its send queue to the former mirror database (the unsent log); the former mirror database contains whatever changes occur after service was forced.</span></span>  
  
 <span data-ttu-id="f9368-278">如果因为主体服务器出现故障而强制服务，则潜在的数据丢失取决于是否在出现故障之前已将所有事务日志发送到镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-278">If service is forced because the principal server has failed, potential data loss is depends on whether any transaction logs were not sent to the mirror server before the failure.</span></span> <span data-ttu-id="f9368-279">在高安全性模式下，可能仅在镜像数据库同步之前会出现这种情况。</span><span class="sxs-lookup"><span data-stu-id="f9368-279">Under high-safety mode, this is possible only until the mirror database becomes synchronized.</span></span> <span data-ttu-id="f9368-280">在高性能模式下，可能会始终存在累积的未发送日志。</span><span class="sxs-lookup"><span data-stu-id="f9368-280">Under the high-performance mode, accumulated unsent log is always a possibility.</span></span>  
  
 <span data-ttu-id="f9368-281">强制服务的影响在某种程度上取决于会话是否具有见证服务器：</span><span class="sxs-lookup"><span data-stu-id="f9368-281">The implications of forcing service depend partly on whether the session has a witness:</span></span>  
  
-   <span data-ttu-id="f9368-282">没有见证服务器时，如果伙伴断开连接（例如，因为伙伴网络连接断开），则可以强制服务运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-282">In the absence of a witness, service can be forced if the partners become disconnected, for example, because their network connection is broken.</span></span> <span data-ttu-id="f9368-283">如果原始主体服务器仍在运行，则两个伙伴都拥有主体角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-283">If the original principal server is still running, both partners own the principal role.</span></span> <span data-ttu-id="f9368-284">连接到新主体服务器的客户端将访问当前版本的数据库，而连接到原始主体服务器的客户端将访问原始主体数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-284">Clients connecting to the new principal server will access the current version of the database, while clients connecting to the original principal server will access the original principal database.</span></span> <span data-ttu-id="f9368-285">这种情况增大了数据丢失的可能性。</span><span class="sxs-lookup"><span data-stu-id="f9368-285">This situation increases the potential for data loss.</span></span> <span data-ttu-id="f9368-286">如果允许伙伴进行重新连接，则原始主体服务器担当镜像角色，并在镜像挂起之前将其数据库的状态更改为“正在恢复”。</span><span class="sxs-lookup"><span data-stu-id="f9368-286">If the partners are allowed to reconnect, the original principal server assumes the mirror role and changes the status of its database to "recovering," before mirroring is suspended.</span></span> <span data-ttu-id="f9368-287">如果恢复会话，则原始主体数据库中日志在最近断开连接以来已在发送队列中的事务将丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-287">If the session is resumed, transactions on the original principal database whose log was in the send queue as of the most recent disconnection are lost.</span></span> <span data-ttu-id="f9368-288">此外，强制服务之后发生的所有事务也将丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-288">In addition, any the transactions that occurred after service was forced are also lost.</span></span>  
  
-   <span data-ttu-id="f9368-289">存在见证服务器时，如果镜像服务器与主体服务器和见证服务器断开连接，则只要主体服务器和见证服务器保持相互连接，主体服务器便会公开运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-289">In the presence of a witness, if the mirror server is disconnected from both the principal server and the witness, as long as the latter two remain connected to each other, the principal runs exposed.</span></span> <span data-ttu-id="f9368-290">如果主体服务器与见证服务器断开连接，则它会停止为数据库提供服务。</span><span class="sxs-lookup"><span data-stu-id="f9368-290">If the principal server then becomes disconnected from the witness, it stops serving the database.</span></span> <span data-ttu-id="f9368-291">此后，如果镜像服务器重新连接到见证服务器，则可以强制服务运行。</span><span class="sxs-lookup"><span data-stu-id="f9368-291">Thereafter, if the mirror server reconnects to the witness, forcing service becomes possible.</span></span> <span data-ttu-id="f9368-292">如果强制服务，则在重新连接原始主体服务器时，在原始主体服务器公开运行时所做的所有更改都将丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-292">If service is forced, all the changes made while the original principal server was running exposed will be lost if the original principal server reconnects.</span></span>  
  
 <span data-ttu-id="f9368-293">有关详细信息，请参阅本主题后面的 [管理潜在的数据丢失](#ManageDataLoss)。</span><span class="sxs-lookup"><span data-stu-id="f9368-293">For more information, see [Managing the Potential Data Loss](#ManageDataLoss), later in this topic.</span></span>  
  
###  <a name="managing-the-potential-data-loss"></a><a name="ManageDataLoss"></a> <span data-ttu-id="f9368-294">管理潜在的数据丢失</span><span class="sxs-lookup"><span data-stu-id="f9368-294">Managing the Potential Data Loss</span></span>  
 <span data-ttu-id="f9368-295">强制服务之后，如果以前的主体服务器可用，并假设其数据库没有损坏，则可以尝试管理潜在的数据丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-295">After service is forced, once the former principal server is available, assuming that its database is undamaged, you can attempt to manage the potential data loss.</span></span> <span data-ttu-id="f9368-296">管理潜在数据丢失的可用方法取决于原始主体服务器是否已重新连接到其伙伴并重新加入镜像会话。</span><span class="sxs-lookup"><span data-stu-id="f9368-296">The available approach for managing potential data loss depends on whether the original principal server has reconnected to its partner and rejoined the mirroring session.</span></span> <span data-ttu-id="f9368-297">假设原始主体服务器可以访问新的主体实例，则会自动透明地进行重新连接。</span><span class="sxs-lookup"><span data-stu-id="f9368-297">Assuming that the original principal server can access the new principal instance, reconnecting occurs automatically and transparently.</span></span>  
  
#### <a name="the-original-principal-server-has-reconnected"></a><span data-ttu-id="f9368-298">已重新连接原始主体服务器</span><span class="sxs-lookup"><span data-stu-id="f9368-298">The Original Principal Server Has Reconnected</span></span>  
 <span data-ttu-id="f9368-299">通常，出现故障后，原始主体服务器在重新启动时便会迅速重新连接到其伙伴。</span><span class="sxs-lookup"><span data-stu-id="f9368-299">Typically, after a failure, when the original principal server restarts it quickly reconnects to its partner.</span></span> <span data-ttu-id="f9368-300">重新连接后，原始主体服务器变为镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="f9368-300">On reconnecting, the original principal server becomes the mirror server.</span></span> <span data-ttu-id="f9368-301">其数据库变为镜像数据库，并且在会话挂起之前进入恢复状态。</span><span class="sxs-lookup"><span data-stu-id="f9368-301">Its database becomes the mirror database and enters the recovering state before the session is suspended.</span></span> <span data-ttu-id="f9368-302">除非恢复镜像，否则不回滚镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-302">The mirror database will not be not rolled back unless you resume mirroring.</span></span>  
  
 <span data-ttu-id="f9368-303">但是，无法访问恢复数据库；因此，不能对其进行检查以确定恢复镜像时可能丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="f9368-303">However, the recovering database is inaccessible; therefore, you cannot inspect it to evaluate what data would be lost if you were to resume mirroring.</span></span> <span data-ttu-id="f9368-304">因此，确定是恢复镜像还是删除镜像取决于您是否能够完全接受数据丢失。</span><span class="sxs-lookup"><span data-stu-id="f9368-304">Therefore, the decision on whether to resume or remove mirroring depends on whether you are willing to accept any data loss at all.</span></span>  
  
-   <span data-ttu-id="f9368-305">如果数据丢失不可接受，则应该删除镜像以对数据进行补救。</span><span class="sxs-lookup"><span data-stu-id="f9368-305">If losing any data would be unacceptable, you should remove mirroring to salvage them.</span></span>  
  
     <span data-ttu-id="f9368-306">通过删除镜像，数据库管理员可以恢复原始主体数据库，并尝试恢复可能已丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="f9368-306">Removing mirroring would allow the database administrator to recover the original principal database and attempt to recover the data that would have been lost.</span></span> <span data-ttu-id="f9368-307">但是，如果以前的镜像数据库在线，则以前的伙伴将为同名的不同数据库提供服务。</span><span class="sxs-lookup"><span data-stu-id="f9368-307">However, when the former mirror database comes online, the former partners will be serving divergent databases with the same name.</span></span> <span data-ttu-id="f9368-308">数据库管理员需要使客户端无法访问其中一个数据库，以免数据库产生进一步分歧并防止出现客户端故障转移问题。</span><span class="sxs-lookup"><span data-stu-id="f9368-308">The database administrator needs to make one of the databases inaccessible to clients to avoid further divergence of the database and to prevent client-failover issues.</span></span>  
  
-   <span data-ttu-id="f9368-309">如果数据丢失可以接受，则可以恢复镜像。</span><span class="sxs-lookup"><span data-stu-id="f9368-309">If losing any data would be acceptable, you can resume mirroring.</span></span>  
  
     <span data-ttu-id="f9368-310">恢复镜像会导致新的镜像数据库如同步数据库第一步所述那样回滚。</span><span class="sxs-lookup"><span data-stu-id="f9368-310">Resuming mirroring causes the new mirror database to be rolled back as the first step in synchronizing the database.</span></span> <span data-ttu-id="f9368-311">如果出现故障时日志记录在发送队列中等待，则相应的事务将会丢失，即使已提交这些事务也会如此。</span><span class="sxs-lookup"><span data-stu-id="f9368-311">If any log records were waiting in the send queue at the time of failure, the corresponding transactions are lost, even if they were committed.</span></span>  
  
#### <a name="the-original-principal-server-has-not-reconnected"></a><span data-ttu-id="f9368-312">尚未重新连接原始主体服务器</span><span class="sxs-lookup"><span data-stu-id="f9368-312">The Original Principal Server Has Not Reconnected</span></span>  
 <span data-ttu-id="f9368-313">如果可以暂时阻止原始主体服务器通过网络重新连接到新的主体服务器，则可以检查原始主体数据库以确定恢复镜像时可能丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="f9368-313">If you can temporarily prevent the original principal server from reconnecting over the network to the new principal server, you can inspect the original principal database to evaluate what data would be lost if mirroring were resumed.</span></span>  
  
-   <span data-ttu-id="f9368-314">如果潜在的数据丢失可以接受</span><span class="sxs-lookup"><span data-stu-id="f9368-314">If the potential data loss is acceptable</span></span>  
  
     <span data-ttu-id="f9368-315">允许原始主体服务器重新连接到其伙伴。</span><span class="sxs-lookup"><span data-stu-id="f9368-315">Allow the original principal server to reconnect to its partner.</span></span> <span data-ttu-id="f9368-316">重新连接会导致镜像挂起。</span><span class="sxs-lookup"><span data-stu-id="f9368-316">Reconnecting causes mirroring to be suspended.</span></span> <span data-ttu-id="f9368-317">若要继续镜像，只需恢复会话。</span><span class="sxs-lookup"><span data-stu-id="f9368-317">To proceed with mirroring, simply resume the session.</span></span> <span data-ttu-id="f9368-318">以前的主体服务器担当镜像角色。</span><span class="sxs-lookup"><span data-stu-id="f9368-318">The former principal server assumes the mirror role.</span></span> <span data-ttu-id="f9368-319">新的镜像服务器会删除原始恢复分叉，从而丢失从未发送到以前的镜像服务器或由其接收的所有事务。</span><span class="sxs-lookup"><span data-stu-id="f9368-319">The new mirror server drops the original recovery fork, losing any transactions that were never sent to or received by the former mirror server.</span></span>  
  
-   <span data-ttu-id="f9368-320">如果数据丢失不可接受</span><span class="sxs-lookup"><span data-stu-id="f9368-320">If the data loss is unacceptable</span></span>  
  
     <span data-ttu-id="f9368-321">如果原始主体数据库包含在恢复会话时可能丢失的重要数据，则可以删除镜像以保留原始主体服务器中的数据。</span><span class="sxs-lookup"><span data-stu-id="f9368-321">If the original principal database contains critical data that would be lost if you resumed the session, you can preserve the data on the original principal server by removing mirroring.</span></span> <span data-ttu-id="f9368-322">建议在此时尝试备份主体数据库的日志尾部。</span><span class="sxs-lookup"><span data-stu-id="f9368-322">We recommend that you attempt to back up the tail of the principal's log at this point.</span></span> <span data-ttu-id="f9368-323">然后，通过从原始主体数据库中导出要补救的数据，并将其导入当前主体数据库来更新当前主体数据库（以前的镜像数据库）。</span><span class="sxs-lookup"><span data-stu-id="f9368-323">Then, you can update the current principal (the former mirror database) by exporting the data you want to salvage from the original principal database and importing it into the current principal database.</span></span> <span data-ttu-id="f9368-324">建议尽快对已更新的数据库执行完整数据库备份。</span><span class="sxs-lookup"><span data-stu-id="f9368-324">We recommend taking a full database backup of the updated database as quickly as possible.</span></span>  
  
     <span data-ttu-id="f9368-325">若要使用已更新的数据库作为初始主体数据库来重新建立镜像，请使用此备份（以及至少一个后续日志备份）创建新的镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="f9368-325">To re-establish mirroring with the updated database as the initial principal database, use this backup (and least one subsequent log backup) to create a new mirror database.</span></span> <span data-ttu-id="f9368-326">必须应用删除镜像之后执行的每个日志备份。</span><span class="sxs-lookup"><span data-stu-id="f9368-326">Every log backup taken after mirroring was removed must be applied.</span></span> <span data-ttu-id="f9368-327">因此，建议在启动新的镜像会话之前延迟主体数据的其他日志备份。</span><span class="sxs-lookup"><span data-stu-id="f9368-327">Therefore, we recommend delaying additional log backups of the principal database until the new mirroring session starts.</span></span>  
  
###  <a name="related-tasks-for-managing-a-forced-failover"></a><a name="RelatedTasksForFS"></a> <span data-ttu-id="f9368-328">与管理强制故障转移相关的任务</span><span class="sxs-lookup"><span data-stu-id="f9368-328">Related Tasks For Managing a Forced Failover</span></span>  
 <span data-ttu-id="f9368-329">**强制服务**</span><span class="sxs-lookup"><span data-stu-id="f9368-329">**To force service**</span></span>  
  
-   <span data-ttu-id="f9368-330">[在数据库镜像会话中强制服务 (Transact-SQL)](force-service-in-a-database-mirroring-session-transact-sql.md)。</span><span class="sxs-lookup"><span data-stu-id="f9368-330">[Force Service in a Database Mirroring Session &#40;Transact-SQL&#41;](force-service-in-a-database-mirroring-session-transact-sql.md).</span></span>  
  
 <span data-ttu-id="f9368-331">**恢复数据库镜像**</span><span class="sxs-lookup"><span data-stu-id="f9368-331">**To resume database mirroring**</span></span>  
  
-   [<span data-ttu-id="f9368-332">暂停或恢复数据库镜像会话 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f9368-332">Pause or Resume a Database Mirroring Session &#40;SQL Server&#41;</span></span>](pause-or-resume-a-database-mirroring-session-sql-server.md)  
  
 <span data-ttu-id="f9368-333">**创建新的镜像数据库**</span><span class="sxs-lookup"><span data-stu-id="f9368-333">**To create a new mirror database**</span></span>  
  
 [<span data-ttu-id="f9368-334">为镜像准备镜像数据库 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f9368-334">Prepare a Mirror Database for Mirroring &#40;SQL Server&#41;</span></span>](prepare-a-mirror-database-for-mirroring-sql-server.md)  
  
 <span data-ttu-id="f9368-335">**启动数据库镜像**</span><span class="sxs-lookup"><span data-stu-id="f9368-335">**To start up database mirroring**</span></span>  
  
-   [<span data-ttu-id="f9368-336">设置数据库镜像 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f9368-336">Setting Up Database Mirroring &#40;SQL Server&#41;</span></span>](setting-up-database-mirroring-sql-server.md)  
  
-   [<span data-ttu-id="f9368-337">使用 Windows 身份验证建立数据库镜像会话 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="f9368-337">Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;</span></span>](establish-database-mirroring-session-windows-authentication.md)  
  
## <a name="see-also"></a><span data-ttu-id="f9368-338">另请参阅</span><span class="sxs-lookup"><span data-stu-id="f9368-338">See Also</span></span>  
 <span data-ttu-id="f9368-339">[估计在角色切换期间服务的中断（数据库镜像）](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="f9368-339">[Estimate the Interruption of Service During Role Switching &#40;Database Mirroring&#41;](estimate-the-interruption-of-service-during-role-switching-database-mirroring.md) </span></span>  
 <span data-ttu-id="f9368-340">[数据库镜像期间可能出现的故障](possible-failures-during-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="f9368-340">[Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md) </span></span>  
 <span data-ttu-id="f9368-341">[将客户端连接到数据库镜像会话 (SQL Server)](connect-clients-to-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="f9368-341">[Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](connect-clients-to-a-database-mirroring-session-sql-server.md) </span></span>  
 <span data-ttu-id="f9368-342">[数据库镜像见证服务器](database-mirroring-witness.md) </span><span class="sxs-lookup"><span data-stu-id="f9368-342">[Database Mirroring Witness](database-mirroring-witness.md) </span></span>  
 <span data-ttu-id="f9368-343">[完整数据库还原（完整恢复模式）](../../relational-databases/backup-restore/complete-database-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="f9368-343">[Complete Database Restores &#40;Full Recovery Model&#41;](../../relational-databases/backup-restore/complete-database-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="f9368-344">[数据库镜像运行模式](database-mirroring-operating-modes.md) </span><span class="sxs-lookup"><span data-stu-id="f9368-344">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) </span></span>  
 [<span data-ttu-id="f9368-345">镜像状态 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="f9368-345">Mirroring States &#40;SQL Server&#41;</span></span>](mirroring-states-sql-server.md)  
  
  

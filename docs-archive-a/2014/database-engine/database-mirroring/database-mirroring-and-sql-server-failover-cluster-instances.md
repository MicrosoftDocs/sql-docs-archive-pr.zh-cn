---
title: 数据库镜像和 SQL Server 故障转移群集实例 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- failover clustering [SQL Server], database mirroring
- database mirroring [SQL Server], failover
- high-availability mode [SQL Server]
ms.assetid: f1dd6a79-698b-4e31-b923-6bfc3ea0b617
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 378f834b4482f44f6a84abf419f027b353c7771a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87691865"
---
# <a name="database-mirroring-and-sql-server-failover-cluster-instances"></a><span data-ttu-id="76b80-102">数据库镜像和 SQL Server 故障转移群集实例</span><span class="sxs-lookup"><span data-stu-id="76b80-102">Database Mirroring and SQL Server Failover Cluster Instances</span></span>
  <span data-ttu-id="76b80-103">故障转移群集是 [!INCLUDE[msCoName](../../includes/msconame-md.md)] 群集服务 (MSCS) 群集组（称为资源组）中的一个或多个物理磁盘的组合，这些磁盘是群集的节点。</span><span class="sxs-lookup"><span data-stu-id="76b80-103">A failover cluster is a combination of one or more physical disks in a [!INCLUDE[msCoName](../../includes/msconame-md.md)] Cluster Service (MSCS) cluster group, known as a resource group, that are participating nodes of the cluster.</span></span> <span data-ttu-id="76b80-104">资源组配置为承载 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例的故障转移群集实例。</span><span class="sxs-lookup"><span data-stu-id="76b80-104">The resource group is configured as a failover clustered instance that hosts an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="76b80-105">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 故障转移群集实例就好像是网络上的一台计算机，但是它可以提供故障转移服务，当一个节点不可用时，可以从该节点故障转移到另一个节点。</span><span class="sxs-lookup"><span data-stu-id="76b80-105">A [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] failover clustered instance appears on the network as if it were a single computer, but has functionality that provides failover from one node to another if one node becomes unavailable.</span></span> <span data-ttu-id="76b80-106">有关详细信息，请参阅 [AlwaysOn 故障转移群集实例 (SQL Server)](../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="76b80-106">For more information, see [AlwaysOn Failover Cluster Instances (SQL Server)](../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md).</span></span>  
  
 <span data-ttu-id="76b80-107">与为单个数据库提供高可用性支持的数据库镜像相反，故障转移群集可为整个 [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例提供高可用性支持。</span><span class="sxs-lookup"><span data-stu-id="76b80-107">Failover clusters provide high-availability support for an entire [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance, in contrast to database mirroring, which provides high-availability support for a single database.</span></span> <span data-ttu-id="76b80-108">数据库镜像可以在故障转移群集之间进行，也可以在故障转移群集与非群集计算机之间进行。</span><span class="sxs-lookup"><span data-stu-id="76b80-108">Database mirroring works between failover clusters and, also, between a failover cluster and a nonclustered host.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="76b80-109">有关数据库镜像的介绍，请参阅 [数据库镜像 (SQL Server)](database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="76b80-109">For an introduction to database mirroring, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span></span>  
  
## <a name="mirroring-and-clustering"></a><span data-ttu-id="76b80-110">镜像和群集</span><span class="sxs-lookup"><span data-stu-id="76b80-110">Mirroring and Clustering</span></span>  
 <span data-ttu-id="76b80-111">通常，当镜像与群集一起使用时，主体服务器与镜像服务器都驻留在群集上，其中，主体服务器在一个群集的故障转移群集实例中运行，镜像服务器在另一个群集的故障转移群集实例中运行。</span><span class="sxs-lookup"><span data-stu-id="76b80-111">Typically, when mirroring is used with clustering, the principal server and mirror server both reside on clusters, with the principal server running on the failover clustered instance of one cluster and the mirror server running on the failover clustered instance of a different cluster.</span></span> <span data-ttu-id="76b80-112">不过，您可以建立一个镜像会话，其中，一个伙伴驻留在一个群集的故障转移群集实例中，另一个伙伴驻留在一个单独的非群集的计算机中。</span><span class="sxs-lookup"><span data-stu-id="76b80-112">You can establish a mirroring session in which one partner resides on the failover clustered instance of a cluster and the other partner resides on a separate, unclustered computer, however.</span></span>  
  
 <span data-ttu-id="76b80-113">如果群集故障转移使主体服务器暂时不可用，将断开客户端与数据库的连接。</span><span class="sxs-lookup"><span data-stu-id="76b80-113">If a cluster failover makes a principal server temporarily unavailable, client connections are disconnected from the database.</span></span> <span data-ttu-id="76b80-114">群集故障转移完成之后，根据 [运行模式](database-mirroring-operating-modes.md)，客户端可以重新连接到同一群集、不同群集或非群集计算机中的主体服务器。</span><span class="sxs-lookup"><span data-stu-id="76b80-114">After the cluster failover completes, clients can reconnect to the principal server on the same cluster, or on a different cluster or an unclustered computer, depending on the [operating mode](database-mirroring-operating-modes.md).</span></span> <span data-ttu-id="76b80-115">因此，当决定如何在群集环境中配置数据库镜像时，所使用的镜像运行模式至关重要。</span><span class="sxs-lookup"><span data-stu-id="76b80-115">Therefore, when deciding how to configure database mirroring in a clustered environment, the operating mode you use for mirroring is significant.</span></span>  
  
### <a name="high-safety-mode-session-with-automatic-failover"></a><span data-ttu-id="76b80-116">具有自动故障转移功能的高安全性模式会话</span><span class="sxs-lookup"><span data-stu-id="76b80-116">High-Safety mode Session with Automatic Failover</span></span>  
 <span data-ttu-id="76b80-117">如果想要在具有自动故障转移功能的高安全性模式下镜像数据库，则建议针对伙伴使用双群集配置。</span><span class="sxs-lookup"><span data-stu-id="76b80-117">If you intend to mirror a database in high-safety mode with automatic failover, a two-cluster configuration is recommended for the partners.</span></span> <span data-ttu-id="76b80-118">此配置提供最高的可用性。</span><span class="sxs-lookup"><span data-stu-id="76b80-118">This configuration provides maximum availability.</span></span> <span data-ttu-id="76b80-119">此见证服务器可以驻留在第三方群集上，也可以驻留在非群集计算机上。</span><span class="sxs-lookup"><span data-stu-id="76b80-119">The witness can reside either on a third cluster or on an unclustered computer.</span></span>  
  
 <span data-ttu-id="76b80-120">如果运行当前主体服务器的节点失败，将在几秒钟内开始进行数据库自动故障转移，群集仍然故障转移到另一个节点。</span><span class="sxs-lookup"><span data-stu-id="76b80-120">If the node running the current principal server fails, automatic failover of the database begins within a few seconds, while the cluster is still failing over to another node.</span></span> <span data-ttu-id="76b80-121">数据库镜像会话故障转移到其他群集或非群集计算机中的镜像服务器，并且先前的镜像服务器变为主体服务器。</span><span class="sxs-lookup"><span data-stu-id="76b80-121">The database mirroring session fails over to the mirror server on the other cluster or unclustered computer, and the former mirror server becomes the principal server.</span></span> <span data-ttu-id="76b80-122">新主体服务器将尽快前滚其数据库副本并使其作为主体数据库处于在线状态。</span><span class="sxs-lookup"><span data-stu-id="76b80-122">The new principal server rolls forward its copy of the database as quickly as possible and brings it online as the principal database.</span></span> <span data-ttu-id="76b80-123">群集故障转移完成（通常需要几分钟）之后，先前作为主体服务器的故障转移群集实例变为镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="76b80-123">After the cluster failover completes, which typically takes several minutes, the failover clustered instance that was formerly the principal server becomes the mirror server.</span></span>  
  
 <span data-ttu-id="76b80-124">下图显示了在具有见证服务器（支持自动故障转移）的高安全性模式下运行的镜像会话中，群集之间的自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="76b80-124">The following illustration shows an automatic failover between clusters in a mirroring session running in high-safety mode with a witness (which supports automatic failover).</span></span>  
  
 <span data-ttu-id="76b80-125">![对群集进行故障转移](../media/dbm-and-failover-clustering.gif "对群集进行故障转移")</span><span class="sxs-lookup"><span data-stu-id="76b80-125">![A failover on a cluster](../media/dbm-and-failover-clustering.gif "A failover on a cluster")</span></span>  
  
 <span data-ttu-id="76b80-126">镜像会话中的三个服务器实例驻留在三个不同的群集上：Cluster_A、Cluster_B 和 Cluster_C  。</span><span class="sxs-lookup"><span data-stu-id="76b80-126">The three server instances in the mirroring session reside on three distinct clusters: **Cluster_A**, **Cluster_B**, and **Cluster_C**.</span></span> <span data-ttu-id="76b80-127">每个群集上都有一个 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 默认实例，此实例作为 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 故障转移群集实例在运行。</span><span class="sxs-lookup"><span data-stu-id="76b80-127">On each cluster, a default instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is running as a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] failover clustered instance.</span></span> <span data-ttu-id="76b80-128">镜像会话启动时， **Cluster_A** 上的故障转移群集实例是主体服务器， **Cluster_B** 上的故障转移群集实例是镜像服务器， **Cluster_C** 上的故障转移群集实例是镜像会话中的见证服务器。</span><span class="sxs-lookup"><span data-stu-id="76b80-128">When the mirroring session starts, the failover clustered instance on **Cluster_A** is the principal server, the failover clustered instance on **Cluster_B** is the mirror server, and the failover clustered instance on **Cluster_C** is the witness in the mirroring session.</span></span> <span data-ttu-id="76b80-129">最终， **Cluster_A** 上的活动节点失败，这将导致主体服务器不可用。</span><span class="sxs-lookup"><span data-stu-id="76b80-129">Eventually, the active node on **Cluster_A** fails, which causes the principal server to become unavailable.</span></span>  
  
 <span data-ttu-id="76b80-130">在群集准备执行故障转移之前，镜像服务器借助见证服务器检测到主体服务器已丢失。</span><span class="sxs-lookup"><span data-stu-id="76b80-130">Before the cluster has time to fail over, the loss of the principal server is detected by the mirror server, with the help of the witness.</span></span> <span data-ttu-id="76b80-131">镜像服务器将前滚其数据库，并尽快使该数据库在线以成为新的主体数据库。</span><span class="sxs-lookup"><span data-stu-id="76b80-131">The mirror server rolls forward its database and brings it online as the new principal database as quickly as possible.</span></span> <span data-ttu-id="76b80-132">当 **Cluster_A** 完成故障转移之后，先前的主体服务器现在成为镜像服务器，并将其数据库与 **Cluster_B**上的当前主体数据库同步。</span><span class="sxs-lookup"><span data-stu-id="76b80-132">When **Cluster_A** finishes failing over, the former principal server is now the mirror server, and it synchronizes its database with the current principal database on **Cluster_B**.</span></span>  
  
### <a name="high-safety-mode-session-without-automatic-failover"></a><span data-ttu-id="76b80-133">不带自动故障转移功能的高安全性模式会话</span><span class="sxs-lookup"><span data-stu-id="76b80-133">High-Safety Mode Session Without Automatic Failover</span></span>  
 <span data-ttu-id="76b80-134">在不带自动故障转移功能的高安全性模式下镜像数据库时，如果运行当前主体服务器的节点失败，则群集中的其他节点将充当主体服务器。</span><span class="sxs-lookup"><span data-stu-id="76b80-134">If you are mirroring a database in high-safety mode without automatic failover, another node in the cluster will act as the principal server if the node running the current principal server fails.</span></span> <span data-ttu-id="76b80-135">注意，如果群集不可用，数据库将不可用。</span><span class="sxs-lookup"><span data-stu-id="76b80-135">Note that while the cluster is unavailable, the database is unavailable.</span></span>  
  
### <a name="high-performance-mode-session"></a><span data-ttu-id="76b80-136">高性能模式会话</span><span class="sxs-lookup"><span data-stu-id="76b80-136">High-Performance Mode Session</span></span>  
 <span data-ttu-id="76b80-137">如果想要在高性能模式下镜像数据库，请考虑将主体服务器放置在群集的故障转移群集实例中，将镜像服务器放置在远程位置的非群集服务器上。</span><span class="sxs-lookup"><span data-stu-id="76b80-137">If you intend to mirror a database in high-performance mode, consider placing the principal server on the failover clustered instance of a cluster and placing the mirror server on an unclustered server in a remote location.</span></span> <span data-ttu-id="76b80-138">如果群集故障转移到另一节点，在镜像会话中，故障转移群集实例将继续作为主体服务器。</span><span class="sxs-lookup"><span data-stu-id="76b80-138">If the cluster fails over to a different node, the failover clustered instance will continue as the principal server in the mirroring session.</span></span> <span data-ttu-id="76b80-139">如果整个群集出现问题，则可以将服务强制到镜像服务器上。</span><span class="sxs-lookup"><span data-stu-id="76b80-139">If the entire cluster has problems, you can force service onto the mirror server.</span></span>  
  
 <span data-ttu-id="76b80-140">**设置新的 SQL Server 故障转移群集**</span><span class="sxs-lookup"><span data-stu-id="76b80-140">**To set up a new SQL Server failover cluster**</span></span>  
  
-   [<span data-ttu-id="76b80-141">创建新的 SQL Server 故障转移群集（安装程序）</span><span class="sxs-lookup"><span data-stu-id="76b80-141">Create a New SQL Server Failover Cluster &#40;Setup&#41;</span></span>](../../sql-server/failover-clusters/install/create-a-new-sql-server-failover-cluster-setup.md)  
  
 <span data-ttu-id="76b80-142">**设置数据库镜像**</span><span class="sxs-lookup"><span data-stu-id="76b80-142">**To set up database mirroring**</span></span>  
  
-   [<span data-ttu-id="76b80-143">设置数据库镜像 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="76b80-143">Setting Up Database Mirroring &#40;SQL Server&#41;</span></span>](setting-up-database-mirroring-sql-server.md)  
  
-   [<span data-ttu-id="76b80-144">使用 Windows 身份验证建立数据库镜像会话 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="76b80-144">Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;</span></span>](establish-database-mirroring-session-windows-authentication.md)  
  
## <a name="see-also"></a><span data-ttu-id="76b80-145">另请参阅</span><span class="sxs-lookup"><span data-stu-id="76b80-145">See Also</span></span>  
 <span data-ttu-id="76b80-146">[数据库镜像 (SQL Server)](database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="76b80-146">[Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md) </span></span>  
 <span data-ttu-id="76b80-147">[数据库镜像运行模式](database-mirroring-operating-modes.md) </span><span class="sxs-lookup"><span data-stu-id="76b80-147">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) </span></span>  
 [<span data-ttu-id="76b80-148">AlwaysOn 故障转移群集实例 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="76b80-148">AlwaysOn Failover Cluster Instances (SQL Server)</span></span>](../../sql-server/failover-clusters/windows/always-on-failover-cluster-instances-sql-server.md) 
  
  

---
title: 数据库镜像运行模式 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], operating modes
ms.assetid: f8a579c2-55d7-4278-8088-f1da1de5b2e6
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: c944b402b8b1ba9b78036d667ec728ccaf561a91
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578417"
---
# <a name="database-mirroring-operating-modes"></a><span data-ttu-id="9c872-102">数据库镜像运行模式</span><span class="sxs-lookup"><span data-stu-id="9c872-102">Database Mirroring Operating Modes</span></span>
  <span data-ttu-id="9c872-103">本主题说明数据库镜像会话的同步和异步运行模式。</span><span class="sxs-lookup"><span data-stu-id="9c872-103">This topic describes the synchronous and asynchronous operating modes for database mirroring sessions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9c872-104">有关数据库镜像的介绍，请参阅 [数据库镜像 (SQL Server)](database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-104">For an introduction to database mirroring, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span></span>  
  
 
  
##  <a name="terms-and-definitions"></a><a name="TermsAndDefinitions"></a> <span data-ttu-id="9c872-105">术语和定义</span><span class="sxs-lookup"><span data-stu-id="9c872-105">Terms and Definitions</span></span>  
 <span data-ttu-id="9c872-106">此节介绍了几个术语，它们是本主题的核心。</span><span class="sxs-lookup"><span data-stu-id="9c872-106">This section introduces a few terms that are central to this topic.</span></span>  
  
 <span data-ttu-id="9c872-107">高性能模式</span><span class="sxs-lookup"><span data-stu-id="9c872-107">High-performance mode</span></span>  
 <span data-ttu-id="9c872-108">数据库镜像会话异步运行并仅使用主体服务器和镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-108">The database mirroring session operates asynchronously and uses only the principal server and mirror server.</span></span> <span data-ttu-id="9c872-109">唯一的角色切换形式是强制服务（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="9c872-109">The only form of role switching is forced service (with possible data loss).</span></span>  
  
 <span data-ttu-id="9c872-110">高安全性模式 (High-safety mode)</span><span class="sxs-lookup"><span data-stu-id="9c872-110">High-safety mode</span></span>  
 <span data-ttu-id="9c872-111">数据库镜像会话同步运行并可以选择使用见证服务器、主体服务器和镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-111">The database mirroring session operates synchronously and, optionally, uses a witness, as well as the principal server and mirror server.</span></span>  
  
 <span data-ttu-id="9c872-112">事务安全</span><span class="sxs-lookup"><span data-stu-id="9c872-112">Transaction safety</span></span>  
 <span data-ttu-id="9c872-113">一种镜像特定的数据库属性，用于确定数据库镜像会话是同步运行还是异步运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-113">A mirroring-specific database property that determines whether a database mirroring session operates synchronously or asynchronously.</span></span> <span data-ttu-id="9c872-114">有两种安全级别：FULL 和 OFF。</span><span class="sxs-lookup"><span data-stu-id="9c872-114">There are two safety levels: FULL and OFF.</span></span>  
  
 <span data-ttu-id="9c872-115">见证</span><span class="sxs-lookup"><span data-stu-id="9c872-115">Witness</span></span>  
 <span data-ttu-id="9c872-116">仅用于高安全性模式，SQL Server 的一个可选实例，它能使镜像服务器识别是否要启动自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-116">For use only with high-safety mode, an optional instance of SQL Server that enables the mirror server to recognize whether to initiate an automatic failover.</span></span> <span data-ttu-id="9c872-117">与这两个故障转移伙伴不同的是，见证服务器并不能用于数据库。</span><span class="sxs-lookup"><span data-stu-id="9c872-117">Unlike the two failover partners, the witness does not serve the database.</span></span> <span data-ttu-id="9c872-118">见证服务器的唯一角色是支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-118">Supporting automatic failover is the only role of the witness.</span></span>  
  
##  <a name="asynchronous-database-mirroring-high-performance-mode"></a><a name="VisualElement"></a><span data-ttu-id="9c872-119">异步数据库镜像 (高性能模式) </span><span class="sxs-lookup"><span data-stu-id="9c872-119">Asynchronous Database Mirroring (High-Performance Mode)</span></span>  
 <span data-ttu-id="9c872-120">此节介绍异步数据库镜像的工作原理，何时适合使用高性能模式以及在主体服务器发生故障时如何响应。</span><span class="sxs-lookup"><span data-stu-id="9c872-120">This section describes how asynchronous database mirroring works, when it is appropriate to use high-performance mode, and how to respond if the principal server fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9c872-121">大多数 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] 版本仅支持同步数据库镜像（“仅支持‘完全’安全级别”）。</span><span class="sxs-lookup"><span data-stu-id="9c872-121">Most editions of [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] support only synchronous database mirroring ("Safety Full Only").</span></span> <span data-ttu-id="9c872-122">有关完全支持数据库镜像的版本的信息，请参阅[SQL Server 2014 各个版本支持的功能](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md)中的 "高可用性 (AlwaysOn) "。</span><span class="sxs-lookup"><span data-stu-id="9c872-122">For information about editions that fully support database mirroring, see "High Availability (AlwaysOn)" in [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="9c872-123">将事务安全设置为 OFF 时，数据库镜像会话便会异步运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-123">When transaction safety is set to OFF, the database mirroring session operates asynchronously.</span></span> <span data-ttu-id="9c872-124">异步操作仅支持一种操作模式，即高性能模式。</span><span class="sxs-lookup"><span data-stu-id="9c872-124">Asynchronous operation supports only one operating mode-high-performance mode.</span></span> <span data-ttu-id="9c872-125">此模式可增强性能，但要牺牲高可用性。</span><span class="sxs-lookup"><span data-stu-id="9c872-125">This mode enhances performance at the expense of high availability.</span></span> <span data-ttu-id="9c872-126">高性能模式仅使用主体服务器和镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-126">High-performance mode uses just the principal server and the mirror server.</span></span> <span data-ttu-id="9c872-127">镜像服务器上出现的问题不会影响主体服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-127">Problems on the mirror server never impact the principal server.</span></span> <span data-ttu-id="9c872-128">在丢失主体服务器的情况下，镜像数据库将标记为 DISCONNECTED，但仍可以作为备用数据库。</span><span class="sxs-lookup"><span data-stu-id="9c872-128">On the loss of the principal server, the mirror database is marked DISCONNECTED but is available as a warm standby.</span></span>  
  
 <span data-ttu-id="9c872-129">高性能模式仅支持一种角色切换形式：强制服务（可能造成数据丢失），此服务使用镜像服务器作为备用服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-129">High-performance mode, supports only one form of role switching: forced service (with possible data loss), which uses the mirror server as a warm standby server.</span></span> <span data-ttu-id="9c872-130">强制服务是可能对主体服务器故障作出的响应之一。</span><span class="sxs-lookup"><span data-stu-id="9c872-130">Forced service is one of the possible responses to the failure of the principal server.</span></span> <span data-ttu-id="9c872-131">由于可能造成数据丢失，因此，应当在将服务强制到镜像之前考虑其他备选服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-131">Because data loss is possible, you should consider other alternatives before forcing service to the mirror.</span></span> <span data-ttu-id="9c872-132">有关详细信息，请参阅本主题后面的 [对主体服务器故障的响应](#WhenPrincipalFails)。</span><span class="sxs-lookup"><span data-stu-id="9c872-132">For more information, see [Responding to Failure of the Principal](#WhenPrincipalFails), later in this topic.</span></span>  
  
 <span data-ttu-id="9c872-133">下图显示了使用高性能模式的会话的配置。</span><span class="sxs-lookup"><span data-stu-id="9c872-133">The following figure shows the configuration of a session using high-performance mode.</span></span>  
  
 <span data-ttu-id="9c872-134">![会话的仅合作伙伴配置](../media/dbm-high-performance-mode.gif "会话的仅合作伙伴配置")</span><span class="sxs-lookup"><span data-stu-id="9c872-134">![Partner-only configuration of a session](../media/dbm-high-performance-mode.gif "Partner-only configuration of a session")</span></span>  
  
 <span data-ttu-id="9c872-135">在高性能模式下，主体服务器向镜像服务器发送事务日志之后，就立即向客户端发送确认，而不会等待镜像服务器的确认。</span><span class="sxs-lookup"><span data-stu-id="9c872-135">In high-performance mode, as soon as the principal server sends the log for a transaction to the mirror server, the principal server sends a confirmation to the client, without waiting for an acknowledgement from the mirror server.</span></span> <span data-ttu-id="9c872-136">事务不等待镜像服务器将日志写入磁盘便提交。</span><span class="sxs-lookup"><span data-stu-id="9c872-136">Transactions commit without waiting for the mirror server to write the log to disk.</span></span> <span data-ttu-id="9c872-137">异步操作允许主体服务器的运行有一段最短事务滞后时间。</span><span class="sxs-lookup"><span data-stu-id="9c872-137">Asynchronous operation permits the principal server to run with minimum transaction latency.</span></span>  
  
 <span data-ttu-id="9c872-138">镜像服务器尝试与主体服务器发送的日志记录保持同步。</span><span class="sxs-lookup"><span data-stu-id="9c872-138">The mirror server attempts to keep up with the log records sent by the principal server.</span></span> <span data-ttu-id="9c872-139">但是镜像数据库可能在某种程度上滞后于主体数据库，尽管这两个数据库之间的时间间隔通常很小。</span><span class="sxs-lookup"><span data-stu-id="9c872-139">But the mirror database might lag somewhat behind the principal database, though typically the gap between the databases is small.</span></span> <span data-ttu-id="9c872-140">但是，如果主体服务器的工作负荷过高或镜像服务器系统的负荷过高，则时间间隔会增大。</span><span class="sxs-lookup"><span data-stu-id="9c872-140">However, the gap can become substantial if the principal server is under a heavy work load or the system of the mirror server is over loaded.</span></span>  
  
 
  
###  <a name="when-is-high-performance-mode-appropriate"></a><a name="WhenUseHighPerf"></a> <span data-ttu-id="9c872-141">何时适合使用高性能模式？</span><span class="sxs-lookup"><span data-stu-id="9c872-141">When Is High-Performance Mode Appropriate?</span></span>  
 <span data-ttu-id="9c872-142">高性能模式在灾难恢复方案中非常有用，在这种方案中，主体服务器和镜像服务器之间的距离非常大，并且您不希望小错误影响主体服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-142">High-performance mode can be useful in a disaster-recovery scenario in which the principal and mirror servers are separated by a significant distance and where you do not want small errors to impact the principal server.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9c872-143">日志传送可以作为数据库镜像的补充，最好用其替代异步数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="9c872-143">Log shipping can be a supplement to database mirroring and is a favorable alternative to asynchronous database mirroring.</span></span> <span data-ttu-id="9c872-144">有关日志传送优点的信息，请参阅[高可用性解决方案 (SQL Server)](../../sql-server/failover-clusters/high-availability-solutions-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-144">For information about the advantages of log shipping, see [High Availability Solutions &#40;SQL Server&#41;](../../sql-server/failover-clusters/high-availability-solutions-sql-server.md).</span></span> <span data-ttu-id="9c872-145">有关配合使用日志传送和数据库镜像的信息，请参阅[数据库镜像和日志传送 (SQL Server)](database-mirroring-and-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-145">For information on using log shipping with database mirroring, see [Database Mirroring and Log Shipping &#40;SQL Server&#41;](database-mirroring-and-log-shipping-sql-server.md).</span></span>  
  
###  <a name="the-impact-of-a-witness-on-high-performance-mode"></a><a name="WitnessImpactOnHighPerf"></a> <span data-ttu-id="9c872-146">见证服务器对高性能模式的影响</span><span class="sxs-lookup"><span data-stu-id="9c872-146">The Impact of a Witness on High-Performance Mode</span></span>  
 <span data-ttu-id="9c872-147">如果使用 Transact-SQL 配置高性能模式，则当 SAFETY 属性设置为 OFF 时，我们极力建议也将 WITNESS 属性设置为 OFF。</span><span class="sxs-lookup"><span data-stu-id="9c872-147">If you use Transact-SQL to configure high-performance mode, whenever the SAFETY property is set to OFF, we strongly recommend that the WITNESS property also be set to OFF.</span></span> <span data-ttu-id="9c872-148">见证服务器可以与高性能模式共存，但是见证服务器没有优点并可导致风险。</span><span class="sxs-lookup"><span data-stu-id="9c872-148">A witness can coexist with high-performance mode, but the witness provides no benefit and introduces risk.</span></span>  
  
 <span data-ttu-id="9c872-149">当其中任何一个伙伴出现故障而导致见证服务器与会话断开连接时，数据库便无法使用。</span><span class="sxs-lookup"><span data-stu-id="9c872-149">If the witness is disconnected from the session when either partner goes down, the database becomes unavailable.</span></span> <span data-ttu-id="9c872-150">这是因为，尽管高性能模式不需要见证服务器，但如果设置了见证服务器，则会话便需要由两个或多个服务器实例组成的仲裁。</span><span class="sxs-lookup"><span data-stu-id="9c872-150">This is because, even though high-performance mode does not require a witness, if one is set, the session requires a quorum consisting of two or more server instances.</span></span> <span data-ttu-id="9c872-151">如果会话将仲裁丢失，则不能为数据库服务。</span><span class="sxs-lookup"><span data-stu-id="9c872-151">If the session losses quorum, it cannot serve the database.</span></span>  
  
 <span data-ttu-id="9c872-152">在高性能模式会话中设置了见证服务器后，仲裁的实施便意味着：</span><span class="sxs-lookup"><span data-stu-id="9c872-152">When a witness is set in a high-performance mode session, the enforcement of quorum means that:</span></span>  
  
-   <span data-ttu-id="9c872-153">如果镜像服务器丢失，则主体服务器必须连接到见证服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-153">If the mirror server is lost, the principal server must be connected to the witness.</span></span> <span data-ttu-id="9c872-154">否则，主体服务器将使其数据库脱机，直到见证服务器或镜像服务器重新加入会话。</span><span class="sxs-lookup"><span data-stu-id="9c872-154">Otherwise, the principal server takes its database offline until either the witness or mirror server rejoins the session.</span></span>  
  
-   <span data-ttu-id="9c872-155">如果主体服务器丢失，则强制服务到镜像服务器时需要将镜像服务器连接到见证服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-155">If the principal server is lost, forcing service to the mirror server requires that the mirror server be connected to the witness.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9c872-156">有关仲裁类型的信息，请参阅[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-156">For information about the types of quorums, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
###  <a name="responding-to-failure-of-the-principal"></a><a name="WhenPrincipalFails"></a> <span data-ttu-id="9c872-157">对主体服务器故障的响应</span><span class="sxs-lookup"><span data-stu-id="9c872-157">Responding to Failure of the Principal</span></span>  
 <span data-ttu-id="9c872-158">当主体服务器出现故障时，数据库所有者有多种选择，如下所示：</span><span class="sxs-lookup"><span data-stu-id="9c872-158">When the principal fails, the database owner has several choices, as follows:</span></span>  
  
-   <span data-ttu-id="9c872-159">使数据库不可用，直到主体服务器再次变为可用。</span><span class="sxs-lookup"><span data-stu-id="9c872-159">Leave the database unavailable until the principal becomes available again.</span></span>  
  
     <span data-ttu-id="9c872-160">如果主体数据库及其事务日志保持不变，此选择将保留所有已提交的事务，但会牺牲可用性。</span><span class="sxs-lookup"><span data-stu-id="9c872-160">If the principal database and its transaction log are intact, this choice preserves all of the committed transactions at the expense of availability.</span></span>  
  
-   <span data-ttu-id="9c872-161">停止数据库镜像会话，手动更新数据库，然后开始新的数据库镜像会话。</span><span class="sxs-lookup"><span data-stu-id="9c872-161">Stop the database mirroring session, manually update the database, and then begin a new database mirroring session.</span></span>  
  
     <span data-ttu-id="9c872-162">如果主体数据库丢失但主体服务器仍在运行，它将立即尝试备份主体数据库的日志尾部。</span><span class="sxs-lookup"><span data-stu-id="9c872-162">If the principal database is lost but the principal server is still running, immediately attempt to back up the tail of the log on the principal database.</span></span> <span data-ttu-id="9c872-163">如果结尾日志备份成功，则删除镜像可能是最佳选择。</span><span class="sxs-lookup"><span data-stu-id="9c872-163">If the tail-log backup succeeds, removing mirroring may be your best alternative.</span></span> <span data-ttu-id="9c872-164">删除镜像后，可以将日志还原到以前的镜像数据库中，从而保留所有数据。</span><span class="sxs-lookup"><span data-stu-id="9c872-164">After removing mirroring, you can restore the log onto the former mirror database, which preserves all of the data.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="9c872-165">如果结尾日志备份失败并且无法等待主体服务器恢复，则请考虑强制服务，这样做的好处是可以保持会话状态。</span><span class="sxs-lookup"><span data-stu-id="9c872-165">If the tail-log backup failed and you cannot wait for the principal server to recover, consider forcing service, which has the advantage of maintaining the session state.</span></span>  
  
-   <span data-ttu-id="9c872-166">在镜像服务器上进行强制服务（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="9c872-166">Force service (with possible data loss) on the mirror server.</span></span>  
  
     <span data-ttu-id="9c872-167">严格讲来，强制服务是一种灾难恢复方法，应尽量少使用此方法。</span><span class="sxs-lookup"><span data-stu-id="9c872-167">Forced service is strictly a disaster recovery method and should be used sparingly.</span></span> <span data-ttu-id="9c872-168">只有当主体服务器关闭，会话为异步会话（事务安全设置为 OFF），并且再满足会话不包含任何见证服务器（WITNESS 属性设置为 OFF）或见证服务器连接到镜像服务器（就是它们包含仲裁）这两个条件中的一个时，便可使用强制服务。</span><span class="sxs-lookup"><span data-stu-id="9c872-168">Forcing service is possible only if the principal server is down, the session is asynchronous (transaction safety is set to OFF), and either the session does not have any witness (the WITNESS property is set to OFF) or the witness is connected to the mirror server (that is, they have quorum).</span></span>  
  
     <span data-ttu-id="9c872-169">强制服务会导致镜像服务器成为主体角色，并将其数据库的副本提供给客户端。</span><span class="sxs-lookup"><span data-stu-id="9c872-169">Forcing service causes the mirror server to assume the role of principal and serve its copy of the database for clients.</span></span> <span data-ttu-id="9c872-170">进行强制服务后，主体服务器未发送至镜像服务器的所有事务日志都将丢失。</span><span class="sxs-lookup"><span data-stu-id="9c872-170">When service is forced, whatever transaction logs the principal has not yet sent to the mirror server are lost.</span></span> <span data-ttu-id="9c872-171">因此，您应将强制服务的使用限制在以下两种情况：可以接受可能造成的数据丢失以及立即使用数据库对您很重要。</span><span class="sxs-lookup"><span data-stu-id="9c872-171">Therefore, you should limit forced service to situations where possible data loss is acceptable and immediate database availability is critical.</span></span> <span data-ttu-id="9c872-172">有关强制服务工作原理及最佳使用方法的信息，请参阅[数据库镜像会话期间的角色切换 (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-172">For information on how forced service works and on best practices for using it, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
##  <a name="synchronous-database-mirroring-high-safety-mode"></a><a name="Sync"></a> <span data-ttu-id="9c872-173">同步数据库镜像（高安全性模式）</span><span class="sxs-lookup"><span data-stu-id="9c872-173">Synchronous Database Mirroring (High-Safety Mode)</span></span>  
 <span data-ttu-id="9c872-174">此节介绍了同步数据库镜像的工作原理，包括替代高安全性模式（带自动故障转移和不带自动故障转移）在内，并且包含有关自动故障转移中见证服务器的角色的信息。</span><span class="sxs-lookup"><span data-stu-id="9c872-174">This section describes how synchronous database mirroring works, including the alternative high-safety modes (with automatic failover and without automatic failover), and contains information about the role of the witness in automatic failover.</span></span>  
  
 <span data-ttu-id="9c872-175">当事务安全设置为 FULL 时，数据库镜像会话便会在初始同步阶段后以高安全性模式同步运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-175">When transaction safety is set to FULL, the database mirroring session runs in high-safety mode and operates synchronously after an initial synchronizing phase.</span></span> <span data-ttu-id="9c872-176">此节介绍了为同步操作配置的数据库镜像会话的详细信息。</span><span class="sxs-lookup"><span data-stu-id="9c872-176">This section describes the details of database mirroring sessions that are configured for synchronous operation.</span></span>  
  
 <span data-ttu-id="9c872-177">若要实现会话的同步操作，镜像服务器必须将镜像数据库与主体数据库同步。</span><span class="sxs-lookup"><span data-stu-id="9c872-177">To achieve synchronous operation for a session, the mirror server must synchronize the mirror database with the principal database.</span></span> <span data-ttu-id="9c872-178">会话开始时，主体服务器开始将其活动日志发送到镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-178">When the session begins, the principal server begins sending its active log to the mirror server.</span></span> <span data-ttu-id="9c872-179">镜像服务器将所有传入日志记录尽快写入磁盘。</span><span class="sxs-lookup"><span data-stu-id="9c872-179">The mirror server writes all of the incoming log records to disk as quickly as possible.</span></span> <span data-ttu-id="9c872-180">当所有接收到的日志记录写入磁盘后，数据库便会立即进行同步。</span><span class="sxs-lookup"><span data-stu-id="9c872-180">As soon as all of the received log records have been written to disk, the databases are synchronized.</span></span> <span data-ttu-id="9c872-181">只要伙伴保持通信，数据库就保持同步状态。</span><span class="sxs-lookup"><span data-stu-id="9c872-181">As long as the partners remain in communication, the databases remain synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9c872-182">若要监视数据库镜像会话中的状态更改，请使用 **Database Mirroring State Change** 事件类。</span><span class="sxs-lookup"><span data-stu-id="9c872-182">To monitor state changes in a database mirroring session, use the **Database Mirroring State Change** event class.</span></span> <span data-ttu-id="9c872-183">有关详细信息，请参阅 [Database Mirroring State Change Event Class](../../relational-databases/event-classes/database-mirroring-state-change-event-class.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-183">For more information, see [Database Mirroring State Change Event Class](../../relational-databases/event-classes/database-mirroring-state-change-event-class.md).</span></span>  
  
 <span data-ttu-id="9c872-184">同步结束后，在主体数据库中提交的每个事务也在镜像服务器上提交，因此确保数据受到保护。</span><span class="sxs-lookup"><span data-stu-id="9c872-184">After synchronization finishes, every transaction committed on the principal database is also committed on the mirror server, guaranteeing protection of the data.</span></span> <span data-ttu-id="9c872-185">其实现方法是等待在主体数据库中提交事务，直到主体服务器收到来自镜像服务器的消息：镜像服务器已将事务的日志镜像到磁盘。</span><span class="sxs-lookup"><span data-stu-id="9c872-185">This is achieved by waiting to commit a transaction on the principal database, until the principal server receives a message from the mirror server stating that it has hardened the transaction's log to disk.</span></span> <span data-ttu-id="9c872-186">注意，等待此消息会增加事务的滞后时间。</span><span class="sxs-lookup"><span data-stu-id="9c872-186">Note the wait for this message increases the latency of the transaction.</span></span>  
  
 <span data-ttu-id="9c872-187">同步所需的时间实质上取决于会话开始时镜像数据库滞后于主体数据库的时间（按最初从主体服务器收到的日志记录数计量）、主体数据库的工作负荷和镜像系统的速度。</span><span class="sxs-lookup"><span data-stu-id="9c872-187">The time required for synchronization depends essentially on how far the mirror database was behind the principal database at the start of the session (measured by the number of log records initially received from the principal server), the work load on the principal database, and the speed of the mirror system.</span></span> <span data-ttu-id="9c872-188">在会话同步后，镜像数据库中尚未重做的镜像日志仍处于重做队列中。</span><span class="sxs-lookup"><span data-stu-id="9c872-188">After a session is synchronized, the hardened log that has yet to be redone on the mirror database remains in the redo queue.</span></span>  
  
 <span data-ttu-id="9c872-189">镜像数据库同步后，两个数据库副本的状态将立即改为 SYNCHRONIZED。</span><span class="sxs-lookup"><span data-stu-id="9c872-189">As soon as the mirror database becomes synchronized, the state of both the copies of the database changes to SYNCHRONIZED.</span></span>  
  
 <span data-ttu-id="9c872-190">同步操作按下列方式维护：</span><span class="sxs-lookup"><span data-stu-id="9c872-190">Synchronous operation is maintained in the following manner:</span></span>  
  
1.  <span data-ttu-id="9c872-191">从客户端收到事务时，主体服务器将事务的日志写入事务日志中。</span><span class="sxs-lookup"><span data-stu-id="9c872-191">On receiving a transaction from a client, the principal server writes the log for the transaction to the transaction log.</span></span>  
  
2.  <span data-ttu-id="9c872-192">主体服务器将事务写入数据库中，同时将日志记录发送到镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-192">The principal server writes the transaction to the database and, concurrently, sends the log record to the mirror server.</span></span> <span data-ttu-id="9c872-193">主体服务器等待来自镜像服务器的确认，然后向客户端发送下列任一确认消息：事务提交或回滚。</span><span class="sxs-lookup"><span data-stu-id="9c872-193">The principal server waits for an acknowledgement from the mirror server before confirming either of the following to the client: a transaction commit or a rollback.</span></span>  
  
3.  <span data-ttu-id="9c872-194">镜像服务器将日志镜像到磁盘并向主体服务器返回确认。</span><span class="sxs-lookup"><span data-stu-id="9c872-194">The mirror server hardens the log to disk and returns an acknowledgement to the principal server.</span></span>  
  
4.  <span data-ttu-id="9c872-195">收到来自镜像服务器的确认时，主体服务器将向客户端发送一条确认消息。</span><span class="sxs-lookup"><span data-stu-id="9c872-195">On receiving the acknowledgement from the mirror server, the principal server sends a confirmation message to the client.</span></span>  
  
 <span data-ttu-id="9c872-196">高安全性模式通过要求数据在两个位置间保持同步来保护数据。</span><span class="sxs-lookup"><span data-stu-id="9c872-196">High-safety mode protects your data by requiring the data to be synchronized between two places.</span></span> <span data-ttu-id="9c872-197">所有提交的事务都保证写入镜像服务器的磁盘上。</span><span class="sxs-lookup"><span data-stu-id="9c872-197">All the committed transactions are guaranteed to be written to disk on the mirror server.</span></span>  
  

  
###  <a name="high-safety-mode-without-automatic-failover"></a><a name="HighSafetyWithOutAutoFailover"></a> <span data-ttu-id="9c872-198">不带自动故障转移的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="9c872-198">High-Safety Mode Without Automatic Failover</span></span>  
 <span data-ttu-id="9c872-199">下图显示了不带自动故障转移的高安全性模式的配置。</span><span class="sxs-lookup"><span data-stu-id="9c872-199">The following figure shows the configuration of high-safety mode without automatic failover.</span></span> <span data-ttu-id="9c872-200">配置仅包括两个伙伴。</span><span class="sxs-lookup"><span data-stu-id="9c872-200">The configuration consists of only the two partners.</span></span>  
  
 <span data-ttu-id="9c872-201">![不使用见证服务器的合作伙伴通信](../media/dbm-high-protection-mode.gif "不使用见证服务器的合作伙伴通信")</span><span class="sxs-lookup"><span data-stu-id="9c872-201">![Partners communicating without a witness](../media/dbm-high-protection-mode.gif "Partners communicating without a witness")</span></span>  
  
 <span data-ttu-id="9c872-202">当伙伴连接在一起并且数据库已同步时，支持手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-202">When the partners are connected and the database is already synchronized, manual failover is supported.</span></span> <span data-ttu-id="9c872-203">如果镜像服务器实例出现故障，则主体服务器实例不会受到影响并且公开运行（即，未镜像数据）。</span><span class="sxs-lookup"><span data-stu-id="9c872-203">If the mirror server instance goes down, the principal server instance is unaffected and runs exposed (that is without mirroring the data).</span></span> <span data-ttu-id="9c872-204">如果主体服务器丢失，则镜像会挂起，但可以将服务强制到镜像服务器（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="9c872-204">If the principal server is lost, the mirror is suspended, but service can be forced to the mirror server (with possible data loss).</span></span> <span data-ttu-id="9c872-205">有关详细信息，请参阅 [数据库镜像会话期间的角色切换 (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md)的各版本中均未提供见证服务器实例。</span><span class="sxs-lookup"><span data-stu-id="9c872-205">For more information, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
###  <a name="high-safety-mode-with-automatic-failover"></a><a name="HighSafetyWithAutoFailover"></a> <span data-ttu-id="9c872-206">具有自动故障转移的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="9c872-206">High-Safety Mode with Automatic Failover</span></span>  
 <span data-ttu-id="9c872-207">自动故障转移通过确保在丢失一个服务器之后仍向数据库提供服务来提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="9c872-207">Automatic failover provides high availability by ensuring that the database is still served after the loss of one server.</span></span> <span data-ttu-id="9c872-208">自动故障转移要求会话具有第三个服务器实例（“见证服务器 ”），理想情况是见证服务器驻留在第三台计算机上。</span><span class="sxs-lookup"><span data-stu-id="9c872-208">Automatic failover requires that the session possess a third server instance, the *witness*, which ideally resides on a third computer.</span></span> <span data-ttu-id="9c872-209">下图显示了支持自动故障转移的高安全性模式会话的配置。</span><span class="sxs-lookup"><span data-stu-id="9c872-209">The following figure shows the configuration of a high-safety mode session that supports automatic failover.</span></span>  
  
 <span data-ttu-id="9c872-210">![会话的见证服务器和合作伙伴双方](../media/dbm-high-availability-mode.gif "会话的见证服务器和合作伙伴双方")</span><span class="sxs-lookup"><span data-stu-id="9c872-210">![The witness and two partners of a session](../media/dbm-high-availability-mode.gif "The witness and two partners of a session")</span></span>  
  
 <span data-ttu-id="9c872-211">与这两个伙伴不同的是，见证服务器并不能用于数据库。</span><span class="sxs-lookup"><span data-stu-id="9c872-211">Unlike the two partners, the witness does not serve the database.</span></span> <span data-ttu-id="9c872-212">见证服务器通过验证主体服务器是否已启用并运行来仅支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-212">The witness simply supports automatic failover by verifying whether the principal server is up and functioning.</span></span> <span data-ttu-id="9c872-213">只有在镜像服务器和见证服务器与主体服务器断开连接之后而保持相互连接时，镜像服务器才启动自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-213">The mirror server initiates automatic failover only if the mirror and the witness remain connected to each other after both have been disconnected from the principal server.</span></span>  
  
 <span data-ttu-id="9c872-214">设置见证服务器时，会话需要“仲裁”（允许数据库可用的至少两个服务器实例之间的关系）。</span><span class="sxs-lookup"><span data-stu-id="9c872-214">When a witness is set, the session requires *quorum*-a relationship between at least two server instances that allows the database to be made available.</span></span> <span data-ttu-id="9c872-215">有关详细信息，请参阅[数据库镜像见证服务器](database-mirroring-witness.md)和[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-215">For more information, see [Database Mirroring Witness](database-mirroring-witness.md) and [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
 <span data-ttu-id="9c872-216">自动故障转移需要下列条件：</span><span class="sxs-lookup"><span data-stu-id="9c872-216">Automatic failover requires the following conditions:</span></span>  
  
-   <span data-ttu-id="9c872-217">数据库已同步。</span><span class="sxs-lookup"><span data-stu-id="9c872-217">The database is already synchronized.</span></span>  
  
-   <span data-ttu-id="9c872-218">发生故障时所有三个服务器实例均处于连接状态，并且见证服务器和镜像服务器保持连接状态。</span><span class="sxs-lookup"><span data-stu-id="9c872-218">The failure occurs while all three server instances are connected, and the witness and mirror server remain connected.</span></span>  
  
 <span data-ttu-id="9c872-219">丢失伙伴会产生以下影响：</span><span class="sxs-lookup"><span data-stu-id="9c872-219">The loss of a partner has the following effect:</span></span>  
  
-   <span data-ttu-id="9c872-220">如果主体服务器变得不可用，则在上述条件下将发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-220">If the principal server becomes unavailable under the above conditions, automatic failover occurs.</span></span> <span data-ttu-id="9c872-221">镜像服务器切换为主体角色，并提供其数据库作为主体数据库。</span><span class="sxs-lookup"><span data-stu-id="9c872-221">The mirror server switches to the role of principal, and it offers its database as the principal database.</span></span>  
  
-   <span data-ttu-id="9c872-222">如果主体服务器在这些条件不满足时变得不可用，则可能会强制服务（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="9c872-222">If the principal server becomes unavailable when those conditions are not met, forcing service (with possible data loss) might be possible.</span></span> <span data-ttu-id="9c872-223">有关详细信息，请参阅 [数据库镜像会话期间的角色切换 (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md)的各版本中均未提供见证服务器实例。</span><span class="sxs-lookup"><span data-stu-id="9c872-223">For more information, see [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md).</span></span>  
  
-   <span data-ttu-id="9c872-224">如果只有镜像服务器变得不可用，则主体服务器和见证服务器将继续运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-224">If the only mirror server becomes unavailable, the principal and witness continue.</span></span>  
  
 <span data-ttu-id="9c872-225">如果会话丢失见证服务器，则仲裁需要两个伙伴。</span><span class="sxs-lookup"><span data-stu-id="9c872-225">If the session loses its witness, quorum requires both partners.</span></span> <span data-ttu-id="9c872-226">如果任何一个伙伴失去仲裁，两个伙伴都将失去仲裁且在重新建立仲裁之前数据库将不可用。</span><span class="sxs-lookup"><span data-stu-id="9c872-226">If either partner loses quorum, both partners lose quorum, and the database becomes unavailable until quorum is re-established.</span></span> <span data-ttu-id="9c872-227">此仲裁要求确保没有见证服务器时数据库从不“公开” 运行，即从不执行数据镜像。</span><span class="sxs-lookup"><span data-stu-id="9c872-227">This quorum requirement makes sure that in the absence of a witness the database never runs *exposed*, that is without being mirrored.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="9c872-228">如果您希望见证服务器在很长一段时间内保持断开，则我们建议您在见证服务器变为可用之前将其从会话中删除。</span><span class="sxs-lookup"><span data-stu-id="9c872-228">If you expect the witness to remain disconnected for a significant amount of time, we recommend that you remove the witness from the session until it becomes available.</span></span>  
  
##  <a name="transact-sql-settings-and-database-mirroring-operating-modes"></a><a name="TsqlSettingsAndOpModes"></a> <span data-ttu-id="9c872-229">Transact-SQL 设置和数据库镜像运行模式</span><span class="sxs-lookup"><span data-stu-id="9c872-229">Transact-SQL Settings and Database Mirroring Operating Modes</span></span>  
 <span data-ttu-id="9c872-230">此节从 ALTER DATABASE 设置和镜像数据库状态以及见证服务器（如果有）状态的角度介绍数据库镜像会话。</span><span class="sxs-lookup"><span data-stu-id="9c872-230">This section describes a database mirroring session in terms of the ALTER DATABASE settings and states of the mirrored database and witness, if any.</span></span> <span data-ttu-id="9c872-231">它针对主要或专门使用 [!INCLUDE[tsql](../../includes/tsql-md.md)]（而不是使用 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]）管理数据库镜像的用户。</span><span class="sxs-lookup"><span data-stu-id="9c872-231">The section is aimed at users who manage database mirroring primarily or exclusively using [!INCLUDE[tsql](../../includes/tsql-md.md)], rather than using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="9c872-232">除了可以使用 [!INCLUDE[tsql](../../includes/tsql-md.md)]以外，还可以使用 **“数据库属性”** 对话框的 **“镜像”** 页在对象资源管理器中控制会话的运行模式。</span><span class="sxs-lookup"><span data-stu-id="9c872-232">As an alternative to using [!INCLUDE[tsql](../../includes/tsql-md.md)], you can control the operating mode of a session in Object Explorer using the **Mirroring** page of the **Database Properties** dialog box.</span></span> <span data-ttu-id="9c872-233">有关详细信息，请参阅本主题后面的 [使用 Windows 身份验证建立数据库镜像会话 (SQL Server Management Studio)](establish-database-mirroring-session-windows-authentication.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-233">For more information, see [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md).</span></span>  
  

  
###  <a name="how-transaction-safety-and-witness-state-affect-the-operating-mode"></a><a name="TxnSafetyAndWitness"></a> <span data-ttu-id="9c872-234">事务安全设置和见证服务器状态如何影响运行模式</span><span class="sxs-lookup"><span data-stu-id="9c872-234">How Transaction Safety and Witness State Affect the Operating Mode</span></span>  
 <span data-ttu-id="9c872-235">会话的运行模式由会话的事务安全设置和见证服务器状态这二者决定。</span><span class="sxs-lookup"><span data-stu-id="9c872-235">The operating mode of a session is determined by the combination of its transaction safety setting and the state of the witness.</span></span> <span data-ttu-id="9c872-236">数据库所有者可随时更改事务安全级别，并可添加或删除见证服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-236">At any time, the database owner can change the transaction safety level, and can add or remove the witness.</span></span>  
  

  
####  <a name="transaction-safety"></a><a name="TxnSafety"></a> <span data-ttu-id="9c872-237">Transaction Safety</span><span class="sxs-lookup"><span data-stu-id="9c872-237">Transaction Safety</span></span>  
 <span data-ttu-id="9c872-238">事务安全是镜像特定的数据库属性，用于确定数据库镜像会话是同步运行还是异步运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-238">Transaction safety is a mirroring-specific database property that determines whether a database mirroring session operates synchronously or asynchronously.</span></span> <span data-ttu-id="9c872-239">有两种安全级别：FULL 和 OFF。</span><span class="sxs-lookup"><span data-stu-id="9c872-239">There are two safety levels: FULL and OFF.</span></span>  
  
-   <span data-ttu-id="9c872-240">SAFETY FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-240">SAFETY FULL</span></span>  
  
     <span data-ttu-id="9c872-241">完整事务安全可使会话在高安全性模式下同步运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-241">Full transaction safety causes the session to operate synchronously in high-safety mode.</span></span> <span data-ttu-id="9c872-242">如果存在见证服务器，则会话支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-242">If a witness is present, a session supports automatic failover.</span></span>  
  
     <span data-ttu-id="9c872-243">使用 ALTER DATABASE 语句建立会话时，会话将在 SAFETY 属性设置为 FULL 的情况下开始；即会话将在高安全性模式下开始。</span><span class="sxs-lookup"><span data-stu-id="9c872-243">When you establish a session using ALTER DATABASE statements, the session begins with the SAFETY property set to FULL; that is, the session begins in high-safety mode.</span></span> <span data-ttu-id="9c872-244">会话开始之后，便可添加见证服务器。</span><span class="sxs-lookup"><span data-stu-id="9c872-244">After the session begins, you can add a witness.</span></span>  
  
     <span data-ttu-id="9c872-245">有关详细信息，请参阅本主题前面的 [同步数据库镜像（高安全性模式）](#Sync)。</span><span class="sxs-lookup"><span data-stu-id="9c872-245">For more information, see [Synchronous Database Mirroring (High-Safety Mode)](#Sync), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="9c872-246">SAFETY OFF</span><span class="sxs-lookup"><span data-stu-id="9c872-246">SAFETY OFF</span></span>  
  
     <span data-ttu-id="9c872-247">关闭事务安全可使会话在异步高性能模式下运行。</span><span class="sxs-lookup"><span data-stu-id="9c872-247">Turning off transaction safety causes the session to operate asynchronously, in high-performance mode.</span></span> <span data-ttu-id="9c872-248">如果 SAFETY 属性设置为 OFF，则 WITNESS 属性也应该设置为 OFF（默认值）。</span><span class="sxs-lookup"><span data-stu-id="9c872-248">If the SAFETY property is set to OFF, the WITNESS property should also be set to OFF (the default).</span></span> <span data-ttu-id="9c872-249">有关高性能模式下见证服务器的影响的信息，请参阅本主题后面的 [见证服务器状态](#WitnessState)。</span><span class="sxs-lookup"><span data-stu-id="9c872-249">For information about the impact of the witness in high-performance mode, see [The State of the Witness](#WitnessState), later in this topic.</span></span> <span data-ttu-id="9c872-250">有关在关闭事务安全性的情况下运行的详细信息，请参阅本主题前面的 [异步数据库镜像（高性能模式）](#VisualElement)。</span><span class="sxs-lookup"><span data-stu-id="9c872-250">For more information about running with transaction safety turned off, see [Asynchronous Database Mirroring (High-Performance Mode)](#VisualElement), earlier in this topic.</span></span>  
  
 <span data-ttu-id="9c872-251">数据库的事务安全性设置记录在每个伙伴的 **sys.database_mirroring** 目录视图中的 **mirroring_safety_level** 和 **mirroring_safety_level_desc** 列内。</span><span class="sxs-lookup"><span data-stu-id="9c872-251">The transaction safety setting of the database is recorded on each partner in the **sys.database_mirroring** catalog view in the **mirroring_safety_level** and **mirroring_safety_level_desc** columns.</span></span> <span data-ttu-id="9c872-252">有关详细信息，请参阅 [sys.database_mirroring (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="9c872-252">For more information, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
 <span data-ttu-id="9c872-253">数据库所有者可以随时更改事务安全级别。</span><span class="sxs-lookup"><span data-stu-id="9c872-253">The database owner can change the transaction safety level at any time.</span></span>  
  
####  <a name="the-state-of-the-witness"></a><a name="WitnessState"></a> <span data-ttu-id="9c872-254">见证服务器状态</span><span class="sxs-lookup"><span data-stu-id="9c872-254">The State of the Witness</span></span>  
 <span data-ttu-id="9c872-255">如果已设置了见证服务器，则需要仲裁，因此见证服务器状态始终很重要。</span><span class="sxs-lookup"><span data-stu-id="9c872-255">If a witness has been set, quorum is required, so the state of the witness is always significant.</span></span>  
  
 <span data-ttu-id="9c872-256">如果见证服务器存在，则会具有以下两种状态之一：</span><span class="sxs-lookup"><span data-stu-id="9c872-256">If it exists, the witness has one of two states:</span></span>  
  
-   <span data-ttu-id="9c872-257">当见证服务器连接到伙伴时，见证服务器相对于该伙伴处于 CONNECTED 状态，并且和该伙伴具有仲裁。</span><span class="sxs-lookup"><span data-stu-id="9c872-257">When the witness is connected to a partner, the witness is in the CONNECTED state relative to that partner and has quorum with that partner.</span></span> <span data-ttu-id="9c872-258">在此情况下，即使有一个伙伴不可用，也可以使用数据库。</span><span class="sxs-lookup"><span data-stu-id="9c872-258">In this case, the database can be made available, even if one of the partners is unavailable.</span></span>  
  
-   <span data-ttu-id="9c872-259">如果见证服务器存在，但是未连接到伙伴，则见证服务器相对于该伙伴处于 UNKOWN 或 DISCONNECTED 状态。</span><span class="sxs-lookup"><span data-stu-id="9c872-259">When the witness exists but is not connected to a partner, the witness is in the UNKOWN or DISCONNECTED state relative to that partner.</span></span> <span data-ttu-id="9c872-260">在此情况下，见证服务器和该伙伴缺少仲裁，并且如果伙伴双方未彼此连接，则数据库不可用。</span><span class="sxs-lookup"><span data-stu-id="9c872-260">In this case, the witness lacks quorum with that partner, and if the partners are not connected to each other, the database becomes unavailable.</span></span>  
  
 <span data-ttu-id="9c872-261">有关仲裁的信息，请参阅[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-261">For information about quorum, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
 <span data-ttu-id="9c872-262">服务器实例上每个见证服务器的状态都记录在 **sys.database_mirroring** 目录视图中的 **mirroring_witness_state** 和 **mirroring_witness_state_desc** 列中。</span><span class="sxs-lookup"><span data-stu-id="9c872-262">The state of each witness on a server instance is recorded in the **sys.database_mirroring** catalog view in the **mirroring_witness_state** and **mirroring_witness_state_desc** columns.</span></span> <span data-ttu-id="9c872-263">有关详细信息，请参阅 [sys.database_mirroring (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="9c872-263">For more information, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
 <span data-ttu-id="9c872-264">下表总结了会话的事务安全设置和见证服务器的状态是如何决定会话运行模式的。</span><span class="sxs-lookup"><span data-stu-id="9c872-264">The following table summarizes how the operating mode of a session depends upon its transaction safety setting and on state of the witness.</span></span>  
  
|<span data-ttu-id="9c872-265">运行模式</span><span class="sxs-lookup"><span data-stu-id="9c872-265">Operating mode</span></span>|<span data-ttu-id="9c872-266">事务安全</span><span class="sxs-lookup"><span data-stu-id="9c872-266">Transaction safety</span></span>|<span data-ttu-id="9c872-267">见证服务器状态</span><span class="sxs-lookup"><span data-stu-id="9c872-267">Witness state</span></span>|  
|--------------------|------------------------|-------------------|  
|<span data-ttu-id="9c872-268">高性能模式</span><span class="sxs-lookup"><span data-stu-id="9c872-268">High-performance mode</span></span>|<span data-ttu-id="9c872-269">OFF</span><span class="sxs-lookup"><span data-stu-id="9c872-269">OFF</span></span>|<span data-ttu-id="9c872-270">NULL (没有见证) <sup>2</sup></span><span class="sxs-lookup"><span data-stu-id="9c872-270">NULL (no witness)<sup>2</sup></span></span>|  
|<span data-ttu-id="9c872-271">不带自动故障转移的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="9c872-271">High-safety mode without automatic failover</span></span>|<span data-ttu-id="9c872-272">FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-272">FULL</span></span>|<span data-ttu-id="9c872-273">NULL（无见证服务器）</span><span class="sxs-lookup"><span data-stu-id="9c872-273">NULL (no witness)</span></span>|  
|<span data-ttu-id="9c872-274">具有自动故障转移的高安全性模式<sup>1</sup></span><span class="sxs-lookup"><span data-stu-id="9c872-274">High-safety mode with automatic failover<sup>1</sup></span></span>|<span data-ttu-id="9c872-275">FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-275">FULL</span></span>|<span data-ttu-id="9c872-276">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="9c872-276">CONNECTED</span></span>|  
  
 <span data-ttu-id="9c872-277"><sup>1</sup>如果见证服务器断开连接，则建议您将见证服务器设置为 OFF，直到见证服务器实例变为可用。</span><span class="sxs-lookup"><span data-stu-id="9c872-277"><sup>1</sup> If the witness becomes disconnected, we recommend that you set WITNESS OFF until the witness server instance becomes available.</span></span>  
  
 <span data-ttu-id="9c872-278"><sup>2</sup>如果见证服务器在高性能模式下出现，则见证服务器不会参与会话。</span><span class="sxs-lookup"><span data-stu-id="9c872-278"><sup>2</sup> If a witness is present in high-performance mode, the witness does not participate in the session.</span></span> <span data-ttu-id="9c872-279">但是，若要使数据库可用，必须至少有两个服务器实例保持连接。</span><span class="sxs-lookup"><span data-stu-id="9c872-279">However, to make the database available, at least two of the server instances must remain connected.</span></span> <span data-ttu-id="9c872-280">因此，建议您在高性能模式会话中，始终将 WITNESS 属性设置为 OFF。</span><span class="sxs-lookup"><span data-stu-id="9c872-280">Therefore, we recommend keeping the WITNESS property set to OFF in high-performance mode sessions.</span></span> <span data-ttu-id="9c872-281">有关详细信息，请参阅[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="9c872-281">For more information, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
###  <a name="viewing-the-safety-setting-and-state-of-the-witness"></a><a name="ViewWitness"></a> <span data-ttu-id="9c872-282">查看安全设置和见证服务器状态</span><span class="sxs-lookup"><span data-stu-id="9c872-282">Viewing the Safety Setting and State of the Witness</span></span>  
 <span data-ttu-id="9c872-283">若要针对数据库查看安全设置和见证服务器的状态，请使用 **sys.database_mirroring** 目录视图。</span><span class="sxs-lookup"><span data-stu-id="9c872-283">To view the safety setting and the state of the witness for a database, use the **sys.database_mirroring** catalog view.</span></span> <span data-ttu-id="9c872-284">相关列如下所示：</span><span class="sxs-lookup"><span data-stu-id="9c872-284">The relevant columns are as follows:</span></span>  
  
|<span data-ttu-id="9c872-285">因素</span><span class="sxs-lookup"><span data-stu-id="9c872-285">Factor</span></span>|<span data-ttu-id="9c872-286">列</span><span class="sxs-lookup"><span data-stu-id="9c872-286">Columns</span></span>|<span data-ttu-id="9c872-287">说明</span><span class="sxs-lookup"><span data-stu-id="9c872-287">Description</span></span>|  
|------------|-------------|-----------------|  
|<span data-ttu-id="9c872-288">事务安全</span><span class="sxs-lookup"><span data-stu-id="9c872-288">Transaction safety</span></span>|<span data-ttu-id="9c872-289">**mirroring_safety_level** 或 **mirroring_safety_level_desc**</span><span class="sxs-lookup"><span data-stu-id="9c872-289">**mirroring_safety_level** or **mirroring_safety_level_desc**</span></span>|<span data-ttu-id="9c872-290">镜像数据库上用于更新的事务安全设置，如下所示：</span><span class="sxs-lookup"><span data-stu-id="9c872-290">Transaction safety setting for updates on the mirror database, one of:</span></span><br /><br /> <span data-ttu-id="9c872-291">UNKNOWN</span><span class="sxs-lookup"><span data-stu-id="9c872-291">UNKNOWN</span></span><br /><br /> <span data-ttu-id="9c872-292">OFF</span><span class="sxs-lookup"><span data-stu-id="9c872-292">OFF</span></span><br /><br /> <span data-ttu-id="9c872-293">FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-293">FULL</span></span><br /><br /> <span data-ttu-id="9c872-294">NULL= 数据库没有在线。</span><span class="sxs-lookup"><span data-stu-id="9c872-294">NULL= database is not online.</span></span>|  
|<span data-ttu-id="9c872-295">是否存在见证服务器？</span><span class="sxs-lookup"><span data-stu-id="9c872-295">Does a witness exist?</span></span>|<span data-ttu-id="9c872-296">**mirroring_witness_name**</span><span class="sxs-lookup"><span data-stu-id="9c872-296">**mirroring_witness_name**</span></span>|<span data-ttu-id="9c872-297">数据库镜像见证服务器的名称或 NULL（指示不存在见证服务器）。</span><span class="sxs-lookup"><span data-stu-id="9c872-297">Server name of the database mirroring witness or NULL, indicating that no witness exists.</span></span>|  
|<span data-ttu-id="9c872-298">见证服务器状态</span><span class="sxs-lookup"><span data-stu-id="9c872-298">Witness state</span></span>|<span data-ttu-id="9c872-299">**mirroring_witness_state** 或 **mirroring_witness_state_desc**</span><span class="sxs-lookup"><span data-stu-id="9c872-299">**mirroring_witness_state** or **mirroring_witness_state_desc**</span></span>|<span data-ttu-id="9c872-300">给定伙伴上的数据库中的见证服务器状态：</span><span class="sxs-lookup"><span data-stu-id="9c872-300">State of the witness in the database on a given partner:</span></span><br /><br /> <span data-ttu-id="9c872-301">UNKNOWN</span><span class="sxs-lookup"><span data-stu-id="9c872-301">UNKNOWN</span></span><br /><br /> <span data-ttu-id="9c872-302">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="9c872-302">CONNECTED</span></span><br /><br /> <span data-ttu-id="9c872-303">DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="9c872-303">DISCONNECTED</span></span><br /><br /> <span data-ttu-id="9c872-304">NULL = 不存在见证服务器或数据库没有在线。</span><span class="sxs-lookup"><span data-stu-id="9c872-304">NULL = no witness exists or the database is not online.</span></span>|  
  
 <span data-ttu-id="9c872-305">例如，在主体服务器或镜像服务器上，输入：</span><span class="sxs-lookup"><span data-stu-id="9c872-305">For example, on either the principal or mirror server, enter:</span></span>  
  
```  
SELECT mirroring_safety_level_desc, mirroring_witness_name, mirroring_witness_state_desc FROM sys.database_mirroring  
```  
  
 <span data-ttu-id="9c872-306">有关此目录视图的详细信息，请参阅 [sys.database_mirroring (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="9c872-306">For more information about this catalog view, see [sys.database_mirroring &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-transact-sql).</span></span>  
  
###  <a name="factors-affecting-behavior-on-loss-of-the-principal-server"></a><a name="FactorsOnLossOfPrincipal"></a> <span data-ttu-id="9c872-307">丢失主体服务器时行为的影响因素</span><span class="sxs-lookup"><span data-stu-id="9c872-307">Factors Affecting Behavior on Loss of the Principal Server</span></span>  
 <span data-ttu-id="9c872-308">下表总结了丢失主体服务器时事务安全设置、数据库的状态以及见证服务器的状态对镜像会话行为的综合影响。</span><span class="sxs-lookup"><span data-stu-id="9c872-308">The following table summarizes the combined effect of the transaction safety setting, the state of the database, and the state of the witness on the behavior of a mirroring session on the loss of the principal server.</span></span>  
  
|<span data-ttu-id="9c872-309">事务安全</span><span class="sxs-lookup"><span data-stu-id="9c872-309">Transaction safety</span></span>|<span data-ttu-id="9c872-310">镜像数据库的镜像状态</span><span class="sxs-lookup"><span data-stu-id="9c872-310">Mirroring state of mirror database</span></span>|<span data-ttu-id="9c872-311">见证服务器状态</span><span class="sxs-lookup"><span data-stu-id="9c872-311">Witness state</span></span>|<span data-ttu-id="9c872-312">主体丢失时的行为</span><span class="sxs-lookup"><span data-stu-id="9c872-312">Behavior when principal is lost</span></span>|  
|------------------------|----------------------------------------|-------------------|-------------------------------------|  
|<span data-ttu-id="9c872-313">FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-313">FULL</span></span>|<span data-ttu-id="9c872-314">SYNCHRONIZED</span><span class="sxs-lookup"><span data-stu-id="9c872-314">SYNCHRONIZED</span></span>|<span data-ttu-id="9c872-315">CONNECTED</span><span class="sxs-lookup"><span data-stu-id="9c872-315">CONNECTED</span></span>|<span data-ttu-id="9c872-316">发生了自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="9c872-316">Automatic failover occurs.</span></span>|  
|<span data-ttu-id="9c872-317">FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-317">FULL</span></span>|<span data-ttu-id="9c872-318">SYNCHRONIZED</span><span class="sxs-lookup"><span data-stu-id="9c872-318">SYNCHRONIZED</span></span>|<span data-ttu-id="9c872-319">DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="9c872-319">DISCONNECTED</span></span>|<span data-ttu-id="9c872-320">镜像服务器将停止；无法进行故障转移，并且数据库不可用。</span><span class="sxs-lookup"><span data-stu-id="9c872-320">Mirror server stops; failover is not possible, and the database cannot be made available.</span></span>|  
|<span data-ttu-id="9c872-321">OFF</span><span class="sxs-lookup"><span data-stu-id="9c872-321">OFF</span></span>|<span data-ttu-id="9c872-322">SUSPENDED 或 DISCONNECTED</span><span class="sxs-lookup"><span data-stu-id="9c872-322">SUSPENDED or DISCONNECTED</span></span>|<span data-ttu-id="9c872-323">NULL（无见证服务器）</span><span class="sxs-lookup"><span data-stu-id="9c872-323">NULL (no witness)</span></span>|<span data-ttu-id="9c872-324">可以对镜像服务器进行强制服务（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="9c872-324">Service can be forced to the mirror server (with possible data loss).</span></span>|  
|<span data-ttu-id="9c872-325">FULL</span><span class="sxs-lookup"><span data-stu-id="9c872-325">FULL</span></span>|<span data-ttu-id="9c872-326">SYNCHRONIZING 或 SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="9c872-326">SYNCHRONIZING or SUSPENDED</span></span>|<span data-ttu-id="9c872-327">NULL（无见证服务器）</span><span class="sxs-lookup"><span data-stu-id="9c872-327">NULL (no witness)</span></span>|<span data-ttu-id="9c872-328">可以对镜像服务器进行强制服务（可能造成数据丢失）。</span><span class="sxs-lookup"><span data-stu-id="9c872-328">Service can be forced to the mirror server (with possible data loss).</span></span>|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="9c872-329">相关任务</span><span class="sxs-lookup"><span data-stu-id="9c872-329">Related Tasks</span></span>  
  
-   [<span data-ttu-id="9c872-330">添加或替换数据库镜像见证服务器 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="9c872-330">Add or Replace a Database Mirroring Witness &#40;SQL Server Management Studio&#41;</span></span>](../database-mirroring/add-or-replace-a-database-mirroring-witness-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="9c872-331">使用 Windows 身份验证建立数据库镜像会话 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="9c872-331">Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;</span></span>](establish-database-mirroring-session-windows-authentication.md)  
  
-   [<span data-ttu-id="9c872-332">使用 Windows 身份验证添加数据库镜像见证服务器 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="9c872-332">Add a Database Mirroring Witness Using Windows Authentication &#40;Transact-SQL&#41;</span></span>](add-a-database-mirroring-witness-using-windows-authentication-transact-sql.md)  
  
-   [<span data-ttu-id="9c872-333">从数据库镜像会话删除见证服务器 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="9c872-333">Remove the Witness from a Database Mirroring Session &#40;SQL Server&#41;</span></span>](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
-   [<span data-ttu-id="9c872-334">更改数据库镜像会话中的事务安全 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="9c872-334">Change Transaction Safety in a Database Mirroring Session &#40;Transact-SQL&#41;</span></span>](change-transaction-safety-in-a-database-mirroring-session-transact-sql.md)  
  
## <a name="see-also"></a><span data-ttu-id="9c872-335">另请参阅</span><span class="sxs-lookup"><span data-stu-id="9c872-335">See Also</span></span>  
 <span data-ttu-id="9c872-336">[监视数据库镜像 (SQL Server)](monitoring-database-mirroring-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="9c872-336">[Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md) </span></span>  
 [<span data-ttu-id="9c872-337">数据库镜像见证服务器</span><span class="sxs-lookup"><span data-stu-id="9c872-337">Database Mirroring Witness</span></span>](database-mirroring-witness.md)  

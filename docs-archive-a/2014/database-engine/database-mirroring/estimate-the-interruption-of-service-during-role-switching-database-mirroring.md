---
title: 估计在角色切换过程中服务中断 (数据库镜像) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578397"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="5c8d2-102">估计在角色切换期间服务的中断（数据库镜像）</span><span class="sxs-lookup"><span data-stu-id="5c8d2-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="5c8d2-103">在角色切换过程中，数据库镜像功能中断服务的时间取决于角色切换的类型和原因。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="5c8d2-104">对于自动故障转移，有两个影响服务中断时间的因素：镜像服务器识别主体服务器实例失败（错误检测）所需的时间，以及数据库故障转移所需的时间（故障转移时间）。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="5c8d2-105">对于强制服务操作，尽管已出现失败，但对失败的检测和响应取决于人的响应。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="5c8d2-106">但是，在发出强制服务命令后，估计的潜在服务器中断时间将限定为估计镜像服务器切换角色的时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="5c8d2-107">若要减少检测特定条件（如某些错误类型）所需的时间，可以针对这些条件定义警报。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="5c8d2-108">对于手动故障转移，中断时间仅指在发出故障转移命令后，数据库故障转移所需的时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="5c8d2-109">错误检测</span><span class="sxs-lookup"><span data-stu-id="5c8d2-109">Error detection</span></span>
 <span data-ttu-id="5c8d2-110">系统发现错误的时间取决于错误类型；例如，网络错误几乎可以被立即注意到，而注意到没有响应的服务器需要 10 秒（默认超时）。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="5c8d2-111">有关可在数据库镜像会话期间导致失败以及在具有自动故障转移功能的高安全性模式下导致超时检测的错误的信息，请参阅 [数据库镜像期间可能出现的故障](possible-failures-during-database-mirroring.md))。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="5c8d2-112">故障转移时间</span><span class="sxs-lookup"><span data-stu-id="5c8d2-112">Failover time</span></span>
 <span data-ttu-id="5c8d2-113">故障转移时间主要包括前一个镜像服务器前滚其重做队列中剩余的任意日志所需的时间，以及一小段额外时间（有关镜像服务器如何处理日志记录的详细信息，请参阅[数据库镜像 (SQL Server)](database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="5c8d2-114">有关估计故障转移时间的信息，请参阅本主题后面的“估计故障转移重做速度”。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="5c8d2-115">如果在先创建，后更改索引或表的事务中发生故障转移，则故障转移占用的时间可能长于通常所需的时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="5c8d2-116">例如，在执行某些操作期间，进行故障转移可能会延长故障转移的时间，这些操作包括：BEGIN TRANSACTION，对表执行的 CREATE INDEX 以及 SELECT INTO。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="5c8d2-117">在通过 COMMIT TRANSACTION 或 ROLLBACK TRANSACTION 语句完成事务之前，该事务中故障转移时间延长的可能性一直存在。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="5c8d2-118">重做队列</span><span class="sxs-lookup"><span data-stu-id="5c8d2-118">The Redo Queue</span></span>
 <span data-ttu-id="5c8d2-119">前滚数据库涉及应用镜像服务器上的重做队列中当前存在的任何日志记录。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="5c8d2-120">“重做队列” \*\* 包括已写入镜像服务器的磁盘上、但尚未在镜像数据库中前滚的日志记录。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="5c8d2-121">数据库的故障转移时间取决于镜像服务器前滚重做队列中日志的速度，此速度反过来主要由系统硬件和当前的工作负荷决定。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="5c8d2-122">主体数据库可能会非常忙，以至于主体服务器将日志传送到镜像服务器的速度远远大于镜像服务器前滚日志的速度。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="5c8d2-123">在这种情况下，当镜像服务器前滚重做队列中的日志时，故障转移可能占用大量时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="5c8d2-124">若要了解重做队列当前的大小，请使用数据库镜像性能对象中的 **Redo Queue** 计数器。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="5c8d2-125">有关详细信息，请参阅 [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md)。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="5c8d2-126">估计故障转移重做速度</span><span class="sxs-lookup"><span data-stu-id="5c8d2-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="5c8d2-127">可以使用生产数据库的测试副本测量前滚日志记录所需的时间（“重做速度”）\*\*。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="5c8d2-128">估计故障转移过程中的前滚时间所用的方法取决于重做阶段中镜像服务器使用的线程数。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="5c8d2-129">线程数取决于以下情况：</span><span class="sxs-lookup"><span data-stu-id="5c8d2-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="5c8d2-130">在 [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)]中，镜像服务器始终使用单个线程来前滚数据库。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="5c8d2-131">在 [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)] 中，当作为镜像服务器的计算机使用的 CPU 少于五个时，也只使用单线程。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="5c8d2-132">如果 CPU 的数量为五个或更多时，镜像服务器便会在故障转移过程中在多个线程之间分配其前滚操作（这称为“并行重做”\*\*）。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="5c8d2-133">并行重做被优化为针对每四个 CPU 使用一个线程。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="5c8d2-134">估计单线程重做速度</span><span class="sxs-lookup"><span data-stu-id="5c8d2-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="5c8d2-135">对于单线程重做，在故障转移过程中，镜像数据库前滚所占用的时间与还原日志备份前滚相同量的日志所占用的时间大致相当。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="5c8d2-136">若要估计故障转移时间，请在您要执行镜像的环境中创建一个测试数据库。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="5c8d2-137">然后从生产数据库进行日志备份。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="5c8d2-138">若要度量该日志备份的重做速度，请记录您将日志备份使用 WITH NORECOVERY 选项还原到测试数据库中所需的时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="5c8d2-139">了解了镜像服务器的重做速度之后，便可使用镜像服务器中当前需要重做的日志量（由 **Redo Queue** 性能计数器测量）除以重做速度，来估计给定时点数据库故障转移的时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="5c8d2-140">在正常情况下，如果镜像服务器可以承受主体服务器中的负荷，则 **重做队列** 小于零或接近零，并且故障转移仅会占用几秒钟。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="5c8d2-141">估计并行重做速度</span><span class="sxs-lookup"><span data-stu-id="5c8d2-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="5c8d2-142">在 [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)]中，并行重做被优化为针对每四个 CPU 使用一个线程。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="5c8d2-143">若要估计并行重做的前滚时间，访问正在运行的测试系统要比访问测试数据库更能得到准确的结果。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="5c8d2-144">当监视镜像服务器中的重做队列时，会增加主体服务器中的负荷。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="5c8d2-145">在正常操作中，重做队列接近于零。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="5c8d2-146">增加主体服务器上的负荷，直到重做队列开始不断增长；系统随后将会达到最大重做速度，而此时的 **Redo Bytes/sec** 性能计数器即表示最大重做速度。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="5c8d2-147">有关详细信息，请参阅 [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md)。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="5c8d2-148">估计自动故障转移过程中的服务中断</span><span class="sxs-lookup"><span data-stu-id="5c8d2-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="5c8d2-149">下图阐释了错误检测和故障转移时间如何影响在 **Partner_B**中完成自动故障转移所需的总时间。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="5c8d2-150">故障转移需要一定的时间前滚数据库（重做阶段），另外还需要一小段时间使数据库联机。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="5c8d2-151">撤消阶段涉及回滚任何未提交的事务，这一阶段发生在新的主体数据库联机之后，并在故障转移后继续。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="5c8d2-152">在撤消阶段，数据库是可用的。</span><span class="sxs-lookup"><span data-stu-id="5c8d2-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="5c8d2-153">![错误检测和故障转移时间](../media/dbm-failovauto-time.gif "错误检测和故障转移时间")</span><span class="sxs-lookup"><span data-stu-id="5c8d2-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="5c8d2-154">另请参阅</span><span class="sxs-lookup"><span data-stu-id="5c8d2-154">See Also</span></span>
 <span data-ttu-id="5c8d2-155">[在数据库镜像会话过程中，](role-switching-during-a-database-mirroring-session-sql-server.md) [数据库镜像运行模式](database-mirroring-operating-modes.md)角色切换 &#40;SQL Server&#41;[监视数据库镜像 &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="5c8d2-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>



---
title: 数据库镜像和复制 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- replication [SQL Server], database mirroring and
ms.assetid: 82796217-02e2-4bc5-9ab5-218bae11a2d6
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: b126aeb8ccd24932706b8798ebfe7088308918e2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87691868"
---
# <a name="database-mirroring-and-replication-sql-server"></a><span data-ttu-id="0bf4a-102">数据库镜像和复制 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="0bf4a-102">Database Mirroring and Replication (SQL Server)</span></span>
  <span data-ttu-id="0bf4a-103">数据库镜像可以与复制一起使用以改进发布数据库的可用性。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-103">Database mirroring can be used in conjunction with replication to improve availability for the publication database.</span></span> <span data-ttu-id="0bf4a-104">数据库镜像涉及一个数据库的两个副本，这两个副本通常驻留在不同的计算机上。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-104">Database mirroring involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="0bf4a-105">在任何给定时间都只有一个数据库副本可供客户端使用。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-105">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="0bf4a-106">该副本称为主体数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-106">This copy is known as the principal database.</span></span> <span data-ttu-id="0bf4a-107">客户端对主体数据库所做的更新应用到数据库的另一副本（称为镜像数据库）。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-107">Updates made by clients to the principal database are applied on the other copy of the database, known as the mirror database.</span></span> <span data-ttu-id="0bf4a-108">镜像涉及将在主体数据库上执行的每个插入、更新或删除操作的事务日志应用到镜像数据库上。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-108">Mirroring involves applying the transaction log from every insertion, update, or deletion made on the principal database onto the mirror database.</span></span>  
  
 <span data-ttu-id="0bf4a-109">对发布数据库完全支持将复制故障转移到镜像数据库的功能；而对订阅数据库则提供有限支持。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-109">Replication failover to a mirror is fully supported for publication databases, with limited support for subscription databases.</span></span> <span data-ttu-id="0bf4a-110">对于分发数据库则不支持数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-110">Database mirroring is not supported for the distribution database.</span></span> <span data-ttu-id="0bf4a-111">有关无需重新配置复制就可以恢复分发数据库或订阅数据库的信息，请参阅 [备份和还原复制数据库](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-111">For information about recovering a distribution database or subscription database without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span> <span data-ttu-id="0bf4a-112">有关镜像订阅服务器数据库的信息，请参阅</span><span class="sxs-lookup"><span data-stu-id="0bf4a-112">For information about mirroring the subscriber database, see the</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="0bf4a-113">故障转移后，镜像数据库变为主体数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-113">After a failover, the mirror becomes the principal.</span></span> <span data-ttu-id="0bf4a-114">在本主题中，“主体”和“镜像”始终是指原始主体和镜像。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-114">In this topic, "principal" and "mirror" always refer to the original principal and mirror.</span></span>  
  
## <a name="requirements-and-considerations-for-using-replication-with-database-mirroring"></a><span data-ttu-id="0bf4a-115">将复制与数据库镜像一起使用的要求和注意事项</span><span class="sxs-lookup"><span data-stu-id="0bf4a-115">Requirements and Considerations for Using Replication with Database Mirroring</span></span>  
 <span data-ttu-id="0bf4a-116">将复制与数据库镜像一起使用时，注意以下要求和注意事项：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-116">Be aware of the following requirements and considerations when using replication with database mirroring:</span></span>  
  
-   <span data-ttu-id="0bf4a-117">主体数据库和镜像数据库必须共享分发服务器。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-117">The principal and mirror must share a Distributor.</span></span> <span data-ttu-id="0bf4a-118">建议此处使用远程分发服务器，如果发布服务器有意外故障转移，则远程分发服务器可以提供较大的容错能力。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-118">We recommend that this be a remote Distributor, which provides greater fault tolerance if the Publisher has an unplanned failover.</span></span>  
  
-   <span data-ttu-id="0bf4a-119">对于合并复制，以及对于使用只读订阅服务器或排队更新订阅服务器的事务复制，复制支持对发布数据库进行镜像。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-119">Replication supports mirroring the publication database for merge replication and for transactional replication with read-only Subscribers or queued updating Subscribers.</span></span> <span data-ttu-id="0bf4a-120">不支持即时更新对等拓扑中的订阅服务器、Oracle 发布服务器、发布服务器并重新发布。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-120">Immediate updating Subscribers, Oracle Publishers, Publishers in a peer-to-peer topology, and republishing are not supported.</span></span>  
  
-   <span data-ttu-id="0bf4a-121">存在于数据库外部的元数据和对象不复制到镜像数据库，包括登录名、作业、链接服务器等等。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-121">Metadata and objects that exist outside the database are not copied to the mirror, including logins, jobs, linked servers, and so on.</span></span> <span data-ttu-id="0bf4a-122">如果要求镜像数据库中有元数据和对象，则必须手动复制它们。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-122">If you require the metadata and objects at the mirror, you must copy them manually.</span></span> <span data-ttu-id="0bf4a-123">有关详细信息，请参阅[角色切换后登录名和作业的管理 (SQL Server)](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-123">For more information, see [Management of Logins and Jobs After Role Switching &#40;SQL Server&#41;](../../sql-server/failover-clusters/management-of-logins-and-jobs-after-role-switching-sql-server.md).</span></span>  
  
## <a name="configuring-replication-with-database-mirroring"></a><span data-ttu-id="0bf4a-124">配置复制以及数据库镜像</span><span class="sxs-lookup"><span data-stu-id="0bf4a-124">Configuring Replication with Database Mirroring</span></span>  
 <span data-ttu-id="0bf4a-125">配置复制和数据库镜像包括五个步骤。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-125">Configuring replication and database mirroring involves five steps.</span></span> <span data-ttu-id="0bf4a-126">在下面的部分中将详细说明每个步骤。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-126">Each step is described in more detail in the following section.</span></span>  
  
1.  <span data-ttu-id="0bf4a-127">配置发布服务器。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-127">Configure the Publisher.</span></span>  
  
2.  <span data-ttu-id="0bf4a-128">配置数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-128">Configure database mirroring.</span></span>  
  
3.  <span data-ttu-id="0bf4a-129">配置镜像数据库，使其使用与主体数据库相同的分发服务器。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-129">Configure the mirror to use the same Distributor as the principal.</span></span>  
  
4.  <span data-ttu-id="0bf4a-130">配置用于故障转移的复制代理。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-130">Configure replication agents for failover.</span></span>  
  
5.  <span data-ttu-id="0bf4a-131">向复制监视器添加主体数据库和镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-131">Add the principal and mirror to Replication Monitor.</span></span>  
  
 <span data-ttu-id="0bf4a-132">也可以相反的顺序执行步骤 1 和步骤 2。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-132">Steps 1 and 2 can also be performed in the opposite order.</span></span>  
  
#### <a name="to-configure-database-mirroring-for-a-publication-database"></a><span data-ttu-id="0bf4a-133">配置发布数据库的数据库镜像</span><span class="sxs-lookup"><span data-stu-id="0bf4a-133">To configure database mirroring for a publication database</span></span>  
  
1.  <span data-ttu-id="0bf4a-134">配置发布服务器：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-134">Configure the Publisher:</span></span>  
  
    1.  <span data-ttu-id="0bf4a-135">建议使用远程分发服务器。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-135">We recommend using a remote Distributor.</span></span> <span data-ttu-id="0bf4a-136">有关如何配置分发的详细信息，请参阅 [配置分发](../../relational-databases/replication/configure-distribution.md)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-136">For more information about configuring distribution, see [Configure Distribution](../../relational-databases/replication/configure-distribution.md).</span></span>  
  
    2.  <span data-ttu-id="0bf4a-137">可以为快照发布及事务发布和/或合并发布启用数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-137">You can enable a database for snapshot and transactional publications and/or merge publications.</span></span> <span data-ttu-id="0bf4a-138">对于将包含多种发布类型的镜像数据库，必须使用 [sp_replicationdboption](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql)为同一节点上的两种类型都启用数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-138">For mirrored databases that will contain more than one type of publication, you must enable the database for both types at the same node using [sp_replicationdboption](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span> <span data-ttu-id="0bf4a-139">例如，可以在主体数据库上执行下面的存储过程调用：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-139">For example, you could execute the following stored procedure calls at the principal:</span></span>  
  
        ```  
        exec sp_replicationdboption @dbname='<PublicationDatabase>', @optname='publish', @value=true;  
        exec sp_replicationdboption @dbname='<PublicationDatabase>', @optname='mergepublish', @value=true;  
        ```  
  
         <span data-ttu-id="0bf4a-140">有关创建发布的详细信息，请参阅 [发布数据和数据库对象](../../relational-databases/replication/publish/publish-data-and-database-objects.md)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-140">For more information about creating publications, see [Publish Data and Database Objects](../../relational-databases/replication/publish/publish-data-and-database-objects.md).</span></span>  
  
2.  <span data-ttu-id="0bf4a-141">配置数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-141">Configure database mirroring.</span></span> <span data-ttu-id="0bf4a-142">有关详细信息，请参阅[使用 Windows 身份验证建立数据库镜像会话 (SQL Server Management Studio)](establish-database-mirroring-session-windows-authentication.md) 和[设置数据库镜像 (SQL Server)](database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-142">For more information, see [Establish a Database Mirroring Session Using Windows Authentication &#40;SQL Server Management Studio&#41;](establish-database-mirroring-session-windows-authentication.md) and [Setting Up Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="0bf4a-143">配置镜像的分发。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-143">Configure distribution for the mirror.</span></span> <span data-ttu-id="0bf4a-144">将镜像名称指定为发布服务器，并指定主体数据库使用的同一分发服务器和快照文件夹。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-144">Specify the mirror name as the Publisher, and specify the same Distributor and snapshot folder that the principal uses.</span></span> <span data-ttu-id="0bf4a-145">例如，如果想使用存储过程配置复制，可以在分发服务器上执行 [sp_adddistpublisher](/sql/relational-databases/system-stored-procedures/sp-adddistpublisher-transact-sql) ，然后在镜像上执行 [sp_adddistributor](/sql/relational-databases/system-stored-procedures/sp-adddistributor-transact-sql) 。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-145">For example, if you are configuring replication with stored procedures, execute [sp_adddistpublisher](/sql/relational-databases/system-stored-procedures/sp-adddistpublisher-transact-sql) at the Distributor; and then execute [sp_adddistributor](/sql/relational-databases/system-stored-procedures/sp-adddistributor-transact-sql) at the mirror.</span></span> <span data-ttu-id="0bf4a-146">对于 **sp_adddistpublisher**：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-146">For **sp_adddistpublisher**:</span></span>  
  
    -   <span data-ttu-id="0bf4a-147">将参数的值设置 **@publisher** 为镜像的网络名称。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-147">Set the value of the **@publisher** parameter to the network name of the mirror.</span></span>  
  
    -   <span data-ttu-id="0bf4a-148">将参数的值设置 **@working_directory** 为主体使用的快照文件夹。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-148">Set the value of the **@working_directory** parameter to the snapshot folder used by the principal.</span></span>  
  
4.  <span data-ttu-id="0bf4a-149">为“-PublisherFailoverPartner”代理参数指定镜像名称。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-149">Specify the mirror name for the **-PublisherFailoverPartner** agent parameter.</span></span> <span data-ttu-id="0bf4a-150">下列代理在故障转移后需要使用此代理参数来标识镜像：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-150">Agent This parameter is required for the following agents to identify the mirror after failover:</span></span>  
  
    -   <span data-ttu-id="0bf4a-151">快照代理（对于所有发布）</span><span class="sxs-lookup"><span data-stu-id="0bf4a-151">Snapshot Agent (for all publications)</span></span>  
  
    -   <span data-ttu-id="0bf4a-152">日志读取器代理（对于所有事务发布）</span><span class="sxs-lookup"><span data-stu-id="0bf4a-152">Log Reader Agent (for all transactional publications)</span></span>  
  
    -   <span data-ttu-id="0bf4a-153">队列读取器代理（对于支持排队更新订阅的事务发布）</span><span class="sxs-lookup"><span data-stu-id="0bf4a-153">Queue Reader Agent (for transactional publications that support queued updating subscriptions)</span></span>  
  
    -   <span data-ttu-id="0bf4a-154">合并代理（对于合并订阅）</span><span class="sxs-lookup"><span data-stu-id="0bf4a-154">Merge Agent (for merge subscriptions)</span></span>  
  
    -   [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="0bf4a-155">复制侦听程序（replisapi.dll：用于使用 Web 同步进行同步的合并订阅）</span><span class="sxs-lookup"><span data-stu-id="0bf4a-155">replication listener (replisapi.dll: for merge subscriptions synchronized using Web synchronization)</span></span>  
  
    -   <span data-ttu-id="0bf4a-156">SQL 合并 ActiveX 控件（对于与控件同步的合并订阅）</span><span class="sxs-lookup"><span data-stu-id="0bf4a-156">SQL Merge ActiveX Control (for merge subscriptions synchronized with the control)</span></span>  
  
     <span data-ttu-id="0bf4a-157">分发代理和分发 ActiveX 控件没有此参数，因为它们不连接到发布服务器。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-157">The Distribution Agent and Distribution ActiveX Control do not have this parameter because they do not connect to the Publisher.</span></span>  
  
     <span data-ttu-id="0bf4a-158">对代理参数所做的更改在下次启动代理时生效。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-158">Agent parameter changes take effect the next time the agent is started.</span></span> <span data-ttu-id="0bf4a-159">如果代理连续运行，则必须停止该代理，然后重新启动。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-159">If the agent runs continuously, you must stop and restart the agent.</span></span> <span data-ttu-id="0bf4a-160">可以在代理配置文件中和从命令提示符指定参数。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-160">Parameters can be specified in agent profiles and from the command prompt.</span></span> <span data-ttu-id="0bf4a-161">有关详细信息，请参阅：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-161">For more information, see:</span></span>  
  
    -   [<span data-ttu-id="0bf4a-162">查看和修改复制代理命令提示符参数 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="0bf4a-162">View and Modify Replication Agent Command Prompt Parameters &#40;SQL Server Management Studio&#41;</span></span>](../../relational-databases/replication/agents/view-and-modify-replication-agent-command-prompt-parameters.md)  
  
    -   [<span data-ttu-id="0bf4a-163">Replication Agent Executables Concepts</span><span class="sxs-lookup"><span data-stu-id="0bf4a-163">Replication Agent Executables Concepts</span></span>](../../relational-databases/replication/concepts/replication-agent-executables-concepts.md)  
  
     <span data-ttu-id="0bf4a-164">建议将“-PublisherFailoverPartner”添加到代理配置文件，然后在配置文件中指定镜像名称。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-164">We recommend adding the **-PublisherFailoverPartner** to an agent profile, and then specifying the mirror name in the profile.</span></span> <span data-ttu-id="0bf4a-165">例如，如果您通过存储过程配置复制，请执行以下操作：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-165">For example, if you are configuring replication with stored procedures:</span></span>  
  
    ```  
    -- Execute sp_help_agent_profile in the context of the distribution database to get the list of profiles.  
    -- Select the profile id of the profile that needs to be updated from the result set.  
    -- In the agent_type column returned by sp_help_agent_profile:   
    -- 1 = Snapshot Agent; 2 = Log Reader Agent; 3 = Distribution Agent; 4 = Merge Agent; 9 = Queue Reader Agent.  
  
    exec sp_help_agent_profile;  
  
    -- Setting the -PublisherFailoverPartner parameter in the default Snapshot Agent profile (profile 1).  
    -- Execute sp_add_agent_parameter in the context of the distribution database.  
    exec sp_add_agent_parameter @profile_id = 1, @parameter_name = N'-PublisherFailoverPartner', @parameter_value = N'<Failover Partner Name>';  
  
    -- Setting the -PublisherFailoverPartner parameter in the default Merge Agent profile (profile 6).  
    -- Execute sp_add_agent_parameter in the context of the distribution database.  
    exec sp_add_agent_parameter @profile_id = 6, @parameter_name = N'-PublisherFailoverPartner', @parameter_value = N'<Failover Partner Name>';  
    ```  
  
5.  <span data-ttu-id="0bf4a-166">向复制监视器添加主体数据库和镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-166">Add the principal and mirror to Replication Monitor.</span></span> <span data-ttu-id="0bf4a-167">有关详细信息，请参阅 [从复制监视器中添加和删除发布服务器](../../relational-databases/replication/monitor/add-and-remove-publishers-from-replication-monitor.md)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-167">For more information, see [Add and Remove Publishers from Replication Monitor](../../relational-databases/replication/monitor/add-and-remove-publishers-from-replication-monitor.md).</span></span>  
  
## <a name="maintaining-a-mirrored-publication-database"></a><span data-ttu-id="0bf4a-168">维护镜像发布数据库</span><span class="sxs-lookup"><span data-stu-id="0bf4a-168">Maintaining a Mirrored Publication Database</span></span>  
 <span data-ttu-id="0bf4a-169">维护镜像发布数据库与维护非镜像数据库基本相同，需要注意以下事项：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-169">Maintaining a mirrored publication database is essentially the same as maintaining a non-mirrored database, with the following considerations:</span></span>  
  
-   <span data-ttu-id="0bf4a-170">管理和监视必须在活动服务器上进行。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-170">Administration and monitoring must occur at the active server.</span></span> <span data-ttu-id="0bf4a-171">在 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]中，发布仅出现在活动服务器的 **“本地发布”** 文件夹下方。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-171">In [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], publications appear under the **Local Publications** folder only for the active server.</span></span> <span data-ttu-id="0bf4a-172">例如，如果故障转移到镜像数据库，则发布显示在镜像数据库中，而不再显示在主体数据库中。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-172">For example, if you failover to the mirror, the publications are displayed at the mirror and are no longer displayed at the principal.</span></span> <span data-ttu-id="0bf4a-173">如果数据库故障转移到镜像数据库，则可能需要手动刷新 [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] 和复制监视器才能反映更改。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-173">If the database fails over to the mirror, you might need to manually refresh [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] and Replication Monitor for the change to be reflected.</span></span>  
  
-   <span data-ttu-id="0bf4a-174">复制监视器会在对象树中同时显示主体数据库和镜像数据库的“发布服务器”节点。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-174">Replication Monitor displays Publisher nodes in the object tree for both the principal and the mirror.</span></span> <span data-ttu-id="0bf4a-175">如果主体数据库位于活动服务器，则仅在复制监视器的主体数据库节点下显示发布信息。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-175">If the principal is the active server, publication information is displayed only under the principal node in Replication Monitor.</span></span>  
  
     <span data-ttu-id="0bf4a-176">如果镜像数据库位于活动服务器：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-176">If the mirror is the active server:</span></span>  
  
    -   <span data-ttu-id="0bf4a-177">代理出错时，只在主体数据库节点上指出错误，而不在镜像数据库节点上指出。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-177">If an agent has an error, the error is indicated only on the principal node, not on the mirror node.</span></span>  
  
    -   <span data-ttu-id="0bf4a-178">主体数据库不可用时，主体数据库节点和镜像数据库节点会显示相同的发布列表。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-178">If the principal is unavailable, the principal and mirror nodes display identical lists of publications.</span></span> <span data-ttu-id="0bf4a-179">这时，应对镜像数据库节点下的发布执行监视。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-179">Monitoring should be performed on the publications under the mirror node.</span></span>  
  
-   <span data-ttu-id="0bf4a-180">当使用存储过程或复制管理对象 (RMO) 在镜像数据库上管理复制时，对于需要指定发布服务器名称的情况，必须指定已经为复制启用了数据库的实例的名称。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-180">When using stored procedures or Replication Management Objects (RMO) to administer replication at the mirror, for cases in which you specify the Publisher name, you must specify the name of the instance on which the database was enabled for replication.</span></span> <span data-ttu-id="0bf4a-181">若要确定相应的名称，请使用函数 [publishingservername](/sql/t-sql/functions/replication-functions-publishingservername)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-181">To determine the appropriate name, use the function [publishingservername](/sql/t-sql/functions/replication-functions-publishingservername).</span></span>  
  
     <span data-ttu-id="0bf4a-182">如果对发布数据库做了镜像，则镜像数据库中存储的复制元数据与主体数据库中存储的元数据相同。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-182">When a publication database is mirrored, the replication metadata stored in the mirrored database is identical to the metadata stored in the principal database.</span></span> <span data-ttu-id="0bf4a-183">因此，对于为主体数据库上的复制启用的发布数据库，在镜像数据库上的系统表中存储的发布服务器实例名称是主体数据库的名称，而不是镜像数据库的名称。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-183">Consequently, for publication databases enabled for replication at the principal, the Publisher instance name stored in system tables at the mirror is the name of the principal, not the mirror.</span></span> <span data-ttu-id="0bf4a-184">如果发布数据库故障转移到镜像数据库，则这种情况会影响复制的配置和维护。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-184">This affects replication configuration and maintenance if the publication database fails over to the mirror.</span></span> <span data-ttu-id="0bf4a-185">例如，如果要在故障转移后使用镜像数据库上的存储过程配置复制，并且想要将请求订阅添加到在主体上启用的发布数据库，则必须指定主体名称，而不是 **@publisher** **sp_addpullsubscription**或**sp_addmergepullsubscription**的参数的镜像名称。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-185">For example, if you are configuring replication with stored procedures on the mirror after a failover, and you want to add a pull subscription to a publication database that was enabled at the principal, you must specify the principal name rather than the mirror name for the **@publisher** parameter of **sp_addpullsubscription** or **sp_addmergepullsubscription**.</span></span>  
  
     <span data-ttu-id="0bf4a-186">如果在故障转移到镜像数据库后在镜像服务器上启用发布数据库，则存储在系统表中的发布服务器实例名称是镜像服务器的名称;在这种情况下，应将镜像的名称用于 **@publisher** 参数。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-186">If you enable a publication database at the mirror after failover to the mirror, the Publisher instance name stored in system tables is the name of the mirror; in this case, you would use the name of the mirror for the **@publisher** parameter.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="0bf4a-187">某些情况下，如 **sp_addpublication**，只有非 **@publisher** @publisher[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 参数；在这些情况下，它与 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库镜像无关。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-187">In some cases, such as **sp_addpublication**, the **@publisher** parameter is supported only for non-[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Publishers; in these cases, it is not relevant for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database mirroring.</span></span>  
  
-   <span data-ttu-id="0bf4a-188">若要在故障转移后在 [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] 中同步订阅：请同步来自订阅服务器的请求订阅以及来自活动发布服务器的推送订阅。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-188">To synchronize a subscription in [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] after a failover: synchronize pull subscriptions from the Subscriber; and synchronize push subscriptions from the active Publisher.</span></span>  
  
### <a name="replication-behavior-if-mirroring-is-removed"></a><span data-ttu-id="0bf4a-189">删除镜像后的复制行为</span><span class="sxs-lookup"><span data-stu-id="0bf4a-189">Replication Behavior if Mirroring is Removed</span></span>  
 <span data-ttu-id="0bf4a-190">如果从已发布数据库中删除了数据库镜像，请谨记以下情况：</span><span class="sxs-lookup"><span data-stu-id="0bf4a-190">Keep the following issues in mind if database mirroring is removed from a published database:</span></span>  
  
-   <span data-ttu-id="0bf4a-191">如果主体数据库上的发布数据库不再有镜像，则复制依照原主体数据库无改变地继续工作。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-191">If the publication database at the principal is no longer mirrored, replication continues to work unchanged against the original principal.</span></span>  
  
-   <span data-ttu-id="0bf4a-192">如果发布数据库从主体数据库故障转移到镜像数据库，而且镜像关系随后被禁用或删除，则复制代理不再对镜像数据库起作用。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-192">If the publication database fails over from the principal to the mirror and the mirroring relationship is subsequently disabled or removed, replication agents will not function against the mirror.</span></span> <span data-ttu-id="0bf4a-193">如果主体数据库永久丢失，请禁用复制，然后用指定为发布服务器的像镜重新配置复制。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-193">If the principal is permanently lost, disable and then reconfigure replication with the mirror specified as the Publisher.</span></span>  
  
-   <span data-ttu-id="0bf4a-194">如果完全删除数据库镜像，镜像数据库将处于恢复状态，必须还原才能起作用。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-194">If database mirroring is removed completely, the mirror database is in a recovery state and must be restored in order to become functional.</span></span> <span data-ttu-id="0bf4a-195">就复制而言，已恢复数据库的行为取决于是否指定了 KEEP_REPLICATION 选项。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-195">The behavior of the recovered database with respect to replication depends on whether the KEEP_REPLICATION option is specified.</span></span> <span data-ttu-id="0bf4a-196">在将已发布数据库还原到创建备份的服务器以外的服务器上时，此选项强制还原操作保留复制设置。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-196">This option forces the restore operation to preserve replication settings when restoring a published database to a server other than that on which the backup was created.</span></span> <span data-ttu-id="0bf4a-197">仅当另一个发布数据库不可用时才使用 KEEP_REPLICATION 选项。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-197">Use the KEEP_REPLICATION option only when the other publication database is unavailable.</span></span> <span data-ttu-id="0bf4a-198">如果另一个发布数据库仍然完好且仍在复制，则不支持此选项。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-198">The option is not supported if the other publication database is still intact and replicating.</span></span> <span data-ttu-id="0bf4a-199">有关 KEEP_REPLICATION 的详细信息，请参阅 [RESTORE (Transact-SQL)](/sql/t-sql/statements/restore-statements-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-199">For more information about KEEP_REPLICATION, see [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
## <a name="log-reader-agent-behavior"></a><span data-ttu-id="0bf4a-200">日志读取器代理的行为</span><span class="sxs-lookup"><span data-stu-id="0bf4a-200">Log Reader Agent Behavior</span></span>  
 <span data-ttu-id="0bf4a-201">下表说明了日志读取器代理对于数据库镜像各种运行模式的行为。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-201">The following table describes Log Reader Agent behavior for the various operating modes of database mirroring.</span></span>  
  
|<span data-ttu-id="0bf4a-202">运行模式</span><span class="sxs-lookup"><span data-stu-id="0bf4a-202">Operating mode</span></span>|<span data-ttu-id="0bf4a-203">镜像数据库不可用时日志读取器代理的行为</span><span class="sxs-lookup"><span data-stu-id="0bf4a-203">Log Reader Agent behavior if the mirror is unavailable</span></span>|  
|--------------------|------------------------------------------------------------|  
|<span data-ttu-id="0bf4a-204">具有自动故障转移的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="0bf4a-204">High-safety mode with automatic failover</span></span>|<span data-ttu-id="0bf4a-205">如果镜像数据库不可用，则日志读取器代理将命令传播到分发数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-205">If the mirror is unavailable, the Log Reader Agent propagates commands to the distribution database.</span></span> <span data-ttu-id="0bf4a-206">直到镜像数据库回到联机状态并且具有来自主体数据库的所有事务，主体数据库才能故障转移到镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-206">The principal cannot failover to the mirror until the mirror is back online and has all transactions from the principal.</span></span>|  
|<span data-ttu-id="0bf4a-207">高性能模式</span><span class="sxs-lookup"><span data-stu-id="0bf4a-207">High-performance mode</span></span>|<span data-ttu-id="0bf4a-208">如果镜像数据库不可用，则主体数据库公开（即无镜像）运行。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-208">If the mirror is unavailable, the principal database is running exposed (that is, unmirrored).</span></span> <span data-ttu-id="0bf4a-209">但是，日志读取器代理仅复制那些在镜像服务器上受保护的事务。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-209">However, the Log Reader Agent only replicates those transactions that are hardened on the mirror.</span></span> <span data-ttu-id="0bf4a-210">如果是强制服务，并且镜像服务器充当主体服务器的角色，则日志读取器代理将依照镜像服务器工作并开始拾取新事务。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-210">If service is forced and the mirror server assumes the role of the principal, the Log Reader Agent will work against the mirror and start picking up the new transactions.</span></span><br /><br /> <span data-ttu-id="0bf4a-211">请注意，如果镜像服务器落后于主体服务器，就会加大复制滞后。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-211">Be aware that replication latency will increase if the mirror falls behind the principal.</span></span>|  
|<span data-ttu-id="0bf4a-212">不带自动故障转移的高安全性模式</span><span class="sxs-lookup"><span data-stu-id="0bf4a-212">High-safety mode without automatic failover</span></span>|<span data-ttu-id="0bf4a-213">保证所有已提交的事务均在镜像服务器的磁盘上受到保护。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-213">All committed transactions are guaranteed to be hardened to disk on the mirror.</span></span> <span data-ttu-id="0bf4a-214">日志读取器代理仅复制那些在镜像服务器上受保护的事务。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-214">The Log Reader Agent replicates only those transactions that are hardened on the mirror.</span></span> <span data-ttu-id="0bf4a-215">如果镜像服务器不可用，则主体服务器禁止数据库中的进一步活动；因此，日志读取器代理没有事务可以复制。</span><span class="sxs-lookup"><span data-stu-id="0bf4a-215">If the mirror is unavailable, the principal disallows further activity in the database; therefore the Log Reader Agent has no transactions to replicate.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="0bf4a-216">另请参阅</span><span class="sxs-lookup"><span data-stu-id="0bf4a-216">See Also</span></span>  
 <span data-ttu-id="0bf4a-217">[SQL Server 复制](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="0bf4a-217">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 [<span data-ttu-id="0bf4a-218">日志传送和复制 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="0bf4a-218">Log Shipping and Replication &#40;SQL Server&#41;</span></span>](../log-shipping/log-shipping-and-replication-sql-server.md)  
  
  

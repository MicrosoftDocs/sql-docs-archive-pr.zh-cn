---
title: 数据库镜像见证服务器 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- witness [SQL Server], about witness
- witness [SQL Server]
- database mirroring [SQL Server], witness
ms.assetid: 05606de8-90c3-451a-938d-1ed34211dad7
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 6ac02e2a5dbe86af72c15c07e14de70b12892b48
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578403"
---
# <a name="database-mirroring-witness"></a><span data-ttu-id="7c2a2-102">Database Mirroring Witness</span><span class="sxs-lookup"><span data-stu-id="7c2a2-102">Database Mirroring Witness</span></span>
  <span data-ttu-id="7c2a2-103">若要支持自动故障转移，必须在高安全性模式下配置数据库镜像会话，并且还要具有第三个服务器实例（也称为“见证服务器”）。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-103">To support automatic failover, a database mirroring session must be configured in high-safety mode and also possess a third server instance, known as the *witness*.</span></span> <span data-ttu-id="7c2a2-104">见证服务器是 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的可选实例，它能使高安全性模式会话中的镜像服务器识别出是否要启动自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-104">The witness is an optional instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] that enables the mirror server in a high-safety mode session to recognize whether to initiate an automatic failover.</span></span> <span data-ttu-id="7c2a2-105">与这两个伙伴不同的是，见证服务器并不能用于数据库。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-105">Unlike the two partners, the witness does not serve the database.</span></span> <span data-ttu-id="7c2a2-106">见证服务器的唯一角色是支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-106">Supporting automatic failover is the only role of the witness.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7c2a2-107">在高性能模式下，见证服务器对可用性会有不利影响。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-107">In high-performance mode, the witness can adversely affect availability.</span></span> <span data-ttu-id="7c2a2-108">如果见证服务器是针对数据库镜像会话而配置，则主体服务器必须至少连接到一个其他服务器实例，即镜像服务器或见证服务器，或者是连接到这两个服务器。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-108">If a witness is configured for a database mirroring session, the principal server must be connected at least to one of the other server instances, the mirror server or the witness, or both of them.</span></span> <span data-ttu-id="7c2a2-109">否则，将无法使用数据库，并且不能进行强制服务（可能丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-109">Otherwise, the database becomes unavailable and forcing service (with possible data loss) is impossible.</span></span> <span data-ttu-id="7c2a2-110">因此，对于高性能模式，我们极力建议您始终将见证服务器设置为 OFF。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-110">Therefore, for high-performance mode, we strongly recommend that you always keep the witness set to OFF.</span></span> <span data-ttu-id="7c2a2-111">有关见证服务器对高性能模式影响的信息，请参阅 [数据库镜像运行模式](database-mirroring-operating-modes.md)。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-111">For information about the impact of a witness on high-performance mode, see [Database Mirroring Operating Modes](database-mirroring-operating-modes.md).</span></span>  
  
 <span data-ttu-id="7c2a2-112">下图显示了使用见证服务器的高安全性模式会话。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-112">The following illustration shows a high-safety mode session with a witness.</span></span>  
  
 <span data-ttu-id="7c2a2-113">![具有见证服务器的镜像会话](../media/dbm-3-way-session-intro.gif "具有见证服务器的镜像会话")</span><span class="sxs-lookup"><span data-stu-id="7c2a2-113">![Mirroring session with a witness](../media/dbm-3-way-session-intro.gif "Mirroring session with a witness")</span></span>  
  
 <span data-ttu-id="7c2a2-114">**本主题内容：**</span><span class="sxs-lookup"><span data-stu-id="7c2a2-114">**In This Topic:**</span></span>  
  
-   [<span data-ttu-id="7c2a2-115">在多会话中使用见证服务器</span><span class="sxs-lookup"><span data-stu-id="7c2a2-115">Using a Witness in Multiple Sessions</span></span>](#InMultipleSessions)  
  
-   [<span data-ttu-id="7c2a2-116">关于软件和硬件的建议</span><span class="sxs-lookup"><span data-stu-id="7c2a2-116">Software and Hardware Recommendations</span></span>](#SwHwRecommendations)  
  
-   [<span data-ttu-id="7c2a2-117">自动故障转移中见证服务器的角色</span><span class="sxs-lookup"><span data-stu-id="7c2a2-117">Role of the Witness in Automatic Failover</span></span>](#InAutoFo)  
  
-   [<span data-ttu-id="7c2a2-118">添加或删除见证服务器</span><span class="sxs-lookup"><span data-stu-id="7c2a2-118">To Add or Remove a Witness</span></span>](#AddRemoveWitness)  
  
##  <a name="using-a-witness-in-multiple-sessions"></a><a name="InMultipleSessions"></a> <span data-ttu-id="7c2a2-119">在多会话中使用见证服务器</span><span class="sxs-lookup"><span data-stu-id="7c2a2-119">Using a Witness in Multiple Sessions</span></span>  
 <span data-ttu-id="7c2a2-120">特定的服务器实例可以在并发数据库镜像会话中充当见证服务器，每个会话都针对不同的数据库。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-120">A specific server instance can act as a witness in concurrent database mirroring sessions, each for a different database.</span></span> <span data-ttu-id="7c2a2-121">不同的会话可能有不同的伙伴。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-121">Different sessions can be with different partners.</span></span> <span data-ttu-id="7c2a2-122">下图显示了在两个具有不同伙伴的数据库镜像会话中充当见证服务器的服务器实例。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-122">The following illustration shows a server instance that is a witness in two database mirroring sessions with different partners.</span></span>  
  
 <span data-ttu-id="7c2a2-123">![作为 2 个数据库的见证服务器的服务器实例](../media/dbm-witness-in-2-sessions.gif "作为 2 个数据库的见证服务器的服务器实例")</span><span class="sxs-lookup"><span data-stu-id="7c2a2-123">![Server instance that is a witness for 2 databases](../media/dbm-witness-in-2-sessions.gif "Server instance that is a witness for 2 databases")</span></span>  
  
 <span data-ttu-id="7c2a2-124">此外，一个服务器实例还可以既作为某些会话中的见证服务器，同时又作为其他会话中的伙伴。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-124">A single-server instance can also function at the same time as a witness in some sessions and a partner in other sessions.</span></span> <span data-ttu-id="7c2a2-125">但实际上，服务器实例通常是要么作为见证服务器，要么作为伙伴。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-125">However, in practice, a server instance typically functions as either a witness or a partner.</span></span> <span data-ttu-id="7c2a2-126">这是因为伙伴需要具有足够硬件的高级计算机来支持生产数据库，但是见证服务器可以在支持 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]的任何可用 Windows 系统中运行。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-126">This is because the partners require sophisticated computers that have enough hardware to support a production database, whereas the witness can run on any available Windows system that supports [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>  
  
##  <a name="software-and-hardware-recommendations"></a><a name="SwHwRecommendations"></a> <span data-ttu-id="7c2a2-127">关于软件和硬件的建议</span><span class="sxs-lookup"><span data-stu-id="7c2a2-127">Software and Hardware Recommendations</span></span>  
 <span data-ttu-id="7c2a2-128">我们极力建议将见证服务器置于独立于伙伴的单独计算机中。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-128">We strongly recommend that the witness reside on a separate computer from the partners.</span></span> <span data-ttu-id="7c2a2-129">只有 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Standard Edition 和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise Edition 支持数据库镜像伙伴。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-129">Database mirroring partners are supported only by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Standard edition and by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise edition.</span></span> <span data-ttu-id="7c2a2-130">相反， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Workgroup 和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Express 也支持见证服务器。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-130">Witnesses, in contrast, are also supported by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Workgroup and by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Express.</span></span> <span data-ttu-id="7c2a2-131">除了从早期版本的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]升级期间之外，镜像会话中的服务器实例必须都运行相同版本的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-131">Except during an upgrade from an earlier version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the server instances in a mirroring session must all be running the same version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7c2a2-132">例如，从 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] 镜像配置升级时支持 [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] 见证服务器，但是不能添加到现有或新的 [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] 或更高版本的镜像配置中。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-132">For example, a [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] witness is supported when you are upgrading from a [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] mirroring configuration but cannot be added to an existing or new [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] or later mirroring configuration.</span></span>  
  
 <span data-ttu-id="7c2a2-133">见证服务器可以在支持 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的这些版本之一的任意可靠计算机系统上运行。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-133">A witness can run on any reliable computer system that supports any of these editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="7c2a2-134">然而，我们建议用作见证服务器的每个服务器实例都符合所运行的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Standard 版本所需的最低配置。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-134">However, we recommend that every server instance that is used as a witness correspond to the minimum configuration that is required for the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Standard version that you are running.</span></span> <span data-ttu-id="7c2a2-135">有关这些要求的详细信息，请参阅[安装 SQL Server 2014 的硬件和软件要求](../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-135">For more information about these requirements, see [Hardware and Software Requirements for Installing SQL Server 2014](../../sql-server/install/hardware-and-software-requirements-for-installing-sql-server.md).</span></span>  
  
##  <a name="role-of-the-witness-in-automatic-failover"></a><a name="InAutoFo"></a> <span data-ttu-id="7c2a2-136">自动故障转移中见证服务器的角色</span><span class="sxs-lookup"><span data-stu-id="7c2a2-136">Role of the Witness in Automatic Failover</span></span>  
 <span data-ttu-id="7c2a2-137">在整个数据库镜像会话过程中，所有服务器实例都会监视它们的连接状态。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-137">Throughout a database mirroring session, all the server instances monitor their connection status.</span></span> <span data-ttu-id="7c2a2-138">如果伙伴相互之间断开，它们会依赖见证服务器来确保它们当中只有一个正在操作数据库。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-138">If the partners become disconnected from each other, they rely on the witness to make sure that only one of them is currently serving the database.</span></span> <span data-ttu-id="7c2a2-139">如果有同步镜像服务器断开了与主体服务器的连接，但仍与见证服务器保持连接，镜像服务器就会联系见证服务器，以确定见证服务器是否已与主体服务器断开连接：</span><span class="sxs-lookup"><span data-stu-id="7c2a2-139">If a synchronized mirror server loses its connection to the principal server but remains connected to the witness, the mirror server contacts the witness to determine whether the witness has lost its connection to the principal server:</span></span>  
  
-   <span data-ttu-id="7c2a2-140">如果主体服务器仍与见证服务器保持连接，则不会发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-140">If the principal server is still connected to the witness, automatic failover does not occur.</span></span> <span data-ttu-id="7c2a2-141">主体服务器会继续为数据库提供服务，同时累积日志记录，从而在伙伴重新连接时发送给镜像服务器。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-141">Instead, the principal server continues to server the database while accumulating log records to send the mirror server when the partners reconnect.</span></span>  
  
-   <span data-ttu-id="7c2a2-142">如果见证服务器也与主体服务器断开连接，则镜像服务器知道主体数据库已不可用。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-142">If the witness is also disconnected from the principal server, the mirror server knows that principal database has become unavailable.</span></span> <span data-ttu-id="7c2a2-143">在这种情况下，镜像服务器立即启动自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-143">In this case, the mirror server immediately initiates an automatic failover.</span></span>  
  
-   <span data-ttu-id="7c2a2-144">如果镜像服务器与见证服务器和主体服务器都断开连接，则不论主体服务器状态如何都无法进行自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-144">If the mirror server is disconnected from the witness and also from the principal server, automatic failover is not possible, regardless of the state of the principal server.</span></span>  
  
 <span data-ttu-id="7c2a2-145">至少要连接到两个服务器实例的要求称为“仲裁 ”。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-145">The requirement that at least two of the server instances be connected is known as *quorum*.</span></span> <span data-ttu-id="7c2a2-146">仲裁可以确保数据库一次仅可由一个伙伴提供服务。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-146">Quorum makes sure that the database can only be served by one partner at a time.</span></span> <span data-ttu-id="7c2a2-147">有关仲裁的工作方式及其对会话的影响的信息，请参阅[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="7c2a2-147">For information about how quorum works and its impact on a session, see [Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md).</span></span>  
  
##  <a name="to-add-or-remove-a-witness"></a><a name="AddRemoveWitness"></a> <span data-ttu-id="7c2a2-148">添加或删除见证服务器</span><span class="sxs-lookup"><span data-stu-id="7c2a2-148">To Add or Remove a Witness</span></span>  
 <span data-ttu-id="7c2a2-149">**添加见证服务器**</span><span class="sxs-lookup"><span data-stu-id="7c2a2-149">**To add a witness**</span></span>  
  
-   [<span data-ttu-id="7c2a2-150">添加或替换数据库镜像见证服务器 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="7c2a2-150">Add or Replace a Database Mirroring Witness &#40;SQL Server Management Studio&#41;</span></span>](../database-mirroring/add-or-replace-a-database-mirroring-witness-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="7c2a2-151">使用 Windows 身份验证添加数据库镜像见证服务器 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7c2a2-151">Add a Database Mirroring Witness Using Windows Authentication &#40;Transact-SQL&#41;</span></span>](add-a-database-mirroring-witness-using-windows-authentication-transact-sql.md)  
  
 <span data-ttu-id="7c2a2-152">**删除见证服务器**</span><span class="sxs-lookup"><span data-stu-id="7c2a2-152">**To remove the witness**</span></span>  
  
-   [<span data-ttu-id="7c2a2-153">从数据库镜像会话删除见证服务器 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7c2a2-153">Remove the Witness from a Database Mirroring Session &#40;SQL Server&#41;</span></span>](remove-the-witness-from-a-database-mirroring-session-sql-server.md)  
  
## <a name="see-also"></a><span data-ttu-id="7c2a2-154">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7c2a2-154">See Also</span></span>  
 <span data-ttu-id="7c2a2-155">[数据库镜像会话期间的角色切换 (SQL Server)](role-switching-during-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7c2a2-155">[Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) </span></span>  
 <span data-ttu-id="7c2a2-156">[数据库镜像运行模式](database-mirroring-operating-modes.md) </span><span class="sxs-lookup"><span data-stu-id="7c2a2-156">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) </span></span>  
 <span data-ttu-id="7c2a2-157">[仲裁：见证服务器如何影响数据库可用性（数据库镜像）](quorum-how-a-witness-affects-database-availability-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="7c2a2-157">[Quorum: How a Witness Affects Database Availability &#40;Database Mirroring&#41;](quorum-how-a-witness-affects-database-availability-database-mirroring.md) </span></span>  
 <span data-ttu-id="7c2a2-158">[数据库镜像期间可能出现的故障](possible-failures-during-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="7c2a2-158">[Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md) </span></span>  
 [<span data-ttu-id="7c2a2-159">镜像状态 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7c2a2-159">Mirroring States &#40;SQL Server&#41;</span></span>](mirroring-states-sql-server.md)  
  
  

---
title: 执行可用性组的强制手动故障转移 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/14/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
f1_keywords:
- sql12.swb.availabilitygroup.forcefailover.f1
helpviewer_keywords:
- Availability Groups [SQL Server], failover
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 222288fe-ffc0-4567-b624-5d91485d70f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: f36908102a09eb1ef1f7a485898da715deb4253b
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87580891"
---
# <a name="perform-a-forced-manual-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="213c9-102">执行可用性组的强制手动故障转移 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-102">Perform a Forced Manual Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="213c9-103">本主题说明如何在 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] 中通过使用 [!INCLUDE[tsql](../../../includes/tsql-md.md)]、[!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] 或 PowerShell 对 AlwaysOn 可用性组执行强制故障转移（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="213c9-103">This topic describes how to perform a forced failover (with possible data loss) on an AlwaysOn availability group by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or PowerShell in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="213c9-104">强制故障转移是一种在不可能进行 [计划的手动故障转移](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) 时严格限制用于灾难恢复的手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="213c9-104">A forced failover is a form of manual failover that is intended strictly for disaster recovery, when a [planned manual failover](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md) is not possible.</span></span> <span data-ttu-id="213c9-105">如果您强制故障转移到某一未同步的辅助副本，则可能会丢失一些数据。</span><span class="sxs-lookup"><span data-stu-id="213c9-105">If you force failover to an unsynchronized secondary replica, some data loss is possible.</span></span> <span data-ttu-id="213c9-106">因此，我们强烈建议您仅在以下情况下才强制故障转移：您必须立即将服务还原到可用性组并且您愿意承担丢失数据的风险。</span><span class="sxs-lookup"><span data-stu-id="213c9-106">Therefore, we strongly recommend that you force failover only if you must restore service to the availability group immediately and you are willing to risk losing data.</span></span>  
  
 <span data-ttu-id="213c9-107">执行强制故障转移之后，可用性组故障转移到的故障转移目标将变成新的主副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-107">After a forced failover, the failover target to which the availability group was failed over becomes the new primary replica.</span></span> <span data-ttu-id="213c9-108">剩余辅助副本中的辅助数据库将会挂起并且必须手动恢复。</span><span class="sxs-lookup"><span data-stu-id="213c9-108">The secondary databases in the remaining secondary replicas are suspended and must be manually resumed.</span></span> <span data-ttu-id="213c9-109">当以前的主副本变为可用时，该副本将转换为辅助角色，这导致以前的主数据库变成辅助数据库并转换为 SUSPENDED 状态。</span><span class="sxs-lookup"><span data-stu-id="213c9-109">When the former primary replica becomes available, it transitions to the secondary role, causing the former primary databases to become secondary databases and transition into the SUSPENDED state.</span></span> <span data-ttu-id="213c9-110">在恢复某一给定的辅助数据库之前，您可能能够从其还原丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="213c9-110">Before you resume a given secondary database, you might be able to recover lost data from it.</span></span> <span data-ttu-id="213c9-111">但请注意，在其任何辅助数据库被挂起时，事务日志截断在给定的主数据库上被延迟。</span><span class="sxs-lookup"><span data-stu-id="213c9-111">However, notice that transaction log truncation is delayed on a given primary database while any of its secondary databases is suspended.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="213c9-112">在恢复辅助数据库之前，不会与主数据库进行数据同步。</span><span class="sxs-lookup"><span data-stu-id="213c9-112">Data synchronization with the primary database will not occur until the secondary database is resumed.</span></span> <span data-ttu-id="213c9-113">有关恢复辅助数据库的信息，请参阅本文后面部分的[跟进：强制故障转移后的重要任务](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="213c9-113">For information about resuming a secondary database, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp) later in this article.</span></span>  
  
 <span data-ttu-id="213c9-114">在以下紧急情况下需要执行强制的故障转移：</span><span class="sxs-lookup"><span data-stu-id="213c9-114">Performing a forced failover is necessary in the following emergency situations:</span></span>  
  
-   <span data-ttu-id="213c9-115">在对 WSFC 群集执行强制仲裁（“强制仲裁”  ）后，你需要强制故障转移每个可用性组（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="213c9-115">After forcing quorum on the WSFC cluster (*forced quorum*), you need to force failover each availability group (with possible data loss).</span></span> <span data-ttu-id="213c9-116">强制故障转移是必需的，因为 WSFC 群集值的真实状态可能已丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-116">Forcing failover is required because the real state of the WSFC cluster values might have been lost.</span></span> <span data-ttu-id="213c9-117">但是，如果您在强制仲裁前能够在承载作为主副本的副本的服务器实例上强制故障转移，或者在强制仲裁前能够故障转移到已同步的辅助副本，则可以避免数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-117">However, you can avoid data loss, if are able to force failover on the server instance that was hosting the replica that was the primary replica before you forced quorum or to a secondary replica that was synchronized before you forced quorum.</span></span> <span data-ttu-id="213c9-118">有关详细信息，请参阅本主题后面的 [强制仲裁后避免数据丢失的可能方法](#WaysToAvoidDataLoss)。</span><span class="sxs-lookup"><span data-stu-id="213c9-118">For more information, see [Potential Ways to Avoid Data Loss After Quorum is Forced](#WaysToAvoidDataLoss), later in this topic.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="213c9-119">如果仲裁以自然的方式重新获得而不是强制进行的，则可用性副本将经历正常的恢复工程。</span><span class="sxs-lookup"><span data-stu-id="213c9-119">If quorum is regained by natural means instead of being forced, the availability replicas will go through normal recovery.</span></span> <span data-ttu-id="213c9-120">如果在重新获得仲裁后主副本仍不可用，则您可以执行计划的手动故障转移到同步的辅助副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-120">If the primary replica is still unavailable after quorum is regained, you can perform a planned manual failover to a synchronized secondary replica.</span></span>  
  
     <span data-ttu-id="213c9-121">有关强制仲裁的详细信息，请参阅 [通过强制仲裁进行 WSFC 灾难恢复 (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)或 PowerShell 对 AlwaysOn 可用性组执行强制故障转移（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="213c9-121">For information about forcing quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span> <span data-ttu-id="213c9-122">有关为什么需要在强制仲裁后强制执行故障转移的信息，请参阅[故障转移和故障转移模式（AlwaysOn 可用性组）](failover-and-failover-modes-always-on-availability-groups.md)。</span><span class="sxs-lookup"><span data-stu-id="213c9-122">For information about why forcing failover is required after forcing quorum, see [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
-   <span data-ttu-id="213c9-123">如果在 WSFC 群集具有运行状况正常的仲裁时主副本变得不可用，则您可以强制故障转移（可能会丢失数据）到其角色处于 SECONDARY 或 RESOLVING 状态的任何副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-123">If the primary replica becomes unavailable when the WSFC cluster has a healthy quorum, you can force failover (with possible data loss), to any replica whose role is in the SECONDARY or RESOLVING state.</span></span> <span data-ttu-id="213c9-124">如果可能，应强制故障转移到在主副本丢失时处于同步状态的同步提交辅助副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-124">If possible, force failover to a synchronous-commit secondary replica that was synchronized when the primary replica was lost.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="213c9-125">在 WSFC 群集具有运行状况正常的仲裁时，如果对已同步的辅助副本发出强制故障转移命令，则该副本实际将执行计划的手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="213c9-125">When the WSFC cluster has a healthy quorum, if you issue a force failover command on a synchronized secondary replica, the replica actually performs a planned manual failover.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="213c9-126">有关强制故障转移的先决条件和建议的详细信息，以及使用强制故障转移从灾难性故障中恢复的示例应用场景，请参阅本主题后面部分的[示例应用场景：使用强制故障转移从灾难性故障中恢复](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy)。</span><span class="sxs-lookup"><span data-stu-id="213c9-126">For more information about the prerequisites and recommendations for forcing failover and for an example scenario that uses a forced failover to recover from a catastrophic failure, see [Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md#ExampleRecoveryFromCatastrophy), later in this topic.</span></span>  
  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="213c9-127">开始之前</span><span class="sxs-lookup"><span data-stu-id="213c9-127">Before You Begin</span></span>  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> <span data-ttu-id="213c9-128">限制和局限</span><span class="sxs-lookup"><span data-stu-id="213c9-128">Limitations and Restrictions</span></span>  
  
-   <span data-ttu-id="213c9-129">不能执行强制故障转移的唯一时间是在 Windows Server 故障转移群集 (WSFC) 群集缺少仲裁时。</span><span class="sxs-lookup"><span data-stu-id="213c9-129">The only time that you cannot perform a forced failover is when Windows Server Failover Clustering (WSFC) cluster lacks quorum.</span></span>  
  
-   <span data-ttu-id="213c9-130">在可用性组强制故障转移期间可能会丢失数据。</span><span class="sxs-lookup"><span data-stu-id="213c9-130">Data loss is possible during the forced failover of an availability group.</span></span> <span data-ttu-id="213c9-131">此外，如果在启动强制故障转移时主副本正在运行，客户端可能仍连接到以前的主数据库。</span><span class="sxs-lookup"><span data-stu-id="213c9-131">In addition, if the primary replica is running when you initiate a forced failover, clients might still be connected to former primary databases.</span></span> <span data-ttu-id="213c9-132">因此，我们强烈建议您仅在以下情况下才强制执行故障转移：主副本不再运行，并且您为了还原对可用性组中数据库的访问而愿意承担丢失数据的风险。</span><span class="sxs-lookup"><span data-stu-id="213c9-132">Therefore, we strongly recommend that you force failover only if the primary replica is no longer running and if you are willing to risk losing data in order to restore access to databases in the availability group.</span></span>  
  
-   <span data-ttu-id="213c9-133">当辅助数据库处于 REVERTING 或 INITIALIZING 状态时，强制故障转移将导致该数据库无法作为主数据库启动。</span><span class="sxs-lookup"><span data-stu-id="213c9-133">When a secondary database in the REVERTING or INITIALIZING state, forcing failover would cause the database to fail to start as a primary database.</span></span> <span data-ttu-id="213c9-134">如果数据库处于 INTIAILIZGING 状态，则您将需要从数据库备份应用丢失的日志记录或者完全从头还原数据库。</span><span class="sxs-lookup"><span data-stu-id="213c9-134">If the database was in the INTIAILIZGING state the you will need to apply the missing log records from a database backup or fully restore the database from scratch.</span></span> <span data-ttu-id="213c9-135">如果数据库处于 REVERTING 状态，则您将需要从备份完全还原数据库。</span><span class="sxs-lookup"><span data-stu-id="213c9-135">If the database was in the REVERTING state you will need to fully restore the database from backups.</span></span>  
  
-   <span data-ttu-id="213c9-136">故障转移命令将在故障转移目标接受它之后立即返回。</span><span class="sxs-lookup"><span data-stu-id="213c9-136">A failover command returns as soon as the failover target has accepted the command.</span></span> <span data-ttu-id="213c9-137">但是，在可用性组完成故障转移之后，数据库恢复操作将以异步方式执行。</span><span class="sxs-lookup"><span data-stu-id="213c9-137">However, database recovery occurs asynchronously after the availability group has finished failing over.</span></span>  
  
-   <span data-ttu-id="213c9-138">故障转移时，不维护可用性组中数据库间的跨数据库一致性。</span><span class="sxs-lookup"><span data-stu-id="213c9-138">Cross-database consistency across databases within the availability group is not maintained on failover.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="213c9-139">[!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 不支持跨数据库事务和分布式事务。</span><span class="sxs-lookup"><span data-stu-id="213c9-139">Cross-database transactions and distributed transactions are not supported by [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="213c9-140">有关详细信息，请参阅[数据库镜像或 AlwaysOn 可用性组不支持跨数据库事务 (SQL Server)](transactions-always-on-availability-and-database-mirroring.md)。</span><span class="sxs-lookup"><span data-stu-id="213c9-140">For more information, see [Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md).</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a><span data-ttu-id="213c9-141">先决条件</span><span class="sxs-lookup"><span data-stu-id="213c9-141">Prerequisites</span></span>  
  
-   <span data-ttu-id="213c9-142">WSFC 群集具有仲裁。</span><span class="sxs-lookup"><span data-stu-id="213c9-142">The WSFC cluster has quorum.</span></span> <span data-ttu-id="213c9-143">如果群集缺乏仲裁，请参阅 [通过强制仲裁进行 WSFC 灾难恢复 (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)或 PowerShell 对 AlwaysOn 可用性组执行强制故障转移（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="213c9-143">If the cluster lacks quorum, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
-   <span data-ttu-id="213c9-144">您必须能够连接到承载其角色处于 SECONDARY 或 RESOLVING 状态的副本的服务器实例。</span><span class="sxs-lookup"><span data-stu-id="213c9-144">You must be able to connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state.</span></span>  
  
###  <a name="recommendations"></a><a name="Recommendations"></a> <span data-ttu-id="213c9-145">建议</span><span class="sxs-lookup"><span data-stu-id="213c9-145">Recommendations</span></span>  
  
-   <span data-ttu-id="213c9-146">主副本仍在运行时，请勿进行强制故障转移。</span><span class="sxs-lookup"><span data-stu-id="213c9-146">Do not force failover while the primary replica is still running.</span></span>  
  
-   <span data-ttu-id="213c9-147">如果可能，仅强制故障转移到其辅助数据库处于 NOT SYNCHRONIZED、SYNCHRONIZED 或 SYNCHRONIZING 状态的故障转移目标。</span><span class="sxs-lookup"><span data-stu-id="213c9-147">If possible, force failover only to a failover target whose secondary databases are either in the NOT SYNCHRONIZED, SYNCHRONIZED, or SYNCHRONIZING state.</span></span> <span data-ttu-id="213c9-148">有关在辅助数据库处于 INTIAILIZGING 或 REVERTING 状态时强制故障转移的意义的信息，请参阅本主题中前面的 [限制和局限](#Restrictions)。</span><span class="sxs-lookup"><span data-stu-id="213c9-148">For information about the implications of forcing failover when a secondary database is in the INTIAILIZGING or REVERTING state, see [Limitations and Restrictions](#Restrictions), earlier in this topic.</span></span>  
  
-   <span data-ttu-id="213c9-149">通常情况下，给定的辅助数据库的延迟（相对于主数据库）在不同的异步提交辅助副本上应该是相似的。</span><span class="sxs-lookup"><span data-stu-id="213c9-149">Typically, the latency of a given secondary database, relative to the primary database, should be similar on different asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="213c9-150">但在强制故障转移时，数据丢失问题可能会比较突出。</span><span class="sxs-lookup"><span data-stu-id="213c9-150">However, when forcing failover, data loss can be a significant concern.</span></span> <span data-ttu-id="213c9-151">因此，应该考虑花些时间来确定数据库在不同辅助副本上的相对延迟。</span><span class="sxs-lookup"><span data-stu-id="213c9-151">Therefore, consider taking time to determine the relative latency of the copies of the databases on different secondary replicas.</span></span> <span data-ttu-id="213c9-152">若要确定某一给定辅助数据库的哪一副本具有最少的延迟，请比较其日志末尾 LSN。</span><span class="sxs-lookup"><span data-stu-id="213c9-152">To determine which copy of a given secondary database has the least latency, compare their end-of-log LSNs.</span></span> <span data-ttu-id="213c9-153">更高的日志末尾 LSN 指示更少的延迟。</span><span class="sxs-lookup"><span data-stu-id="213c9-153">A higher the end-of-log LSN indicates less latency.</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="213c9-154">若要比较日志末尾 LSN，请连接到各在线次要副本，并且针对每个本地辅助数据库的 [end_of_log_lsn](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) 值查询 **sys.dm_hadr_database_replica_states** 。</span><span class="sxs-lookup"><span data-stu-id="213c9-154">To compare end-of-log LSNs, connect to each online secondary replica, in turn, and query [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) for the **end_of_log_lsn** value of each local secondary database.</span></span> <span data-ttu-id="213c9-155">然后，比较每个数据库的不同副本的日志末尾 LSN。</span><span class="sxs-lookup"><span data-stu-id="213c9-155">Then, compare the end-of-log LSNs of the different copies of each database.</span></span> <span data-ttu-id="213c9-156">请注意，不同的数据库可能在不同的辅助副本上具有其最高 LSN。</span><span class="sxs-lookup"><span data-stu-id="213c9-156">Note that different databases might have their highest LSNs on different secondary replicas.</span></span> <span data-ttu-id="213c9-157">在本例中，最合适的故障转移目标取决于对于不同数据库中的数据的相对重要性。</span><span class="sxs-lookup"><span data-stu-id="213c9-157">In this case, the most appropriate failover target depends on the relative importance that you place on the data in the different databases.</span></span> <span data-ttu-id="213c9-158">也就是说，在这些数据库中，您最希望减小哪个数据库中可能的数据丢失？</span><span class="sxs-lookup"><span data-stu-id="213c9-158">That is, for which of these databases would you most want to minimize possible data loss?</span></span>  
  
-   <span data-ttu-id="213c9-159">如果客户端无法连接到原始主副本，则强制故障转移可能会导致某些“裂脑”风险。</span><span class="sxs-lookup"><span data-stu-id="213c9-159">If clients are able to connect to the original primary, a forced failover incurs some risk of split brain behavior.</span></span> <span data-ttu-id="213c9-160">在强制故障转移之前，强烈建议您禁止客户端访问原始主副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-160">Before you force failover, we strongly recommend that you prevent clients from accessing the original primary replica.</span></span> <span data-ttu-id="213c9-161">否则，在强制故障转移之后，原始主数据库和当前主数据库便会分别进行更新。</span><span class="sxs-lookup"><span data-stu-id="213c9-161">Otherwise, after failover is forced, the original primary databases and the current primary databases could be updated independently of the other.</span></span>  
  
###  <a name="potential-ways-to-avoid-data-loss-after-quorum-is-forced"></a><a name="WaysToAvoidDataLoss"></a> <span data-ttu-id="213c9-162">强制仲裁后避免数据丢失的可能方法</span><span class="sxs-lookup"><span data-stu-id="213c9-162">Potential Ways to Avoid Data Loss After Quorum is Forced</span></span>  
 <span data-ttu-id="213c9-163">在仲裁后的一些失败条件下，您可以避免数据丢失，如下所示：</span><span class="sxs-lookup"><span data-stu-id="213c9-163">Under some failure conditions after quorum is lost, you can avoid prevent data loss, as follows:</span></span>  
  
-   <span data-ttu-id="213c9-164">**如果原始主副本处于联机状态**</span><span class="sxs-lookup"><span data-stu-id="213c9-164">**If the original primary replica comes online**</span></span>  
  
     <span data-ttu-id="213c9-165">如果仲裁丢失并且强制 WSFC 仲裁还原承载某一可用性组的主副本的群集节点，则对于此可用性组您可以避免数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-165">If quorum is lost and forcing WSFC quorum restores the cluster node that hosts the primary replica of an availability group, you can prevent data loss for this availability group.</span></span> <span data-ttu-id="213c9-166">连接到主副本并且执行强制故障转移 (FAILOVER_ALLOW_DATA_LOSS)。</span><span class="sxs-lookup"><span data-stu-id="213c9-166">Connect to the primary replica and perform a forced failover (FAILOVER_ALLOW_DATA_LOSS).</span></span> <span data-ttu-id="213c9-167">此操作将使主副本恢复联机状态。</span><span class="sxs-lookup"><span data-stu-id="213c9-167">This brings the primary replica back online.</span></span> <span data-ttu-id="213c9-168">因为您执行强制故障转移到原始主副本，所以不会有数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-168">Because you perform the forced failover to the original primary replica, there is no data loss.</span></span>  
  
-   <span data-ttu-id="213c9-169">**如果已同步的同步提交辅助副本处于联机状态**</span><span class="sxs-lookup"><span data-stu-id="213c9-169">**If a synchronized synchronous-commit secondary replica comes online**</span></span>  
  
     <span data-ttu-id="213c9-170">如果仲裁丢失并且强制 WSFC 仲裁还原承载某一可用性组的已同步辅助副本的群集节点，则对于此可用性组您应该能够避免数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-170">If quorum is lost and forcing WSFC quorum restores a cluster node that hosts a synchronized secondary replica for an availability group, you should be able to prevent data loss for this availability group.</span></span> <span data-ttu-id="213c9-171">如果在丢失仲裁时还原的节点已启动，则可以通过查询 **sys.dm_hadr_database_replica_cluster_states** 动态管理视图的 [is_failover_ready](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) 列确定给定数据库上是否发生了数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-171">If the restored node was up at the time that quorum was lost, you can determine whether data loss could occur on a given database by querying the **is_failover_ready** column of the [sys.dm_hadr_database_replica_cluster_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-cluster-states-transact-sql) dynamic management view.</span></span> <span data-ttu-id="213c9-172">例如，对于名为 `sql108w2k8r22`的服务器实例，发出以下查询：</span><span class="sxs-lookup"><span data-stu-id="213c9-172">For example, for a server instance named `sql108w2k8r22`, issue the following query:</span></span>  
  
    ```  
    SELECT * FROM sys.dm_hadr_database_replica_cluster_states  
       WHERE replica_id=(SELECT replica_id FROM sys.availability_replicas   
          WHERE replica_server_name ='sql108w2k8r22')  
    ```  
  
    > [!CAUTION]  
    >  <span data-ttu-id="213c9-173">如果在丢失仲裁时还原的节点未启动，则 **is_failover_ready** 可能不会反映在主要副本处于脱机状态时该群集的实际状态。</span><span class="sxs-lookup"><span data-stu-id="213c9-173">If the restored node was not up at the time quorum was lost, **is_failover_ready** may not reflect the cluster's actual state at the time the primary replica went offline.</span></span> <span data-ttu-id="213c9-174">因此， **is_failover_ready** 值是在主机节点处于失败时唯一合适的值。</span><span class="sxs-lookup"><span data-stu-id="213c9-174">Therefore, the **is_failover_ready** value is only good if the host node at the time of the failure.</span></span> <span data-ttu-id="213c9-175">有关详细信息，请参阅[故障转移和故障转移模式（AlwaysOn 可用性组）](failover-and-failover-modes-always-on-availability-groups.md)中的“为什么需要在强制仲裁后强制执行故障转移”。</span><span class="sxs-lookup"><span data-stu-id="213c9-175">For more information, see "Why Forced Failover is Required After Forcing Quorum" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="213c9-176">如果 **is_failover_ready** = 1，则数据库将在群集中标记为已同步并且可供故障转移。</span><span class="sxs-lookup"><span data-stu-id="213c9-176">If **is_failover_ready** = 1, the database is marked as synchronized in the cluster and is ready for a failover.</span></span> <span data-ttu-id="213c9-177">如果在某一给定次要副本的每个数据库上 **is_failover_ready** = 1，则你可以执行强制故障转移 (FORCE_FAILOVER_ALLOW_DATA_LOSS) 并且在此次要副本上不会丢失数据。</span><span class="sxs-lookup"><span data-stu-id="213c9-177">If **is_failover_ready** = 1 on every database on a given secondary replica, you can perform a forced failover (FORCE_FAILOVER_ALLOW_DATA_LOSS) without data loss on this secondary replica.</span></span> <span data-ttu-id="213c9-178">该同步的辅助副本在主角色中处于联机状态，也就是说，作为新的主副本并且所有数据保持不变。</span><span class="sxs-lookup"><span data-stu-id="213c9-178">The synchronized secondary replica comes online in the primary role, that is, as the new primary replica, with all the data intact.</span></span>  
  
     <span data-ttu-id="213c9-179">如果 **is_failover_ready** = 0，则数据库在群集中将不标记为已同步并且 *不* 可用于计划的手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="213c9-179">If **is_failover_ready** = 0, the database is not marked as synchronized in the cluster and is *not* ready for a planned manual failover.</span></span> <span data-ttu-id="213c9-180">如果您强制故障转移到主机辅助副本，则在此数据库上数据将丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-180">If you force failover to the host secondary replica, data will be lost on this database.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="213c9-181">在您强制故障转移到辅助副本时，丢失的数据量将取决于故障转移目标落在主副本之后有多远。</span><span class="sxs-lookup"><span data-stu-id="213c9-181">When you force failover to a secondary replica, the amount of data loss will depend on how far the failover target is lagging behind the primary replica.</span></span> <span data-ttu-id="213c9-182">但是，在 WSFC 群集缺少仲裁或者仲裁已被强制时，您不能评估可能的数据丢失量。</span><span class="sxs-lookup"><span data-stu-id="213c9-182">Unfortunately, when the WSFC cluster lacks quorum or quorum has been forced, you cannot assess the amount of potential data loss.</span></span> <span data-ttu-id="213c9-183">但请注意，一旦 WSFC 群集重新获得运行状况正常的仲裁后，您可以开始跟踪可能的数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-183">Note, however, that once the WSFC cluster regains a healthy quorum, you could begin to track potential data loss.</span></span> <span data-ttu-id="213c9-184">有关详细信息，请参阅[故障转移和故障转移模式（AlwaysOn 可用性组）](failover-and-failover-modes-always-on-availability-groups.md)中的“跟踪可能的数据丢失”。</span><span class="sxs-lookup"><span data-stu-id="213c9-184">For more information, see "Tracking Potential Data Loss" in [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="213c9-185">Security</span><span class="sxs-lookup"><span data-stu-id="213c9-185">Security</span></span>  
  
####  <a name="permissions"></a><a name="Permissions"></a> <span data-ttu-id="213c9-186">权限</span><span class="sxs-lookup"><span data-stu-id="213c9-186">Permissions</span></span>  
 <span data-ttu-id="213c9-187">对可用性组要求 ALTER AVAILABILITY GROUP 权限、CONTROL AVAILABILITY GROUP 权限、ALTER ANY AVAILABILITY GROUP 权限或 CONTROL SERVER 权限。</span><span class="sxs-lookup"><span data-stu-id="213c9-187">Requires ALTER AVAILABILITY GROUP permission on the availability group, CONTROL AVAILABILITY GROUP permission, ALTER ANY AVAILABILITY GROUP permission, or CONTROL SERVER permission.</span></span>  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="213c9-188">使用 SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="213c9-188">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="213c9-189">**强制故障转移（可能丢失数据）**</span><span class="sxs-lookup"><span data-stu-id="213c9-189">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="213c9-190">在对象资源管理器中，连接到一个服务器实例，该服务器实例承载需要进行故障转移的可用性组中其角色处于 SECONDARY 或 RESOLVING 状态的副本，然后展开服务器树。</span><span class="sxs-lookup"><span data-stu-id="213c9-190">In Object Explorer, connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over, and expand the server tree.</span></span>  
  
2.  <span data-ttu-id="213c9-191">依次展开 **“AlwaysOn 高可用性”** 节点和 **“可用性组”** 节点。</span><span class="sxs-lookup"><span data-stu-id="213c9-191">Expand the **AlwaysOn High Availability** node and the **Availability Groups** node.</span></span>  
  
3.  <span data-ttu-id="213c9-192">右键单击要进行故障转移的可用性组，然后选择“故障转移”  命令。</span><span class="sxs-lookup"><span data-stu-id="213c9-192">Right-click the availability group to be failed over, and select the **Failover** command.</span></span>  
  
4.  <span data-ttu-id="213c9-193">这将启动“故障转移可用性组向导”。</span><span class="sxs-lookup"><span data-stu-id="213c9-193">This launches the Failover Availability Group Wizard.</span></span> <span data-ttu-id="213c9-194">有关详细信息，请参阅本主题后面的 [使用故障转移可用性组向导 (SQL Server Management Studio)](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)或 PowerShell 对 AlwaysOn 可用性组执行强制故障转移（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="213c9-194">For more information, see [Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md).</span></span>  
  
5.  <span data-ttu-id="213c9-195">强制可用性组进行故障转移之后，请完成必要的后续步骤。</span><span class="sxs-lookup"><span data-stu-id="213c9-195">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="213c9-196">有关详细信息，请参阅本主题后面部分的[跟进：强制故障转移后的重要任务](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="213c9-196">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="213c9-197">使用 Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="213c9-197">Using Transact-SQL</span></span>  
 <span data-ttu-id="213c9-198">**强制故障转移（可能丢失数据）**</span><span class="sxs-lookup"><span data-stu-id="213c9-198">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="213c9-199">连接到一个服务器实例，该服务器实例承载需要进行故障转移的可用性组中其角色处于 SECONDARY 或 RESOLVING 状态的副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-199">Connect to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="213c9-200">按如下所示使用 [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) 语句：</span><span class="sxs-lookup"><span data-stu-id="213c9-200">Use the [ALTER AVAILABILITY GROUP](/sql/t-sql/statements/alter-availability-group-transact-sql) statement, as follows:</span></span>  
  
     <span data-ttu-id="213c9-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span><span class="sxs-lookup"><span data-stu-id="213c9-201">ALTER AVAILABILITY GROUP *group_name* FORCE_FAILOVER_ALLOW_DATA_LOSS</span></span>  
  
     <span data-ttu-id="213c9-202">其中， *group_name* 是可用性组的名称。</span><span class="sxs-lookup"><span data-stu-id="213c9-202">where *group_name* is the name of the availability group.</span></span>  
  
     <span data-ttu-id="213c9-203">下面的示例强制 `AccountsAG` 可用性组故障转移到本地辅助副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-203">The following example forces the `AccountsAG` availability group to fail over to the local secondary replica.</span></span>  
  
    ```sql
    ALTER AVAILABILITY GROUP AccountsAG FORCE_FAILOVER_ALLOW_DATA_LOSS;  
    ```  
  
3.  <span data-ttu-id="213c9-204">强制可用性组进行故障转移之后，请完成必要的后续步骤。</span><span class="sxs-lookup"><span data-stu-id="213c9-204">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="213c9-205">有关详细信息，请参阅本主题后面部分的[跟进：强制故障转移后的重要任务](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="213c9-205">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
##  <a name="using-powershell"></a><a name="PowerShellProcedure"></a> <span data-ttu-id="213c9-206">使用 PowerShell</span><span class="sxs-lookup"><span data-stu-id="213c9-206">Using PowerShell</span></span>  
 <span data-ttu-id="213c9-207">**强制故障转移（可能丢失数据）**</span><span class="sxs-lookup"><span data-stu-id="213c9-207">**To force failover (with possible data loss)**</span></span>  
  
1.  <span data-ttu-id="213c9-208">更改目录 (`cd`) 服务器实例，该服务器实例承载其角色在需要进行故障转移的可用性组中处于辅助或正在解析状态的副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-208">Change directory (`cd`) to a server instance that hosts a replica whose role is in the SECONDARY or RESOLVING state in the availability group that needs to be failed over.</span></span>  
  
2.  <span data-ttu-id="213c9-209">以下列形式之一使用 `Switch-SqlAvailabilityGroup` cmdlet 以及 `AllowDataLoss` 参数：</span><span class="sxs-lookup"><span data-stu-id="213c9-209">Use the `Switch-SqlAvailabilityGroup` cmdlet with the `AllowDataLoss` parameter in one of the following forms:</span></span>  
  
    -   `-AllowDataLoss`  
  
         <span data-ttu-id="213c9-210">默认情况下，`-AllowDataLoss` 参数会让 `Switch-SqlAvailabilityGroup` 向您进行提示，以提醒您强制故障转移可能会导致丢失未提交的事务，并请求确认。</span><span class="sxs-lookup"><span data-stu-id="213c9-210">By default `-AllowDataLoss` parameter causes `Switch-SqlAvailabilityGroup` to prompt you to remind you that forcing failover might result in the loss of uncommitted transactions and to request confirmation.</span></span> <span data-ttu-id="213c9-211">若要继续，请输入 `Y`；若要取消操作，请输入 `N`。</span><span class="sxs-lookup"><span data-stu-id="213c9-211">To continue, enter `Y`; to cancel the operation, enter `N`.</span></span>  
  
         <span data-ttu-id="213c9-212">下面的示例对可用性组 `MyAg` 执行强制故障转移（可能会造成数据丢失），以将故障转移到名为 `SecondaryServer\InstanceName`服务器实例上的次要副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-212">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the secondary replica on the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="213c9-213">系统将提示您确认此操作。</span><span class="sxs-lookup"><span data-stu-id="213c9-213">You will be prompted to confirm this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss  
        ```  
  
    -   <span data-ttu-id="213c9-214">**-AllowDataLoss-Force**</span><span class="sxs-lookup"><span data-stu-id="213c9-214">**-AllowDataLoss-Force**</span></span>  
  
         <span data-ttu-id="213c9-215">要启动强制故障转移而无需确认，请同时指定 `-AllowDataLoss` 和 `-Force` 参数。</span><span class="sxs-lookup"><span data-stu-id="213c9-215">To initiate a forced failover without confirmation, specify both the `-AllowDataLoss` and `-Force` parameters.</span></span> <span data-ttu-id="213c9-216">如果您要在脚本中包含此命令而无需用户交互来运行它，此操作很有用。</span><span class="sxs-lookup"><span data-stu-id="213c9-216">This is useful if you want to include the command in a script and run it without user interaction.</span></span>  <span data-ttu-id="213c9-217">但是，应慎重使用 `-Force` 选项，因为强制故障转移可能导致参与可用性组的数据库中的数据丢失。</span><span class="sxs-lookup"><span data-stu-id="213c9-217">However, use the `-Force` option with caution, because a forced failover might result in the loss of data from databases participating the availability group.</span></span>  
  
         <span data-ttu-id="213c9-218">下面的示例将对可用性组 `MyAg` 执行强制故障转移（可能造成数据丢失），以将故障转移到名为 `SecondaryServer\InstanceName`的服务器实例。</span><span class="sxs-lookup"><span data-stu-id="213c9-218">The following example performs a forced failover (with possible data loss) of the availability group `MyAg` to the server instance named `SecondaryServer\InstanceName`.</span></span> <span data-ttu-id="213c9-219"> 选项将取消确认此操作。</span><span class="sxs-lookup"><span data-stu-id="213c9-219">The `-Force` option suppresses confirmation of this operation.</span></span>  
  
        ```powershell
        Switch-SqlAvailabilityGroup -Path SQLSERVER:\Sql\SecondaryServer\InstanceName\AvailabilityGroups\MyAg -AllowDataLoss -Force  
        ```  
  
    > [!NOTE]  
    >  <span data-ttu-id="213c9-220">若要查看 cmdlet 的语法，请在 `Get-Help` PowerShell 环境中使用 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] cmdlet。</span><span class="sxs-lookup"><span data-stu-id="213c9-220">To view the syntax of a cmdlet, use the `Get-Help` cmdlet in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] PowerShell environment.</span></span> <span data-ttu-id="213c9-221">有关详细信息，请参阅 [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md)。</span><span class="sxs-lookup"><span data-stu-id="213c9-221">For more information, see [Get Help SQL Server PowerShell](../../../powershell/sql-server-powershell.md).</span></span>  
  
3.  <span data-ttu-id="213c9-222">强制可用性组进行故障转移之后，请完成必要的后续步骤。</span><span class="sxs-lookup"><span data-stu-id="213c9-222">After forcing an availability group to fail over, complete the necessary follow-up steps.</span></span> <span data-ttu-id="213c9-223">有关详细信息，请参阅本主题后面部分的[跟进：强制故障转移后的重要任务](#FollowUp)。</span><span class="sxs-lookup"><span data-stu-id="213c9-223">For more information, see [Follow Up: Essential Tasks After a Forced Failover](#FollowUp), later in this topic.</span></span>  
  
 <span data-ttu-id="213c9-224">**设置和使用 SQL Server PowerShell 提供程序**</span><span class="sxs-lookup"><span data-stu-id="213c9-224">**To set up and use the SQL Server PowerShell provider**</span></span>  
  
-   [<span data-ttu-id="213c9-225">SQL Server PowerShell 提供程序</span><span class="sxs-lookup"><span data-stu-id="213c9-225">SQL Server PowerShell Provider</span></span>](../../../powershell/sql-server-powershell-provider.md)  
  
##  <a name="follow-up-essential-tasks-after-a-forced-failover"></a><a name="FollowUp"></a> <span data-ttu-id="213c9-226">跟进：强制故障转移后的重要任务</span><span class="sxs-lookup"><span data-stu-id="213c9-226">Follow Up: Essential Tasks After a Forced Failover</span></span>  
  
1.  <span data-ttu-id="213c9-227">执行强制故障转移之后，故障转移到的辅助副本将变成新的主副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-227">After a forced failover, the secondary replica to which you failed over becomes the new primary replica.</span></span> <span data-ttu-id="213c9-228">但是，要使客户端可访问可用性副本，您可能需要重新配置 WSFC 仲裁或调整可用性组的可用性模式配置，如下所示：</span><span class="sxs-lookup"><span data-stu-id="213c9-228">However, to make that availability replica accessible to clients, you might need to reconfigure the WSFC quorum or adjust the availability-mode configuration of the availability group, as follows:</span></span>  
  
    -   <span data-ttu-id="213c9-229">如果将故障转移到 [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] 之外  ：调整 WSFC 节点的仲裁投票，以反映新的可用性组配置。</span><span class="sxs-lookup"><span data-stu-id="213c9-229">**If you failed over outside of the [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]:**  Adjust the quorum votes of the WSFC nodes to reflect your new availability group configuration.</span></span> <span data-ttu-id="213c9-230">如果承载目标辅助副本的 WSFC 节点不具有 WSFC 仲裁投票，则可能需要强制 WSFC 仲裁。</span><span class="sxs-lookup"><span data-stu-id="213c9-230">If the WSFC node that hosts the target secondary replica does not have a WSFC quorum vote, you might need to force WSFC quorum.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="213c9-231">仅当两个可用性副本（包含之前的主副本）都配置为使用同步提交模式和自动故障转移时， [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] 才存在。</span><span class="sxs-lookup"><span data-stu-id="213c9-231">An [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)] exists only if two availability replicas (including the previous primary replica) are configured for synchronous-commit mode with automatic failover.</span></span>  
  
         <span data-ttu-id="213c9-232">**调整仲裁投票**</span><span class="sxs-lookup"><span data-stu-id="213c9-232">**To adjust quorum votes**</span></span>  
  
        -   [<span data-ttu-id="213c9-233">查看群集仲裁 NodeWeight 设置</span><span class="sxs-lookup"><span data-stu-id="213c9-233">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="213c9-234">配置群集仲裁 NodeWeight 设置</span><span class="sxs-lookup"><span data-stu-id="213c9-234">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
        -   [<span data-ttu-id="213c9-235">在无仲裁情况下强制启动 WSFC 群集</span><span class="sxs-lookup"><span data-stu-id="213c9-235">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
    -   <span data-ttu-id="213c9-236">如果将故障转移到 [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] 之外  ：我们建议你考虑调整新的主要副本上和其他次要副本上的可用性模式和故障转移模式，以反映你所需的同步提交模式和自动故障转移配置。</span><span class="sxs-lookup"><span data-stu-id="213c9-236">**If you failed over outside of the [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]:** We recommend that you consider adjusting the availability mode and failover mode on the new primary replica and on remaining secondary replicas to reflect your desired synchronous-commit and automatic failover configuration.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="213c9-237">只有在当前主副本配置为同步提交模式时， [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] 才存在。</span><span class="sxs-lookup"><span data-stu-id="213c9-237">A [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)] exists only if the current primary replica is configured for synchronous-commit mode.</span></span>  
  
         <span data-ttu-id="213c9-238">**更改可用性模式和故障转移模式**</span><span class="sxs-lookup"><span data-stu-id="213c9-238">**To change the availability mode and failover mode**</span></span>  
  
        -   [<span data-ttu-id="213c9-239">更改可用性副本的可用性模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-239">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)  
  
        -   [<span data-ttu-id="213c9-240">更改可用性副本的故障转移模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-240">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
2.  <span data-ttu-id="213c9-241">强制故障转移后，所有辅助数据库都处于挂起状态。</span><span class="sxs-lookup"><span data-stu-id="213c9-241">After a forced failover, all secondary databases are suspended.</span></span> <span data-ttu-id="213c9-242">这包括以前的主数据库（在以前的主副本返回到联机状态并且发现它现在是辅助副本后）。</span><span class="sxs-lookup"><span data-stu-id="213c9-242">This includes the former primary databases, after the former primary replica comes back online and discovers that it is now a secondary replica.</span></span> <span data-ttu-id="213c9-243">您必须单独在每个辅助副本上手动恢复每个挂起的数据库。</span><span class="sxs-lookup"><span data-stu-id="213c9-243">You must manually resume each suspended database individually on each secondary replica.</span></span>  
  
     <span data-ttu-id="213c9-244">在恢复辅助数据库时，辅助数据库启动与相应主数据库之间的初始数据同步。</span><span class="sxs-lookup"><span data-stu-id="213c9-244">When a secondary database is resumed, it initiates data synchronization with the corresponding primary database.</span></span> <span data-ttu-id="213c9-245">辅助数据库将回滚从未在新的主数据库上提交的任何日志记录。因此，如果你担心故障转移后的主数据库可能发生数据丢失，你应该尝试在同步提交辅助数据库之一上创建暂停的数据库的数据库快照。</span><span class="sxs-lookup"><span data-stu-id="213c9-245">The secondary database rolls back any log records that were never committed on the new primary database.Therefore, if you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one of the synchronous-commit secondary databases.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="213c9-246">在其任何辅助数据库被挂起时，事务日志截断在主数据库上被延迟。</span><span class="sxs-lookup"><span data-stu-id="213c9-246">Transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="213c9-247">此外，只要任何本地数据库保持挂起状态，同步提交辅助副本的同步运行状况就无法转换到“正常”。</span><span class="sxs-lookup"><span data-stu-id="213c9-247">Also the synchronization health of a synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>  
  
     <span data-ttu-id="213c9-248">**创建数据库快照**</span><span class="sxs-lookup"><span data-stu-id="213c9-248">**To create a database snapshot**</span></span>  
  
    -   [<span data-ttu-id="213c9-249">创建数据库快照 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="213c9-249">Create a Database Snapshot &#40;Transact-SQL&#41;</span></span>](../../../relational-databases/databases/create-a-database-snapshot-transact-sql.md)  
  
     <span data-ttu-id="213c9-250">**恢复可用性数据库**</span><span class="sxs-lookup"><span data-stu-id="213c9-250">**To resume an availability database**</span></span>  
  
    -   [<span data-ttu-id="213c9-251">恢复可用性数据库 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-251">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)  
  
    > [!CAUTION]  
    >  <span data-ttu-id="213c9-252">在恢复所有辅助数据库之后，但在再次尝试故障转移该组之前，请等待下一个故障转移目标上的每个辅助数据库进入 SYNCHRONIZING 状态。</span><span class="sxs-lookup"><span data-stu-id="213c9-252">After resuming all the secondary databases, before attempting to fail over the group again, wait for every secondary database on the next failover target to enter the SYNCHRONIZING state.</span></span> <span data-ttu-id="213c9-253">如果任何数据库尚未处于 SYNCHRONIZING 状态，则将阻止该数据库作为主数据库联机，并且重新建立该数据库的数据同步可能要求还原事务日志、还原完整的数据库备份或故障转移回之前的主副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-253">If any database is not yet SYNCHRONIZING, that database will be prevented from coming online as a primary database, and re-establishing data synchronization for the database might require restoring transaction logs, restoring a full database backup, or failing over back to the previous primary replica.</span></span>  
  
3.  <span data-ttu-id="213c9-254">如果失败的可用性副本将不返回到可用性副本，或返回太迟而延迟了新的主数据库上的事务日志截断，则考虑从该可用性组中删除此失败的副本，以免在针对您的日志文件的磁盘空间不足的情况下运行。</span><span class="sxs-lookup"><span data-stu-id="213c9-254">If an availability replica that failed will not be returning to the availability replica or will return too late for you to delay transaction log truncation on the new primary database, consider removing the failed replica from the availability group to avoid running out of disk space for your log files.</span></span>  
  
     <span data-ttu-id="213c9-255">**删除辅助副本**</span><span class="sxs-lookup"><span data-stu-id="213c9-255">**To remove a secondary replica**</span></span>  
  
    -   [<span data-ttu-id="213c9-256">将次要副本从可用性组删除 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-256">Remove a Secondary Replica from an Availability Group &#40;SQL Server&#41;</span></span>](remove-a-secondary-replica-from-an-availability-group-sql-server.md)  
  
4.  <span data-ttu-id="213c9-257">如果在一个或多个附加强制故障转移后执行一个强制故障转移，请在系列中的每个附加强制故障转移后执行日志备份。</span><span class="sxs-lookup"><span data-stu-id="213c9-257">If you follow a forced failover with one or more additional forced failovers, perform a log backup after each additional forced failover in the series.</span></span> <span data-ttu-id="213c9-258">有关这样做的原因的详细信息，请参阅[故障转移和故障转移模式（AlwaysOn 可用性组）](failover-and-failover-modes-always-on-availability-groups.md)中“强制手动故障转移（可能丢失数据）”部分中的“强制故障转移的风险”。</span><span class="sxs-lookup"><span data-stu-id="213c9-258">For information about the reason for this, see "Risks of Forcing Failover" in the "Forced Manual Failover (with Possible Data Loss)" section of [Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md).</span></span>  
  
     <span data-ttu-id="213c9-259">**执行日志备份**</span><span class="sxs-lookup"><span data-stu-id="213c9-259">**To perform a log backup**</span></span>  
  
    -   [<span data-ttu-id="213c9-260">备份事务日志 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-260">Back Up a Transaction Log &#40;SQL Server&#41;</span></span>](../../../relational-databases/backup-restore/back-up-a-transaction-log-sql-server.md)  
  
##  <a name="example-scenario-using-a-forced-failover-to-recover-from-a-catastrophic-failure"></a><a name="ExampleRecoveryFromCatastrophy"></a> <span data-ttu-id="213c9-261">示例应用场景：使用强制故障转移从灾难性故障中恢复</span><span class="sxs-lookup"><span data-stu-id="213c9-261">Example Scenario: Using a Forced Failover to Recover from a Catastrophic Failure</span></span>  
 <span data-ttu-id="213c9-262">如果主副本失败并且没有同步的辅助副本可用，则强制可用性组进行故障转移可能是适当的反应。</span><span class="sxs-lookup"><span data-stu-id="213c9-262">If the primary replica fails and no synchronized secondary replica is available, forcing the availability group to fail over might be an appropriate response.</span></span> <span data-ttu-id="213c9-263">强制执行故障转移是否合适取决于以下几个方面：(1) 是否希望主要副本处于脱机状态的时间超过服务级别协议 (SLA) 的容限，(2) 是否愿意为使主数据库更快处于可用状态，而承担数据可能丢失的风险。</span><span class="sxs-lookup"><span data-stu-id="213c9-263">The appropriateness of forcing a failover depends on: (1) whether you expect the primary replica to be offline for longer than your service level agreement (SLA) tolerates, and (2) whether you are willing to risk potential data loss in order to make primary databases available quickly.</span></span> <span data-ttu-id="213c9-264">如果您决定可用性组需要强制故障转移，则实际的强制故障转移将是多步骤过程中的一个步骤。</span><span class="sxs-lookup"><span data-stu-id="213c9-264">If you decide that an availability group requires a forced failover, the actual forced failover is but one step of a multi-step process.</span></span>  
  
 <span data-ttu-id="213c9-265">为了说明使用强制故障转移从灾难性故障中恢复所需的步骤，本主题提供了一个可能的灾难恢复应用场景。</span><span class="sxs-lookup"><span data-stu-id="213c9-265">To illustrate the steps that are required to use a forced failover to recover from a catastrophic failure, this topic presents one possible disaster recovery scenario.</span></span> <span data-ttu-id="213c9-266">此示例应用场景假定某一可用性组的原始拓扑结构由一个主数据中心和一个远程数据中心构成。主数据中心承载三个同步提交可用性副本，包括主副本；而远程数据中心承载两个异步提交辅助副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-266">The example scenario considers an availability group whose original topology consists of a main data center that hosts three synchronous-commit availability replicas, including the primary replica, and a remote data center that hosts two asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="213c9-267">下图说明了此示例可用性组的原始拓扑结构。</span><span class="sxs-lookup"><span data-stu-id="213c9-267">The following figure illustrates the original topology of this example availability group.</span></span> <span data-ttu-id="213c9-268">该可用性组由一个多子网 WSFC 群集承载，并且在主数据中心具有三个节点（**节点 01**、 **节点 02**和 **节点 03**），在远程数据中心有两个节点（**节点 04** 和 **节点 05**）。</span><span class="sxs-lookup"><span data-stu-id="213c9-268">The availability group is hosted by a multi-subnet WSFC cluster with three nodes in the main data center (**Node 01**, **Node 02**, and **Node 03**) and two nodes in a remote data center (**Node 04** and **Node 05**).</span></span>  
  
 <span data-ttu-id="213c9-269">![可用性组的原始拓扑](../../media/aoag-failurerecovery-origtopology.gif "可用性组的原始拓扑")</span><span class="sxs-lookup"><span data-stu-id="213c9-269">![Original topology of availability group](../../media/aoag-failurerecovery-origtopology.gif "Original topology of availability group")</span></span>  
  
 <span data-ttu-id="213c9-270">主数据中心意外关闭。</span><span class="sxs-lookup"><span data-stu-id="213c9-270">The main data center shuts down unexpectedly.</span></span> <span data-ttu-id="213c9-271">其三个可用性副本进入脱机状态并且其数据库变得不可用。</span><span class="sxs-lookup"><span data-stu-id="213c9-271">Its three availability replicas to go offline, and their databases become unavailable.</span></span> <span data-ttu-id="213c9-272">下图说明了此失败对该可用性组的拓扑的影响。</span><span class="sxs-lookup"><span data-stu-id="213c9-272">The following figure illustrates the impact of this failure on the topology of the availability group.</span></span>  
  
 <span data-ttu-id="213c9-273">![主数据中心故障之后的拓扑](../../media/aoag-failurerecovery-catastrophy.gif "主数据中心故障之后的拓扑")</span><span class="sxs-lookup"><span data-stu-id="213c9-273">![Topology after failure of main data center](../../media/aoag-failurerecovery-catastrophy.gif "Topology after failure of main data center")</span></span>  
  
 <span data-ttu-id="213c9-274">数据库管理员 (DBA) 确定可能的最佳响应是将可用性组强制故障转移到远程异步提交辅助副本中的一个。</span><span class="sxs-lookup"><span data-stu-id="213c9-274">The database administrator (DBA) determines that the best possible response is to force failover of the availability group to one of the remote, asynchronous-commit secondary replicas.</span></span> <span data-ttu-id="213c9-275">此示例说明在您将该可用性组强制故障转移到远程副本并且最终将该可用性组返回到其原始拓扑时涉及的典型步骤。</span><span class="sxs-lookup"><span data-stu-id="213c9-275">This example illustrates the typical steps involved when you force failover of the availability group to a remote replica and, eventually, return the availability group to its original topology.</span></span>  
  
  
###  <a name="responding-to-the-catastrophic-failure-of-the-main-data-center"></a><a name="FailureResponse"></a> <span data-ttu-id="213c9-276">Responding to the Catastrophic Failure of the Main Data Center</span><span class="sxs-lookup"><span data-stu-id="213c9-276">Responding to the Catastrophic Failure of the Main Data Center</span></span>  
 <span data-ttu-id="213c9-277">下图说明了为响应在主数据中心发生的灾难性故障而在远程数据中心执行的一系列操作。</span><span class="sxs-lookup"><span data-stu-id="213c9-277">The following figure illustrates the series of actions performed at the remote data center in response a catastrophic failure at the main data center.</span></span>  
  
 <span data-ttu-id="213c9-278">![主数据中心故障响应步骤](../../media/aoag-failurerecovery-actions-part1.gif "主数据中心故障响应步骤")</span><span class="sxs-lookup"><span data-stu-id="213c9-278">![Steps for responding to failure of main data cente](../../media/aoag-failurerecovery-actions-part1.gif "Steps for responding to failure of main data cente")</span></span>  
  
 <span data-ttu-id="213c9-279">在此图中的步骤说明以下步骤：</span><span class="sxs-lookup"><span data-stu-id="213c9-279">The steps in this figure indicate the following steps:</span></span>  
  
|<span data-ttu-id="213c9-280">步骤</span><span class="sxs-lookup"><span data-stu-id="213c9-280">Step</span></span>|<span data-ttu-id="213c9-281">操作</span><span class="sxs-lookup"><span data-stu-id="213c9-281">Action</span></span>|<span data-ttu-id="213c9-282">链接</span><span class="sxs-lookup"><span data-stu-id="213c9-282">Links</span></span>|  
|----------|------------|-----------|  
|<span data-ttu-id="213c9-283">**1.**</span><span class="sxs-lookup"><span data-stu-id="213c9-283">**1.**</span></span>|<span data-ttu-id="213c9-284">数据库管理员或网络管理员确保 WSFC 群集具有运行状况正常的仲裁。</span><span class="sxs-lookup"><span data-stu-id="213c9-284">The DBA or network administrator ensures that the WSFC cluster has a healthy quorum.</span></span> <span data-ttu-id="213c9-285">在此示例中，需要强制仲裁。</span><span class="sxs-lookup"><span data-stu-id="213c9-285">In this example, quorum needs to be forced.</span></span>|[<span data-ttu-id="213c9-286">WSFC 仲裁模式和投票配置 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-286">WSFC Quorum Modes and Voting Configuration &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-quorum-modes-and-voting-configuration-sql-server.md)<br /><br /> [<span data-ttu-id="213c9-287">通过强制仲裁进行 WSFC 灾难恢复 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-287">WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;</span></span>](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)|  
|<span data-ttu-id="213c9-288">**2.**</span><span class="sxs-lookup"><span data-stu-id="213c9-288">**2.**</span></span>|<span data-ttu-id="213c9-289">数据库管理员连接到具有最少的延迟的服务器示例（在 **节点 04**上）并且执行强制手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="213c9-289">The DBA connects to the server instance with the least latency (on **Node 04**) and performs a forced manual failover.</span></span> <span data-ttu-id="213c9-290">此强制故障转移将此次要副本转换为主角色并且挂起其余次要副本上的辅助数据库（在 **节点 05**上）。</span><span class="sxs-lookup"><span data-stu-id="213c9-290">The forced failover transitions this secondary replica to the primary role and suspends the secondary databases on the remaining secondary replica (on **Node 05**).</span></span>|<span data-ttu-id="213c9-291">[sys.dm_hadr_database_replica_states (Transact-SQL)](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) （查询 **sys.dm_hadr_database_replica_states** 列）。</span><span class="sxs-lookup"><span data-stu-id="213c9-291">[sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) (Query the **end_of_log_lsn** column.</span></span> <span data-ttu-id="213c9-292">有关详细信息，请参阅本主题前面的 [建议](#Recommendations)。）</span><span class="sxs-lookup"><span data-stu-id="213c9-292">For more information, see [Recommendations](#Recommendations), earlier in this topic.)</span></span>|  
|<span data-ttu-id="213c9-293">**3.**</span><span class="sxs-lookup"><span data-stu-id="213c9-293">**3.**</span></span>|<span data-ttu-id="213c9-294">数据库管理员手动恢复剩余辅助副本上的每个辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="213c9-294">The DBA manually resumes each of the secondary databases on the remaining secondary replica.</span></span>|[<span data-ttu-id="213c9-295">恢复可用性数据库 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-295">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)|  
  
###  <a name="returning-the-availability-group-to-its-original-topology"></a><a name="ReturnToOrigTopology"></a> <span data-ttu-id="213c9-296">将可用性组返回到其原始拓扑</span><span class="sxs-lookup"><span data-stu-id="213c9-296">Returning the Availability Group to its Original Topology</span></span>  
 <span data-ttu-id="213c9-297">下图说明了在主数据中心返回到联机状态并且 WSFC 节点重新建立与 WSFC 群集的通信后将该可用性组返回到其原始拓扑的一系列操作。</span><span class="sxs-lookup"><span data-stu-id="213c9-297">The following figure illustrates the series of actions that return the availability group to its original topology after the main data center comes back online and the WSFC nodes re-establish communication with the WSFC cluster.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="213c9-298">如果已强制 WSFC 群集仲裁，则在脱机节点重新启动时，只要下列两个条件均成立，它们就可以构成新的仲裁：(a) 在强制仲裁集的任何节点之间没有网络连接，(b) 重新启动的节点是群集中的大多数节点。</span><span class="sxs-lookup"><span data-stu-id="213c9-298">If the WSFC cluster quorum has been forced, as the offline nodes restart they could form a new quorum if the following conditions both exist: (a) there is no network connectivity between any of the nodes in the forced-quorum set, and (b) the restarting nodes are the majority of the cluster nodes.</span></span> <span data-ttu-id="213c9-299">这可能会导致“裂脑”情形，即可用性组将拥有两个独立的主副本，在各数据中心各有一个。</span><span class="sxs-lookup"><span data-stu-id="213c9-299">This would result in a "split brain" condition in which the availability group would possess two independent primary replicas, one at each data center.</span></span> <span data-ttu-id="213c9-300">强制仲裁以创建少数仲裁集之前，请参阅 [通过强制仲裁进行 WSFC 灾难恢复 (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md)或 PowerShell 对 AlwaysOn 可用性组执行强制故障转移（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="213c9-300">Before forcing quorum to create a minority quorum set, see [WSFC Disaster Recovery through Forced Quorum &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-disaster-recovery-through-forced-quorum-sql-server.md).</span></span>  
  
 <span data-ttu-id="213c9-301">![将组返回至其原始拓扑的步骤](../../media/aoag-failurerecovery-actions-part2.gif "将组返回至其原始拓扑的步骤")</span><span class="sxs-lookup"><span data-stu-id="213c9-301">![Steps to return the group to its original topology](../../media/aoag-failurerecovery-actions-part2.gif "Steps to return the group to its original topology")</span></span>  
  
 <span data-ttu-id="213c9-302">在此图中的步骤说明以下步骤：</span><span class="sxs-lookup"><span data-stu-id="213c9-302">The steps in this figure indicate the following steps:</span></span>  
  
||<span data-ttu-id="213c9-303">步骤</span><span class="sxs-lookup"><span data-stu-id="213c9-303">Step</span></span>|<span data-ttu-id="213c9-304">链接</span><span class="sxs-lookup"><span data-stu-id="213c9-304">Links</span></span>|  
|-|----------|-----------|  
|<span data-ttu-id="213c9-305">**1.**</span><span class="sxs-lookup"><span data-stu-id="213c9-305">**1.**</span></span>|<span data-ttu-id="213c9-306">主数据中心中的节点返回到联机状态，并且重新建立与 WSFC 群集的通信。</span><span class="sxs-lookup"><span data-stu-id="213c9-306">The nodes in the main data center come back online and re-establish communication with the WSFC cluster.</span></span> <span data-ttu-id="213c9-307">其可用性副本将作为具有挂起的数据库的辅助副本进入联机状态，数据库管理员将需要手动尽快恢复这些数据库中的每个数据库。</span><span class="sxs-lookup"><span data-stu-id="213c9-307">Their availability replicas come online as secondary replicas with suspended databases, and the DBA will need to manually resume each of these databases soon.</span></span>|[<span data-ttu-id="213c9-308">恢复可用性数据库 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-308">Resume an Availability Database &#40;SQL Server&#41;</span></span>](resume-an-availability-database-sql-server.md)<br /><br /> <span data-ttu-id="213c9-309">提示：如果担心在故障转移后主数据库上可能会丢失数据，则应该尝试在同步提交辅助数据库上创建已挂起数据库的数据库快照。</span><span class="sxs-lookup"><span data-stu-id="213c9-309">Tip: If you are concerned about possible data loss on the post-failover primary databases, you should attempt to create a database snapshot on the suspended databases on one the synchronous-commit secondary database.</span></span> <span data-ttu-id="213c9-310">请记住，在其任何辅助数据库被挂起时，事务日志截断在主数据库上被延迟。</span><span class="sxs-lookup"><span data-stu-id="213c9-310">Keep in mind that the transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="213c9-311">此外，只要任何本地数据库保持挂起状态，则同步提交辅助副本的同步运行状况将无法转换到 HEALTHY。</span><span class="sxs-lookup"><span data-stu-id="213c9-311">Also the synchronization health of the synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>|  
|<span data-ttu-id="213c9-312">**2.**</span><span class="sxs-lookup"><span data-stu-id="213c9-312">**2.**</span></span>|<span data-ttu-id="213c9-313">在恢复数据库后，数据库管理员暂时将新的主副本更改为同步提交模式。</span><span class="sxs-lookup"><span data-stu-id="213c9-313">Once the databases are resumed, the DBA changes the new primary replica to synchronous-commit mode temporarily.</span></span> <span data-ttu-id="213c9-314">这涉及两个步骤：</span><span class="sxs-lookup"><span data-stu-id="213c9-314">This involves two steps:</span></span><br /><br /> <span data-ttu-id="213c9-315">1) 将一个脱机可用性副本更改为异步提交模式。</span><span class="sxs-lookup"><span data-stu-id="213c9-315">1) Change one offline availability replica to asynchronous-commit mode.</span></span> <br /><span data-ttu-id="213c9-316">2) 将新的主副本更改为同步提交模式。</span><span class="sxs-lookup"><span data-stu-id="213c9-316">2) Change the new primary replica to synchronous-commit mode.</span></span><br /><span data-ttu-id="213c9-317">注意：此步骤将使已恢复的同步提交辅助数据库能够成为 SYNCHRONIZED。</span><span class="sxs-lookup"><span data-stu-id="213c9-317">Note: This step enables resumed synchronous-commit secondary databases to become SYNCHRONIZED.</span></span>|[<span data-ttu-id="213c9-318">更改可用性副本的可用性模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-318">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
|<span data-ttu-id="213c9-319">**3.**</span><span class="sxs-lookup"><span data-stu-id="213c9-319">**3.**</span></span>|<span data-ttu-id="213c9-320">在 **节点 03** 上同步提交次要副本（原始主要副本）进入 HEALTHY 同步状态后，数据库管理员将执行到该副本的计划的手动故障转移，使其再次成为主要副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-320">Once the synchronous-commit secondary replica on **Node 03** (the original primary replica) enters the HEALTHY synchronization state, the DBA performs a planned manual failover to that replica, to make it the primary replica again.</span></span> <span data-ttu-id="213c9-321">**节点 04** 上的副本将恢复成为辅助副本。</span><span class="sxs-lookup"><span data-stu-id="213c9-321">The replica on **Node 04** returns to being a secondary replica.</span></span>|[<span data-ttu-id="213c9-322">sys.dm_hadr_database_replica_states (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="213c9-322">sys.dm_hadr_database_replica_states &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql)<br /><br /> [<span data-ttu-id="213c9-323">使用 AlwaysOn 策略查看可用性组的运行状况 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="213c9-323">Use AlwaysOn Policies to View the Health of an Availability Group &#40;SQL Server&#41;</span></span>](use-always-on-policies-to-view-the-health-of-an-availability-group-sql-server.md)<br /><br /> [<span data-ttu-id="213c9-324">执行可用性组的计划手动故障转移 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-324">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)|  
|<span data-ttu-id="213c9-325">**4.**</span><span class="sxs-lookup"><span data-stu-id="213c9-325">**4.**</span></span>|<span data-ttu-id="213c9-326">数据库管理员将连接到新的主副本，并且：</span><span class="sxs-lookup"><span data-stu-id="213c9-326">The DBA connects to the new primary replica and:</span></span><br /><br /> <span data-ttu-id="213c9-327">1) 将以前的主副本（在远程中心中）更改回异步提交模式。</span><span class="sxs-lookup"><span data-stu-id="213c9-327">1) Changes the former primary replica (in the remote center) back to asynchronous-commit mode.</span></span><br /><span data-ttu-id="213c9-328">2) 将主数据中心中的异步提交辅助副本更改回同步提交模式。</span><span class="sxs-lookup"><span data-stu-id="213c9-328">2) Changes the asynchronous-commit secondary replica in the main data center back to synchronous-commit mode.</span></span>|[<span data-ttu-id="213c9-329">更改可用性副本的可用性模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-329">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)|  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="213c9-330">相关任务</span><span class="sxs-lookup"><span data-stu-id="213c9-330">Related Tasks</span></span>  
 <span data-ttu-id="213c9-331">**调整仲裁投票**</span><span class="sxs-lookup"><span data-stu-id="213c9-331">**To adjust quorum votes**</span></span>  
  
-   [<span data-ttu-id="213c9-332">查看群集仲裁 NodeWeight 设置</span><span class="sxs-lookup"><span data-stu-id="213c9-332">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="213c9-333">配置群集仲裁 NodeWeight 设置</span><span class="sxs-lookup"><span data-stu-id="213c9-333">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="213c9-334">在无仲裁情况下强制启动 WSFC 群集</span><span class="sxs-lookup"><span data-stu-id="213c9-334">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
 <span data-ttu-id="213c9-335">**计划的手动故障转移：**</span><span class="sxs-lookup"><span data-stu-id="213c9-335">**Planned manual failover:**</span></span>  
  
-   [<span data-ttu-id="213c9-336">执行可用性组的计划手动故障转移 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="213c9-336">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [<span data-ttu-id="213c9-337">使用故障转移可用性组向导 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="213c9-337">Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)  
  
 <span data-ttu-id="213c9-338">**排除故障：**</span><span class="sxs-lookup"><span data-stu-id="213c9-338">**To troubleshoot:**</span></span>  
  
-   [<span data-ttu-id="213c9-339">AlwaysOn 可用性组配置 &#40;SQL Server&#41;疑难解答</span><span class="sxs-lookup"><span data-stu-id="213c9-339">Troubleshoot AlwaysOn Availability Groups Configuration &#40;SQL Server&#41;</span></span>](troubleshoot-always-on-availability-groups-configuration-sql-server.md) 
  
-   [<span data-ttu-id="213c9-340">排除失败的添加文件操作 &#40;AlwaysOn 可用性组&#41;</span><span class="sxs-lookup"><span data-stu-id="213c9-340">Troubleshoot a Failed Add-File Operation &#40;AlwaysOn Availability Groups&#41;</span></span>](troubleshoot-a-failed-add-file-operation-always-on-availability-groups.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="213c9-341">相关内容</span><span class="sxs-lookup"><span data-stu-id="213c9-341">Related Content</span></span>  
  
-   <span data-ttu-id="213c9-342">**博客：**</span><span class="sxs-lookup"><span data-stu-id="213c9-342">**Blogs:**</span></span>  
  
     [<span data-ttu-id="213c9-343">SQL Server AlwaysOn 团队博客：SQL Server AlwaysOn 官方团队博客</span><span class="sxs-lookup"><span data-stu-id="213c9-343">SQL Server AlwaysOn Team Blogs: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
     [<span data-ttu-id="213c9-344">CSS SQL Server 工程师博客</span><span class="sxs-lookup"><span data-stu-id="213c9-344">CSS SQL Server Engineers Blogs</span></span>](https://blogs.msdn.com/b/psssql/)  
  
-   <span data-ttu-id="213c9-345">**白皮书：**</span><span class="sxs-lookup"><span data-stu-id="213c9-345">**Whitepapers:**</span></span>  
  
     [<span data-ttu-id="213c9-346">用于高可用性和灾难恢复的 Microsoft SQL Server AlwaysOn 解决方案指南</span><span class="sxs-lookup"><span data-stu-id="213c9-346">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
     [<span data-ttu-id="213c9-347">针对 SQL Server 2012 的 Microsoft 白皮书</span><span class="sxs-lookup"><span data-stu-id="213c9-347">Microsoft White Papers for SQL Server 2012</span></span>](https://msdn.microsoft.com/library/hh403491.aspx)  
  
     [<span data-ttu-id="213c9-348">SQL Server 客户咨询团队白皮书</span><span class="sxs-lookup"><span data-stu-id="213c9-348">SQL Server Customer Advisory Team Whitepapers</span></span>](http://sqlcat.com/)  
  
## <a name="see-also"></a><span data-ttu-id="213c9-349">另请参阅</span><span class="sxs-lookup"><span data-stu-id="213c9-349">See Also</span></span>  
 <span data-ttu-id="213c9-350">[AlwaysOn 可用性组 &#40;SQL Server 概述&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="213c9-350">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="213c9-351">[可用性模式 &#40;AlwaysOn 可用性组&#41;](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="213c9-351">[Availability Modes &#40;AlwaysOn Availability Groups&#41;](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="213c9-352">[故障转移和故障转移模式 &#40;AlwaysOn 可用性组&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="213c9-352">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="213c9-353">[关于对可用性副本的客户端连接访问 &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="213c9-353">[About Client Connection Access to Availability Replicas &#40;SQL Server&#41;](about-client-connection-access-to-availability-replicas-sql-server.md) </span></span>  
 <span data-ttu-id="213c9-354">[监视可用性组 (SQL Server)](monitoring-of-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="213c9-354">[Monitoring of Availability Groups &#40;SQL Server&#41;](monitoring-of-availability-groups-sql-server.md) </span></span>  
 [<span data-ttu-id="213c9-355">Windows Server 故障转移群集 (WSFC) 与 SQL Server</span><span class="sxs-lookup"><span data-stu-id="213c9-355">Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server</span></span>](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)  
  
  

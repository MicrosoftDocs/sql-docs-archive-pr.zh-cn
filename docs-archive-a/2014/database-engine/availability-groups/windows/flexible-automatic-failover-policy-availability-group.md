---
title: 用于 (SQL Server) 的可用性组的自动故障转移的灵活的故障转移策略 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], flexible failover policy
- Availability Groups [SQL Server], failover
- flexible failover policy
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 8c504c7f-5c1d-4124-b697-f735ef0084f0
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: cd4dd62d8b30e2041415e0b9be5682ce4b01d1f6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87585973"
---
# <a name="flexible-failover-policy-for-automatic-failover-of-an-availability-group-sql-server"></a><span data-ttu-id="40a08-102">针对可用性组的自动故障转移的灵活的故障转移策略 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="40a08-102">Flexible Failover Policy for Automatic Failover of an Availability Group (SQL Server)</span></span>
  <span data-ttu-id="40a08-103">灵活的故障转移策略提供了对导致可用性组[自动故障转移](failover-and-failover-modes-always-on-availability-groups.md)的条件的精确控制。</span><span class="sxs-lookup"><span data-stu-id="40a08-103">A flexible failover policy provides granular control over the conditions that cause [automatic failover](failover-and-failover-modes-always-on-availability-groups.md) for an availability group.</span></span> <span data-ttu-id="40a08-104">通过更改触发自动故障转移的失败条件和运行状况检查的频率，可增大或减小自动进行故障转移来支持高可用性 SLA 的可能性。</span><span class="sxs-lookup"><span data-stu-id="40a08-104">By changing the failure conditions that trigger an automatic failover and the frequency of health checks, you can increase or decrease the likelihood of an automatic failover to support your SLA for high availability.</span></span>  
  
 <span data-ttu-id="40a08-105">可用性组的灵活的故障转移策略是由其失败条件级别和运行状况检查超时阈值定义的。</span><span class="sxs-lookup"><span data-stu-id="40a08-105">The flexible failover policy of an availability group is defined by its failure-condition level and health-check timeout threshold.</span></span> <span data-ttu-id="40a08-106">在检测到某个可用性组已超出其失败条件级别或其运行状况检查超时阈值时，该可用性组的资源 DLL 会响应 Windows Server 故障转移群集 (WSFC) 群集。</span><span class="sxs-lookup"><span data-stu-id="40a08-106">On detecting that an availability group has exceeded its failure condition level or its health-check timeout threshold, the availability group's resource DLL responds back to the Windows Server Failover Clustering (WSFC) cluster.</span></span> <span data-ttu-id="40a08-107">之后，WSFC 群集会启动到辅助副本的自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="40a08-107">The WSFC cluster then initiates an automatic failover to the secondary replica.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="40a08-108">如果某个可用性组超过其 WSFC 故障阈值，则该 WSFC 群集不会尝试为该可用性组执行自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="40a08-108">If an availability group exceeds its WSFC failure threshold, the WSFC cluster will not attempt an automatic failover for the availability group.</span></span> <span data-ttu-id="40a08-109">此外，该可用性组的 WSFC 资源组始终保持失败状态，直到群集管理员手动将该失败的资源组联机，或是数据库管理员对该可用性组执行手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="40a08-109">Furthermore, the WSFC resource group of the availability group remains in a failed state until either the cluster administrator manually brings the failed resource group online or the database administrator performs a manual failover of the availability group.</span></span> <span data-ttu-id="40a08-110">WSFC 故障阈值 \*\* 定义为给定时间段中可用性组所支持的最大故障数。</span><span class="sxs-lookup"><span data-stu-id="40a08-110">The *WSFC failure threshold* is defined as the maximum number of failures supported for the availability group during a given time period.</span></span> <span data-ttu-id="40a08-111">默认时间段为六个小时，此时间段中最大故障数的默认值为 *n*-1，其中 *n* 是 WSFC 节点的数目。</span><span class="sxs-lookup"><span data-stu-id="40a08-111">The default time period is six hours, and the default value for the maximum number of failures during this period is *n*-1, where *n* is the number of WSFC nodes.</span></span> <span data-ttu-id="40a08-112">若要更改给定的可用性组的故障阈值，请使用 WSFC 故障转移管理器控制台。</span><span class="sxs-lookup"><span data-stu-id="40a08-112">To change the failure-threshold values for a given availability group, use the WSFC Failover Manager Console.</span></span>  
  
  
  
##  <a name="health-check-timeout-threshold"></a><a name="HCtimeout"></a> <span data-ttu-id="40a08-113">运行状况检查超时阈值</span><span class="sxs-lookup"><span data-stu-id="40a08-113">Health-Check Timeout Threshold</span></span>  
 <span data-ttu-id="40a08-114">可用性组的 WSFC 资源 DLL 将通过在承载主副本的 SQL Server 实例上调用 *sp_server_diagnostics* 存储过程来对主副本执行 [运行状况检查](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) 。</span><span class="sxs-lookup"><span data-stu-id="40a08-114">WSFC resource DLL of the availability group performs a *health check* of the primary replica by calling the [sp_server_diagnostics](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql) stored procedure on the instance of SQL Server that hosts the primary replica.</span></span> <span data-ttu-id="40a08-115">**sp_server_diagnostics** 按等于可用性组的运行状况检查超时阈值的 1/3 的时间间隔返回结果。</span><span class="sxs-lookup"><span data-stu-id="40a08-115">**sp_server_diagnostics** returns results at an interval that equals 1/3 of the health-check timeout threshold for the availability group.</span></span> <span data-ttu-id="40a08-116">默认的运行状况检查超时阈值为 30 秒，这将导致 **sp_server_diagnostics** 按 10 秒的时间间隔返回结果。</span><span class="sxs-lookup"><span data-stu-id="40a08-116">The default health-check timeout threshold is 30 seconds, which causes **sp_server_diagnostics** to return at a 10-second interval.</span></span> <span data-ttu-id="40a08-117">如果 **sp_server_diagnostics** 的运行速度较慢且未返回信息，则资源 DLL 将在等待运行状况检查超时阈值的完全时间间隔后确定主副本已停止响应。</span><span class="sxs-lookup"><span data-stu-id="40a08-117">If **sp_server_diagnostics** is slow or is not returning information, the resource DLL will wait for the full interval of the health-check timeout threshold before determining that the primary replica is unresponsive.</span></span> <span data-ttu-id="40a08-118">如果主副本停止响应，则启动自动故障转移（如果当前受支持）。</span><span class="sxs-lookup"><span data-stu-id="40a08-118">If the primary replica is unresponsive, an automatic failover is initiated, if currently supported.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="40a08-119">**sp_server_diagnostics** 在数据库级别不执行运行状况检查。</span><span class="sxs-lookup"><span data-stu-id="40a08-119">**sp_server_diagnostics** does not perform health checks at the database level.</span></span>  
  
##  <a name="failure-condition-level"></a><a name="FClevel"></a> <span data-ttu-id="40a08-120">故障条件级别</span><span class="sxs-lookup"><span data-stu-id="40a08-120">Failure-Condition Level</span></span>  
 <span data-ttu-id="40a08-121">由 **sp_server_diagnostics** 返回的诊断数据和运行状况信息是否保证触发自动故障转移取决于可用性组的失败条件级别。</span><span class="sxs-lookup"><span data-stu-id="40a08-121">Whether the diagnostic data and health information returned by **sp_server_diagnostics** warrants an automatic failover depends on the failure-condition level of the availability group.</span></span> <span data-ttu-id="40a08-122">*失败条件级别* 指定触发自动故障转移的失败条件。</span><span class="sxs-lookup"><span data-stu-id="40a08-122">The *failure-condition level* specifies what failure conditions trigger an automatic failover.</span></span> <span data-ttu-id="40a08-123">有 5 个失败条件级别，其范围从最少限制（级别 1）到最多限制（级别 5）。</span><span class="sxs-lookup"><span data-stu-id="40a08-123">There are five failure-condition levels, which range from the least restrictive (level one) to the most restrictive (level five).</span></span> <span data-ttu-id="40a08-124">给定级别包含限制较少的级别。</span><span class="sxs-lookup"><span data-stu-id="40a08-124">A given level encompasses the less restrictive levels.</span></span> <span data-ttu-id="40a08-125">因此，最严格的级别 5 包含四个限制更少的条件，依此类推。</span><span class="sxs-lookup"><span data-stu-id="40a08-125">Thus, the strictest level, five, includes the four less restrictive conditions, and so forth.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="40a08-126">任何级别的故障条件均不检测已损坏的数据库和可疑数据库。</span><span class="sxs-lookup"><span data-stu-id="40a08-126">Damaged databases and suspect databases are not detected by any failure-condition level.</span></span> <span data-ttu-id="40a08-127">因此，已损坏的或可疑的数据库（无论是由于硬件故障、数据损坏还是其他问题导致）从不触发自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="40a08-127">Therefore, a database that is damaged or suspect (whether due to a hardware failure, data corruption, or other issue) never triggers an automatic failover.</span></span>  
  
 <span data-ttu-id="40a08-128">下表介绍了与各级别相对应的失败条件。</span><span class="sxs-lookup"><span data-stu-id="40a08-128">The following table describes the failure-conditions that corresponds to each level.</span></span>  
  
|<span data-ttu-id="40a08-129">级别</span><span class="sxs-lookup"><span data-stu-id="40a08-129">Level</span></span>|<span data-ttu-id="40a08-130">失败条件</span><span class="sxs-lookup"><span data-stu-id="40a08-130">Failure Condition</span></span>|[!INCLUDE[tsql](../../../includes/tsql-md.md)] <span data-ttu-id="40a08-131">值</span><span class="sxs-lookup"><span data-stu-id="40a08-131">Value</span></span>|<span data-ttu-id="40a08-132">PowerShell 值</span><span class="sxs-lookup"><span data-stu-id="40a08-132">PowerShell Value</span></span>|  
|-----------|-----------------------|------------------------------|----------------------|  
|<span data-ttu-id="40a08-133">一个</span><span class="sxs-lookup"><span data-stu-id="40a08-133">One</span></span>|<span data-ttu-id="40a08-134">当服务器关闭时。</span><span class="sxs-lookup"><span data-stu-id="40a08-134">On server down.</span></span> <span data-ttu-id="40a08-135">这是限制最少的级别。</span><span class="sxs-lookup"><span data-stu-id="40a08-135">This is the least restrictive level.</span></span> <span data-ttu-id="40a08-136">指定在发生以下任何情况时启动自动故障转移：</span><span class="sxs-lookup"><span data-stu-id="40a08-136">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="40a08-137">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 服务停止。</span><span class="sxs-lookup"><span data-stu-id="40a08-137">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service is down.</span></span><br /><br /> <span data-ttu-id="40a08-138">因为没有从服务器实例接收到 ACK，连接到 WSFC 群集的可用性组的租期到期。</span><span class="sxs-lookup"><span data-stu-id="40a08-138">The lease of the availability group for connecting to the WSFC cluster expires because no ACK is received from the server instance.</span></span> <span data-ttu-id="40a08-139">有关详细信息，请参阅 [工作方式：SQL Server AlwaysOn 租约超时](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)。</span><span class="sxs-lookup"><span data-stu-id="40a08-139">For more information, see [How It Works: SQL Server AlwaysOn Lease Timeout](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx).</span></span>|<span data-ttu-id="40a08-140">1</span><span class="sxs-lookup"><span data-stu-id="40a08-140">1</span></span>|`OnServerDown`|  
|<span data-ttu-id="40a08-141">两个</span><span class="sxs-lookup"><span data-stu-id="40a08-141">Two</span></span>|<span data-ttu-id="40a08-142">当服务器无响应时。</span><span class="sxs-lookup"><span data-stu-id="40a08-142">On server unresponsive.</span></span> <span data-ttu-id="40a08-143">指定在发生以下任何情况时启动自动故障转移：</span><span class="sxs-lookup"><span data-stu-id="40a08-143">Specifies that an automatic failover is initiated when any of the following occurs:</span></span><br /><br /> <span data-ttu-id="40a08-144">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 的实例未连接到群集，并且超出了可用性组的用户指定的运行状况检查超时阈值。</span><span class="sxs-lookup"><span data-stu-id="40a08-144">The instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] does not connect to cluster, and the user-specified health check timeout threshold of the availability group is exceeded.</span></span><br /><br /> <span data-ttu-id="40a08-145">可用性副本处于失败状态。</span><span class="sxs-lookup"><span data-stu-id="40a08-145">The availability replica is in failed state.</span></span>|<span data-ttu-id="40a08-146">2</span><span class="sxs-lookup"><span data-stu-id="40a08-146">2</span></span>|`OnServerUnresponsive`|  
|<span data-ttu-id="40a08-147">三级</span><span class="sxs-lookup"><span data-stu-id="40a08-147">Three</span></span>|<span data-ttu-id="40a08-148">出现严重服务器错误时。</span><span class="sxs-lookup"><span data-stu-id="40a08-148">On critical server error.</span></span> <span data-ttu-id="40a08-149">指定在发生了严重的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 内部错误（例如孤立的自旋锁、严重的写访问冲突或过多的转储）时启动自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="40a08-149">Specifies that an automatic failover is initiated on critical [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as orphaned spinlocks, serious write-access violations, or too much dumping.</span></span> <span data-ttu-id="40a08-150">这是默认级别。</span><span class="sxs-lookup"><span data-stu-id="40a08-150">This is the default level.</span></span>|<span data-ttu-id="40a08-151">3</span><span class="sxs-lookup"><span data-stu-id="40a08-151">3</span></span>|`OnCriticalServerError`|  
|<span data-ttu-id="40a08-152">四级</span><span class="sxs-lookup"><span data-stu-id="40a08-152">Four</span></span>|<span data-ttu-id="40a08-153">出现严重服务器错误时。</span><span class="sxs-lookup"><span data-stu-id="40a08-153">On moderate server error.</span></span> <span data-ttu-id="40a08-154">指定在发生了中等 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 内部错误（在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 内部资源池中出现持久的内存不足情况）时启动自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="40a08-154">Specifies that an automatic failover is initiated on moderate [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal errors, such as a persistent out-of-memory condition in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] internal resource pool.</span></span>|<span data-ttu-id="40a08-155">4</span><span class="sxs-lookup"><span data-stu-id="40a08-155">4</span></span>|`OnModerateServerError`|  
|<span data-ttu-id="40a08-156">五级</span><span class="sxs-lookup"><span data-stu-id="40a08-156">Five</span></span>|<span data-ttu-id="40a08-157">在出现任何限定的失败条件时。</span><span class="sxs-lookup"><span data-stu-id="40a08-157">On any qualified failure conditions.</span></span> <span data-ttu-id="40a08-158">这是限制最多的级别。</span><span class="sxs-lookup"><span data-stu-id="40a08-158">This is the most restrictive level.</span></span> <span data-ttu-id="40a08-159">指定在出现任何符合的失败条件时启动自动故障转移，这些失败条件包括：</span><span class="sxs-lookup"><span data-stu-id="40a08-159">Specifies that an automatic failover is initiated on any qualified failure conditions, including:</span></span><br /><br /> <span data-ttu-id="40a08-160">SQL 引擎的工作线程耗尽。</span><span class="sxs-lookup"><span data-stu-id="40a08-160">Exhaustion of SQL Engine worker-threads.</span></span><br /><br /> <span data-ttu-id="40a08-161">检测到无法解决的死锁。</span><span class="sxs-lookup"><span data-stu-id="40a08-161">Detection of an unsolvable deadlock.</span></span>|<span data-ttu-id="40a08-162">5</span><span class="sxs-lookup"><span data-stu-id="40a08-162">5</span></span>|`OnAnyQualifiedFailureConditions`|  
  
> [!NOTE]  
>  <span data-ttu-id="40a08-163">缺少 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 的实例对客户端请求的响应与可用性组无关。</span><span class="sxs-lookup"><span data-stu-id="40a08-163">Lack of response by an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] to client requests is irrelevant to availability groups.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="40a08-164">相关任务</span><span class="sxs-lookup"><span data-stu-id="40a08-164">Related Tasks</span></span>  
 <span data-ttu-id="40a08-165">**配置自动故障转移**</span><span class="sxs-lookup"><span data-stu-id="40a08-165">**To configure automatic failover**</span></span>  
  
-   <span data-ttu-id="40a08-166">[更改可用性副本的可用性模式 (SQL Server) ](change-the-availability-mode-of-an-availability-replica-sql-server.md)（自动故障转移要求同步提交可用性模式）</span><span class="sxs-lookup"><span data-stu-id="40a08-166">[Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md) (automatic failover requires synchronous-commit availability mode)</span></span>  
  
-   [<span data-ttu-id="40a08-167">更改可用性副本的故障转移模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="40a08-167">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [<span data-ttu-id="40a08-168">配置灵活的故障转移策略以控制自动故障转移的条件（AlwaysOn 可用性组）</span><span class="sxs-lookup"><span data-stu-id="40a08-168">Configure the Flexible Failover Policy to Control Conditions for Automatic Failover (AlwaysOn Availability Groups)</span></span>](configure-flexible-automatic-failover-policy.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="40a08-169">相关内容</span><span class="sxs-lookup"><span data-stu-id="40a08-169">Related Content</span></span>  
  
-   [<span data-ttu-id="40a08-170">工作方式：SQL Server AlwaysOn 租约超时</span><span class="sxs-lookup"><span data-stu-id="40a08-170">How It Works: SQL Server AlwaysOn Lease Timeout</span></span>](https://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-alwayson-lease-timeout.aspx)  
  
## <a name="see-also"></a><span data-ttu-id="40a08-171">另请参阅</span><span class="sxs-lookup"><span data-stu-id="40a08-171">See Also</span></span>  
 <span data-ttu-id="40a08-172">[AlwaysOn 可用性组 &#40;SQL Server 概述&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="40a08-172">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="40a08-173">[可用性模式 (AlwaysOn 可用性组) ](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="40a08-173">[Availability Modes (AlwaysOn Availability Groups)](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="40a08-174">[故障转移和故障转移模式 &#40;AlwaysOn 可用性组&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="40a08-174">[Failover and Failover Modes &#40;AlwaysOn Availability Groups&#41;](failover-and-failover-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="40a08-175">[Windows Server 故障转移群集 (WSFC) 与 SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="40a08-175">[Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span></span>  
 <span data-ttu-id="40a08-176">[故障转移群集实例的故障转移策略](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span><span class="sxs-lookup"><span data-stu-id="40a08-176">[Failover Policy for Failover Cluster Instances](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span></span>  
 [<span data-ttu-id="40a08-177">sp_server_diagnostics (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="40a08-177">sp_server_diagnostics &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql)  
  
  

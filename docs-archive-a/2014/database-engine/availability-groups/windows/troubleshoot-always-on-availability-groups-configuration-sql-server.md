---
title: AlwaysOn 可用性组配置 (SQL Server) 疑难解答 |Microsoft Docs
ms.custom: ''
ms.date: 01/31/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- troubleshooting [SQL Server], deploying
- Availability Groups [SQL Server], troubleshooting
- Availability Groups [SQL Server], configuring
ms.assetid: 8c222f98-7392-4faf-b7ad-5fb60ffa237e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 165036ba539c3392b1944282bd9d6126eb471a97
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87693478"
---
# <a name="troubleshoot-alwayson-availability-groups-configuration-sql-server"></a><span data-ttu-id="7be71-102">解决 AlwaysOn 可用性组配置问题 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-102">Troubleshoot AlwaysOn Availability Groups Configuration (SQL Server)</span></span>
  <span data-ttu-id="7be71-103">本主题提供的信息可帮助您解决在为 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]配置服务器实例时遇到的典型问题。</span><span class="sxs-lookup"><span data-stu-id="7be71-103">This topic provides information to help you troubleshoot typical problems with configuring server instances for [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)].</span></span> <span data-ttu-id="7be71-104">典型配置问题包括 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 被禁用、帐户配置不当、数据库镜像端点不存在、端点无法访问（SQL Server 错误 1418）、网络访问不存在，以及联接数据库命令失败（SQL Server 错误 35250）。</span><span class="sxs-lookup"><span data-stu-id="7be71-104">Typical configuration problems include [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] is disabled, accounts are incorrectly configured, the database mirroring endpoint does not exist, the endpoint is inaccessible (SQL Server Error 1418), network access does not exist, and a join database command fails (SQL Server Error 35250).</span></span>

> [!NOTE]
>  <span data-ttu-id="7be71-105">确保您满足 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 的先决条件。</span><span class="sxs-lookup"><span data-stu-id="7be71-105">Ensure that you are meeting the [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] prerequisites.</span></span> <span data-ttu-id="7be71-106">有关详细信息，请参阅[针对 AlwaysOn 可用性组的先决条件、限制和建议 (SQL Server)](prereqs-restrictions-recommendations-always-on-availability.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-106">For more information, see [Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md).</span></span>

 <span data-ttu-id="7be71-107">**本主题内容：**</span><span class="sxs-lookup"><span data-stu-id="7be71-107">**In This Topic:**</span></span>

|<span data-ttu-id="7be71-108">部分</span><span class="sxs-lookup"><span data-stu-id="7be71-108">Section</span></span>|<span data-ttu-id="7be71-109">说明</span><span class="sxs-lookup"><span data-stu-id="7be71-109">Description</span></span>|
|-------------|-----------------|
|[<span data-ttu-id="7be71-110">未启用 AlwaysOn 可用性组</span><span class="sxs-lookup"><span data-stu-id="7be71-110">AlwaysOn Availability Groups Is Not Enabled</span></span>](#IsHadrEnabled)|<span data-ttu-id="7be71-111">如果 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例未启用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]，该实例则不支持创建可用性组，也无法承载任何可用性副本。</span><span class="sxs-lookup"><span data-stu-id="7be71-111">If an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is not enabled for [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)], the instance does not support availability group creation and cannot host any availability replicas.</span></span>|
|[<span data-ttu-id="7be71-112">帐户</span><span class="sxs-lookup"><span data-stu-id="7be71-112">Accounts</span></span>](#Accounts)|<span data-ttu-id="7be71-113">介绍了正确配置运行 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 所用的帐户的相关要求。</span><span class="sxs-lookup"><span data-stu-id="7be71-113">Discusses requirements for correctly configuring the accounts under which [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is running.</span></span>|
|[<span data-ttu-id="7be71-114">端点</span><span class="sxs-lookup"><span data-stu-id="7be71-114">Endpoints</span></span>](#Endpoints)|<span data-ttu-id="7be71-115">介绍如何诊断与服务器实例的数据库镜像端点有关的问题。</span><span class="sxs-lookup"><span data-stu-id="7be71-115">Discusses how to diagnose issues with the database mirroring endpoint of a server instance.</span></span>|
|[<span data-ttu-id="7be71-116">系统名称</span><span class="sxs-lookup"><span data-stu-id="7be71-116">System name</span></span>](#SystemName)|<span data-ttu-id="7be71-117">概述了在端点 URL 中指定服务器实例的系统名称的备选方法。</span><span class="sxs-lookup"><span data-stu-id="7be71-117">Summarizes the alternatives for specifying the system name of a server instance in an endpoint URL.</span></span>|
|[<span data-ttu-id="7be71-118">网络访问</span><span class="sxs-lookup"><span data-stu-id="7be71-118">Network access</span></span>](#NetworkAccess)|<span data-ttu-id="7be71-119">记录了承载可用性副本的每个服务器实例必须能够通过 TCP 访问其他各个服务器实例的端口的要求。</span><span class="sxs-lookup"><span data-stu-id="7be71-119">Documents the requirement that each server instance that is hosting an availability replica must be able to access the port of each of the other server instances over TCP.</span></span>|
|[<span data-ttu-id="7be71-120">端点访问（SQL Server 错误 1418）</span><span class="sxs-lookup"><span data-stu-id="7be71-120">Endpoint Access (SQL Server Error 1418)</span></span>](#Msg1418)|<span data-ttu-id="7be71-121">包含有关此 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 错误消息的信息。</span><span class="sxs-lookup"><span data-stu-id="7be71-121">Contains information about this [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] error message.</span></span>|
|[<span data-ttu-id="7be71-122">联接数据库失败（SQL Server 错误 35250）</span><span class="sxs-lookup"><span data-stu-id="7be71-122">Join Database Fails (SQL Server Error 35250)</span></span>](#JoinDbFails)|<span data-ttu-id="7be71-123">介绍由于与主副本的连接处于非活动状态而导致未能将辅助数据库联接到可用性组的可能原因和解决方法。</span><span class="sxs-lookup"><span data-stu-id="7be71-123">Discusses the possible causes and resolution of a failure to join secondary databases to an availability group because the connection to the primary replica is not active.</span></span>|
|[<span data-ttu-id="7be71-124">只读路由未正确工作</span><span class="sxs-lookup"><span data-stu-id="7be71-124">Read-Only Routing is Not Working Correctly</span></span>](#ROR)||
|[<span data-ttu-id="7be71-125">相关任务</span><span class="sxs-lookup"><span data-stu-id="7be71-125">Related Tasks</span></span>](#RelatedTasks)|<span data-ttu-id="7be71-126">包含 [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] 联机丛书中专门针对排除可用性组配置问题的面向任务的主题列表。</span><span class="sxs-lookup"><span data-stu-id="7be71-126">Contains a list of task-oriented topics in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] Books Online that are particularly relevant to troubleshooting an availability group configuration.</span></span>|
|[<span data-ttu-id="7be71-127">相关内容</span><span class="sxs-lookup"><span data-stu-id="7be71-127">Related Content</span></span>](#RelatedContent)|<span data-ttu-id="7be71-128">包含 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 联机丛书以外的相关资源的列表。</span><span class="sxs-lookup"><span data-stu-id="7be71-128">Contains a list of relevant resources that are external to [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Books Online.</span></span>|

##  <a name="alwayson-availability-groups-is-not-enabled"></a><a name="IsHadrEnabled"></a><span data-ttu-id="7be71-129">AlwaysOn 可用性组未启用</span><span class="sxs-lookup"><span data-stu-id="7be71-129">AlwaysOn Availability Groups Is Not Enabled</span></span>
 <span data-ttu-id="7be71-130">必须在每个 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 实例上启用 [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)]功能。</span><span class="sxs-lookup"><span data-stu-id="7be71-130">The [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] feature must be enabled on each of the instances of [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="7be71-131">有关详细信息，请参阅[启用和禁用 AlwaysOn 可用性组 (SQL Server)](enable-and-disable-always-on-availability-groups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-131">For more information, see [Enable and Disable AlwaysOn Availability Groups &#40;SQL Server&#41;](enable-and-disable-always-on-availability-groups-sql-server.md).</span></span>

##  <a name="accounts"></a><a name="Accounts"></a> <span data-ttu-id="7be71-132">帐户</span><span class="sxs-lookup"><span data-stu-id="7be71-132">Accounts</span></span>
 <span data-ttu-id="7be71-133">必须正确配置运行 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 所用的帐户。</span><span class="sxs-lookup"><span data-stu-id="7be71-133">The accounts under which [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is running must be correctly configured.</span></span>

1.  <span data-ttu-id="7be71-134">帐户是否具有正确的权限？</span><span class="sxs-lookup"><span data-stu-id="7be71-134">Do the accounts have the correct permissions?</span></span>

    1.  <span data-ttu-id="7be71-135">如果伙伴使用相同的域用户帐户运行，则正确的用户登录名将自动存在于全部两个 **master** 数据库中。</span><span class="sxs-lookup"><span data-stu-id="7be71-135">If the partners run as the same domain user account, the correct user logins exist automatically in both **master** databases.</span></span> <span data-ttu-id="7be71-136">这样可简化数据库的安全配置并建议这样做。</span><span class="sxs-lookup"><span data-stu-id="7be71-136">This simplifies the security configuration the database and is recommended.</span></span>

    2.  <span data-ttu-id="7be71-137">如果两个服务器实例使用不同的帐户运行，则必须在远程服务器实例上的 **master** 数据库中创建每个登录帐户，并且必须向该登录帐户授予 CONNECT 权限，以便连接到该服务器实例的数据库镜像端点。</span><span class="sxs-lookup"><span data-stu-id="7be71-137">If two server instances run as different accounts, the login each account must be created in **master** on the remote server instance, and that login must be granted CONNECT permissions to connect to the database mirroring endpoint of that server instance.</span></span> <span data-ttu-id="7be71-138">有关详细信息，请参阅[设置数据库镜像的登录帐户或 AlwaysOn 可用性组 &#40;SQL Server&#41;](../../database-mirroring/set-up-login-accounts-database-mirroring-always-on-availability.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-138">For more information, see[Set Up Login Accounts for Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](../../database-mirroring/set-up-login-accounts-database-mirroring-always-on-availability.md).</span></span>

2.  <span data-ttu-id="7be71-139">如果 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 正在以内置帐户（例如 Local System、Local Service 或 Network Service）或非域帐户运行，则您必须使用证书来进行端点身份验证。</span><span class="sxs-lookup"><span data-stu-id="7be71-139">If [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is running as a built-in account, such as Local System, Local Service, or Network Service, or a nondomain account, you must use certificates for endpoint authentication.</span></span> <span data-ttu-id="7be71-140">如果您的服务帐户使用的是同一个域中的域帐户，则您可以选择为所有副本位置上的每个服务帐户授予 CONNECT 访问权限，或者您可以使用证书。</span><span class="sxs-lookup"><span data-stu-id="7be71-140">If your service accounts are using domain accounts in the same domain, you can choose to grant CONNECT access for each service account on all the replica locations or you can use certificates.</span></span> <span data-ttu-id="7be71-141">有关详细信息，请参阅[使用数据库镜像终结点证书 (Transact-SQL)](../../database-mirroring/use-certificates-for-a-database-mirroring-endpoint-transact-sql.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-141">For more information, see[Use Certificates for a Database Mirroring Endpoint &#40;Transact-SQL&#41;](../../database-mirroring/use-certificates-for-a-database-mirroring-endpoint-transact-sql.md).</span></span>

##  <a name="endpoints"></a><a name="Endpoints"></a> <span data-ttu-id="7be71-142">Endpoints</span><span class="sxs-lookup"><span data-stu-id="7be71-142">Endpoints</span></span>
 <span data-ttu-id="7be71-143">必须正确配置端点。</span><span class="sxs-lookup"><span data-stu-id="7be71-143">Endpoints must be correctly configured.</span></span>

1.  <span data-ttu-id="7be71-144">确保要托管可用性副本（每个副本位置）的各个 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例都具有数据库镜像终结点。</span><span class="sxs-lookup"><span data-stu-id="7be71-144">Make sure that each instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] that is going to host an availability replica (each *replica location*) has a database mirroring endpoint.</span></span> <span data-ttu-id="7be71-145">若要确定给定服务器实例上是否存在数据库镜像终结点，请使用 [sys.database_mirroring_endpoints](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql) 目录视图。</span><span class="sxs-lookup"><span data-stu-id="7be71-145">To determine whether a database mirroring endpoint exists on a given server instance, use the [sys.database_mirroring_endpoints](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql) catalog view.</span></span> <span data-ttu-id="7be71-146">有关详细信息，请参阅[创建 Windows 身份验证的数据库镜像终结点 (Transact-SQL)](../../database-mirroring/create-a-database-mirroring-endpoint-for-windows-authentication-transact-sql.md) 或[允许数据库镜像终结点使用证书进行出站连接 (Transact-SQL)](../../database-mirroring/database-mirroring-use-certificates-for-outbound-connections.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-146">For more information, see either [Create a Database Mirroring Endpoint for Windows Authentication &#40;Transact-SQL&#41;](../../database-mirroring/create-a-database-mirroring-endpoint-for-windows-authentication-transact-sql.md) or [Allow a Database Mirroring Endpoint to Use Certificates for Outbound Connections &#40;Transact-SQL&#41;](../../database-mirroring/database-mirroring-use-certificates-for-outbound-connections.md).</span></span>

2.  <span data-ttu-id="7be71-147">检查端口号是否正确。</span><span class="sxs-lookup"><span data-stu-id="7be71-147">Check that the port numbers are correct.</span></span>

     <span data-ttu-id="7be71-148">若要标识当前与服务器实例的数据库镜像端点关联的端口，请使用以下 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句：</span><span class="sxs-lookup"><span data-stu-id="7be71-148">To identify the port currently associated with database mirroring endpoint of a server instance, use the following [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement:</span></span>

    ```
    SELECT type_desc, port FROM sys.tcp_endpoints;
    GO
    ```

3.  <span data-ttu-id="7be71-149">对于难以解释的 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] 设置问题，建议您检查每个服务器实例以确定它是否正在侦听相应的端口。</span><span class="sxs-lookup"><span data-stu-id="7be71-149">For [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] setup issues that are difficult to explain, we recommend that you inspect each server instance to determine whether it is listening on the correct ports.</span></span> <span data-ttu-id="7be71-150">有关验证端口可用性的信息，请参阅 [MSSQLSERVER_1418](../../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-150">For information about verifying port availability, see [MSSQLSERVER_1418](../../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md).</span></span>

4.  <span data-ttu-id="7be71-151">确保已启动端点 (STATE = STARTED)。</span><span class="sxs-lookup"><span data-stu-id="7be71-151">Make sure that the endpoints are started (STATE=STARTED).</span></span> <span data-ttu-id="7be71-152">对于各个服务器实例，使用以下 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句：</span><span class="sxs-lookup"><span data-stu-id="7be71-152">On each server instance, use the following [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement:</span></span>

    ```
    SELECT state_desc FROM sys.database_mirroring_endpoints
    ```

     <span data-ttu-id="7be71-153">有关 **state_desc** 列的详细信息，请参阅 [sys.database_mirroring_endpoints (Transact-SQL)](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="7be71-153">For more information about the **state_desc** column, see [sys.database_mirroring_endpoints &#40;Transact-SQL&#41;](/sql/relational-databases/system-catalog-views/sys-database-mirroring-endpoints-transact-sql).</span></span>

     <span data-ttu-id="7be71-154">若要启动端点，请使用以下 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句：</span><span class="sxs-lookup"><span data-stu-id="7be71-154">To start an endpoint, use the following [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement:</span></span>

    ```
    ALTER ENDPOINT Endpoint_Mirroring 
    STATE = STARTED 
    AS TCP (LISTENER_PORT = <port_number>)
    FOR database_mirroring (ROLE = ALL);
    GO
    ```

     <span data-ttu-id="7be71-155">有关详细信息，请参阅 [ALTER ENDPOINT (Transact-SQL)](/sql/t-sql/statements/alter-endpoint-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="7be71-155">For more information, see [ALTER ENDPOINT &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-endpoint-transact-sql).</span></span>

5.  <span data-ttu-id="7be71-156">确保其他服务器的登录帐户具有 CONNECT 权限。</span><span class="sxs-lookup"><span data-stu-id="7be71-156">Make sure that the login from the other server has CONNECT permission.</span></span> <span data-ttu-id="7be71-157">若要确定哪个登录帐户拥有对端点的 CONNECT 权限，请对每个服务器实例使用以下 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句：</span><span class="sxs-lookup"><span data-stu-id="7be71-157">To determine who has CONNECT permission for an endpoint, on each server instance use the following [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement:</span></span>

    ```
    SELECT 'Metadata Check';
    SELECT EP.name, SP.STATE, 
       CONVERT(nvarchar(38), suser_name(SP.grantor_principal_id)) 
          AS GRANTOR, 
       SP.TYPE AS PERMISSION,
       CONVERT(nvarchar(46),suser_name(SP.grantee_principal_id)) 
          AS GRANTEE 
       FROM sys.server_permissions SP , sys.endpoints EP
       WHERE SP.major_id = EP.endpoint_id
       ORDER BY Permission,grantor, grantee; 
    GO

    ```

##  <a name="system-name"></a><a name="SystemName"></a> <span data-ttu-id="7be71-158">System Name</span><span class="sxs-lookup"><span data-stu-id="7be71-158">System Name</span></span>
 <span data-ttu-id="7be71-159">对于端点 URL 中服务器实例的系统名称，可以使用明确标识系统的任何名称。</span><span class="sxs-lookup"><span data-stu-id="7be71-159">For the system name of a server instance in an endpoint URL, you can use any name that unambiguously identifies the system.</span></span> <span data-ttu-id="7be71-160">服务器地址可以是系统名称（如果各系统都在同一个域中）、完全限定域名或 IP 地址（最好是静态 IP 地址）。</span><span class="sxs-lookup"><span data-stu-id="7be71-160">The server address can be a system name (if the systems are in the same domain), a fully qualified domain name, or an IP address (preferably, a static IP address).</span></span> <span data-ttu-id="7be71-161">保证使用完全限定域名的有效性。</span><span class="sxs-lookup"><span data-stu-id="7be71-161">Using the fully qualified domain name is guaranteed to work.</span></span> <span data-ttu-id="7be71-162">有关详细信息，请参阅 [在添加或修改可用性副本时指定终结点 URL (SQL Server)](specify-endpoint-url-adding-or-modifying-availability-replica.md)配置服务器实例时遇到的典型问题。</span><span class="sxs-lookup"><span data-stu-id="7be71-162">For more information, see [Specify the Endpoint URL When Adding or Modifying an Availability Replica &#40;SQL Server&#41;](specify-endpoint-url-adding-or-modifying-availability-replica.md).</span></span>

##  <a name="network-access"></a><a name="NetworkAccess"></a> <span data-ttu-id="7be71-163">Network Access</span><span class="sxs-lookup"><span data-stu-id="7be71-163">Network Access</span></span>
 <span data-ttu-id="7be71-164">要承载可用性副本的每个服务器实例必须能够通过 TCP 访问其他各个服务器实例的端口。</span><span class="sxs-lookup"><span data-stu-id="7be71-164">Each server instance that is hosting an availability replica must be able to access the port of each of the other server instance over TCP.</span></span> <span data-ttu-id="7be71-165">当服务器实例位于相互不信任的不同域（不可信的域）中时，这尤为重要。</span><span class="sxs-lookup"><span data-stu-id="7be71-165">This is especially important if the server instances are in different domains that do not trust each other (untrusted domains).</span></span>

##  <a name="endpoint-access-sql-server-error-1418"></a><a name="Msg1418"></a> <span data-ttu-id="7be71-166">端点访问（SQL Server 错误 1418）</span><span class="sxs-lookup"><span data-stu-id="7be71-166">Endpoint Access (SQL Server Error 1418)</span></span>
 <span data-ttu-id="7be71-167">此 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 消息指示无法到达端点 URL 中指定的服务器网络地址或该地址不存在，同时建议您确认网络地址名称并重新发出命令。</span><span class="sxs-lookup"><span data-stu-id="7be71-167">This [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] message indicates that the server network address specified in the endpoint URL cannot be reached or does not exist, and it suggests that you verify the network address name and reissue the command.</span></span> <span data-ttu-id="7be71-168">有关详细信息，请参阅 [MSSQLSERVER_1418](../../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md)。</span><span class="sxs-lookup"><span data-stu-id="7be71-168">For more information, see [MSSQLSERVER_1418](../../../relational-databases/errors-events/mssqlserver-1418-database-engine-error.md).</span></span>

##  <a name="join-database-fails-sql-server-error-35250"></a><a name="JoinDbFails"></a> <span data-ttu-id="7be71-169">联接数据库失败（SQL Server 错误 35250）</span><span class="sxs-lookup"><span data-stu-id="7be71-169">Join Database Fails (SQL Server Error 35250)</span></span>
 <span data-ttu-id="7be71-170">此部分介绍由于与主副本的连接处于非活动状态而导致未能将辅助数据库联接到可用性组的可能原因和解决方法。</span><span class="sxs-lookup"><span data-stu-id="7be71-170">This section discusses the possible causes and resolution of a failure to join secondary databases to the availability group because the connection to the primary replica is not active.</span></span>

 <span data-ttu-id="7be71-171">**解决方法：**</span><span class="sxs-lookup"><span data-stu-id="7be71-171">**Resolution:**</span></span>

1.  <span data-ttu-id="7be71-172">检查防火墙设置，确定是否允许在承载主副本的服务器实例与辅助副本之间进行端点端口通信（默认情况下为端口 5022）。</span><span class="sxs-lookup"><span data-stu-id="7be71-172">Check the firewall setting to see if whether allows the endpoint port communication between the server instances that host primary replica and the secondary replica (port 5022 by default).</span></span>

2.  <span data-ttu-id="7be71-173">检查网络服务帐户是否拥有对端点的 CONNECT 权限。</span><span class="sxs-lookup"><span data-stu-id="7be71-173">Check whether the network service account has connect permission to the endpoint.</span></span>

##  <a name="read-only-routing-is-not-working-correctly"></a><a name="ROR"></a> <span data-ttu-id="7be71-174">只读路由未正确工作</span><span class="sxs-lookup"><span data-stu-id="7be71-174">Read-Only Routing is Not Working Correctly</span></span>
 <span data-ttu-id="7be71-175">验证以下配置值设置并且根据需要进行更正。</span><span class="sxs-lookup"><span data-stu-id="7be71-175">Verify the following configuration values settings and correct them if necessary.</span></span>

||<span data-ttu-id="7be71-176">On...</span><span class="sxs-lookup"><span data-stu-id="7be71-176">On...</span></span>|<span data-ttu-id="7be71-177">操作</span><span class="sxs-lookup"><span data-stu-id="7be71-177">Action</span></span>|<span data-ttu-id="7be71-178">注释</span><span class="sxs-lookup"><span data-stu-id="7be71-178">Comments</span></span>|<span data-ttu-id="7be71-179">链接</span><span class="sxs-lookup"><span data-stu-id="7be71-179">Link</span></span>|
|------|---------|------------|--------------|----------|
|<span data-ttu-id="7be71-180">![复选框](../../media/checkboxemptycenterxtraspacetopandright.gif "复选框")</span><span class="sxs-lookup"><span data-stu-id="7be71-180">![Checkbox](../../media/checkboxemptycenterxtraspacetopandright.gif "Checkbox")</span></span>|<span data-ttu-id="7be71-181">当前主副本</span><span class="sxs-lookup"><span data-stu-id="7be71-181">Current primary replica</span></span>|<span data-ttu-id="7be71-182">确保可用性组侦听器处于联机状态。</span><span class="sxs-lookup"><span data-stu-id="7be71-182">Ensure that the availability group listener is online.</span></span>|<span data-ttu-id="7be71-183">**验证侦听器是否处于联机状态：**</span><span class="sxs-lookup"><span data-stu-id="7be71-183">**To verify whether the listener is online:**</span></span><br /><br /> `SELECT * FROM sys.dm_tcp_listener_states;`<br /><br /> <span data-ttu-id="7be71-184">**重新启动处于脱机状态的侦听器：**</span><span class="sxs-lookup"><span data-stu-id="7be71-184">**To restart an offline listener:**</span></span><br /><br /> `ALTER AVAILABILITY GROUP myAG RESTART LISTENER 'myAG_Listener';`|[<span data-ttu-id="7be71-185">sys.dm_tcp_listener_states (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-185">sys.dm_tcp_listener_states &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/sys-dm-tcp-listener-states-transact-sql)<br /><br /> [<span data-ttu-id="7be71-186">ALTER AVAILABILITY GROUP (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-186">ALTER AVAILABILITY GROUP &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-availability-group-transact-sql)|
|<span data-ttu-id="7be71-187">![复选框](../../media/checkboxemptycenterxtraspacetopandright.gif "复选框")</span><span class="sxs-lookup"><span data-stu-id="7be71-187">![Checkbox](../../media/checkboxemptycenterxtraspacetopandright.gif "Checkbox")</span></span>|<span data-ttu-id="7be71-188">当前主副本</span><span class="sxs-lookup"><span data-stu-id="7be71-188">Current primary replica</span></span>|<span data-ttu-id="7be71-189">确保 READ_ONLY_ROUTING_LIST 仅包含承载可读辅助副本的服务器实例。</span><span class="sxs-lookup"><span data-stu-id="7be71-189">Ensure that the READ_ONLY_ROUTING_LIST contains only server instances that are hosting a readable secondary replica.</span></span>|<span data-ttu-id="7be71-190">**标识可读次要副本：** sys.availability_replicas（**secondary_role_allow_connections_desc** 列）</span><span class="sxs-lookup"><span data-stu-id="7be71-190">**To identify readable secondary replicas:** sys.availability_replicas  (**secondary_role_allow_connections_desc** column)</span></span><br /><br /> <span data-ttu-id="7be71-191">**查看只读路由列表：** sys.availability_read_only_routing_lists</span><span class="sxs-lookup"><span data-stu-id="7be71-191">**To view a read-only routing list:** sys.availability_read_only_routing_lists</span></span><br /><br /> <span data-ttu-id="7be71-192">**更改只读路由列表：** ALTER AVAILABILITY GROUP</span><span class="sxs-lookup"><span data-stu-id="7be71-192">**To change a read-only routing list:** ALTER AVAILABILITY GROUP</span></span>|[<span data-ttu-id="7be71-193">sys.availability_replicas (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-193">sys.availability_replicas &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-replicas-transact-sql)<br /><br /> [<span data-ttu-id="7be71-194">sys.availability_read_only_routing_lists (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-194">sys.availability_read_only_routing_lists &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-read-only-routing-lists-transact-sql)<br /><br /> [<span data-ttu-id="7be71-195">ALTER AVAILABILITY GROUP (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-195">ALTER AVAILABILITY GROUP &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-availability-group-transact-sql)|
|<span data-ttu-id="7be71-196">![复选框](../../media/checkboxemptycenterxtraspacetopandright.gif "复选框")</span><span class="sxs-lookup"><span data-stu-id="7be71-196">![Checkbox](../../media/checkboxemptycenterxtraspacetopandright.gif "Checkbox")</span></span>|<span data-ttu-id="7be71-197">read_only_routing_list 中的每个副本</span><span class="sxs-lookup"><span data-stu-id="7be71-197">Every replica in the read_only_routing_list</span></span>|<span data-ttu-id="7be71-198">请确保 Windows 防火墙未在阻止 READ_ONLY_ROUTING_URL 端口。</span><span class="sxs-lookup"><span data-stu-id="7be71-198">Ensure that the Windows firewall is not blocking the READ_ONLY_ROUTING_URL port.</span></span>|-|[<span data-ttu-id="7be71-199">为数据库引擎访问配置 Windows 防火墙</span><span class="sxs-lookup"><span data-stu-id="7be71-199">Configure a Windows Firewall for Database Engine Access</span></span>](../../configure-windows/configure-a-windows-firewall-for-database-engine-access.md)|
|<span data-ttu-id="7be71-200">![复选框](../../media/checkboxemptycenterxtraspacetopandright.gif "复选框")</span><span class="sxs-lookup"><span data-stu-id="7be71-200">![Checkbox](../../media/checkboxemptycenterxtraspacetopandright.gif "Checkbox")</span></span>|<span data-ttu-id="7be71-201">read_only_routing_list 中的每个副本</span><span class="sxs-lookup"><span data-stu-id="7be71-201">Every replica in the read_only_routing_list</span></span>|<span data-ttu-id="7be71-202">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 配置管理器中，请确认：</span><span class="sxs-lookup"><span data-stu-id="7be71-202">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Configuration Manager, verify that:</span></span><br /><br /> <span data-ttu-id="7be71-203">已启用 SQL Server 远程连接。</span><span class="sxs-lookup"><span data-stu-id="7be71-203">SQL Server remote connectivity is enabled.</span></span><br /><br /> <span data-ttu-id="7be71-204">已启用 TCP/IP。</span><span class="sxs-lookup"><span data-stu-id="7be71-204">TCP/IP is enabled.</span></span><br /><br /> <span data-ttu-id="7be71-205">IP 地址已正确配置。</span><span class="sxs-lookup"><span data-stu-id="7be71-205">The IP addresses are configured correctly.</span></span>|-|[<span data-ttu-id="7be71-206">查看或更改服务器属性 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-206">View or Change Server Properties &#40;SQL Server&#41;</span></span>](../../configure-windows/view-or-change-server-properties-sql-server.md)<br /><br /> [<span data-ttu-id="7be71-207">配置服务器以侦听特定 TCP 端口（SQL Server 配置管理器）</span><span class="sxs-lookup"><span data-stu-id="7be71-207">Configure a Server to Listen on a Specific TCP Port &#40;SQL Server Configuration Manager&#41;</span></span>](../../configure-windows/configure-a-server-to-listen-on-a-specific-tcp-port.md)|
|<span data-ttu-id="7be71-208">![复选框](../../media/checkboxemptycenterxtraspacetopandright.gif "复选框")</span><span class="sxs-lookup"><span data-stu-id="7be71-208">![Checkbox](../../media/checkboxemptycenterxtraspacetopandright.gif "Checkbox")</span></span>|<span data-ttu-id="7be71-209">read_only_routing_list 中的每个副本</span><span class="sxs-lookup"><span data-stu-id="7be71-209">Every replica in the read_only_routing_list</span></span>|<span data-ttu-id="7be71-210">请确保 (TCP：/<strong>/ *`system-address`* ：</strong>*port*) READ_ONLY_ROUTING_URL 包含正确的完全限定域名 (FQDN) 和端口号。</span><span class="sxs-lookup"><span data-stu-id="7be71-210">Ensure that the READ_ONLY_ROUTING_URL (TCP<strong>://*`system-address`*:</strong>*port*) contains the correct fully-qualified domain name (FQDN) and port number.</span></span>|-|[<span data-ttu-id="7be71-211">计算 AlwaysOn 的 read_only_routing_url</span><span class="sxs-lookup"><span data-stu-id="7be71-211">Calculating read_only_routing_url for AlwaysOn</span></span>](https://docs.microsoft.com/archive/blogs/mattn/calculating-read_only_routing_url-for-alwayson)<br /><br /> [<span data-ttu-id="7be71-212">sys.availability_replicas (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-212">sys.availability_replicas &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-availability-replicas-transact-sql)<br /><br /> [<span data-ttu-id="7be71-213">ALTER AVAILABILITY GROUP (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-213">ALTER AVAILABILITY GROUP &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-availability-group-transact-sql)|
|<span data-ttu-id="7be71-214">![复选框](../../media/checkboxemptycenterxtraspacetopandright.gif "复选框")</span><span class="sxs-lookup"><span data-stu-id="7be71-214">![Checkbox](../../media/checkboxemptycenterxtraspacetopandright.gif "Checkbox")</span></span>|<span data-ttu-id="7be71-215">客户端系统</span><span class="sxs-lookup"><span data-stu-id="7be71-215">Client system</span></span>|<span data-ttu-id="7be71-216">确认客户端驱动程序支持只读路由。</span><span class="sxs-lookup"><span data-stu-id="7be71-216">Verify that the client driver supports read-only routing.</span></span>|-|[<span data-ttu-id="7be71-217">AlwaysOn 客户端连接 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-217">AlwaysOn Client Connectivity (SQL Server)</span></span>](always-on-client-connectivity-sql-server.md)|

##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="7be71-218">相关任务</span><span class="sxs-lookup"><span data-stu-id="7be71-218">Related Tasks</span></span>

-   [<span data-ttu-id="7be71-219">创建和配置可用性组 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-219">Creation and Configuration of Availability Groups &#40;SQL Server&#41;</span></span>](creation-and-configuration-of-availability-groups-sql-server.md)

-   [<span data-ttu-id="7be71-220">为 Windows 身份验证创建数据库镜像终结点 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="7be71-220">Create a Database Mirroring Endpoint for Windows Authentication &#40;Transact-SQL&#41;</span></span>](../../database-mirroring/create-a-database-mirroring-endpoint-for-windows-authentication-transact-sql.md)

-   [<span data-ttu-id="7be71-221">在添加或修改可用性副本时指定终结点 URL (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-221">Specify the Endpoint URL When Adding or Modifying an Availability Replica &#40;SQL Server&#41;</span></span>](specify-endpoint-url-adding-or-modifying-availability-replica.md)

-   [<span data-ttu-id="7be71-222">为可用性组手动准备辅助数据库 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-222">Manually Prepare a Secondary Database for an Availability Group &#40;SQL Server&#41;</span></span>](manually-prepare-a-secondary-database-for-an-availability-group-sql-server.md)

-   [<span data-ttu-id="7be71-223">排除失败的添加文件操作 &#40;AlwaysOn 可用性组&#41;</span><span class="sxs-lookup"><span data-stu-id="7be71-223">Troubleshoot a Failed Add-File Operation &#40;AlwaysOn Availability Groups&#41;</span></span>](troubleshoot-a-failed-add-file-operation-always-on-availability-groups.md)

-   [<span data-ttu-id="7be71-224">管理可用性组中数据库的登录名和作业 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-224">Management of Logins and Jobs for the Databases of an Availability Group &#40;SQL Server&#41;</span></span>](../../logins-and-jobs-for-availability-group-databases.md)

-   [<span data-ttu-id="7be71-225">当数据库在其他服务器实例上可用时管理元数据 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7be71-225">Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;</span></span>](../../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md)

##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="7be71-226">相关内容</span><span class="sxs-lookup"><span data-stu-id="7be71-226">Related Content</span></span>

-   <span data-ttu-id="7be71-227">[查看故障转移群集的事件和日志](https://technet.microsoft.com/library/cc772342\(WS.10\).aspx)</span><span class="sxs-lookup"><span data-stu-id="7be71-227">[View Events and Logs for a Failover Cluster](https://technet.microsoft.com/library/cc772342\(WS.10\).aspx)</span></span>

-   [<span data-ttu-id="7be71-228">Get-ClusterLog 故障转移群集 Cmdlet</span><span class="sxs-lookup"><span data-stu-id="7be71-228">Get-ClusterLog Failover Cluster Cmdlet</span></span>](https://technet.microsoft.com/library/ee461045.aspx)

-   [<span data-ttu-id="7be71-229">SQL Server AlwaysOn 团队博客：SQL Server AlwaysOn 官方团队博客</span><span class="sxs-lookup"><span data-stu-id="7be71-229">SQL Server AlwaysOn Team Blog: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)

## <a name="see-also"></a><span data-ttu-id="7be71-230">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7be71-230">See Also</span></span>
 <span data-ttu-id="7be71-231">用于[数据库镜像和 AlwaysOn 可用性组 &#40;的传输安全 SQL Server&#41;](../../database-mirroring/transport-security-database-mirroring-always-on-availability.md) [客户端网络配置](../../configure-windows/client-network-configuration.md)[先决条件、限制和建议](prereqs-restrictions-recommendations-always-on-availability.md)AlwaysOn 可用性组 &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="7be71-231">[Transport Security for Database Mirroring and AlwaysOn Availability Groups &#40;SQL Server&#41;](../../database-mirroring/transport-security-database-mirroring-always-on-availability.md) [Client Network Configuration](../../configure-windows/client-network-configuration.md) [Prerequisites, Restrictions, and Recommendations for AlwaysOn Availability Groups &#40;SQL Server&#41;](prereqs-restrictions-recommendations-always-on-availability.md)</span></span>



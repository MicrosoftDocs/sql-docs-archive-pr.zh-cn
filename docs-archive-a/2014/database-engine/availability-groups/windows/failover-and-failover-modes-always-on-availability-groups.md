---
title: 故障转移和故障转移模式 (AlwaysOn 可用性组) |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- Availability Groups [SQL Server], availability replicas
- Availability Groups [SQL Server], failover
- Availability Groups [SQL Server], failover modes
- failover [SQL Server], AlwaysOn Availability Groups
ms.assetid: 378d2d63-50b9-420b-bafb-d375543fda17
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: eb904cd0f0649c43553b5d6c8b031c5f284901f4
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87585984"
---
# <a name="failover-and-failover-modes-alwayson-availability-groups"></a><span data-ttu-id="3b85d-102">故障转移和故障转移模式（AlwaysOn 可用性组）</span><span class="sxs-lookup"><span data-stu-id="3b85d-102">Failover and Failover Modes (AlwaysOn Availability Groups)</span></span>
  <span data-ttu-id="3b85d-103">在可用性组的上下文中，可用性副本的主角色和辅助角色在称为“故障转移” 的过程中通常是可互换的。</span><span class="sxs-lookup"><span data-stu-id="3b85d-103">Within the context of an availability group, the primary role and secondary role of availability replicas are typically interchangeable in a process known as *failover*.</span></span> <span data-ttu-id="3b85d-104">存在三种故障转移形式：自动故障转移（无数据丢失）、计划的手动故障转移（无数据丢失）和强制手动故障转移（可能丢失数据）。最后一种形式通常称为“强制故障转移”。</span><span class="sxs-lookup"><span data-stu-id="3b85d-104">Three forms of failover exist: automatic failover (without data loss), planned manual failover (without data loss), and forced manual failover (with possible data loss), typically called *forced failover*.</span></span> <span data-ttu-id="3b85d-105">自动故障转移和计划的手动故障转移会保留您的所有数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-105">Automatic and planned manual failover preserve all your data.</span></span> <span data-ttu-id="3b85d-106">可用性组在可用性副本级别进行故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-106">An availability group fails over at the availability-replica level.</span></span> <span data-ttu-id="3b85d-107">也就是说，可用性组故障转移到其次要副本之一（当前故障转移目标）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-107">That is, an availability group fails over to one of its secondary replicas (the current *failover target*).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3b85d-108">在数据库级别，诸如因数据文件丢失而使数据库成为可疑数据库、删除数据库或事务日志损坏之类的数据库问题不会导致可用性组进行故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-108">Issues at the database level, such as a database becoming suspect due to the loss of a data file, deletion of a database, or corruption of a transaction log, do not cause an availability group to failover.</span></span>  
  
 <span data-ttu-id="3b85d-109">在故障转移期间，故障转移目标将接管主角色、恢复其数据库并且使它们作为新的主数据库处于联机状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-109">During the failover, the failover target takes over the primary role, recovers its databases, and brings them online as the new primary databases.</span></span> <span data-ttu-id="3b85d-110">以前的主副本一旦可用将切换为辅助角色，并且其数据库成为辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-110">The former primary replica, when available, switches to the secondary role, and its databases become secondary databases.</span></span> <span data-ttu-id="3b85d-111">在可能的情况下，这些角色可以来回切换（或切换为不同的故障转移目标），以应对多次故障或满足管理的需要。</span><span class="sxs-lookup"><span data-stu-id="3b85d-111">Potentially, these roles can switch back and forth (or to a different failover target) in response to multiple failures or for administrative purposes.</span></span>  
  
 <span data-ttu-id="3b85d-112">“故障转移模式”属性指定某一给定可用性副本支持的故障转移形式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-112">The form(s) of failover that a given availability replica supports is specified by the *failover mode* property.</span></span> <span data-ttu-id="3b85d-113">对于某一给定的可用性副本，可能的故障转移模式取决于该副本的[可用性模式](availability-modes-always-on-availability-groups.md)，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3b85d-113">For a given availability replica, the possible failover modes depends on the [availability mode](availability-modes-always-on-availability-groups.md) of the replica, as follows:</span></span>  
  
-   <span data-ttu-id="3b85d-114">同步提交副本支持两种设置：自动或手动。</span><span class="sxs-lookup"><span data-stu-id="3b85d-114">**Synchronous-commit replicas** support two settings-automatic or manual.</span></span> <span data-ttu-id="3b85d-115">“自动”设置支持自动故障转移和手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-115">The "automatic" setting supports both automatic failover and manual failover.</span></span> <span data-ttu-id="3b85d-116">为了防止丢失数据，自动故障转移和计划的故障转移要求故障转移目标为同步提交的辅助副本且处于正常同步状态（这表示故障转移目标上的每个辅助数据库与相应的主数据库同步）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-116">To prevent data loss, automatic failover and planned failover require that the failover target be a synchronous-commit secondary replica with a healthy synchronization state (this indicates that every secondary database on the failover target is synchronized with its corresponding primary database).</span></span> <span data-ttu-id="3b85d-117">只要某一辅助副本不满足这两个条件，它就仅支持强制故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-117">Whenever a secondary replica does not meet both of these conditions, it supports only forced failover.</span></span> <span data-ttu-id="3b85d-118">请注意，强制故障转移还支持角色处于“正在解析”状态的副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-118">Note that forced failover is also supported a replicas whose role is in the RESOLVING state.</span></span>  
  
-   <span data-ttu-id="3b85d-119">**异步提交副本** 仅支持手动故障转移模式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-119">**Asynchronous-commit replicas** support only the manual failover mode.</span></span> <span data-ttu-id="3b85d-120">此外，因为它们永远不会同步，所以它们仅支持强制故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-120">Moreover, because they are never synchronized, they support only forced failover.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3b85d-121">故障转移后，需要访问主数据库的客户端应用程序必须连接到新的主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-121">After a failover, client applications that need to access the primary databases must connect to the new primary replica.</span></span> <span data-ttu-id="3b85d-122">此外，如果新的辅助副本配置为允许只读访问，则只读客户端应用程序可以连接到它。</span><span class="sxs-lookup"><span data-stu-id="3b85d-122">Also, if the new secondary replica is configured to allow read-only access, read-only client applications can connect to it.</span></span> <span data-ttu-id="3b85d-123">有关客户端如何连接到可用性组的信息，请参阅[可用性组侦听程序、客户端连接和应用程序故障转移 (SQL Server)](../../listeners-client-connectivity-application-failover.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-123">For information about how clients connect to an availability group, see [Availability Group Listeners, Client Connectivity, and Application Failover &#40;SQL Server&#41;](../../listeners-client-connectivity-application-failover.md).</span></span>  
  
  
##  <a name="terms-and-definitions"></a><a name="TermsAndDefinitions"></a> <span data-ttu-id="3b85d-124">术语和定义</span><span class="sxs-lookup"><span data-stu-id="3b85d-124">Terms and Definitions</span></span>  
 <span data-ttu-id="3b85d-125">自动故障转移 (automatic failover)</span><span class="sxs-lookup"><span data-stu-id="3b85d-125">Automatic failover</span></span>  
 <span data-ttu-id="3b85d-126">在丢失主副本时自动发生的故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-126">A failover that occurs automatically on the loss of the primary replica.</span></span> <span data-ttu-id="3b85d-127">仅当当前主副本和一个辅助副本同时配置为使用自动故障转移模式，并且辅助副本当前已同步时，才支持自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-127">Automatic failover is supported only when the current primary and one secondary replica are both configured with failover mode set to AUTOMATIC and the secondary replica currently synchronized.</span></span>  <span data-ttu-id="3b85d-128">如果主副本或辅助副本的故障转移模式设置为手动，则不能发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-128">If the failover mode of either the primary or secondary replica is MANUAL, automatic failover cannot occur.</span></span>  
  
 <span data-ttu-id="3b85d-129">计划的手动故障转移（无数据丢失）</span><span class="sxs-lookup"><span data-stu-id="3b85d-129">Planned manual failover (without data loss)</span></span>  
 <span data-ttu-id="3b85d-130">计划的手动故障转移或“手动故障转移”通常是由数据库管理员为了进行管理而启动的故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-130">Planned manual failover, or *manual failover*, is a failover that is initiated by a database administrator, typically, for administrative purposes.</span></span> <span data-ttu-id="3b85d-131">仅当主副本和辅助副本同时配置为使用同步提交模式并且辅助副本当前已同步（处于同步状态）时，才支持计划的手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-131">A planned manual failover is supported only if both the primary replica and secondary replica are configured for synchronous-commit mode and the secondary replica is currently synchronized (in the SYNCHRONIZED state).</span></span> <span data-ttu-id="3b85d-132">当目标辅助副本同步后，即使主副本已崩溃，也可以进行手动故障转移（无数据丢失），因为辅助数据库已准备好进行故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-132">When the target secondary replica is synchronized, manual failover (without data loss) is possible even if the primary replica has crashed because the secondary databases are ready for failover.</span></span> <span data-ttu-id="3b85d-133">数据库管理员需要手动启动手动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-133">A database administrator manually initiates a manual failover.</span></span>  
  
 <span data-ttu-id="3b85d-134">强制故障转移（可能丢失数据）</span><span class="sxs-lookup"><span data-stu-id="3b85d-134">Forced failover (with possible data loss)</span></span>  
 <span data-ttu-id="3b85d-135">当没有任何辅助副本与主副本同步，或者主副本未运行且没有辅助副本准备好进行故障转移时，可由数据库管理员启动的故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-135">A failover that can be initiated by a database administrator when no secondary replica is SYNCHRONIZED with the primary replica or the primary replica is not running and no secondary replica is failover ready.</span></span> <span data-ttu-id="3b85d-136">强制故障转移存在数据丢失的风险，建议严格限制用于灾难恢复。</span><span class="sxs-lookup"><span data-stu-id="3b85d-136">Forced failover risks possible data loss and is recommended strictly for disaster recovery.</span></span> <span data-ttu-id="3b85d-137">强制故障转移也称为强制手动故障转移，因为它只能手动启动。</span><span class="sxs-lookup"><span data-stu-id="3b85d-137">Forced failover is also known as forced manual failover because it can only be initiated manually.</span></span> <span data-ttu-id="3b85d-138">这是异步提交可用性模式下支持的唯一故障转移形式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-138">This is the only form of failover supported by in asynchronous-commit availability mode.</span></span>  
  
 [!INCLUDE[ssFosAutoC](../../../includes/ssfosautoc-md.md)]  
 <span data-ttu-id="3b85d-139">在给定的可用性组中，仅当一对可用性副本（包括当前主副本）配置为使用同步提交模式以及自动故障转移（如果有）时，才发生这种故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-139">Within a given availability group, a pair of availability replicas (including the current primary replica) that are configured for synchronous-commit mode with automatic failover, if any.</span></span> <span data-ttu-id="3b85d-140">仅当辅助副本当前已与主副本同步时，[!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]才会生效。</span><span class="sxs-lookup"><span data-stu-id="3b85d-140">An[!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]takes effect only if the secondary replica is currently SYNCHRONIZED with the primary replica.</span></span>  
  
 [!INCLUDE[ssFosSyncC](../../../includes/ssfossyncc-md.md)]  
 <span data-ttu-id="3b85d-141">在给定的可用性组中，仅当一组（两个或三个）可用性副本（包括当前主副本）配置为使用同步提交模式（如果有）时，才发生这种故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-141">Within a given availability group, a set of two or three availability replicas (including the current primary replica) that are configured for synchronous-commit mode, if any.</span></span> <span data-ttu-id="3b85d-142">仅当辅助副本配置为使用手动故障转移模式，并且至少一个辅助副本当前与主要副本同步时， [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]才会生效。</span><span class="sxs-lookup"><span data-stu-id="3b85d-142">A [!INCLUDE[ssFosSync](../../../includes/ssfossync-md.md)]takes effect only if the secondary replicas are configured for manual failover mode and at least one secondary replica is currently SYNCHRONIZED with the primary replica.</span></span>  
  
 [!INCLUDE[ssFosEntireC](../../../includes/ssfosentirec-md.md)]  
 <span data-ttu-id="3b85d-143">在给定的可用性组内，其运行状态当前为联机的所有可用性副本的集合，而不考虑可用性模式和故障转移模式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-143">Within a given availability group, the set of all availability replicas whose operational state is currently ONLINE, regardless of availability mode and of failover mode.</span></span> <span data-ttu-id="3b85d-144">仅在当前没有辅助副本与主要副本同步时， [!INCLUDE[ssFosEntire](../../../includes/ssfosentire-md.md)]才会变为相关。</span><span class="sxs-lookup"><span data-stu-id="3b85d-144">The [!INCLUDE[ssFosEntire](../../../includes/ssfosentire-md.md)]becomes relevant when no secondary replica is currently SYNCHRONIZED with the primary replica.</span></span>  
  
##  <a name="overview-of-failover"></a><a name="Overview"></a> <span data-ttu-id="3b85d-145">故障转移的概述</span><span class="sxs-lookup"><span data-stu-id="3b85d-145">Overview of Failover</span></span>  
 <span data-ttu-id="3b85d-146">下表概述了在不同的可用性和故障转移模式下支持的故障转移形式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-146">The following table summarizes which forms of failover are supported under different availability and failover modes.</span></span> <span data-ttu-id="3b85d-147">对于每个对，有效的可用性模式和故障转移模式由主副本的模式和一个或多个辅助副本的模式的交集决定。</span><span class="sxs-lookup"><span data-stu-id="3b85d-147">For each pairing, the effective availability mode and failover mode is determined by the intersection of the modes of the primary replica plus the modes of one or more secondary replicas.</span></span>  
  
||<span data-ttu-id="3b85d-148">异步提交模式</span><span class="sxs-lookup"><span data-stu-id="3b85d-148">Asynchronous-commit mode</span></span>|<span data-ttu-id="3b85d-149">同步提交模式（手动故障转移模式）</span><span class="sxs-lookup"><span data-stu-id="3b85d-149">Synchronous-commit mode with manual-failover mode</span></span>|<span data-ttu-id="3b85d-150">同步提交模式（自动故障转移模式）</span><span class="sxs-lookup"><span data-stu-id="3b85d-150">Synchronous-commit mode with automatic-failover mode</span></span>|  
|-|-------------------------------|---------------------------------------------------------|------------------------------------------------------------|  
|<span data-ttu-id="3b85d-151">自动故障转移 (automatic failover)</span><span class="sxs-lookup"><span data-stu-id="3b85d-151">Automatic failover</span></span>|<span data-ttu-id="3b85d-152">否</span><span class="sxs-lookup"><span data-stu-id="3b85d-152">No</span></span>|<span data-ttu-id="3b85d-153">否</span><span class="sxs-lookup"><span data-stu-id="3b85d-153">No</span></span>|<span data-ttu-id="3b85d-154">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-154">Yes</span></span>|  
|<span data-ttu-id="3b85d-155">计划的手动故障转移</span><span class="sxs-lookup"><span data-stu-id="3b85d-155">Planned manual failover</span></span>|<span data-ttu-id="3b85d-156">否</span><span class="sxs-lookup"><span data-stu-id="3b85d-156">No</span></span>|<span data-ttu-id="3b85d-157">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-157">Yes</span></span>|<span data-ttu-id="3b85d-158">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-158">Yes</span></span>|  
|<span data-ttu-id="3b85d-159">强制故障转移</span><span class="sxs-lookup"><span data-stu-id="3b85d-159">Forced failover</span></span>|<span data-ttu-id="3b85d-160">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-160">Yes</span></span>|<span data-ttu-id="3b85d-161">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-161">Yes</span></span>|<span data-ttu-id="3b85d-162">是的**<sup>\*</sup>**</span><span class="sxs-lookup"><span data-stu-id="3b85d-162">Yes**<sup>\*</sup>**</span></span>|  
  
 <span data-ttu-id="3b85d-163">**<sup>\*</sup>** 如果对已同步的辅助副本发出强制故障转移命令，则辅助副本的行为与手动故障转移相同。</span><span class="sxs-lookup"><span data-stu-id="3b85d-163">**<sup>\*</sup>**  If you issue a forced failover command on a synchronized secondary replica, the secondary replica behaves the same as for a manual failover.</span></span>  
  
 <span data-ttu-id="3b85d-164">在故障转移过程中，数据库不可用的时间取决于故障转移的类型及其原因。</span><span class="sxs-lookup"><span data-stu-id="3b85d-164">The amount of time that the database is unavailable during a failover depends on the type of failover and its cause.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3b85d-165">为了支持在故障转移后进行客户端连接，除包含的数据库外，必须在新的主数据库上手动重新创建在任何先前主数据库上定义的登录名和作业。</span><span class="sxs-lookup"><span data-stu-id="3b85d-165">To support client connections after failover, except for contained databases, logins and jobs defined on any of the former primary databases must be manually recreated on the new primary database.</span></span> <span data-ttu-id="3b85d-166">有关详细信息，请参阅 [管理可用性组中数据库的登录名和作业 (SQL Server)](../../logins-and-jobs-for-availability-group-databases.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-166">For more information, see [Management of Logins and Jobs for the Databases of an Availability Group &#40;SQL Server&#41;](../../logins-and-jobs-for-availability-group-databases.md).</span></span>  
  
### <a name="failover-sets"></a><span data-ttu-id="3b85d-167">故障转移集</span><span class="sxs-lookup"><span data-stu-id="3b85d-167">Failover Sets</span></span>  
 <span data-ttu-id="3b85d-168">就故障转移集而言，可理解为某一给定可用性组的可能的各种故障转移形式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-168">The forms of failover that are possible for a given availability group can be understood in terms of failover sets.</span></span> <span data-ttu-id="3b85d-169">一个故障转移集由主副本和支持某一给定故障转移形式的辅助副本构成，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3b85d-169">A failover set consists of the primary replica and secondary replicas that support a given form of failover, as follows:</span></span>  
  
-   <span data-ttu-id="3b85d-170">**[!INCLUDE[ssFosAutoC](../../../includes/ssfosautoc-md.md)]（可选）：** 在给定的可用性组中，仅当一对可用性副本（包括当前主副本）配置为使用同步提交模式以及自动故障转移（如果有）时，才发生这种故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-170">**[!INCLUDE[ssFosAutoC](../../../includes/ssfosautoc-md.md)] (optional):**  Within a given availability group, a pair of availability replicas (including the current primary replica) that are configured for synchronous-commit mode with automatic failover, if any.</span></span> <span data-ttu-id="3b85d-171">仅当辅助副本当前已与主副本同步时，自动故障转移集才会生效。</span><span class="sxs-lookup"><span data-stu-id="3b85d-171">An automatic failover set takes effect only if the secondary replica is currently SYNCHRONIZED with the primary replica.</span></span>  
  
-   <span data-ttu-id="3b85d-172">**[!INCLUDE[ssFosSyncC](../../../includes/ssfossyncc-md.md)]（可选）：** 在给定的可用性组中，仅当一组（两个或三个）可用性副本（包括当前主副本）配置为使用同步提交模式（如果有）时，才发生这种故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-172">**[!INCLUDE[ssFosSyncC](../../../includes/ssfossyncc-md.md)] (optional):**  Within a given availability group, a set of two or three availability replicas (including the current primary replica) that are configured for synchronous-commit mode, if any.</span></span> <span data-ttu-id="3b85d-173">仅当辅助副本配置为使用手动故障转移模式，并且至少一个辅助副本当前已与主副本同步时，同步提交故障转移集才会生效。</span><span class="sxs-lookup"><span data-stu-id="3b85d-173">A synchronous-commit failover set takes effect only if the secondary replicas are configured for manual failover mode and at least one secondary replica is currently SYNCHRONIZED with the primary replica.</span></span>  
  
-   <span data-ttu-id="3b85d-174">**[!INCLUDE[ssFosEntireC](../../../includes/ssfosentirec-md.md)]：** 在给定的可用性组内，其运行状态当前为联机的所有可用性副本的集合，而不考虑可用性模式和故障转移模式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-174">**[!INCLUDE[ssFosEntireC](../../../includes/ssfosentirec-md.md)] :**  Within a given availability group, the set of all availability replicas whose operational state is currently ONLINE, regardless of availability mode and of failover mode.</span></span> <span data-ttu-id="3b85d-175">仅当当前没有辅助副本已与主副本同步时，整个故障转移集才会变为相关的。</span><span class="sxs-lookup"><span data-stu-id="3b85d-175">The entire failover set becomes relevant when no secondary replica is currently SYNCHRONIZED with the primary replica.</span></span>  
  
 <span data-ttu-id="3b85d-176">当您将可用性副本配置为同步提交以及自动故障转移时，此可用性副本将成为 [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)]的一部分。</span><span class="sxs-lookup"><span data-stu-id="3b85d-176">When you configure an availability replica as synchronous commit with automatic failover, the availability replica becomes part of the [!INCLUDE[ssFosAuto](../../../includes/ssfosauto-md.md)].</span></span> <span data-ttu-id="3b85d-177">但是，该集是否生效则取决于当前主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-177">However whether the set takes effect depends the current primary.</span></span> <span data-ttu-id="3b85d-178">在某一给定时间实际可用的故障转移形式取决于当前有效的故障转移集。</span><span class="sxs-lookup"><span data-stu-id="3b85d-178">The forms of failover that are actually possible at a given time depends on what failover sets are currently in effect.</span></span>  
  
 <span data-ttu-id="3b85d-179">例如，考虑一个可用性组，它有四个可用性副本，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3b85d-179">For example, consider an availability group that has four availability replicas, as follows:</span></span>  
  
|<span data-ttu-id="3b85d-180">副本</span><span class="sxs-lookup"><span data-stu-id="3b85d-180">Replica</span></span>|<span data-ttu-id="3b85d-181">可用性模式和故障转移模式设置</span><span class="sxs-lookup"><span data-stu-id="3b85d-181">Availability Mode and Failover Mode Settings</span></span>|  
|-------------|--------------------------------------------------|  
|<span data-ttu-id="3b85d-182">A</span><span class="sxs-lookup"><span data-stu-id="3b85d-182">A</span></span>|<span data-ttu-id="3b85d-183">同步提交模式（自动故障转移）</span><span class="sxs-lookup"><span data-stu-id="3b85d-183">Synchronous commit with automatic failover</span></span>|  
|<span data-ttu-id="3b85d-184">B</span><span class="sxs-lookup"><span data-stu-id="3b85d-184">B</span></span>|<span data-ttu-id="3b85d-185">同步提交模式（自动故障转移）</span><span class="sxs-lookup"><span data-stu-id="3b85d-185">Synchronous commit with automatic failover</span></span>|  
|<span data-ttu-id="3b85d-186">C</span><span class="sxs-lookup"><span data-stu-id="3b85d-186">C</span></span>|<span data-ttu-id="3b85d-187">同步提交模式（仅限计划的手动故障转移）</span><span class="sxs-lookup"><span data-stu-id="3b85d-187">Synchronous commit with planned manual failover only</span></span>|  
|<span data-ttu-id="3b85d-188">D</span><span class="sxs-lookup"><span data-stu-id="3b85d-188">D</span></span>|<span data-ttu-id="3b85d-189">异步提交模式（仅限强制故障转移）</span><span class="sxs-lookup"><span data-stu-id="3b85d-189">Asynchronous commit (with only forced failover)</span></span>|  
  
 <span data-ttu-id="3b85d-190">每个辅助副本的故障转移行为取决于哪个可用性副本当前是主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-190">The failover behavior for each secondary replica depends on which availability replica is currently the primary replica.</span></span> <span data-ttu-id="3b85d-191">基本上，对于给定的辅助副本而言，针对当前主副本的故障转移行为是最坏的情况。</span><span class="sxs-lookup"><span data-stu-id="3b85d-191">Basically, for a given secondary replica, the failover behavior is the worst case given the current primary replica.</span></span> <span data-ttu-id="3b85d-192">下图说明辅助副本的故障转移行为如何随当前主副本而变化，以及该行为是配置为异步提交模式（仅限强制故障转移）还是同步提交模式（具有或没有自动故障转移）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-192">The following figure illustrates how the failover behavior of secondary replicas varies depending on the current primary replica, and whether it is configured for asynchronous-commit mode (with only forced failover) or synchronous-commit mode (with or without automatic failover).</span></span>  
  
 <span data-ttu-id="3b85d-193">![主副本配置对故障转移的影响](../../media/aoag-failoversetexample.gif "主副本配置对故障转移的影响")</span><span class="sxs-lookup"><span data-stu-id="3b85d-193">![How primary replica configuration affects failover](../../media/aoag-failoversetexample.gif "How primary replica configuration affects failover")</span></span>  
  
##  <a name="automatic-failover"></a><a name="AutomaticFailover"></a> <span data-ttu-id="3b85d-194">Automatic Failover</span><span class="sxs-lookup"><span data-stu-id="3b85d-194">Automatic Failover</span></span>  
 <span data-ttu-id="3b85d-195">在主副本变得不可用之后，自动故障转移将导致合格的辅助副本自动转换为主角色。</span><span class="sxs-lookup"><span data-stu-id="3b85d-195">An automatic failover causes a qualified secondary replica to automatically transition to the primary role after the primary replica becomes unavailable.</span></span> <span data-ttu-id="3b85d-196">当承载主副本的 WSFC 节点对于承载辅助副本的节点而言为本地节点时，自动故障转移最适合。</span><span class="sxs-lookup"><span data-stu-id="3b85d-196">Automatic failover is best suited when the WSFC node that hosts the primary replica is local to the node that hosts the secondary replica.</span></span> <span data-ttu-id="3b85d-197">这是因为数据同步最适合于计算机之间的低消息延迟时间情况以及因为客户端连接可以保持为本地。</span><span class="sxs-lookup"><span data-stu-id="3b85d-197">This is because data synchronization works best with low message latency between computers and because client connections can remain local.</span></span>  
  
  
###  <a name="conditions-required-for-an-automatic-failover"></a><a name="RequiredConditions"></a> <span data-ttu-id="3b85d-198">自动故障转移所需条件</span><span class="sxs-lookup"><span data-stu-id="3b85d-198">Conditions Required for an Automatic Failover</span></span>  
 <span data-ttu-id="3b85d-199">仅在以下条件下才发生自动故障转移：</span><span class="sxs-lookup"><span data-stu-id="3b85d-199">Automatic failover occurs only under the following conditions:</span></span>  
  
-   <span data-ttu-id="3b85d-200">存在自动故障转移集。</span><span class="sxs-lookup"><span data-stu-id="3b85d-200">An automatic failover set exists.</span></span> <span data-ttu-id="3b85d-201">此自动故障转移集由主要副本和次要副本（自动故障转移目标）构成，主要副本和次要副本都配置为同步提交模式并且设置为自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-201">This set consists of a primary replica and a secondary replica (the *automatic failover target*) that are both configured for synchronous-commit mode and set to AUTOMATIC failover.</span></span> <span data-ttu-id="3b85d-202">HYPERLINK“file:///C:\\\Users\\\marshow\\\AppData\\\Local\\\Temp\\\DxEditor\\\DduePreview\\\Default\\\6fe88e12-4df1-4025-ba24-7579635ccecf\\\HTM\\\html\\\29e0ac5d-eb58-4801-82b9-e278f08db920”如果主要副本设置为手动故障转移，即使次要副本设置为自动故障转移，也无法发生自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-202">HYPERLINK "file:///C:\\\Users\\\marshow\\\AppData\\\Local\\\Temp\\\DxEditor\\\DduePreview\\\Default\\\6fe88e12-4df1-4025-ba24-7579635ccecf\\\HTM\\\html\\\29e0ac5d-eb58-4801-82b9-e278f08db920"  If the primary replica is set MANUAL failover, automatic failover cannot occur, even if a secondary replica is set to AUTOMATIC failover.</span></span>  
  
     <span data-ttu-id="3b85d-203">有关详细信息，请参阅[可用性模式（AlwaysOn 可用性组）](availability-modes-always-on-availability-groups.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-203">For more information, see [Availability Modes &#40;AlwaysOn Availability Groups&#41;](availability-modes-always-on-availability-groups.md).</span></span>  
  
-   <span data-ttu-id="3b85d-204">自动故障转移目标具有正常运行的同步状态（这指示故障转移目标上的每个辅助数据库都与其相应的主数据库同步）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-204">The automatic failover target has a healthy synchronization state (this indicates that every secondary database on the failover target is synchronized with its corresponding primary database).</span></span>  
  
    > [!TIP]  
    >  <span data-ttu-id="3b85d-205">AlwaysOn 可用性组监视自动故障转移集中两个副本的运行状况。</span><span class="sxs-lookup"><span data-stu-id="3b85d-205">AlwaysOn Availability Groups monitors the health of both replicas in an automatic failover set.</span></span> <span data-ttu-id="3b85d-206">如果任一副本失败，则该可用性组的运行状况状态将设置为“严重”。</span><span class="sxs-lookup"><span data-stu-id="3b85d-206">If either replica fails, the availability group's health state is set to CRITICAL.</span></span> <span data-ttu-id="3b85d-207">如果辅助副本失败，则自动故障转移将不可行，因为自动故障转移目标不可用。</span><span class="sxs-lookup"><span data-stu-id="3b85d-207">If the secondary replica fails, automatic failover is not possible because the automatic failover target is unavailable.</span></span> <span data-ttu-id="3b85d-208">如果主副本失败，则可用性组将故障转移到辅助副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-208">If the primary replica fails, the availability group will fail over to the secondary replica.</span></span> <span data-ttu-id="3b85d-209">在之前的主副本进入联机状态之前，将不存在任何自动故障转移目标。</span><span class="sxs-lookup"><span data-stu-id="3b85d-209">Until the former primary replica comes online, no automatic failover target exists.</span></span> <span data-ttu-id="3b85d-210">在任一情况下，为了在连续出现失败这种近乎不可能发生的情况下确保可用性，我们建议您将其他辅助副本配置为自动故障转移目标。</span><span class="sxs-lookup"><span data-stu-id="3b85d-210">In either case, to ensure availability in the unlikely case of a sequential failure, we recommend that you configure a different secondary replica as the automatic failover target.</span></span>  
    >   
    >  <span data-ttu-id="3b85d-211">有关详细信息，请参阅[使用 AlwaysOn 策略查看可用性组的运行状况 (SQL Server)](use-always-on-policies-to-view-the-health-of-an-availability-group-sql-server.md) 和[更改可用性副本的故障转移模式 (SQL Server)](change-the-failover-mode-of-an-availability-replica-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-211">For more information, see [Use AlwaysOn Policies to View the Health of an Availability Group &#40;SQL Server&#41;](use-always-on-policies-to-view-the-health-of-an-availability-group-sql-server.md) and [Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;](change-the-failover-mode-of-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="3b85d-212">Windows Server 故障转移群集 (WSFC) 群集具有仲裁。</span><span class="sxs-lookup"><span data-stu-id="3b85d-212">The Windows Server Failover Clustering (WSFC) cluster has quorum.</span></span> <span data-ttu-id="3b85d-213">有关详细信息，请参阅 [WSFC 仲裁模式和投票配置 (SQL Server)](../../../sql-server/failover-clusters/windows/wsfc-quorum-modes-and-voting-configuration-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-213">For more information, see [WSFC Quorum Modes and Voting Configuration &#40;SQL Server&#41;](../../../sql-server/failover-clusters/windows/wsfc-quorum-modes-and-voting-configuration-sql-server.md).</span></span>  
  
-   <span data-ttu-id="3b85d-214">主副本已变得不可用，并且由灵活的故障转移策略定义的故障转移条件级别已得到满足。</span><span class="sxs-lookup"><span data-stu-id="3b85d-214">The primary replica has become unavailable, and the failover-condition levels defined by your the flexible failover policy have been met.</span></span> <span data-ttu-id="3b85d-215">有关故障转移条件级别的信息，请参阅 [针对可用性组的自动故障转移的灵活的故障转移策略 (SQL Server)](flexible-automatic-failover-policy-availability-group.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-215">For information about failover-condition levels, see [Flexible Failover Policy for Automatic Failover of an Availability Group &#40;SQL Server&#41;](flexible-automatic-failover-policy-availability-group.md).</span></span>  
  
###  <a name="how-automatic-failover-works"></a><a name="HowAutoFoWorks"></a> <span data-ttu-id="3b85d-216">自动故障转移的原理</span><span class="sxs-lookup"><span data-stu-id="3b85d-216">How Automatic Failover Works</span></span>  
 <span data-ttu-id="3b85d-217">自动故障转移将启动以下操作序列：</span><span class="sxs-lookup"><span data-stu-id="3b85d-217">An automatic failover initiates the following sequence of actions:</span></span>  
  
1.  <span data-ttu-id="3b85d-218">如果承载当前主副本的服务器实例仍在运行，则它会将主数据库的状态更改为“已断开连接”并断开所有客户端的连接。</span><span class="sxs-lookup"><span data-stu-id="3b85d-218">If the server instance that is hosting the current primary replica is still running, it changes the state of the primary databases to DISCONNECTED and disconnects all clients.</span></span>  
  
2.  <span data-ttu-id="3b85d-219">如果在目标辅助副本上有任何日志记录正在恢复队列中处于等待状态，则辅助副本会应用剩下的日志记录，以完成对辅助数据库的前滚操作。</span><span class="sxs-lookup"><span data-stu-id="3b85d-219">If any log records are waiting in recovery queues on the target secondary replica, the secondary replica applies the remaining log records to finish rolling forward the secondary databases.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="3b85d-220">将日志应用于给定数据库所需的时间取决于系统的速度、最近的工作负载以及恢复队列中的日志量。</span><span class="sxs-lookup"><span data-stu-id="3b85d-220">The amount of time required to apply the log to a given database depends on the speed of the system, the recent work load, and the amount of log in the recovery queue.</span></span>  
  
3.  <span data-ttu-id="3b85d-221">先前的辅助副本转换到主角色。</span><span class="sxs-lookup"><span data-stu-id="3b85d-221">The former secondary replica transitions to the primary role.</span></span> <span data-ttu-id="3b85d-222">其数据库成为主数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-222">Its databases become the primary databases.</span></span> <span data-ttu-id="3b85d-223">新的主副本将尽快回滚任何未提交的事务（恢复的撤消阶段）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-223">The new primary replica rolls back any uncommitted transactions (the undo phase of recovery) as quickly as possible.</span></span> <span data-ttu-id="3b85d-224">锁定会分离这些未提交的事务，允许当客户端使用数据库时在后台进行回滚。</span><span class="sxs-lookup"><span data-stu-id="3b85d-224">Locks isolate these uncommitted transactions, allowing roll back to occur in the background while clients use the database.</span></span> <span data-ttu-id="3b85d-225">此过程不会回滚任何已提交的事务。</span><span class="sxs-lookup"><span data-stu-id="3b85d-225">This process does not roll back any committed transactions.</span></span>  
  
     <span data-ttu-id="3b85d-226">直到连接给定的辅助数据库后，才将其简要标记为 NOT_SYNCHRONIZED。</span><span class="sxs-lookup"><span data-stu-id="3b85d-226">Until a given secondary database is connected, it is briefly marked as NOT_SYNCHRONIZED.</span></span> <span data-ttu-id="3b85d-227">在回滚恢复开始前，辅助数据库可以连接到新的主数据库并快速转换为同步状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-227">Before the rollback recovery starts, secondary databases can connect to the new primary databases and quickly transition to the SYNCHRONIZED state.</span></span> <span data-ttu-id="3b85d-228">最佳事例是通常用于第三个同步提交的副本，该副本在故障转移之后仍然为辅助角色。</span><span class="sxs-lookup"><span data-stu-id="3b85d-228">The best case is usually for a third synchronous-commit replica that remains in the secondary role after the failover.</span></span>  
  
4.  <span data-ttu-id="3b85d-229">然后，当承载先前主副本的服务器实例重新启动时，它将识别出其他可用性副本现在拥有主角色。</span><span class="sxs-lookup"><span data-stu-id="3b85d-229">Later, when the server instance that is hosting the former primary replica restarts, it recognizes that another availability replica now owns the primary role.</span></span> <span data-ttu-id="3b85d-230">以前的主副本将转换为辅助角色，并且其数据库将成为辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-230">The former primary replica transitions to the secondary role, and its databases become secondary databases.</span></span> <span data-ttu-id="3b85d-231">新的辅助副本连接到当前主副本，并尽快将其数据库更新为当前主数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-231">The new secondary replica connects to the current primary replica and catches its database up to the current primary databases as quickly as possible.</span></span> <span data-ttu-id="3b85d-232">只要新的辅助副本重新同步了其数据库，就可以再次执行故障转移，但按反向执行。</span><span class="sxs-lookup"><span data-stu-id="3b85d-232">As soon as the new secondary replica has resynchronized its databases, failover is again possible, in the reverse direction.</span></span>  
  
###  <a name="to-configure-automatic-failover"></a><a name="EnableAutoFo"></a> <span data-ttu-id="3b85d-233">配置自动故障转移</span><span class="sxs-lookup"><span data-stu-id="3b85d-233">To Configure Automatic Failover</span></span>  
 <span data-ttu-id="3b85d-234">可用性副本可以配置为支持在任何一点进行自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-234">An availability replica can be configured to support automatic failover at any point.</span></span>  
  
 <span data-ttu-id="3b85d-235">**配置自动故障转移**</span><span class="sxs-lookup"><span data-stu-id="3b85d-235">**To configure automatic failover**</span></span>  
  
1.  <span data-ttu-id="3b85d-236">确保辅助副本配置为使用同步提交可用性模式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-236">Ensure that the secondary replica is configured to use the synchronous-commit availability mode.</span></span> <span data-ttu-id="3b85d-237">有关详细信息，请参阅 [更改可用性副本的可用性模式 (SQL Server)](change-the-availability-mode-of-an-availability-replica-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-237">For more information, see [Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;](change-the-availability-mode-of-an-availability-replica-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="3b85d-238">将故障转移模式设置为自动。</span><span class="sxs-lookup"><span data-stu-id="3b85d-238">Set the failover mode to automatic.</span></span> <span data-ttu-id="3b85d-239">有关详细信息，请参阅 [更改可用性副本的故障转移模式 (SQL Server)](change-the-failover-mode-of-an-availability-replica-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-239">For more information, see [Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;](change-the-failover-mode-of-an-availability-replica-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="3b85d-240">更改可用性组的灵活故障转移策略，以指定可以导致自动故障转移的故障类别，此功能为可选的。</span><span class="sxs-lookup"><span data-stu-id="3b85d-240">Optionally, change the flexible failover policy of the availability group to specify the sorts of failures that can cause an automatic failover to occur.</span></span> <span data-ttu-id="3b85d-241">有关详细信息，请参阅[配置灵活的故障转移策略以控制自动故障转移的条件（AlwaysOn 可用性组）](configure-flexible-automatic-failover-policy.md)HYPERLINK“file:///C:\\\Users\\\marshow\\\AppData\\\Local\\\Temp\\\DxEditor\\\DduePreview\\\Default\\\6a8d98a9-6e6a-40d1-9809-efa9013d7452\\\HTM\\\html\\\1ed564b4-9835-4245-ae35-9ba67419a4ce”和[故障转移群集实例的故障转移策略](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-241">For more information, see [Configure the Flexible Failover Policy to Control Conditions for Automatic Failover &#40;AlwaysOn Availability Groups&#41;](configure-flexible-automatic-failover-policy.md) HYPERLINK "file:///C:\\\Users\\\marshow\\\AppData\\\Local\\\Temp\\\DxEditor\\\DduePreview\\\Default\\\6a8d98a9-6e6a-40d1-9809-efa9013d7452\\\HTM\\\html\\\1ed564b4-9835-4245-ae35-9ba67419a4ce"  and [Failover Policy for Failover Cluster Instances](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md).</span></span>  
  
##  <a name="planned-manual-failover-without-data-loss"></a><a name="ManualFailover"></a> <span data-ttu-id="3b85d-242">计划的手动故障转移（无数据丢失）</span><span class="sxs-lookup"><span data-stu-id="3b85d-242">Planned Manual Failover (Without Data Loss)</span></span>  
 <span data-ttu-id="3b85d-243">在数据库管理员针对承载目标辅助副本的服务器实例发出手动故障转移命令后，手动故障转移将导致已同步的辅助副本转换为主角色。</span><span class="sxs-lookup"><span data-stu-id="3b85d-243">A manual failover causes a synchronized secondary replica to transition to the primary role after a database administrator issues a manual-failover command on the server instance that hosts the target secondary replica.</span></span> <span data-ttu-id="3b85d-244">为了支持手动故障转移，辅助副本和当前主副本必须同时配置为同步提交模式（如果有）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-244">To support manual failover, the secondary replica and the current primary replica must both be configured for synchronous-commit mode, if any.</span></span> <span data-ttu-id="3b85d-245">可用性副本上的每个辅助数据库都必须加入到可用性组中，并与其对应的主数据库同步（也即，必须同步辅助副本）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-245">Every secondary database on the availability replica must be joined to the availability group and synchronized with its corresponding primary database (that is, the secondary replica must be synchronized).</span></span> <span data-ttu-id="3b85d-246">这可确保对先前主数据库提交的每个事务也对新的主数据库提交。</span><span class="sxs-lookup"><span data-stu-id="3b85d-246">This guarantees that every transaction that was committed on a former primary database has also been committed on the new primary database.</span></span> <span data-ttu-id="3b85d-247">因此，新的主数据库与旧的主数据库完全相同。</span><span class="sxs-lookup"><span data-stu-id="3b85d-247">Therefore, the new primary databases are identical to the old primary databases.</span></span>  
  
 <span data-ttu-id="3b85d-248">下图说明计划的故障转移的各个阶段：</span><span class="sxs-lookup"><span data-stu-id="3b85d-248">The following figure illustrates the stages of a planned failover:</span></span>  
  
1.  <span data-ttu-id="3b85d-249">在故障转移之前，主副本位于 `Node01`的服务器实例上。</span><span class="sxs-lookup"><span data-stu-id="3b85d-249">Before the failover, the primary replica is hosted by the server instance on `Node01`.</span></span>  
  
2.  <span data-ttu-id="3b85d-250">数据库管理员启动计划的故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-250">A database administrator initiates a planned failover.</span></span> <span data-ttu-id="3b85d-251">故障转移目标为位于 `Node02`的服务器实例上的可用性副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-251">The failover target is the availability replica hosted by the server instance on `Node02`.</span></span>  
  
3.  <span data-ttu-id="3b85d-252">故障转移目标（位于 `Node02`上）将成为新的主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-252">The failover target (on `Node02`) becomes the new primary replica.</span></span> <span data-ttu-id="3b85d-253">因为这是计划的故障转移，以前的主副本在故障转移期间切换为辅助角色，并且使其数据库立即联机作为辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-253">Because this is a planned failover, the former primary replica switches to the secondary role during the failover and brings its databases online as secondary databases immediately.</span></span>  
  
 <span data-ttu-id="3b85d-254">![计划的手动故障转移图释](../../media/aoag-plannedmanualfailover.gif "计划的手动故障转移图释")</span><span class="sxs-lookup"><span data-stu-id="3b85d-254">![Illustation of a planned manual failover](../../media/aoag-plannedmanualfailover.gif "Illustation of a planned manual failover")</span></span>  
  
  
###  <a name="conditions-required-for-a-manual-failover"></a><a name="ManualFailoverConditions"></a> <span data-ttu-id="3b85d-255">手动故障转移所需条件</span><span class="sxs-lookup"><span data-stu-id="3b85d-255">Conditions Required for a Manual Failover</span></span>  
 <span data-ttu-id="3b85d-256">为了支持手动故障转移，当前主副本必须设置为同步提交模式，而辅助副本必须：</span><span class="sxs-lookup"><span data-stu-id="3b85d-256">To support a manual failover, the current primary replica must be set to synchronous-commit mode and a secondary replica must be:</span></span>  
  
-   <span data-ttu-id="3b85d-257">配置为同步提交模式。</span><span class="sxs-lookup"><span data-stu-id="3b85d-257">Configured for synchronous-commit mode.</span></span>  
  
-   <span data-ttu-id="3b85d-258">当前已与主副本同步。</span><span class="sxs-lookup"><span data-stu-id="3b85d-258">Currently synchronized with the primary replica.</span></span>  
  
 <span data-ttu-id="3b85d-259">若要手动对可用性组执行故障转移，您必须连接到将成为新的主副本的辅助副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-259">To manually fail over an availability group, you must be connected to the secondary replica that is to become the new primary replica.</span></span>  
  
###  <a name="how-a-planned-manual-failover-works"></a><a name="ManualFailoverHowWorks"></a> <span data-ttu-id="3b85d-260">计划的手动故障转移的工作方式</span><span class="sxs-lookup"><span data-stu-id="3b85d-260">How a Planned Manual Failover Works</span></span>  
 <span data-ttu-id="3b85d-261">计划的手动故障转移（必须在目标辅助副本上启动）将启动以下操作序列：</span><span class="sxs-lookup"><span data-stu-id="3b85d-261">A planned manual failover, which must be initiated on the target secondary replica, initiates the following sequence of actions:</span></span>  
  
1.  <span data-ttu-id="3b85d-262">为了确保在原始主数据库上不发生任何新的用户事务，WSFC 群集向主副本发送要求脱机的请求。</span><span class="sxs-lookup"><span data-stu-id="3b85d-262">To ensure that no new user transactions occur on the original primary databases, the WSFC cluster sends a request to the primary replica to go offline.</span></span>  
  
2.  <span data-ttu-id="3b85d-263">如果任何辅助数据库的恢复队列中有任何日志处于等待状态，则辅助副本将完成对辅助数据库进行前滚的操作。</span><span class="sxs-lookup"><span data-stu-id="3b85d-263">If any log is waiting in the recovery queue of any secondary database, the secondary replica finishes rolling forward that secondary database.</span></span> <span data-ttu-id="3b85d-264">所需时间取决于系统速度、最新工作负荷以及恢复队列中的日志量。</span><span class="sxs-lookup"><span data-stu-id="3b85d-264">The amount of time required depends on the speed of the system, the recent workload, and the amount of log in the recovery queue.</span></span> <span data-ttu-id="3b85d-265">若要了解恢复队列的当前大小，请使用 **Recovery Queue** 性能计数器。</span><span class="sxs-lookup"><span data-stu-id="3b85d-265">To learn the current size of the recovery queue, use the **Recovery Queue** performance counter.</span></span> <span data-ttu-id="3b85d-266">有关详细信息，请参阅 [SQL Server，数据库副本](../../../relational-databases/performance-monitor/sql-server-database-replica.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-266">For more information, see [SQL Server, Database Replica](../../../relational-databases/performance-monitor/sql-server-database-replica.md).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="3b85d-267">可通过限制恢复队列的大小调整故障转移时间。</span><span class="sxs-lookup"><span data-stu-id="3b85d-267">The failover time can be regulated by limiting the size of the recovery queue.</span></span> <span data-ttu-id="3b85d-268">不过，这会导致主副本的速度下降，以允许辅助副本与其同步。</span><span class="sxs-lookup"><span data-stu-id="3b85d-268">However, this can cause the primary replica to slow down to allow the secondary replica to keep up.</span></span>  
  
3.  <span data-ttu-id="3b85d-269">辅助副本成为新的主副本，先前的主副本成为新的辅助副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-269">The secondary replica becomes the new primary replica, and the former primary replica becomes the new secondary replica.</span></span>  
  
4.  <span data-ttu-id="3b85d-270">新的主要副本会回滚任何未提交的事务，并使其数据库作为主数据库上线。所有辅助数据库都简要标记为“不同步”，直到它们连接并重新同步到新的主数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-270">The new primary replica rolls back any uncommitted transactions and brings its databases online as the primary databases.All secondary databases are briefly marked as NOT SYNCHRONIZED until they connect and resynchronize to the new primary databases.</span></span> <span data-ttu-id="3b85d-271">此过程不会回滚任何已提交的事务。</span><span class="sxs-lookup"><span data-stu-id="3b85d-271">This process does not roll back any committed transactions.</span></span>  
  
5.  <span data-ttu-id="3b85d-272">当以前的主副本重新联机后，它将承担辅助角色，而以前的主数据库将成为辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-272">When the former primary replica comes back online, it takes on the secondary role, and the former primary database becomes the secondary database.</span></span> <span data-ttu-id="3b85d-273">新的辅助副本快速将新的辅助数据库与对应的主数据库重新同步。</span><span class="sxs-lookup"><span data-stu-id="3b85d-273">The new secondary replica quickly resynchronizes the new secondary databases with the corresponding primary databases.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="3b85d-274">只要新的辅助副本重新同步了数据库，就可以再次执行故障转移，但按反向执行。</span><span class="sxs-lookup"><span data-stu-id="3b85d-274">As soon as the new secondary replica has resynchronized the databases, failover is again possible, but in the reverse direction.</span></span>  
  
 <span data-ttu-id="3b85d-275">执行故障转移后，客户端必须重新连接到当前的主数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-275">After failover, clients must reconnect to the current primary database.</span></span> <span data-ttu-id="3b85d-276">有关详细信息，请参阅 [可用性组侦听程序、客户端连接和应用程序故障转移 (SQL Server)](../../listeners-client-connectivity-application-failover.md)概念。</span><span class="sxs-lookup"><span data-stu-id="3b85d-276">For more information, see [Availability Group Listeners, Client Connectivity, and Application Failover &#40;SQL Server&#41;](../../listeners-client-connectivity-application-failover.md).</span></span>  
  
###  <a name="maintaining-availability-during-upgrades"></a><a name="ManualFailoverDuringUpgrades"></a> <span data-ttu-id="3b85d-277">升级期间维护可用性</span><span class="sxs-lookup"><span data-stu-id="3b85d-277">Maintaining Availability During Upgrades</span></span>  
 <span data-ttu-id="3b85d-278">当您升级硬件或软件时，可用性组的数据库管理员可以使用手动故障转移来维护数据库可用性。</span><span class="sxs-lookup"><span data-stu-id="3b85d-278">The database administrator for your availability groups can use manual failovers to maintain database availability when you upgrade hardware or software.</span></span> <span data-ttu-id="3b85d-279">若要将可用性组用于软件升级，承载目标辅助副本的服务器实例和/或计算机节点必须已经收到升级。</span><span class="sxs-lookup"><span data-stu-id="3b85d-279">To use an availability group for software upgrades, the server instance and/or computer node that hosts the target secondary replica must have already received the upgrades.</span></span> <span data-ttu-id="3b85d-280">有关详细信息，请参阅 [Upgrade and Update of Availability Group Servers with Minimal Downtime and Data Loss](upgrading-always-on-availability-group-replica-instances.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-280">For more information, see [Upgrade and Update of Availability Group Servers with Minimal Downtime and Data Loss](upgrading-always-on-availability-group-replica-instances.md).</span></span>  
  
##  <a name="forced-failover-with-possible-data-loss"></a><a name="ForcedFailover"></a> <span data-ttu-id="3b85d-281">强制故障转移（可能丢失数据）</span><span class="sxs-lookup"><span data-stu-id="3b85d-281">Forced Failover (with Possible Data Loss)</span></span>  
 <span data-ttu-id="3b85d-282">强制执行可用性组的故障转移（可能丢失数据）是一种灾难恢复方法，可使你使用次要副本作为热备用服务器。因为强制执行故障转移可能面临数据丢失的风险，因此应审慎使用它。</span><span class="sxs-lookup"><span data-stu-id="3b85d-282">Forcing failover of an availability group (with possible data loss) is a disaster recovery method that allows you to use a secondary replica as a warm standby server.Because forcing failover risks possible data loss, it should be used cautiously and sparingly.</span></span> <span data-ttu-id="3b85d-283">建议仅当您必须立即将服务还原到可用性数据库并愿意承担数据丢失的风险时，才执行强制故障转移。</span><span class="sxs-lookup"><span data-stu-id="3b85d-283">We recommend forcing failover only if you must restore service to your availability databases immediately and are willing to risk losing data.</span></span> <span data-ttu-id="3b85d-284">有关强制故障转移的先决条件和建议，以及使用强制故障转移从灾难性故障中恢复的示例应用场景的详细信息，请参阅 [执行可用性组的强制手动故障转移 (SQL Server)](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-284">For more information about the prerequisites and recommendations for forcing failover and for an example scenario that uses a forced failover to recover from a catastrophic failure, see [Perform a Forced Manual Failover of an Availability Group &#40;SQL Server&#41;](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md).</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="3b85d-285">强制故障转移要求 WSFC 群集具有仲裁。</span><span class="sxs-lookup"><span data-stu-id="3b85d-285">Forcing failover requires that the WSFC cluster have quorum.</span></span> <span data-ttu-id="3b85d-286">有关配置仲裁和强制仲裁的信息，请参阅 [Windows Server 故障转移群集 (WSFC) 与 SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-286">For information about configuring quorum and forcing quorum, see [Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md).</span></span>  
  
  
###  <a name="how-forced-failover-works"></a><a name="ForcedFailoverHowWorks"></a> <span data-ttu-id="3b85d-287">强制故障转移的原理</span><span class="sxs-lookup"><span data-stu-id="3b85d-287">How Forced Failover Works</span></span>  
 <span data-ttu-id="3b85d-288">强制故障转移会启动一个将主角色转换为角色处于辅助或正在解析状态的目标副本的过程。</span><span class="sxs-lookup"><span data-stu-id="3b85d-288">Forcing failover initiates a transition of the primary role to a target replica whose role is in the SECONDARY or RESOLVING state.</span></span> <span data-ttu-id="3b85d-289">故障转移目标成为新的主副本，并立即将其数据库副本提供给客户端。</span><span class="sxs-lookup"><span data-stu-id="3b85d-289">The failover target becomes the new primary replica and immediately serves its copies of the databases to clients.</span></span> <span data-ttu-id="3b85d-290">当以前的主副本变得可用时，它将转换为辅助角色，并且其数据库将成为辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-290">When the former primary replica becomes available, it will transition to the secondary role and its databases will become secondary databases.</span></span>  
  
 <span data-ttu-id="3b85d-291">所有辅助数据库（包括现在变得可用的以前的主数据库）将挂起。</span><span class="sxs-lookup"><span data-stu-id="3b85d-291">All secondary databases (including the former primary databases, when they become available) are SUSPENDED.</span></span> <span data-ttu-id="3b85d-292">根据挂起的辅助数据库以前的数据同步状态，它可能适合于补救该主数据库的未能提交的数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-292">Depending on the previous data synchronization state of a suspended secondary database, it might be suitable for salvaging missing committed data for that primary database.</span></span> <span data-ttu-id="3b85d-293">在配置为只读访问的辅助副本上，您可以查询辅助数据库以手动发现丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-293">On a secondary replica that is configured for read-only access, you can query the secondary databases to manually discover missing data.</span></span> <span data-ttu-id="3b85d-294">然后，您可以对新的主数据库发出 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句来进行必要的更改。</span><span class="sxs-lookup"><span data-stu-id="3b85d-294">Then you can issue [!INCLUDE[tsql](../../../includes/tsql-md.md)] statements on the new primary databases to make any necessary changes.</span></span>  
  
###  <a name="risks-of-forcing-failover"></a><a name="ForcedFailoverRisks"></a> <span data-ttu-id="3b85d-295">强制故障转移的风险</span><span class="sxs-lookup"><span data-stu-id="3b85d-295">Risks of Forcing Failover</span></span>  
 <span data-ttu-id="3b85d-296">一定要注意，强制故障转移可能会造成数据丢失。</span><span class="sxs-lookup"><span data-stu-id="3b85d-296">It is essential to understand that forcing failover can cause data loss.</span></span> <span data-ttu-id="3b85d-297">这是因为目标副本无法与主副本进行通信，从而不能保证两个数据库同步。</span><span class="sxs-lookup"><span data-stu-id="3b85d-297">Data loss is possible because the target replica cannot communicate with the primary replica and, therefore, cannot guarantee that the databases are synchronized.</span></span> <span data-ttu-id="3b85d-298">强制故障转移启动新的恢复分叉。</span><span class="sxs-lookup"><span data-stu-id="3b85d-298">Forcing failover starts a new recovery fork.</span></span> <span data-ttu-id="3b85d-299">因为原始主数据库和辅助数据库位于不同的恢复分叉上，所以每个数据库现在包含另一个数据库不包含的数据：每个原始主数据库包含任何尚未从其发送队列发送到以前的辅助数据库的更改（未发送的日志）；以前的辅助数据库包含任何强制故障转移之后发生的更改。</span><span class="sxs-lookup"><span data-stu-id="3b85d-299">Because the original primary databases and secondary databases are on different recovery forks, each of them now contains data that the other database does not contain: each original primary database contains whatever changes were not yet sent from its send queue to the former secondary database (the unsent log); the former secondary databases contain whatever changes occur after failover was forced.</span></span>  
  
 <span data-ttu-id="3b85d-300">如果因为主副本出现故障而强制进行故障转移，则潜在的数据丢失取决于是否在出现故障之前已将所有事务日志发送到辅助副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-300">If failover is forced because the primary replica has failed, potential data loss is depends on whether any transaction logs had not been sent to the secondary replica before the failure.</span></span> <span data-ttu-id="3b85d-301">在异步提交模式下，可能会始终存在累积的未发送日志。</span><span class="sxs-lookup"><span data-stu-id="3b85d-301">Under the asynchronous-commit mode, accumulated unsent log is always a possibility.</span></span> <span data-ttu-id="3b85d-302">在同步提交模式下，可能仅在辅助数据库同步之前会出现这种情况。</span><span class="sxs-lookup"><span data-stu-id="3b85d-302">Under synchronous-commit mode, this is possible only until the secondary databases becomes synchronized.</span></span>  
  
 <span data-ttu-id="3b85d-303">下表总结了在强制故障转移到该副本上时特定数据库丢失数据的可能性。</span><span class="sxs-lookup"><span data-stu-id="3b85d-303">The following table summarizes the possibility of data loss for a particular database on the replica to which you force failover.</span></span>  
  
|<span data-ttu-id="3b85d-304">辅助副本的可用性模式</span><span class="sxs-lookup"><span data-stu-id="3b85d-304">Availability mode of Secondary Replica</span></span>|<span data-ttu-id="3b85d-305">数据库是否同步？</span><span class="sxs-lookup"><span data-stu-id="3b85d-305">Is database synchronized?</span></span>|<span data-ttu-id="3b85d-306">是否可能发生数据丢失？</span><span class="sxs-lookup"><span data-stu-id="3b85d-306">Is data loss possible?</span></span>|  
|--------------------------------------------|-------------------------------|----------------------------|  
|<span data-ttu-id="3b85d-307">同步提交</span><span class="sxs-lookup"><span data-stu-id="3b85d-307">Synchronous-commit</span></span>|<span data-ttu-id="3b85d-308">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-308">Yes</span></span>|<span data-ttu-id="3b85d-309">否</span><span class="sxs-lookup"><span data-stu-id="3b85d-309">No</span></span>|  
|<span data-ttu-id="3b85d-310">同步提交</span><span class="sxs-lookup"><span data-stu-id="3b85d-310">Synchronous-commit</span></span>|<span data-ttu-id="3b85d-311">否</span><span class="sxs-lookup"><span data-stu-id="3b85d-311">No</span></span>|<span data-ttu-id="3b85d-312">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-312">Yes</span></span>|  
|<span data-ttu-id="3b85d-313">异步提交</span><span class="sxs-lookup"><span data-stu-id="3b85d-313">Asynchronous-commit</span></span>|<span data-ttu-id="3b85d-314">否</span><span class="sxs-lookup"><span data-stu-id="3b85d-314">No</span></span>|<span data-ttu-id="3b85d-315">是</span><span class="sxs-lookup"><span data-stu-id="3b85d-315">Yes</span></span>|  
||||  
  
 <span data-ttu-id="3b85d-316">辅助数据库仅跟踪两个恢复分叉，因此，如果您执行多个强制故障转移，则确实已与先前的强制故障转移启动数据同步的任何辅助数据库都可能无法恢复运行。</span><span class="sxs-lookup"><span data-stu-id="3b85d-316">Secondary databases track only two recovery forks, so if you perform multiple forced failovers, any secondary database that did start data synchronization with the previous force failover might not be able to resume.</span></span> <span data-ttu-id="3b85d-317">如果发生这种情况，则需要从可用性组中删除无法恢复的所有辅助数据库，还原到正确的时间点，然后重新加入可用性组。</span><span class="sxs-lookup"><span data-stu-id="3b85d-317">If this occurs, any secondary databases that cannot be resumed will need to be removed from the availability group, restored to the correct point in time, and rejoined to the availability group.</span></span> <span data-ttu-id="3b85d-318">还原不能跨多个恢复分叉执行，因此请确保在执行多个强制故障转移后执行日志备份。</span><span class="sxs-lookup"><span data-stu-id="3b85d-318">A restore will not work across multiple recovery forks, therefore, be sure to perform a log backup after performing more than one forced failover.</span></span>  
  
###  <a name="why-forced-failover-is-required-after-forcing-quorum"></a><a name="WhyFFoPostForcedQuorum"></a> <span data-ttu-id="3b85d-319">强制仲裁后需要强制故障转移的原因</span><span class="sxs-lookup"><span data-stu-id="3b85d-319">Why Forced Failover is Required After Forcing Quorum</span></span>  
 <span data-ttu-id="3b85d-320">在对 WSFC 群集强制执行仲裁（强制仲裁）后，你需要在每个可用性组上执行强制故障转移（可能会丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-320">After quorum is forced on the WSFC cluster (*forced quorum*) you need to perform a forced failover (with possible data loss) on each availability group.</span></span> <span data-ttu-id="3b85d-321">强制故障转移是必需的，因为 WSFC 群集的真实状态值可能已丢失。</span><span class="sxs-lookup"><span data-stu-id="3b85d-321">The forced failover is required because the real state of the WSFC cluster values might have been lost.</span></span> <span data-ttu-id="3b85d-322">在强制仲裁后需要防止常规故障转移，因为在重新配置的 WSFC 群集上未同步的辅助副本很可能显示为“已同步”。</span><span class="sxs-lookup"><span data-stu-id="3b85d-322">Preventing normal failovers after a forced quorum is required because of the possibility than an unsynchronized secondary replica would appear to be synchronized on the reconfigured WSFC cluster.</span></span>  
  
 <span data-ttu-id="3b85d-323">例如，考虑在 3 个节点上承载可用性组的 WSFC 群集：节点 A 承载主要副本，而节点 B 和节点 C 分别承载一个次要副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-323">For example, consider a WSFC cluster that hosts an availability group on three nodes:  Node A hosts the primary replica and Node B and Node C each hosts a secondary replica.</span></span> <span data-ttu-id="3b85d-324">节点 C 断开了与 WSFC 群集的连接，而此时该节点上的本地辅助副本处于同步状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-324">Node C gets disconnected from the WSFC cluster while the local secondary replica is SYNCHRONIZED.</span></span>  <span data-ttu-id="3b85d-325">但是节点 A 和节点 B 仍可以正常仲裁，可用性组仍处于联机状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-325">But Node A and Node B retain a healthy quorum and the availability group remains online.</span></span> <span data-ttu-id="3b85d-326">在节点 A 上，主副本继续接受更新，在节点 B 上，辅助副本继续与主副本同步。</span><span class="sxs-lookup"><span data-stu-id="3b85d-326">On Node A, the primary replica continues to accept updates, and on Node B, the secondary replica continues to synchronize with the primary replica.</span></span> <span data-ttu-id="3b85d-327">节点 C 上的辅助副本就会变得不同步，并且越来越滞后于主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-327">The secondary replica on Node C becomes unsynchronized and falls increasingly behind the primary replica.</span></span> <span data-ttu-id="3b85d-328">但是，由于节点 C 已断开连接，该副本仍错误地处于同步状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-328">However, because Node C is disconnected, the replica remains, incorrectly, in the SYNCHRONIZED state.</span></span>  
  
 <span data-ttu-id="3b85d-329">如果仲裁丢失，然后在节点 A 上强制执行，则 WSFC 群集上可用性组的同步状态应是正确的（节点 C 上的辅助副本显示为未同步状态）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-329">If quorum is lost and is then forced on Node A, the synchronization state of the availability group on the WSFC cluster should be correct-with the secondary replica on Node C shown as UNSYNCHRONIZED.</span></span> <span data-ttu-id="3b85d-330">但是，如果在节点 C 上强制执行仲裁，则可用性组的同步状态将是不正确的。</span><span class="sxs-lookup"><span data-stu-id="3b85d-330">However, if quorum is forced on Node C, the synchronization of the availability group will be incorrect.</span></span> <span data-ttu-id="3b85d-331">群集上的同步状态将恢复为节点 C 断开连接时所处的状态（节点 C 上的辅助副本“错误地”显示为同步状态）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-331">The synchronization state on the cluster will have reverted back to when Node C was disconnected-with the secondary replica on Node C *incorrectly* shown as SYNCHRONIZED.</span></span> <span data-ttu-id="3b85d-332">由于计划的手动故障转移确保了数据的安全性，在强制仲裁后它们不允许将可用性组恢复为联机状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-332">Since planned manual failovers guarantee the safety of the data, they are disallowed for bring an availability group back online after quorum is forced.</span></span>  
  
###  <a name="tracking-potential-data-loss"></a><a name="TrackPotentialDataLoss"></a> <span data-ttu-id="3b85d-333">跟踪可能的数据丢失</span><span class="sxs-lookup"><span data-stu-id="3b85d-333">Tracking Potential Data Loss</span></span>  
 <span data-ttu-id="3b85d-334">WSFC 群集正常仲裁时，您可以估计数据库上当前可能的数据丢失量。</span><span class="sxs-lookup"><span data-stu-id="3b85d-334">When the WSFC cluster has a healthy quorum, you can estimate the current potential for data loss on databases.</span></span> <span data-ttu-id="3b85d-335">对于给定的辅助副本，当前可能的数据丢失量取决于本地辅助数据库滞后相应主数据库的程度。</span><span class="sxs-lookup"><span data-stu-id="3b85d-335">For a given secondary replica, the current potential for data loss depends on how far the local secondary databases are lagging behind the corresponding primary databases.</span></span> <span data-ttu-id="3b85d-336">因为滞后程度随时间而变化，我们建议您定期跟踪未同步的辅助数据库可能的数据丢失情况。</span><span class="sxs-lookup"><span data-stu-id="3b85d-336">Because the amount of lag varies over time, we recommend that you periodically track potential data loss for your unsynchronized secondary databases.</span></span> <span data-ttu-id="3b85d-337">跟踪滞后情况涉及比较每个主数据库和辅助数据库的上次提交 LSN 和上次提交时间，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3b85d-337">Tracking lag involves comparing the Last Commit LSN and Last Commit Time for each primary database and its secondary databases, as follows:</span></span>  
  
1.  <span data-ttu-id="3b85d-338">连接到主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-338">Connect to the primary replica.</span></span>  
  
2.  <span data-ttu-id="3b85d-339">查询 `last_commit_lsn` 上次提交的事务的 (LSN) 以及 `last_commit_time` [sys.databases dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql)动态管理视图的上次提交) 列 (时间。</span><span class="sxs-lookup"><span data-stu-id="3b85d-339">Query the `last_commit_lsn` (LSN of the last committed transaction) and `last_commit_time` (time of the last commit) columns of the [sys.dm_hadr_database_replica_states](/sql/relational-databases/system-dynamic-management-views/sys-dm-hadr-database-replica-states-transact-sql) dynamic management view.</span></span>  
  
3.  <span data-ttu-id="3b85d-340">比较为每个主数据库和它的每个辅助数据库返回的值。</span><span class="sxs-lookup"><span data-stu-id="3b85d-340">Compare the values returned for each primary database and each of its secondary databases.</span></span> <span data-ttu-id="3b85d-341">它们的上次提交 LSN 的差值指示滞后的程度。</span><span class="sxs-lookup"><span data-stu-id="3b85d-341">The difference between their Last Commit LSNs indicate the amount of lag.</span></span>  
  
4.  <span data-ttu-id="3b85d-342">当某个或某组数据库上的滞后程度超过指定时间段的最大滞后程度时，您可以触发一个警报。</span><span class="sxs-lookup"><span data-stu-id="3b85d-342">You can trigger an alert when the amount of lag on a database or set of databases exceeds your desired maximum lag for a given period of time.</span></span> <span data-ttu-id="3b85d-343">例如，可以通过每分钟在每个主数据库上执行的一个作业来运行查询。</span><span class="sxs-lookup"><span data-stu-id="3b85d-343">For example, the query can be run by a job that executes every minute on each primary database.</span></span> <span data-ttu-id="3b85d-344">如果自上次执行该作业以来，主数据库的 `last_commit_time` 和任意辅助数据库的相应值的差值超过恢复点目标 (RPO)（例如，5 分钟），该作业可以引发一个警报。</span><span class="sxs-lookup"><span data-stu-id="3b85d-344">If the difference between the `last_commit_time` of a primary database and any of its secondary databases has exceeded the recovery point objective (RPO) (for example, 5 minutes) since the last time the job executed, the job can raise an alert.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="3b85d-345">WSFC 群集缺乏仲裁或强制执行了仲裁时，`last_commit_lsn` 和 `last_commit_time` 为 NULL。</span><span class="sxs-lookup"><span data-stu-id="3b85d-345">When the WSFC cluster lacks quorum or quorum has been forced, `last_commit_lsn` and `last_commit_time` are NULL.</span></span> <span data-ttu-id="3b85d-346">有关在强制仲裁后如何避免数据丢失的信息，请参阅 [执行可用性组的强制手动故障转移 (SQL Server)](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="3b85d-346">For information about how you might be able to avoid data loss after you forced quorum, see "Potential Ways to Avoid Data Loss After Quorum is Forced" in [Perform a Forced Manual Failover of an Availability Group &#40;SQL Server&#41;](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md).</span></span>  
  
###  <a name="managing-the-potential-data-loss"></a><a name="ForcedFailoverManagingDataLoss"></a> <span data-ttu-id="3b85d-347">管理潜在的数据丢失</span><span class="sxs-lookup"><span data-stu-id="3b85d-347">Managing the Potential Data Loss</span></span>  
 <span data-ttu-id="3b85d-348">强制故障转移后，所有辅助数据库都将挂起。</span><span class="sxs-lookup"><span data-stu-id="3b85d-348">After failover is forced, all secondary databases are suspended.</span></span> <span data-ttu-id="3b85d-349">这包括以前的主数据库（在以前的主副本返回到联机状态并且发现它现在是辅助副本后）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-349">This includes the former primary databases, after the former primary replica comes back online and discovers that it is now a secondary replica.</span></span> <span data-ttu-id="3b85d-350">您必须单独在每个辅助副本上手动恢复每个挂起的数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-350">You must manually resume each suspended database individually on each secondary replica.</span></span>  
  
 <span data-ttu-id="3b85d-351">以前的主副本可用后，假设其数据库没有损坏，则可以尝试管理可能的数据丢失。</span><span class="sxs-lookup"><span data-stu-id="3b85d-351">Once the former primary replica is available, assuming that its databases are undamaged, you can attempt to manage the potential data loss.</span></span> <span data-ttu-id="3b85d-352">管理潜在数据丢失的可用方法取决于原始主副本是否已连接到新的主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-352">The available approach for managing potential data loss depends on whether the original primary replica has connected to the new primary replica.</span></span> <span data-ttu-id="3b85d-353">假设原始主副本可以访问新的主实例，则会自动透明地进行重新连接。</span><span class="sxs-lookup"><span data-stu-id="3b85d-353">Assuming that the original primary replica can access the new primary instance, reconnecting occurs automatically and transparently.</span></span>  
  
#### <a name="the-original-primary-replica-has-reconnected"></a><span data-ttu-id="3b85d-354">已重新连接原始主副本</span><span class="sxs-lookup"><span data-stu-id="3b85d-354">The Original Primary Replica Has Reconnected</span></span>  
 <span data-ttu-id="3b85d-355">通常，出现故障后，原始主副本在重新启动时便会迅速重新连接到其伙伴。</span><span class="sxs-lookup"><span data-stu-id="3b85d-355">Typically, after a failure, when the original primary replica restarts it quickly reconnects to its partner.</span></span> <span data-ttu-id="3b85d-356">重新连接后，原始主副本将成为辅助副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-356">On reconnecting, the original primary replica becomes the secondary replica.</span></span> <span data-ttu-id="3b85d-357">其数据库将成为辅助数据库，然后进入挂起状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-357">Its databases becomes the secondary databases and enter the SUSPENDED state.</span></span> <span data-ttu-id="3b85d-358">除非您恢复新的辅助数据库，否则不会回滚它们。</span><span class="sxs-lookup"><span data-stu-id="3b85d-358">The new secondary databases will not be not rolled back unless you resume them.</span></span>  
  
 <span data-ttu-id="3b85d-359">但是，无法访问挂起的数据库；因此，不能对其进行检查以确定恢复给定数据库时可能丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-359">However, the suspended databases are inaccessible, so you cannot inspect them to evaluate what data would be lost if you were to resume a given database.</span></span> <span data-ttu-id="3b85d-360">因此，确定是恢复还是删除辅助数据库取决于您是否能够完全接受数据丢失，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3b85d-360">Therefore, the decision on whether to resume or remove a secondary database depends on whether you are willing to accept any data loss, as follows:</span></span>  
  
-   <span data-ttu-id="3b85d-361">如果数据丢失不可接受，则应该从可用性组中删除数据库以对数据进行补救。</span><span class="sxs-lookup"><span data-stu-id="3b85d-361">If losing any data would be unacceptable, you should remove the databases from the availability group to salvage them.</span></span>  
  
     <span data-ttu-id="3b85d-362">数据库管理员现在可以恢复以前的主数据库，并尝试恢复可能已丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-362">The database administrator can now recover the former primary databases and attempt to recover the data that would have been lost.</span></span> <span data-ttu-id="3b85d-363">但是，当以前的主数据库处于联机状态后，它与当前主数据库存在偏差，因此，数据库管理员需要使客户端无法访问删除的数据库或当前主要数据库，以免数据库之间出现更大偏差并防止出现客户端故障转移问题。</span><span class="sxs-lookup"><span data-stu-id="3b85d-363">However, when a former primary database comes online, it is divergent from the current primary database, so the database administrator needs to make either the removed database or the current primary database inaccessible to clients to avoid further divergence of the databases and to prevent client-failover issues.</span></span>  
  
-   <span data-ttu-id="3b85d-364">如果数据丢失对于您的业务目标是可以接受的，您可以恢复辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-364">If losing data would be acceptable to your business goals, you can resume the secondary databases.</span></span>  
  
     <span data-ttu-id="3b85d-365">恢复辅助数据库会导致它如同步数据库第一步所述那样回滚。</span><span class="sxs-lookup"><span data-stu-id="3b85d-365">Resuming a new secondary database causes it to be rolled back as the first step in synchronizing the database.</span></span> <span data-ttu-id="3b85d-366">如果出现故障时日志记录在发送队列中等待，则相应的事务将会丢失，即使已提交这些事务也会如此。</span><span class="sxs-lookup"><span data-stu-id="3b85d-366">If any log records were waiting in the send queue at the time of failure, the corresponding transactions are lost, even if they were committed.</span></span>  
  
#### <a name="the-original-primary-replica-has-not-reconnected"></a><span data-ttu-id="3b85d-367">未重新连接原始主副本</span><span class="sxs-lookup"><span data-stu-id="3b85d-367">The Original Primary Replica Has Not Reconnected</span></span>  
 <span data-ttu-id="3b85d-368">如果可以暂时阻止原始主副本通过网络重新连接到新的主副本，则可以检查原始主数据库以确定恢复它们时可能丢失的数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-368">If you can temporarily prevent the original primary replica from reconnecting over the network to the new primary replica, you can inspect the original primary databases to evaluate what data would be lost if they were resumed.</span></span>  
  
-   <span data-ttu-id="3b85d-369">如果潜在的数据丢失可以接受</span><span class="sxs-lookup"><span data-stu-id="3b85d-369">If the potential data loss is acceptable</span></span>  
  
     <span data-ttu-id="3b85d-370">允许原始主副本重新连接到新的主副本。</span><span class="sxs-lookup"><span data-stu-id="3b85d-370">Allow the original primary replica to reconnect to the new primary replica.</span></span> <span data-ttu-id="3b85d-371">重新连接会导致新的辅助数据库被挂起。</span><span class="sxs-lookup"><span data-stu-id="3b85d-371">Reconnecting causes the new secondary databases to be suspended.</span></span> <span data-ttu-id="3b85d-372">要启动数据库的数据同步，只需恢复它。</span><span class="sxs-lookup"><span data-stu-id="3b85d-372">To start data synchronization on a database, simply resume it.</span></span> <span data-ttu-id="3b85d-373">新的辅助副本会删除该数据库的原始恢复分叉，从而丢失从未发送到以前的辅助副本或由其接收的所有事务。</span><span class="sxs-lookup"><span data-stu-id="3b85d-373">The new secondary replica drops the original recovery fork for that database, losing any transactions that were never sent to or received by the former secondary replica.</span></span>  
  
-   <span data-ttu-id="3b85d-374">如果数据丢失不可接受</span><span class="sxs-lookup"><span data-stu-id="3b85d-374">If the data loss is unacceptable</span></span>  
  
     <span data-ttu-id="3b85d-375">如果原始主数据库包含在恢复挂起的数据库时可能丢失的重要数据，则可以从可用性组中删除它，以保留原始主数据库中的数据。</span><span class="sxs-lookup"><span data-stu-id="3b85d-375">If the original primary database contains critical data that would be lost if you resumed the suspended database, you can preserve the data on the original primary database by removing it from the availability group.</span></span> <span data-ttu-id="3b85d-376">这样会导致数据库进入“正在还原”状态。</span><span class="sxs-lookup"><span data-stu-id="3b85d-376">This causes the database to enter the RESTORING state.</span></span> <span data-ttu-id="3b85d-377">此时，我们建议您尝试备份已删除数据库的日志尾部。</span><span class="sxs-lookup"><span data-stu-id="3b85d-377">At this point, we recommend that you attempt to back up the tail of the removed database's log.</span></span> <span data-ttu-id="3b85d-378">然后，通过从原始主数据库中导出要补救的数据，并将其导入当前主数据库来更新当前主数据库（以前的辅助数据库）。</span><span class="sxs-lookup"><span data-stu-id="3b85d-378">Then, you can update the current primary (the former secondary database) by exporting the data you want to salvage from the original primary database and importing it into the current primary database.</span></span> <span data-ttu-id="3b85d-379">建议尽快对已更新的主数据库执行完整数据库备份。</span><span class="sxs-lookup"><span data-stu-id="3b85d-379">We recommend taking a full database backup of the updated primary database as quickly as possible.</span></span>  
  
     <span data-ttu-id="3b85d-380">然后，在承载新的辅助副本的服务器实例上，您可以使用 RESTORE WITH NORECOVERY 来还原此备份（以及至少一个后续日志备份），从而删除挂起的辅助数据库并创建新的辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-380">Then, on the server instance that hosts the new secondary replica, you can delete the suspended secondary database and create a new secondary database by restoring this backup (and least one subsequent log backup) using RESTORE WITH NORECOVERY.</span></span> <span data-ttu-id="3b85d-381">我们建议延迟当前主数据库的其他日志备份，直到恢复相应的辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="3b85d-381">We recommend delaying additional log backups of the current primary databases until the corresponding secondary databases are resumed.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="3b85d-382">在其任何辅助数据库被挂起时，事务日志截断在主数据库上被延迟。</span><span class="sxs-lookup"><span data-stu-id="3b85d-382">Transaction log truncation is delayed on a primary database while any of its secondary databases is suspended.</span></span> <span data-ttu-id="3b85d-383">此外，只要任何本地数据库保持挂起状态，同步提交辅助副本的同步运行状况就无法转换到“正常”。</span><span class="sxs-lookup"><span data-stu-id="3b85d-383">Also the synchronization health of a synchronous-commit secondary replica cannot transition to HEALTHY as long as any local database remains suspended.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="3b85d-384">相关任务</span><span class="sxs-lookup"><span data-stu-id="3b85d-384">Related Tasks</span></span>  
 <span data-ttu-id="3b85d-385">**配置故障转移行为**</span><span class="sxs-lookup"><span data-stu-id="3b85d-385">**To configure failover behavior**</span></span>  
  
-   [<span data-ttu-id="3b85d-386">更改可用性副本的可用性模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3b85d-386">Change the Availability Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-availability-mode-of-an-availability-replica-sql-server.md)  
  
-   [<span data-ttu-id="3b85d-387">更改可用性副本的故障转移模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3b85d-387">Change the Failover Mode of an Availability Replica &#40;SQL Server&#41;</span></span>](change-the-failover-mode-of-an-availability-replica-sql-server.md)  
  
-   [<span data-ttu-id="3b85d-388">配置灵活的故障转移策略以控制自动故障转移的条件 &#40;AlwaysOn 可用性组&#41;</span><span class="sxs-lookup"><span data-stu-id="3b85d-388">Configure the Flexible Failover Policy to Control Conditions for Automatic Failover &#40;AlwaysOn Availability Groups&#41;</span></span>](configure-flexible-automatic-failover-policy.md)  
  
 <span data-ttu-id="3b85d-389">**执行手动故障转移**</span><span class="sxs-lookup"><span data-stu-id="3b85d-389">**To perform a manual fail over**</span></span>  
  
-   [<span data-ttu-id="3b85d-390">执行可用性组的计划手动故障转移 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3b85d-390">Perform a Planned Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-planned-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [<span data-ttu-id="3b85d-391">执行可用性组的强制手动故障转移 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3b85d-391">Perform a Forced Manual Failover of an Availability Group &#40;SQL Server&#41;</span></span>](perform-a-forced-manual-failover-of-an-availability-group-sql-server.md)  
  
-   [<span data-ttu-id="3b85d-392">使用故障转移可用性组向导 (SQL Server Management Studio)</span><span class="sxs-lookup"><span data-stu-id="3b85d-392">Use the Fail Over Availability Group Wizard &#40;SQL Server Management Studio&#41;</span></span>](use-the-fail-over-availability-group-wizard-sql-server-management-studio.md)  
  
-   [<span data-ttu-id="3b85d-393">管理可用性组中数据库的登录名和作业 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3b85d-393">Management of Logins and Jobs for the Databases of an Availability Group &#40;SQL Server&#41;</span></span>](../../logins-and-jobs-for-availability-group-databases.md)  
  
 <span data-ttu-id="3b85d-394">**配置 WSFC 仲裁配置**</span><span class="sxs-lookup"><span data-stu-id="3b85d-394">**To configure WSFC Quorum Configuration**</span></span>  
  
-   [<span data-ttu-id="3b85d-395">配置群集仲裁 NodeWeight 设置</span><span class="sxs-lookup"><span data-stu-id="3b85d-395">Configure Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/configure-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="3b85d-396">查看群集仲裁 NodeWeight 设置</span><span class="sxs-lookup"><span data-stu-id="3b85d-396">View Cluster Quorum NodeWeight Settings</span></span>](../../../sql-server/failover-clusters/windows/view-cluster-quorum-nodeweight-settings.md)  
  
-   [<span data-ttu-id="3b85d-397">在无仲裁情况下强制启动 WSFC 群集</span><span class="sxs-lookup"><span data-stu-id="3b85d-397">Force a WSFC Cluster to Start Without a Quorum</span></span>](../../../sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum.md)  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="3b85d-398">相关内容</span><span class="sxs-lookup"><span data-stu-id="3b85d-398">Related Content</span></span>  
  
-   [<span data-ttu-id="3b85d-399">用于高可用性和灾难恢复的 Microsoft SQL Server AlwaysOn 解决方案指南</span><span class="sxs-lookup"><span data-stu-id="3b85d-399">Microsoft SQL Server AlwaysOn Solutions Guide for High Availability and Disaster Recovery</span></span>](https://go.microsoft.com/fwlink/?LinkId=227600)  
  
-   [<span data-ttu-id="3b85d-400">SQL Server AlwaysOn 团队博客：SQL Server AlwaysOn 官方团队博客</span><span class="sxs-lookup"><span data-stu-id="3b85d-400">SQL Server AlwaysOn Team Blog: The official SQL Server AlwaysOn Team Blog</span></span>](https://blogs.msdn.com/b/sqlalwayson/)  
  
## <a name="see-also"></a><span data-ttu-id="3b85d-401">另请参阅</span><span class="sxs-lookup"><span data-stu-id="3b85d-401">See Also</span></span>  
 <span data-ttu-id="3b85d-402">[AlwaysOn 可用性组 &#40;SQL Server 概述&#41;](overview-of-always-on-availability-groups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="3b85d-402">[Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](overview-of-always-on-availability-groups-sql-server.md) </span></span>  
 <span data-ttu-id="3b85d-403">[可用性模式 &#40;AlwaysOn 可用性组&#41;](availability-modes-always-on-availability-groups.md) </span><span class="sxs-lookup"><span data-stu-id="3b85d-403">[Availability Modes &#40;AlwaysOn Availability Groups&#41;](availability-modes-always-on-availability-groups.md) </span></span>  
 <span data-ttu-id="3b85d-404">[Windows Server 故障转移群集 (WSFC) 与 SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="3b85d-404">[Windows Server Failover Clustering &#40;WSFC&#41; with SQL Server](../../../sql-server/failover-clusters/windows/windows-server-failover-clustering-wsfc-with-sql-server.md) </span></span>  
 <span data-ttu-id="3b85d-405">[数据库镜像不支持跨数据库事务或 AlwaysOn 可用性组 &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md) </span><span class="sxs-lookup"><span data-stu-id="3b85d-405">[Cross-Database Transactions Not Supported For Database Mirroring or AlwaysOn Availability Groups &#40;SQL Server&#41;](transactions-always-on-availability-and-database-mirroring.md) </span></span>  
 <span data-ttu-id="3b85d-406">[故障转移群集实例的故障转移策略](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span><span class="sxs-lookup"><span data-stu-id="3b85d-406">[Failover Policy for Failover Cluster Instances](../../../sql-server/failover-clusters/windows/failover-policy-for-failover-cluster-instances.md) </span></span>  
 [<span data-ttu-id="3b85d-407">针对可用性组的自动故障转移的灵活的故障转移策略 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="3b85d-407">Flexible Failover Policy for Automatic Failover of an Availability Group &#40;SQL Server&#41;</span></span>](flexible-automatic-failover-policy-availability-group.md)  
  
  

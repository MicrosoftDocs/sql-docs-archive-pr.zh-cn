---
title: 用于数据库管理员的诊断连接 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- server management [SQL Server], connections
- administrator connections [SQL Server]
- ports [SQL Server], DAC
- DAC
- network connections [SQL Server], dedicated administrator
- diagnostic connections [SQL Server]
- connections [SQL Server], dedicated administrator
- ports [SQL Server]
- dedicated administrator connections [SQL Server]
ms.assetid: 993e0820-17f2-4c43-880c-d38290bf7abc
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0d452ca155a5187136c910e81e8bd073e34cad56
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87587600"
---
# <a name="diagnostic-connection-for-database-administrators"></a><span data-ttu-id="013d7-102">用于数据库管理员的诊断连接</span><span class="sxs-lookup"><span data-stu-id="013d7-102">Diagnostic Connection for Database Administrators</span></span>
  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="013d7-103">为管理员提供了一种特殊的诊断连接，以供在无法与服务器建立标准连接时使用。</span><span class="sxs-lookup"><span data-stu-id="013d7-103">provides a special diagnostic connection for administrators when standard connections to the server are not possible.</span></span> <span data-ttu-id="013d7-104">即使在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 不响应标准连接请求时，管理员也可以使用此诊断连接访问 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，以便执行诊断查询并解决问题。</span><span class="sxs-lookup"><span data-stu-id="013d7-104">This diagnostic connection allows an administrator to access [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to execute diagnostic queries and troubleshoot problems even when [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is not responding to standard connection requests.</span></span>  
  
 <span data-ttu-id="013d7-105">此专用管理员连接 (DAC) 支持 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的加密功能和其他安全功能。</span><span class="sxs-lookup"><span data-stu-id="013d7-105">This dedicated administrator connection (DAC) supports encryption and other security features of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="013d7-106">DAC 只允许将用户上下文切换到其他管理用户。</span><span class="sxs-lookup"><span data-stu-id="013d7-106">The DAC only allows changing the user context to another admin user.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="013d7-107">尽力使 DAC 连接成功，但在非常特殊的情况下也可能会出现连接失败。</span><span class="sxs-lookup"><span data-stu-id="013d7-107">makes every attempt to make DAC connect successfully, but under extreme situations it may not be successful.</span></span>  
  
||  
|-|  
|<span data-ttu-id="013d7-108">**适用**于： [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] 通过[当前版本](https://go.microsoft.com/fwlink/p/?LinkId=299658))  ([!INCLUDE[sqldbesa](../../includes/sqldbesa-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="013d7-108">**Applies to**: [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ([!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] through [current version](https://go.microsoft.com/fwlink/p/?LinkId=299658)), [!INCLUDE[sqldbesa](../../includes/sqldbesa-md.md)].</span></span>|  
  
## <a name="connecting-with-dac"></a><span data-ttu-id="013d7-109">使用 DAC 连接</span><span class="sxs-lookup"><span data-stu-id="013d7-109">Connecting with DAC</span></span>  
 <span data-ttu-id="013d7-110">默认情况下，只能从服务器上运行的客户端建立连接。</span><span class="sxs-lookup"><span data-stu-id="013d7-110">By default, the connection is only allowed from a client running on the server.</span></span> <span data-ttu-id="013d7-111">不允许进行网络连接，除非它们是使用带 [remote admin connections 选项](remote-admin-connections-server-configuration-option.md)的 sp_configure 存储过程配置的。</span><span class="sxs-lookup"><span data-stu-id="013d7-111">Network connections are not permitted unless they are configured by using the sp_configure stored procedure with the [remote admin connections option](remote-admin-connections-server-configuration-option.md).</span></span>  
  
 <span data-ttu-id="013d7-112">只有 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] sysadmin 角色的成员可以使用 DAC 进行连接。</span><span class="sxs-lookup"><span data-stu-id="013d7-112">Only members of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] sysadmin role can connect using the DAC.</span></span>  
  
 <span data-ttu-id="013d7-113">通过使用专用的管理员开关 ( **-A** ) 的**sqlcmd**命令提示实用工具，可以支持和使用 DAC。</span><span class="sxs-lookup"><span data-stu-id="013d7-113">The DAC is available and supported through the **sqlcmd** command-prompt utility using a special administrator switch (**-A**).</span></span> <span data-ttu-id="013d7-114">有关使用 **sqlcmd** 的详细信息，请参阅[将 sqlcmd 与脚本变量结合使用](../../relational-databases/scripting/sqlcmd-use-with-scripting-variables.md)。</span><span class="sxs-lookup"><span data-stu-id="013d7-114">For more information about using **sqlcmd**, see [Use sqlcmd with Scripting Variables](../../relational-databases/scripting/sqlcmd-use-with-scripting-variables.md).</span></span> <span data-ttu-id="013d7-115">还可以将前缀连接 `admin:` 到实例名称，格式为**Sqlcmd-Sadmin：** _<instance_name>。_</span><span class="sxs-lookup"><span data-stu-id="013d7-115">You can also connect prefixing `admin:`to the instance name in the format **sqlcmd -Sadmin:**_<instance_name>._</span></span> <span data-ttu-id="013d7-116">您还可以 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] 通过连接到从查询编辑器启动 DAC `admin:` \<*instance_name*> 。</span><span class="sxs-lookup"><span data-stu-id="013d7-116">You can also initiate a DAC from a [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] Query Editor by connecting to `admin:`\<*instance_name*>.</span></span>  
  
## <a name="restrictions"></a><span data-ttu-id="013d7-117">限制</span><span class="sxs-lookup"><span data-stu-id="013d7-117">Restrictions</span></span>  
 <span data-ttu-id="013d7-118">由于 DAC 仅用于在极少数情况下诊断服务器问题，因此对连接有一些限制：</span><span class="sxs-lookup"><span data-stu-id="013d7-118">Because the DAC exists solely for diagnosing server problems in rare circumstances, there are some restrictions on the connection:</span></span>  
  
-   <span data-ttu-id="013d7-119">为了保证有可用的连接资源，每个 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例只允许使用一个 DAC。</span><span class="sxs-lookup"><span data-stu-id="013d7-119">To guarantee that there are resources available for the connection, only one DAC is allowed per instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="013d7-120">如果 DAC 连接已经激活，则通过 DAC 进行连接的任何新请求都将被拒绝，并出现错误 17810。</span><span class="sxs-lookup"><span data-stu-id="013d7-120">If a DAC connection is already active, any new request to connect through the DAC is denied with error 17810.</span></span>  
  
-   <span data-ttu-id="013d7-121">为了保留资源， [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)] 不侦听 DAC 端口，除非使用跟踪标志 7806 进行启动。</span><span class="sxs-lookup"><span data-stu-id="013d7-121">To conserve resources, [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)] does not listen on the DAC port unless started with a trace flag 7806.</span></span>  
  
-   <span data-ttu-id="013d7-122">DAC 最初尝试连接到与登录帐户关联的默认数据库。</span><span class="sxs-lookup"><span data-stu-id="013d7-122">The DAC initially attempts to connect to the default database associated with the login.</span></span> <span data-ttu-id="013d7-123">连接成功后，可以连接到 master 数据库。</span><span class="sxs-lookup"><span data-stu-id="013d7-123">After it is successfully connected, you can connect to the master database.</span></span> <span data-ttu-id="013d7-124">如果默认数据库脱机或不可用，则连接返回错误 4060。</span><span class="sxs-lookup"><span data-stu-id="013d7-124">If the default database is offline or otherwise not available, the connection will return error 4060.</span></span> <span data-ttu-id="013d7-125">但是，如果使用以下命令覆盖默认数据库，改为连接到 master 数据库，则连接会成功：</span><span class="sxs-lookup"><span data-stu-id="013d7-125">However, it will succeed if you override the default database to connect to the master database instead using the following command:</span></span>  
  
     <span data-ttu-id="013d7-126">**sqlcmd -A -d master**</span><span class="sxs-lookup"><span data-stu-id="013d7-126">**sqlcmd -A -d master**</span></span>  
  
     <span data-ttu-id="013d7-127">由于只要启动 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 的实例，就能保证 master 数据库处于可用状态，因此建议使用 DAC 连接到 master 数据库。</span><span class="sxs-lookup"><span data-stu-id="013d7-127">We recommend that you connect to the master database with the DAC because master is guaranteed to be available if the instance of the [!INCLUDE[ssDE](../../includes/ssde-md.md)] is started.</span></span>  
  
-   [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="013d7-128">禁止使用 DAC 运行并行查询或命令。</span><span class="sxs-lookup"><span data-stu-id="013d7-128">prohibits running parallel queries or commands with the DAC.</span></span> <span data-ttu-id="013d7-129">例如，如果使用 DAC 执行下列任何语句，都会生成错误 3637。</span><span class="sxs-lookup"><span data-stu-id="013d7-129">For example, error 3637 is generated if you execute either of the following statements with the DAC:</span></span>  
  
    -   <span data-ttu-id="013d7-130">RESTORE</span><span class="sxs-lookup"><span data-stu-id="013d7-130">RESTORE</span></span>  
  
    -   <span data-ttu-id="013d7-131">BACKUP</span><span class="sxs-lookup"><span data-stu-id="013d7-131">BACKUP</span></span>  
  
-   <span data-ttu-id="013d7-132">DAC 只能使用有限的资源。</span><span class="sxs-lookup"><span data-stu-id="013d7-132">Only limited resources are guaranteed to be available with the DAC.</span></span> <span data-ttu-id="013d7-133">请勿使用 DAC 运行需要消耗大量资源的查询（例如，</span><span class="sxs-lookup"><span data-stu-id="013d7-133">Do not use the DAC to run resource-intensive queries (for example.</span></span> <span data-ttu-id="013d7-134">对大型表执行复杂的联接）或可能造成阻塞的查询。</span><span class="sxs-lookup"><span data-stu-id="013d7-134">a complex join on large table) or queries that may block.</span></span> <span data-ttu-id="013d7-135">这有助于防止将 DAC 与任何现有的服务器问题混淆。</span><span class="sxs-lookup"><span data-stu-id="013d7-135">This helps prevent the DAC from compounding any existing server problems.</span></span> <span data-ttu-id="013d7-136">为了避免发生潜在的阻塞情况，如果必须执行可能会发生阻塞的查询，则尽可能在基于快照的隔离级别下运行查询；或者，将事务隔离级别设置为 READ UNCOMMITTED，将 LOCK_TIMEOUT 值设置为较短的值（如 2000 毫秒），或者同时执行这两种操作。</span><span class="sxs-lookup"><span data-stu-id="013d7-136">To avoid potential blocking scenarios, if you have to run queries that may block, run the query under snapshot-based isolation levels if possible; otherwise, set the transaction isolation level to READ UNCOMMITTED and set the LOCK_TIMEOUT value to a short value such as 2000 milliseconds, or both.</span></span> <span data-ttu-id="013d7-137">这可以防止 DAC 会话被阻塞。</span><span class="sxs-lookup"><span data-stu-id="013d7-137">This will prevent the DAC session from getting blocked.</span></span> <span data-ttu-id="013d7-138">但是，根据 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 所处的状态，DAC 会话可能会在闩锁上被阻塞。</span><span class="sxs-lookup"><span data-stu-id="013d7-138">However, depending on the state that the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is in, the DAC session might get blocked on a latch.</span></span> <span data-ttu-id="013d7-139">可以使用 CNTRL-C 终止 DAC 会话，但不能保证一定成功。</span><span class="sxs-lookup"><span data-stu-id="013d7-139">You might be able to terminate the DAC session using CNTRL-C but it is not guaranteed.</span></span> <span data-ttu-id="013d7-140">如果失败，唯一的选择是重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="013d7-140">In that case, your only option may be to restart [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="013d7-141">为保证连接成功并排除 DAC 故障， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 保留了一定的资源用于处理 DAC 上运行的命令。</span><span class="sxs-lookup"><span data-stu-id="013d7-141">To guarantee connectivity and troubleshooting with the DAC, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] reserves limited resources to process commands run on the DAC.</span></span> <span data-ttu-id="013d7-142">通常这些资源只够执行简单的诊断和故障排除功能，如下所示。</span><span class="sxs-lookup"><span data-stu-id="013d7-142">These resources are typically only enough for simple diagnostic and troubleshooting functions, such as those listed below.</span></span>  
  
 <span data-ttu-id="013d7-143">虽然理论上可以运行任何不必在 DAC 上并行执行的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 语句，但极力建议您限制使用下列诊断和故障排除命令：</span><span class="sxs-lookup"><span data-stu-id="013d7-143">Although you can theoretically run any [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that does not have to execute in parallel on the DAC, we strongly recommend that you restrict usage to the following diagnostic and troubleshooting commands:</span></span>  
  
-   <span data-ttu-id="013d7-144">查询动态管理视图以进行基本的诊断，例如查询 sys.dm_tran_locks 以了解锁定状态，查询 sys.dm_os_memory_cache_counters 以检查缓存质量，查询 sys.dm_exec_requests 和 sys.dm_exec_sessions 以了解活动的会话和请求。</span><span class="sxs-lookup"><span data-stu-id="013d7-144">Querying dynamic management views for basic diagnostics such as sys.dm_tran_locks for the locking status, sys.dm_os_memory_cache_counters to check the health of caches, and sys.dm_exec_requests and sys.dm_exec_sessions for active sessions and requests.</span></span> <span data-ttu-id="013d7-145">避免使用需要消耗大量资源的动态管理视图（例如，sys.dm_tran_version_store 扫描整个版本存储区，并且会导致大量的 I/O）或使用了复杂联接的动态管理视图。</span><span class="sxs-lookup"><span data-stu-id="013d7-145">Avoid dynamic management views that are resource intensive (for example, sys.dm_tran_version_store scans the full version store and can cause extensive I/O) or that use complex joins.</span></span> <span data-ttu-id="013d7-146">有关性能影响的信息，请参阅特定 [动态管理视图](../../relational-databases/views/views.md)的文档。</span><span class="sxs-lookup"><span data-stu-id="013d7-146">For information about performance implications, see the documentation for the specific [dynamic management view](../../relational-databases/views/views.md).</span></span>  
  
-   <span data-ttu-id="013d7-147">查询目录视图。</span><span class="sxs-lookup"><span data-stu-id="013d7-147">Querying catalog views.</span></span>  
  
-   <span data-ttu-id="013d7-148">基本 DBCC 命令，例如 DBCC FREEPROCCACHE、DBCC FREESYSTEMCACHE、DBCC DROPCLEANBUFFERS`,` 和 DBCC SQLPERF。</span><span class="sxs-lookup"><span data-stu-id="013d7-148">Basic DBCC commands such as DBCC FREEPROCCACHE, DBCC FREESYSTEMCACHE, DBCC DROPCLEANBUFFERS`,` and DBCC SQLPERF.</span></span> <span data-ttu-id="013d7-149">不要运行大量占用大量资源的命令，如**dbcc** CHECKDB、dbcc DBREINDEX 或 dbcc SHRINKDATABASE。</span><span class="sxs-lookup"><span data-stu-id="013d7-149">Do not run resource-intensive commands such as **DBCC** CHECKDB, DBCC DBREINDEX, or DBCC SHRINKDATABASE.</span></span>  
  
-   [!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="013d7-150">KILL\<spid> 命令。</span><span class="sxs-lookup"><span data-stu-id="013d7-150">KILL*\<spid>* command.</span></span> <span data-ttu-id="013d7-151">根据 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的状态，KILL 命令并非一定会成功；如果失败，则唯一的选择是重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="013d7-151">Depending on the state of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the KILL command might not always succeed; then the only option may be to restart [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="013d7-152">下面是一般的指导原则：</span><span class="sxs-lookup"><span data-stu-id="013d7-152">The following are some general guidelines:</span></span>  
  
    -   <span data-ttu-id="013d7-153">请通过查询 `SELECT * FROM sys.dm_exec_sessions WHERE session_id = <spid>`来验证 SPID 是否已被实际终止。</span><span class="sxs-lookup"><span data-stu-id="013d7-153">Verify that the SPID was actually killed by querying `SELECT * FROM sys.dm_exec_sessions WHERE session_id = <spid>`.</span></span> <span data-ttu-id="013d7-154">如果没有返回任何行，则表明会话已被终止。</span><span class="sxs-lookup"><span data-stu-id="013d7-154">If it returns no rows, it means the session was killed.</span></span>  
  
    -   <span data-ttu-id="013d7-155">如果会话仍在运行，则通过运行查询 `SELECT * FROM sys.dm_os_tasks WHERE session_id = <spid>`来验证是否为此会话分配了任务。</span><span class="sxs-lookup"><span data-stu-id="013d7-155">If the session is still there, verify whether there are tasks assigned to this session by running the query `SELECT * FROM sys.dm_os_tasks WHERE session_id = <spid>`.</span></span> <span data-ttu-id="013d7-156">如果发现还有任务，则很可能当前正在终止会话。</span><span class="sxs-lookup"><span data-stu-id="013d7-156">If you see the task there, most likely your session is currently being killed.</span></span> <span data-ttu-id="013d7-157">注意，此操作可能会持续很长时间，也可能根本不会成功。</span><span class="sxs-lookup"><span data-stu-id="013d7-157">Note that this may take considerable amount of time and may not succeed at all.</span></span>  
  
    -   <span data-ttu-id="013d7-158">如果在与此会话关联的 sys.dm_os_tasks 中没有任何任务，但是在执行 KILL 命令后该会话仍然出现在 sys.dm_exec_sessions 中，则表明没有可用的工作线程。</span><span class="sxs-lookup"><span data-stu-id="013d7-158">If there are no tasks in the sys.dm_os_tasks associated with this session, but the session remains in sys.dm_exec_sessions after executing the KILL command, it means that you do not have a worker available.</span></span> <span data-ttu-id="013d7-159">选择某个当前正在运行的任务（在 sys.dm_os_tasks 视图中列出的 `sessions_id <> NULL`的任务），并终止与其关联的会话以释放工作线程。</span><span class="sxs-lookup"><span data-stu-id="013d7-159">Select one of the currently running tasks (a task listed in the sys.dm_os_tasks view with a `sessions_id <> NULL`), and kill the session associated with it to free up the worker.</span></span> <span data-ttu-id="013d7-160">请注意，终止单个会话可能不够，可能需要终止多个会话。</span><span class="sxs-lookup"><span data-stu-id="013d7-160">Note that it may not be enough to kill a single session: you may have to kill multiple ones.</span></span>  
  
## <a name="dac-port"></a><span data-ttu-id="013d7-161">DAC 端口</span><span class="sxs-lookup"><span data-stu-id="013d7-161">DAC Port</span></span>  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="013d7-162">在 TCP 端口 1434（如果可用）上侦听 DAC，或者在 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 启动时动态分配的 TCP 端口上侦听 DAC。</span><span class="sxs-lookup"><span data-stu-id="013d7-162">listens for the DAC on TCP port 1434 if available or a TCP port dynamically assigned upon [!INCLUDE[ssDE](../../includes/ssde-md.md)] startup.</span></span> <span data-ttu-id="013d7-163">错误日志包含所侦听的 DAC 所在的端口号。</span><span class="sxs-lookup"><span data-stu-id="013d7-163">The error log contains the port number the DAC is listening on.</span></span> <span data-ttu-id="013d7-164">默认情况下，DAC 侦听器只接受本地端口上的连接。</span><span class="sxs-lookup"><span data-stu-id="013d7-164">By default the DAC listener accepts connection on only the local port.</span></span> <span data-ttu-id="013d7-165">有关激活远程管理连接的代码示例的详细信息，请参阅 [remote admin connections 服务器配置选项](remote-admin-connections-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="013d7-165">For a code sample that activates remote administration connections, see [remote admin connections Server Configuration Option](remote-admin-connections-server-configuration-option.md).</span></span>  
  
 <span data-ttu-id="013d7-166">配置远程管理连接之后，会立即启用 DAC 侦听器而不必重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，并且客户端可以立即远程连接到 DAC。</span><span class="sxs-lookup"><span data-stu-id="013d7-166">After the remote administration connection is configured, the DAC listener is enabled without requiring a restart of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] and a client can now connect to the DAC remotely.</span></span> <span data-ttu-id="013d7-167">通过先在本地使用 DAC 连接到 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，然后再执行 sp_configure 存储过程接受远程连接，则即使 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 停止响应，DAC 侦听器仍然可以接受远程连接。</span><span class="sxs-lookup"><span data-stu-id="013d7-167">You can enable the DAC listener to accept connections remotely even if [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is unresponsive by first connecting to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] using the DAC locally, and then executing the sp_configure stored procedure to accept connection from remote connections.</span></span>  
  
 <span data-ttu-id="013d7-168">对于群集配置，DAC 在默认情况下是禁用的。</span><span class="sxs-lookup"><span data-stu-id="013d7-168">On cluster configurations, the DAC will be off by default.</span></span> <span data-ttu-id="013d7-169">用户可以执行 sp_configure 的 remote admin connection 选项，使 DAC 侦听器能够访问远程连接。</span><span class="sxs-lookup"><span data-stu-id="013d7-169">Users can execute the remote admin connection option of sp_configure to enable the DAC listener to access a remote connection.</span></span> <span data-ttu-id="013d7-170">如果 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 停止响应并且未启用 DAC 侦听器，则可能必须重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 来连接 DAC。</span><span class="sxs-lookup"><span data-stu-id="013d7-170">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is unresponsive and the DAC listener is not enabled, you might have to restart [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to connect with the DAC.</span></span> <span data-ttu-id="013d7-171">因此，建议在群集系统上启用 remote admin connections 配置选项。</span><span class="sxs-lookup"><span data-stu-id="013d7-171">Therefore, we recommend that you enable the remote admin connections configuration option on clustered systems.</span></span>  
  
 <span data-ttu-id="013d7-172">DAC 端口由 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 在启动时动态分配。</span><span class="sxs-lookup"><span data-stu-id="013d7-172">The DAC port is assigned dynamically by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] during startup.</span></span> <span data-ttu-id="013d7-173">当连接到默认实例时，DAC 会避免在连接时对 SQL Server Browser 服务使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 解决协议 (SSRP) 请求。</span><span class="sxs-lookup"><span data-stu-id="013d7-173">When connecting to the default instance, the DAC avoids using a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Resolution Protocol (SSRP) request to the SQL Server Browser Service when connecting.</span></span> <span data-ttu-id="013d7-174">它先通过 TCP 端口 1434 进行连接。</span><span class="sxs-lookup"><span data-stu-id="013d7-174">It first connects over TCP port 1434.</span></span> <span data-ttu-id="013d7-175">如果失败，则通过 SSRP 调用来获取端口。</span><span class="sxs-lookup"><span data-stu-id="013d7-175">If that fails, it makes an SSRP call to get the port.</span></span> <span data-ttu-id="013d7-176">如果 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 浏览器没有侦听 SSRP 请求，则连接请求将返回错误。</span><span class="sxs-lookup"><span data-stu-id="013d7-176">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Browser is not listening for SSRP requests, the connection request returns an error.</span></span> <span data-ttu-id="013d7-177">若要了解 DAC 所侦听的端口号，请参阅错误日志。</span><span class="sxs-lookup"><span data-stu-id="013d7-177">Refer to the error log to find the port number DAC is listening on.</span></span> <span data-ttu-id="013d7-178">如果将 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 配置为接受远程管理连接，则必须使用显式端口号启动 DAC：</span><span class="sxs-lookup"><span data-stu-id="013d7-178">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is configured to accept remote administration connections, the DAC must be initiated with an explicit port number:</span></span>  
  
 <span data-ttu-id="013d7-179">**sqlcmd-Stcp：** _ \<server> ， \<port> _</span><span class="sxs-lookup"><span data-stu-id="013d7-179">**sqlcmd-Stcp:** _\<server>,\<port>_</span></span>  
  
 <span data-ttu-id="013d7-180">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 错误日志列出了 DAC 的端口号，默认情况下为 1434。</span><span class="sxs-lookup"><span data-stu-id="013d7-180">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log lists the port number for the DAC, which is 1434 by default.</span></span> <span data-ttu-id="013d7-181">如果将 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 配置为只接受本地 DAC 连接，请使用以下命令和环回适配器进行连接：</span><span class="sxs-lookup"><span data-stu-id="013d7-181">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is configured to accept local DAC connections only, connect using the loopback adapter using the following command:</span></span>  
  
 <span data-ttu-id="013d7-182">**sqlcmd-s 127.0.0.1**，`1434`</span><span class="sxs-lookup"><span data-stu-id="013d7-182">**sqlcmd-S127.0.0.1**,`1434`</span></span>  
  
## <a name="example"></a><span data-ttu-id="013d7-183">示例</span><span class="sxs-lookup"><span data-stu-id="013d7-183">Example</span></span>  
 <span data-ttu-id="013d7-184">在此示例中，管理员发现服务器 `URAN123` 不响应，因此要诊断该问题。</span><span class="sxs-lookup"><span data-stu-id="013d7-184">In this example, an administrator notices that server `URAN123` is not responding and wants to diagnose the problem.</span></span> <span data-ttu-id="013d7-185">为此，用户激活 `sqlcmd` 命令提示实用工具，并使用 `URAN123` 指明 DAC 连接到服务器 `-A` 。</span><span class="sxs-lookup"><span data-stu-id="013d7-185">To do this, the user activates the `sqlcmd` command prompt utility and connects to server `URAN123` using `-A` to indicate the DAC.</span></span>  
  
 `sqlcmd -S URAN123 -U sa -P <xxx> -A`  
  
 <span data-ttu-id="013d7-186">现在，管理员可以执行查询来诊断问题，并且可以终止停止响应的会话。</span><span class="sxs-lookup"><span data-stu-id="013d7-186">The administrator can now execute queries to diagnose the problem and possibly terminate the unresponsive sessions.</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="013d7-187">Related Tasks</span><span class="sxs-lookup"><span data-stu-id="013d7-187">Related Tasks</span></span>  
  
## <a name="related-content"></a><span data-ttu-id="013d7-188">相关内容</span><span class="sxs-lookup"><span data-stu-id="013d7-188">Related Content</span></span>  
 [<span data-ttu-id="013d7-189">将 sqlcmd 与脚本变量结合使用</span><span class="sxs-lookup"><span data-stu-id="013d7-189">Use sqlcmd with Scripting Variables</span></span>](../../relational-databases/scripting/sqlcmd-use-with-scripting-variables.md)  
  
 [<span data-ttu-id="013d7-190">sqlcmd 实用工具</span><span class="sxs-lookup"><span data-stu-id="013d7-190">sqlcmd Utility</span></span>](../../tools/sqlcmd-utility.md)  
  
 [<span data-ttu-id="013d7-191">SELECT (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-191">SELECT &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/queries/select-transact-sql)  
  
 [<span data-ttu-id="013d7-192">sp_who (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-192">sp_who &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-who-transact-sql)  
  
 [<span data-ttu-id="013d7-193">sp_lock (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-193">sp_lock &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-lock-transact-sql)  
  
 [<span data-ttu-id="013d7-194">KILL (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-194">KILL &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/language-elements/kill-transact-sql)  
  
 [<span data-ttu-id="013d7-195">DBCC CHECKALLOC (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-195">DBCC CHECKALLOC &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql)  
  
 [<span data-ttu-id="013d7-196">DBCC CHECKDB (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-196">DBCC CHECKDB &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql)  
  
 [<span data-ttu-id="013d7-197">DBCC OPENTRAN (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-197">DBCC OPENTRAN &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql)  
  
 [<span data-ttu-id="013d7-198">DBCC INPUTBUFFER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-198">DBCC INPUTBUFFER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-inputbuffer-transact-sql)  
  
 [<span data-ttu-id="013d7-199">服务器配置选项 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="013d7-199">Server Configuration Options &#40;SQL Server&#41;</span></span>](server-configuration-options-sql-server.md)  
  
 [<span data-ttu-id="013d7-200">与事务相关的动态管理视图和函数 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-200">Transaction Related Dynamic Management Views and Functions &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-dynamic-management-views/transaction-related-dynamic-management-views-and-functions-transact-sql)  
  
 [<span data-ttu-id="013d7-201">跟踪标志 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="013d7-201">Trace Flags &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql)  
  
  

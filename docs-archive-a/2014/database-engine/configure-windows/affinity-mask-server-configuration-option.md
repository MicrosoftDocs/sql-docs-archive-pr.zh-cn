---
title: affinity mask 服务器配置选项 | Microsoft Docs
ms.custom: ''
ms.date: 10/20/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: configuration
ms.topic: conceptual
helpviewer_keywords:
- default affinity mask option
- reloading processor cache
- processor cache [SQL Server]
- CPU [SQL Server], licensing
- deferred process call
- affinity mask option
- processor affinity [SQL Server]
- SMP
- DPC
ms.assetid: 5823ba29-a75d-4b3e-ba7b-421c07ab3ac1
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: dfebde8a9431026e8faedb2a1e76eb2f2d82e207
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87588051"
---
# <a name="affinity-mask-server-configuration-option"></a><span data-ttu-id="0e742-102">affinity mask 服务器配置选项</span><span class="sxs-lookup"><span data-stu-id="0e742-102">affinity mask Server Configuration Option</span></span>
    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureDontUse](../../includes/ssnotedepfuturedontuse-md.md)] <span data-ttu-id="0e742-103">改为使用 [ALTER SERVER CONFIGURATION (Transact-SQL)](/sql/t-sql/statements/alter-server-configuration-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="0e742-103">Use [ALTER SERVER CONFIGURATION &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-server-configuration-transact-sql) instead.</span></span>  
  
 <span data-ttu-id="0e742-104">为了执行多任务， [!INCLUDE[msCoName](../../includes/msconame-md.md)] Windows 有时会在不同的处理器之间移动进程线程。</span><span class="sxs-lookup"><span data-stu-id="0e742-104">To carry out multitasking, [!INCLUDE[msCoName](../../includes/msconame-md.md)] Windows sometimes move process threads among different processors.</span></span> <span data-ttu-id="0e742-105">虽然从操作系统方面而言，这种活动是高效的，但是在高系统负荷的情况下，该活动会降低 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的性能，因为每个处理器缓存都会不断地重新加载数据。</span><span class="sxs-lookup"><span data-stu-id="0e742-105">Although efficient from an operating system point of view, this activity can reduce [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] performance under heavy system loads, as each processor cache is repeatedly reloaded with data.</span></span> <span data-ttu-id="0e742-106">如果将各个处理器分配给特定线程，则通过消除处理器的重新加载需要以及减少处理器之间的线程迁移（因而减少上下文切换），可以提高在这些条件下的性能；线程与处理器之间的这种关联称为“处理器关联”。</span><span class="sxs-lookup"><span data-stu-id="0e742-106">Assigning processors to specific threads can improve performance under these conditions by eliminating processor reloads and reducing thread migration across processors (thereby reducing context switching); such an association between a thread and a processor is called processor affinity.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]<span data-ttu-id="0e742-107">通过两个关联掩码选项来支持处理器关联：关联掩码 (也称为**CPU 关联掩码**) 和关联 i/o 掩码。</span><span class="sxs-lookup"><span data-stu-id="0e742-107">supports processor affinity by means of two affinity mask options: affinity mask (also known as **CPU affinity mask**) and affinity I/O mask.</span></span> <span data-ttu-id="0e742-108">有关 affinity I/O maskoption 的详细信息，请参阅 [affinity I/O mask 服务器配置选项](affinity-input-output-mask-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="0e742-108">For more information on the affinity I/O maskoption, see [affinity Input-Output mask Server Configuration Option](affinity-input-output-mask-server-configuration-option.md).</span></span> <span data-ttu-id="0e742-109">对具有 33 至 64 个处理器的服务器的 CPU 和 I/O 关联支持还要求分别使用 [affinity64 mask 服务器配置选项](affinity64-mask-server-configuration-option.md) 和 [affinity64 I/O mask 服务器配置选项](affinity64-input-output-mask-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="0e742-109">CPU and I/O affinity support for servers with 33 to 64 processors requires the additional use of the [affinity64 mask Server Configuration Option](affinity64-mask-server-configuration-option.md) and [affinity64 Input-Output mask Server Configuration Option](affinity64-input-output-mask-server-configuration-option.md), respectively.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="0e742-110">对具有 33 到 64 个处理器的服务器的关联支持仅在 64 位操作系统上可用。</span><span class="sxs-lookup"><span data-stu-id="0e742-110">Affinity support for servers with 33 to 64 processors is only available on 64-bit operating systems.</span></span>  
  
 <span data-ttu-id="0e742-111">关联掩码选项存在于 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的早期版本中，用于动态控制 CPU 关联。</span><span class="sxs-lookup"><span data-stu-id="0e742-111">The affinity mask option, which existed in earlier releases of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], dynamically controls CPU affinity.</span></span>  
  
 <span data-ttu-id="0e742-112">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中，可以配置关联掩码选项而无需重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例。</span><span class="sxs-lookup"><span data-stu-id="0e742-112">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the affinity mask option can be configured without requiring a restart of the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="0e742-113">在您正在使用 sp_configure 时，必须在设置配置选项之后运行 RECONFIGURE 或 RECONFIGURE WITH OVERRIDE。</span><span class="sxs-lookup"><span data-stu-id="0e742-113">When you are using sp_configure, you must run either RECONFIGURE or RECONFIGURE WITH OVERRIDE after setting a configuration option.</span></span> <span data-ttu-id="0e742-114">使用 [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)]时，更改关联掩码选项不需要重新启动。</span><span class="sxs-lookup"><span data-stu-id="0e742-114">When you are using [!INCLUDE[ssExpress](../../includes/ssexpress-md.md)], changing the affinity mask option does require a restart.</span></span>  
  
 <span data-ttu-id="0e742-115">关联掩码的更改是动态进行的，因此可以按需启动和关闭用于在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中绑定进程线程的 CPU 计划程序。</span><span class="sxs-lookup"><span data-stu-id="0e742-115">Changes to the affinity masks occur dynamically, allowing for on-demand startup and shutdown of the CPU schedulers that bind process threads within [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="0e742-116">当服务器上的条件改变时会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="0e742-116">This can occur as conditions change on the server.</span></span> <span data-ttu-id="0e742-117">例如，如果向服务器上添加了新的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例，可能需要调整关联掩码选项以重新分配处理器负荷。</span><span class="sxs-lookup"><span data-stu-id="0e742-117">For example, if a new instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is added to the server, it may be necessary to make adjustments to the affinity mask option to redistribute processor load.</span></span>  
  
 <span data-ttu-id="0e742-118">对关联位掩码进行修改需要 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 启用新的 CPU 计划程序并禁用现有的 CPU 计划程序。</span><span class="sxs-lookup"><span data-stu-id="0e742-118">Modifications to the affinity bitmasks require [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to enable a new CPU scheduler and disable the existing CPU scheduler.</span></span> <span data-ttu-id="0e742-119">然后就可以在新的或剩余的计划程序上处理新批处理。</span><span class="sxs-lookup"><span data-stu-id="0e742-119">New batches can then be processed on the new or remaining schedulers.</span></span>  
  
 <span data-ttu-id="0e742-120">若要启动新的 CPU 计划程序， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 应创建新的计划程序并将其添加到标准计划程序列表中。</span><span class="sxs-lookup"><span data-stu-id="0e742-120">To start a new CPU scheduler, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates a new scheduler and adds it to the list of its standard schedulers.</span></span> <span data-ttu-id="0e742-121">新的计划程序仅用于新加入的批处理。</span><span class="sxs-lookup"><span data-stu-id="0e742-121">The new scheduler is considered only for the new incoming batches.</span></span> <span data-ttu-id="0e742-122">当前批处理会继续在同一计划程序上运行。</span><span class="sxs-lookup"><span data-stu-id="0e742-122">Current batches continue to run on the same scheduler.</span></span> <span data-ttu-id="0e742-123">当释放了现有工作线程或创建了新的工作线程后，它们就会迁移到新的计划程序。</span><span class="sxs-lookup"><span data-stu-id="0e742-123">The workers migrate to the new scheduler as they free up, or as new workers are created.</span></span>  
  
 <span data-ttu-id="0e742-124">若要关闭某个计划程序，需要等到该计划程序上的所有批处理都完成其活动并退出之后。</span><span class="sxs-lookup"><span data-stu-id="0e742-124">Shutting down a scheduler requires all batches on the scheduler to complete their activities and exit.</span></span> <span data-ttu-id="0e742-125">已关闭的计划程序将被标记为脱机，以防在它上面安排新的批处理。</span><span class="sxs-lookup"><span data-stu-id="0e742-125">A scheduler that has been shut down is marked as offline so that no new batch is scheduled on it.</span></span>  
  
 <span data-ttu-id="0e742-126">服务器处于运行状态时，无论添加还是删除了计划程序，永久系统任务 [如锁监视器、检查点、系统任务线程（用于处理 DTC）和信号进程] 都会继续在原计划程序上运行。</span><span class="sxs-lookup"><span data-stu-id="0e742-126">Whether a new scheduler is added or removed, the permanent system tasks such as lockmonitor, checkpoint, system task thread (processing DTC), and signal process continue to run on the scheduler while the server is operational.</span></span> <span data-ttu-id="0e742-127">这些永久系统任务不会动态迁移。</span><span class="sxs-lookup"><span data-stu-id="0e742-127">These permanent system tasks do not dynamically migrate.</span></span> <span data-ttu-id="0e742-128">若要在各个计划程序上重新为这些系统任务分配处理器负荷，则需要重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例。</span><span class="sxs-lookup"><span data-stu-id="0e742-128">To redistribute processor load for these system tasks across schedulers, it is necessary to restart the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="0e742-129">当 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 尝试关闭与某个永久系统任务相关联的计划程序时，该任务会继续在脱机计划程序上运行（而不迁移）。</span><span class="sxs-lookup"><span data-stu-id="0e742-129">If [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] attempts to shut down a scheduler associated with a permanent system task, the task continues to run on the offline scheduler (no migration).</span></span> <span data-ttu-id="0e742-130">此计划程序将被绑定到修改后的关联掩码中的处理器，在修改之前，不应在其关联的处理器上添加任何负荷。</span><span class="sxs-lookup"><span data-stu-id="0e742-130">This scheduler is bound to the processors in the modified affinity mask and should not put any load on the processor it was affinitized with before the change.</span></span> <span data-ttu-id="0e742-131">额外的脱机计划程序不会显著影响系统的负荷。</span><span class="sxs-lookup"><span data-stu-id="0e742-131">Having extra offline schedulers, should not significantly affect the load of the system.</span></span> <span data-ttu-id="0e742-132">如果不是这样，则需要重新启动数据库服务器以重新配置这些任务。</span><span class="sxs-lookup"><span data-stu-id="0e742-132">If this is not the case, a database server reboot is required to reconfigure these tasks.</span></span>  
  
 <span data-ttu-id="0e742-133">I/O 关联任务（如惰性编写器和日志编写器）直接受 I/O 关联掩码的影响。</span><span class="sxs-lookup"><span data-stu-id="0e742-133">The I/O affinity tasks (such as lazywriter and logwriter) are directly affected by the I/O affinity mask.</span></span> <span data-ttu-id="0e742-134">如果惰性编写器和日志编写器任务不被关联，它们将与其他永久任务（如锁监视器或检查点）遵循相同的规则。</span><span class="sxs-lookup"><span data-stu-id="0e742-134">If the lazywriter and logwriter tasks are not affinitized, they follow the same rules defined for the other permanent tasks such as lockmonitor or checkpoint.</span></span>  
  
 <span data-ttu-id="0e742-135">为了确保新的关联掩码有效，RECONFIGURE 命令将验证正常 CPU 与 I/O 关联是否互相排斥。</span><span class="sxs-lookup"><span data-stu-id="0e742-135">To ensure that the new affinity mask is valid, the RECONFIGURE command verifies that the normal CPU and I/O affinities are mutually exclusive.</span></span> <span data-ttu-id="0e742-136">如果不互相排斥，将向客户端会话和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 错误日志报告一条错误消息，指明不建议进行这种设置。</span><span class="sxs-lookup"><span data-stu-id="0e742-136">If this is not the case, an error message is reported to the client session and to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, indicating that such a setting is not recommended.</span></span> <span data-ttu-id="0e742-137">运行 RECONFIGURE WITH OVERRIDE 选项将允许 CPU 与 I/O 关联不互相排斥。</span><span class="sxs-lookup"><span data-stu-id="0e742-137">Running RECONFIGURE WITH OVERRIDE options allows CPU and I/O affinities that are not mutually exclusive.</span></span>  
  
 <span data-ttu-id="0e742-138">如果指定的关联掩码试图映射到不存在的 CPU，RECONFIGURE 命令会向客户端会话和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 错误日志报告一条错误消息。</span><span class="sxs-lookup"><span data-stu-id="0e742-138">If you specify an affinity mask that attempts to map to a nonexistent CPU, the RECONFIGURE command reports an error message to both the client session and the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="0e742-139">在这种情况下，RECONFIGURE WITH OVERRIDE 选项将不起作用，并将再次报告相同的配置错误。</span><span class="sxs-lookup"><span data-stu-id="0e742-139">Using the RECONFIGURE WITH OVERRIDE option has no effect in this case, and the same configuration error is reported again.</span></span>  
  
 <span data-ttu-id="0e742-140">您也可以不在由 Windows 2000 或 Windows Server 2003 操作系统分配了特定工作负荷的处理器上执行 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 活动。</span><span class="sxs-lookup"><span data-stu-id="0e742-140">You can also exclude [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] activity from processors assigned specific workload assignments by the Windows 2000 or Windows Server 2003 operating system.</span></span> <span data-ttu-id="0e742-141">如果将代表某个处理器的位设置为 1，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库引擎将会选择该处理器来进行线程分配。</span><span class="sxs-lookup"><span data-stu-id="0e742-141">If you set a bit representing a processor to 1, that processor is selected by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Database Engine for thread assignment.</span></span> <span data-ttu-id="0e742-142">如果设置 `affinity mask` 为 0 (默认) ，则 Microsoft Windows 2000 或 Windows Server 2003 计划算法将设置线程的关联。</span><span class="sxs-lookup"><span data-stu-id="0e742-142">When you set `affinity mask` to 0 (the default), the Microsoft Windows 2000 or Windows Server 2003 scheduling algorithms set the thread's affinity.</span></span> <span data-ttu-id="0e742-143">如果将 `affinity mask` 设置为任一非零值，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 关联将把该值解释为一个位掩码，用于指定可选的处理器。</span><span class="sxs-lookup"><span data-stu-id="0e742-143">When you set `affinity mask` to any nonzero value, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] affinity interprets the value as a bitmask that specifies those processors eligible for selection.</span></span>  
  
 <span data-ttu-id="0e742-144">通过防止 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 线程在某个特定的处理器上运行，Microsoft Windows 2000 或 Windows Server 2003 可以更好地评估 Windows 专用的系统进程处理。</span><span class="sxs-lookup"><span data-stu-id="0e742-144">By segregating [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] threads from running on particular processors, Microsoft Windows 2000 or Windows Server 2003 can better evaluate the system's handling of processes specific to Windows.</span></span> <span data-ttu-id="0e742-145">例如，在运行两个 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例（实例 A 和实例 B）的具有 8 个 CPU 的服务器上，系统管理员可以使用关联掩码选项将第一组的 4 个 CPU 分配给实例 A，将第二组的 4 个 CPU 分配给实例 B。若要配置 32 个以上的处理器，应同时设置关联掩码和 affinity64 掩码。</span><span class="sxs-lookup"><span data-stu-id="0e742-145">For example, on an 8-CPU server running two instances of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (instance A and B), the system administrator could use the affinity mask option to assign the first set of 4 CPUs to instance A and the second set of 4 to instance B. To configure more than 32 processors, set both the affinity mask and the affinity64 mask.</span></span> <span data-ttu-id="0e742-146">`affinity mask` 的值如下：</span><span class="sxs-lookup"><span data-stu-id="0e742-146">The values for `affinity mask` are as follows:</span></span>  
  
-   <span data-ttu-id="0e742-147">在多处理器计算机中，单字节 `affinity mask` 最多可以涵盖 8 个 CPU。</span><span class="sxs-lookup"><span data-stu-id="0e742-147">A one-byte `affinity mask` covers up to 8 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="0e742-148">在多处理器计算机中，双字节 `affinity mask` 最多可以涵盖 16 个 CPU。</span><span class="sxs-lookup"><span data-stu-id="0e742-148">A two-byte `affinity mask` covers up to 16 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="0e742-149">在多处理器计算机中，3 字节 `affinity mask` 最多可以涵盖 24 个 CPU。</span><span class="sxs-lookup"><span data-stu-id="0e742-149">A three-byte `affinity mask` covers up to 24 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="0e742-150">在多处理器计算机中，4 字节 `affinity mask` 最多可以涵盖 32 个 CPU。</span><span class="sxs-lookup"><span data-stu-id="0e742-150">A four-byte `affinity mask` covers up to 32 CPUs in a multiprocessor computer.</span></span>  
  
-   <span data-ttu-id="0e742-151">若要涵盖 32 个以上的 CPU，可为前 32 个 CPU 配置一个 4 字节关联掩码，为其余的 CPU 配置一个最多 4 字节的 affinity64 掩码。</span><span class="sxs-lookup"><span data-stu-id="0e742-151">To cover more than 32 CPUs, configure a four-byte affinity mask for the first 32 CPUs and up to a four-byte affinity64 mask for the remaining CPUs.</span></span>  
  
 <span data-ttu-id="0e742-152">因为设置 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 处理器关联是一种专用操作，所以建议只在需要时使用。</span><span class="sxs-lookup"><span data-stu-id="0e742-152">Because setting [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] processor affinity is a specialized operation, it is recommended that it be used only when necessary.</span></span> <span data-ttu-id="0e742-153">大多数情况下，Windows 2000 或 Windows Server 2003 的默认关联可提供最佳性能。</span><span class="sxs-lookup"><span data-stu-id="0e742-153">In most cases, the Microsoft Windows 2000 or Windows Server 2003 default affinity provides the best performance.</span></span> <span data-ttu-id="0e742-154">在设置关联掩码时还应考虑其他应用程序对 CPU 的需求。</span><span class="sxs-lookup"><span data-stu-id="0e742-154">You should also consider the CPU requirements for other applications when setting the affinity masks.</span></span> <span data-ttu-id="0e742-155">有关详细信息，请参阅 Windows 操作系统文档。</span><span class="sxs-lookup"><span data-stu-id="0e742-155">For more information, see your Windows operating system documentation.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="0e742-156">可以使用 Windows 系统监视器来查看和分析单个处理器的使用情况。</span><span class="sxs-lookup"><span data-stu-id="0e742-156">You can use the Windows System Monitor to view and analyze individual processor usage.</span></span>  
  
 <span data-ttu-id="0e742-157">在指定 affinity I/O mask 选项时，必须将其与关联掩码配置选项结合使用。</span><span class="sxs-lookup"><span data-stu-id="0e742-157">When specifying the affinity I/O mask option, you must use it in connection with the affinity mask configuration option.</span></span> <span data-ttu-id="0e742-158">请勿在关联掩码`affinity mask`开关和关联 I/O 掩码选项中启用相同的 CPU。</span><span class="sxs-lookup"><span data-stu-id="0e742-158">Do not enable the same CPU in both the `affinity mask` switch and the affinity I/O mask option.</span></span> <span data-ttu-id="0e742-159">与每个 CPU 对应的位应处于以下三种状态之一：</span><span class="sxs-lookup"><span data-stu-id="0e742-159">The bits corresponding to each CPU should be in one of these three states:</span></span>  
  
-   <span data-ttu-id="0e742-160">在 affinity mask 选项和 affinity I/O mask 选项中均为 0。</span><span class="sxs-lookup"><span data-stu-id="0e742-160">0 in both the affinity mask option and the affinity I/O mask option.</span></span>  
  
-   <span data-ttu-id="0e742-161">在 affinity mask 选项中为 1，在 affinity I/O mask 选项中为 0。</span><span class="sxs-lookup"><span data-stu-id="0e742-161">1 in the affinity mask option and 0 in the affinity I/O mask option.</span></span>  
  
-   <span data-ttu-id="0e742-162">在 affinity mask 选项中为 0，在 affinity I/O mask 选项中为 1。</span><span class="sxs-lookup"><span data-stu-id="0e742-162">0 in the affinity mask option and 1 in the affinity I/O mask option.</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="0e742-163">请不要在 Windows 操作系统中配置 CPU 关联后，还在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 中配置关联掩码。</span><span class="sxs-lookup"><span data-stu-id="0e742-163">Do not configure CPU affinity in the Windows operating system and also configure the affinity mask in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="0e742-164">这些设置实现的效果相同，如果配置不一致，则可能会得到意外的结果。</span><span class="sxs-lookup"><span data-stu-id="0e742-164">These settings are attempting to achieve the same result, and if the configurations are inconsistent, you may have unpredictable results.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="0e742-165">最好使用 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]中的 sp_configure 选项配置 CPU 关联。</span><span class="sxs-lookup"><span data-stu-id="0e742-165">CPU affinity is best configured using the sp_configure option in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
## <a name="example"></a><span data-ttu-id="0e742-166">示例</span><span class="sxs-lookup"><span data-stu-id="0e742-166">Example</span></span>  
 <span data-ttu-id="0e742-167">例如，设置关联掩码选项时，如果选择处理器 1、2 和 5 作为可用的处理器，并将位 1、2 和 5 设置为 1，位 0、3、4、6 和 7 设置为 0，则将指定十六进制值 0x26 或等于 `38` 的十进制值。</span><span class="sxs-lookup"><span data-stu-id="0e742-167">As an example of setting the affinity mask option, if processors 1, 2, and 5 are selected as available with bits 1, 2, and 5 set to 1 and bits 0, 3, 4, 6, and 7 set to 0, a hexadecimal value of 0x26 or the decimal equivalent of `38` is specified.</span></span> <span data-ttu-id="0e742-168">从右至左对位进行编号。</span><span class="sxs-lookup"><span data-stu-id="0e742-168">Number the bits from right to left.</span></span> <span data-ttu-id="0e742-169">关联掩码选项按从 0 到 31 的方式来计算处理器，这样在以下示例中，计数器 `1` 表示服务器上的第二个处理器。</span><span class="sxs-lookup"><span data-stu-id="0e742-169">The affinity mask option starts counting processors from 0 to 31, so that in the following example the counter `1` represents the second processor on the server.</span></span>  
  
```  
sp_configure 'show advanced options', 1;  
RECONFIGURE;  
GO  
sp_configure 'affinity mask', 38;  
RECONFIGURE;  
GO  
```  
  
 <span data-ttu-id="0e742-170">以下是具有 8 个 CPU 的系统的 `affinity mask` 值。</span><span class="sxs-lookup"><span data-stu-id="0e742-170">These are `affinity mask` values for an 8-CPU system.</span></span>  
  
|<span data-ttu-id="0e742-171">十进制值</span><span class="sxs-lookup"><span data-stu-id="0e742-171">Decimal value</span></span>|<span data-ttu-id="0e742-172">二进制位掩码</span><span class="sxs-lookup"><span data-stu-id="0e742-172">Binary bit mask</span></span>|<span data-ttu-id="0e742-173">允许 SQL Server 线程在哪些处理器上运行</span><span class="sxs-lookup"><span data-stu-id="0e742-173">Allow SQL Server threads on processors</span></span>|  
|-------------------|---------------------|--------------------------------------------|  
|<span data-ttu-id="0e742-174">1</span><span class="sxs-lookup"><span data-stu-id="0e742-174">1</span></span>|<span data-ttu-id="0e742-175">00000001</span><span class="sxs-lookup"><span data-stu-id="0e742-175">00000001</span></span>|<span data-ttu-id="0e742-176">0</span><span class="sxs-lookup"><span data-stu-id="0e742-176">0</span></span>|  
|<span data-ttu-id="0e742-177">3</span><span class="sxs-lookup"><span data-stu-id="0e742-177">3</span></span>|<span data-ttu-id="0e742-178">00000011</span><span class="sxs-lookup"><span data-stu-id="0e742-178">00000011</span></span>|<span data-ttu-id="0e742-179">0 和 1</span><span class="sxs-lookup"><span data-stu-id="0e742-179">0 and 1</span></span>|  
|<span data-ttu-id="0e742-180">7</span><span class="sxs-lookup"><span data-stu-id="0e742-180">7</span></span>|<span data-ttu-id="0e742-181">00000111</span><span class="sxs-lookup"><span data-stu-id="0e742-181">00000111</span></span>|<span data-ttu-id="0e742-182">0、1 和 2</span><span class="sxs-lookup"><span data-stu-id="0e742-182">0, 1, and 2</span></span>|  
|<span data-ttu-id="0e742-183">15</span><span class="sxs-lookup"><span data-stu-id="0e742-183">15</span></span>|<span data-ttu-id="0e742-184">00001111</span><span class="sxs-lookup"><span data-stu-id="0e742-184">00001111</span></span>|<span data-ttu-id="0e742-185">0、1、2 和 3</span><span class="sxs-lookup"><span data-stu-id="0e742-185">0, 1, 2, and 3</span></span>|  
|<span data-ttu-id="0e742-186">31</span><span class="sxs-lookup"><span data-stu-id="0e742-186">31</span></span>|<span data-ttu-id="0e742-187">00011111</span><span class="sxs-lookup"><span data-stu-id="0e742-187">00011111</span></span>|<span data-ttu-id="0e742-188">0、1、2、3 和 4</span><span class="sxs-lookup"><span data-stu-id="0e742-188">0, 1, 2, 3, and 4</span></span>|  
|<span data-ttu-id="0e742-189">63</span><span class="sxs-lookup"><span data-stu-id="0e742-189">63</span></span>|<span data-ttu-id="0e742-190">00111111</span><span class="sxs-lookup"><span data-stu-id="0e742-190">00111111</span></span>|<span data-ttu-id="0e742-191">0、1、2、3、4 和 5</span><span class="sxs-lookup"><span data-stu-id="0e742-191">0, 1, 2, 3, 4, and 5</span></span>|  
|<span data-ttu-id="0e742-192">127</span><span class="sxs-lookup"><span data-stu-id="0e742-192">127</span></span>|<span data-ttu-id="0e742-193">01111111</span><span class="sxs-lookup"><span data-stu-id="0e742-193">01111111</span></span>|<span data-ttu-id="0e742-194">0、1、2、3、4、5 和 6</span><span class="sxs-lookup"><span data-stu-id="0e742-194">0, 1, 2, 3, 4, 5, and 6</span></span>|  
|<span data-ttu-id="0e742-195">255</span><span class="sxs-lookup"><span data-stu-id="0e742-195">255</span></span>|<span data-ttu-id="0e742-196">11111111</span><span class="sxs-lookup"><span data-stu-id="0e742-196">11111111</span></span>|<span data-ttu-id="0e742-197">0、1、2、3、4、5、6 和 7</span><span class="sxs-lookup"><span data-stu-id="0e742-197">0, 1, 2, 3, 4, 5, 6, and 7</span></span>|  
  
 <span data-ttu-id="0e742-198">affinity mask 选项是一个高级选项。</span><span class="sxs-lookup"><span data-stu-id="0e742-198">The affinity mask option is an advanced option.</span></span> <span data-ttu-id="0e742-199">如果使用 sp_configure 系统存储过程来更改该设置，则 `affinity mask` 仅当**show advanced options**设置为1时才可以更改。</span><span class="sxs-lookup"><span data-stu-id="0e742-199">If you are using the sp_configure system stored procedure to change the setting, you can change `affinity mask` only when **show advanced options** is set to 1.</span></span> <span data-ttu-id="0e742-200">执行 [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE 命令后，新的设置将立即生效，且不需要重新启动 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例。</span><span class="sxs-lookup"><span data-stu-id="0e742-200">After executing the [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE command, the new setting takes effect immediately without requiring a restart of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span>  
  
## <a name="non-uniform-memory-access-numa"></a><span data-ttu-id="0e742-201">非一致性内存访问 (NUMA)</span><span class="sxs-lookup"><span data-stu-id="0e742-201">Non-uniform Memory Access (NUMA)</span></span>  
 <span data-ttu-id="0e742-202">当使用基于硬件的非一致性内存访问 (NUMA) 并设置了关联掩码时，节点中的每个计划程序都将关联到它自己的 CPU。</span><span class="sxs-lookup"><span data-stu-id="0e742-202">When using hardware based non-uniform memory access (NUMA) and the affinity mask is set, every scheduler in a node will be affinitized to its own CPU.</span></span> <span data-ttu-id="0e742-203">未设置关联掩码时，每个计划程序都关联到 NUMA 节点内的 CPU 组，映射到 NUMA 节点 N1 的计划程序可对节点中的任何 CPU 计划工作，但是不能对与其他节点关联的 CPU 计划工作。</span><span class="sxs-lookup"><span data-stu-id="0e742-203">When the affinity mask is not set, each scheduler is affinitized to the group of CPUs within the NUMA node and a scheduler mapped to NUMA node N1 can schedule work on any CPU in the node, but not on CPUs associated with another node.</span></span>  
  
 <span data-ttu-id="0e742-204">针对单个 NUMA 节点执行的任何操作都只能使用该节点中的缓冲区页。</span><span class="sxs-lookup"><span data-stu-id="0e742-204">Any operation running on a single NUMA node can only use buffer pages from that node.</span></span> <span data-ttu-id="0e742-205">当针对多个节点上的 CPU 以并行方式执行操作时，可以使用所涉及的任何节点中的内存。</span><span class="sxs-lookup"><span data-stu-id="0e742-205">When an operation is run in parallel on CPUs from multiple nodes, memory can be used from any node involved.</span></span>  
  
## <a name="licensing-issues"></a><span data-ttu-id="0e742-206">许可问题</span><span class="sxs-lookup"><span data-stu-id="0e742-206">Licensing Issues</span></span>  
 <span data-ttu-id="0e742-207">动态关联受 CPU 许可的严格约束。</span><span class="sxs-lookup"><span data-stu-id="0e742-207">Dynamic affinity is tightly constrained by CPU licensing.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="0e742-208">不允许对关联掩码选项进行任何违反许可策略的配置。</span><span class="sxs-lookup"><span data-stu-id="0e742-208">does not allow any configuration of affinity mask options that violates the licensing policy.</span></span>  
  
### <a name="startup"></a><span data-ttu-id="0e742-209">启动</span><span class="sxs-lookup"><span data-stu-id="0e742-209">Startup</span></span>  
 <span data-ttu-id="0e742-210">如果在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 启动期间或在数据库附加期间，指定的关联掩码违反了许可策略，则引擎层将会完成启动进程或数据库附加/还原操作，然后将关联掩码的 sp_configure 运行值重置为零，并向 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 错误日志发出一条错误消息。</span><span class="sxs-lookup"><span data-stu-id="0e742-210">If a specified affinity mask violates the licensing policy during [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] startup or during database attach, the engine layer will complete the startup process or database attach/restore operation, and then it will reset the sp_configure run value for the affinity mask to zero, issuing an error message to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span>  
  
### <a name="reconfigure"></a><span data-ttu-id="0e742-211">重新配置</span><span class="sxs-lookup"><span data-stu-id="0e742-211">Reconfigure</span></span>  
 <span data-ttu-id="0e742-212">如果在运行 [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE 命令时，指定的关联掩码违反了许可策略，则系统将向客户端会话和 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 错误日志报告错误消息，要求数据库管理员重新配置关联掩码。</span><span class="sxs-lookup"><span data-stu-id="0e742-212">If a specified affinity mask violates the licensing policy when running [!INCLUDE[tsql](../../includes/tsql-md.md)] RECONFIGURE command, an error message is reported to the client session and to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log, requiring the database administrator to reconfigure the affinity mask.</span></span> <span data-ttu-id="0e742-213">在这种情况下，不接受任何 RECONFIGURE WITH OVERRIDE 命令。</span><span class="sxs-lookup"><span data-stu-id="0e742-213">No RECONFIGURE WITH OVERRIDE command is accepted in this case.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="0e742-214">另请参阅</span><span class="sxs-lookup"><span data-stu-id="0e742-214">See Also</span></span>  
 <span data-ttu-id="0e742-215">[监视资源使用情况（系统监视器）](../../relational-databases/performance-monitor/monitor-resource-usage-system-monitor.md) </span><span class="sxs-lookup"><span data-stu-id="0e742-215">[Monitor Resource Usage &#40;System Monitor&#41;](../../relational-databases/performance-monitor/monitor-resource-usage-system-monitor.md) </span></span>  
 <span data-ttu-id="0e742-216">[RECONFIGURE (Transact-SQL)](/sql/t-sql/language-elements/reconfigure-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="0e742-216">[RECONFIGURE &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/reconfigure-transact-sql) </span></span>  
 <span data-ttu-id="0e742-217">[服务器配置选项 (SQL Server)](server-configuration-options-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="0e742-217">[Server Configuration Options &#40;SQL Server&#41;](server-configuration-options-sql-server.md) </span></span>  
 <span data-ttu-id="0e742-218">[sp_configure &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="0e742-218">[sp_configure &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-configure-transact-sql) </span></span>  
 [<span data-ttu-id="0e742-219">ALTER SERVER CONFIGURATION (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="0e742-219">ALTER SERVER CONFIGURATION &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-server-configuration-transact-sql)  
  
  

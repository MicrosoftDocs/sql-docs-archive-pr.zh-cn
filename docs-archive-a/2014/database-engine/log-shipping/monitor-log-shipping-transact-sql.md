---
title: 监视日志传送 (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], status
- history tables [SQL Server]
- historical information [SQL Server], log shipping
- log shipping [SQL Server], monitoring
- alerts [SQL Server], log shipping
- status information [SQL Server], log shipping
- monitoring log shipping [SQL Server]
ms.assetid: acf3cd99-55f7-4287-8414-0892f830f423
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0ab87d5d8aa08b7b2860fe52fd097f33af327a94
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87579728"
---
# <a name="monitor-log-shipping-transact-sql"></a><span data-ttu-id="ec5c5-102">监视日志传送 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="ec5c5-102">Monitor Log Shipping (Transact-SQL)</span></span>
  <span data-ttu-id="ec5c5-103">配置日志传送后，就可以监视有关所有日志传送服务器状态的信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-103">After you have configured log shipping, you can monitor information about the status of all the log shipping servers.</span></span> <span data-ttu-id="ec5c5-104">日志传送操作的历史记录和状态始终由日志传送作业保存在本地。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-104">The history and status of log shipping operations are always saved locally by the log shipping jobs.</span></span> <span data-ttu-id="ec5c5-105">备份操作的历史记录和状态存储在主服务器上，复制和还原操作的历史记录和状态存储在辅助服务器上。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-105">The history and status of the backup operation are stored at the primary server, and the history and status of the copy and restore operations are stored at the secondary server.</span></span> <span data-ttu-id="ec5c5-106">如果使用了远程监视服务器，此信息还将存储在监视服务器上。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-106">If you have implemented a remote monitor server, this information is also stored on the monitor server.</span></span>  
  
 <span data-ttu-id="ec5c5-107">您可以配置警报，当日志传送操作无法按计划发生时激发该警报。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-107">You can configure alerts that will fire if log shipping operations fail to occur as scheduled.</span></span> <span data-ttu-id="ec5c5-108">监视备份和还原操作状态的警报作业将引发错误。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-108">Errors are raised by an alert job that watches the status of the backup and restore operations.</span></span> <span data-ttu-id="ec5c5-109">您可以定义警报，以便在引发这些错误时通知操作员。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-109">You can define alerts that notify an operator when these errors are raised.</span></span> <span data-ttu-id="ec5c5-110">如果配置了监视服务器，该监视服务器上将运行一个警报作业，它可以引发日志传送配置中所有操作的错误。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-110">If a monitor server is configured, one alert job runs on the monitor server that raises errors for all operations in the log shipping configuration.</span></span> <span data-ttu-id="ec5c5-111">如果未指定监视服务器，警报作业将在主服务器实例上运行，以便监视备份操作。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-111">If a monitor server is not specified, an alert job runs on the primary server instance, which monitors the backup operation.</span></span> <span data-ttu-id="ec5c5-112">警报作业还将在每个辅助服务器实例上运行，以便监视本地复制和还原操作。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-112">If a monitor server is not specified, an alert job also runs on each secondary server instance to monitor the local copy and restore operations.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="ec5c5-113">若要监视日志传送配置，在启用日志传送时必须添加监视服务器。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-113">To monitor a log shipping configuration, you must add the monitor server when you enable log shipping.</span></span> <span data-ttu-id="ec5c5-114">如果之后添加监视服务器，则必须首先删除日志传送配置，然后将其替换为包含监视服务器的新配置。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-114">If you add a monitor server later, you must remove the log shipping configuration and then replace it with a new configuration that includes a monitor server.</span></span> <span data-ttu-id="ec5c5-115">有关详细信息，请参阅[配置日志传送 (SQL Server)](configure-log-shipping-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-115">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span> <span data-ttu-id="ec5c5-116">此外，在配置了监视服务器之后，只有首先删除日志传送才能对其进行更改。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-116">Furthermore, after the monitor server has been configured, it cannot be changed without removing log shipping first.</span></span>  
  
## <a name="history-tables-containing-monitoring-information"></a><span data-ttu-id="ec5c5-117">包含监视信息的历史记录表</span><span class="sxs-lookup"><span data-stu-id="ec5c5-117">History Tables Containing Monitoring Information</span></span>  
 <span data-ttu-id="ec5c5-118">监视历史记录表包含监视服务器上存储的元数据。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-118">The monitoring history tables contain metadata that is stored on the monitor server.</span></span> <span data-ttu-id="ec5c5-119">与给定的主服务器或辅助服务器相关的信息副本也存储在本地。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-119">A copy of information specific to a given primary or secondary server is also stored locally.</span></span>  
  
 <span data-ttu-id="ec5c5-120">可以查询这些表，以监视日志传送会话的状态。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-120">You can query these tables to monitor the status of a log shipping session.</span></span> <span data-ttu-id="ec5c5-121">例如，了解日志传送的状态，查看备份作业、复制作业和还原作业的状态和历史记录。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-121">For example, to learn status of log shipping, check the status and history of the backup job, copy job, and restore job.</span></span> <span data-ttu-id="ec5c5-122">通过查询下列监视表，可以查看特定的日志传送历史记录和错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-122">You can view specific log shipping history and error details by querying the following monitoring tables.</span></span>  
  
|<span data-ttu-id="ec5c5-123">表</span><span class="sxs-lookup"><span data-stu-id="ec5c5-123">Table</span></span>|<span data-ttu-id="ec5c5-124">说明</span><span class="sxs-lookup"><span data-stu-id="ec5c5-124">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="ec5c5-125">log_shipping_monitor_alert</span><span class="sxs-lookup"><span data-stu-id="ec5c5-125">log_shipping_monitor_alert</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-alert-transact-sql)|<span data-ttu-id="ec5c5-126">存储警报作业 ID。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-126">Stores alert job ID.</span></span>|  
|[<span data-ttu-id="ec5c5-127">log_shipping_monitor_error_detail</span><span class="sxs-lookup"><span data-stu-id="ec5c5-127">log_shipping_monitor_error_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-error-detail-transact-sql)|<span data-ttu-id="ec5c5-128">存储日志传送作业的错误详细信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-128">Stores error details for log shipping jobs.</span></span> <span data-ttu-id="ec5c5-129">可以查询此表来查看某个代理会话的错误。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-129">You can query this table see the errors for an agent session.</span></span> <span data-ttu-id="ec5c5-130">还可以按每个错误的记录日期和时间对错误进行排序。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-130">Optionally, you can sort the errors by the date and time at which each was logged.</span></span> <span data-ttu-id="ec5c5-131">每个错误都记录为一个异常序列，多个错误（序列）可以形成一个代理会话。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-131">Each error is logged as a sequence of exceptions, and multiple errors (sequences) can per agent session.</span></span>|  
|[<span data-ttu-id="ec5c5-132">log_shipping_monitor_history_detail</span><span class="sxs-lookup"><span data-stu-id="ec5c5-132">log_shipping_monitor_history_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-history-detail-transact-sql)|<span data-ttu-id="ec5c5-133">存储日志传送代理的历史记录详细信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-133">Contains history details for log shipping agents.</span></span> <span data-ttu-id="ec5c5-134">可以查询此表来查看某个代理会话的历史记录详细信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-134">You can query this table to see the history detail for an agent session.</span></span>|  
|[<span data-ttu-id="ec5c5-135">log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="ec5c5-135">log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="ec5c5-136">在每个日志传送配置中对主数据库存储一条监视记录，包括有关对监视有用的最新备份文件和最新还原文件的信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-136">Stores one monitor record for the primary database in each log shipping configuration, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
|[<span data-ttu-id="ec5c5-137">log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="ec5c5-137">log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="ec5c5-138">对每个辅助数据库存储一条监视记录，包括有关对监视有用的最新备份文件和最新还原文件的信息。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-138">Stores one monitor record for each secondary database, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
  
## <a name="stored-procedures-for-monitoring-log-shipping"></a><span data-ttu-id="ec5c5-139">监视日志传送的存储过程</span><span class="sxs-lookup"><span data-stu-id="ec5c5-139">Stored Procedures for Monitoring Log Shipping</span></span>  
 <span data-ttu-id="ec5c5-140">监视和历史记录信息存储在 **msdb**的表中，可以通过日志传送存储过程来访问它。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-140">Monitoring and history information is stored in tables in **msdb**, which can be accessed using log shipping stored procedures.</span></span> <span data-ttu-id="ec5c5-141">请在下表中指定的服务器上运行下列存储过程。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-141">Run these stored procedures on the servers indicated in the following table.</span></span>  
  
|<span data-ttu-id="ec5c5-142">存储过程</span><span class="sxs-lookup"><span data-stu-id="ec5c5-142">Stored procedure</span></span>|<span data-ttu-id="ec5c5-143">说明</span><span class="sxs-lookup"><span data-stu-id="ec5c5-143">Description</span></span>|<span data-ttu-id="ec5c5-144">运行存储过程的服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-144">Run this procedure on</span></span>|  
|----------------------|-----------------|---------------------------|  
|[<span data-ttu-id="ec5c5-145">sp_help_log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="ec5c5-145">sp_help_log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="ec5c5-146">从 **log_shipping_monitor_primary** 表中返回指定的主数据库的监视记录。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-146">Returns monitor records for the specified primary database from the **log_shipping_monitor_primary** table.</span></span>|<span data-ttu-id="ec5c5-147">监视服务器或主服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-147">Monitor server or primary server</span></span>|  
|[<span data-ttu-id="ec5c5-148">sp_help_log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="ec5c5-148">sp_help_log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="ec5c5-149">从 **log_shipping_monitor_secondary** 表中返回指定的辅助数据库的监视记录。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-149">Returns monitor records for the specified secondary database from the **log_shipping_monitor_secondary** table.</span></span>|<span data-ttu-id="ec5c5-150">监视服务器或辅助服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-150">Monitor server or secondary server</span></span>|  
|[<span data-ttu-id="ec5c5-151">sp_help_log_shipping_alert_job</span><span class="sxs-lookup"><span data-stu-id="ec5c5-151">sp_help_log_shipping_alert_job</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-alert-job-transact-sql)|<span data-ttu-id="ec5c5-152">返回警报作业的作业 ID。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-152">Returns the job ID of the alert job.</span></span>|<span data-ttu-id="ec5c5-153">监视服务器或主/辅助服务器（如果未定义监视服务器）</span><span class="sxs-lookup"><span data-stu-id="ec5c5-153">Monitor server, or primary or secondary server if no monitor is defined</span></span>|  
|[<span data-ttu-id="ec5c5-154">sp_help_log_shipping_primary_database</span><span class="sxs-lookup"><span data-stu-id="ec5c5-154">sp_help_log_shipping_primary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-database-transact-sql)|<span data-ttu-id="ec5c5-155">检索主数据库设置并显示 **log_shipping_primary_databases** 和 **log_shipping_monitor_primary** 表中的值。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-155">Retrieves primary database settings and displays the values from the **log_shipping_primary_databases** and **log_shipping_monitor_primary** tables.</span></span>|<span data-ttu-id="ec5c5-156">主服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-156">Primary server</span></span>|  
|[<span data-ttu-id="ec5c5-157">sp_help_log_shipping_primary_secondary</span><span class="sxs-lookup"><span data-stu-id="ec5c5-157">sp_help_log_shipping_primary_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-secondary-transact-sql)|<span data-ttu-id="ec5c5-158">检索主数据库的辅助数据库名称。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-158">Retrieves secondary database names for a primary database.</span></span>|<span data-ttu-id="ec5c5-159">主服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-159">Primary server</span></span>|  
|[<span data-ttu-id="ec5c5-160">sp_help_log_shipping_secondary_database</span><span class="sxs-lookup"><span data-stu-id="ec5c5-160">sp_help_log_shipping_secondary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-database-transact-sql)|<span data-ttu-id="ec5c5-161">从 **log_shipping_secondary**、 **log_shipping_secondary_databases** 和 **log_shipping_monitor_secondary** 表中检索辅助数据库设置。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-161">Retrieves secondary-database settings from the **log_shipping_secondary**, **log_shipping_secondary_databases** and **log_shipping_monitor_secondary** tables.</span></span>|<span data-ttu-id="ec5c5-162">辅助服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-162">Secondary server</span></span>|  
|[<span data-ttu-id="ec5c5-163">sp_help_log_shipping_secondary_primary (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="ec5c5-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-primary-transact-sql)|<span data-ttu-id="ec5c5-164">此存储过程将在辅助服务器上检索给定的主数据库的设置。</span><span class="sxs-lookup"><span data-stu-id="ec5c5-164">This stored procedure retrieves the settings for a given primary database on the secondary server.</span></span>|<span data-ttu-id="ec5c5-165">辅助服务器</span><span class="sxs-lookup"><span data-stu-id="ec5c5-165">Secondary server</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="ec5c5-166">另请参阅</span><span class="sxs-lookup"><span data-stu-id="ec5c5-166">See Also</span></span>  
 <span data-ttu-id="ec5c5-167">[查看日志传送报告 (SQL Server Management Studio)](view-the-log-shipping-report-sql-server-management-studio.md) </span><span class="sxs-lookup"><span data-stu-id="ec5c5-167">[View the Log Shipping Report &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span></span>  
 [<span data-ttu-id="ec5c5-168">日志传送存储过程和表</span><span class="sxs-lookup"><span data-stu-id="ec5c5-168">Log Shipping Stored Procedures and Tables</span></span>](log-shipping-tables-and-stored-procedures.md)  
  
  

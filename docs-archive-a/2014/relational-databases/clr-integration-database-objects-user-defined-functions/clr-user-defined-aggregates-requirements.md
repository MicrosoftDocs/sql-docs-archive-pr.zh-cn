---
title: CLR 用户定义聚合的要求 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87587429"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="c2fa9-102">CLR 用户定义聚合的要求</span><span class="sxs-lookup"><span data-stu-id="c2fa9-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="c2fa9-103">只要公共语言运行时 (CLR) 程序集中的类型实现了所需的聚合约定，就可以将它作为用户定义聚合函数注册。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="c2fa9-104">此约定由 `SqlUserDefinedAggregate` 属性和聚合约定方法组成。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="c2fa9-105">聚合约定包括保存聚合中间状态的机制以及累计新值的机制，它由四个方法组成：`Init`、`Accumulate`、`Merge` 和 `Terminate`。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="c2fa9-106">满足这些要求后，你将能够在中充分利用用户定义的聚合 [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="c2fa9-107">本主题的以下章节提供有关如何创建和使用用户定义聚合的其他详细信息。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="c2fa9-108">有关示例，请参阅[调用 CLR 用户定义聚合函数](clr-user-defined-aggregate-invoking-functions.md)。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="c2fa9-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="c2fa9-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="c2fa9-110">有关详细信息，请参阅[SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626)。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="c2fa9-111">聚合方法</span><span class="sxs-lookup"><span data-stu-id="c2fa9-111">Aggregation Methods</span></span>  
 <span data-ttu-id="c2fa9-112">注册为用户定义聚合的类应支持以下实例方法。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="c2fa9-113">这些是查询处理器计算聚合所用的方法。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="c2fa9-114">方法</span><span class="sxs-lookup"><span data-stu-id="c2fa9-114">Method</span></span>|<span data-ttu-id="c2fa9-115">语法</span><span class="sxs-lookup"><span data-stu-id="c2fa9-115">Syntax</span></span>|<span data-ttu-id="c2fa9-116">说明</span><span class="sxs-lookup"><span data-stu-id="c2fa9-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="c2fa9-117">公共 void Init ( # A1;</span><span class="sxs-lookup"><span data-stu-id="c2fa9-117">public void Init();</span></span>|<span data-ttu-id="c2fa9-118">查询处理器使用此方法初始化聚合的计算。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="c2fa9-119">对于查询处理器正在聚合的每个组调用此方法一次。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="c2fa9-120">查询处理器可以选择重用聚合类的同一实例来计算多个组的聚合。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="c2fa9-121">`Init` 方法应在上一次使用此实例后根据需要执行清除，并允许重新启动新的聚合计算。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="c2fa9-122">公共 void 累积 ( 输入类型值 [，输入类型值，...]) ;</span><span class="sxs-lookup"><span data-stu-id="c2fa9-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="c2fa9-123">表示该函数的参数的一个或多个参数。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="c2fa9-124">*input_type*应是 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 等效于 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 语句中*input_sqltype*指定的本机数据类型的托管数据类型 `CREATE AGGREGATE` 。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="c2fa9-125">有关详细信息，请参阅[映射 CLR 参数数据](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md)。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="c2fa9-126">对于用户定义类型 (UDT)，input-type 与 UDT 类型相同。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="c2fa9-127">查询处理器使用此方法累计聚合值。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="c2fa9-128">对于正在聚合的组中的每个值调用此方法一次。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="c2fa9-129">查询处理器仅在为聚合类的指定实例调用 `Init` 方法之后才调用此方法。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="c2fa9-130">此方法的实现应更新实例的状态以反映正在传递的参数值的累计。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="c2fa9-131">公共 void Merge ( udagg_class 值) ;</span><span class="sxs-lookup"><span data-stu-id="c2fa9-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="c2fa9-132">此方法可以将此聚合的另一实例与当前实例合并。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="c2fa9-133">查询处理器使用此方法合并聚合的多个部分计算。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="c2fa9-134">public return_type 终止 ( # A1;</span><span class="sxs-lookup"><span data-stu-id="c2fa9-134">public return_type Terminate();</span></span>|<span data-ttu-id="c2fa9-135">此方法完成聚合计算并返回聚合的结果。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="c2fa9-136">*Return_type*应为托管 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据类型，该类型是语句中指定的*return_sqltype*的托管等效项 `CREATE AGGREGATE` 。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="c2fa9-137">*Return_type*也可以是用户定义的类型。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="c2fa9-138">表值参数</span><span class="sxs-lookup"><span data-stu-id="c2fa9-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="c2fa9-139">表值参数 (TVP) 即传递到某一过程或函数的用户定义表类型，它提供了一种将多行数据传递到服务器的高效方法。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="c2fa9-140">TVP 提供与参数数组类似的功能，但灵活性更高并且与 [!INCLUDE[tsql](../../includes/tsql-md.md)] 的集成更紧密。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="c2fa9-141">它们还提供提升性能的潜力。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="c2fa9-142">TVP 还有助于减少到服务器的往返次数。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="c2fa9-143">可以将数据作为 TVP 发送到服务器，而不是向服务器发送多个请求（例如，对于标量参数列表）。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="c2fa9-144">用户定义表类型不能作为表值参数传递到在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 进程中执行的托管存储过程或函数，也不能从这些存储过程或函数中返回。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="c2fa9-145">而且，TVP 不能在上下文连接的作用域内使用。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="c2fa9-146">但是，如果在非上下文连接中使用 TVP，则 TVP 可用于在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 进程中执行的托管存储过程或函数中的 SqlClient。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="c2fa9-147">该连接可以是对执行托管过程或函数的同一服务器的连接。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="c2fa9-148">有关 Tvp 的详细信息，请参阅[&#40;数据库引擎使用表值参数&#41;](../tables/use-table-valued-parameters-database-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="c2fa9-149">更改历史记录</span><span class="sxs-lookup"><span data-stu-id="c2fa9-149">Change History</span></span>  
  
|<span data-ttu-id="c2fa9-150">更新的内容</span><span class="sxs-lookup"><span data-stu-id="c2fa9-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="c2fa9-151">更新了 `Accumulate` 方法的说明；该方法现在接受多个参数。</span><span class="sxs-lookup"><span data-stu-id="c2fa9-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="c2fa9-152">另请参阅</span><span class="sxs-lookup"><span data-stu-id="c2fa9-152">See Also</span></span>  
 <span data-ttu-id="c2fa9-153">[CLR 用户定义类型](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="c2fa9-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="c2fa9-154">调用 CLR 用户定义聚合函数</span><span class="sxs-lookup"><span data-stu-id="c2fa9-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  

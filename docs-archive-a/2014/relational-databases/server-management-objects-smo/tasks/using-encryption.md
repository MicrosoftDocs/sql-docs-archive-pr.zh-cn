---
title: 使用加密 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: reference
helpviewer_keywords:
- database master key [SMO]
- cryptography [SMO]
- cryptography [SQL Server], SMO
- encryption keys [SMO]
- encryption [SQL Server], SMO
- encryption [SMO]
- certificates [SMO]
- service master key [SMO]
ms.assetid: 405e0ed7-50a9-430e-a343-471f54b4af76
author: stevestein
ms.author: sstein
ms.openlocfilehash: 1f1f7d6a8714deb1317562dce669fa0e7adbd45c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87590138"
---
# <a name="using-encryption"></a><span data-ttu-id="c300d-102">使用加密</span><span class="sxs-lookup"><span data-stu-id="c300d-102">Using Encryption</span></span>
  <span data-ttu-id="c300d-103">在 SMO 中，服务主密钥由 <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey> 对象表示。</span><span class="sxs-lookup"><span data-stu-id="c300d-103">In SMO, the service master key is represented by the <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey> object.</span></span> <span data-ttu-id="c300d-104">它是由 <xref:Microsoft.SqlServer.Management.Smo.Server.ServiceMasterKey%2A> 对象的 <xref:Microsoft.SqlServer.Management.Smo.Server> 属性引用的。</span><span class="sxs-lookup"><span data-stu-id="c300d-104">This is referenced by the <xref:Microsoft.SqlServer.Management.Smo.Server.ServiceMasterKey%2A> property of the <xref:Microsoft.SqlServer.Management.Smo.Server> object.</span></span> <span data-ttu-id="c300d-105">可以通过使用 <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey.Regenerate%2A> 方法重新生成服务主密钥。</span><span class="sxs-lookup"><span data-stu-id="c300d-105">It can be regenerated by using the <xref:Microsoft.SqlServer.Management.Smo.ServiceMasterKey.Regenerate%2A> method.</span></span>  
  
 <span data-ttu-id="c300d-106">数据库主密钥由 <xref:Microsoft.SqlServer.Management.Smo.MasterKey> 对象表示。</span><span class="sxs-lookup"><span data-stu-id="c300d-106">The database master key is represented by the <xref:Microsoft.SqlServer.Management.Smo.MasterKey> object.</span></span> <span data-ttu-id="c300d-107"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.IsEncryptedByServer%2A> 属性指示是否通过服务主密钥对数据库主密钥进行加密。</span><span class="sxs-lookup"><span data-stu-id="c300d-107">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.IsEncryptedByServer%2A> property indicates whether or not the database master key is encrypted by the service master key.</span></span> <span data-ttu-id="c300d-108">数据库主密钥发生变化时，主数据库中的加密副本会自动进行更新。</span><span class="sxs-lookup"><span data-stu-id="c300d-108">The encrypted copy in the master database is automatically updated whenever the database master key is changed.</span></span>  
  
 <span data-ttu-id="c300d-109">可以采用 <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> 方法删除服务密钥加密，并使用密码加密数据库主密钥。</span><span class="sxs-lookup"><span data-stu-id="c300d-109">It is possible to drop service key encryption using the <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> method and encrypt the database master key with a password.</span></span> <span data-ttu-id="c300d-110">在这种情况下，您必须显式打开数据库主密钥，然后才能访问已受到安全保护的私钥。</span><span class="sxs-lookup"><span data-stu-id="c300d-110">In that situation, you will have to explicitly open the database master key before accessing private keys that it has secured.</span></span>  
  
 <span data-ttu-id="c300d-111">如果数据库已附加到 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例，则必须为数据库主密钥提供密码或执行 <xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> 方法，才能生成一个未加密的数据库主密钥的副本，以便使用服务主密钥进行加密。</span><span class="sxs-lookup"><span data-stu-id="c300d-111">When a database is being attached to an instance of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], you must either supply the password for the database master key or execute the <xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> method to make an unencrypted copy of the database master key available for encryption with the service master key.</span></span> <span data-ttu-id="c300d-112">建议执行此步骤，从而无需显式打开数据库主密钥。</span><span class="sxs-lookup"><span data-stu-id="c300d-112">This step is recommended to avoid the need to explicitly open the database master key.</span></span>  
  
 <span data-ttu-id="c300d-113"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.Regenerate%2A> 方法将重新生成数据库主密钥。</span><span class="sxs-lookup"><span data-stu-id="c300d-113">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.Regenerate%2A> method regenerates the database master key.</span></span> <span data-ttu-id="c300d-114">当重新生成数据库主密钥时，会对所有使用该数据库主密钥加密的密钥进行解密，然后使用新的数据库主密钥对其进行加密。</span><span class="sxs-lookup"><span data-stu-id="c300d-114">When the database master key is regenerated, all the keys that have been encrypted with the database master key are decrypted, and then encrypts them with the new database master key.</span></span> <span data-ttu-id="c300d-115"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> 方法将通过服务主密钥删除对数据库主密钥的加密。</span><span class="sxs-lookup"><span data-stu-id="c300d-115">The <xref:Microsoft.SqlServer.Management.Smo.MasterKey.DropServiceKeyEncryption%2A> method removes the encryption of the database master key by the service master key.</span></span> <span data-ttu-id="c300d-116"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> 可以通过服务主密钥对主密钥的副本进行加密，然后将副本存储在当前数据库和主数据库中。</span><span class="sxs-lookup"><span data-stu-id="c300d-116"><xref:Microsoft.SqlServer.Management.Smo.MasterKey.AddServiceKeyEncryption%2A> causes a copy of the master key to be encrypted using the service master key and stored in both the current database and in the master database.</span></span>  
  
 <span data-ttu-id="c300d-117">在 SMO 中，证书由 <xref:Microsoft.SqlServer.Management.Smo.Certificate> 对象表示。</span><span class="sxs-lookup"><span data-stu-id="c300d-117">In SMO, certificates are represented by the <xref:Microsoft.SqlServer.Management.Smo.Certificate> object.</span></span> <span data-ttu-id="c300d-118"><xref:Microsoft.SqlServer.Management.Smo.Certificate> 对象具有指定公钥、主题名称、有效期以及有关颁发者的信息的属性。</span><span class="sxs-lookup"><span data-stu-id="c300d-118">The <xref:Microsoft.SqlServer.Management.Smo.Certificate> object has properties that specify the public key, the name of the subject, period of validity, and information about the issuer.</span></span> <span data-ttu-id="c300d-119">可采用 `Grant`、`Revoke` 和 `Deny` 方法控制对证书的访问权限。</span><span class="sxs-lookup"><span data-stu-id="c300d-119">Permission to access the certificate is controlled by using the `Grant`, `Revoke` and `Deny` methods.</span></span>  
  
## <a name="example"></a><span data-ttu-id="c300d-120">示例</span><span class="sxs-lookup"><span data-stu-id="c300d-120">Example</span></span>  
 <span data-ttu-id="c300d-121">对于下面的代码示例，您必须选择编程环境、编程模板和编程语言才能创建应用程序。</span><span class="sxs-lookup"><span data-stu-id="c300d-121">For the following code example, you will have to select the programming environment, programming template and the programming language to create your application.</span></span> <span data-ttu-id="c300d-122">有关详细信息，请参阅[在 Visual studio .net 中创建 VISUAL BASIC SMO 项目](../../../database-engine/dev-guide/create-a-visual-basic-smo-project-in-visual-studio-net.md)和[在 visual Studio .Net 中创建 VISUAL C&#35; smo 项目](../how-to-create-a-visual-csharp-smo-project-in-visual-studio-net.md)。</span><span class="sxs-lookup"><span data-stu-id="c300d-122">For more information, see [Create a Visual Basic SMO Project in Visual Studio .NET](../../../database-engine/dev-guide/create-a-visual-basic-smo-project-in-visual-studio-net.md) and [Create a Visual C&#35; SMO Project in Visual Studio .NET](../how-to-create-a-visual-csharp-smo-project-in-visual-studio-net.md).</span></span>  
  
## <a name="adding-a-certificate-in-visual-basic"></a><span data-ttu-id="c300d-123">在 Visual Basic 中添加证书</span><span class="sxs-lookup"><span data-stu-id="c300d-123">Adding a Certificate in Visual Basic</span></span>  
 <span data-ttu-id="c300d-124">该代码示例使用加密密码创建简单证书。</span><span class="sxs-lookup"><span data-stu-id="c300d-124">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="c300d-125">与其他对象不同，<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> 方法具有若干种重载。</span><span class="sxs-lookup"><span data-stu-id="c300d-125">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="c300d-126">该示例中所使用的重载将使用加密密码创建一个新证书。</span><span class="sxs-lookup"><span data-stu-id="c300d-126">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
<!-- TODO: review snippet reference  [!CODE [SMO How to#SMO_VBCertificate1](SMO How to#SMO_VBCertificate1)]  -->  
  
## <a name="adding-a-certificate-in-visual-c"></a><span data-ttu-id="c300d-127">在 Visual C# 中添加证书</span><span class="sxs-lookup"><span data-stu-id="c300d-127">Adding a Certificate in Visual C#</span></span>  
 <span data-ttu-id="c300d-128">该代码示例使用加密密码创建简单证书。</span><span class="sxs-lookup"><span data-stu-id="c300d-128">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="c300d-129">与其他对象不同，<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> 方法具有若干种重载。</span><span class="sxs-lookup"><span data-stu-id="c300d-129">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="c300d-130">该示例中所使用的重载将使用加密密码创建一个新证书。</span><span class="sxs-lookup"><span data-stu-id="c300d-130">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
```csharp
{  
            //Connect to the local, default instance of SQL Server.   
            {  
                Server srv = new Server();  
  
                //Reference the AdventureWorks2012 database.   
                Database db = srv.Databases["AdventureWorks2012"];  
  
                //Define a Certificate object variable by supplying the parent database and name in the constructor.   
                Certificate c = new Certificate(db, "Test_Certificate");  
  
                //Set the start date, expiry date, and description.   
                System.DateTime dt;  
                DateTime.TryParse("January 01, 2010", out dt);  
                c.StartDate = dt;  
                DateTime.TryParse("January 01, 2015", out dt);  
                c.ExpirationDate = dt;  
                c.Subject = "This is a test certificate.";  
                //Create the certificate on the instance of SQL Server by supplying the certificate password argument.   
                c.Create("pGFD4bb925DGvbd2439587y");  
            }  
        }   
```  
  
## <a name="adding-a-certificate-in-powershell"></a><span data-ttu-id="c300d-131">在 PowerShell 中添加证书</span><span class="sxs-lookup"><span data-stu-id="c300d-131">Adding a Certificate in PowerShell</span></span>  
 <span data-ttu-id="c300d-132">该代码示例使用加密密码创建简单证书。</span><span class="sxs-lookup"><span data-stu-id="c300d-132">The code example creates a simple certificate with an encryption password.</span></span> <span data-ttu-id="c300d-133">与其他对象不同，<xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> 方法具有若干种重载。</span><span class="sxs-lookup"><span data-stu-id="c300d-133">Unlike other objects, the <xref:Microsoft.SqlServer.Management.Smo.Certificate.Create%2A> method has several overloads.</span></span> <span data-ttu-id="c300d-134">该示例中所使用的重载将使用加密密码创建一个新证书。</span><span class="sxs-lookup"><span data-stu-id="c300d-134">The overload used in the example creates a new certificate with an encryption password.</span></span>  
  
```powershell
# Set the path context to the local, default instance of SQL Server and get a reference to AdventureWorks2012  
CD \sql\localhost\default\databases  
$db = get-item AdventureWorks2012  
  
#Create a certificate
$c = New-Object -TypeName Microsoft.SqlServer.Management.Smo.Certificate -ArgumentList $db, "Test_Certificate"  
$c.StartDate = "January 01, 2010"  
$c.Subject = "This is a test certificate."  
$c.ExpirationDate = "January 01, 2015"  
  
#Create the certificate on the instance of SQL Server by supplying the certificate password argument.  
$c.Create("pGFD4bb925DGvbd2439587y")
```  
  
## <a name="see-also"></a><span data-ttu-id="c300d-135">另请参阅</span><span class="sxs-lookup"><span data-stu-id="c300d-135">See Also</span></span>  
 [<span data-ttu-id="c300d-136">使用加密密钥</span><span class="sxs-lookup"><span data-stu-id="c300d-136">Using Encryption Keys</span></span>](using-encryption.md)  

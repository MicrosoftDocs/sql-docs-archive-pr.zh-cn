---
title: 使用测试服务器的注意事项 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- overhead [Database Engine Tuning Advisor]
- tuning overhead [SQL Server]
- reducing production server tuning load
- Database Engine Tuning Advisor [SQL Server], test servers
- xp_msver
- test servers [Database Engine Tuning Advisor]
- production servers [SQL Server]
- offload tuning overhead [SQL Server]
ms.assetid: 94e6c3e5-1f09-4616-9da2-4e44d066d494
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 3fe835c1e92b382e3e2fadd7e80d4b2984929cc5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87688843"
---
# <a name="considerations-for-using-test-servers"></a><span data-ttu-id="808e9-102">使用测试服务器的注意事项</span><span class="sxs-lookup"><span data-stu-id="808e9-102">Considerations for Using Test Servers</span></span>
  <span data-ttu-id="808e9-103">使用测试服务器优化生产服务器中的数据库是 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问的显著优势。</span><span class="sxs-lookup"><span data-stu-id="808e9-103">Using a test server to tune a database on a production server is an important benefit of [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor.</span></span> <span data-ttu-id="808e9-104">使用此功能，可以将优化开销转移到测试服务器，而无需将实际数据从生产服务器复制到测试服务器。</span><span class="sxs-lookup"><span data-stu-id="808e9-104">Using this feature, you can offload tuning overhead to a test server without copying the actual data over to the test server from the production server.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="808e9-105">[!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问图形用户界面 (GUI) 不支持测试服务器优化功能。</span><span class="sxs-lookup"><span data-stu-id="808e9-105">The test server tuning feature is not supported in the [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor graphical user interface (GUI).</span></span>  
  
 <span data-ttu-id="808e9-106">若要成功使用此功能，请查看下列部分中列出的注意事项。</span><span class="sxs-lookup"><span data-stu-id="808e9-106">To use this feature successfully, review the considerations listed in the following sections.</span></span>  
  
## <a name="setting-up-the-test-serverproduction-server-environment"></a><span data-ttu-id="808e9-107">设置测试服务器/生产服务器环境</span><span class="sxs-lookup"><span data-stu-id="808e9-107">Setting Up the Test Server/Production Server Environment</span></span>  
  
-   <span data-ttu-id="808e9-108">要使用测试服务器优化生产服务器上的数据库的用户必须同时存在于两个服务器上，否则此方案无效。</span><span class="sxs-lookup"><span data-stu-id="808e9-108">The user who wants to use a test server to tune a database on a production server must exist on both servers, or this scenario will not work.</span></span>  
  
-   <span data-ttu-id="808e9-109">必须启用扩展存储过程 **xp_msver**，才能使用测试服务器/生产服务器方案。</span><span class="sxs-lookup"><span data-stu-id="808e9-109">The extended stored procedure, **xp_msver**, must be enabled to use the test server/production server scenario.</span></span> [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-110">优化顾问使用此扩展存储过程来提取在优化测试服务器时要使用的处理器数和生产服务器的可用内存。</span><span class="sxs-lookup"><span data-stu-id="808e9-110">Tuning Advisor uses this extended stored procedure to fetch the number of processors and the available memory of the production server to use while tuning the test server.</span></span> <span data-ttu-id="808e9-111">如果未启用 **xp_msver** ，则 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问假定运行 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问的计算机具有硬件特征。</span><span class="sxs-lookup"><span data-stu-id="808e9-111">If **xp_msver** is not enabled, [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor assumes the hardware characteristics of the computer where [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor is running.</span></span> <span data-ttu-id="808e9-112">如果运行 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问的计算机没有硬件特征，则假定具有一个处理器和 1024 MB 的内存。</span><span class="sxs-lookup"><span data-stu-id="808e9-112">If the hardware characteristics of the computer where [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor is running are not available, one processor and 1024 megabytes (MBs) of memory are assumed.</span></span> <span data-ttu-id="808e9-113">在安装 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]时，该扩展存储过程默认是打开的。</span><span class="sxs-lookup"><span data-stu-id="808e9-113">This extended stored procedure is turned on by default when you install [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="808e9-114">有关详细信息，请参阅 [外围应用配置器](../security/surface-area-configuration.md) 和 [xp_msver (Transact-SQL)](/sql/relational-databases/system-stored-procedures/xp-msver-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="808e9-114">For more information, see [Surface Area Configuration](../security/surface-area-configuration.md) and [xp_msver &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/xp-msver-transact-sql).</span></span>  
  
-   [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-115">优化顾问需要测试服务器和生产服务器中的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 为同一版本。</span><span class="sxs-lookup"><span data-stu-id="808e9-115">Tuning Advisor expects the editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to be the same on both the test server and the production server.</span></span> <span data-ttu-id="808e9-116">如果有两个不同的版本，则优先使用测试服务器中的版本。</span><span class="sxs-lookup"><span data-stu-id="808e9-116">If there are two different editions, the edition on the test server takes precedence.</span></span> <span data-ttu-id="808e9-117">例如，如果测试服务器运行 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 标准版，则即使生产服务器运行 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 企业版， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 优化顾问也不会建议使用索引视图、分区和联机操作。</span><span class="sxs-lookup"><span data-stu-id="808e9-117">For example, if the test server is running [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Standard, [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor will not include indexed views, partitioning, and online operations in its recommendations even if the production server is running [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span></span>  
  
## <a name="about-test-serverproduction-server-behavior"></a><span data-ttu-id="808e9-118">关于测试服务器/生产服务器行为</span><span class="sxs-lookup"><span data-stu-id="808e9-118">About Test Server/Production Server Behavior</span></span>  
  
-   [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-119">优化顾问将考虑生产服务器与测试服务器之间的硬件差异。</span><span class="sxs-lookup"><span data-stu-id="808e9-119">Tuning Advisor takes into account hardware differences between the production and the test server when creating recommendations.</span></span> <span data-ttu-id="808e9-120">所得到的建议与在生产服务器上进行优化时相同。</span><span class="sxs-lookup"><span data-stu-id="808e9-120">The recommendation is the same as though the tuning was done on the production server alone.</span></span>  
  
-   [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-121">优化顾问可能会在生产服务器中施加一些负载，以收集元数据并创建优化所需的统计信息。</span><span class="sxs-lookup"><span data-stu-id="808e9-121">Tuning Advisor may impose some load on the production server for gathering metadata as well as creation of statistics necessary for tuning.</span></span>  
  
-   [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-122">优化顾问不会将实际数据从生产服务器复制到测试服务器中。</span><span class="sxs-lookup"><span data-stu-id="808e9-122">Tuning Advisor does not copy actual data from the production server to the test server.</span></span> <span data-ttu-id="808e9-123">仅复制数据库的元数据和必要的统计信息。</span><span class="sxs-lookup"><span data-stu-id="808e9-123">It only copies the metadata of the databases and the necessary statistics.</span></span>  
  
-   <span data-ttu-id="808e9-124">所有会话信息都存储在生产服务器上的 **msdb** 中。</span><span class="sxs-lookup"><span data-stu-id="808e9-124">All session information is stored in **msdb** on the production server.</span></span> <span data-ttu-id="808e9-125">这使用户可以利用任何可用的测试服务器进行优化，并且有关所有会话的信息都可以从一个地方（生产服务器）获得。</span><span class="sxs-lookup"><span data-stu-id="808e9-125">This allows you to exploit any available test server for tuning, and information about all sessions is available in one place (the production server).</span></span>  
  
## <a name="issues-related-to-the-shell-database"></a><span data-ttu-id="808e9-126">与 Shell 数据库有关的问题</span><span class="sxs-lookup"><span data-stu-id="808e9-126">Issues Related to the Shell Database</span></span>  
  
-   <span data-ttu-id="808e9-127">执行优化后， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问应删除优化期间在测试服务器中创建的所有元数据。</span><span class="sxs-lookup"><span data-stu-id="808e9-127">After tuning, [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor should remove any metadata that it created on the test server during the tuning process.</span></span> <span data-ttu-id="808e9-128">包括 shell 数据库。</span><span class="sxs-lookup"><span data-stu-id="808e9-128">This includes the shell database.</span></span> <span data-ttu-id="808e9-129">如果您要使用相同的生产服务器和测试服务器执行一系列优化会话，那么您可能希望保留此 shell 数据库以节省时间。</span><span class="sxs-lookup"><span data-stu-id="808e9-129">If you are performing a series of tuning sessions with the same production and test servers, you may want to retain this shell database to save time.</span></span> <span data-ttu-id="808e9-130">请在 XML 输入文件中指定 **TuningOptions** 父元素下的 **RetainShellDB** 子元素以及其他子元素。</span><span class="sxs-lookup"><span data-stu-id="808e9-130">In the XML input file, specify the **RetainShellDB** subelement with the other sub elements under the **TuningOptions** parent element.</span></span> <span data-ttu-id="808e9-131">使用这些选项将使 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问保留 Shell 数据库。</span><span class="sxs-lookup"><span data-stu-id="808e9-131">Using these options causes [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor to retain the shell database.</span></span> <span data-ttu-id="808e9-132">有关详细信息，请参阅[ XML 输入文件引用（数据库引擎优化顾问）](database-engine-tuning-advisor.md)。</span><span class="sxs-lookup"><span data-stu-id="808e9-132">For more information, see [XML Input File Reference &#40;Database Engine Tuning Advisor&#41;](database-engine-tuning-advisor.md).</span></span>  
  
-   <span data-ttu-id="808e9-133">在成功完成测试服务器/生产服务器的优化会话后，即使未指定 **RetainShellDB** 子元素，Shell 数据库也会保留在测试服务器中。</span><span class="sxs-lookup"><span data-stu-id="808e9-133">Shell databases may be left behind on the test server after a successful test server/production server tuning session even if you have not specified the **RetainShellDB** subelement.</span></span> <span data-ttu-id="808e9-134">这些无用的 Shell 数据库可能会妨碍后续的会话优化操作，因此，在执行其他测试服务器/生产服务器优化会话之前，应先删除这些 Shell 数据库。</span><span class="sxs-lookup"><span data-stu-id="808e9-134">These unwanted shell databases may interfere with subsequent tuning sessions and should be dropped before performing another test server/production server tuning session.</span></span> <span data-ttu-id="808e9-135">此外，如果优化会话意外结束，则测试服务器中的 Shell 数据库及其内部对象可能会保留在测试服务器中。</span><span class="sxs-lookup"><span data-stu-id="808e9-135">In addition, if a tuning session exits unexpectedly, the shell databases on the test server and the objects within those databases may be left behind on the test server.</span></span> <span data-ttu-id="808e9-136">在启动新的测试服务器/生产服务器优化会话之前，也应删除这些数据库和对象。</span><span class="sxs-lookup"><span data-stu-id="808e9-136">You should also delete these databases and objects before starting a new test server/production server tuning session.</span></span>  
  
## <a name="issues-related-to-the-tuning-process"></a><span data-ttu-id="808e9-137">与优化过程有关的问题</span><span class="sxs-lookup"><span data-stu-id="808e9-137">Issues Related to the Tuning Process</span></span>  
  
-   <span data-ttu-id="808e9-138">用户必须在优化日志中检查由生产服务器和测试服务器之间的差异导致的优化错误，以及由于将元数据从生产服务器复制到测试服务器而导致的错误。</span><span class="sxs-lookup"><span data-stu-id="808e9-138">The user must check the tuning log for tuning errors that result from differences between the production and test servers, and for errors that result from copying metadata from the production to the test server.</span></span> <span data-ttu-id="808e9-139">例如，用户登录名可能在测试服务器上不存在。</span><span class="sxs-lookup"><span data-stu-id="808e9-139">For example, a user login may not exist on the test server.</span></span> <span data-ttu-id="808e9-140">如果用户登录名在测试服务器上不存在，则可能无法优化工作负荷中由该用户登录名执行的那些事件。</span><span class="sxs-lookup"><span data-stu-id="808e9-140">If a user login does not exist on the test server, those events in the workload that are issued by that user login may not be tunable.</span></span> <span data-ttu-id="808e9-141">使用 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问 GUI 可以查看优化日志。</span><span class="sxs-lookup"><span data-stu-id="808e9-141">Use the [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor GUI to view the tuning log.</span></span> <span data-ttu-id="808e9-142">有关详细信息，请参阅 [查看和使用数据库引擎优化顾问的输出](view-and-work-with-the-output-from-the-database-engine-tuning-advisor.md)</span><span class="sxs-lookup"><span data-stu-id="808e9-142">For more information, see [View and Work with the Output from the Database Engine Tuning Advisor](view-and-work-with-the-output-from-the-database-engine-tuning-advisor.md)</span></span>  
  
-   <span data-ttu-id="808e9-143">如果因 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问在测试服务器中创建的 Shell 数据库中的对象丢失而导致 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问无法优化多个事件，则用户必须检查优化日志。</span><span class="sxs-lookup"><span data-stu-id="808e9-143">If [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor cannot tune many events because objects are missing in the shell database that [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor creates on the test server, the user must check the tuning log.</span></span> <span data-ttu-id="808e9-144">无法优化的事件列在日志中。</span><span class="sxs-lookup"><span data-stu-id="808e9-144">Events that cannot be tuned are listed in the log.</span></span> <span data-ttu-id="808e9-145">若要成功优化测试服务器上的数据库，用户必须创建 shell 数据库中所缺少的对象，然后启动新的优化会话。</span><span class="sxs-lookup"><span data-stu-id="808e9-145">To successfully tune the database on the test server, the user must create the missing objects in the shell database, and then start a new tuning session.</span></span>  
  
-   <span data-ttu-id="808e9-146">如果测试服务器中已存在同名数据库，则 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问不会复制元数据，但会根据需要继续执行优化并收集统计信息。</span><span class="sxs-lookup"><span data-stu-id="808e9-146">If a database with the same name already exists on the test server, [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor does not copy metadata, but continues tuning and gathers statistics as necessary.</span></span> <span data-ttu-id="808e9-147">如果在调用 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问之前，用户已在测试服务器中创建了一个数据库并复制了适当的元数据，则此功能将十分有用。</span><span class="sxs-lookup"><span data-stu-id="808e9-147">This is useful if the user has already created a database on the test server and has copied the appropriate metadata before invoking [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor.</span></span>  
  
-   <span data-ttu-id="808e9-148">如果为生产服务器上的数据库启用了 DATE_CORRELATION_OPTIMIZATION 选项，则在优化测试服务器时，元数据和与此选项关联的数据不会完全编入脚本。</span><span class="sxs-lookup"><span data-stu-id="808e9-148">If the DATE_CORRELATION_OPTIMIZATION option is turned on for a database on the production server, metadata and the data associated with this option are not completely scripted while tuning the test server.</span></span> <span data-ttu-id="808e9-149">采用测试服务器/生产服务器方案进行优化时，可能会出现下列问题：</span><span class="sxs-lookup"><span data-stu-id="808e9-149">When tuning is performed for a test server/production server scenario, the following issues may apply:</span></span>  
  
    -   <span data-ttu-id="808e9-150">对于服务器上使用 DATE_CORRELATION_OPTIMIZATION 选项的各个查询，用户可以执行不同的查询计划。</span><span class="sxs-lookup"><span data-stu-id="808e9-150">Users can have different query plans on the servers for queries that use the DATE_CORRELATION_OPTIMIZATION option.</span></span>  
  
    -   [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-151">优化顾问可能会建议删除执行建议脚本中 DATE_CORRELATION_OPTIMIZATION 选项的索引视图。</span><span class="sxs-lookup"><span data-stu-id="808e9-151">Tuning Advisor may suggest dropping indexed views that enforce the DATE_CORRELATION_OPTIMIZATION option in the recommendation script.</span></span>  
  
     <span data-ttu-id="808e9-152">因此，您可能希望忽略 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问针对保留相关统计信息的索引视图所提出的任何建议，因为 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 优化顾问只了解其开销，而不了解其优势。</span><span class="sxs-lookup"><span data-stu-id="808e9-152">Therefore, you may want to ignore any recommendations that [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor makes about the indexed views that hold correlation statistics because [!INCLUDE[ssDE](../../includes/ssde-md.md)] Tuning Advisor knows their costs but not their benefits.</span></span> [!INCLUDE[ssDE](../../includes/ssde-md.md)] <span data-ttu-id="808e9-153">优化顾问可能不建议你选择某些索引（例如 **datetime** 列的聚集索引），而这些索引在启用 DATE_CORRELATION_OPTIMIZATION 时可能会非常有用。</span><span class="sxs-lookup"><span data-stu-id="808e9-153">Tuning Advisor may not recommend selection of certain indexes such as clustered indexes on **datetime** columns, which could be beneficial when DATE_CORRELATION_OPTIMIZATION is enabled.</span></span>  
  
     <span data-ttu-id="808e9-154">若要确定视图是否基于关联统计信息，请选择 **sys.views** 目录视图的 [is_date_correlation_view](/sql/relational-databases/system-catalog-views/sys-views-transact-sql) 列。</span><span class="sxs-lookup"><span data-stu-id="808e9-154">To determine if a view is based on correlation statistics, select the **is_date_correlation_view** column of the [sys.views](/sql/relational-databases/system-catalog-views/sys-views-transact-sql) catalog view.</span></span>  
  
  

---
title: 使用预计算分区优化参数化筛选器性能 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- precomputed partitions [SQL Server replication]
- merge replication precomputed partitions [SQL Server replication]
- merge replication precomputed partitions [SQL Server replication], about precomputed partitions
ms.assetid: 85654bf4-e25f-4f04-8e34-bbbd738d60fa
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 4ad0a33f0a5951256ff94bc78e7f09a88c05f227
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87693257"
---
# <a name="optimize-parameterized-filter-performance-with-precomputed-partitions"></a><span data-ttu-id="c2b98-102">使用预计算分区优化参数化筛选器的性能</span><span class="sxs-lookup"><span data-stu-id="c2b98-102">Optimize Parameterized Filter Performance with Precomputed Partitions</span></span>
  <span data-ttu-id="c2b98-103">预计算分区是一种性能优化方法，可用于已筛选的合并发布。</span><span class="sxs-lookup"><span data-stu-id="c2b98-103">Precomputed partitions is a performance optimization that can be used with filtered merge publications.</span></span> <span data-ttu-id="c2b98-104">预计算分区也是在已筛选的发布上使用逻辑记录的一项要求。</span><span class="sxs-lookup"><span data-stu-id="c2b98-104">Precomputed partitions is also a requirement for using logical records on filtered publications.</span></span> <span data-ttu-id="c2b98-105">有关逻辑记录的详细信息，请参阅[通过逻辑记录对相关行的更改进行分组](group-changes-to-related-rows-with-logical-records.md)。</span><span class="sxs-lookup"><span data-stu-id="c2b98-105">For more information about logical records, see [Group Changes to Related Rows with Logical Records](group-changes-to-related-rows-with-logical-records.md).</span></span>  
  
 <span data-ttu-id="c2b98-106">订阅服务器与发布服务器同步时，发布服务器必须计算订阅服务器的筛选器，以确定哪些行属于该订阅服务器的分区或数据集。</span><span class="sxs-lookup"><span data-stu-id="c2b98-106">When a Subscriber synchronizes with a Publisher, the Publisher must evaluate the Subscriber's filters to determine which rows belong to that Subscriber's partition, or data set.</span></span> <span data-ttu-id="c2b98-107">我们将为接收已筛选数据集的每个订阅服务器确定发布服务器上的更改的分区成员身份这一过程称为“分区计算” \*\*。</span><span class="sxs-lookup"><span data-stu-id="c2b98-107">This process of determining partition membership of changes at the Publisher for each Subscriber receiving a filtered dataset is referred to as *partition evaluation*.</span></span> <span data-ttu-id="c2b98-108">如果没有预计算分区，那么，自上次为特定订阅服务器运行合并代理之后，对发布服务器上已筛选列每进行一次更改都必须执行分区计算，而且对与该发布服务器同步的每个订阅服务器都要重复这一过程。</span><span class="sxs-lookup"><span data-stu-id="c2b98-108">Without precomputed partitions, partition evaluation must be performed for each change made to a filtered column at the Publisher since the last time the Merge Agent ran for a specific Subscriber, and this process has to be repeated for every Subscriber that synchronizes with the Publisher.</span></span>  
  
 <span data-ttu-id="c2b98-109">但是，如果发布服务器和订阅服务器在 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 或更高版本上运行，并且您使用的是预计算分区，则在发布服务器上进行的所有更改的分区成员身份在进行更改时将预计算并持久保存。</span><span class="sxs-lookup"><span data-stu-id="c2b98-109">However, if the Publisher and Subscriber are running on [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version and you use precomputed partitions, partition membership for all changes at the Publisher is precomputed and persisted at the time that the changes are made.</span></span> <span data-ttu-id="c2b98-110">因此，当订阅服务器与发布服务器同步时，它可以立即开始下载与其分区相关的更改，而不必执行分区计算过程。</span><span class="sxs-lookup"><span data-stu-id="c2b98-110">As a result, when a Subscriber synchronizes with the Publisher, it can immediately start to download changes relevant to its partition without having to go through the partition evaluation process.</span></span> <span data-ttu-id="c2b98-111">当发布中有大量更改、订阅服务器或项目时，这样可以显著提高性能。</span><span class="sxs-lookup"><span data-stu-id="c2b98-111">This can lead to significant performance gains when a publication has a large number of changes, Subscribers, or articles in the publication.</span></span>  
  
 <span data-ttu-id="c2b98-112">除了使用预计算分区外，预先生成快照和/或允许订阅服务器在第一次同步时还请求生成快照和应用快照。</span><span class="sxs-lookup"><span data-stu-id="c2b98-112">In addition to using precomputed partitions, pre-generate snapshots and/or allow Subscribers to request snapshot generation and application the first time they synchronize.</span></span> <span data-ttu-id="c2b98-113">使用以上选项中的一个或两个可以为使用参数化筛选器的发布提供快照。</span><span class="sxs-lookup"><span data-stu-id="c2b98-113">Use one or both of these options to provide snapshots for publications that use parameterized filters.</span></span> <span data-ttu-id="c2b98-114">如果未指定任一选项，将使用一系列的 SELECT 和 INSERT 语句初始化订阅，而不是使用 **bcp** 实用工具；此过程的速度将更慢。</span><span class="sxs-lookup"><span data-stu-id="c2b98-114">If you do not specify one of these options, subscriptions are initialized using a series of SELECT and INSERT statements, rather than using the **bcp** utility; this process is much slower.</span></span> <span data-ttu-id="c2b98-115">有关详细信息，请参阅 [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md)。</span><span class="sxs-lookup"><span data-stu-id="c2b98-115">For more information, see [Snapshots for Merge Publications with Parameterized Filters](../snapshots-for-merge-publications-with-parameterized-filters.md).</span></span>  
  
 <span data-ttu-id="c2b98-116">**使用预计算分区**</span><span class="sxs-lookup"><span data-stu-id="c2b98-116">**To use precomputed partitions**</span></span>  
  
 <span data-ttu-id="c2b98-117">默认情况下，在遵循上述指导原则的所有新发布和现有发布上均启用了预计算分区。</span><span class="sxs-lookup"><span data-stu-id="c2b98-117">Precomputed partitions are enabled by default on all new and existing publications that adhere to the guidelines described above.</span></span> <span data-ttu-id="c2b98-118">可通过 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] 或通过编程方式更改此设置。</span><span class="sxs-lookup"><span data-stu-id="c2b98-118">The setting can be changed through [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] or programmatically.</span></span> <span data-ttu-id="c2b98-119">有关详细信息，请参阅 [Optimize Parameterized Row Filters](../publish/optimize-parameterized-row-filters.md)。</span><span class="sxs-lookup"><span data-stu-id="c2b98-119">For more information, see [Optimize Parameterized Row Filters](../publish/optimize-parameterized-row-filters.md).</span></span>  
  
## <a name="requirements-for-using-precomputed-partitions"></a><span data-ttu-id="c2b98-120">使用预计算分区的要求</span><span class="sxs-lookup"><span data-stu-id="c2b98-120">Requirements for Using Precomputed Partitions</span></span>  
 <span data-ttu-id="c2b98-121">如果满足下列要求，默认情况下创建新的合并复制时将启用预计算分区，而现有的发布将自动升级以使用此功能。</span><span class="sxs-lookup"><span data-stu-id="c2b98-121">If the following requirements are met, new merge publications are, by default, created with precomputed partitions enabled, and existing publications are automatically upgraded to use the feature.</span></span> <span data-ttu-id="c2b98-122">如果发布不满足下列要求，可对其先进行更改，然后即可启用预计算分区。</span><span class="sxs-lookup"><span data-stu-id="c2b98-122">If a publication does not meet the requirements, it can be changed, and then precomputed partitions can be enabled.</span></span> <span data-ttu-id="c2b98-123">如果有些项目满足这些要求而有些不满足，请考虑创建两个发布，为其中一个发布启用预计算分区。</span><span class="sxs-lookup"><span data-stu-id="c2b98-123">If some articles meet these requirements and some do not, consider creating two publications, with one enabled for precomputed partitions.</span></span>  
  
### <a name="requirements-for-filter-clauses"></a><span data-ttu-id="c2b98-124">筛选器子句的要求</span><span class="sxs-lookup"><span data-stu-id="c2b98-124">Requirements for Filter Clauses</span></span>  
  
-   <span data-ttu-id="c2b98-125">参数化行筛选器中使用的任何函数（如 HOST_NAME() 和 SUSER_SNAME()），都应直接出现在参数化筛选器子句中，而不能嵌套在视图或动态函数内。</span><span class="sxs-lookup"><span data-stu-id="c2b98-125">Any functions used in parameterized row filters, such as HOST_NAME() and SUSER_SNAME(), should appear directly in the parameterized filter clause and not be nested inside of a view or dynamic function.</span></span> <span data-ttu-id="c2b98-126">有关这些函数的详细信息，请参阅 [HOST_NAME (Transact-SQL)](/sql/t-sql/functions/host-name-transact-sql)、[SUSER_SNAME (Transact-SQL)](/sql/t-sql/functions/suser-sname-transact-sql) 和[参数化行筛选器](parameterized-filters-parameterized-row-filters.md)。</span><span class="sxs-lookup"><span data-stu-id="c2b98-126">For more information about these functions, see [HOST_NAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/host-name-transact-sql), [SUSER_SNAME &#40;Transact-SQL&#41;](/sql/t-sql/functions/suser-sname-transact-sql), and [Parameterized Row Filters](parameterized-filters-parameterized-row-filters.md).</span></span>  
  
-   <span data-ttu-id="c2b98-127">创建分区后，不应更改为每个订阅服务器返回的值。</span><span class="sxs-lookup"><span data-stu-id="c2b98-127">The values returned for each Subscriber should not change after the partition is created.</span></span> <span data-ttu-id="c2b98-128">例如，如果在筛选器中使用 HOST_NAME()（且不覆盖 HOST_NAME() 值），请不要更改订阅服务器上的计算机名称。</span><span class="sxs-lookup"><span data-stu-id="c2b98-128">For example, if you use HOST_NAME() in a filter (and do not override the HOST_NAME() value) do not change the computer name at the Subscriber.</span></span>  
  
-   <span data-ttu-id="c2b98-129">联接筛选器不应包含动态函数（如 HOST_NAME() 和 SUSER_SNAME()，此类函数会根据正在同步的订阅服务器计算出不同的值）。</span><span class="sxs-lookup"><span data-stu-id="c2b98-129">Join filters should not contain dynamic functions (functions such as HOST_NAME() and SUSER_SNAME() that evaluate to a different value depending upon the Subscriber that is synchronizing).</span></span> <span data-ttu-id="c2b98-130">只有参数化行筛选器可以包含动态函数。</span><span class="sxs-lookup"><span data-stu-id="c2b98-130">Only parameterized row filters should contain dynamic functions.</span></span>  
  
-   <span data-ttu-id="c2b98-131">筛选器子句中不能使用不确定性函数。</span><span class="sxs-lookup"><span data-stu-id="c2b98-131">Nondeterministic functions cannot be used in a filter clause.</span></span> <span data-ttu-id="c2b98-132">有关不确定性函数的详细信息，请参阅 [Deterministic and Nondeterministic Functions](../../user-defined-functions/deterministic-and-nondeterministic-functions.md)。</span><span class="sxs-lookup"><span data-stu-id="c2b98-132">For more information about nondeterministic functions, see [Deterministic and Nondeterministic Functions](../../user-defined-functions/deterministic-and-nondeterministic-functions.md).</span></span>  
  
-   <span data-ttu-id="c2b98-133">在联接筛选器子句或参数化筛选器子句中引用的视图不应包含动态函数。</span><span class="sxs-lookup"><span data-stu-id="c2b98-133">Views referenced in join filter clauses or parameterized filter clauses should not contain dynamic functions.</span></span>  
  
-   <span data-ttu-id="c2b98-134">发布中不应有循环联接筛选器关系。</span><span class="sxs-lookup"><span data-stu-id="c2b98-134">There should be no circular join filter relationships in the publication.</span></span>  
  
### <a name="database-collation"></a><span data-ttu-id="c2b98-135">数据库排序规则</span><span class="sxs-lookup"><span data-stu-id="c2b98-135">Database Collation</span></span>  
  
-   <span data-ttu-id="c2b98-136">如果使用了预计算分区，进行比较时始终使用数据库的排序规则，而不使用表或列的排序规则。</span><span class="sxs-lookup"><span data-stu-id="c2b98-136">When precomputed partitions are used, the collation of the database is always used when making comparisons, rather than the collation of the table or column.</span></span> <span data-ttu-id="c2b98-137">请参考以下方案：</span><span class="sxs-lookup"><span data-stu-id="c2b98-137">Consider the following scenario:</span></span>  
  
    -   <span data-ttu-id="c2b98-138">具有区分大小写排序规则的数据库包含一个具有不区分大小写排序规则的表。</span><span class="sxs-lookup"><span data-stu-id="c2b98-138">A database with a case-sensitive collation contains a table with a case-insensitive collation.</span></span>  
  
    -   <span data-ttu-id="c2b98-139">该表包含一个 **ComputerName**列，它与参数化筛选器中的订阅服务器的主机名相比较。</span><span class="sxs-lookup"><span data-stu-id="c2b98-139">The table contains a column **ComputerName**, which is compared against the host name of the Subscriber in a parameterized filter.</span></span>  
  
    -   <span data-ttu-id="c2b98-140">该表在此列中包含一个值为“MYCOMPUTER”的行和一个值为“mycomputer”的行。</span><span class="sxs-lookup"><span data-stu-id="c2b98-140">The table contains one row with the value "MYCOMPUTER" and one row with the value "mycomputer" in this column.</span></span>  
  
     <span data-ttu-id="c2b98-141">如果订阅服务器与主机名“mycomputer”同步，则订阅服务器只能收到一行，因为比较是区分大小写的（数据库的排序规则）。</span><span class="sxs-lookup"><span data-stu-id="c2b98-141">If the Subscriber synchronizes with a host name of "mycomputer", the Subscriber receives only one row because the comparison is case-sensitive (the collation of the database).</span></span> <span data-ttu-id="c2b98-142">如果未使用预计算分区，订阅服务器会收到这两行，因为该表具有不区分大小写的排序规则。</span><span class="sxs-lookup"><span data-stu-id="c2b98-142">If precomputed partitions are not used, the Subscriber receives both rows, because the table has a case-insensitive collation.</span></span>  
  
## <a name="performance-of-precomputed-partitions"></a><span data-ttu-id="c2b98-143">预计算分区的性能</span><span class="sxs-lookup"><span data-stu-id="c2b98-143">Performance of Precomputed Partitions</span></span>  
 <span data-ttu-id="c2b98-144">在将更改从订阅服务器上载到发布服务器时，尽管使用预计算分区会产生少量的性能开销，但大部分合并处理时间用于计算分区以及将更改从发布服务器下载到订阅服务器上，所以净的性能收益仍然很显著。</span><span class="sxs-lookup"><span data-stu-id="c2b98-144">There is a small performance cost with precomputed partitions when changes are uploaded from the Subscriber to the Publisher, but the bulk of merge processing time is spent evaluating partitions and downloading changes from the Publisher to the Subscriber, so the net gain can still be significant.</span></span> <span data-ttu-id="c2b98-145">根据并发同步的订阅服务器的数目以及将行从一个分区移动到另一分区的每个同步的更新数目的不同，性能收益也会有所不同。</span><span class="sxs-lookup"><span data-stu-id="c2b98-145">The performance benefit will vary, depending on the number of Subscribers synchronizing concurrently and the number of updates per synchronization that move rows from one partition to another.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c2b98-146">另请参阅</span><span class="sxs-lookup"><span data-stu-id="c2b98-146">See Also</span></span>  
 [<span data-ttu-id="c2b98-147">参数化行筛选器</span><span class="sxs-lookup"><span data-stu-id="c2b98-147">Parameterized Row Filters</span></span>](parameterized-filters-parameterized-row-filters.md)  
  
  

---
title: 对复制代理事件使用警报 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- viewing alerts
- Queue Reader Agent, alerts
- alerts [SQL Server replication]
- predefined replication alerts [SQL Server replication]
- Log Reader Agent, alerts
- Distribution Agent, alerts
- Merge Agent, alerts
- agents [SQL Server replication], alerts
- displaying alerts
- Snapshot Agent, alerts
ms.assetid: 8c42e523-7020-471d-8977-a0bd044b9471
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 9d3e30c0a8768a872dc86745ef986faec509c3c6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578140"
---
# <a name="use-alerts-for-replication-agent-events"></a><span data-ttu-id="3aa88-102">对复制代理事件使用警报</span><span class="sxs-lookup"><span data-stu-id="3aa88-102">Use Alerts for Replication Agent Events</span></span>
  [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] <span data-ttu-id="3aa88-103">和 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 代理提供了使用警报监视事件（如复制代理事件）的方法。</span><span class="sxs-lookup"><span data-stu-id="3aa88-103">and [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Agent provide a way to monitor events, such as replication agent events, using alerts.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="3aa88-104">代理监视与警报相关联的事件的 Windows 应用程序日志。</span><span class="sxs-lookup"><span data-stu-id="3aa88-104">Agent monitors the Windows application log for events that are associated with alerts.</span></span> <span data-ttu-id="3aa88-105">如果发生此类事件， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 代理将通过执行已定义的任务和/或向指定操作员发送电子邮件或寻呼消息的方式自动进行响应。</span><span class="sxs-lookup"><span data-stu-id="3aa88-105">If such an event occurs, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Agent responds automatically, by executing a task that you have defined and/or sending e-mail or a pager message to a specified operator.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="3aa88-106">包括一组预定义的复制代理警报，您可以配置这些警报以执行某项任务和/或通知某个操作员。</span><span class="sxs-lookup"><span data-stu-id="3aa88-106">includes a set of predefined alerts for replication agents that you can configure to execute a task and/or notify an operator.</span></span> <span data-ttu-id="3aa88-107">有关如何定义要执行的任务的详细信息，请参阅本主题中的“自动响应警报”部分。</span><span class="sxs-lookup"><span data-stu-id="3aa88-107">For more information about defining a task to execute, see the section "Automating a Response to an Alert" in this topic.</span></span>  
  
 <span data-ttu-id="3aa88-108">将计算机配置为分发服务器时，会安装下列警报：</span><span class="sxs-lookup"><span data-stu-id="3aa88-108">The following alerts are installed when a computer is configured as a Distributor:</span></span>  
  
|<span data-ttu-id="3aa88-109">消息 ID</span><span class="sxs-lookup"><span data-stu-id="3aa88-109">Message ID</span></span>|<span data-ttu-id="3aa88-110">预定义的警报</span><span class="sxs-lookup"><span data-stu-id="3aa88-110">Predefined alert</span></span>|<span data-ttu-id="3aa88-111">激发警报的条件</span><span class="sxs-lookup"><span data-stu-id="3aa88-111">Condition causing the alert to fire</span></span>|<span data-ttu-id="3aa88-112">在 msdb..sysreplicationalerts 中输入其他信息</span><span class="sxs-lookup"><span data-stu-id="3aa88-112">Enters additional information in msdb..sysreplicationalerts</span></span>|  
|----------------|----------------------|-----------------------------------------|-----------------------------------------------------------------|  
|<span data-ttu-id="3aa88-113">14150</span><span class="sxs-lookup"><span data-stu-id="3aa88-113">14150</span></span>|<span data-ttu-id="3aa88-114">**复制: 代理成功**</span><span class="sxs-lookup"><span data-stu-id="3aa88-114">**Replication: agent success**</span></span>|<span data-ttu-id="3aa88-115">代理成功关闭。</span><span class="sxs-lookup"><span data-stu-id="3aa88-115">Agent shuts down successfully.</span></span>|<span data-ttu-id="3aa88-116">是</span><span class="sxs-lookup"><span data-stu-id="3aa88-116">Yes</span></span>|  
|<span data-ttu-id="3aa88-117">14151</span><span class="sxs-lookup"><span data-stu-id="3aa88-117">14151</span></span>|<span data-ttu-id="3aa88-118">**复制: 代理失败**</span><span class="sxs-lookup"><span data-stu-id="3aa88-118">**Replication: agent failure**</span></span>|<span data-ttu-id="3aa88-119">代理关闭时出现错误。</span><span class="sxs-lookup"><span data-stu-id="3aa88-119">Agent shuts down with an error.</span></span>|<span data-ttu-id="3aa88-120">是</span><span class="sxs-lookup"><span data-stu-id="3aa88-120">Yes</span></span>|  
|<span data-ttu-id="3aa88-121">14152</span><span class="sxs-lookup"><span data-stu-id="3aa88-121">14152</span></span>|<span data-ttu-id="3aa88-122">**复制：代理重试**</span><span class="sxs-lookup"><span data-stu-id="3aa88-122">**Replication: agent retry**</span></span>|<span data-ttu-id="3aa88-123">代理在重试某项操作失败后关闭（代理遇到服务器不可用、死锁、连接失败或超时故障之类的错误）。</span><span class="sxs-lookup"><span data-stu-id="3aa88-123">Agent shuts down after unsuccessfully retrying an operation (agent encounters an error such as server not available, deadlock, connection failure, or time-out failure).</span></span>|<span data-ttu-id="3aa88-124">是</span><span class="sxs-lookup"><span data-stu-id="3aa88-124">Yes</span></span>|  
|<span data-ttu-id="3aa88-125">14157</span><span class="sxs-lookup"><span data-stu-id="3aa88-125">14157</span></span>|<span data-ttu-id="3aa88-126">**复制：已删除过期的订阅**</span><span class="sxs-lookup"><span data-stu-id="3aa88-126">**Replication: expired subscription dropped**</span></span>|<span data-ttu-id="3aa88-127">已删除过期的订阅。</span><span class="sxs-lookup"><span data-stu-id="3aa88-127">Expired subscription was dropped.</span></span>|<span data-ttu-id="3aa88-128">否</span><span class="sxs-lookup"><span data-stu-id="3aa88-128">No</span></span>|  
|<span data-ttu-id="3aa88-129">20572</span><span class="sxs-lookup"><span data-stu-id="3aa88-129">20572</span></span>|<span data-ttu-id="3aa88-130">**复制：验证失败后重新初始化了订阅**</span><span class="sxs-lookup"><span data-stu-id="3aa88-130">**Replication: Subscription reinitialized after validation failure**</span></span>|<span data-ttu-id="3aa88-131">响应作业“数据验证失败时重新初始化订阅”成功重新初始化订阅。</span><span class="sxs-lookup"><span data-stu-id="3aa88-131">Response job 'Reinitialize subscriptions on data validation failure' reinitializes a subscription successfully.</span></span>|<span data-ttu-id="3aa88-132">否</span><span class="sxs-lookup"><span data-stu-id="3aa88-132">No</span></span>|  
|<span data-ttu-id="3aa88-133">20574</span><span class="sxs-lookup"><span data-stu-id="3aa88-133">20574</span></span>|<span data-ttu-id="3aa88-134">**复制：订阅服务器未通过数据验证**</span><span class="sxs-lookup"><span data-stu-id="3aa88-134">**Replication: Subscriber has failed data validation**</span></span>|<span data-ttu-id="3aa88-135">分发代理或合并代理未通过数据验证。</span><span class="sxs-lookup"><span data-stu-id="3aa88-135">Distribution or Merge Agent fails data validation.</span></span>|<span data-ttu-id="3aa88-136">是</span><span class="sxs-lookup"><span data-stu-id="3aa88-136">Yes</span></span>|  
|<span data-ttu-id="3aa88-137">20575</span><span class="sxs-lookup"><span data-stu-id="3aa88-137">20575</span></span>|<span data-ttu-id="3aa88-138">**复制：订阅服务器已通过数据验证**</span><span class="sxs-lookup"><span data-stu-id="3aa88-138">**Replication: Subscriber has passed data validation**</span></span>|<span data-ttu-id="3aa88-139">分发代理或合并代理通过数据验证。</span><span class="sxs-lookup"><span data-stu-id="3aa88-139">Distribution or Merge Agent passes data validation.</span></span>|<span data-ttu-id="3aa88-140">是</span><span class="sxs-lookup"><span data-stu-id="3aa88-140">Yes</span></span>|  
|<span data-ttu-id="3aa88-141">20578</span><span class="sxs-lookup"><span data-stu-id="3aa88-141">20578</span></span>|<span data-ttu-id="3aa88-142">**复制：代理自定义关闭**</span><span class="sxs-lookup"><span data-stu-id="3aa88-142">**Replication: agent custom shutdown**</span></span>|||  
|<span data-ttu-id="3aa88-143">22815</span><span class="sxs-lookup"><span data-stu-id="3aa88-143">22815</span></span>|<span data-ttu-id="3aa88-144">**对等冲突检测警报**</span><span class="sxs-lookup"><span data-stu-id="3aa88-144">**Peer-to-peer conflict detection alert**</span></span>|<span data-ttu-id="3aa88-145">当分发代理尝试在对等节点上应用更改时检测到冲突。</span><span class="sxs-lookup"><span data-stu-id="3aa88-145">Distribution Agent detected a conflict when it tries to apply a change at a peer-to-peer node.</span></span>|<span data-ttu-id="3aa88-146">是</span><span class="sxs-lookup"><span data-stu-id="3aa88-146">Yes</span></span>|  
  
 <span data-ttu-id="3aa88-147">除这些警报之外，复制监视器还提供了一组与状态和性能相关的警告和警报。</span><span class="sxs-lookup"><span data-stu-id="3aa88-147">In addition to these alerts, Replication Monitor provides a set of warnings and alerts related to status and performance.</span></span> <span data-ttu-id="3aa88-148">有关详细信息，请参阅[在复制监视器警报基础结构中设置阈值和警告](../monitor/set-thresholds-and-warnings-in-replication-monitor.md)。</span><span class="sxs-lookup"><span data-stu-id="3aa88-148">For more information, see [Set Thresholds and Warnings in Replication Monitor](../monitor/set-thresholds-and-warnings-in-replication-monitor.md) alerts infrastructure.</span></span> <span data-ttu-id="3aa88-149">有关详细信息，请参阅[创建用户定义事件](../../../ssms/agent/create-a-user-defined-event.md)。</span><span class="sxs-lookup"><span data-stu-id="3aa88-149">For more information, see [Create a User-Defined Event](../../../ssms/agent/create-a-user-defined-event.md).</span></span>  
  
 <span data-ttu-id="3aa88-150">**配置预定义的复制警报**</span><span class="sxs-lookup"><span data-stu-id="3aa88-150">**To configure predefined replication alerts**</span></span>  
  
-   [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]<span data-ttu-id="3aa88-151">：[配置预定义的复制警报 (SQL Server Management Studio)](../administration/configure-predefined-replication-alerts-sql-server-management-studio.md)</span><span class="sxs-lookup"><span data-stu-id="3aa88-151">: [Configure Predefined Replication Alerts &#40;SQL Server Management Studio&#41;](../administration/configure-predefined-replication-alerts-sql-server-management-studio.md)</span></span>  
  
## <a name="viewing-the-application-log-directly"></a><span data-ttu-id="3aa88-152">直接查看应用程序日志</span><span class="sxs-lookup"><span data-stu-id="3aa88-152">Viewing the Application Log Directly</span></span>  
 <span data-ttu-id="3aa88-153">若要查看 Windows 应用程序日志，请使用 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows 事件查看器。</span><span class="sxs-lookup"><span data-stu-id="3aa88-153">To view the Windows application log, use the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows Event Viewer.</span></span> <span data-ttu-id="3aa88-154">应用程序日志包含 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 错误消息以及计算机上其他许多活动的消息。</span><span class="sxs-lookup"><span data-stu-id="3aa88-154">The application log contains [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] error messages as well as messages for many other activities on the computer.</span></span> <span data-ttu-id="3aa88-155">与 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 错误日志不同，新的应用程序日志不是在每次启动 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 时创建（每个 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 会话都会在现有应用程序日志中写入新事件）；但是，您可以指定已记录事件的保留时间。</span><span class="sxs-lookup"><span data-stu-id="3aa88-155">Unlike the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] error log, a new application log is not created each time you start [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (each [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] session writes new events to an existing application log); however, you can specify how long logged events will be retained.</span></span> <span data-ttu-id="3aa88-156">查看 Windows 应用程序日志时，可以筛选特定事件的日志。</span><span class="sxs-lookup"><span data-stu-id="3aa88-156">When you view the Windows application log, you can filter the log for specific events.</span></span> <span data-ttu-id="3aa88-157">有关详细信息，请参阅 Windows 文档。</span><span class="sxs-lookup"><span data-stu-id="3aa88-157">For more information, see the Windows documentation.</span></span>  
  
## <a name="automating-a-response-to-an-alert"></a><span data-ttu-id="3aa88-158">自动生成警报响应</span><span class="sxs-lookup"><span data-stu-id="3aa88-158">Automating a Response to an Alert</span></span>  
 <span data-ttu-id="3aa88-159">复制为未通过数据验证的订阅提供了响应作业，同时还提供了用于创建其他自动警报响应的框架。</span><span class="sxs-lookup"><span data-stu-id="3aa88-159">Replication provides a response job for subscriptions that fail data validation, and also provides a framework for creating additional automated responses to alerts.</span></span> <span data-ttu-id="3aa88-160">响应作业的标题为 **“数据验证失败时重新初始化订阅”** ，它存储在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 的 **代理的** “作业” [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]文件夹中。</span><span class="sxs-lookup"><span data-stu-id="3aa88-160">The response job is titled **Reinitialize subscriptions on data validation failure** and is stored in the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Agent **Jobs** folder in [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="3aa88-161">有关启用此响应作业的信息，请参阅[配置预定义的复制警报 (SQL Server Management Studio)](../administration/configure-predefined-replication-alerts-sql-server-management-studio.md)。</span><span class="sxs-lookup"><span data-stu-id="3aa88-161">For information about enabling this response job, see [Configure Predefined Replication Alerts &#40;SQL Server Management Studio&#41;](../administration/configure-predefined-replication-alerts-sql-server-management-studio.md).</span></span> <span data-ttu-id="3aa88-162">如果事务发布中的项目未通过验证，响应作业将只重新初始化那些未通过验证的项目。</span><span class="sxs-lookup"><span data-stu-id="3aa88-162">If articles in a transactional publication fail validation, the response job reinitializes only those articles that failed.</span></span> <span data-ttu-id="3aa88-163">如果合并发布中的项目未通过验证，响应作业将重新初始化发布中的所有项目。</span><span class="sxs-lookup"><span data-stu-id="3aa88-163">If articles in a merge publication fail validation, the response job reinitializes all articles in the publication.</span></span>  
  
### <a name="framework-for-automating-responses"></a><span data-ttu-id="3aa88-164">用于自动生成响应的框架</span><span class="sxs-lookup"><span data-stu-id="3aa88-164">Framework for Automating Responses</span></span>  
 <span data-ttu-id="3aa88-165">通常，当发生警报时，能够帮助您理解引起警报的原因以及应采取的适当措施的唯一信息就包含在警报消息中。</span><span class="sxs-lookup"><span data-stu-id="3aa88-165">Usually, when an alert occurs, the only information you have to help you understand what caused the alert and the appropriate action to take is contained in the alert message itself.</span></span> <span data-ttu-id="3aa88-166">分析此信息的过程是一个易出错且费时的过程。</span><span class="sxs-lookup"><span data-stu-id="3aa88-166">Parsing this information can be error-prone and time-consuming.</span></span> <span data-ttu-id="3aa88-167">复制在 **sysreplicationalerts** 系统表中提供了有关警报的其他信息，从而使自动生成响应变得更容易，因为系统表中提供的信息已按自定义程序易于使用的格式进行了分析。</span><span class="sxs-lookup"><span data-stu-id="3aa88-167">Replication makes automating responses easier by providing additional information about the alert in the **sysreplicationalerts** system table; the information provided is already parsed in a form easily used by customized programs.</span></span>  
  
 <span data-ttu-id="3aa88-168">例如，如果订阅服务器 A 上的 **Sales.SalesOrderHeader** 表中的数据未通过验证， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 可以激发消息 20574，通知您未通过验证。</span><span class="sxs-lookup"><span data-stu-id="3aa88-168">For example, if the data in the **Sales.SalesOrderHeader** table at Subscriber A fails validation, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can trigger message 20574, notifying you of that failure.</span></span> <span data-ttu-id="3aa88-169">您收到的消息是：“订阅服务器‘A’上对发布‘MyPublication’中项目‘SalesOrderHeader’的订阅未通过数据验证”。</span><span class="sxs-lookup"><span data-stu-id="3aa88-169">The message you receive will be: "Subscriber 'A', subscription to article 'SalesOrderHeader' in publication 'MyPublication' failed data validation."</span></span>  
  
 <span data-ttu-id="3aa88-170">如果基于该消息创建响应，必须手动分析该消息中的订阅服务器名称、项目名称、发布名称和错误。</span><span class="sxs-lookup"><span data-stu-id="3aa88-170">If you create a response based on the message, you must manually parse the Subscriber name, article name, publication name, and error from the message.</span></span> <span data-ttu-id="3aa88-171">但是，因为分发代理和合并代理将相同的信息写入了 **sysreplicationalerts** （同时写入的还有代理类型、警报时间、发布数据库、订阅服务器数据库和发布类型等详细信息），所以响应作业可以直接从该表中查询相关的信息。</span><span class="sxs-lookup"><span data-stu-id="3aa88-171">However, because the Distribution Agent and Merge Agent write that same information to **sysreplicationalerts** (along with details such as the type of agent, time of the alert, publication database, Subscriber database, and type of publication) the response job can directly query the relevant information from the table.</span></span> <span data-ttu-id="3aa88-172">虽然无法将确切的行与警报的特定实例相关联，但是该表中有一个 **status** 列，可用于跟踪所服务的条目。</span><span class="sxs-lookup"><span data-stu-id="3aa88-172">Although the exact row cannot be associated with a specific instance of the alert, the table has a **status** column, which can be used to keep track of serviced entries.</span></span> <span data-ttu-id="3aa88-173">此表中的条目会一直保留到历史记录保持期结束。</span><span class="sxs-lookup"><span data-stu-id="3aa88-173">The entries in this table are maintained for the history retention period.</span></span>  
  
 <span data-ttu-id="3aa88-174">例如，如果要在 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 中创建一个为警报消息 20574 服务的响应作业，则可以使用下列逻辑：</span><span class="sxs-lookup"><span data-stu-id="3aa88-174">For example, if you were to create a response job in [!INCLUDE[tsql](../../../includes/tsql-md.md)] that services alert message 20574, you might use the following logic:</span></span>  
  
```  
declare @publisher sysname, @publisher_db sysname, @publication sysname, @publication_type int, @article sysname, @subscriber sysname, @subscriber_db sysname, @alert_id int  
declare hc cursor local for select publisher, publisher_db, publication, publication_type, article, subscriber,   
  subscriber_db, alert_id from   
  msdb..sysreplicationalerts where  
  alert_error_code = 20574 and status = 0  
  for read only  
open hc  
fetch hc into  @publisher, @publisher_db, @publication, @publication_type, @article, @subscriber, @subscriber_db, @alert_id  
while (@@fetch_status <> -1)  
begin  
/* Do custom work  */  
/* Update status to 1, which means the alert has been serviced. This prevents subsequent runs of this job from doing this again */  
update msdb..sysreplicationalerts set status = 1 where alert_id = @alert_id  
 fetch hc into  @publisher, @publisher_db, @publication, @publication_type, @article, @subscriber, @subscriber_db, @alert_id  
end  
close hc  
deallocate hc  
```  
  
## <a name="see-also"></a><span data-ttu-id="3aa88-175">另请参阅</span><span class="sxs-lookup"><span data-stu-id="3aa88-175">See Also</span></span>  
 <span data-ttu-id="3aa88-176">[复制代理管理](replication-agent-administration.md) </span><span class="sxs-lookup"><span data-stu-id="3aa88-176">[Replication Agent Administration](replication-agent-administration.md) </span></span>  
 <span data-ttu-id="3aa88-177">[复制管理的最佳做法](../administration/best-practices-for-replication-administration.md) </span><span class="sxs-lookup"><span data-stu-id="3aa88-177">[Best Practices for Replication Administration](../administration/best-practices-for-replication-administration.md) </span></span>  
 [<span data-ttu-id="3aa88-178">监视（复制）</span><span class="sxs-lookup"><span data-stu-id="3aa88-178">Monitoring &#40;Replication&#41;</span></span>](../monitoring-replication.md)  
  
  

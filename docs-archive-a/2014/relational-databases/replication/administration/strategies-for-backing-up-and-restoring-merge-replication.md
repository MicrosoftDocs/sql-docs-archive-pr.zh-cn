---
title: 合并复制的备份和还原策略 | Microsoft Docs
ms.custom: ''
ms.date: 03/09/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- recovery [SQL Server replication], merge replication
- backups [SQL Server replication], merge replication
- restoring [SQL Server replication], merge replication
- merge replication [SQL Server replication], backup and restore
ms.assetid: b8ae31c6-d76f-4dd7-8f46-17d023ca3eca
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 45e3259d93af4735569fcb6b6a9c7b9eddd52730
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87691700"
---
# <a name="strategies-for-backing-up-and-restoring-merge-replication"></a><span data-ttu-id="e5b37-102">合并复制的备份和还原策略</span><span class="sxs-lookup"><span data-stu-id="e5b37-102">Strategies for Backing Up and Restoring Merge Replication</span></span>
  <span data-ttu-id="e5b37-103">对于合并复制，请定期备份下列数据库：</span><span class="sxs-lookup"><span data-stu-id="e5b37-103">For merge replication, back up the following databases regularly:</span></span>  
  
-   <span data-ttu-id="e5b37-104">发布服务器上的发布数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-104">The publication database at the Publisher</span></span>   
-   <span data-ttu-id="e5b37-105">分发服务器上的分发数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-105">The distribution database at the Distributor</span></span>    
-   <span data-ttu-id="e5b37-106">各个订阅服务器上的订阅数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-106">The subscription database at each Subscriber</span></span>    
-   <span data-ttu-id="e5b37-107">发布服务器、分发服务器和所有订阅服务器上的 **master** 和 **msdb** 系统数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-107">The **master** and **msdb** system databases at the Publisher, Distributor and all Subscribers.</span></span> <span data-ttu-id="e5b37-108">当备份这些数据库中的一个数据库或相关的复制数据库时，应同时备份这些数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-108">These databases should be backed up at the same time as each other and the relevant replication database.</span></span> <span data-ttu-id="e5b37-109">例如，应在备份发布数据库的同时备份发布服务器上的 **master** 和 **msdb** 数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-109">For example, back up the **master** and **msdb** databases at the Publisher at the same time you back up the publication database.</span></span> <span data-ttu-id="e5b37-110">如果还原发布数据库，请确保 **master** 和 **msdb** 数据库在复制配置和设置方面与发布数据库保持一致。</span><span class="sxs-lookup"><span data-stu-id="e5b37-110">If the publication database is restored, ensure that the **master** and **msdb** database are consistent with the publication database in terms of replication configuration and settings.</span></span>  
  
 <span data-ttu-id="e5b37-111">如果执行定期日志备份，则在日志备份中应捕获所有与复制相关的更改。</span><span class="sxs-lookup"><span data-stu-id="e5b37-111">If you perform regular log backups, any replication-related changes should be captured in the log backups.</span></span> <span data-ttu-id="e5b37-112">如果不执行日志备份，则当与复制相关的设置发生更改时，应执行备份。</span><span class="sxs-lookup"><span data-stu-id="e5b37-112">If you don't perform log backups, a backup should be performed whenever a setting relevant to replication is changed.</span></span> <span data-ttu-id="e5b37-113">有关详细信息，请参阅 [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-113">For more information, see [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span></span>  
  
 <span data-ttu-id="e5b37-114">选择以下一种方法来备份和还原发布数据库，然后遵循针对分发数据库和订阅数据库列出的建议。</span><span class="sxs-lookup"><span data-stu-id="e5b37-114">Choose one of the approaches detailed below for backing up and restoring the publication database, and then follow the recommendations listed for the distribution database and subscription databases.</span></span>  
  
## <a name="backing-up-and-restoring-the-publication-database"></a><span data-ttu-id="e5b37-115">备份和还原发布数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-115">Backing Up and Restoring the Publication Database</span></span>  
 <span data-ttu-id="e5b37-116">有两种方法可以还原合并发布数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-116">There are two approaches to restoring a merge publication database.</span></span> <span data-ttu-id="e5b37-117">从备份中还原发布数据库后，应进行以下两项操作之一：</span><span class="sxs-lookup"><span data-stu-id="e5b37-117">After restoring the publication database from a backup, you should either:</span></span>  
  
-   <span data-ttu-id="e5b37-118">使发布数据库和订阅数据库同步。</span><span class="sxs-lookup"><span data-stu-id="e5b37-118">Synchronize the publication database with a subscription database.</span></span>  
  
-   <span data-ttu-id="e5b37-119">重新初始化对发布数据库中发布的所有订阅。</span><span class="sxs-lookup"><span data-stu-id="e5b37-119">Reinitialize all subscriptions to the publications in the publication database.</span></span>  
  
 <span data-ttu-id="e5b37-120">使用这两种方法中的任何一种都可确保发布服务器和所有订阅服务器在执行还原后同步。</span><span class="sxs-lookup"><span data-stu-id="e5b37-120">Using either of these methods ensures that after a restore is performed, the Publisher and all Subscribers are synchronized.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="e5b37-121">如果某些表包含标识列，则必须确保还原后分配正确的标识范围。</span><span class="sxs-lookup"><span data-stu-id="e5b37-121">If any tables contain identity columns, you must ensure the correct identity ranges are assigned after a restore.</span></span> <span data-ttu-id="e5b37-122">有关详细信息，请参阅[复制标识列](../publish/replicate-identity-columns.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-122">For more information, see [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
### <a name="synchronizing-the-publication-database"></a><span data-ttu-id="e5b37-123">同步发布数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-123">Synchronizing the Publication Database</span></span>  
 <span data-ttu-id="e5b37-124">使发布数据库与订阅数据库同步使用户可从一个或多个订阅数据库中上载先前在发布数据库中所做的但未在还原备份中实现的更改。</span><span class="sxs-lookup"><span data-stu-id="e5b37-124">Synchronizing a publication database with a subscription database allows you to upload from one or more subscription databases those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="e5b37-125">可以上载的数据取决于筛选发布的方法：</span><span class="sxs-lookup"><span data-stu-id="e5b37-125">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
-   <span data-ttu-id="e5b37-126">如果发布未经筛选，则应能通过与最新订阅服务器同步来更新发布数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-126">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
-   <span data-ttu-id="e5b37-127">如果发布经过筛选，则可能无法更新发布数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-127">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="e5b37-128">假设有一个按如下方式分区的表：每个订阅仅收到一个区域（北部、东部、南部和西部）的客户数据。</span><span class="sxs-lookup"><span data-stu-id="e5b37-128">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="e5b37-129">如果每个数据分区至少有一个订阅服务器，那么使每个分区与订阅服务器同步会更新发布数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-129">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="e5b37-130">但是，以西分区为例，如果其中的数据未复制到任何订阅服务器，那么发布服务器上的此数据就无法更新。</span><span class="sxs-lookup"><span data-stu-id="e5b37-130">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="e5b37-131">使发布数据库与订阅数据库同步可使已发布的表还原到一个时间点，该时间点比从备份还原的其他未发布表的时间点更近。</span><span class="sxs-lookup"><span data-stu-id="e5b37-131">Synchronizing a publication database with a subscription database can result in published tables being restored to a point in time that is more recent than the point in time of other non-published tables restored from the backup.</span></span>  
  
 <span data-ttu-id="e5b37-132">如果与运行 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 之前的 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]版本的订阅服务器同步，则订阅无法匿名；它必须是客户端订阅或服务器订阅（在早期版本中称为本地订阅和全局订阅）。</span><span class="sxs-lookup"><span data-stu-id="e5b37-132">If you synchronize with a Subscriber that is running a version of [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prior to [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span>  
  
 <span data-ttu-id="e5b37-133">若要同步订阅，请参阅 [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) 和 [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-133">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
### <a name="reinitializing-all-subscriptions"></a><span data-ttu-id="e5b37-134">重新初始化所有订阅</span><span class="sxs-lookup"><span data-stu-id="e5b37-134">Reinitializing all Subscriptions</span></span>  
 <span data-ttu-id="e5b37-135">重新初始化所有订阅可确保所有订阅服务器都处于与已还原发布数据库一致的状态。</span><span class="sxs-lookup"><span data-stu-id="e5b37-135">Reinitializing all subscriptions ensures all Subscribers are in a state consistent with the restored publication database.</span></span> <span data-ttu-id="e5b37-136">若要将完整的拓扑返回到给定发布数据库备份表示的先前状态，应使用此方法。</span><span class="sxs-lookup"><span data-stu-id="e5b37-136">This approach should be used if you want to return an entire topology to the previous state represented by a given publication database backup.</span></span> <span data-ttu-id="e5b37-137">例如，如果作为从错误执行的批处理操作中还原的一种机制将发布数据库还原到某个较早的时间点，就可能需要重新初始化所有订阅。</span><span class="sxs-lookup"><span data-stu-id="e5b37-137">For example, you might want to reinitialize all subscriptions if you are restoring a publication database to an earlier point in time as a mechanism to recover from an erroneously performed batch operation.</span></span>  
  
 <span data-ttu-id="e5b37-138">如果选择此选项，请生成一个新的快照，用以在还原发布数据库后立即向重新初始化的订阅服务器传递。</span><span class="sxs-lookup"><span data-stu-id="e5b37-138">If you choose this option, generate a new snapshot for delivery to reinitialized Subscribers immediately after restoring your publication database.</span></span>  
  
 <span data-ttu-id="e5b37-139">若要重新初始化订阅，请参阅 [重新初始化订阅](../reinitialize-a-subscription.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-139">To reinitialize a subscription, see [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span></span>  
  
 <span data-ttu-id="e5b37-140">若要创建并应用快照，请参阅 [创建并应用初始快照](../create-and-apply-the-initial-snapshot.md) 和 [为包含参数化筛选器的合并发布创建快照](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-140">To create and apply a snapshot, see [Create and Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md) and [Create a Snapshot for a Merge Publication with Parameterized Filters](../create-a-snapshot-for-a-merge-publication-with-parameterized-filters.md).</span></span>  
  
## <a name="backing-up-and-restoring-the-distribution-database"></a><span data-ttu-id="e5b37-141">备份和还原分发数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-141">Backing Up and Restoring the Distribution Database</span></span>  
 <span data-ttu-id="e5b37-142">对于合并复制，应定期备份分发数据库，而且，只要所用备份的时间不超过使用分发服务器的所有发布的最短保持期，则无须考虑任何特殊事项即可还原分发数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-142">With merge replication, the distribution database should be backed up regularly, and can be restored without any special considerations as long as the backup used is no older than the shortest retention period of all publications that use the Distributor.</span></span> <span data-ttu-id="e5b37-143">例如，如果三个发布的保持期分别为 10 天、20 天和 30 天，则用于还原数据库的备份的保持时间不应超过 10 天。</span><span class="sxs-lookup"><span data-stu-id="e5b37-143">For example, if there are three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span> <span data-ttu-id="e5b37-144">分发数据库在合并复制中的作用有限：它不存储更改跟踪中使用的任何数据，也不对将要转发到订阅数据库的合并复制更改提供临时存储（而事务复制中提供）。</span><span class="sxs-lookup"><span data-stu-id="e5b37-144">The distribution database has a limited role in merge replication: it does not store any data used in change tracking and it does not provide temporary storage of merge replication changes to be forwarded to subscription databases (as it does in transactional replication).</span></span>  
  
## <a name="backing-up-and-restoring-a-subscription-database"></a><span data-ttu-id="e5b37-145">备份和还原订阅数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-145">Backing Up and Restoring a Subscription Database</span></span>  
 <span data-ttu-id="e5b37-146">为了确保成功恢复订阅数据库，订阅服务器应在备份订阅数据库前与发布服务器同步；还原订阅数据库后它们还要进行同步：</span><span class="sxs-lookup"><span data-stu-id="e5b37-146">To ensure successful recovery of a subscription database, Subscribers should synchronize with the Publisher before the subscription database is backed up; they should also synchronize after the subscription database is restored:</span></span>  
  
-   <span data-ttu-id="e5b37-147">备份订阅数据库前与发布服务器同步有助于确保在从备份中还原订阅服务器的情况下，订阅可以仍处于发布保持期内。</span><span class="sxs-lookup"><span data-stu-id="e5b37-147">Synchronizing with the Publisher before a subscription database backup helps ensure that if a Subscriber is restored from backup, the subscription is still within the publication retention period.</span></span> <span data-ttu-id="e5b37-148">例如，请假设有一个保持期为 10 天的发布。</span><span class="sxs-lookup"><span data-stu-id="e5b37-148">For example, assume a publication with a retention period of 10 days.</span></span> <span data-ttu-id="e5b37-149">上次同步是在 8 天前，现在执行备份。</span><span class="sxs-lookup"><span data-stu-id="e5b37-149">The last synchronization was 8 days ago, and now the backup is performed.</span></span> <span data-ttu-id="e5b37-150">如果 4 天后还原备份，那么上次同步就已经是 12 天前的事了，这已经过了保持期。</span><span class="sxs-lookup"><span data-stu-id="e5b37-150">If the backup is restored 4 days later, the last synchronization will have occurred 12 days ago, which is past the retention period.</span></span> <span data-ttu-id="e5b37-151">这种情况下，必须重新初始化订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="e5b37-151">In this case, you would have to reinitialize the Subscriber.</span></span> <span data-ttu-id="e5b37-152">如果订阅服务器在备份之前进行了同步，则订阅数据库将在保持期之内。</span><span class="sxs-lookup"><span data-stu-id="e5b37-152">If the Subscriber had synchronized before the backup, the subscription database would be within the retention period.</span></span>  
  
     <span data-ttu-id="e5b37-153">该备份的保持时间应不超过订阅服务器订阅的所有发布的保持期的最小值。</span><span class="sxs-lookup"><span data-stu-id="e5b37-153">The backup should be no older than the shortest retention period of all publications to which the Subscriber subscribes.</span></span> <span data-ttu-id="e5b37-154">例如，如果订阅服务器订阅了三个保持期分别为 10 天、20 天和 30 天的发布，则用于还原数据库的备份的保持时间不应超过 10 天。</span><span class="sxs-lookup"><span data-stu-id="e5b37-154">For example, if a Subscriber subscribes to three publications with retention periods of 10, 20, and 30 days, respectively, the backup used to restore the database should not be more than 10 days old.</span></span>  
  
-   <span data-ttu-id="e5b37-155">还原后使订阅数据库与其每个发布同步可确保订阅服务器与发布服务器上的所有更改同步更新。</span><span class="sxs-lookup"><span data-stu-id="e5b37-155">Synchronizing the subscription database with each of its publications following a restore ensures that the Subscriber is up to date with all changes at the Publisher.</span></span>  
  
 <span data-ttu-id="e5b37-156">若要设置发布保持期，请参阅[设置订阅的过期期限](../publish/set-the-expiration-period-for-subscriptions.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-156">To set the publication retention period, see [Set the Expiration Period for Subscriptions](../publish/set-the-expiration-period-for-subscriptions.md).</span></span>  
  
 <span data-ttu-id="e5b37-157">若要同步订阅，请参阅 [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) 和 [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md)。</span><span class="sxs-lookup"><span data-stu-id="e5b37-157">To synchronize a subscription, see [Synchronize a Push Subscription](../synchronize-a-push-subscription.md) and [Synchronize a Pull Subscription](../synchronize-a-pull-subscription.md).</span></span>  
  
## <a name="backing-up-and-restoring-a-republishing-database"></a><span data-ttu-id="e5b37-158">备份和还原重新发布的数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-158">Backing Up and Restoring a Republishing Database</span></span>  
 <span data-ttu-id="e5b37-159">如果某个数据库从发布服务器订阅数据，并依次将同样的数据发布给其他订阅数据库，则称该数据库为重新发布数据库。</span><span class="sxs-lookup"><span data-stu-id="e5b37-159">When a database subscribes to data from a Publisher and in turn publishes that same data to other subscription databases, it is referred to as a republishing database.</span></span> <span data-ttu-id="e5b37-160">还原重新发布数据库时，请遵从此主题中“备份和还原发布数据库”和“备份和还原订阅数据库”两节所介绍的准则。</span><span class="sxs-lookup"><span data-stu-id="e5b37-160">When restoring a republishing database, follow the guidelines described in "Backing Up and Restoring a Publication Database" and "Backing Up and Restoring a Subscription Database" in this topic.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e5b37-161">另请参阅</span><span class="sxs-lookup"><span data-stu-id="e5b37-161">See Also</span></span>  
 <span data-ttu-id="e5b37-162">[SQL Server 数据库的备份和还原](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="e5b37-162">[Back Up and Restore of SQL Server Databases](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 [<span data-ttu-id="e5b37-163">备份和还原复制的数据库</span><span class="sxs-lookup"><span data-stu-id="e5b37-163">Back Up and Restore Replicated Databases</span></span>](back-up-and-restore-replicated-databases.md)  
  
  

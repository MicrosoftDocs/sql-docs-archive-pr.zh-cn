---
title: 快照复制和事务复制的备份和还原策略 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- backups [SQL Server replication], snapshot replication
- restoring [SQL Server replication], transactional replication
- snapshot replication [SQL Server], backup and restore
- restoring [SQL Server replication], snapshot replication
- recovery [SQL Server replication], transactional replication
- transactional replication, backup and restore
- recovery [SQL Server replication], snapshot replication
- sync with backup [SQL Server replication]
- backups [SQL Server replication], transactional replication
ms.assetid: a8afcdbc-55db-4916-a219-19454f561f9e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e26f6cf1a61e4df9db79bc5fd90429f86d70a99f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87591878"
---
# <a name="strategies-for-backing-up-and-restoring-snapshot-and-transactional-replication"></a><span data-ttu-id="cc27b-102">快照复制和事务复制的备份和还原策略</span><span class="sxs-lookup"><span data-stu-id="cc27b-102">Strategies for Backing Up and Restoring Snapshot and Transactional Replication</span></span>
  <span data-ttu-id="cc27b-103">在设计快照和事务复制的备份和还原策略时，需要考虑三个方面：</span><span class="sxs-lookup"><span data-stu-id="cc27b-103">When you design a backup and restore strategy for snapshot and transactional replication, there are three areas to consider:</span></span>  
  
-   <span data-ttu-id="cc27b-104">要备份哪些数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-104">Which databases to back up.</span></span>  
  
-   <span data-ttu-id="cc27b-105">事务复制的备份设置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-105">Backup settings for transactional replication.</span></span>  
  
-   <span data-ttu-id="cc27b-106">还原数据库需要的步骤。</span><span class="sxs-lookup"><span data-stu-id="cc27b-106">The steps that are required to restore a database.</span></span> <span data-ttu-id="cc27b-107">这些步骤取决于所选的复制类型和选项。</span><span class="sxs-lookup"><span data-stu-id="cc27b-107">These depend on the type of replication and options chosen.</span></span>  
  
 <span data-ttu-id="cc27b-108">本主题在下面三部分中分别介绍了这三个方面。</span><span class="sxs-lookup"><span data-stu-id="cc27b-108">This topic covers each of these areas in the next three sections.</span></span> <span data-ttu-id="cc27b-109">有关备份和还原 Oracle 发布的信息，请参阅 [Oracle 发布服务器的备份和还原](../non-sql/backup-and-restore-for-oracle-publishers.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-109">For information about backup and restore for Oracle publishing, see [Backup and Restore for Oracle Publishers](../non-sql/backup-and-restore-for-oracle-publishers.md).</span></span>  
  
## <a name="backing-up-databases"></a><span data-ttu-id="cc27b-110">备份数据库</span><span class="sxs-lookup"><span data-stu-id="cc27b-110">Backing up Databases</span></span>  
 <span data-ttu-id="cc27b-111">对于快照和事务复制，应定期对以下数据库进行备份：</span><span class="sxs-lookup"><span data-stu-id="cc27b-111">For snapshot and transactional replication, you should regularly back up the following databases:</span></span>  
  
-   <span data-ttu-id="cc27b-112">发布服务器上的发布数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-112">The publication database at the Publisher.</span></span>  
  
-   <span data-ttu-id="cc27b-113">分发服务器上的分发数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-113">The distribution database at the Distributor.</span></span>  
  
-   <span data-ttu-id="cc27b-114">每台订阅服务器上的订阅数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-114">The subscription database at each Subscriber.</span></span>  
  
-   <span data-ttu-id="cc27b-115">发布服务器、分发服务器和所有订阅服务器上的 **master** 和 **msdb** 系统数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-115">The **master** and **msdb** system databases at the Publisher, Distributor and all Subscribers.</span></span> <span data-ttu-id="cc27b-116">当备份这些数据库中的一个数据库或相关的复制数据库时，应同时备份这些数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-116">These databases should be backed up at the same time as each other and the relevant replication database.</span></span> <span data-ttu-id="cc27b-117">例如，应在备份发布数据库的同时备份发布服务器上的 **master** 和 **msdb** 数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-117">For example, back up the **master** and **msdb** databases at the Publisher at the same time that you back up the publication database.</span></span> <span data-ttu-id="cc27b-118">如果还原发布数据库，请确保 **master** 和 **msdb** 数据库在复制配置和设置方面与发布数据库保持一致。</span><span class="sxs-lookup"><span data-stu-id="cc27b-118">If the publication database is restored, make sure that the **master** and **msdb** databases are consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
 <span data-ttu-id="cc27b-119">如果执行定期日志备份，则在日志备份中应捕获所有与复制相关的更改。</span><span class="sxs-lookup"><span data-stu-id="cc27b-119">If you perform regular log backups, any replication-related changes should be captured in the log backups.</span></span> <span data-ttu-id="cc27b-120">如果不执行日志备份，则当与复制相关的设置发生更改时，应执行备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-120">If you do not perform log backups, a backup should be performed whenever a setting relevant to replication is changed.</span></span> <span data-ttu-id="cc27b-121">有关详细信息，请参阅 [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-121">For more information, see [Common Actions Requiring an Updated Backup](common-actions-requiring-an-updated-backup.md).</span></span>  
  
## <a name="backup-settings-for-transactional-replication"></a><span data-ttu-id="cc27b-122">事务复制的备份设置</span><span class="sxs-lookup"><span data-stu-id="cc27b-122">Backup Settings for Transactional Replication</span></span>  
 <span data-ttu-id="cc27b-123">事务复制包括使用 **sync with backup** 选项，可以对分发数据库和发布数据库设置此选项：</span><span class="sxs-lookup"><span data-stu-id="cc27b-123">Transactional replication includes using the **sync with backup** option, which can be set on the distribution database and the publication database:</span></span>  
  
-   <span data-ttu-id="cc27b-124">建议您始终对分发数据库设置此选项。</span><span class="sxs-lookup"><span data-stu-id="cc27b-124">We recommend that you always set this option on the distribution database.</span></span>  
  
     <span data-ttu-id="cc27b-125">对分发数据库设置此选项可以确保发布数据库日志中的事务在分发数据库上备份之前不会被截断。</span><span class="sxs-lookup"><span data-stu-id="cc27b-125">Setting this option on the distribution database ensures that transactions in the log of the publication database will not be truncated until they have been backed up at the distribution database.</span></span> <span data-ttu-id="cc27b-126">分发数据库可以还原为上次的备份，并且任何缺失的事务都会从发布数据库传递到分发数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-126">The distribution database can be restored to the last backup, and any missing transactions are delivered from the publication database to the distribution database.</span></span> <span data-ttu-id="cc27b-127">复制将继续，而不会受到任何影响。</span><span class="sxs-lookup"><span data-stu-id="cc27b-127">Replication continues unaffected.</span></span>  
  
     <span data-ttu-id="cc27b-128">对分发数据库设置此选项不会影响复制滞后时间。</span><span class="sxs-lookup"><span data-stu-id="cc27b-128">Setting this option on the distribution database does not affect replication latency.</span></span> <span data-ttu-id="cc27b-129">但是，设置该选项后，直到分发数据库中的相应事务备份已经完成，才会对发布数据库上的日志进行截断。</span><span class="sxs-lookup"><span data-stu-id="cc27b-129">However, the option will delay the truncation of the log on the publication database until the corresponding transactions in the distribution database have been backed up.</span></span> <span data-ttu-id="cc27b-130">（这会导致发布数据库中生成较大的事务日志）。</span><span class="sxs-lookup"><span data-stu-id="cc27b-130">(This can create a larger transaction log in the publication database.)</span></span>  
  
-   <span data-ttu-id="cc27b-131">如果应用程序允许额外的滞后时间，则建议您对发布数据库设置此选项。</span><span class="sxs-lookup"><span data-stu-id="cc27b-131">We recommend that you set this option on the publication database if your application can tolerate additional latency.</span></span>  
  
     <span data-ttu-id="cc27b-132">对发布数据库设置此选项可以确保事务在发布数据库上备份之前不会传递到分发数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="cc27b-133">这样上次的发布数据库备份就可以在发布服务器上还原，而分发数据库不可能具有已还原发布数据库所没有的事务。</span><span class="sxs-lookup"><span data-stu-id="cc27b-133">The last publication database backup can then be restored at the Publisher without any chance of the distribution database having transactions that the restored publication database does not have.</span></span>  
  
     <span data-ttu-id="cc27b-134">由于事务在发布服务器上备份之前无法传递到分发数据库，因此会影响滞后时间和吞吐量。</span><span class="sxs-lookup"><span data-stu-id="cc27b-134">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher.</span></span> <span data-ttu-id="cc27b-135">例如，如果事务日志每五分钟备份一次，则在发布服务器上提交事务与将事务依次传递到分发数据库和订阅服务器之间会另有五分钟的滞后时间。</span><span class="sxs-lookup"><span data-stu-id="cc27b-135">For example, if the transaction log is backed up every five minutes, there is an additional five minutes of latency between when a transaction is committed at the Publisher and when the transaction is delivered to the distribution database, and subsequently the Subscriber.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="cc27b-136">**sync with backup** 选项可确保发布数据库和分发数据库之间的一致性，但此选项不能保证数据不丢失。</span><span class="sxs-lookup"><span data-stu-id="cc27b-136">The **sync with backup** option ensures consistency between the publication database and the distribution database, but the option does not guarantee against data loss.</span></span> <span data-ttu-id="cc27b-137">例如，如果事务日志丢失，则在发布数据库或分发数据库中没有上次事务日志备份后提交的事务。</span><span class="sxs-lookup"><span data-stu-id="cc27b-137">For example, if the transaction log is lost, transactions that have been committed since the last transaction log backup will not be available in the publication database or the distribution database.</span></span> <span data-ttu-id="cc27b-138">这与非复制数据库的行为相同。</span><span class="sxs-lookup"><span data-stu-id="cc27b-138">This is the same behavior as a nonreplicated database.</span></span>  
  
 <span data-ttu-id="cc27b-139">**设置 sync with backup 选项**</span><span class="sxs-lookup"><span data-stu-id="cc27b-139">**To set the sync with backup option**</span></span>  
  
-   <span data-ttu-id="cc27b-140">复制 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 编程：[为事务复制启用协调备份（复制 Transact-SQL 编程）](enable-coordinated-backups-for-transactional-replication.md)</span><span class="sxs-lookup"><span data-stu-id="cc27b-140">Replication [!INCLUDE[tsql](../../../includes/tsql-md.md)] programming: [Enable Coordinated Backups for Transactional Replication &#40;Replication Transact-SQL Programming&#41;](enable-coordinated-backups-for-transactional-replication.md)</span></span>  
  
## <a name="restoring-databases-involved-in-replication"></a><span data-ttu-id="cc27b-141">还原复制中涉及的数据库</span><span class="sxs-lookup"><span data-stu-id="cc27b-141">Restoring Databases Involved in Replication</span></span>  
 <span data-ttu-id="cc27b-142">如果最近的备份可用并且遵循正确的步骤，则可以还原复制拓扑中的所有数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-142">You can restore all databases in a replication topology if recent backups are available and the appropriate steps are followed.</span></span> <span data-ttu-id="cc27b-143">发布数据库的还原步骤取决于复制类型和所用的选项；但所有其他数据库的还原步骤与类型和选项无关。</span><span class="sxs-lookup"><span data-stu-id="cc27b-143">The restore steps for the publication database depend on the type of replication and options that are used; however, the restore steps for all other databases are independent of the type and options.</span></span>  
  
 <span data-ttu-id="cc27b-144">复制支持将复制的数据库还原到从中创建备份的同一服务器和数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-144">Replication supports restoring replicated databases to the same server and database from which the backup was created.</span></span> <span data-ttu-id="cc27b-145">如果将复制数据库的备份还原到其他服务器或数据库，则无法保留复制设置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-145">If you restore a backup of a replicated database to another server or database, replication settings cannot be preserved.</span></span> <span data-ttu-id="cc27b-146">在这种情况下，您必须在还原备份后重新创建所有发布和订阅。</span><span class="sxs-lookup"><span data-stu-id="cc27b-146">In this case, you must re-create all publications and subscriptions after backups are restored.</span></span>  
  
### <a name="publisher"></a><span data-ttu-id="cc27b-147">发布者</span><span class="sxs-lookup"><span data-stu-id="cc27b-147">Publisher</span></span>  
 <span data-ttu-id="cc27b-148">下面介绍了下列类型复制的还原步骤：</span><span class="sxs-lookup"><span data-stu-id="cc27b-148">There are restore steps provided for the following types of replication:</span></span>  
  
-   <span data-ttu-id="cc27b-149">快照复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-149">Snapshot replication</span></span>  
  
-   <span data-ttu-id="cc27b-150">只读事务复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-150">Read-only transactional replication</span></span>  
  
-   <span data-ttu-id="cc27b-151">带有更新订阅的事务复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-151">Transactional replication with updating subscriptions</span></span>  
  
-   <span data-ttu-id="cc27b-152">对等事务复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-152">Peer-to-peer transactional replication</span></span>  
  
 <span data-ttu-id="cc27b-153">本部分还介绍了 **msdb** 和 **master** 数据库的还原步骤，这些步骤与所有四种复制类型的还原步骤相同。</span><span class="sxs-lookup"><span data-stu-id="cc27b-153">The restore of the **msdb** and **master** databases, which are also covered in this section, is the same for all four types.</span></span>  
  
#### <a name="publication-database-snapshot-replication"></a><span data-ttu-id="cc27b-154">发布数据库：快照复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-154">Publication Database: Snapshot Replication</span></span>  
  
1.  <span data-ttu-id="cc27b-155">还原发布数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-155">Restore the latest backup of the publication database.</span></span> <span data-ttu-id="cc27b-156">转到步骤 2。</span><span class="sxs-lookup"><span data-stu-id="cc27b-156">Go to step 2.</span></span>  
  
2.  <span data-ttu-id="cc27b-157">发布数据库备份是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-157">Does the publication database backup contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-158">如果是，则还原已完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-158">If yes, the restore is completed.</span></span> <span data-ttu-id="cc27b-159">如果不是，则转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-159">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="cc27b-160">从发布服务器、分发服务器和订阅服务器中删除复制配置，然后重新创建配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-160">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="cc27b-161">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-161">Restore is completed.</span></span>  
  
     <span data-ttu-id="cc27b-162">有关如何删除复制的详细信息，请参阅 [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-162">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
#### <a name="publication-database-read-only-transactional-replication"></a><span data-ttu-id="cc27b-163">发布数据库：只读事务复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-163">Publication Database: Read-Only Transactional Replication</span></span>  
  
1.  <span data-ttu-id="cc27b-164">还原发布数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-164">Restore the latest backup of the publication database.</span></span> <span data-ttu-id="cc27b-165">转到步骤 2。</span><span class="sxs-lookup"><span data-stu-id="cc27b-165">Go to step 2.</span></span>  
  
2.  <span data-ttu-id="cc27b-166">是否在故障发生前对发布数据库启用了 **sync with backup** 设置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-166">Was the **sync with backup** setting enabled on the publication database before the failure?</span></span> <span data-ttu-id="cc27b-167">如果是，则转到步骤 3；如果不是，则转到步骤 5。</span><span class="sxs-lookup"><span data-stu-id="cc27b-167">If yes, go to step 3; if no, go to step 5.</span></span>  
  
     <span data-ttu-id="cc27b-168">如果此设置已启用，查询 `SELECT DATABASEPROPERTYEX('<PublicationDatabaseName>', 'IsSyncWithBackup')` 将返回“1”。</span><span class="sxs-lookup"><span data-stu-id="cc27b-168">If the setting is enabled, the query `SELECT DATABASEPROPERTYEX('<PublicationDatabaseName>', 'IsSyncWithBackup')` returns '1'.</span></span>  
  
3.  <span data-ttu-id="cc27b-169">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-169">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-170">它是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-170">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-171">如果是，则还原已完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-171">If yes, the restore is completed.</span></span> <span data-ttu-id="cc27b-172">如果不是，则转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-172">If no, go to step 4.</span></span>  
  
4.  <span data-ttu-id="cc27b-173">还原的发布数据库中的配置信息不是最新的。</span><span class="sxs-lookup"><span data-stu-id="cc27b-173">The configuration information in the restored publication database is not up-to-date.</span></span> <span data-ttu-id="cc27b-174">因此，必须确保订阅服务器包含分发数据库中所有未完成的命令，然后删除并重新创建复制配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-174">Therefore, you must make sure that the Subscribers have all outstanding commands in the distribution database, and then drop and re-create the replication configuration.</span></span>  
  
    1.  <span data-ttu-id="cc27b-175">运行分发代理，直到所有订阅服务器都与分发数据库中的未完成命令同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-175">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="cc27b-176">通过使用复制监视器中的 **“未分发的命令”** 选项卡或通过查询分发数据库中的 [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) 视图，确保所有命令都已传递到订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="cc27b-176">Verify that all commands are delivered to Subscribers by using the **Undistributed Commands** tab in Replication Monitor or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="cc27b-177">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-177">Go to step b.</span></span>  
  
         <span data-ttu-id="cc27b-178">有关如何运行分发代理的详细信息，请参阅[启动和停止复制代理 &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) 和[复制代理可执行文件概念](../concepts/replication-agent-executables-concepts.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-178">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
         <span data-ttu-id="cc27b-179">有关如何验证命令的详细信息，请参阅[在分发数据库中查看复制的命令和其他信息 &#40;复制 Transact-sql 编程&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md)和[使用复制监视器查看信息和执行任务](../monitor/view-information-and-perform-tasks-replication-monitor.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-179">For more information about how to verify commands, see [View Replicated Commands and Other Information in the Distribution Database &#40;Replication Transact-SQL Programming&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md) and [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
    2.  <span data-ttu-id="cc27b-180">从发布服务器、分发服务器和订阅服务器中删除复制配置，然后重新创建配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-180">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="cc27b-181">重新创建订阅时，指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-181">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-182">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-182">The restore is completed.</span></span>  
  
         <span data-ttu-id="cc27b-183">有关如何删除复制的详细信息，请参阅 [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-183">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="cc27b-184">有关如何指定订阅服务器已包含数据的详细信息，请参阅 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-184">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
5.  <span data-ttu-id="cc27b-185">未对发布数据库设置 **sync with backup** 选项。</span><span class="sxs-lookup"><span data-stu-id="cc27b-185">The **sync with backup** option was not set on the publication database.</span></span> <span data-ttu-id="cc27b-186">因此，还原备份中不包括的事务可能已传递到分发服务器和订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="cc27b-186">Therefore, transactions that were not included in the restored backup might have been delivered to the Distributor and Subscribers.</span></span> <span data-ttu-id="cc27b-187">现在必须确保订阅服务器包含分发数据库中所有未完成的命令，然后手动将还原备份中未包含的所有事务都应用到发布数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-187">You must now make sure that Subscribers have all outstanding commands in the distribution database, and then manually apply to the publication database any transactions that are not included in the restored backup.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="cc27b-188">执行此过程会导致已发布的表还原到的时间点晚于从备份还原的其他未发布表的时间点。</span><span class="sxs-lookup"><span data-stu-id="cc27b-188">Performing this process can cause published tables to be restored to a point in time that is more recent than the point in time of other nonpublished tables that are restored from the backup.</span></span>  
  
    1.  <span data-ttu-id="cc27b-189">运行分发代理，直到所有订阅服务器都与分发数据库中的未完成命令同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-189">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="cc27b-190">通过使用复制监视器中的 **“未分发的命令”** 选项卡或通过查询分发数据库中的 [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) 视图，确保所有命令都已传递到订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="cc27b-190">Verify that all commands are delivered to Subscribers by using the **Undistributed Commands** tab in Replication Monitor or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="cc27b-191">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-191">Go to step b.</span></span>  
  
         <span data-ttu-id="cc27b-192">有关如何运行分发代理的详细信息，请参阅[启动和停止复制代理 &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) 和[复制代理可执行文件概念](../concepts/replication-agent-executables-concepts.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-192">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
         <span data-ttu-id="cc27b-193">有关如何验证命令的详细信息，请参阅[在分发数据库中查看复制的命令和其他信息 &#40;复制 Transact-sql 编程&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md)和[使用复制监视器查看信息和执行任务](../monitor/view-information-and-perform-tasks-replication-monitor.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-193">For more information about how to verify commands, see [View Replicated Commands and Other Information in the Distribution Database &#40;Replication Transact-SQL Programming&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md) and [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
    2.  <span data-ttu-id="cc27b-194">使用 [tablediff 实用工具](../../../tools/tablediff-utility.md) 或其他工具手动将发布服务器和订阅服务器同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-194">Use the [tablediff utility](../../../tools/tablediff-utility.md) or another tool to manually synchronize the Publisher with the Subscriber.</span></span> <span data-ttu-id="cc27b-195">这使您能够从订阅数据库恢复发布数据库备份中未包含的数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-195">This enables you to recover data from the subscription database that was not contained in the publication database backup.</span></span> <span data-ttu-id="cc27b-196">转到步骤 c。</span><span class="sxs-lookup"><span data-stu-id="cc27b-196">Go to step c.</span></span>  
  
         <span data-ttu-id="cc27b-197">有关 **tablediff** 实用工具的详细信息，请参阅[比较所复制表的差异（复制编程）](compare-replicated-tables-for-differences-replication-programming.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-197">For more information about the **tablediff** utility, see [Compare Replicated Tables for Differences &#40;Replication Programming&#41;](compare-replicated-tables-for-differences-replication-programming.md).</span></span>  
  
    3.  <span data-ttu-id="cc27b-198">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-198">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-199">它是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-199">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-200">如果是，执行 [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) 存储过程，使发布服务器元数据与分发服务器元数据重新同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-200">If yes, execute the [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) stored procedure to resynchronize the Publisher metadata with the Distributor metadata.</span></span> <span data-ttu-id="cc27b-201">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-201">The restore is completed.</span></span> <span data-ttu-id="cc27b-202">如果不是，则转到步骤 d。</span><span class="sxs-lookup"><span data-stu-id="cc27b-202">If no, go to step d.</span></span>  
  
    4.  <span data-ttu-id="cc27b-203">从发布服务器、分发服务器和订阅服务器中删除复制配置，然后重新创建配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-203">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="cc27b-204">重新创建订阅时，指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-204">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-205">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-205">The restore is completed.</span></span>  
  
         <span data-ttu-id="cc27b-206">有关如何删除复制的详细信息，请参阅 [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-206">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="cc27b-207">有关如何指定订阅服务器已包含数据的详细信息，请参阅 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-207">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
#### <a name="publication-database-transactional-replication-with-updating-subscriptions"></a><span data-ttu-id="cc27b-208">发布数据库：带有更新订阅的事务复制</span><span class="sxs-lookup"><span data-stu-id="cc27b-208">Publication Database: Transactional Replication with Updating Subscriptions</span></span>  
  
1.  <span data-ttu-id="cc27b-209">还原发布数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-209">Restore the latest backup of the publication database.</span></span> <span data-ttu-id="cc27b-210">转到步骤 2。</span><span class="sxs-lookup"><span data-stu-id="cc27b-210">Go to step 2.</span></span>  
  
2.  <span data-ttu-id="cc27b-211">运行分发代理，直到所有订阅服务器都与分发数据库中的未完成命令同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-211">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="cc27b-212">通过使用复制监视器中的 **“未分发的命令”** 选项卡或通过查询分发数据库中的 [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) 视图，确保所有命令都已传递到订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="cc27b-212">Verify that all commands are delivered to Subscribers by using the **Undistributed Commands** tab in Replication Monitor, or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="cc27b-213">转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-213">Go to step 3.</span></span>  
  
     <span data-ttu-id="cc27b-214">有关如何运行分发代理的详细信息，请参阅[启动和停止复制代理 &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) 和[复制代理可执行文件概念](../concepts/replication-agent-executables-concepts.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-214">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
     <span data-ttu-id="cc27b-215">有关如何验证命令的详细信息，请参阅[在分发数据库中查看复制的命令和其他信息 &#40;复制 Transact-sql 编程&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md)和[使用复制监视器查看信息和执行任务](../monitor/view-information-and-perform-tasks-replication-monitor.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-215">For more information about how to verify commands, see [View Replicated Commands and Other Information in the Distribution Database &#40;Replication Transact-SQL Programming&#41;](../monitor/view-replicated-commands-and-information-in-distribution-database.md) and [View Information and Perform Tasks using Replication Monitor](../monitor/view-information-and-perform-tasks-replication-monitor.md).</span></span>  
  
3.  <span data-ttu-id="cc27b-216">如果使用的是排队更新订阅，则连接到每台订阅服务器，并从订阅数据库中的 [MSreplication_queue &#40;Transact-SQL&#41;](/sql/relational-databases/system-tables/msreplication-queue-transact-sql) 表中删除所有行。</span><span class="sxs-lookup"><span data-stu-id="cc27b-216">If you are using queued updating subscriptions, connect to each Subscriber and delete all rows from the [MSreplication_queue &#40;Transact-SQL&#41;](/sql/relational-databases/system-tables/msreplication-queue-transact-sql) table in the subscription database.</span></span> <span data-ttu-id="cc27b-217">转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-217">Go to step 4.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="cc27b-218">如果使用的是排队更新并且任何表中都包含标识列，则必须确保还原后分配正确的标识范围。</span><span class="sxs-lookup"><span data-stu-id="cc27b-218">If you are using queued updating subscriptions and any tables contain identity columns, you must make sure that the correct identity ranges are assigned after a restore.</span></span> <span data-ttu-id="cc27b-219">有关详细信息，请参阅[复制标识列](../publish/replicate-identity-columns.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-219">For more information, see [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
4.  <span data-ttu-id="cc27b-220">现在必须确保订阅服务器包含分发数据库中所有未完成的命令，然后手动将还原备份中未包含的所有事务都应用到发布数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-220">You must now make sure that Subscribers have all outstanding commands in the distribution database, and then manually apply to the publication database any transactions that are not included in the restored backup.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="cc27b-221">执行此过程会导致已发布的表还原到的时间点晚于从备份还原的其他未发布表的时间点。</span><span class="sxs-lookup"><span data-stu-id="cc27b-221">Performing this process can cause published tables to be restored to a point in time that is more recent than the point in time of other nonpublished tables that are restored from the backup.</span></span>  
  
    1.  <span data-ttu-id="cc27b-222">运行分发代理，直到所有订阅服务器都与分发数据库中的未完成命令同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-222">Run the Distribution Agent until all Subscribers are synchronized with the outstanding commands in the distribution database.</span></span> <span data-ttu-id="cc27b-223">通过使用复制监视器或通过查询分发数据库中的 [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) 视图，确保所有命令都已传递到订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="cc27b-223">Verify that all commands are delivered to Subscribers by using Replication Monitor or by querying the [MSdistribution_status](/sql/relational-databases/system-views/msdistribution-status-transact-sql) view in the distribution database.</span></span> <span data-ttu-id="cc27b-224">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-224">Go to step b.</span></span>  
  
    2.  <span data-ttu-id="cc27b-225">使用 [tablediff Utility](../../../tools/tablediff-utility.md) 或其他工具手动将发布服务器和订阅服务器同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-225">Use the [tablediff Utility](../../../tools/tablediff-utility.md) or another tool to manually synchronize the Publisher with the Subscriber.</span></span> <span data-ttu-id="cc27b-226">这使您能够从订阅数据库恢复发布数据库备份中未包含的数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-226">This enables you to recover data from the subscription database that was not contained in the publication database backup.</span></span> <span data-ttu-id="cc27b-227">转到步骤 c。</span><span class="sxs-lookup"><span data-stu-id="cc27b-227">Go to step c.</span></span>  
  
         <span data-ttu-id="cc27b-228">有关 **tablediff** 实用工具的详细信息，请参阅[比较所复制表的差异（复制编程）](compare-replicated-tables-for-differences-replication-programming.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-228">For more information about the **tablediff** utility, see [Compare Replicated Tables for Differences &#40;Replication Programming&#41;](compare-replicated-tables-for-differences-replication-programming.md).</span></span>  
  
    3.  <span data-ttu-id="cc27b-229">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-229">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-230">它是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-230">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-231">如果是，执行 [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) 存储过程，使发布服务器元数据与分发服务器元数据重新同步。</span><span class="sxs-lookup"><span data-stu-id="cc27b-231">If yes, execute the [sp_replrestart](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql) stored procedure to resynchronize the Publisher metadata with the Distributor metadata.</span></span> <span data-ttu-id="cc27b-232">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-232">The restore is completed.</span></span> <span data-ttu-id="cc27b-233">如果不是，则转到步骤 d。</span><span class="sxs-lookup"><span data-stu-id="cc27b-233">If no, go to step d.</span></span>  
  
    4.  <span data-ttu-id="cc27b-234">从发布服务器、分发服务器和订阅服务器中删除复制配置，然后重新创建配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-234">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="cc27b-235">重新创建订阅时，指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-235">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-236">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-236">The restore is completed.</span></span>  
  
         <span data-ttu-id="cc27b-237">有关如何删除复制的详细信息，请参阅 [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-237">For more information about how to remove replication, see and [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="cc27b-238">有关如何指定订阅服务器已包含数据的详细信息，请参阅 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-238">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
#### <a name="publication-database-peer-to-peer-transactional-replication"></a><span data-ttu-id="cc27b-239">发布数据库：@loopback_detection</span><span class="sxs-lookup"><span data-stu-id="cc27b-239">Publication Database: Peer-to-Peer Transactional Replication</span></span>  
 <span data-ttu-id="cc27b-240">在下列步骤中，复制数据库 **A**、 **B**和 **C** 位于对等事务复制拓扑中。</span><span class="sxs-lookup"><span data-stu-id="cc27b-240">In the following steps, publication databases **A**, **B**, and **C** are in a peer-to-peer transactional replication topology.</span></span> <span data-ttu-id="cc27b-241">数据库 **A** 和 **C** 处于联机状态，并且可以正常工作；数据库 **B** 是要还原的数据库。</span><span class="sxs-lookup"><span data-stu-id="cc27b-241">Databases **A** and **C** are online and functioning properly; database **B** is the database to be restored.</span></span> <span data-ttu-id="cc27b-242">在此介绍的过程，尤其是步骤 7、10 和 11，非常类似于向对等拓扑添加节点时所需的过程。</span><span class="sxs-lookup"><span data-stu-id="cc27b-242">The process described here, especially steps 7, 10, and 11, is very similar to the process required to add a node to a peer-to-peer topology.</span></span> <span data-ttu-id="cc27b-243">执行这些步骤最简单的方法是使用配置对等拓扑向导，但是您也可以使用存储过程。</span><span class="sxs-lookup"><span data-stu-id="cc27b-243">The most straightforward way to perform these steps is to use the Configure Peer-to-Peer Topology Wizard, but you can also use stored procedures.</span></span>  
  
1.  <span data-ttu-id="cc27b-244">运行分发代理以同步数据库 **A** 和 **C** 上的订阅。转到步骤 2。</span><span class="sxs-lookup"><span data-stu-id="cc27b-244">Run the Distribution Agents to synchronize the subscriptions at databases **A** and **C**. Go to step 2.</span></span>  
  
     <span data-ttu-id="cc27b-245">有关如何运行分发代理的详细信息，请参阅[启动和停止复制代理 &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) 和[复制代理可执行文件概念](../concepts/replication-agent-executables-concepts.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-245">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
2.  <span data-ttu-id="cc27b-246">如果 **B** 使用的分发数据库仍可用，请运行分发代理以同步数据库 **B** 和 **A** 之间的订阅以及数据库 B 和 **C** 之间的订阅。转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-246">If the distribution database that **B** uses is still available, run Distribution Agents to synchronize subscriptions between databases **B** and **A** and databases and B and **C**. Go to step 3.</span></span>  
  
3.  <span data-ttu-id="cc27b-247">通过在 **B** 的分发数据库上执行 [sp_removedistpublisherdbreplication](/sql/relational-databases/system-stored-procedures/sp-removedistpublisherdbreplication-transact-sql)，从 **B** 使用的分发数据库中删除元数据。转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-247">Remove metadata from the distribution database that **B** uses by executing [sp_removedistpublisherdbreplication](/sql/relational-databases/system-stored-procedures/sp-removedistpublisherdbreplication-transact-sql) at the distribution database for **B**. Go to step 4.</span></span>  
  
4.  <span data-ttu-id="cc27b-248">在数据库 **A** 和 **C** 上，删除对数据库 **B** 上的发布的订阅。转到步骤 5。</span><span class="sxs-lookup"><span data-stu-id="cc27b-248">At databases **A** and **C**, drop the subscriptions to the publication at database **B**. Go to step 5.</span></span>  
  
     <span data-ttu-id="cc27b-249">有关如何删除订阅的详细信息，请参阅 [Subscribe to Publications](../subscribe-to-publications.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-249">For more information about how to drop subscriptions, see [Subscribe to Publications](../subscribe-to-publications.md).</span></span>  
  
5.  <span data-ttu-id="cc27b-250">对数据库 **A** 执行日志备份或完整备份。转到步骤 6。</span><span class="sxs-lookup"><span data-stu-id="cc27b-250">Perform a log backup or full backup of database **A**. Go to step 6.</span></span>  
  
6.  <span data-ttu-id="cc27b-251">在数据库 **B** 上还原数据库 **A** 的备份。数据库 **B** 现在具有数据库 **A** 的数据，但是不包含复制配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-251">Restore the backup of database **A** at database **B**. Database **B** now has the data from database **A**, but not the replication configuration.</span></span> <span data-ttu-id="cc27b-252">在将备份还原到其他服务器时，将删除复制；因此，已从数据库 **B** 中删除复制。转到步骤 7。</span><span class="sxs-lookup"><span data-stu-id="cc27b-252">When you restore a backup to another server, replication is removed; therefore, replication has been removed from database **B**. Go to step 7.</span></span>  
  
7.  <span data-ttu-id="cc27b-253">在数据库 **B** 上重新创建发布，然后重新创建数据库 **A** 和 **B** 之间的订阅。（在更后面的阶段处理涉及数据库 **C** 的订阅）。</span><span class="sxs-lookup"><span data-stu-id="cc27b-253">Re-create the publication at database **B**, and then re-create subscriptions between databases **A** and **B**. (Subscriptions that involve database **C** are handled at a later stage.).</span></span>  
  
    1.  <span data-ttu-id="cc27b-254">在数据库 **B** 上重新创建发布。转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-254">Re-create the publication at database **B**. Go to step b.</span></span>  
  
    2.  <span data-ttu-id="cc27b-255">在数据库**B**上重新创建对数据库**A**上的发布的订阅，同时指定该订阅应使用备份进行初始化 (值为 sp_addsubscription) 的参数的 "**使用备份进行初始化**" **@sync_type** 。 [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)</span><span class="sxs-lookup"><span data-stu-id="cc27b-255">Re-create the subscription at database **B** to the publication at database **A**, specifying that the subscription should be initialized with a backup (a value of **initialize with backup** for the **@sync_type** parameter of [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)).</span></span> <span data-ttu-id="cc27b-256">转到步骤 c。</span><span class="sxs-lookup"><span data-stu-id="cc27b-256">Go to step c.</span></span>  
  
    3.  <span data-ttu-id="cc27b-257">在数据库**a**上重新创建对数据库**B**上的发布的订阅，同时指定订阅服务器已包含数据 (仅 sp_addsubscription) 的参数的**复制支持** **@sync_type** 。 [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)</span><span class="sxs-lookup"><span data-stu-id="cc27b-257">Re-create the subscription at database **A** to the publication at database **B**, specifying that the Subscriber already has the data (a value of **replication support only** for the **@sync_type** parameter of [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)).</span></span> <span data-ttu-id="cc27b-258">转到步骤 8。</span><span class="sxs-lookup"><span data-stu-id="cc27b-258">Go to step 8.</span></span>  
  
8.  <span data-ttu-id="cc27b-259">运行分发代理以同步数据库 **A** 和 **B** 上的订阅。如果发布的表中有标识列，则转到步骤 9。</span><span class="sxs-lookup"><span data-stu-id="cc27b-259">Run the Distribution Agents to synchronize the subscriptions at databases **A** and **B**. If there are any identity columns in published tables, go to step 9.</span></span> <span data-ttu-id="cc27b-260">否则，转到步骤 10。</span><span class="sxs-lookup"><span data-stu-id="cc27b-260">If not, go to step 10.</span></span>  
  
9. <span data-ttu-id="cc27b-261">还原后，在数据库 **A** 中为每个表分配的标识范围也将在数据库 **B** 中使用。确保还原的数据库 **B** 已收到发生故障的数据库 **B** 中传播到数据库 **A** 和数据库 **C** 的所有更改；然后重设每个表的标识范围种子。</span><span class="sxs-lookup"><span data-stu-id="cc27b-261">After the restore, the identity range that you assigned for each table in database **A** would also be used in database **B**. Make sure that the restored database **B** has received all changes from the failed database **B** that were propagated to database **A** and database **C**; and then reseed the identity range for each table.</span></span>  
  
    1.  <span data-ttu-id="cc27b-262">在数据库**B**上执行[sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql)并检索 output 参数 **@request_id** 。</span><span class="sxs-lookup"><span data-stu-id="cc27b-262">Execute [sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql) at database **B** and retrieve the output parameter **@request_id**.</span></span> <span data-ttu-id="cc27b-263">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-263">Go to step b.</span></span>  
  
    2.  <span data-ttu-id="cc27b-264">默认情况下，分发代理设置为连续运行；因此，令牌应该自动发送到所有节点。</span><span class="sxs-lookup"><span data-stu-id="cc27b-264">By default, the Distribution Agent is set to run continuously; therefore, tokens should be sent to all nodes automatically.</span></span> <span data-ttu-id="cc27b-265">如果分发代理未以连续模式运行，请运行该代理。</span><span class="sxs-lookup"><span data-stu-id="cc27b-265">If the Distribution Agent is not running in continuous mode, run the agent.</span></span> <span data-ttu-id="cc27b-266">有关详细信息，请参阅[复制代理可执行文件概念](../concepts/replication-agent-executables-concepts.md)或[启动和停止复制代理 (SQL Server Management Studio)](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-266">For more information, see [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md) or [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span> <span data-ttu-id="cc27b-267">转到步骤 c。</span><span class="sxs-lookup"><span data-stu-id="cc27b-267">Go to step c.</span></span>  
  
    3.  <span data-ttu-id="cc27b-268">执行[sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql)，并提供 **@request_id** 在步骤 b 中检索到的值。</span><span class="sxs-lookup"><span data-stu-id="cc27b-268">Execute [sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql), providing the **@request_id** value retrieved in step b.</span></span> <span data-ttu-id="cc27b-269">请等到所有节点都指示它们已接收到对等请求。</span><span class="sxs-lookup"><span data-stu-id="cc27b-269">Wait until all nodes indicate they have received the peer request.</span></span> <span data-ttu-id="cc27b-270">转到步骤 d。</span><span class="sxs-lookup"><span data-stu-id="cc27b-270">Go to step d.</span></span>  
  
    4.  <span data-ttu-id="cc27b-271">使用 [DBCC CHECKIDENT](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) 在数据库 **B** 中对每个表重设种子以确保使用适当的范围。</span><span class="sxs-lookup"><span data-stu-id="cc27b-271">Use [DBCC CHECKIDENT](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) to reseed each table in database **B** to make sure that an appropriate range is used.</span></span> <span data-ttu-id="cc27b-272">转到步骤 10。</span><span class="sxs-lookup"><span data-stu-id="cc27b-272">Go to step 10.</span></span>  
  
     <span data-ttu-id="cc27b-273">有关如何管理标识范围的更多信息，请参阅[复制标识列](../publish/replicate-identity-columns.md)的“为手动标识范围管理分配范围”部分。</span><span class="sxs-lookup"><span data-stu-id="cc27b-273">For more information about how to manage identity ranges, see the "Assigning ranges for manual identity range management" section of [Replicate Identity Columns](../publish/replicate-identity-columns.md).</span></span>  
  
10. <span data-ttu-id="cc27b-274">此时，数据库 **B** 和数据库 **C** 没有直接连接，但它们将通过数据库 **A** 接收更改。如果拓扑包含任何运行 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 的节点，则转到步骤 11；否则转到步骤 12。</span><span class="sxs-lookup"><span data-stu-id="cc27b-274">At this point, database **B** and database **C** are not directly connected, but they will receive changes through database **A**. If the topology contains any nodes that are running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], go to step 11; otherwise, go to step 12.</span></span>  
  
11. <span data-ttu-id="cc27b-275">静默系统，在数据库 **B** 和 **C** 之间重新创建订阅。使系统静默包括停止对所有节点上已发布的表执行活动，并确保每个节点都已收到来自所有其他节点的所有更改。</span><span class="sxs-lookup"><span data-stu-id="cc27b-275">Quiesce the system, and then re-create the subscription between databases **B** and **C**. Quiescing a system involves stopping activity on published tables at all nodes and making sure of that each node has received all changes from all other nodes.</span></span>  
  
    1.  <span data-ttu-id="cc27b-276">停止对等拓扑中已发布表上的所有活动。</span><span class="sxs-lookup"><span data-stu-id="cc27b-276">Stop all activity on published tables in the peer-to-peer topology.</span></span> <span data-ttu-id="cc27b-277">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-277">Go to step b.</span></span>  
  
    2.  <span data-ttu-id="cc27b-278">在数据库**B**上执行[sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql)并检索 output 参数 **@request_id** 。</span><span class="sxs-lookup"><span data-stu-id="cc27b-278">Execute [sp_requestpeerresponse](/sql/relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql) at database **B** and retrieve the output parameter **@request_id**.</span></span> <span data-ttu-id="cc27b-279">转到步骤 c。</span><span class="sxs-lookup"><span data-stu-id="cc27b-279">Go to step c.</span></span>  
  
    3.  <span data-ttu-id="cc27b-280">默认情况下，分发代理设置为连续运行；因此，令牌应该自动发送到所有节点。</span><span class="sxs-lookup"><span data-stu-id="cc27b-280">By default, the Distribution Agent is set to run continuously; therefore, tokens should be sent to all nodes automatically.</span></span> <span data-ttu-id="cc27b-281">如果分发代理未以连续模式运行，请运行该代理。</span><span class="sxs-lookup"><span data-stu-id="cc27b-281">If the Distribution Agent is not running in continuous mode, run the agent.</span></span> <span data-ttu-id="cc27b-282">转到步骤 d。</span><span class="sxs-lookup"><span data-stu-id="cc27b-282">Go to step d.</span></span>  
  
    4.  <span data-ttu-id="cc27b-283">执行[sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql)，并提供 **@request_id** 在步骤 b 中检索到的值。</span><span class="sxs-lookup"><span data-stu-id="cc27b-283">Execute [sp_helppeerresponses](/sql/relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql), providing the **@request_id** value retrieved in step b.</span></span> <span data-ttu-id="cc27b-284">请等到所有节点都指示它们已接收到对等请求。</span><span class="sxs-lookup"><span data-stu-id="cc27b-284">Wait until all nodes indicate they have received the peer request.</span></span> <span data-ttu-id="cc27b-285">转到步骤 e。</span><span class="sxs-lookup"><span data-stu-id="cc27b-285">Go to step e.</span></span>  
  
    5.  <span data-ttu-id="cc27b-286">在数据库 **B** 上重新创建对数据库 **C**上的发布的订阅，同时指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-286">Re-create the subscription at database **B** to the publication at database **C**, specifying that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-287">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-287">Go to step b.</span></span>  
  
    6.  <span data-ttu-id="cc27b-288">在数据库 **C** 上重新创建对数据库 **B**上的发布的订阅，同时指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-288">Re-create the subscription at database **C** to the publication at database **B**, specifying that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-289">转到步骤 13。</span><span class="sxs-lookup"><span data-stu-id="cc27b-289">Go to step 13.</span></span>  
  
12. <span data-ttu-id="cc27b-290">在数据库 **B** 和 **C**之间重新创建订阅：</span><span class="sxs-lookup"><span data-stu-id="cc27b-290">Re-create the subscription between databases **B** and **C**:</span></span>  
  
    1.  <span data-ttu-id="cc27b-291">在数据库 **B**上，查询 [MSpeer_lsns](/sql/relational-databases/system-tables/mspeer-lsns-transact-sql) 表，以检索数据库 **B** 从 **C**收到的最近事务的日志序列号 (LSN)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-291">At database **B**, query the [MSpeer_lsns](/sql/relational-databases/system-tables/mspeer-lsns-transact-sql) table to retrieve the log sequence number (LSN) of the most recent transaction that database **B** has received from database **C**.</span></span>  
  
    2.  <span data-ttu-id="cc27b-292">在数据库**B**上重新创建对数据库**C**上的发布的订阅，同时指定该订阅应基于 lsn 进行初始化 (sp_addsubscription) 的参数的值**初始化**。 **@sync_type** [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)</span><span class="sxs-lookup"><span data-stu-id="cc27b-292">Re-create the subscription at database **B** to the publication at database **C**, specifying that the subscription should be initialized based on LSN (a value of **initialize from lsn** for the **@sync_type** parameter of [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql)).</span></span> <span data-ttu-id="cc27b-293">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-293">Go to step b.</span></span>  
  
    3.  <span data-ttu-id="cc27b-294">在数据库 **C** 上重新创建对数据库 **B**上的发布的订阅，同时指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-294">Re-create the subscription at database **C** to the publication at database **B**, specifying that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-295">转到步骤 13。</span><span class="sxs-lookup"><span data-stu-id="cc27b-295">Go to step 13.</span></span>  
  
13. <span data-ttu-id="cc27b-296">运行分发代理以同步数据库 **B** 和 **C** 上的订阅。还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-296">Run the Distribution Agents to synchronize the subscriptions at databases **B** and **C**. The restore is completed.</span></span>  
  
#### <a name="msdb-database-publisher"></a><span data-ttu-id="cc27b-297">msdb 数据库（发布服务器）</span><span class="sxs-lookup"><span data-stu-id="cc27b-297">msdb Database (Publisher)</span></span>  
  
1.  <span data-ttu-id="cc27b-298">还原 **msdb** 数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-298">Restore the latest backup of the **msdb** database.</span></span>  
  
2.  <span data-ttu-id="cc27b-299">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-299">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-300">它是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-300">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-301">如果是，则恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-301">If yes, recovery is completed.</span></span> <span data-ttu-id="cc27b-302">如果不是，则转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-302">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="cc27b-303">从复制脚本重新创建订阅清除作业。</span><span class="sxs-lookup"><span data-stu-id="cc27b-303">Re-create the subscription cleanup job from your replication scripts.</span></span> <span data-ttu-id="cc27b-304">恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-304">Recovery is completed.</span></span>  
  
#### <a name="master-database-publisher"></a><span data-ttu-id="cc27b-305">master 数据库（发布服务器）</span><span class="sxs-lookup"><span data-stu-id="cc27b-305">master Database (Publisher)</span></span>  
  
1.  <span data-ttu-id="cc27b-306">还原 **master** 数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-306">Restore the latest backup of the **master** database.</span></span>  
  
2.  <span data-ttu-id="cc27b-307">确保该数据库在复制配置和设置方面与发布数据库一致。</span><span class="sxs-lookup"><span data-stu-id="cc27b-307">Make sure that the database is consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
### <a name="databases-at-the-distributor"></a><span data-ttu-id="cc27b-308">分发服务器上的数据库</span><span class="sxs-lookup"><span data-stu-id="cc27b-308">Databases at the Distributor</span></span>  
  
#### <a name="distribution-database"></a><span data-ttu-id="cc27b-309">分发数据库</span><span class="sxs-lookup"><span data-stu-id="cc27b-309">Distribution Database</span></span>  
  
1.  <span data-ttu-id="cc27b-310">还原分发数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-310">Restore the latest backup of the distribution database.</span></span>  
  
2.  <span data-ttu-id="cc27b-311">是否在故障发生前对分发数据库启用了 **sync with backup** 设置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-311">Was the **sync with backup** setting enabled on the distribution database before the failure?</span></span> <span data-ttu-id="cc27b-312">如果是，则转到步骤 3；如果不是，则转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-312">If yes, go to step 3; if no, go to step 4.</span></span>  
  
     <span data-ttu-id="cc27b-313">如果此设置已启用，查询 `SELECT DATABASEPROPERTYEX('<DistributionDatabaseName>', 'IsSyncWithBackup')` 将返回“1”。</span><span class="sxs-lookup"><span data-stu-id="cc27b-313">If the setting is enabled, the query `SELECT DATABASEPROPERTYEX('<DistributionDatabaseName>', 'IsSyncWithBackup')` returns '1'.</span></span>  
  
3.  <span data-ttu-id="cc27b-314">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-314">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-315">它是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-315">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-316">如果是，则恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-316">If yes, recovery is completed.</span></span> <span data-ttu-id="cc27b-317">如果不是，则转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-317">If no, go to step 4.</span></span>  
  
4.  <span data-ttu-id="cc27b-318">已还原的分发数据库中的配置信息不是最新的，或未对分发数据库设置 **sync with backup** 选项。</span><span class="sxs-lookup"><span data-stu-id="cc27b-318">Either the configuration information in the restored distribution database is not up-to-date, or the **sync with backup** option was not set on the distribution database.</span></span> <span data-ttu-id="cc27b-319">（还原后，分发数据库可能会丢失已在发布服务器上提交但尚未传递到订阅服务器的事务）。删除并重新创建复制，然后运行验证。</span><span class="sxs-lookup"><span data-stu-id="cc27b-319">(After the restore, the distribution database might be missing transactions that were committed at the Publisher but have not yet been delivered to Subscribers.) Drop and re-create replication, and then run validation.</span></span>  
  
    1.  <span data-ttu-id="cc27b-320">从发布服务器、分发服务器和订阅服务器中删除复制配置，然后重新创建配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-320">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="cc27b-321">重新创建订阅时，指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-321">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-322">转到步骤 b。</span><span class="sxs-lookup"><span data-stu-id="cc27b-322">Go to step b.</span></span>  
  
         <span data-ttu-id="cc27b-323">有关如何删除复制的详细信息，请参阅 [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-323">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
         <span data-ttu-id="cc27b-324">有关如何指定订阅服务器已包含数据的详细信息，请参阅 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-324">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
    2.  <span data-ttu-id="cc27b-325">将所有发布标记为要验证。</span><span class="sxs-lookup"><span data-stu-id="cc27b-325">Mark all publications for validation.</span></span> <span data-ttu-id="cc27b-326">重新初始化所有验证失败的订阅。</span><span class="sxs-lookup"><span data-stu-id="cc27b-326">Reinitialize any subscriptions that fail validation.</span></span> <span data-ttu-id="cc27b-327">恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-327">Recovery is completed.</span></span>  
  
         <span data-ttu-id="cc27b-328">有关验证的详细信息，请参阅 [Validate Replicated Data](../validate-data-at-the-subscriber.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-328">For more information about validation, see [Validate Replicated Data](../validate-data-at-the-subscriber.md).</span></span> <span data-ttu-id="cc27b-329">有关重新初始化的详细信息，请参阅[重新初始化订阅](../reinitialize-subscriptions.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-329">For more information about reinitialization, see [Reinitialize Subscriptions](../reinitialize-subscriptions.md).</span></span>  
  
#### <a name="msdb-database-distributor"></a><span data-ttu-id="cc27b-330">msdb 数据库（分发服务器）</span><span class="sxs-lookup"><span data-stu-id="cc27b-330">msdb Database (Distributor)</span></span>  
  
1.  <span data-ttu-id="cc27b-331">还原 **msdb** 数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-331">Restore the latest backup of the **msdb** database.</span></span>  
  
2.  <span data-ttu-id="cc27b-332">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-332">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-333">它是否包含所有发布和订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-333">Does it contain the latest configuration for all publications and subscriptions?</span></span> <span data-ttu-id="cc27b-334">如果是，则恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-334">If yes, recovery is completed.</span></span> <span data-ttu-id="cc27b-335">如果不是，则转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-335">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="cc27b-336">从发布服务器、分发服务器和订阅服务器中删除复制配置，然后重新创建配置。</span><span class="sxs-lookup"><span data-stu-id="cc27b-336">Remove the replication configuration from the Publisher, Distributor and Subscribers, and then re-create the configuration.</span></span> <span data-ttu-id="cc27b-337">重新创建订阅时，指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-337">When you re-create subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-338">转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-338">Go to step 4.</span></span>  
  
     <span data-ttu-id="cc27b-339">有关如何删除复制的详细信息，请参阅 [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-339">For more information about how to remove replication, see [sp_removedbreplication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql).</span></span>  
  
     <span data-ttu-id="cc27b-340">有关如何指定订阅服务器已包含数据的详细信息，请参阅 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-340">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
4.  <span data-ttu-id="cc27b-341">将所有发布标记为要验证。</span><span class="sxs-lookup"><span data-stu-id="cc27b-341">Mark all publications for validation.</span></span> <span data-ttu-id="cc27b-342">重新初始化所有验证失败的订阅。</span><span class="sxs-lookup"><span data-stu-id="cc27b-342">Reinitialize any subscriptions that fail validation.</span></span> <span data-ttu-id="cc27b-343">恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-343">Recovery is completed.</span></span>  
  
     <span data-ttu-id="cc27b-344">有关验证的详细信息，请参阅 [Validate Replicated Data](../validate-data-at-the-subscriber.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-344">For more information about validation, see [Validate Replicated Data](../validate-data-at-the-subscriber.md).</span></span> <span data-ttu-id="cc27b-345">有关重新初始化的详细信息，请参阅[重新初始化订阅](../reinitialize-subscriptions.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-345">For more information about reinitialization, see [Reinitialize Subscriptions](../reinitialize-subscriptions.md).</span></span>  
  
#### <a name="master-database-distributor"></a><span data-ttu-id="cc27b-346">master 数据库（分发服务器）</span><span class="sxs-lookup"><span data-stu-id="cc27b-346">master Database (Distributor)</span></span>  
  
1.  <span data-ttu-id="cc27b-347">还原 **master** 数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-347">Restore the latest backup of the **master** database.</span></span>  
  
2.  <span data-ttu-id="cc27b-348">确保该数据库在复制配置和设置方面与发布数据库一致。</span><span class="sxs-lookup"><span data-stu-id="cc27b-348">Make sure that the database is consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
### <a name="databases-at-the-subscriber"></a><span data-ttu-id="cc27b-349">订阅服务器上的数据库</span><span class="sxs-lookup"><span data-stu-id="cc27b-349">Databases at the Subscriber</span></span>  
  
#### <a name="subscription-database"></a><span data-ttu-id="cc27b-350">订阅数据库</span><span class="sxs-lookup"><span data-stu-id="cc27b-350">Subscription Database</span></span>  
  
1.  <span data-ttu-id="cc27b-351">最新的订阅数据库备份是否晚于分发数据库上的最小分发保持期设置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-351">Is the latest subscription database backup more recent than the minimum distribution retention setting on the distribution database?</span></span> <span data-ttu-id="cc27b-352">（这可确定分发服务器是否仍具有使订阅服务器保持最新所需的所有命令？）如果是，则转到步骤 2。</span><span class="sxs-lookup"><span data-stu-id="cc27b-352">(This determines whether the Distributor still has all the commands that are required to bring the Subscriber up-to-date.) If yes, go to step 2.</span></span> <span data-ttu-id="cc27b-353">如果否，则重新初始化订阅。</span><span class="sxs-lookup"><span data-stu-id="cc27b-353">If no, reinitialize the subscription.</span></span> <span data-ttu-id="cc27b-354">恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-354">Recovery is completed.</span></span>  
  
     <span data-ttu-id="cc27b-355">若要确定最大分发保持期设置，请执行 [sp_helpdistributiondb](/sql/relational-databases/system-stored-procedures/sp-helpdistributiondb-transact-sql) ，并从 **max_distretention** 列检索值（此值以小时为单位）。</span><span class="sxs-lookup"><span data-stu-id="cc27b-355">To determine the maximum distribution retention setting, execute [sp_helpdistributiondb](/sql/relational-databases/system-stored-procedures/sp-helpdistributiondb-transact-sql) and retrieve the value from the **max_distretention** column (this value is in hours).</span></span>  
  
     <span data-ttu-id="cc27b-356">有关如何重新初始化订阅的详细信息，请参阅 [Reinitialize a Subscription](../reinitialize-a-subscription.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-356">For more information about how to reinitialize a subscription, see [Reinitialize a Subscription](../reinitialize-a-subscription.md).</span></span>  
  
2.  <span data-ttu-id="cc27b-357">还原订阅数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-357">Restore the latest subscription database backup.</span></span> <span data-ttu-id="cc27b-358">转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-358">Go to step 3.</span></span>  
  
3.  <span data-ttu-id="cc27b-359">如果订阅数据库仅包含推送订阅，则转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-359">If the subscription database contains only push subscriptions, go to step 4.</span></span> <span data-ttu-id="cc27b-360">如果订阅数据库包含任何请求订阅，则询问以下问题：订阅信息是否是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-360">If the subscription database contains any pull subscriptions, ask the following questions: Is the subscription information current?</span></span> <span data-ttu-id="cc27b-361">数据库是否包含故障发生时设置的所有表和选项？</span><span class="sxs-lookup"><span data-stu-id="cc27b-361">Does the database include all tables and options that were set at the time of failure.</span></span> <span data-ttu-id="cc27b-362">如果是，则转到步骤 4。</span><span class="sxs-lookup"><span data-stu-id="cc27b-362">If yes, go to step 4.</span></span> <span data-ttu-id="cc27b-363">如果否，则重新初始化订阅。</span><span class="sxs-lookup"><span data-stu-id="cc27b-363">If no, reinitialize the subscription.</span></span> <span data-ttu-id="cc27b-364">恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-364">Recovery is completed.</span></span>  
  
4.  <span data-ttu-id="cc27b-365">若要同步订阅服务器，运行分发代理。</span><span class="sxs-lookup"><span data-stu-id="cc27b-365">To synchronize the Subscriber, run the Distribution Agent.</span></span> <span data-ttu-id="cc27b-366">恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-366">Recovery is completed.</span></span>  
  
     <span data-ttu-id="cc27b-367">有关如何运行分发代理的详细信息，请参阅[启动和停止复制代理 &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) 和[复制代理可执行文件概念](../concepts/replication-agent-executables-concepts.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-367">For more information about how to run the Distribution Agent, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) and [Replication Agent Executables Concepts](../concepts/replication-agent-executables-concepts.md).</span></span>  
  
#### <a name="msdb-database-subscriber"></a><span data-ttu-id="cc27b-368">msdb 数据库（订阅服务器）</span><span class="sxs-lookup"><span data-stu-id="cc27b-368">msdb Database (Subscriber)</span></span>  
  
1.  <span data-ttu-id="cc27b-369">还原 **msdb** 数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-369">Restore the latest backup of the **msdb** database.</span></span> <span data-ttu-id="cc27b-370">是否在此订阅服务器上使用请求订阅？</span><span class="sxs-lookup"><span data-stu-id="cc27b-370">Are pull subscriptions used at this Subscriber?</span></span> <span data-ttu-id="cc27b-371">如果是，则还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-371">If no, the restore is completed.</span></span> <span data-ttu-id="cc27b-372">如果是，则转到步骤 2。</span><span class="sxs-lookup"><span data-stu-id="cc27b-372">If yes, go to step 2.</span></span>  
  
2.  <span data-ttu-id="cc27b-373">还原的备份是否已完成并且是最新的？</span><span class="sxs-lookup"><span data-stu-id="cc27b-373">Is the restored backup complete and up-to-date?</span></span> <span data-ttu-id="cc27b-374">它是否包含所有请求订阅的最新配置？</span><span class="sxs-lookup"><span data-stu-id="cc27b-374">Does it contain the latest configuration for all pull subscriptions?</span></span> <span data-ttu-id="cc27b-375">如果是，则恢复完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-375">If yes, recovery is completed.</span></span> <span data-ttu-id="cc27b-376">如果不是，则转到步骤 3。</span><span class="sxs-lookup"><span data-stu-id="cc27b-376">If no, go to step 3.</span></span>  
  
3.  <span data-ttu-id="cc27b-377">删除并重新创建请求订阅。</span><span class="sxs-lookup"><span data-stu-id="cc27b-377">Drop and re-create the pull subscriptions.</span></span> <span data-ttu-id="cc27b-378">重新创建订阅时，指定订阅服务器已包含数据。</span><span class="sxs-lookup"><span data-stu-id="cc27b-378">When you re-create the subscriptions, specify that the Subscriber already has the data.</span></span> <span data-ttu-id="cc27b-379">还原完成。</span><span class="sxs-lookup"><span data-stu-id="cc27b-379">The restore is completed.</span></span>  
  
     <span data-ttu-id="cc27b-380">有关如何删除订阅的详细信息，请参阅 [Subscribe to Publications](../subscribe-to-publications.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-380">For more information about how to drop subscriptions, see [Subscribe to Publications](../subscribe-to-publications.md).</span></span>  
  
     <span data-ttu-id="cc27b-381">有关如何指定订阅服务器已包含数据的详细信息，请参阅 [Initialize a Subscription Manually](../initialize-a-subscription-manually.md)。</span><span class="sxs-lookup"><span data-stu-id="cc27b-381">For more information about how to specify that the Subscriber already has the data, see [Initialize a Subscription Manually](../initialize-a-subscription-manually.md).</span></span>  
  
#### <a name="master-database-subscriber"></a><span data-ttu-id="cc27b-382">master 数据库（订阅服务器）</span><span class="sxs-lookup"><span data-stu-id="cc27b-382">master Database (Subscriber)</span></span>  
  
1.  <span data-ttu-id="cc27b-383">还原 **master** 数据库的最新备份。</span><span class="sxs-lookup"><span data-stu-id="cc27b-383">Restore the latest backup of the **master** database.</span></span>  
  
2.  <span data-ttu-id="cc27b-384">确保该数据库在复制配置和设置方面与发布数据库一致。</span><span class="sxs-lookup"><span data-stu-id="cc27b-384">Make sure that the database is consistent with the publication database with regard to replication configuration and settings.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="cc27b-385">另请参阅</span><span class="sxs-lookup"><span data-stu-id="cc27b-385">See Also</span></span>  
 <span data-ttu-id="cc27b-386">[SQL Server 数据库的备份和还原](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="cc27b-386">[Back Up and Restore of SQL Server Databases](../../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 <span data-ttu-id="cc27b-387">[备份和还原复制的数据库](back-up-and-restore-replicated-databases.md) </span><span class="sxs-lookup"><span data-stu-id="cc27b-387">[Back Up and Restore Replicated Databases](back-up-and-restore-replicated-databases.md) </span></span>  
 <span data-ttu-id="cc27b-388">[“配置分发”](../configure-distribution.md) </span><span class="sxs-lookup"><span data-stu-id="cc27b-388">[Configure Distribution](../configure-distribution.md) </span></span>  
 <span data-ttu-id="cc27b-389">[发布数据和数据库对象](../publish/publish-data-and-database-objects.md) </span><span class="sxs-lookup"><span data-stu-id="cc27b-389">[Publish Data and Database Objects](../publish/publish-data-and-database-objects.md) </span></span>  
 <span data-ttu-id="cc27b-390">[Subscribe to Publications](../subscribe-to-publications.md) </span><span class="sxs-lookup"><span data-stu-id="cc27b-390">[Subscribe to Publications](../subscribe-to-publications.md) </span></span>  
 <span data-ttu-id="cc27b-391">[初始化订阅](../initialize-a-subscription.md) </span><span class="sxs-lookup"><span data-stu-id="cc27b-391">[Initialize a Subscription](../initialize-a-subscription.md) </span></span>  
 [<span data-ttu-id="cc27b-392">同步数据</span><span class="sxs-lookup"><span data-stu-id="cc27b-392">Synchronize Data</span></span>](../synchronize-data.md)  
  
  

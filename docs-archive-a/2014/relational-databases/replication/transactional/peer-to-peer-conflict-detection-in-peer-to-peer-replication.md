---
title: 对等复制中的冲突检测 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- transactional replication, peer-to-peer replication
- peer-to-peer transactional replication, conflict detection
ms.assetid: 754a1070-59bc-438d-998b-97fdd77d45ca
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 301a751bf5b5959ab1fc434ac2a583a6b0378fdd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87587330"
---
# <a name="conflict-detection-in-peer-to-peer-replication"></a><span data-ttu-id="52ae3-102">对等复制中的冲突检测</span><span class="sxs-lookup"><span data-stu-id="52ae3-102">Conflict Detection in Peer-to-Peer Replication</span></span>
  <span data-ttu-id="52ae3-103">通过对等事务复制，可以在拓扑中的任何节点插入、更新或删除数据并将数据更改传播到其他节点。</span><span class="sxs-lookup"><span data-stu-id="52ae3-103">Peer-to-peer transactional replication lets you insert, update, or delete data at any node in a topology and have data changes propagated to the other nodes.</span></span> <span data-ttu-id="52ae3-104">由于可在任何节点上更改数据，因此在不同节点上进行的数据更改可能会相互冲突。</span><span class="sxs-lookup"><span data-stu-id="52ae3-104">Because you can change data at any node, data changes at different nodes could conflict with each other.</span></span> <span data-ttu-id="52ae3-105">如果在多个节点上修改了某一行，则将该行传播给其他节点时会导致冲突甚至丢失更新。</span><span class="sxs-lookup"><span data-stu-id="52ae3-105">If a row is modified at more than one node, it can cause a conflict or even a lost update when the row is propagated to other nodes.</span></span>  
  
 <span data-ttu-id="52ae3-106">[!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] 和更高版本中的对等复制提供了在对等拓扑中启用冲突检测的选项。</span><span class="sxs-lookup"><span data-stu-id="52ae3-106">Peer-to-peer replication in [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] and later versions provides the option to enable conflict detection across a peer-to-peer topology.</span></span> <span data-ttu-id="52ae3-107">此选项将有助于防止出现因未检测到的冲突而引发的各种问题，包括不一致的应用程序行为和丢失的更新。</span><span class="sxs-lookup"><span data-stu-id="52ae3-107">This option would help prevent the issues that are caused by undetected conflicts, including inconsistent application behavior and lost updates.</span></span> <span data-ttu-id="52ae3-108">启用该选项后，默认情况下，发生冲突的更改将被视为导致分发代理失败的关键错误。</span><span class="sxs-lookup"><span data-stu-id="52ae3-108">With this option enabled, by default a conflicting change is treated as a critical error that causes the failure of the Distribution Agent.</span></span> <span data-ttu-id="52ae3-109">发生冲突时，拓扑将始终处于不一致的状态，直至冲突得以解决而且拓扑中的数据保持一致。</span><span class="sxs-lookup"><span data-stu-id="52ae3-109">In the event of a conflict, the topology remains in an inconsistent state until the conflict is resolved and the data is made consistent across the topology.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="52ae3-110">为了避免潜在的数据不一致性，即便已经启用了冲突检测功能，也应尽力避免对等拓扑中发生冲突。</span><span class="sxs-lookup"><span data-stu-id="52ae3-110">To avoid potential data inconsistency, make sure that you avoid conflicts in a peer-to-peer topology, even with conflict detection enabled.</span></span> <span data-ttu-id="52ae3-111">为了确保仅在某一个节点上执行特定行的写入操作，访问并更改数据的应用程序必须对其插入、更新和删除操作进行分区。</span><span class="sxs-lookup"><span data-stu-id="52ae3-111">To ensure that write operations for a particular row are performed at only one node, applications that access and change data must partition insert, update, and delete operations.</span></span> <span data-ttu-id="52ae3-112">分区可确保在一个节点上对给定行进行的修改可以在其他节点修改该行之前，与拓扑中的所有其他节点同步。</span><span class="sxs-lookup"><span data-stu-id="52ae3-112">This partitioning ensures that modifications to a given row that is originating at one node are synchronized with all other nodes in the topology before the row is modified by a different node.</span></span> <span data-ttu-id="52ae3-113">如果应用程序需要完善的冲突检测与解决功能，请使用合并复制。</span><span class="sxs-lookup"><span data-stu-id="52ae3-113">If an application requires sophisticated conflict detection and resolution capabilities, use merge replication.</span></span> <span data-ttu-id="52ae3-114">有关详细信息，请参阅[合并复制](../merge/merge-replication.md)和[检测并解决合并复制冲突](../merge/advanced-merge-replication-conflict-detection-and-resolution.md)。</span><span class="sxs-lookup"><span data-stu-id="52ae3-114">For more information, see [Merge Replication](../merge/merge-replication.md) and [Detect and Resolve Merge Replication Conflicts](../merge/advanced-merge-replication-conflict-detection-and-resolution.md).</span></span>  
  
## <a name="understanding-conflicts-and-conflict-detection"></a><span data-ttu-id="52ae3-115">了解冲突和冲突检测</span><span class="sxs-lookup"><span data-stu-id="52ae3-115">Understanding Conflicts and Conflict Detection</span></span>  
 <span data-ttu-id="52ae3-116">在单个数据库中，不同应用程序对同一行进行的更改不会导致冲突。</span><span class="sxs-lookup"><span data-stu-id="52ae3-116">In a single database, changes that are made to the same row by different applications do not cause a conflict.</span></span> <span data-ttu-id="52ae3-117">原因在于，事务已经过序列化，并使用锁定来处理并发更改。</span><span class="sxs-lookup"><span data-stu-id="52ae3-117">This is because transactions are serialized, and locks are used to handle concurrent changes.</span></span> <span data-ttu-id="52ae3-118">在异步分布式系统（如对等复制）中，事务独立作用于每个节点，而且没有用来跨多个节点对事务进行序列化的机制。</span><span class="sxs-lookup"><span data-stu-id="52ae3-118">In an asynchronous distributed system such as peer-to-peer replication, transactions act independently on each node; and there is no mechanism to serialize transactions across multiple nodes.</span></span> <span data-ttu-id="52ae3-119">可以使用两阶段提交之类的协议，但是这会显著影响性能。</span><span class="sxs-lookup"><span data-stu-id="52ae3-119">A protocol like two-phase commit could be used, but this affects performance significantly.</span></span>  
  
 <span data-ttu-id="52ae3-120">在对等复制之类的系统中，在单个对等节点上提交更改之后将检测不到冲突。</span><span class="sxs-lookup"><span data-stu-id="52ae3-120">In systems such as peer-to-peer replication, conflicts are not detected when changes are committed at individual peers.</span></span> <span data-ttu-id="52ae3-121">相反，在复制这些更改并将其应用于其他对等节点之后，才能够检测到这些更改。</span><span class="sxs-lookup"><span data-stu-id="52ae3-121">Instead, they are detected when those changes are replicated and applied at other peers.</span></span> <span data-ttu-id="52ae3-122">在对等复制中，用来将更改应用于每个节点的存储过程会基于每个已发布表中的某个隐藏列来检测冲突。</span><span class="sxs-lookup"><span data-stu-id="52ae3-122">In peer-to-peer replication, conflicts are detected by the stored procedures that apply changes to each node, based on a hidden column in each published table.</span></span> <span data-ttu-id="52ae3-123">该隐藏列所存储的 ID 将您为每个节点指定的“  发起方 ID”与行版本结合起来。</span><span class="sxs-lookup"><span data-stu-id="52ae3-123">This hidden column stores an ID that combines an *originator ID* that you specify for each node and the version of the row.</span></span> <span data-ttu-id="52ae3-124">在同步期间，分发代理会针对每个表执行同步过程。</span><span class="sxs-lookup"><span data-stu-id="52ae3-124">During synchronization, the Distribution Agent executes procedures for each table.</span></span> <span data-ttu-id="52ae3-125">这些过程会应用来自其他对等节点的插入、更新和删除操作。</span><span class="sxs-lookup"><span data-stu-id="52ae3-125">These procedures apply insert, update, and delete operations from other peers.</span></span> <span data-ttu-id="52ae3-126">如果某个过程在读取该隐藏列的值时检测到冲突，将会引发严重级别为 16 的错误 22815：</span><span class="sxs-lookup"><span data-stu-id="52ae3-126">If one of the procedures detects a conflict when it reads the hidden column value, it raises error 22815 that has a severity level of 16:</span></span>  
  
 `A conflict of type '%s' was detected at peer %d between peer %d (incoming), transaction id %s  and peer %d (on disk), transaction id %s`  
  
 <span data-ttu-id="52ae3-127">默认情况下，此错误会导致分发代理停止向该节点应用所做的更改。</span><span class="sxs-lookup"><span data-stu-id="52ae3-127">By default, this error causes the Distribution Agent to stop applying changes to that node.</span></span> <span data-ttu-id="52ae3-128">有关如何处理所检测到冲突的信息，请参阅本主题稍后部分中的“处理冲突”。</span><span class="sxs-lookup"><span data-stu-id="52ae3-128">For information about how to handle the conflicts that are detected, see "Handling Conflicts" later in this topic.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="52ae3-129">隐藏列只能由通过专用管理员连接 (DAC) 登录的用户来访问。</span><span class="sxs-lookup"><span data-stu-id="52ae3-129">The hidden column can be accessed only by a user that is logged in through the Dedicated Administrator Connection (DAC).</span></span> <span data-ttu-id="52ae3-130">有关 DAC 的信息，请参阅[用于数据库管理员的诊断连接](../../../database-engine/configure-windows/diagnostic-connection-for-database-administrators.md)。</span><span class="sxs-lookup"><span data-stu-id="52ae3-130">For information about DAC, see [Diagnostic Connection for Database Administrators](../../../database-engine/configure-windows/diagnostic-connection-for-database-administrators.md).</span></span>  
  
 <span data-ttu-id="52ae3-131">对等复制检测到下列类型的冲突：</span><span class="sxs-lookup"><span data-stu-id="52ae3-131">Peer-to-peer replication detects the following types of conflicts:</span></span>  
  
-   <span data-ttu-id="52ae3-132">插入-插入</span><span class="sxs-lookup"><span data-stu-id="52ae3-132">Insert-insert</span></span>  
  
     <span data-ttu-id="52ae3-133">每个表中所有参与对等复制的行都使用主键值进行唯一标识。</span><span class="sxs-lookup"><span data-stu-id="52ae3-133">All rows in each table participating in peer-to-peer replication are uniquely identified by using primary key values.</span></span> <span data-ttu-id="52ae3-134">在将具有相同键值的行插入到多个节点时，会发生插入-插入冲突。</span><span class="sxs-lookup"><span data-stu-id="52ae3-134">An insert-insert conflict occurs when a row with the same key value was inserted at more than one node.</span></span>  
  
-   <span data-ttu-id="52ae3-135">更新-更新</span><span class="sxs-lookup"><span data-stu-id="52ae3-135">Update-update</span></span>  
  
     <span data-ttu-id="52ae3-136">在多个节点上更新了同一行时发生。</span><span class="sxs-lookup"><span data-stu-id="52ae3-136">Occurs when the same row was updated at more than one node.</span></span>  
  
-   <span data-ttu-id="52ae3-137">插入-更新</span><span class="sxs-lookup"><span data-stu-id="52ae3-137">Insert-update</span></span>  
  
     <span data-ttu-id="52ae3-138">在以下情况下发生：在一个节点上更新了某行，但是在另一个节点上删除了该行，然后又重新插入该行。</span><span class="sxs-lookup"><span data-stu-id="52ae3-138">Occurs if a row was updated at one node, but the same row was deleted and then reinserted at another node.</span></span>  
  
-   <span data-ttu-id="52ae3-139">插入-删除</span><span class="sxs-lookup"><span data-stu-id="52ae3-139">Insert-delete</span></span>  
  
     <span data-ttu-id="52ae3-140">在以下情况下发生：在一个节点上删除了某行，但是在另一个节点上删除了该行，然后又重新插入该行。</span><span class="sxs-lookup"><span data-stu-id="52ae3-140">Occurs if a row was deleted at one node, but the same row was deleted and then reinserted at another node.</span></span>  
  
-   <span data-ttu-id="52ae3-141">更新-删除</span><span class="sxs-lookup"><span data-stu-id="52ae3-141">Update-delete</span></span>  
  
     <span data-ttu-id="52ae3-142">在以下情况下发生：在一个节点上更新了某行，但是在另一个节点上删除了该行。</span><span class="sxs-lookup"><span data-stu-id="52ae3-142">Occurs if a row was updated at one node, but the same row was deleted at another node.</span></span>  
  
-   <span data-ttu-id="52ae3-143">删除-删除</span><span class="sxs-lookup"><span data-stu-id="52ae3-143">Delete-delete</span></span>  
  
     <span data-ttu-id="52ae3-144">在多个节点上删除了同一行时发生。</span><span class="sxs-lookup"><span data-stu-id="52ae3-144">Occurs when a row was deleted at more than one node.</span></span>  
  
## <a name="enabling-conflict-detection"></a><span data-ttu-id="52ae3-145">启用冲突检测</span><span class="sxs-lookup"><span data-stu-id="52ae3-145">Enabling Conflict Detection</span></span>  
 <span data-ttu-id="52ae3-146">若要使用冲突检测，所有节点都必须运行 [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] 或更高版本；且必须为所有节点启用检测。</span><span class="sxs-lookup"><span data-stu-id="52ae3-146">To use conflict detection, all nodes must be running [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] or a later version; and detection must be enabled for all nodes.</span></span> <span data-ttu-id="52ae3-147">在 [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] 和更高版本中，默认情况下，冲突检测在 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]中处于启用状态。</span><span class="sxs-lookup"><span data-stu-id="52ae3-147">In [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] and later versions, by default, conflict detection is enabled in [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="52ae3-148">我们建议您启用冲突检测，即使在应当不会有任何冲突时也是如此。</span><span class="sxs-lookup"><span data-stu-id="52ae3-148">We recommend that you have detection enabled, even in scenarios in which you do not expect any conflicts.</span></span> <span data-ttu-id="52ae3-149">可以使用 [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] 或 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 存储过程来启用和禁用冲突检测：</span><span class="sxs-lookup"><span data-stu-id="52ae3-149">Conflict detection can be enabled and disabled by using [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] or [!INCLUDE[tsql](../../../includes/tsql-md.md)] stored procedures:</span></span>  
  
-   <span data-ttu-id="52ae3-150">在 [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] 中，可以使用 **“发布属性”** 对话框的 **“订阅选项”** 页或配置对等拓扑向导的 **“配置拓扑”** 页来启用和禁用冲突检测。</span><span class="sxs-lookup"><span data-stu-id="52ae3-150">You can enable and disable detection in [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] either by using the **Subscription Options** page of the **Publication Properties** dialog box or the **Configure Topology** page of the Configure Peer-to-Peer Topology Wizard.</span></span>  
  
     <span data-ttu-id="52ae3-151">如果您使用 [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)]来配置冲突检测，则分发代理将配置为在检测到冲突时停止应用所做的更改。</span><span class="sxs-lookup"><span data-stu-id="52ae3-151">If you configure conflict detection by using [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)], the Distribution Agent is configured to stop applying changes when a conflict is detected.</span></span>  
  
-   <span data-ttu-id="52ae3-152">还可以使用 [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql) 或 [sp_configure_peerconflictdetection](/sql/relational-databases/system-stored-procedures/sp-configure-peerconflictdetection-transact-sql)存储过程来启用和禁用冲突检测。</span><span class="sxs-lookup"><span data-stu-id="52ae3-152">You can also enable and disable detection by using the following stored procedures: [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql) or [sp_configure_peerconflictdetection](/sql/relational-databases/system-stored-procedures/sp-configure-peerconflictdetection-transact-sql).</span></span>  
  
     <span data-ttu-id="52ae3-153">如果您使用存储过程来配置冲突检测，则可以指定在检测到冲突时分发代理是否应当停止应用所做的更改。</span><span class="sxs-lookup"><span data-stu-id="52ae3-153">If you configure conflict detection by using stored procedures, you can specify whether the Distribution Agent should stop applying changes when a conflict is detected.</span></span> <span data-ttu-id="52ae3-154">默认值是让分发代理停止。</span><span class="sxs-lookup"><span data-stu-id="52ae3-154">The default is for the agent to stop.</span></span> <span data-ttu-id="52ae3-155">我们建议您使用默认设置。</span><span class="sxs-lookup"><span data-stu-id="52ae3-155">We recommend that you use the default setting.</span></span>  
  
## <a name="handling-conflicts"></a><span data-ttu-id="52ae3-156">处理冲突</span><span class="sxs-lookup"><span data-stu-id="52ae3-156">Handling Conflicts</span></span>  
 <span data-ttu-id="52ae3-157">对等复制中发生冲突时，会引发对等冲突检测警报。</span><span class="sxs-lookup"><span data-stu-id="52ae3-157">When a conflict occurs in peer-to-peer replication, the Peer-to-peer conflict detection alert is raised.</span></span> <span data-ttu-id="52ae3-158">我们建议您配置该警报，以便在发生冲突时获得通知。</span><span class="sxs-lookup"><span data-stu-id="52ae3-158">We recommend that you configure this alert so that you are notified when a conflict occurs.</span></span> <span data-ttu-id="52ae3-159">有关警报的详细信息，请参阅[对复制代理事件使用警报](../agents/use-alerts-for-replication-agent-events.md)。</span><span class="sxs-lookup"><span data-stu-id="52ae3-159">For more information about alerts, see [Use Alerts for Replication Agent Events](../agents/use-alerts-for-replication-agent-events.md).</span></span>  
  
 <span data-ttu-id="52ae3-160">在分发代理停止并且引发警报之后，请使用下列方法之一来处理所发生的冲突：</span><span class="sxs-lookup"><span data-stu-id="52ae3-160">After the Distribution Agent stops and the alert is raised, use one of the following approaches to handle the conflicts that occurred:</span></span>  
  
-   <span data-ttu-id="52ae3-161">从包含必需数据的节点的备份中重新初始化检测到冲突的节点（建议的方法）。</span><span class="sxs-lookup"><span data-stu-id="52ae3-161">Reinitialize the node where the conflict was detected from the backup of a node that contains the required data (the recommended approach).</span></span> <span data-ttu-id="52ae3-162">此方法可确保数据保持一致状态。</span><span class="sxs-lookup"><span data-stu-id="52ae3-162">This method ensures that data is in a consistent state.</span></span>  
  
-   <span data-ttu-id="52ae3-163">尝试通过允许分发代理继续应用所做的更改，再次同步节点：</span><span class="sxs-lookup"><span data-stu-id="52ae3-163">Try to synchronize the node again by enabling the Distribution Agent to continue to apply changes:</span></span>  
  
    1.  <span data-ttu-id="52ae3-164">执行[sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql)：指定参数的 "p2p_continue_onconflict" @property 和 `true` 参数的 @value 。</span><span class="sxs-lookup"><span data-stu-id="52ae3-164">Execute [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql): specify 'p2p_continue_onconflict' for the @property parameter and `true` for the @value parameter.</span></span>  
  
    2.  <span data-ttu-id="52ae3-165">重新启动分发代理。</span><span class="sxs-lookup"><span data-stu-id="52ae3-165">Restart the Distribution Agent.</span></span>  
  
    3.  <span data-ttu-id="52ae3-166">使用冲突查看器验证检测到的冲突，并确定所涉及的行、冲突类型以及入选方。</span><span class="sxs-lookup"><span data-stu-id="52ae3-166">Verify the conflicts that were detected by using the conflict viewer and determine the rows that were involved, the type of conflict, and the winner.</span></span> <span data-ttu-id="52ae3-167">冲突可基于您在配置过程中指定的发起方 ID 值来解决：源自具有最高 ID 的节点的行将在冲突中入选。</span><span class="sxs-lookup"><span data-stu-id="52ae3-167">The conflict is resolved based on the originator ID value that you specified during configuration: the row that originated at the node with the highest ID wins the conflict.</span></span> <span data-ttu-id="52ae3-168">有关详细信息，请参阅[查看事务发布的数据冲突 (SQL Server Management Studio)](../view-data-conflicts-for-transactional-publications-sql-server-management-studio.md)。</span><span class="sxs-lookup"><span data-stu-id="52ae3-168">For more information, see [View Data Conflicts for Transactional Publications &#40;SQL Server Management Studio&#41;](../view-data-conflicts-for-transactional-publications-sql-server-management-studio.md).</span></span>  
  
    4.  <span data-ttu-id="52ae3-169">运行验证步骤以确保发生冲突的行能够正确收敛。</span><span class="sxs-lookup"><span data-stu-id="52ae3-169">Run validation to ensure that the conflicting rows converged correctly.</span></span> <span data-ttu-id="52ae3-170">有关详细信息，请参阅[验证已复制的数据](../validate-data-at-the-subscriber.md)。</span><span class="sxs-lookup"><span data-stu-id="52ae3-170">For more information, see [Validate Replicated Data](../validate-data-at-the-subscriber.md).</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="52ae3-171">如果在执行该步骤之后数据不一致，则必须在具有最高优先级的节点上手动更新行，然后允许从该节点传播所做的更改。</span><span class="sxs-lookup"><span data-stu-id="52ae3-171">If data is inconsistent after this step, you must manually update rows on the node that has the highest priority, and then let the changes propagate from this node.</span></span> <span data-ttu-id="52ae3-172">如果拓扑中不再有发生冲突的更改，则所有节点将保持一致状态。</span><span class="sxs-lookup"><span data-stu-id="52ae3-172">If there are no further conflicting changes in the topology, all nodes will be brought to a consistent state.</span></span>  
  
    5.  <span data-ttu-id="52ae3-173">执行[sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql)：指定参数的 "p2p_continue_onconflict" @property 和 `false` 参数的 @value 。</span><span class="sxs-lookup"><span data-stu-id="52ae3-173">Execute [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql): specify 'p2p_continue_onconflict' for the @property parameter and `false` for the @value parameter.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="52ae3-174">另请参阅</span><span class="sxs-lookup"><span data-stu-id="52ae3-174">See Also</span></span>  
 [<span data-ttu-id="52ae3-175">@loopback_detection</span><span class="sxs-lookup"><span data-stu-id="52ae3-175">Peer-to-Peer Transactional Replication</span></span>](peer-to-peer-transactional-replication.md)  
  
  

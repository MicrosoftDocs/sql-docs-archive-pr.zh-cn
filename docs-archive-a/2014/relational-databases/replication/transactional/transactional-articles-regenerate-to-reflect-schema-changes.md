---
title: 重新生成自定义事务过程以反映架构更改 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- custom procedures [SQL Server replication]
- transactional replication, replicating schema changes
- schemas [SQL Server replication], replicating changes
ms.assetid: ccf68a13-e748-4455-8168-90e6d2868098
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 7b41b5309816e037ce3619e880b796e0653c7506
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87692342"
---
# <a name="regenerate-custom-transactional-procedures-to-reflect-schema-changes"></a><span data-ttu-id="5bf0d-102">重新生成自定义事务过程以反映架构更改</span><span class="sxs-lookup"><span data-stu-id="5bf0d-102">Regenerate Custom Transactional Procedures to Reflect Schema Changes</span></span>
  <span data-ttu-id="5bf0d-103">默认情况下，事务复制通过发布中的每个表项目的内部过程生成的存储过程，在订阅服务器上进行所有数据更改。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-103">By default transactional replication makes all data changes at Subscribers through stored procedures that are generated by internal procedures for each table article in the publication.</span></span> <span data-ttu-id="5bf0d-104">三个过程（分别对应插入、更新和删除）将复制到订阅服务器并在插入、更新或删除复制到订阅服务器后执行。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-104">The three procedures (one each for inserts, updates, and deletes) are copied to the Subscriber and execute when an insert, update, or delete is replicated to the Subscriber.</span></span> <span data-ttu-id="5bf0d-105">对 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 发布服务器上的表进行架构更改后，复制会通过调用同一组内部脚本过程自动重新生成这些过程，以便新过程与新架构相匹配（Oracle 发布服务器不支持复制架构更改）。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-105">When a schema change is made to a table on a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Publisher, replication regenerates these procedures automatically by calling the same set of internal scripting procedures so that the new procedures match the new schema (replication of schema changes is not supported for Oracle Publishers).</span></span>  
  
 <span data-ttu-id="5bf0d-106">也可以指定自定义过程来替换一个或多个默认过程。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-106">It is also possible to specify custom procedures to replace one or more of the default procedures.</span></span> <span data-ttu-id="5bf0d-107">如果架构更改将影响过程，则应该更改自定义过程。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-107">The custom procedures should be changed if the schema change will affect the procedure.</span></span> <span data-ttu-id="5bf0d-108">例如，如果一个过程引用了架构更改中删除的列，则对此列的引用应从过程中删除。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-108">For example, if a procedure references a column that is dropped in a schema change, references to the column should be removed from the procedure.</span></span> <span data-ttu-id="5bf0d-109">复制有两种方式将新的自定义过程传播到订阅服务器：</span><span class="sxs-lookup"><span data-stu-id="5bf0d-109">There are two ways for replication to propagate a new custom procedure to Subscribers:</span></span>  
  
-   <span data-ttu-id="5bf0d-110">第一种选择是使用自定义脚本过程替换复制使用的默认过程：</span><span class="sxs-lookup"><span data-stu-id="5bf0d-110">The first option is to use a custom scripting procedure to replace the defaults used by replication:</span></span>  
  
    1.  <span data-ttu-id="5bf0d-111">在执行[&#40;transact-sql&#41;sp_addarticle](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql)时，请确保 **@schema_option** 0x02 位为**true**。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-111">When executing [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), ensure the **@schema_option** 0x02 bit is to **true**.</span></span>  
  
    2.  <span data-ttu-id="5bf0d-112">执行[sp_register_custom_scripting &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql) ，并为参数指定值 "insert"、"update" 或 "delete"，并为参数指定 **@type** 自定义脚本过程的名称 **@value** 。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-112">Execute [sp_register_custom_scripting &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql) and specify a value of 'insert', 'update', or 'delete' for the parameter **@type** and the name of the custom scripting procedure for the parameter **@value**.</span></span>  
  
     <span data-ttu-id="5bf0d-113">下次进行架构更改时，复制会调用此存储过程为新用户定义的自定义存储过程编写定义脚本，然后将此过程传播到每个订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-113">The next time a schema change is made, replication calls this stored procedure to script out the definition for the new user defined custom stored procedure, and then propagates the procedure to each Subscriber.</span></span>  
  
-   <span data-ttu-id="5bf0d-114">第二种选择是使用包含新自定义过程定义的脚本：</span><span class="sxs-lookup"><span data-stu-id="5bf0d-114">The second option is to use a script that contains a new custom procedure definition:</span></span>  
  
    1.  <span data-ttu-id="5bf0d-115">当执行[sp_addarticle &#40;transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql)时，将 **@schema_option** 0x02 位设置为**false** ，以便复制不会自动在订阅服务器上生成自定义过程。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-115">When executing [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), set the **@schema_option** 0x02 bit to **false** so replication does not automatically generate custom procedures at the Subscriber.</span></span>  
  
    2.  <span data-ttu-id="5bf0d-116">每次更改架构前，请执行 [sp_register_custom_scripting &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql) 来创建新脚本文件并注册具有复制的脚本。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-116">Before each schema change, create a new script file and register the script with replication by executing [sp_register_custom_scripting &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-register-custom-scripting-transact-sql).</span></span> <span data-ttu-id="5bf0d-117">将参数的值指定为 "custom_script" **@type** ，并为参数指定发布服务器上脚本的路径 **@value** 。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-117">Specify a value of 'custom_script' for the parameter **@type** and the path to the script on the Publisher for the parameter **@value**.</span></span>  
  
     <span data-ttu-id="5bf0d-118">下次进行相关的架构更改时，此脚本会在每个订阅服务器上、在 DDL 命令所在的事务内执行。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-118">The next time a relevant schema change is made, this script executes on each Subscriber within the same transaction as the DDL command.</span></span> <span data-ttu-id="5bf0d-119">更改架构后，此脚本将撤消注册。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-119">After the schema change is made, the script is unregistered.</span></span> <span data-ttu-id="5bf0d-120">在后续架构更改后必须重新注册此脚本，使其执行。</span><span class="sxs-lookup"><span data-stu-id="5bf0d-120">You must re-register the script to have it executed after a subsequent schema change.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="5bf0d-121">另请参阅</span><span class="sxs-lookup"><span data-stu-id="5bf0d-121">See Also</span></span>  
 <span data-ttu-id="5bf0d-122">[指定如何传播事务项目的更改](transactional-articles-specify-how-changes-are-propagated.md) </span><span class="sxs-lookup"><span data-stu-id="5bf0d-122">[Specify How Changes Are Propagated for Transactional Articles](transactional-articles-specify-how-changes-are-propagated.md) </span></span>  
 [<span data-ttu-id="5bf0d-123">对发布数据库进行架构更改</span><span class="sxs-lookup"><span data-stu-id="5bf0d-123">Make Schema Changes on Publication Databases</span></span>](../publish/make-schema-changes-on-publication-databases.md)  
  
  

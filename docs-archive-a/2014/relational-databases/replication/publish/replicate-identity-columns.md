---
title: 复制标识列 | Microsoft Docs
ms.custom: ''
ms.date: 10/04/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- identities [SQL Server replication]
- identity values [SQL Server replication]
- merge replication [SQL Server replication], identity range management
- publishing [SQL Server replication], identity columns
- transactional replication, identity range management
- identity columns [SQL Server], replication
ms.assetid: eb2f23a8-7ec2-48af-9361-0e3cb87ebaf7
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: c899d902e403e9f7cdbdfd1a83cde110e627ab11
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578793"
---
# <a name="replicate-identity-columns"></a><span data-ttu-id="23dac-102">复制标识列</span><span class="sxs-lookup"><span data-stu-id="23dac-102">Replicate Identity Columns</span></span>
  <span data-ttu-id="23dac-103">将 IDENTITY 属性分配到列时，[!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 将为在包含标识列的表中插入的新行自动生成顺序编号。</span><span class="sxs-lookup"><span data-stu-id="23dac-103">When you assign an IDENTITY property to a column, [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] automatically generates sequential numbers for new rows inserted in the table containing the identity column.</span></span> <span data-ttu-id="23dac-104">有关详细信息，请参阅 [IDENTITY（属性）&#40;Transact-SQL&#41;](/sql/t-sql/statements/create-table-transact-sql-identity-property)。</span><span class="sxs-lookup"><span data-stu-id="23dac-104">For more information, see [IDENTITY &#40;Property&#41; &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-table-transact-sql-identity-property).</span></span> <span data-ttu-id="23dac-105">因为包含的标识列可能是主键的一部分，所以请务必避免在标识列中出现重复值。</span><span class="sxs-lookup"><span data-stu-id="23dac-105">Because identity columns might be included as a part of the primary key, it is important to avoid duplicate values in the identity columns.</span></span> <span data-ttu-id="23dac-106">若要在多个节点上都有更新的复制拓扑中使用标识列，复制拓扑中的每个节点都必须使用不同范围的标识值，以避免出现重复。</span><span class="sxs-lookup"><span data-stu-id="23dac-106">To use identity columns in a replication topology that has updates at more than one node, each node in the replication topology must use a different range of identity values, so that duplicates do not occur.</span></span>  
  
 <span data-ttu-id="23dac-107">例如，可以为发布服务器分配范围 1-100，为订阅服务器 A 分配范围 101-200，为订阅服务器 B 分配范围 201-300。</span><span class="sxs-lookup"><span data-stu-id="23dac-107">For example, the Publisher could be assigned the range 1-100, Subscriber A the range 101-200, and Subscriber B the range 201-300.</span></span> <span data-ttu-id="23dac-108">如果在发布服务器中插入行，例如标识值是 65，则将该值复制到每个订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="23dac-108">If a row is inserted at the Publisher and the identity value is, for example, 65, that value is replicated to each Subscriber.</span></span> <span data-ttu-id="23dac-109">复制在每个订阅服务器上插入数据时，不会增加订阅服务器表中的标识列值，而是插入文字值 65。</span><span class="sxs-lookup"><span data-stu-id="23dac-109">When replication inserts data at each Subscriber, it does not increment the identity column value in the Subscriber table; instead, the literal value 65 is inserted.</span></span> <span data-ttu-id="23dac-110">仅用户插入，而复制代理不插入，将导致标识列值增加。</span><span class="sxs-lookup"><span data-stu-id="23dac-110">Only user inserts, but not replication agent inserts cause the identity column value to be incremented.</span></span>  
  
 <span data-ttu-id="23dac-111">复制会处理所有发布和订阅类型的标识列，从而允许您手动管理列或通过复制自动管理列。</span><span class="sxs-lookup"><span data-stu-id="23dac-111">Replication handles identity columns across all publication and subscription types, allowing you to manage the columns manually or have replication manage them automatically.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="23dac-112">不支持向已发布的表添加标识列，因为将列复制到订阅服务器时，会导致无法收敛。</span><span class="sxs-lookup"><span data-stu-id="23dac-112">Adding an identity column to a published table is not supported, because it can result in non-convergence when the column is replicated to the Subscriber.</span></span> <span data-ttu-id="23dac-113">发布服务器的标识列中的值取决于受影响的表中行的物理存储顺序。</span><span class="sxs-lookup"><span data-stu-id="23dac-113">The values in the identity column at the Publisher depend on the order in which the rows for the affected table are physically stored.</span></span> <span data-ttu-id="23dac-114">行在订阅服务器中的存储顺序可能会有所不同。因此对于相同的行，标识列的值可能会不同。</span><span class="sxs-lookup"><span data-stu-id="23dac-114">The rows might be stored differently at the Subscriber; therefore the value for the identity column can be different for the same rows.</span></span>  
  
## <a name="specifying-an-identity-range-management-option"></a><span data-ttu-id="23dac-115">指定标识范围管理选项</span><span class="sxs-lookup"><span data-stu-id="23dac-115">Specifying an Identity Range Management Option</span></span>  
 <span data-ttu-id="23dac-116">复制提供了三个标识范围管理选项：</span><span class="sxs-lookup"><span data-stu-id="23dac-116">Replication offers three identity range management options:</span></span>  
  
-   <span data-ttu-id="23dac-117">自动。</span><span class="sxs-lookup"><span data-stu-id="23dac-117">Automatic.</span></span> <span data-ttu-id="23dac-118">用于在订阅服务器上进行更新的合并复制和事务复制。</span><span class="sxs-lookup"><span data-stu-id="23dac-118">Used for merge replication and transactional replication with updates at the Subscriber.</span></span> <span data-ttu-id="23dac-119">指定发布服务器和订阅服务器的大小范围，复制将自动管理新范围的分配。</span><span class="sxs-lookup"><span data-stu-id="23dac-119">Specify size ranges for the Publisher and Subscribers, and replication automatically manages the assignment of new ranges.</span></span> <span data-ttu-id="23dac-120">复制会为订阅服务器的标识列设置 NOT FOR REPLICATION 选项，这样只有用户插入才会导致订阅服务器上的值增加。</span><span class="sxs-lookup"><span data-stu-id="23dac-120">Replication sets the NOT FOR REPLICATION option on the identity column at the Subscriber, so that only user inserts cause the value to be incremented at the Subscriber.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="23dac-121">订阅服务器必须与发布服务器同步，以接收新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-121">Subscribers must synchronize with the Publisher to receive new ranges.</span></span> <span data-ttu-id="23dac-122">由于订阅服务器上的标识范围是自动分配的，所以如果订阅服务器重复请求新范围，则它可能会用尽可提供的整个标识范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-122">Because Subscribers are assigned identity ranges automatically, it is possible for any Subscriber to exhaust the entire supply of identity ranges if it repeatedly requests new ranges.</span></span>  
  
-   <span data-ttu-id="23dac-123">手动。</span><span class="sxs-lookup"><span data-stu-id="23dac-123">Manual.</span></span> <span data-ttu-id="23dac-124">用于订阅服务器上不进行更新的快照和事务复制、对等事务复制，或者当应用程序必须以编程方式控制标识范围时。</span><span class="sxs-lookup"><span data-stu-id="23dac-124">Used for snapshot and transactional replication without updates at the Subscriber, peer-to-peer transactional replication, or if your application must control identity ranges programmatically.</span></span> <span data-ttu-id="23dac-125">如果指定手动管理，则必须确保将范围分配给发布服务器和每个订阅服务器，还要确保在使用初始范围时，新范围已分配。</span><span class="sxs-lookup"><span data-stu-id="23dac-125">If you specify manual management, you must ensure that ranges are assigned to the Publisher and each Subscriber and that new ranges are assigned if the initial ranges are used.</span></span> <span data-ttu-id="23dac-126">复制会为订阅服务器的标识列设置 NOT FOR REPLICATION 选项。</span><span class="sxs-lookup"><span data-stu-id="23dac-126">Replication sets the NOT FOR REPLICATION option on the identity column at the Subscriber.</span></span>  
  
-   <span data-ttu-id="23dac-127">无。</span><span class="sxs-lookup"><span data-stu-id="23dac-127">None.</span></span> <span data-ttu-id="23dac-128">建议仅在为了向后兼容早期版本的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 时使用此选项，并且此选项只出现在事务发布的存储过程界面中。</span><span class="sxs-lookup"><span data-stu-id="23dac-128">This option is recommended only for backwards compatibility with earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and is available only from the stored procedure interface for transactional publications.</span></span>  
  
 <span data-ttu-id="23dac-129">若要指定标识范围管理选项，请参阅[管理标识列](manage-identity-columns.md)。</span><span class="sxs-lookup"><span data-stu-id="23dac-129">To specify an identity range management option, see [Manage Identity Columns](manage-identity-columns.md).</span></span>  
  
## <a name="assigning-identity-ranges"></a><span data-ttu-id="23dac-130">分配标识范围</span><span class="sxs-lookup"><span data-stu-id="23dac-130">Assigning Identity Ranges</span></span>  
 <span data-ttu-id="23dac-131">合并复制和事务复制用不同的方法分配范围，这些方法将在本部分中介绍。</span><span class="sxs-lookup"><span data-stu-id="23dac-131">Merge replication and transactional replication use different methods for assigning ranges; these methods are described in this section.</span></span>  
  
 <span data-ttu-id="23dac-132">复制标识列时有两种类型的范围需要考虑：分配给发布服务器和订阅服务器的范围，以及列中数据类型的范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-132">There are two types of ranges to take into account when replicating identity columns: the ranges assigned to the Publisher and Subscribers, and the range of the data type in the column.</span></span> <span data-ttu-id="23dac-133">下表显示了通常标识列中所使用数据类型的可用范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-133">The following table shows the ranges available for the data types typically used in identity columns.</span></span> <span data-ttu-id="23dac-134">此范围可用于拓扑中的所有节点。</span><span class="sxs-lookup"><span data-stu-id="23dac-134">The range is used across all nodes in a topology.</span></span> <span data-ttu-id="23dac-135">例如，如果使用 `smallint` 从1开始的增量为1，则对于发布服务器和所有订阅服务器，插入的最大数目为32767。</span><span class="sxs-lookup"><span data-stu-id="23dac-135">For example, if you use `smallint` starting at 1 with an increment of 1, the maximum number of inserts is 32,767 for the Publisher and all Subscribers.</span></span> <span data-ttu-id="23dac-136">插入的实际数取决于所用的值是否有间隔，以及是否使用了阈值。</span><span class="sxs-lookup"><span data-stu-id="23dac-136">The actual number of inserts depends on whether there are gaps in the values used and whether a threshold value is used.</span></span> <span data-ttu-id="23dac-137">有关阈值的详细信息，请参阅下列“合并复制”和“具有排队更新订阅的事务复制”两部分。</span><span class="sxs-lookup"><span data-stu-id="23dac-137">For more information about thresholds, see the following sections "Merge Replication" and "Transactional Replication with Queued Updating Subscriptions".</span></span>  
  
 <span data-ttu-id="23dac-138">如果发布服务器在插入后用尽了其标识范围，并且若此插入是由 **db_owner** 固定服务器角色的某个成员来执行的，那么该发布服务器将会自动分配一个新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-138">If the Publisher exhausts its identity range after an insert, it can automatically assign a new range if the insert was performed by a member of the **db_owner** fixed database role.</span></span> <span data-ttu-id="23dac-139">如果插入是由不属于该角色的用户执行的，则日志读取器代理、合并代理或属于 **db_owner** 角色的成员的用户必须运行 [sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="23dac-139">If the insert was performed by a user not in that role, the Log Reader Agent, Merge Agent, or a user who is a member of the **db_owner** role must run [sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql).</span></span> <span data-ttu-id="23dac-140">对于事务发布，必须运行日志读取器代理，以便自动分配新范围（默认设置是使代理连续运行）。</span><span class="sxs-lookup"><span data-stu-id="23dac-140">For transactional publications, the Log Reader Agent must be running to automatically allocate a new range (the default is for the agent to run continuously).</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="23dac-141">在大型批插入过程中，复制触发器只激发一次，不是对每个插入行都激发。</span><span class="sxs-lookup"><span data-stu-id="23dac-141">During a large batch insert the replication trigger is fired only once, not for each row of the insert.</span></span> <span data-ttu-id="23dac-142">如果标识范围在大型插入期间用尽，则会导致 insert 语句（如 `INSERT INTO` 语句）失败。</span><span class="sxs-lookup"><span data-stu-id="23dac-142">This can lead to a failure of the insert statement if an identity range is exhausted during an large insert, such as an `INSERT INTO` statement.</span></span>  
  
|<span data-ttu-id="23dac-143">数据类型</span><span class="sxs-lookup"><span data-stu-id="23dac-143">Data type</span></span>|<span data-ttu-id="23dac-144">范围</span><span class="sxs-lookup"><span data-stu-id="23dac-144">Range</span></span>|  
|---------------|-----------|  
|`tinyint`|<span data-ttu-id="23dac-145">不支持自动管理</span><span class="sxs-lookup"><span data-stu-id="23dac-145">Not supported for automatic management</span></span>|  
|`smallint`|<span data-ttu-id="23dac-146">-2^15 (-32,768) 到 2^15-1 (32,767)</span><span class="sxs-lookup"><span data-stu-id="23dac-146">-2^15 (-32,768) to 2^15-1 (32,767)</span></span>|  
|`int`|<span data-ttu-id="23dac-147">-2^31 (-2,147,483,648) 到 2^31-1 (2,147,483,647)</span><span class="sxs-lookup"><span data-stu-id="23dac-147">-2^31 (-2,147,483,648) to 2^31-1 (2,147,483,647)</span></span>|  
|`bigint`|<span data-ttu-id="23dac-148">-2^63 (-9,223,372,036,854,775,808) 到 2^63-1 (9,223,372,036,854,775,807)</span><span class="sxs-lookup"><span data-stu-id="23dac-148">-2^63 (-9,223,372,036,854,775,808) to 2^63-1 (9,223,372,036,854,775,807)</span></span>|  
|<span data-ttu-id="23dac-149">`decimal` 和 `numeric`</span><span class="sxs-lookup"><span data-stu-id="23dac-149">`decimal` and `numeric`</span></span>|<span data-ttu-id="23dac-150">-10^38+1 到 10^38-1</span><span class="sxs-lookup"><span data-stu-id="23dac-150">-10^38+1 through 10^38-1</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="23dac-151">要创建一个可在多个表中使用的自动递增数字或者可以从应用程序中调用而不引用任何表的自动递增数字，请参阅[序列号](../../sequence-numbers/sequence-numbers.md)。</span><span class="sxs-lookup"><span data-stu-id="23dac-151">To create an automatically incrementing number that can be used in multiple tables or that can be called from applications without referencing any table, see [Sequence Numbers](../../sequence-numbers/sequence-numbers.md).</span></span>  
  
### <a name="merge-replication"></a><span data-ttu-id="23dac-152">合并复制</span><span class="sxs-lookup"><span data-stu-id="23dac-152">Merge Replication</span></span>  
 <span data-ttu-id="23dac-153">标识范围由发布服务器管理，并由合并代理传播到订阅服务器（在重新发布的层次结构中，范围由根发布服务器和重新发布服务器管理）。</span><span class="sxs-lookup"><span data-stu-id="23dac-153">Identity ranges are managed by the Publisher and propagated to Subscribers by the Merge Agent (in a republishing hierarchy, ranges are managed by the root Publisher and the republishers).</span></span> <span data-ttu-id="23dac-154">从发布服务器上的池中分配标识值。</span><span class="sxs-lookup"><span data-stu-id="23dac-154">The identity values are assigned from a pool at the Publisher.</span></span> <span data-ttu-id="23dac-155">在新建发布向导中或通过使用 [sp_addmergearticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql) 向发布中添加带有标识列的项目时，请指定以下各项的值：</span><span class="sxs-lookup"><span data-stu-id="23dac-155">When you add an article with an identity column to a publication in the New Publication Wizard or by using [sp_addmergearticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergearticle-transact-sql), you specify values for:</span></span>  
  
-   <span data-ttu-id="23dac-156">\*\* \@ Identity_range\*\*参数，用于控制初始分配给发布服务器的标识范围大小，以及包含客户端订阅的订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="23dac-156">The **\@identity_range** parameter, which controls the identity range size initially allocated both to the Publisher and to Subscribers with client subscriptions.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="23dac-157">对于运行早期版本的的订阅服务器 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] ，此参数 (而不是\*\* \@ pub_identity_range\*\*参数) 还控制重新发布订阅服务器上的标识范围大小。</span><span class="sxs-lookup"><span data-stu-id="23dac-157">For Subscribers running previous versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], this parameter (rather than the **\@pub_identity_range** parameter) also controls the identity range size at republishing Subscribers.</span></span>  
  
-   <span data-ttu-id="23dac-158">\*\* \@ Pub_identity_range\*\*参数，它控制分配给具有服务器订阅的订阅服务器的重新发布的标识范围大小 (重新发布数据) 所必需的。</span><span class="sxs-lookup"><span data-stu-id="23dac-158">The **\@pub_identity_range** parameter, which controls the identity range size for republishing allocated to Subscribers with server subscriptions (required for republishing data).</span></span> <span data-ttu-id="23dac-159">所有带有服务器订阅的订阅服务器都会接收到重新发布的范围，即使它们实际上并不重新发布数据。</span><span class="sxs-lookup"><span data-stu-id="23dac-159">All Subscribers with server subscriptions receive a range for republishing, even if they don't actually republish data.</span></span>  
  
-   <span data-ttu-id="23dac-160">\*\* \@ 阈值\*\*参数，用于确定订阅 [!INCLUDE[ssEW](../../../includes/ssew-md.md)] 或早期版本的订阅何时需要新的标识范围 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="23dac-160">The **\@threshold** parameter, which is used to determine when a new range of identities is required for a subscription to [!INCLUDE[ssEW](../../../includes/ssew-md.md)] or a previous version of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="23dac-161">例如，可以为\*\* \@ identity_range**指定10000，为** \@ pub_identity_range\*\*指定500000。</span><span class="sxs-lookup"><span data-stu-id="23dac-161">For example, you could specify 10000 for **\@identity_range** and 500000 for **\@pub_identity_range**.</span></span> <span data-ttu-id="23dac-162">为运行 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 或更高版本的发布服务器和所有订阅服务器（包括具有服务器订阅功能的订阅服务器）分配主范围 10000。</span><span class="sxs-lookup"><span data-stu-id="23dac-162">The Publisher and all Subscribers running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version, including the Subscriber with the server subscription, are assigned a primary range of 10000.</span></span> <span data-ttu-id="23dac-163">还为具有服务器订阅的订阅服务器分配主范围500000，这可由与重新发布订阅服务器同步的订阅服务器使用 (您还必须为重新发布订阅服务器) 中的发布项目指定\*\* \@ identity_range**、 \*\* \@ pub_identity_range**和\*\* \@ 阈值\*\*。</span><span class="sxs-lookup"><span data-stu-id="23dac-163">The Subscriber with the server subscription is also assigned a primary range of 500000, which can be used by Subscribers that synchronize with the republishing Subscriber (you must also specify **\@identity_range**, **\@pub_identity_range**, and **\@threshold** for the articles in the publication at the republishing Subscriber).</span></span>  
  
 <span data-ttu-id="23dac-164">每个运行 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 或更高版本的订阅服务器还接收辅助标识范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-164">Each Subscriber running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or a later version also receives a secondary identity range.</span></span> <span data-ttu-id="23dac-165">辅助范围的大小等于主范围的大小。主范围用尽后，可以使用辅助范围，而且合并代理将分配一个新范围给订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="23dac-165">The secondary range is equal in size to the primary range; when the primary range is exhausted, the secondary range is used, and the Merge Agent assigns a new range to the Subscriber.</span></span> <span data-ttu-id="23dac-166">新范围将成为辅助范围，而由于订阅服务器使用标识值，处理将继续进行。</span><span class="sxs-lookup"><span data-stu-id="23dac-166">The new range becomes the secondary range, and the process continues as the Subscriber uses identity values.</span></span>  
  
  
### <a name="transactional-replication-with-queued-updating-subscriptions"></a><span data-ttu-id="23dac-167">带有排队更新订阅的事务复制</span><span class="sxs-lookup"><span data-stu-id="23dac-167">Transactional Replication with Queued Updating Subscriptions</span></span>  
 <span data-ttu-id="23dac-168">标识范围由分发服务器管理，并由分发代理传播到订阅服务器。</span><span class="sxs-lookup"><span data-stu-id="23dac-168">Identity ranges are managed by the Distributor and propagated to Subscribers by the Distribution Agent.</span></span> <span data-ttu-id="23dac-169">标识值从分发服务器上的池中分配。</span><span class="sxs-lookup"><span data-stu-id="23dac-169">The identity values are assigned from a pool at the Distributor.</span></span> <span data-ttu-id="23dac-170">池的大小根据标识列所使用的数据类型和增量大小而定。</span><span class="sxs-lookup"><span data-stu-id="23dac-170">The pool size is based on the size of the data type and the increment used for the identity column.</span></span> <span data-ttu-id="23dac-171">在新建发布向导中或通过使用 [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) 向发布中添加带有标识列的项目时，请指定以下各项的值：</span><span class="sxs-lookup"><span data-stu-id="23dac-171">When you add an article with an identity column to a publication in the New Publication Wizard or by using [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql), you specify values for:</span></span>  
  
-   <span data-ttu-id="23dac-172">\*\* \@ Identity_range\*\*参数，用于控制初始分配给所有订阅服务器的标识范围大小。</span><span class="sxs-lookup"><span data-stu-id="23dac-172">The **\@identity_range** parameter, which controls the identity range size initially allocated to all Subscribers.</span></span>  
  
-   <span data-ttu-id="23dac-173">\*\* \@ Pub_identity_range\*\*参数，控制分配给发布服务器的标识范围大小。</span><span class="sxs-lookup"><span data-stu-id="23dac-173">The **\@pub_identity_range** parameter, which controls the identity range size allocated to the Publisher.</span></span>  
  
-   <span data-ttu-id="23dac-174">\*\* \@ 阈值\*\*参数，用于确定订阅何时需要新的标识范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-174">The **\@threshold** parameter, which is used to determine when a new range of identities is required for a subscription.</span></span>  
  
 <span data-ttu-id="23dac-175">例如，你可以为\*\* \@ pub_identity_range**指定10000，为** \@ identity_range**指定1000， (假定订阅服务器) 中的更新较少，并为** \@ 阈值\*\*指定80%。</span><span class="sxs-lookup"><span data-stu-id="23dac-175">For example, you could specify 10000 for **\@pub_identity_range**, 1000 for **\@identity_range** (assuming fewer updates at the Subscriber), and 80 percent for **\@threshold**.</span></span> <span data-ttu-id="23dac-176">在订阅服务器上进行 800 次插入后（即 1000 的 80%），将为订阅服务器分配一个新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-176">After 800 inserts at a Subscriber (80 percent of 1000), a Subscriber is assigned a new range.</span></span> <span data-ttu-id="23dac-177">在发布服务器上进行 8000 次插入后，将为发布服务器分配一个新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-177">After 8000 inserts at the Publisher, the Publisher is assigned a new range.</span></span> <span data-ttu-id="23dac-178">分配新范围后，表中的标识范围值之间将有一定的间隔。</span><span class="sxs-lookup"><span data-stu-id="23dac-178">When a new range is assigned, there will be a gap in the identity range values in the table.</span></span> <span data-ttu-id="23dac-179">指定较高的阈值会产生较小的间隔，但这会降低系统的容错能力：如果分发代理由于某种原因无法运行，订阅服务器就更容易用完标识。</span><span class="sxs-lookup"><span data-stu-id="23dac-179">Specifying a higher threshold results in smaller gaps, but the system is less fault-tolerant: if the Distribution Agent cannot run for some reason, a Subscriber could more easily run out of identities.</span></span>  
  
## <a name="assigning-ranges-for-manual-identity-range-management"></a><span data-ttu-id="23dac-180">为手动标识范围管理分配范围</span><span class="sxs-lookup"><span data-stu-id="23dac-180">Assigning ranges for manual identity range management</span></span>  
 <span data-ttu-id="23dac-181">如果指定手动标识范围管理，则必须确保发布服务器和每个订阅服务器使用不同的标识范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-181">If you specify manual identity range management, you must ensure that the Publisher and each Subscriber use different identity ranges.</span></span> <span data-ttu-id="23dac-182">例如，假设发布服务器上具有标识列定义为 `IDENTITY(1,1)`的表：标识列从 1 开始，在每次插入行时递增 1。</span><span class="sxs-lookup"><span data-stu-id="23dac-182">For example, consider a table at the Publisher with an identity column defined as `IDENTITY(1,1)`: the identity column starts at 1 and is incremented by 1 each time a row is inserted.</span></span> <span data-ttu-id="23dac-183">如果发布服务器上的表有 5,000 行，并预计表中的行数在应用程序生存期间会有增长，则发布服务器可使用范围 1-10,000。</span><span class="sxs-lookup"><span data-stu-id="23dac-183">If the table at the Publisher has 5,000 rows, and you expect some growth in the table over the life of the application, the Publisher could use the range 1-10,000.</span></span> <span data-ttu-id="23dac-184">假定有两个订阅服务器，订阅服务器 A 可以使用 10,001-20,000，订阅服务器 B 可使用 20,001-30,000。</span><span class="sxs-lookup"><span data-stu-id="23dac-184">Given two Subscribers, Subscriber A could use 10,001-20,000, and Subscriber B could use 20,001-30,000.</span></span>  
  
 <span data-ttu-id="23dac-185">使用快照或其他方式初始化订阅服务器后，执行 DBCC CHECKIDENT，为订阅服务器分配其标识范围的起点。</span><span class="sxs-lookup"><span data-stu-id="23dac-185">After a Subscriber is initialized with a snapshot or through another means, execute DBCC CHECKIDENT to assign the Subscriber a starting point for its identity range.</span></span> <span data-ttu-id="23dac-186">例如，在订阅服务器 A 上，将执行 `DBCC CHECKIDENT('<TableName>','reseed',10001)`。</span><span class="sxs-lookup"><span data-stu-id="23dac-186">For example, at Subscriber A, you would execute `DBCC CHECKIDENT('<TableName>','reseed',10001)`.</span></span> <span data-ttu-id="23dac-187">在订阅服务器 B 上，将执行 `CHECKIDENT('<TableName>','reseed',20001)`。</span><span class="sxs-lookup"><span data-stu-id="23dac-187">At Subscriber B, you would execute `CHECKIDENT('<TableName>','reseed',20001)`.</span></span>  
  
 <span data-ttu-id="23dac-188">若要为发布服务器或订阅服务器分配新范围，请执行 DBCC CHECKIDENT 并指定新值，以对表重设种子。</span><span class="sxs-lookup"><span data-stu-id="23dac-188">To assign new ranges to the Publisher or Subscribers, execute DBCC CHECKIDENT and specify a new value to reseed the table.</span></span> <span data-ttu-id="23dac-189">应有某种方法确定何时必须分配新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-189">You should have some way to determine when a new range must be assigned.</span></span> <span data-ttu-id="23dac-190">例如，应用程序可能有检测何时节点将用尽范围的机制，并可以用 DBCC CHECKIDENT 分配新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-190">For example, your application could have a mechanism that detects when a node is about to use up its range and assign a new range using DBCC CHECKIDENT.</span></span> <span data-ttu-id="23dac-191">您还可以添加检查约束来确保如果添加某行将造成使用超出范围的标识值，则不添加此行。</span><span class="sxs-lookup"><span data-stu-id="23dac-191">You can also add a check constraint to ensure that a row cannot be added if it would cause an out of range identity value to be used.</span></span>  
  
## <a name="handling-identity-ranges-after-a-database-restore"></a><span data-ttu-id="23dac-192">在数据库还原之后处理标识范围</span><span class="sxs-lookup"><span data-stu-id="23dac-192">Handling Identity Ranges after a Database Restore</span></span>  
 <span data-ttu-id="23dac-193">如果正在使用自动标识范围管理，则从备份还原订阅服务器后，它将自动请求标识值的新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-193">If you are using automatic identity range management, when a Subscriber is restored from a backup, it automatically requests a new range of identity values.</span></span> <span data-ttu-id="23dac-194">如果发布服务器是从备份还原的，则必须确保为发布服务器分配了适当的范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-194">If a Publisher is restored from a backup, you must ensure that the Publisher is assigned an appropriate range.</span></span> <span data-ttu-id="23dac-195">对于复制合并，请使用 [sp_restoremergeidentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-restoremergeidentityrange-transact-sql) 分配一个新范围。</span><span class="sxs-lookup"><span data-stu-id="23dac-195">For merge replication, assign a new range using [sp_restoremergeidentityrange &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-restoremergeidentityrange-transact-sql).</span></span> <span data-ttu-id="23dac-196">对于事务复制，请先确定其使用过的最大值，然后设置新范围的起点。</span><span class="sxs-lookup"><span data-stu-id="23dac-196">For transactional replication, determine the highest value that has been used and then set the starting point for new ranges.</span></span> <span data-ttu-id="23dac-197">还原发布数据库后请使用下列过程：</span><span class="sxs-lookup"><span data-stu-id="23dac-197">Use the following procedure after the publication database has been restored:</span></span>  
  
1.  <span data-ttu-id="23dac-198">停止所有订阅服务器上的所有活动。</span><span class="sxs-lookup"><span data-stu-id="23dac-198">Stop all activity on all Subscribers.</span></span>  
  
2.  <span data-ttu-id="23dac-199">对包含标识列的每个已发布表：</span><span class="sxs-lookup"><span data-stu-id="23dac-199">For each published table that includes an identity column:</span></span>  
  
    1.  <span data-ttu-id="23dac-200">在每个订阅服务器的订阅数据库中，执行 `IDENT_CURRENT('<TableName>')`。</span><span class="sxs-lookup"><span data-stu-id="23dac-200">In the subscription database at each Subscriber, execute `IDENT_CURRENT('<TableName>')`.</span></span>  
  
    2.  <span data-ttu-id="23dac-201">记录在所有订阅服务器中发现的最大值。</span><span class="sxs-lookup"><span data-stu-id="23dac-201">Record the highest value found across all Subscribers.</span></span>  
  
    3.  <span data-ttu-id="23dac-202">在发布服务器上的发布数据库中，执行 `DBCC CHECKIDENT(<TableName>','reseed',<HighestValueFound+1>`)。</span><span class="sxs-lookup"><span data-stu-id="23dac-202">In the publication database at the Publisher, execute `DBCC CHECKIDENT(<TableName>','reseed',<HighestValueFound+1>`).</span></span>  
  
    4.  <span data-ttu-id="23dac-203">在发布服务器上的发布数据库中，执行 `sp_adjustpublisheridentityrange <PublicationName>, <TableName>`。</span><span class="sxs-lookup"><span data-stu-id="23dac-203">In the publication database at the Publisher, execute `sp_adjustpublisheridentityrange <PublicationName>, <TableName>`.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="23dac-204">如果将标识列中的值设置为减小而非增加，则请记录发现的最小值，然后用此值重设种子。</span><span class="sxs-lookup"><span data-stu-id="23dac-204">If the value in the identity column is set to decrement rather than increment, record the lowest value found, and then reseed with that value.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="23dac-205">另请参阅</span><span class="sxs-lookup"><span data-stu-id="23dac-205">See Also</span></span>  
 <span data-ttu-id="23dac-206">[BACKUP (Transact-SQL)](/sql/t-sql/statements/backup-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="23dac-206">[BACKUP &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-transact-sql) </span></span>  
 <span data-ttu-id="23dac-207">[DBCC CHECKIDENT &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="23dac-207">[DBCC CHECKIDENT &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-checkident-transact-sql) </span></span>  
 <span data-ttu-id="23dac-208">[IDENT_CURRENT &#40;Transact-SQL&#41;](/sql/t-sql/functions/ident-current-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="23dac-208">[IDENT_CURRENT &#40;Transact-SQL&#41;](/sql/t-sql/functions/ident-current-transact-sql) </span></span>  
 <span data-ttu-id="23dac-209">[IDENTITY（属性）&#40;Transact-SQL&#41;](/sql/t-sql/statements/create-table-transact-sql-identity-property) </span><span class="sxs-lookup"><span data-stu-id="23dac-209">[IDENTITY &#40;Property&#41; &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-table-transact-sql-identity-property) </span></span>  
 [<span data-ttu-id="23dac-210">sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="23dac-210">sp_adjustpublisheridentityrange &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-adjustpublisheridentityrange-transact-sql)  
  
  

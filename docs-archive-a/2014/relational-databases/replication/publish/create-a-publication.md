---
title: 创建发布 | Microsoft Docs
ms.custom: ''
ms.date: 06/30/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publications [SQL Server replication], creating
- articles [SQL Server replication], defining
- adding articles
- articles [SQL Server replication], adding
ms.assetid: 52ee6de9-1d58-4cb9-8711-372bddbe7154
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 14d8b3f1a998b18ae0153c1771fa11afd925da9c
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87591260"
---
# <a name="create-a-publication"></a><span data-ttu-id="b0904-102">Create a Publication</span><span class="sxs-lookup"><span data-stu-id="b0904-102">Create a Publication</span></span>
  <span data-ttu-id="b0904-103">本主题说明如何使用 [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] 、 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)]或复制管理对象 (RMO) 在 [!INCLUDE[tsql](../../../includes/tsql-md.md)]中创建发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-103">This topic describes how to create a publication in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], [!INCLUDE[tsql](../../../includes/tsql-md.md)], or Replication Management Objects (RMO).</span></span>  
  
 <span data-ttu-id="b0904-104">**本主题内容**</span><span class="sxs-lookup"><span data-stu-id="b0904-104">**In This Topic**</span></span>  
  
-   <span data-ttu-id="b0904-105">**开始之前：**</span><span class="sxs-lookup"><span data-stu-id="b0904-105">**Before you begin:**</span></span>  
  
     [<span data-ttu-id="b0904-106">限制和局限</span><span class="sxs-lookup"><span data-stu-id="b0904-106">Limitations and Restrictions</span></span>](#Restrictions)  
  
     [<span data-ttu-id="b0904-107">安全性</span><span class="sxs-lookup"><span data-stu-id="b0904-107">Security</span></span>](#Security)  
  
-   <span data-ttu-id="b0904-108">**创建发布和定义项目，使用：**</span><span class="sxs-lookup"><span data-stu-id="b0904-108">**To create a publication and define articles, using:**</span></span>  
  
     [<span data-ttu-id="b0904-109">SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="b0904-109">SQL Server Management Studio</span></span>](#SSMSProcedure)  
  
     [<span data-ttu-id="b0904-110">Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="b0904-110">Transact-SQL</span></span>](#TsqlProcedure)  
  
     [<span data-ttu-id="b0904-111">复制管理对象 (RMO)</span><span class="sxs-lookup"><span data-stu-id="b0904-111">Replication Management Objects (RMO)</span></span>](#RMOProcedure)  
  
##  <a name="before-you-begin"></a><a name="BeforeYouBegin"></a> <span data-ttu-id="b0904-112">开始之前</span><span class="sxs-lookup"><span data-stu-id="b0904-112">Before You Begin</span></span>  
  
###  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> <span data-ttu-id="b0904-113">限制和局限</span><span class="sxs-lookup"><span data-stu-id="b0904-113">Limitations and Restrictions</span></span>  
  
-   <span data-ttu-id="b0904-114">发布和项目名称不能包括下列任何字符：%、\*、[ , ]、|、:、"、?</span><span class="sxs-lookup"><span data-stu-id="b0904-114">Publication and article names cannot include any of the following characters: % , \* , [ , ] , | , : , " , ?</span></span> <span data-ttu-id="b0904-115">, ' , \ , / , \< , >.</span><span class="sxs-lookup"><span data-stu-id="b0904-115">, ' , \ , / , \< , >.</span></span> <span data-ttu-id="b0904-116">如果数据库中的对象包括上述任意字符，并且你希望复制它们，那么必须在“项目属性 - \<Article>”对话框（可从向导中的“项目”页面获得）中指定一个与相应对象名称不同的项目名称 。</span><span class="sxs-lookup"><span data-stu-id="b0904-116">If objects in the database include any of these characters and you want to replicate them, you must specify an article name that is different from the object name in the **Article Properties - \<Article>** dialog box, which is available from the **Articles** page in the wizard.</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="b0904-117">Security</span><span class="sxs-lookup"><span data-stu-id="b0904-117">Security</span></span>  
 <span data-ttu-id="b0904-118">如果可能，请在运行时提示用户输入安全凭据。</span><span class="sxs-lookup"><span data-stu-id="b0904-118">When possible, prompt users to enter security credentials at runtime.</span></span> <span data-ttu-id="b0904-119">如果必须存储凭据，请使用 [Windows .NET Framework 提供的](https://go.microsoft.com/fwlink/?LinkId=34733) Cryptographic Services [!INCLUDE[msCoName](../../../includes/msconame-md.md)] （加密服务）。</span><span class="sxs-lookup"><span data-stu-id="b0904-119">If you must store credentials, use the [cryptographic services](https://go.microsoft.com/fwlink/?LinkId=34733) provided by the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows .NET Framework.</span></span>  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="b0904-120">使用 SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="b0904-120">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="b0904-121">可以使用新建发布向导创建发布和定义项目。</span><span class="sxs-lookup"><span data-stu-id="b0904-121">Create publications and define articles with the New Publication Wizard.</span></span> <span data-ttu-id="b0904-122">创建发布之后，可在“发布属性 - \<Publication>”对话框中查看和修改发布属性。</span><span class="sxs-lookup"><span data-stu-id="b0904-122">After a publication is created, view and modify publication properties in the **Publication Properties - \<Publication>** dialog box.</span></span> <span data-ttu-id="b0904-123">有关从 Oracle 数据库创建发布的信息，请参阅[从 Oracle 数据库创建发布](create-a-publication-from-an-oracle-database.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-123">For information about creating a publication from an Oracle database, see [Create a Publication from an Oracle Database](create-a-publication-from-an-oracle-database.md).</span></span>  
  
#### <a name="to-create-a-publication-and-define-articles"></a><span data-ttu-id="b0904-124">创建发布和定义项目</span><span class="sxs-lookup"><span data-stu-id="b0904-124">To create a publication and define articles</span></span>  
  
1.  <span data-ttu-id="b0904-125">在 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] 中连接到发布服务器，然后展开服务器节点。</span><span class="sxs-lookup"><span data-stu-id="b0904-125">Connect to the Publisher in [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], and then expand the server node.</span></span>  
  
2.  <span data-ttu-id="b0904-126">展开 **“复制”** 文件夹，再右键单击 **“本地发布”** 文件夹。</span><span class="sxs-lookup"><span data-stu-id="b0904-126">Expand the **Replication** folder, and then right-click the **Local Publications** folder.</span></span>  
  
3.  <span data-ttu-id="b0904-127">单击 **“新建发布”** 。</span><span class="sxs-lookup"><span data-stu-id="b0904-127">Click **New Publication**.</span></span>  
  
4.  <span data-ttu-id="b0904-128">按照新建发布向导中的页完成以下任务：</span><span class="sxs-lookup"><span data-stu-id="b0904-128">Follow the pages in the New Publication Wizard to:</span></span>  
  
    -   <span data-ttu-id="b0904-129">如果尚未在服务器上配置分发，请指定分发服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-129">Specify a Distributor if distribution has not been configured on the server.</span></span> <span data-ttu-id="b0904-130">有关如何配置分发的详细信息，请参阅[配置发布和分发](../configure-publishing-and-distribution.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-130">For more information about configuring distribution, see [Configure Publishing and Distribution](../configure-publishing-and-distribution.md).</span></span>  
  
         <span data-ttu-id="b0904-131">如果在 **“分发服务器”** 页上指定将发布服务器用作其自己的分发服务器（本地分发服务器），而未将服务器配置为分发服务器，则新建发布向导将配置该服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-131">If you specify on the **Distributor** page that the Publisher server will act as its own Distributor (a local Distributor), and the server is not configured as a Distributor, the New Publication Wizard will configure the server.</span></span> <span data-ttu-id="b0904-132">在 **“快照文件夹”** 页中指定分发服务器的快照文件夹。</span><span class="sxs-lookup"><span data-stu-id="b0904-132">You will specify a default snapshot folder for the Distributor on the **Snapshot Folder** page.</span></span> <span data-ttu-id="b0904-133">快照文件夹只是指定共享的目录。向此文件夹中执行读写操作的代理必须对其具有足够的访问权限。</span><span class="sxs-lookup"><span data-stu-id="b0904-133">The snapshot folder is simply a directory that you have designated as a share; agents that read from and write to this folder must have sufficient permissions to access it.</span></span> <span data-ttu-id="b0904-134">有关正确保护文件夹的详细信息，请参阅[保护快照文件夹](../security/secure-the-snapshot-folder.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-134">For more information about securing the folder appropriately, see [Secure the Snapshot Folder](../security/secure-the-snapshot-folder.md).</span></span>  
  
         <span data-ttu-id="b0904-135">如果指定另一台服务器作为分发服务器，则必须在 **“管理密码”** 页上输入密码来连接发布服务器和分发服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-135">If you specify that another server should act as the Distributor, you must enter a password on the **Administrative Password** page for connections made from the Publisher to the Distributor.</span></span> <span data-ttu-id="b0904-136">此密码必须与在远程分发服务器上启用发布服务器时所指定的密码相匹配。</span><span class="sxs-lookup"><span data-stu-id="b0904-136">This password must match the password specified when the Publisher was enabled at the remote Distributor.</span></span>  
  
         <span data-ttu-id="b0904-137">有关详细信息，请参阅 [Configure Distribution](../configure-distribution.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-137">For more information, see [Configure Distribution](../configure-distribution.md).</span></span>  
  
    -   <span data-ttu-id="b0904-138">选择发布数据库。</span><span class="sxs-lookup"><span data-stu-id="b0904-138">Choose a publication database.</span></span>  
  
    -   <span data-ttu-id="b0904-139">选择发布类型。</span><span class="sxs-lookup"><span data-stu-id="b0904-139">Select a publication type.</span></span> <span data-ttu-id="b0904-140">有关详细信息，请参阅[复制类型](../types-of-replication.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-140">For more information, see [Types of Replication](../types-of-replication.md).</span></span>  
  
    -   <span data-ttu-id="b0904-141">指定要发布的数据和数据库对象；（可选）筛选来自表项目的列，并设置项目属性。</span><span class="sxs-lookup"><span data-stu-id="b0904-141">Specify data and database objects to publish; optionally filter columns from table articles, and set article properties.</span></span>  
  
    -   <span data-ttu-id="b0904-142">可选择筛选来自表项目的行。</span><span class="sxs-lookup"><span data-stu-id="b0904-142">Optionally filter rows from table articles.</span></span> <span data-ttu-id="b0904-143">有关详细信息，请参阅[筛选已发布数据](filter-published-data.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-143">For more information, see [Filter Published Data](filter-published-data.md).</span></span>  
  
    -   <span data-ttu-id="b0904-144">设置快照代理调度。</span><span class="sxs-lookup"><span data-stu-id="b0904-144">Set the Snapshot Agent schedule.</span></span>  
  
    -   <span data-ttu-id="b0904-145">指定运行下列复制代理和进行连接的凭证：</span><span class="sxs-lookup"><span data-stu-id="b0904-145">Specify the credentials under which the following replication agents run and make connections:</span></span>  
  
         <span data-ttu-id="b0904-146">\- 用于所有发布的快照代理。</span><span class="sxs-lookup"><span data-stu-id="b0904-146">\- Snapshot Agent for all publications.</span></span>  
  
         <span data-ttu-id="b0904-147">\- 用于所有事务发布的日志读取器代理。</span><span class="sxs-lookup"><span data-stu-id="b0904-147">\- Log Reader Agent for all transactional publications.</span></span>  
  
         <span data-ttu-id="b0904-148">\- 用于允许更新订阅的事务发布的队列读取器代理。</span><span class="sxs-lookup"><span data-stu-id="b0904-148">\- Queue Reader Agent for transactional publications that allow updating subscriptions.</span></span>  
  
         <span data-ttu-id="b0904-149">有关详细信息，请参阅 [Replication Agent Security Model](../security/replication-agent-security-model.md) 和 [Replication Security Best Practices](../security/replication-security-best-practices.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-149">For more information, see [Replication Agent Security Model](../security/replication-agent-security-model.md) and [Replication Security Best Practices](../security/replication-security-best-practices.md).</span></span>  
  
    -   <span data-ttu-id="b0904-150">（可选）编写发布脚本。</span><span class="sxs-lookup"><span data-stu-id="b0904-150">Optionally script the publication.</span></span> <span data-ttu-id="b0904-151">有关详细信息，请参阅 [Scripting Replication](../scripting-replication.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-151">For more information, see [Scripting Replication](../scripting-replication.md).</span></span>  
  
    -   <span data-ttu-id="b0904-152">指定发布的名称。</span><span class="sxs-lookup"><span data-stu-id="b0904-152">Specify a name for the publication.</span></span>  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="b0904-153">使用 Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="b0904-153">Using Transact-SQL</span></span>  
 <span data-ttu-id="b0904-154">可以使用复制存储过程以编程方式创建发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-154">Publications can be created programmatically using replication stored procedures.</span></span> <span data-ttu-id="b0904-155">使用的存储过程将取决于要创建的发布的类型。</span><span class="sxs-lookup"><span data-stu-id="b0904-155">The stored procedures that are used will depend on the type of publication being created.</span></span>  
  
#### <a name="to-create-a-snapshot-or-transactional-publication"></a><span data-ttu-id="b0904-156">创建快照发布或事务发布</span><span class="sxs-lookup"><span data-stu-id="b0904-156">To create a snapshot or transactional publication</span></span>  
  
1.  <span data-ttu-id="b0904-157">在发布服务器上，对发布数据库执行 [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql) 以允许使用快照复制或事务复制发布当前数据库。</span><span class="sxs-lookup"><span data-stu-id="b0904-157">At the Publisher on the publication database, execute [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql) to enable publication of the current database using snapshot or transactional replication.</span></span>  
  
2.  <span data-ttu-id="b0904-158">对于事务发布，确定发布数据库中是否存在日志读取器代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-158">For a transactional publication, determine whether a Log Reader Agent job exists for the publication database.</span></span> <span data-ttu-id="b0904-159">（对于快照发布，不需要此步骤）。</span><span class="sxs-lookup"><span data-stu-id="b0904-159">(This step is not required for snapshot publications.)</span></span>  
  
    -   <span data-ttu-id="b0904-160">如果发布数据库中存在日志读取器代理作业，则继续执行步骤 3。</span><span class="sxs-lookup"><span data-stu-id="b0904-160">If a Log Reader Agent job exists for the publication database, proceed to step 3.</span></span>  
  
    -   <span data-ttu-id="b0904-161">如果无法确定已发布的数据库是否存在日志读取器代理作业，请在发布服务器上对发布数据库执行 [sp_helplogreader_agent &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-helplogreader-agent-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="b0904-161">If you are unsure whether a Log Reader Agent job exists for a published database, execute [sp_helplogreader_agent &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-helplogreader-agent-transact-sql) at the Publisher on the publication database.</span></span>  
  
    -   <span data-ttu-id="b0904-162">如果结果集为空，则创建日志读取器代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-162">If the result set is empty, create a Log Reader Agent job.</span></span> <span data-ttu-id="b0904-163">在发布服务器上，执行[sp_addlogreader_agent &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addlogreader-agent-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="b0904-163">At the Publisher, execute [sp_addlogreader_agent &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addlogreader-agent-transact-sql).</span></span> <span data-ttu-id="b0904-164">为 \@job_name 和 \@password 指定运行该代理时所使用的 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows 凭据 。</span><span class="sxs-lookup"><span data-stu-id="b0904-164">Specify the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows credentials under which the agent runs for **\@job_name** and **\@password**.</span></span> <span data-ttu-id="b0904-165">如果代理在连接到发布服务器时使用 SQL Server 身份验证，则还必须将 \@publisher_security_mode 的值指定为 0，并为 \@publisher_login 和 \@publisher_password 指定 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 登录信息   。</span><span class="sxs-lookup"><span data-stu-id="b0904-165">If the agent will use SQL Server Authentication when connecting to the Publisher, you must also specify a value of **0** for **\@publisher_security_mode** and the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] login information for **\@publisher_login** and **\@publisher_password**.</span></span> <span data-ttu-id="b0904-166">继续执行步骤 3。</span><span class="sxs-lookup"><span data-stu-id="b0904-166">Proceed to step 3.</span></span>  
  
3.  <span data-ttu-id="b0904-167">在发布服务器上，执行[sp_addpublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="b0904-167">At the Publisher, execute [sp_addpublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql).</span></span> <span data-ttu-id="b0904-168">指定发布的发布名称\*\* \@ ，并且**对于** \@ repl_freq\*\*参数，为 `snapshot` 快照发布或事务发布的值指定值 `continuous` 。</span><span class="sxs-lookup"><span data-stu-id="b0904-168">Specify a publication name for **\@publication**, and, for the **\@repl_freq** parameter, specify a value of `snapshot` for a snapshot publication or a value of `continuous` for a transactional publication.</span></span> <span data-ttu-id="b0904-169">指定任何其他发布选项。</span><span class="sxs-lookup"><span data-stu-id="b0904-169">Specify any other publication options.</span></span> <span data-ttu-id="b0904-170">这便定义了发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-170">This defines the publication.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="b0904-171">发布名称不能包括下列字符：</span><span class="sxs-lookup"><span data-stu-id="b0904-171">Publication names cannot include the following characters:</span></span>  
    >   
    >  <span data-ttu-id="b0904-172">% \* [ ] | : " ?</span><span class="sxs-lookup"><span data-stu-id="b0904-172">% \* [ ] | : " ?</span></span> <span data-ttu-id="b0904-173">\ / \< ></span><span class="sxs-lookup"><span data-stu-id="b0904-173">\ / \< ></span></span>  
  
4.  <span data-ttu-id="b0904-174">在发布服务器上，执行[sp_addpublication_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-snapshot-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="b0904-174">At the Publisher, execute [sp_addpublication_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-snapshot-transact-sql).</span></span> <span data-ttu-id="b0904-175">将 \@publication 指定为步骤 3 中使用的发布名称，并为 \@snapshot_job_name 和 \@password 指定运行该快照代理时所使用的 Windows 凭据  。</span><span class="sxs-lookup"><span data-stu-id="b0904-175">Specify the publication name used in step 3 for **\@publication** and the Windows credentials under which the Snapshot Agent runs for **\@snapshot_job_name** and **\@password**.</span></span> <span data-ttu-id="b0904-176">如果代理在连接到发布服务器时使用 SQL Server 身份验证，则还必须将 \@publisher_security_mode 的值指定为 0 并为 \@publisher_login 和 \@publisher_password 指定 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 登录信息   。</span><span class="sxs-lookup"><span data-stu-id="b0904-176">If the agent will use SQL Server Authentication when connecting to the Publisher, you must also specify a value of **0** for **\@publisher_security_mode** and the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] login information for **\@publisher_login** and **\@publisher_password**.</span></span> <span data-ttu-id="b0904-177">此操作将为发布创建一个快照代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-177">This creates a Snapshot Agent job for the publication.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="b0904-178">使用远程分发服务器配置发布服务器时，为所有参数提供的值（包括 *job_login* 和 *job_password*）都会以纯文本方式发送到该分发服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-178">When configuring a Publisher with a remote Distributor, the values supplied for all parameters, including *job_login* and *job_password*, are sent to the Distributor as plain text.</span></span> <span data-ttu-id="b0904-179">在执行此存储过程之前，应该对发布服务器及其远程分发服务器之间的连接进行加密。</span><span class="sxs-lookup"><span data-stu-id="b0904-179">You should encrypt the connection between the Publisher and its remote Distributor before executing this stored procedure.</span></span> <span data-ttu-id="b0904-180">有关详细信息，请参阅[启用数据库引擎的加密连接（SQL Server 配置管理器）](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-180">For more information, see [Enable Encrypted Connections to the Database Engine &#40;SQL Server Configuration Manager&#41;](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md).</span></span>  
  
5.  <span data-ttu-id="b0904-181">向发布添加项目。</span><span class="sxs-lookup"><span data-stu-id="b0904-181">Add articles to the publication.</span></span> <span data-ttu-id="b0904-182">有关详细信息，请参阅 [定义项目](define-an-article.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-182">For more information, see [Define an Article](define-an-article.md).</span></span>  
  
6.  <span data-ttu-id="b0904-183">启动快照代理作业以为此发布生成初始快照。</span><span class="sxs-lookup"><span data-stu-id="b0904-183">Start the Snapshot Agent job to generate the initial snapshot for this publication.</span></span> <span data-ttu-id="b0904-184">有关详细信息，请参阅 [创建并应用初始快照](../create-and-apply-the-initial-snapshot.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-184">For more information, see [Create and Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md).</span></span>  
  
#### <a name="to-create-a-merge-publication"></a><span data-ttu-id="b0904-185">创建合并发布</span><span class="sxs-lookup"><span data-stu-id="b0904-185">To create a merge publication</span></span>  
  
1.  <span data-ttu-id="b0904-186">在发布服务器上，执行 [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql) 以允许使用合并复制发布当前数据库。</span><span class="sxs-lookup"><span data-stu-id="b0904-186">At the Publisher, execute [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql) to enable publication of the current database using merge replication.</span></span>  
  
2.  <span data-ttu-id="b0904-187">在发布服务器上，对发布数据库执行 [sp_addmergepublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="b0904-187">At the Publisher on the publication database, execute [sp_addmergepublication &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql).</span></span> <span data-ttu-id="b0904-188">为 \@publication 指定发布的名称，并指定任何其他发布选项。</span><span class="sxs-lookup"><span data-stu-id="b0904-188">Specify a name for the publication for **\@publication** and any other publication options.</span></span> <span data-ttu-id="b0904-189">这便定义了发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-189">This defines the publication.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="b0904-190">发布名称不能包括下列字符：</span><span class="sxs-lookup"><span data-stu-id="b0904-190">Publication names cannot include the following characters:</span></span>  
    >   
    >  <span data-ttu-id="b0904-191">% \* [ ] | : " ?</span><span class="sxs-lookup"><span data-stu-id="b0904-191">% \* [ ] | : " ?</span></span> <span data-ttu-id="b0904-192">\ / \< ></span><span class="sxs-lookup"><span data-stu-id="b0904-192">\ / \< ></span></span>  
  
3.  <span data-ttu-id="b0904-193">在发布服务器上，执行[sp_addpublication_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-snapshot-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="b0904-193">At the Publisher, execute [sp_addpublication_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addpublication-snapshot-transact-sql).</span></span> <span data-ttu-id="b0904-194">将 \@publication 指定为步骤 2 中使用的发布名称，并为 \@snapshot_job_name 和 \@password 指定运行该快照代理时所使用的 Windows 凭据  。</span><span class="sxs-lookup"><span data-stu-id="b0904-194">Specify the publication name used in step 2 for **\@publication** and the Windows credentials under which the Snapshot Agent runs for **\@snapshot_job_name** and **\@password**.</span></span> <span data-ttu-id="b0904-195">如果代理在连接到发布服务器时使用 SQL Server 身份验证，则还必须将 \@publisher_security_mode 的值指定为 0 并为 \@publisher_login 和 \@publisher_password 指定 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 登录信息   。</span><span class="sxs-lookup"><span data-stu-id="b0904-195">If the agent will use SQL Server Authentication when connecting to the Publisher, you must also specify a value of **0** for **\@publisher_security_mode** and the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] login information for **\@publisher_login** and **\@publisher_password**.</span></span> <span data-ttu-id="b0904-196">此操作将为发布创建一个快照代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-196">This creates a Snapshot Agent job for the publication.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="b0904-197">使用远程分发服务器配置发布服务器时，为所有参数提供的值（包括 *job_login* 和 *job_password*）都会以纯文本方式发送到该分发服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-197">When configuring a Publisher with a remote Distributor, the values supplied for all parameters, including *job_login* and *job_password*, are sent to the Distributor as plain text.</span></span> <span data-ttu-id="b0904-198">在执行此存储过程之前，应该对发布服务器及其远程分发服务器之间的连接进行加密。</span><span class="sxs-lookup"><span data-stu-id="b0904-198">You should encrypt the connection between the Publisher and its remote Distributor before executing this stored procedure.</span></span> <span data-ttu-id="b0904-199">有关详细信息，请参阅[启用数据库引擎的加密连接（SQL Server 配置管理器）](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-199">For more information, see [Enable Encrypted Connections to the Database Engine &#40;SQL Server Configuration Manager&#41;](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md).</span></span>  
  
4.  <span data-ttu-id="b0904-200">向发布添加项目。</span><span class="sxs-lookup"><span data-stu-id="b0904-200">Add articles to the publication.</span></span> <span data-ttu-id="b0904-201">有关详细信息，请参阅 [定义项目](define-an-article.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-201">For more information, see [Define an Article](define-an-article.md).</span></span>  
  
5.  <span data-ttu-id="b0904-202">启动快照代理作业以为此发布生成初始快照。</span><span class="sxs-lookup"><span data-stu-id="b0904-202">Start the Snapshot Agent job to generate the initial snapshot for this publication.</span></span> <span data-ttu-id="b0904-203">有关详细信息，请参阅 [创建并应用初始快照](../create-and-apply-the-initial-snapshot.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-203">For more information, see [Create and Apply the Initial Snapshot](../create-and-apply-the-initial-snapshot.md).</span></span>  
  
###  <a name="example-transact-sql"></a><a name="TsqlExample"></a> <span data-ttu-id="b0904-204">示例 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="b0904-204">Example (Transact-SQL)</span></span>  
 <span data-ttu-id="b0904-205">此示例创建事务发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-205">This example creates a transactional publication.</span></span> <span data-ttu-id="b0904-206">脚本变量用于传递创建快照代理和日志读取器代理作业时所需的 Windows 凭据。</span><span class="sxs-lookup"><span data-stu-id="b0904-206">Scripting variables are used to pass Windows credentials that are needed to create jobs for the Snapshot Agent and Log Reader Agent.</span></span>  
  
 [!code-sql[HowTo#sp_AddTranPub](../../../snippets/tsql/SQL15/replication/howto/tsql/createtranpub.sql#sp_addtranpub)]  
  
 <span data-ttu-id="b0904-207">此示例创建合并发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-207">This example creates a merge publication.</span></span> <span data-ttu-id="b0904-208">脚本变量用于传递创建快照代理作业时所需的 Windows 凭据。</span><span class="sxs-lookup"><span data-stu-id="b0904-208">Scripting variables are used to pass Windows credentials that are needed to create the job for the Snapshot Agent.</span></span>  
  
 [!code-sql[HowTo#sp_AddMergePub](../../../snippets/tsql/SQL15/replication/howto/tsql/createmergepub.sql#sp_addmergepub)]  
  
##  <a name="using-replication-management-objects-rmo"></a><a name="RMOProcedure"></a> <span data-ttu-id="b0904-209">使用复制管理对象 (RMO)</span><span class="sxs-lookup"><span data-stu-id="b0904-209">Using Replication Management Objects (RMO)</span></span>  
 <span data-ttu-id="b0904-210">可以使用复制管理对象 (RMO) 以编程方式创建发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-210">You can create publications programmatically by using Replication Management Objects (RMO).</span></span> <span data-ttu-id="b0904-211">用于创建发布的 RMO 类取决于所创建发布的类型。</span><span class="sxs-lookup"><span data-stu-id="b0904-211">The RMO classes that you use to create a publication depend on the type of publication you create.</span></span>  
  
#### <a name="to-create-a-snapshot-or-transactional-publication"></a><span data-ttu-id="b0904-212">创建快照发布或事务发布</span><span class="sxs-lookup"><span data-stu-id="b0904-212">To create a snapshot or transactional publication</span></span>  
  
1.  <span data-ttu-id="b0904-213">使用 <xref:Microsoft.SqlServer.Management.Common.ServerConnection> 类创建与发布服务器的连接。</span><span class="sxs-lookup"><span data-stu-id="b0904-213">Create a connection to the Publisher by using the <xref:Microsoft.SqlServer.Management.Common.ServerConnection> class.</span></span>  
  
2.  <span data-ttu-id="b0904-214">为发布数据库创建 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase> 类的实例，将 <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A> 属性设置为步骤 1 中的 <xref:Microsoft.SqlServer.Management.Common.ServerConnection> 的实例，然后调用 <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="b0904-214">Create an instance of the <xref:Microsoft.SqlServer.Replication.ReplicationDatabase> class for the publication database, set the <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A> property to the instance of <xref:Microsoft.SqlServer.Management.Common.ServerConnection> from step 1, and call the <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> method.</span></span> <span data-ttu-id="b0904-215">如果 <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> 返回 `false`，请验证该数据库是否存在。</span><span class="sxs-lookup"><span data-stu-id="b0904-215">If <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> returns `false`, verify that the database exists.</span></span>  
  
3.  <span data-ttu-id="b0904-216">如果 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.EnabledTransPublishing%2A> 属性为 `false`，请将其设置为 `true`。</span><span class="sxs-lookup"><span data-stu-id="b0904-216">If the <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.EnabledTransPublishing%2A> property is `false`, set it to `true`.</span></span>  
  
4.  <span data-ttu-id="b0904-217">对于事务发布，请检查 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentExists%2A> 属性的值。</span><span class="sxs-lookup"><span data-stu-id="b0904-217">For a transactional publication, check the value of the <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentExists%2A> property.</span></span> <span data-ttu-id="b0904-218">如果该属性为 `true`，说明已经存在一个针对此数据库的日志读取器代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-218">If this property is `true`, a Log Read Agent job already exists for this database.</span></span> <span data-ttu-id="b0904-219">如果该属性为 `false`，请执行如下操作：</span><span class="sxs-lookup"><span data-stu-id="b0904-219">If this property is `false`, do the following:</span></span>  
  
    -   <span data-ttu-id="b0904-220">设置 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Login%2A> 的 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Password%2A> 和 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.SecurePassword%2A> 或 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentProcessSecurity%2A> 字段，为运行日志读取器代理所用的 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows 帐户提供凭据。</span><span class="sxs-lookup"><span data-stu-id="b0904-220">Set the <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Login%2A> and <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Password%2A> or <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.SecurePassword%2A> fields of <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentProcessSecurity%2A> to provide the credentials for the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows account under which the Log Reader Agent runs.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="b0904-221">如果发布是由 `sysadmin` 固定服务器角色的成员创建的，则不需要设置 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentProcessSecurity%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-221">Setting <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentProcessSecurity%2A> is not required when the publication is created by a member of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="b0904-222">在这种情况下，代理会模拟 SQL Server Agent 帐户。</span><span class="sxs-lookup"><span data-stu-id="b0904-222">In this case, the agent will impersonate the SQL Server Agent account.</span></span> <span data-ttu-id="b0904-223">有关详细信息，请参阅 [复制代理安全模式](../security/replication-agent-security-model.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-223">For more information, see [Replication Agent Security Model](../security/replication-agent-security-model.md).</span></span>  
  
    -   <span data-ttu-id="b0904-224">（可选）在使用 SQL Server 身份验证连接到发布服务器时设置 <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardLogin%2A> 的 <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardPassword%2A> 和 <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SecureSqlStandardPassword%2A> 或 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentPublisherSecurity%2A> 字段。</span><span class="sxs-lookup"><span data-stu-id="b0904-224">(Optional) Set the <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardLogin%2A> and <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardPassword%2A> or <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SecureSqlStandardPassword%2A> fields of <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.LogReaderAgentPublisherSecurity%2A> when using SQL Server Authentication to connect to the Publisher.</span></span>  
  
    -   <span data-ttu-id="b0904-225">调用 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.CreateLogReaderAgent%2A> 方法，为该数据库创建日志读取器代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-225">Call the <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.CreateLogReaderAgent%2A> method to create the Log Reader Agent job for the database.</span></span>  
  
5.  <span data-ttu-id="b0904-226">创建 <xref:Microsoft.SqlServer.Replication.TransPublication> 类的实例，并设置此对象的以下属性：</span><span class="sxs-lookup"><span data-stu-id="b0904-226">Create an instance of the <xref:Microsoft.SqlServer.Replication.TransPublication> class, and set the following properties for this object:</span></span>  
  
    -   <span data-ttu-id="b0904-227">将 <xref:Microsoft.SqlServer.Management.Common.ServerConnection> 设置为步骤 1 中的 <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-227">The <xref:Microsoft.SqlServer.Management.Common.ServerConnection> from step 1 for <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A>.</span></span>  
  
    -   <span data-ttu-id="b0904-228">将 <xref:Microsoft.SqlServer.Replication.Publication.DatabaseName%2A>设置为已发布的数据库的名称。</span><span class="sxs-lookup"><span data-stu-id="b0904-228">The name of the published database for <xref:Microsoft.SqlServer.Replication.Publication.DatabaseName%2A>.</span></span>  
  
    -   <span data-ttu-id="b0904-229">将 <xref:Microsoft.SqlServer.Replication.Publication.Name%2A>属性设置为发布的名称。</span><span class="sxs-lookup"><span data-stu-id="b0904-229">A name for the publication for <xref:Microsoft.SqlServer.Replication.Publication.Name%2A>.</span></span>  
  
    -   <span data-ttu-id="b0904-230">将 <xref:Microsoft.SqlServer.Replication.PublicationType> 设置为 <xref:Microsoft.SqlServer.Replication.PublicationType.Transactional> 或 <xref:Microsoft.SqlServer.Replication.PublicationType.Snapshot>。</span><span class="sxs-lookup"><span data-stu-id="b0904-230">A <xref:Microsoft.SqlServer.Replication.PublicationType> of either <xref:Microsoft.SqlServer.Replication.PublicationType.Transactional> or <xref:Microsoft.SqlServer.Replication.PublicationType.Snapshot>.</span></span>  
  
    -   <span data-ttu-id="b0904-231">设置 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Login%2A> 的 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Password%2A> 和 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A> 字段，为运行快照代理所用的 Windows 帐户提供凭据。</span><span class="sxs-lookup"><span data-stu-id="b0904-231">The <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Login%2A> and <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Password%2A> fields of <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A> to provide the credentials for the Windows account under which the Snapshot Agent runs.</span></span> <span data-ttu-id="b0904-232">如果使用 Windows 身份验证，在快照代理连接到本地分发服务器或建立远程连接时，也会使用此帐户。</span><span class="sxs-lookup"><span data-stu-id="b0904-232">This account is also used when the Snapshot Agent makes connections to the local Distributor and for any remote connections when using Windows Authentication.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="b0904-233">如果发布是由 `sysadmin` 固定服务器角色的成员创建的，则不需要设置 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-233">Setting <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A> is not required when the publication is created by a member of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="b0904-234">在这种情况下，代理会模拟 SQL Server Agent 帐户。</span><span class="sxs-lookup"><span data-stu-id="b0904-234">In this case, the agent will impersonate the SQL Server Agent account.</span></span> <span data-ttu-id="b0904-235">有关详细信息，请参阅 [复制代理安全模式](../security/replication-agent-security-model.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-235">For more information, see [Replication Agent Security Model](../security/replication-agent-security-model.md).</span></span>  
  
    -   <span data-ttu-id="b0904-236">（可选）如果使用 SQL Server 身份验证连接到发布服务器，设置 <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardLogin%2A> 的 <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardPassword%2A> 和 <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SecureSqlStandardPassword%2A> 或 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentPublisherSecurity%2A> 字段。</span><span class="sxs-lookup"><span data-stu-id="b0904-236">(Optional) The <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardLogin%2A> and <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SqlStandardPassword%2A> or <xref:Microsoft.SqlServer.Replication.ConnectionSecurityContext.SecureSqlStandardPassword%2A> fields of <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentPublisherSecurity%2A> when using SQL Server Authentication to connect to the Publisher.</span></span>  
  
    -   <span data-ttu-id="b0904-237">（可选）使用“或”逻辑 OR 运算符（在 Visual C# 中为 `|`，在 Visual Basic 中为 `Or`）和“异或”逻辑 OR 运算符（在 Visual C# 中为 `^`，在 Visual Basic 中为 `Xor`），将 <xref:Microsoft.SqlServer.Replication.PublicationAttributes> 属性的值设置为 <xref:Microsoft.SqlServer.Replication.Publication.Attributes%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-237">(Optional) Use the inclusive logical OR operator (`|` in Visual C# and `Or` in Visual Basic) and the exclusive logical OR operator (`^` in Visual C# and `Xor` in Visual Basic) to set the <xref:Microsoft.SqlServer.Replication.PublicationAttributes> values for the <xref:Microsoft.SqlServer.Replication.Publication.Attributes%2A> property.</span></span>  
  
    -   <span data-ttu-id="b0904-238">（可选）将 <xref:Microsoft.SqlServer.Replication.TransPublication.PublisherName%2A> 设置为发布服务器的名称（如果发布服务器不是 SQL Server 发布服务器）。</span><span class="sxs-lookup"><span data-stu-id="b0904-238">(Optional) The name of the Publisher for <xref:Microsoft.SqlServer.Replication.TransPublication.PublisherName%2A> when the Publisher is a non-SQL Server Publisher.</span></span>  
  
6.  <span data-ttu-id="b0904-239">调用 <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> 方法来创建发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-239">Call the <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> method to create the publication.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="b0904-240">在使用远程分发服务器配置发布服务器时，为所有属性提供的值（包括 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A>）都会以纯文本形式发送到该分发服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-240">When configuring a Publisher with a remote Distributor, the values supplied for all properties, including <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A>, are sent to the Distributor as plain text.</span></span> <span data-ttu-id="b0904-241">调用 <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> 方法之前，应先对发布服务器与其远程分发服务器之间的连接进行加密。</span><span class="sxs-lookup"><span data-stu-id="b0904-241">You should encrypt the connection between the Publisher and its remote Distributor before calling the <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> method.</span></span> <span data-ttu-id="b0904-242">有关详细信息，请参阅[启用数据库引擎的加密连接（SQL Server 配置管理器）](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-242">For more information, see [Enable Encrypted Connections to the Database Engine &#40;SQL Server Configuration Manager&#41;](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md).</span></span>  
  
7.  <span data-ttu-id="b0904-243">调用 <xref:Microsoft.SqlServer.Replication.Publication.CreateSnapshotAgent%2A> 方法，为发布创建快照代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-243">Call the <xref:Microsoft.SqlServer.Replication.Publication.CreateSnapshotAgent%2A> method to create the Snapshot Agent job for the publication.</span></span>  
  
#### <a name="to-create-a-merge-publication"></a><span data-ttu-id="b0904-244">创建合并发布</span><span class="sxs-lookup"><span data-stu-id="b0904-244">To create a merge publication</span></span>  
  
1.  <span data-ttu-id="b0904-245">使用 <xref:Microsoft.SqlServer.Management.Common.ServerConnection> 类创建与发布服务器的连接。</span><span class="sxs-lookup"><span data-stu-id="b0904-245">Create a connection to the Publisher by using the <xref:Microsoft.SqlServer.Management.Common.ServerConnection> class.</span></span>  
  
2.  <span data-ttu-id="b0904-246">为发布数据库创建 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase> 类的实例，将 <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A> 属性设置为步骤 1 中的 <xref:Microsoft.SqlServer.Management.Common.ServerConnection> 的实例，然后调用 <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="b0904-246">Create an instance of the <xref:Microsoft.SqlServer.Replication.ReplicationDatabase> class for the publication database, set the <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A> property to the instance of <xref:Microsoft.SqlServer.Management.Common.ServerConnection> from step 1, and call the <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> method.</span></span> <span data-ttu-id="b0904-247">如果 <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> 返回 `false`，请验证该数据库是否存在。</span><span class="sxs-lookup"><span data-stu-id="b0904-247">If <xref:Microsoft.SqlServer.Replication.ReplicationObject.LoadProperties%2A> returns `false`, verify that the database exists.</span></span>  
  
3.  <span data-ttu-id="b0904-248">如果 <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.EnabledMergePublishing%2A> 属性为 `false`，请将其设置为 `true`，然后调用 <xref:Microsoft.SqlServer.Replication.ReplicationObject.CommitPropertyChanges%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-248">If <xref:Microsoft.SqlServer.Replication.ReplicationDatabase.EnabledMergePublishing%2A> Property is `false`, set it to `true`, and call <xref:Microsoft.SqlServer.Replication.ReplicationObject.CommitPropertyChanges%2A>.</span></span>  
  
4.  <span data-ttu-id="b0904-249">创建 <xref:Microsoft.SqlServer.Replication.MergePublication> 类的实例，并设置此对象的以下属性：</span><span class="sxs-lookup"><span data-stu-id="b0904-249">Create an instance of the <xref:Microsoft.SqlServer.Replication.MergePublication> class, and set the following properties for this object:</span></span>  
  
    -   <span data-ttu-id="b0904-250">将 <xref:Microsoft.SqlServer.Management.Common.ServerConnection> 设置为步骤 1 中的 <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-250">The <xref:Microsoft.SqlServer.Management.Common.ServerConnection> from step 1 for <xref:Microsoft.SqlServer.Replication.ReplicationObject.ConnectionContext%2A>.</span></span>  
  
    -   <span data-ttu-id="b0904-251">将 <xref:Microsoft.SqlServer.Replication.Publication.DatabaseName%2A>设置为已发布的数据库的名称。</span><span class="sxs-lookup"><span data-stu-id="b0904-251">The name of the published database for <xref:Microsoft.SqlServer.Replication.Publication.DatabaseName%2A>.</span></span>  
  
    -   <span data-ttu-id="b0904-252">将 <xref:Microsoft.SqlServer.Replication.Publication.Name%2A>属性设置为发布的名称。</span><span class="sxs-lookup"><span data-stu-id="b0904-252">A name for the publication for <xref:Microsoft.SqlServer.Replication.Publication.Name%2A>.</span></span>  
  
    -   <span data-ttu-id="b0904-253">设置 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Login%2A> 的 <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Password%2A> 和 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A> 字段，为运行快照代理所用的 Windows 帐户提供凭据。</span><span class="sxs-lookup"><span data-stu-id="b0904-253">The <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Login%2A> and <xref:Microsoft.SqlServer.Replication.IProcessSecurityContext.Password%2A> fields of <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A> to provide the credentials for the Windows account under which the Snapshot Agent runs.</span></span> <span data-ttu-id="b0904-254">如果使用 Windows 身份验证，在快照代理连接到本地分发服务器或建立远程连接时，也会使用此帐户。</span><span class="sxs-lookup"><span data-stu-id="b0904-254">This account is also used when the Snapshot Agent makes connections to the local Distributor and for any remote connections when using Windows Authentication.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="b0904-255">如果发布是由 `sysadmin` 固定服务器角色的成员创建的，则不需要设置 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-255">Setting <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A> is not required when the publication is created by a member of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="b0904-256">有关详细信息，请参阅 [复制代理安全模式](../security/replication-agent-security-model.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-256">For more information, see [Replication Agent Security Model](../security/replication-agent-security-model.md).</span></span>  
  
    -   <span data-ttu-id="b0904-257">（可选）使用“或”逻辑 OR 运算符（在 Visual C# 中为 `|`，在 Visual Basic 中为 `Or`）和“异或”逻辑 OR 运算符（在 Visual C# 中为 `^`，在 Visual Basic 中为 `Xor`），将 <xref:Microsoft.SqlServer.Replication.PublicationAttributes> 属性的值设置为 <xref:Microsoft.SqlServer.Replication.Publication.Attributes%2A>。</span><span class="sxs-lookup"><span data-stu-id="b0904-257">(Optional) Use the inclusive logical OR operator (`|` in Visual C# and `Or` in Visual Basic) and the exclusive logical OR operator (`^` in Visual C# and `Xor` in Visual Basic) to set the <xref:Microsoft.SqlServer.Replication.PublicationAttributes> values for the <xref:Microsoft.SqlServer.Replication.Publication.Attributes%2A> property.</span></span>  
  
5.  <span data-ttu-id="b0904-258">调用 <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> 方法来创建发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-258">Call the <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> method to create the publication.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="b0904-259">在使用远程分发服务器配置发布服务器时，为所有属性提供的值（包括 <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A>）都会以纯文本形式发送到该分发服务器。</span><span class="sxs-lookup"><span data-stu-id="b0904-259">When configuring a Publisher with a remote Distributor, the values supplied for all properties, including <xref:Microsoft.SqlServer.Replication.Publication.SnapshotGenerationAgentProcessSecurity%2A>, are sent to the Distributor as plain text.</span></span> <span data-ttu-id="b0904-260">调用 <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> 方法之前，应先对发布服务器与其远程分发服务器之间的连接进行加密。</span><span class="sxs-lookup"><span data-stu-id="b0904-260">You should encrypt the connection between the Publisher and its remote Distributor before calling the <xref:Microsoft.SqlServer.Replication.Publication.Create%2A> method.</span></span> <span data-ttu-id="b0904-261">有关详细信息，请参阅[启用数据库引擎的加密连接（SQL Server 配置管理器）](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-261">For more information, see [Enable Encrypted Connections to the Database Engine &#40;SQL Server Configuration Manager&#41;](../../../database-engine/configure-windows/enable-encrypted-connections-to-the-database-engine.md).</span></span>  
  
6.  <span data-ttu-id="b0904-262">调用 <xref:Microsoft.SqlServer.Replication.Publication.CreateSnapshotAgent%2A> 方法，为发布创建快照代理作业。</span><span class="sxs-lookup"><span data-stu-id="b0904-262">Call the <xref:Microsoft.SqlServer.Replication.Publication.CreateSnapshotAgent%2A> method to create the Snapshot Agent job for the publication.</span></span>  
  
###  <a name="examples-rmo"></a><a name="PShellExample"></a> <span data-ttu-id="b0904-263">示例 (RMO)</span><span class="sxs-lookup"><span data-stu-id="b0904-263">Examples (RMO)</span></span>  
 <span data-ttu-id="b0904-264">本例将 AdventureWorks 数据库设置为支持事务发布，定义了一个日志读取器代理作业，并且创建了 AdvWorksProductTran 发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-264">This example enables the AdventureWorks database for transactional publishing, defines a Log Reader Agent job, and creates the AdvWorksProductTran publication.</span></span> <span data-ttu-id="b0904-265">必须为此发布定义一个项目。</span><span class="sxs-lookup"><span data-stu-id="b0904-265">An article must be defined for this publication.</span></span> <span data-ttu-id="b0904-266">创建日志读取器代理作业和快照代理作业所需的 Windows 帐户凭据在运行时进行传递。</span><span class="sxs-lookup"><span data-stu-id="b0904-266">The Windows account credentials that are needed to create the Log Reader Agent job and the Snapshot Agent job are passed at runtime.</span></span> <span data-ttu-id="b0904-267">若要了解如何使用 RMO 定义快照项目和事务项目，请参阅 [Define an Article](define-an-article.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-267">To learn how to use RMO to define snapshot and transactional articles, see [Define an Article](define-an-article.md).</span></span>  
  
 [!code-csharp[HowTo#rmo_CreateTranPub](../../../snippets/csharp/SQL15/replication/howto/cs/rmotestevelope.cs#rmo_createtranpub)]  
  
 [!code-vb[HowTo#rmo_vb_CreateTranPub](../../../snippets/visualbasic/SQL15/replication/howto/vb/rmotestenv.vb#rmo_vb_createtranpub)]  
  
 <span data-ttu-id="b0904-268">本例将 AdventureWorks 数据库设置为支持合并发布，并且创建了 AdvWorksSalesOrdersMerge 发布。</span><span class="sxs-lookup"><span data-stu-id="b0904-268">This example enables the AdventureWorks database for merge publishing and creates the AdvWorksSalesOrdersMerge publication.</span></span> <span data-ttu-id="b0904-269">仍然必须为此发布定义项目。</span><span class="sxs-lookup"><span data-stu-id="b0904-269">Articles must still be defined for this publication.</span></span> <span data-ttu-id="b0904-270">创建快照代理作业所需的 Windows 帐户凭据在运行时进行传递。</span><span class="sxs-lookup"><span data-stu-id="b0904-270">The Windows account credentials that are needed to create the Snapshot Agent job are passed at runtime.</span></span> <span data-ttu-id="b0904-271">若要了解如何使用 RMO 定义合并项目，请参阅 [Define an Article](define-an-article.md)。</span><span class="sxs-lookup"><span data-stu-id="b0904-271">To learn how to use RMO to define merge articles, see [Define an Article](define-an-article.md).</span></span>  
  
 [!code-csharp[HowTo#rmo_CreateMergePub](../../../snippets/csharp/SQL15/replication/howto/cs/rmotestevelope.cs#rmo_createmergepub)]  
  
 [!code-vb[HowTo#rmo_vb_CreateMergePub](../../../snippets/visualbasic/SQL15/replication/howto/vb/rmotestenv.vb#rmo_vb_createmergepub)]  
  
## <a name="see-also"></a><span data-ttu-id="b0904-272">另请参阅</span><span class="sxs-lookup"><span data-stu-id="b0904-272">See Also</span></span>  
 <span data-ttu-id="b0904-273">[将 sqlcmd 与脚本变量结合使用](../../scripting/sqlcmd-use-with-scripting-variables.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-273">[Use sqlcmd with Scripting Variables](../../scripting/sqlcmd-use-with-scripting-variables.md) </span></span>  
 <span data-ttu-id="b0904-274">[发布数据和数据库对象](publish-data-and-database-objects.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-274">[Publish Data and Database Objects](publish-data-and-database-objects.md) </span></span>  
 <span data-ttu-id="b0904-275">[Replication Management Objects Concepts](../concepts/replication-management-objects-concepts.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-275">[Replication Management Objects Concepts](../concepts/replication-management-objects-concepts.md) </span></span>  
 <span data-ttu-id="b0904-276">[Define an Article](define-an-article.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-276">[Define an Article](define-an-article.md) </span></span>  
 <span data-ttu-id="b0904-277">[查看和修改发布属性](view-and-modify-publication-properties.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-277">[View and Modify Publication Properties](view-and-modify-publication-properties.md) </span></span>  
 <span data-ttu-id="b0904-278">[“配置分发”](../configure-distribution.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-278">[Configure Distribution](../configure-distribution.md) </span></span>  
 <span data-ttu-id="b0904-279">[保护分发服务器](../security/secure-the-distributor.md) </span><span class="sxs-lookup"><span data-stu-id="b0904-279">[Secure the Distributor](../security/secure-the-distributor.md) </span></span>  
 [<span data-ttu-id="b0904-280">保护发布服务器</span><span class="sxs-lookup"><span data-stu-id="b0904-280">Secure the Publisher</span></span>](../security/secure-the-publisher.md)  
  
  

---
title: 通过 FTP 传递快照 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- snapshots [SQL Server replication], FTP snapshots
- FTP snapshots [SQL Server replication]
- snapshot replication [SQL Server], FTP
ms.assetid: 99872c4f-40ce-4405-8fd4-44052d3bd827
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 2e6700e6989a5a7e32202a0710bc663978a136cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578809"
---
# <a name="deliver-a-snapshot-through-ftp"></a><span data-ttu-id="21aaa-102">通过 FTP 传递快照</span><span class="sxs-lookup"><span data-stu-id="21aaa-102">Deliver a Snapshot Through FTP</span></span>
  <span data-ttu-id="21aaa-103">本主题说明如何使用 [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] 或 [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] 在 [!INCLUDE[tsql](../../../includes/tsql-md.md)]中通过 FTP 传递快照。</span><span class="sxs-lookup"><span data-stu-id="21aaa-103">This topic describes how to deliver a snapshot through FTP in [!INCLUDE[ssCurrent](../../../includes/sscurrent-md.md)] by using [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)] or [!INCLUDE[tsql](../../../includes/tsql-md.md)].</span></span>  
  
##  <a name="limitations-and-restrictions"></a><a name="Restrictions"></a> <span data-ttu-id="21aaa-104">限制和局限</span><span class="sxs-lookup"><span data-stu-id="21aaa-104">Limitations and Restrictions</span></span>  
  
-   <span data-ttu-id="21aaa-105">快照代理必须对指定的目录具有写权限，而分发代理或合并代理必须具有读权限。</span><span class="sxs-lookup"><span data-stu-id="21aaa-105">The Snapshot Agent must have write permissions for the directory you specify, and the Distribution Agent or Merge Agent must have read permissions.</span></span> <span data-ttu-id="21aaa-106">如果使用请求订阅，就必须指定一个共享目录作为通用命名约定 (UNC) 路径，例如 \\\ftpserver\home\snapshots。</span><span class="sxs-lookup"><span data-stu-id="21aaa-106">If pull subscriptions are used, you must specify a shared directory as a universal naming convention (UNC) path, such as \\\ftpserver\home\snapshots.</span></span> <span data-ttu-id="21aaa-107">有关详细信息，请参阅[保护快照文件夹](../security/secure-the-snapshot-folder.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-107">For more information, see [Secure the Snapshot Folder](../security/secure-the-snapshot-folder.md).</span></span>  
  
###  <a name="prerequisites"></a><a name="Prerequisites"></a><span data-ttu-id="21aaa-108">先决条件</span><span class="sxs-lookup"><span data-stu-id="21aaa-108">Prerequisites</span></span>  
  
-   <span data-ttu-id="21aaa-109">若要通过文件传输协议 (FTP) 传输快照文件，必须先配置一个 FTP 服务器。</span><span class="sxs-lookup"><span data-stu-id="21aaa-109">To transfer snapshot files using File Transfer Protocol (FTP), you must first configure an FTP server.</span></span> <span data-ttu-id="21aaa-110">有关详细信息，请参阅 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Internet Information Services (IIS) 文档。</span><span class="sxs-lookup"><span data-stu-id="21aaa-110">For more information, see the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Internet Information Services (IIS) documentation.</span></span>  
  
###  <a name="security"></a><a name="Security"></a> <span data-ttu-id="21aaa-111">Security</span><span class="sxs-lookup"><span data-stu-id="21aaa-111">Security</span></span>  
 <span data-ttu-id="21aaa-112">为了帮助改进安全性，建议您在通过 Internet 使用 FTP 快照传递时实现虚拟专用网络 (VPN)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-112">To help improve security, we recommend that you implement a virtual private network (VPN) when using FTP snapshot delivery over the Internet.</span></span> <span data-ttu-id="21aaa-113">有关详细信息，请参阅[使用 VPN 通过 Internet 发布数据](../publish-data-over-the-internet-using-vpn.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-113">For more information, see [Publish Data over the Internet Using VPN](../publish-data-over-the-internet-using-vpn.md).</span></span>  
  
 <span data-ttu-id="21aaa-114">出于安全考虑，最好不允许匿名登录 FTP 服务器。</span><span class="sxs-lookup"><span data-stu-id="21aaa-114">As a security best practice, do not allow anonymous logins to the FTP server.</span></span> <span data-ttu-id="21aaa-115">快照代理必须对指定的目录具有写权限，而分发代理或合并代理必须具有读权限。</span><span class="sxs-lookup"><span data-stu-id="21aaa-115">The Snapshot Agent must have write permissions for the directory you specify, and the Distribution Agent or Merge Agent must have read permissions.</span></span> <span data-ttu-id="21aaa-116">如果使用请求订阅，就必须指定一个共享目录作为通用命名约定 (UNC) 路径，例如 \\\ftpserver\home\snapshots。</span><span class="sxs-lookup"><span data-stu-id="21aaa-116">If pull subscriptions are used, you must specify a shared directory as a universal naming convention (UNC) path, such as \\\ftpserver\home\snapshots.</span></span> <span data-ttu-id="21aaa-117">有关详细信息，请参阅[保护快照文件夹](../security/secure-the-snapshot-folder.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-117">For more information, see [Secure the Snapshot Folder](../security/secure-the-snapshot-folder.md).</span></span>  
  
 <span data-ttu-id="21aaa-118">如果可能，请在运行时提示用户输入其凭据。</span><span class="sxs-lookup"><span data-stu-id="21aaa-118">When possible, prompt users to enter their credentials at runtime.</span></span> <span data-ttu-id="21aaa-119">如果将凭据存储在脚本文件中，则必须确保此文件的安全。</span><span class="sxs-lookup"><span data-stu-id="21aaa-119">If you store credentials in a script file, you must secure the file.</span></span>  
  
##  <a name="using-sql-server-management-studio"></a><a name="SSMSProcedure"></a> <span data-ttu-id="21aaa-120">使用 SQL Server Management Studio</span><span class="sxs-lookup"><span data-stu-id="21aaa-120">Using SQL Server Management Studio</span></span>  
 <span data-ttu-id="21aaa-121">配置 FTP 服务器后，请在“发布属性 \<Publication>”对话框中为该服务器指定目录和安全信息。</span><span class="sxs-lookup"><span data-stu-id="21aaa-121">After the FTP server is configured, specify directory and security information for this server in the **Publication Properties \<Publication>** dialog box.</span></span> <span data-ttu-id="21aaa-122">有关访问此对话框的详细信息，请参阅 [View and Modify Publication Properties](view-and-modify-publication-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-122">For more information about accessing this dialog box, see [View and Modify Publication Properties](view-and-modify-publication-properties.md).</span></span>  
  
#### <a name="to-specify-ftp-information"></a><span data-ttu-id="21aaa-123">指定 FTP 信息</span><span class="sxs-lookup"><span data-stu-id="21aaa-123">To specify FTP information</span></span>  
  
1.  <span data-ttu-id="21aaa-124">在“发布属性 - \<Publication>”对话框中，从以下任一页面选择“允许订阅服务器下载使用 FTP 的快照文件”： </span><span class="sxs-lookup"><span data-stu-id="21aaa-124">In the **Publication Properties - \<Publication>** dialog box, select **Allow Subscribers to download snapshot files using FTP** from one of the following pages:</span></span>   
    -   <span data-ttu-id="21aaa-125">“FTP 快照”页面，用于运行 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 之前版本的发布服务器的快照发布、事务发布以及合并发布。</span><span class="sxs-lookup"><span data-stu-id="21aaa-125">The **FTP Snapshot** page, for snapshot and transactional publications, and merge publications for Publishers running versions prior to [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)].</span></span>    
    -   <span data-ttu-id="21aaa-126">**“FTP 快照和 Internet”** 页，用于运行 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 或更高版本的发布服务器的合并发布。</span><span class="sxs-lookup"><span data-stu-id="21aaa-126">The **FTP Snapshot and Internet** page, for merge publications from Publishers running [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] or later.</span></span>    
2.  <span data-ttu-id="21aaa-127">为 **“FTP 服务器名称”** 、 **“端口号”** 、 **“从 FTP 根文件夹开始的路径”** 、 **“登录名”** 和 **“密码”** 指定值。</span><span class="sxs-lookup"><span data-stu-id="21aaa-127">Specify values for **FTP server name**, **Port number**, **Path from the FTP root folder**, **Login**, and **Password**.</span></span>    
     <span data-ttu-id="21aaa-128">例如，如果 FTP 服务器的根目录是 \\\ftpserver\home，但你想将快照存储在 \\\ftpserver\home\snapshots，请为“从 FTP 根文件夹开始的路径”属性指定 \snapshots\ftp（复制在创建快照文件时将“ftp”追加到快照文件夹路径）。</span><span class="sxs-lookup"><span data-stu-id="21aaa-128">For example, if the FTP server root is \\\ftpserver\home and you want snapshots to be stored at \\\ftpserver\home\snapshots, specify \snapshots\ftp for the property **Path from the FTP root folder** (replication appends 'ftp' to the snapshot folder path when it creates snapshot files).</span></span>    
3.  <span data-ttu-id="21aaa-129">指定快照代理应将快照文件写入在步骤 2 中指定的目录。</span><span class="sxs-lookup"><span data-stu-id="21aaa-129">Specify that the Snapshot Agent should write the snapshot files to the directory specified in step 2.</span></span> <span data-ttu-id="21aaa-130">例如，若要让快照代理将快照文件写入 \\\ftpserver\home\snapshots\ftp，必须在下面两个位置之一指定路径 \\\ftpserver\home\snapshots：</span><span class="sxs-lookup"><span data-stu-id="21aaa-130">For example, to have the Snapshot Agent write the snapshot files to \\\ftpserver\home\snapshots\ftp, you must specify the path \\\ftpserver\home\snapshots in one of two places:</span></span>    
    -   <span data-ttu-id="21aaa-131">与发布关联的分发服务器的默认快照位置。</span><span class="sxs-lookup"><span data-stu-id="21aaa-131">The default snapshot location for the Distributor associated with this publication.</span></span>    
         <span data-ttu-id="21aaa-132">有关指定默认快照位置的详细信息，请参阅[指定默认快照位置](../snapshot-options.md#snapshot-folder-locations)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-132">For more information about specifying the default snapshot location, see [Specify the Default Snapshot Location](../snapshot-options.md#snapshot-folder-locations).</span></span>    
    -   <span data-ttu-id="21aaa-133">发布的备用快照文件夹位置。</span><span class="sxs-lookup"><span data-stu-id="21aaa-133">An alternate snapshot folder location for this publication.</span></span> <span data-ttu-id="21aaa-134">如果压缩快照，则需要指定备用位置。</span><span class="sxs-lookup"><span data-stu-id="21aaa-134">An alternate location is required if the snapshot is compressed.</span></span>    
         <span data-ttu-id="21aaa-135">在 "**发布属性- \<Publication> \*\* " 对话框的 "快照" 页上的 "**将文件放入下列文件夹\*\*" 文本框中输入路径。</span><span class="sxs-lookup"><span data-stu-id="21aaa-135">Enter the path in the **Put files in the following folder** textbox on the Snapshot page of the **Publication Properties - \<Publication>** dialog box.</span></span>   
4.  [!INCLUDE[clickOK](../../../includes/clickok-md.md)]  
  
##  <a name="using-transact-sql"></a><a name="TsqlProcedure"></a> <span data-ttu-id="21aaa-136">使用 Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="21aaa-136">Using Transact-SQL</span></span>  
 <span data-ttu-id="21aaa-137">通过使用复制存储过程，可以按编程方式设置在 FTP 服务器上提供快照文件的选项以及修改这些 FTP 设置。</span><span class="sxs-lookup"><span data-stu-id="21aaa-137">The option to make snapshot files available on an FTP server can be set and these FTP settings can be modified programmatically using replication stored procedures.</span></span> <span data-ttu-id="21aaa-138">所用的过程由发布的类型决定。</span><span class="sxs-lookup"><span data-stu-id="21aaa-138">The procedure used depends on the type of publication.</span></span> <span data-ttu-id="21aaa-139">FTP 快照传递仅可同请求订阅一起使用。</span><span class="sxs-lookup"><span data-stu-id="21aaa-139">FTP snapshot delivery is only used with pull subscriptions.</span></span>  
  
#### <a name="to-enable-ftp-snapshot-delivery-for-a-snapshot-or-transactional-publication"></a><span data-ttu-id="21aaa-140">为快照发布或事务发布启用 FTP 快照传递</span><span class="sxs-lookup"><span data-stu-id="21aaa-140">To enable FTP snapshot delivery for a snapshot or transactional publication</span></span>  
  
1.  <span data-ttu-id="21aaa-141">在发布服务器上，对发布数据库执行 [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-141">At the Publisher on the publication database, execute [sp_addpublication](/sql/relational-databases/system-stored-procedures/sp-addpublication-transact-sql).</span></span> <span data-ttu-id="21aaa-142">**@publication**将、的值指定 `true` 为 **@enabled_for_internet** ，并为以下参数指定适当的值：</span><span class="sxs-lookup"><span data-stu-id="21aaa-142">Specify **@publication**, a value of `true` for **@enabled_for_internet**, and appropriate values for the following parameters:</span></span>    
    -   <span data-ttu-id="21aaa-143">**@ftp_address**-用于传递快照的 FTP 服务器的地址。</span><span class="sxs-lookup"><span data-stu-id="21aaa-143">**@ftp_address** - the address of the FTP server used to deliver the snapshot.</span></span>    
    -   <span data-ttu-id="21aaa-144"> (可选) **@ftp_port** -FTP 服务器所使用的端口。</span><span class="sxs-lookup"><span data-stu-id="21aaa-144">(Optional) **@ftp_port** - the port used by the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-145"> (可选) **@ftp_subdirectory** -分配给 FTP 登录名的默认 FTP 目录的子目录。</span><span class="sxs-lookup"><span data-stu-id="21aaa-145">(Optional) **@ftp_subdirectory** - the subdirectory of the default FTP directory assigned to an FTP login.</span></span> <span data-ttu-id="21aaa-146">例如，如果 FTP 服务器根目录为 \ftpserver\home， \\ 并且你希望快照存储在 \\ \ftpserver\home\snapshots 中，则**\snapshots\ftp** **@ftp_subdirectory** 在创建快照文件) 时，指定 \snapshots\ftp for (复制会将 "FTP" 追加到快照文件夹路径中。</span><span class="sxs-lookup"><span data-stu-id="21aaa-146">For example, if the FTP server root is \\\ftpserver\home and you want snapshots to be stored at \\\ftpserver\home\snapshots, specify **\snapshots\ftp** for **@ftp_subdirectory** (replication appends 'ftp' to the snapshot folder path when it creates snapshot files).</span></span>    
    -   <span data-ttu-id="21aaa-147"> (可选) **@ftp_login** -连接到 FTP 服务器时使用的登录帐户。</span><span class="sxs-lookup"><span data-stu-id="21aaa-147">(Optional) **@ftp_login** - a login account used when connecting to the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-148"> (可选) **@ftp_password** -FTP 登录名的密码。</span><span class="sxs-lookup"><span data-stu-id="21aaa-148">(Optional) **@ftp_password** - the password for the FTP login.</span></span>  
  
     <span data-ttu-id="21aaa-149">此操作将创建一个使用 FTP 的发布。</span><span class="sxs-lookup"><span data-stu-id="21aaa-149">This creates a publication that uses FTP.</span></span> <span data-ttu-id="21aaa-150">有关详细信息，请参阅 [Create a Publication](create-a-publication.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-150">For more information, see [Create a Publication](create-a-publication.md).</span></span>  
  
#### <a name="to-enable-ftp-snapshot-delivery-for-a-merge-publication"></a><span data-ttu-id="21aaa-151">为合并发布启用 FTP 快照传递</span><span class="sxs-lookup"><span data-stu-id="21aaa-151">To enable FTP snapshot delivery for a merge publication</span></span>  
  
1.  <span data-ttu-id="21aaa-152">在发布服务器上，对发布数据库执行 [sp_addmergepublication](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-152">At the Publisher on the publication database, execute [sp_addmergepublication](/sql/relational-databases/system-stored-procedures/sp-addmergepublication-transact-sql).</span></span> <span data-ttu-id="21aaa-153">为 **@publication** 以下参数指定值，并为其指定 `true` **@enabled_for_internet** 适当的值：</span><span class="sxs-lookup"><span data-stu-id="21aaa-153">Specify **@publication**, a value of `true` for **@enabled_for_internet** and appropriate values for the following parameters:</span></span>  
  
    -   <span data-ttu-id="21aaa-154">**@ftp_address**-用于传递快照的 FTP 服务器的地址。</span><span class="sxs-lookup"><span data-stu-id="21aaa-154">**@ftp_address** - the address of the FTP server used to deliver the snapshot.</span></span>    
    -   <span data-ttu-id="21aaa-155"> (可选) **@ftp_port** -FTP 服务器所使用的端口。</span><span class="sxs-lookup"><span data-stu-id="21aaa-155">(Optional) **@ftp_port** - the port used by the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-156"> (可选) **@ftp_subdirectory** -分配给 FTP 登录名的默认 FTP 目录的子目录。</span><span class="sxs-lookup"><span data-stu-id="21aaa-156">(Optional) **@ftp_subdirectory** - the subdirectory of the default FTP directory assigned to an FTP login.</span></span> <span data-ttu-id="21aaa-157">例如，如果 FTP 服务器根目录为 \ftpserver\home， \\ 并且你希望快照存储在 \\ \ftpserver\home\snapshots 中，则**\snapshots\ftp** **@ftp_subdirectory** 在创建快照文件) 时，指定 \snapshots\ftp for (复制会将 "FTP" 追加到快照文件夹路径中。</span><span class="sxs-lookup"><span data-stu-id="21aaa-157">For example, if the FTP server root is \\\ftpserver\home and you want snapshots to be stored at \\\ftpserver\home\snapshots, specify **\snapshots\ftp** for **@ftp_subdirectory** (replication appends 'ftp' to the snapshot folder path when it creates snapshot files).</span></span>    
    -   <span data-ttu-id="21aaa-158"> (可选) **@ftp_login** -连接到 FTP 服务器时使用的登录帐户。</span><span class="sxs-lookup"><span data-stu-id="21aaa-158">(Optional) **@ftp_login** - a login account used when connecting to the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-159"> (可选) **@ftp_password** -FTP 登录名的密码。</span><span class="sxs-lookup"><span data-stu-id="21aaa-159">(Optional) **@ftp_password** - the password for the FTP login.</span></span>  
  
     <span data-ttu-id="21aaa-160">此操作将创建一个使用 FTP 的发布。</span><span class="sxs-lookup"><span data-stu-id="21aaa-160">This creates a publication that uses FTP.</span></span> <span data-ttu-id="21aaa-161">有关详细信息，请参阅 [Create a Publication](create-a-publication.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-161">For more information, see [Create a Publication](create-a-publication.md).</span></span>  
  
#### <a name="to-create-a-pull-subscription-to-a-snapshot-or-transactional-publication-that-uses-ftp-snapshot-delivery"></a><span data-ttu-id="21aaa-162">创建对使用 FTP 快照传递的快照发布或事务发布的请求订阅</span><span class="sxs-lookup"><span data-stu-id="21aaa-162">To create a pull subscription to a snapshot or transactional publication that uses FTP snapshot delivery</span></span>  
  
1.  <span data-ttu-id="21aaa-163">在订阅服务器上，对订阅数据库执行 [sp_addpullsubscription](/sql/relational-databases/system-stored-procedures/sp-addpullsubscription-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-163">At the Subscriber on the subscription database, execute [sp_addpullsubscription](/sql/relational-databases/system-stored-procedures/sp-addpullsubscription-transact-sql).</span></span> <span data-ttu-id="21aaa-164">指定 **@publisher** 和 **@publication** 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-164">Specify **@publisher** and **@publication**.</span></span>  
  
    -   <span data-ttu-id="21aaa-165">在订阅服务器上，对订阅数据库执行 [sp_addpullsubscription_agent](/sql/relational-databases/system-stored-procedures/sp-addpullsubscription-agent-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-165">At the Subscriber on the subscription database, execute [sp_addpullsubscription_agent](/sql/relational-databases/system-stored-procedures/sp-addpullsubscription-agent-transact-sql).</span></span> <span data-ttu-id="21aaa-166">指定 **@publisher** 、 **@publisher_db** 、 **@publication** 、在 [!INCLUDE[msCoName](../../../includes/msconame-md.md)] 其下运行订阅服务器分发代理的 Windows 凭据 **@job_login** ，并为指定和 **@job_password** 值 `true` **@use_ftp** 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-166">Specify **@publisher**, **@publisher_db**, **@publication**, the [!INCLUDE[msCoName](../../../includes/msconame-md.md)] Windows credentials under which the Distribution Agent at the Subscriber runs for **@job_login** and **@job_password**, and a value of `true` for **@use_ftp**.</span></span>  
  
2.  <span data-ttu-id="21aaa-167">在发布服务器上，对发布数据库执行 [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql) 以注册请求订阅。</span><span class="sxs-lookup"><span data-stu-id="21aaa-167">At the Publisher on the publication database, execute [sp_addsubscription](/sql/relational-databases/system-stored-procedures/sp-addsubscription-transact-sql) to register the pull subscription.</span></span> <span data-ttu-id="21aaa-168">有关详细信息，请参阅 [创建请求订阅](../create-a-pull-subscription.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-168">For more information, see [Create a Pull Subscription](../create-a-pull-subscription.md).</span></span>  
  
#### <a name="to-create-a-pull-subscription-to-a-merge-publication-that-uses-ftp-snapshot-delivery"></a><span data-ttu-id="21aaa-169">创建对使用 FTP 快照传递的合并发布的请求订阅</span><span class="sxs-lookup"><span data-stu-id="21aaa-169">To create a pull subscription to a merge publication that uses FTP snapshot delivery</span></span>  
  
1.  <span data-ttu-id="21aaa-170">在订阅服务器上，对订阅数据库执行 [sp_addmergepullsubscription](/sql/relational-databases/system-stored-procedures/sp-addmergepullsubscription-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-170">At the Subscriber on the subscription database, execute [sp_addmergepullsubscription](/sql/relational-databases/system-stored-procedures/sp-addmergepullsubscription-transact-sql).</span></span> <span data-ttu-id="21aaa-171">指定 **@publisher** 和 **@publication** 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-171">Specify **@publisher** and **@publication**.</span></span>   
2.  <span data-ttu-id="21aaa-172">在订阅服务器上，对订阅数据库执行 [sp_addmergepullsubscription_agent](/sql/relational-databases/system-stored-procedures/sp-addmergepullsubscription-agent-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-172">At the Subscriber on the subscription database, execute [sp_addmergepullsubscription_agent](/sql/relational-databases/system-stored-procedures/sp-addmergepullsubscription-agent-transact-sql).</span></span> <span data-ttu-id="21aaa-173">指定 **@publisher** 、 **@publisher_db** 、 **@publication** 、在其下运行订阅服务器分发代理的 Windows 凭据 **@job_login** ，并为指定和 **@job_password** 值 `true` **@use_ftp** 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-173">Specify **@publisher**, **@publisher_db**, **@publication**, the Windows credentials under which the Distribution Agent at the Subscriber runs for **@job_login** and **@job_password**, and a value of `true` for **@use_ftp**.</span></span>    
3.  <span data-ttu-id="21aaa-174">在发布服务器上，对发布数据库执行 [sp_addmergesubscription](/sql/relational-databases/system-stored-procedures/sp-addmergesubscription-transact-sql) 以注册请求订阅。</span><span class="sxs-lookup"><span data-stu-id="21aaa-174">At the Publisher on the publication database, execute [sp_addmergesubscription](/sql/relational-databases/system-stored-procedures/sp-addmergesubscription-transact-sql) to register the pull subscription.</span></span> <span data-ttu-id="21aaa-175">有关详细信息，请参阅 [创建请求订阅](../create-a-pull-subscription.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-175">For more information, see [Create a Pull Subscription](../create-a-pull-subscription.md).</span></span>  
  
#### <a name="to-change-one-or-more-ftp-snapshot-delivery-settings-for-a-snapshot-or-transactional-publication"></a><span data-ttu-id="21aaa-176">为快照发布或事务发布更改一个或多个 FTP 快照传递设置</span><span class="sxs-lookup"><span data-stu-id="21aaa-176">To change one or more FTP snapshot delivery settings for a snapshot or transactional publication</span></span>  
  
1.  <span data-ttu-id="21aaa-177">在发布服务器上，对发布数据库执行 [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-177">At the Publisher on the publication database, execute [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql).</span></span> <span data-ttu-id="21aaa-178">为指定以下值之一 **@property** ，并为此设置指定新值 **@value** ：</span><span class="sxs-lookup"><span data-stu-id="21aaa-178">Specify one of the following values for **@property** and a new value of this setting for **@value**:</span></span>    
    -   <span data-ttu-id="21aaa-179">`ftp_address` - 用于传递快照的 FTP 服务器的地址。</span><span class="sxs-lookup"><span data-stu-id="21aaa-179">`ftp_address` - the address of the FTP server used to deliver the snapshot.</span></span>    
    -   <span data-ttu-id="21aaa-180">`ftp_port` - FTP 服务器所使用的端口。</span><span class="sxs-lookup"><span data-stu-id="21aaa-180">`ftp_port` - the port used by the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-181">`ftp_subdirectory` - 用于 FTP 快照的默认 FTP 目录的子目录。</span><span class="sxs-lookup"><span data-stu-id="21aaa-181">`ftp_subdirectory` - the subdirectory of the default FTP directory used for the FTP snapshot.</span></span>    
    -   <span data-ttu-id="21aaa-182">`ftp_login` - 用于连接到 FTP 服务器的登录名。</span><span class="sxs-lookup"><span data-stu-id="21aaa-182">`ftp_login` - a login used to connect to the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-183">`ftp_password` - FTP 登录名的密码。</span><span class="sxs-lookup"><span data-stu-id="21aaa-183">`ftp_password` - the password for the FTP login.</span></span>  
  
2.  <span data-ttu-id="21aaa-184">（可选）对更改的每个 FTP 设置重复步骤 1。</span><span class="sxs-lookup"><span data-stu-id="21aaa-184">(Optional) Repeat step 1 for each FTP setting being changed.</span></span>    
3.  <span data-ttu-id="21aaa-185">（可选）若要禁用 FTP 快照传递，请在发布服务器上对发布数据库执行 [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql) 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-185">(Optional) To disable FTP snapshot delivery, execute [sp_changepublication](/sql/relational-databases/system-stored-procedures/sp-changepublication-transact-sql) at the Publisher on the publication database.</span></span> <span data-ttu-id="21aaa-186">将的值指定 `enabled_for_internet` 为 **@property** ，并将的值指定 `false` 为 **@value** 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-186">Specify a value of `enabled_for_internet` for **@property** and a value of `false` for **@value**.</span></span>  
  
#### <a name="to-change-ftp-snapshot-delivery-settings-for-a-merge-publication"></a><span data-ttu-id="21aaa-187">为合并发布更改 FTP 快照传递的设置</span><span class="sxs-lookup"><span data-stu-id="21aaa-187">To change FTP snapshot delivery settings for a merge publication</span></span>  
  
1.  <span data-ttu-id="21aaa-188">在发布服务器上，对发布数据库执行 [sp_changemergepublication](/sql/relational-databases/system-stored-procedures/sp-changemergepublication-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-188">At the Publisher on the publication database, execute [sp_changemergepublication](/sql/relational-databases/system-stored-procedures/sp-changemergepublication-transact-sql).</span></span> <span data-ttu-id="21aaa-189">为指定以下值之一 **@property** ，并为此设置指定新值 **@value** ：</span><span class="sxs-lookup"><span data-stu-id="21aaa-189">Specify one of the following values for **@property** and a new value of this setting for **@value**:</span></span>  
  
    -   <span data-ttu-id="21aaa-190">`ftp_address` - 用于传递快照的 FTP 服务器的地址。</span><span class="sxs-lookup"><span data-stu-id="21aaa-190">`ftp_address` - the address of the FTP server used to deliver the snapshot.</span></span>    
    -   <span data-ttu-id="21aaa-191">`ftp_port` - FTP 服务器所使用的端口。</span><span class="sxs-lookup"><span data-stu-id="21aaa-191">`ftp_port` - the port used by the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-192">`ftp_subdirectory` - 用于 FTP 快照的默认 FTP 目录的子目录。</span><span class="sxs-lookup"><span data-stu-id="21aaa-192">`ftp_subdirectory` - the subdirectory of the default FTP directory used for the FTP snapshot.</span></span>   
    -   <span data-ttu-id="21aaa-193">`ftp_login` - 用于连接到 FTP 服务器的登录名。</span><span class="sxs-lookup"><span data-stu-id="21aaa-193">`ftp_login` - a login used to connect to the FTP server.</span></span>    
    -   <span data-ttu-id="21aaa-194">`ftp_password` - FTP 登录名的密码。</span><span class="sxs-lookup"><span data-stu-id="21aaa-194">`ftp_password` - the password for the FTP login.</span></span>    
2.  <span data-ttu-id="21aaa-195">（可选）对更改的每个 FTP 设置重复步骤 1。</span><span class="sxs-lookup"><span data-stu-id="21aaa-195">(Optional) Repeat step 1 for each FTP setting being changed.</span></span>    
3.  <span data-ttu-id="21aaa-196">（可选）若要禁用 FTP 快照传递，请在发布服务器上对发布数据库执行 [sp_changemergepublication](/sql/relational-databases/system-stored-procedures/sp-changemergepublication-transact-sql) 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-196">(Optional) To disable FTP snapshot delivery, execute [sp_changemergepublication](/sql/relational-databases/system-stored-procedures/sp-changemergepublication-transact-sql) at the Publisher on the publication database.</span></span> <span data-ttu-id="21aaa-197">将的值指定 `enabled_for_internet` 为 **@property** ，并将的值指定 `false` 为 **@value** 。</span><span class="sxs-lookup"><span data-stu-id="21aaa-197">Specify a value of `enabled_for_internet` for **@property** and a value of `false` for **@value**.</span></span>  
  
###  <a name="examples-transact-sql"></a><a name="TsqlExample"></a> <span data-ttu-id="21aaa-198">示例 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="21aaa-198">Examples (Transact-SQL)</span></span>  
 <span data-ttu-id="21aaa-199">下面的示例创建一个合并发布，该发布允许订阅服务器通过使用 FTP 访问快照数据。</span><span class="sxs-lookup"><span data-stu-id="21aaa-199">The following example creates a merge publication that allows Subscribers to access the snapshot data using FTP.</span></span> <span data-ttu-id="21aaa-200">访问 FTP 共享区时，订阅服务器应使用安全的 VPN 连接。</span><span class="sxs-lookup"><span data-stu-id="21aaa-200">The Subscriber should use a secure VPN connection when accessing the FTP share.</span></span> <span data-ttu-id="21aaa-201">**sqlcmd** 脚本变量用于提供登录名和密码值。</span><span class="sxs-lookup"><span data-stu-id="21aaa-201">**sqlcmd** scripting variables are used to supply login and password values.</span></span> <span data-ttu-id="21aaa-202">有关详细信息，请参阅[将 sqlcmd 与脚本变量结合使用](../../scripting/sqlcmd-use-with-scripting-variables.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-202">For more information, see [Use sqlcmd with Scripting Variables](../../scripting/sqlcmd-use-with-scripting-variables.md).</span></span>  
  
 [!code-sql[HowTo#sp_createmergepub_ftp](../../../snippets/tsql/SQL15/replication/howto/tsql/createmergepubftp.sql#sp_createmergepub_ftp)]  
  
 <span data-ttu-id="21aaa-203">下面的示例创建一个对合并发布的订阅，在该订阅中订阅服务器通过使用 FTP 来获取快照。</span><span class="sxs-lookup"><span data-stu-id="21aaa-203">The following example creates a subscription to a merge publication, where the Subscriber obtains the snapshot using FTP.</span></span> <span data-ttu-id="21aaa-204">访问 FTP 共享区时，订阅服务器应使用安全的 VPN 连接。</span><span class="sxs-lookup"><span data-stu-id="21aaa-204">The Subscriber should use a secure VPN connection when accessing the FTP share.</span></span> <span data-ttu-id="21aaa-205">**sqlcmd** 脚本变量用于提供登录名和密码值。</span><span class="sxs-lookup"><span data-stu-id="21aaa-205">**sqlcmd** scripting variables are used to supply login and password values.</span></span> <span data-ttu-id="21aaa-206">有关详细信息，请参阅[将 sqlcmd 与脚本变量结合使用](../../scripting/sqlcmd-use-with-scripting-variables.md)。</span><span class="sxs-lookup"><span data-stu-id="21aaa-206">For more information, see [Use sqlcmd with Scripting Variables](../../scripting/sqlcmd-use-with-scripting-variables.md).</span></span>  
  
 [!code-sql[HowTo#sp_createmergepullsub_ftp](../../../snippets/tsql/SQL15/replication/howto/tsql/createmergepullsubftp.sql#sp_createmergepullsub_ftp)]  
  
 [!code-sql[HowTo#sp_createmergepullsubagent_ftp](../../../snippets/tsql/SQL15/replication/howto/tsql/createmergepullsubftp.sql#sp_createmergepullsubagent_ftp)]  
  
## <a name="see-also"></a><span data-ttu-id="21aaa-207">另请参阅</span><span class="sxs-lookup"><span data-stu-id="21aaa-207">See Also</span></span>  
 <span data-ttu-id="21aaa-208">[Replication System Stored Procedures Concepts](../concepts/replication-system-stored-procedures-concepts.md) </span><span class="sxs-lookup"><span data-stu-id="21aaa-208">[Replication System Stored Procedures Concepts](../concepts/replication-system-stored-procedures-concepts.md) </span></span>  
 <span data-ttu-id="21aaa-209">[通过 FTP 传输快照](../transfer-snapshots-through-ftp.md) </span><span class="sxs-lookup"><span data-stu-id="21aaa-209">[Transfer Snapshots Through FTP](../transfer-snapshots-through-ftp.md) </span></span>  
 <span data-ttu-id="21aaa-210">[更改发布和项目属性](change-publication-and-article-properties.md) </span><span class="sxs-lookup"><span data-stu-id="21aaa-210">[Change Publication and Article Properties](change-publication-and-article-properties.md) </span></span>  
 [<span data-ttu-id="21aaa-211">使用快照初始化订阅</span><span class="sxs-lookup"><span data-stu-id="21aaa-211">Initialize a Subscription with a Snapshot</span></span>](../initialize-a-subscription-with-a-snapshot.md)  
  
  

---
title: 将数据插入表值参数 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- table-valued parameters, inserting data into
ms.assetid: 9c1a3234-4675-40d3-b473-8df06208f880
author: rothja
ms.author: jroth
ms.openlocfilehash: 38e33c6e58bc2633591fa80e095ceafe46f67045
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87580229"
---
# <a name="inserting-data-into-table-valued-parameters"></a><span data-ttu-id="4bd54-102">向表值参数中插入数据</span><span class="sxs-lookup"><span data-stu-id="4bd54-102">Inserting Data into Table-Valued Parameters</span></span>
  <span data-ttu-id="4bd54-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]Native Client OLE DB 提供程序支持使用两种模型来指定表值参数行的数据：推送模型和请求模型。</span><span class="sxs-lookup"><span data-stu-id="4bd54-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider supports two models for the consumer to specify data for table valued parameter rows: a push model and a pull model.</span></span> <span data-ttu-id="4bd54-104">提供演示请求模型的示例；请参阅 [SQL Server 数据编程示例](https://msftdpprodsamples.codeplex.com/)。</span><span class="sxs-lookup"><span data-stu-id="4bd54-104">A sample that demonstrates the pull model is available; see [SQL Server Data Programming Samples](https://msftdpprodsamples.codeplex.com/).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4bd54-105">表值参数列要么必须在所有行中具有非默认值，要么必须在所有行中具有默认值。</span><span class="sxs-lookup"><span data-stu-id="4bd54-105">A table-valued parameter column must have either non-default values in all rows or default values in all rows.</span></span> <span data-ttu-id="4bd54-106">不能在某些行中具有默认值，而在其他行中不具有默认值。</span><span class="sxs-lookup"><span data-stu-id="4bd54-106">It is not possible to have default values in some rows but not others.</span></span> <span data-ttu-id="4bd54-107">因此，在表值参数绑定中，表值参数行集列数据仅允许状态值 DBSTATUS_S_ISNULL 和 DBSTATUS_S_OK。</span><span class="sxs-lookup"><span data-stu-id="4bd54-107">Therefore, in table-valued parameter bindings, the only status values allowed for table-valued parameter rowset column data are DBSTATUS_S_ISNULL and DBSTATUS_S_OK.</span></span> <span data-ttu-id="4bd54-108">DBSTATUS_S_DEFAULT 将导致失败，而绑定的状态值将设置为 DBSTATUS_E_BADSTATUS。</span><span class="sxs-lookup"><span data-stu-id="4bd54-108">DBSTATUS_S_DEFAULT will result in a failure and the bound status value will be set to DBSTATUS_E_BADSTATUS.</span></span>  
  
## <a name="push-model-loads-all-table-valued-paremeter-data-in-memory"></a><span data-ttu-id="4bd54-109">推送模型（在内存中加载所有表值参数数据）</span><span class="sxs-lookup"><span data-stu-id="4bd54-109">Push Model (Loads All Table-Valued Paremeter Data in Memory)</span></span>  
 <span data-ttu-id="4bd54-110">推送模型类似于使用参数集（也即，ICommand::Execute 中的 DBPARAMS 参数）。</span><span class="sxs-lookup"><span data-stu-id="4bd54-110">The push model is similar to the use of parameter sets (that is, the DBPARAMS parameter in ICommand::Execute).</span></span> <span data-ttu-id="4bd54-111">仅当在未对 IRowset 接口执行自定义实现的情况下使用表值参数行集对象时，才使用推送模型。</span><span class="sxs-lookup"><span data-stu-id="4bd54-111">The push model is only used if table-valued parameter rowset objects are used without a customized implementation of IRowset interfaces.</span></span> <span data-ttu-id="4bd54-112">当表值参数行集中的行数较少且预计不会给应用程序带来过量内存压力时，建议使用推送模型。</span><span class="sxs-lookup"><span data-stu-id="4bd54-112">The push model is recommended when the number of rows in the table-valued parameter rowset is small and is not expected to put excessive memory pressure on the application.</span></span> <span data-ttu-id="4bd54-113">这比请求模型更简单，因为它向使用者应用程序要求的功能不会超过典型 OLE DB 应用程序中当前常用的功能。</span><span class="sxs-lookup"><span data-stu-id="4bd54-113">This is simpler than the pull model, because it does not require any more functionality from the consumer application than what is currently common in typical OLE DB applications.</span></span>  
  
 <span data-ttu-id="4bd54-114">使用者应在执行命令之前向访问接口提供所有表值参数数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-114">The consumer is expected to provide all the table-valued parameter data to the provider before executing a command.</span></span> <span data-ttu-id="4bd54-115">为提供数据，使用者为每个表值参数填充一个表值参数行集对象。</span><span class="sxs-lookup"><span data-stu-id="4bd54-115">To provide the data, the consumer populates a table-valued parameter rowset object for each table-valued parameter.</span></span> <span data-ttu-id="4bd54-116">表值参数行集对象显示行集 Insert、Set 和 Delete 操作，使用者将使用这些操作来操作表值参数数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-116">The table-valued parameter rowset object exposes rowset Insert, Set, and Delete operations, which the consumer will use to manipulate the table-valued parameter data.</span></span> <span data-ttu-id="4bd54-117">访问接口在执行时将从该表值参数行集对象中提取数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-117">The provider will fetch the data from this table-valued parameter rowset object at execution time.</span></span>  
  
 <span data-ttu-id="4bd54-118">当向使用者提供表值参数行集对象时，使用者可以将其作为行集对象处理。</span><span class="sxs-lookup"><span data-stu-id="4bd54-118">When a table-valued parameter rowset object is provided to the consumer, the consumer can process it as a rowset object.</span></span> <span data-ttu-id="4bd54-119">使用者可以使用 IColumnsInfo::GetColumnInfo 或 IColumnsRowset::GetColumnsRowset 接口方法，获得每列的类型信息（类型、长度上限、精度和确定位数）。</span><span class="sxs-lookup"><span data-stu-id="4bd54-119">The consumer can obtain the type information of each column (type, maximum length, precision, and scale) by using the IColumnsInfo::GetColumnInfo or IColumnsRowset::GetColumnsRowset interface method.</span></span> <span data-ttu-id="4bd54-120">然后，使用者创建取值函数，以便为数据指定绑定。</span><span class="sxs-lookup"><span data-stu-id="4bd54-120">The consumer then creates an accessor to specify the bindings for the data.</span></span> <span data-ttu-id="4bd54-121">下一步是将数据行插入表值参数行集。</span><span class="sxs-lookup"><span data-stu-id="4bd54-121">The next step is to insert rows of data into the table-valued parameter rowset.</span></span> <span data-ttu-id="4bd54-122">为此，可以使用 IRowsetChange::InsertRow。</span><span class="sxs-lookup"><span data-stu-id="4bd54-122">This can be done by using IRowsetChange::InsertRow.</span></span> <span data-ttu-id="4bd54-123">如果必须操作数据，还可以对表值参数行集对象使用 IRowsetChange::SetData 或 IRowsetChange::DeleteRows。</span><span class="sxs-lookup"><span data-stu-id="4bd54-123">IRowsetChange::SetData or IRowsetChange::DeleteRows can also be used on the table-valued parameter rowset object if you have to manipulate the data.</span></span> <span data-ttu-id="4bd54-124">表值参数行集对象将进行引用计数，这与流对象类似。</span><span class="sxs-lookup"><span data-stu-id="4bd54-124">Table-valued parameter rowset objects are reference counted, similar to stream objects.</span></span>  
  
 <span data-ttu-id="4bd54-125">如果使用的是 IColumnsRowset::GetColumnsRowset，后续会对结果列的行集对象调用 IRowset::GetNextRows、IRowset::GetData 和 IRowset::ReleaseRows 方法。</span><span class="sxs-lookup"><span data-stu-id="4bd54-125">If IColumnsRowset::GetColumnsRowset is used, there will be subsequent calls to IRowset::GetNextRows, IRowset::GetData, and IRowset::ReleaseRows methods on the rowset object of the resulting column.</span></span>  
  
 <span data-ttu-id="4bd54-126">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 提供程序开始执行命令后，将从该表值参数行集对象中提取表值参数值，并将其发送到服务器。</span><span class="sxs-lookup"><span data-stu-id="4bd54-126">After the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider begins executing the command, the table-valued parameter values will be fetched from this table-valued parameter rowset object and sent to the server.</span></span>  
  
 <span data-ttu-id="4bd54-127">推送模型对于使用者的工作量要求最少，但占用的内存高于请求模型，原因在于在执行时所有表值参数数据都必须位于内存中。</span><span class="sxs-lookup"><span data-stu-id="4bd54-127">The push model requires minimal work by the consumer, but uses more memory than the pull model, because all the table-valued parameter data has to be in memory at execution time.</span></span>  
  
## <a name="pull-model-obtaining-table-valued-parameter-data-on-demand-from-the-consumer"></a><span data-ttu-id="4bd54-128">请求模型（从使用者按需获得表值参数数据）</span><span class="sxs-lookup"><span data-stu-id="4bd54-128">Pull Model (Obtaining Table-Valued Parameter Data on Demand from the Consumer)</span></span>  
 <span data-ttu-id="4bd54-129">请求模型用于两种应用场景：</span><span class="sxs-lookup"><span data-stu-id="4bd54-129">The pull model is useful for two scenarios:</span></span>  
  
-   <span data-ttu-id="4bd54-130">使行成为流数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-130">To stream rows.</span></span>  
  
-   <span data-ttu-id="4bd54-131">如果其他访问接口中的行集正用作表值参数值。</span><span class="sxs-lookup"><span data-stu-id="4bd54-131">If a rowset from another provider is being used as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="4bd54-132">在请求模型中，使用者按需为访问接口提供数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-132">In the pull model, the consumer provides data on demand to the provider.</span></span> <span data-ttu-id="4bd54-133">如果应用程序具有许多数据插入操作，并且内存中的表值参数行集数据将导致过量的内存访问，则使用此方法。</span><span class="sxs-lookup"><span data-stu-id="4bd54-133">Use this approach if your application has many data insertions, and table-valued parameter rowset data in memory would result in excessive memory access.</span></span> <span data-ttu-id="4bd54-134">如果使用多个 OLE DB 访问接口，则借助于使用者请求模型，使用者可以将任何行集对象作为表值参数值提供。</span><span class="sxs-lookup"><span data-stu-id="4bd54-134">If multiple OLE DB providers are used, the consumer pull model enables the consumer to provide any rowset object as the table-valued parameter value.</span></span>  
  
 <span data-ttu-id="4bd54-135">为了使用请求模型，使用者必须提供其自己的对于行集对象的实现。</span><span class="sxs-lookup"><span data-stu-id="4bd54-135">To use the pull model, consumers have to provide their own implementation of a rowset object.</span></span> <span data-ttu-id="4bd54-136">如果结合使用拉取模型和表值参数行集 (CLSID_ROWSET_TVP)，使用者必须聚合提供程序通过 ITableDefinitionWithConstraints::CreateTableWithConstraints 方法或 IOpenRowset::OpenRowset 方法公开的表值参数行集对象。</span><span class="sxs-lookup"><span data-stu-id="4bd54-136">When using the pull model with table-valued parameter rowsets (CLSID_ROWSET_TVP), the consumer is required to aggregate the table-valued parameter rowset object that the provider exposes through the ITableDefinitionWithConstraints::CreateTableWithConstraints method or the IOpenRowset::OpenRowset method.</span></span> <span data-ttu-id="4bd54-137">使用者对象应只覆盖 IRowset 接口实现。</span><span class="sxs-lookup"><span data-stu-id="4bd54-137">The consumer object is only expected to override the IRowset interface implementation.</span></span> <span data-ttu-id="4bd54-138">您必须覆盖以下函数：</span><span class="sxs-lookup"><span data-stu-id="4bd54-138">You must override the following functions:</span></span>  
  
-   <span data-ttu-id="4bd54-139">IRowset::GetNextRows</span><span class="sxs-lookup"><span data-stu-id="4bd54-139">IRowset::GetNextRows</span></span>  
  
-   <span data-ttu-id="4bd54-140">IRowset::AddRefRows</span><span class="sxs-lookup"><span data-stu-id="4bd54-140">IRowset::AddRefRows</span></span>  
  
-   <span data-ttu-id="4bd54-141">IRowset::GetData</span><span class="sxs-lookup"><span data-stu-id="4bd54-141">IRowset::GetData</span></span>  
  
-   <span data-ttu-id="4bd54-142">IRowset::ReleaseRows</span><span class="sxs-lookup"><span data-stu-id="4bd54-142">IRowset::ReleaseRows</span></span>  
  
-   <span data-ttu-id="4bd54-143">IRowset::RestartPosition</span><span class="sxs-lookup"><span data-stu-id="4bd54-143">IRowset::RestartPosition</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="4bd54-144">Native Client OLE DB 访问接口将一次从使用者行集对象中读取一行或多行，以便在表值参数中支持流行为。</span><span class="sxs-lookup"><span data-stu-id="4bd54-144">Native Client OLE DB Provider will read one or more rows at a time from the consumer rowset object to support streaming behavior in table-valued parameters.</span></span> <span data-ttu-id="4bd54-145">例如，用户可能在磁盘上（而非内存中）具有表值参数行集数据，当 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口要求时，可能实现从磁盘读取数据的功能。</span><span class="sxs-lookup"><span data-stu-id="4bd54-145">For example, the user might have the table-valued parameter rowset data on disk (not in memory) and might implement the functionality to read data from the disk when required by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider.</span></span>  
  
 <span data-ttu-id="4bd54-146">使用者将 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 使用表值参数行集对象上的 IAccessor：： CreateAccessor 将其数据格式与 Native Client OLE DB 提供程序进行通信。</span><span class="sxs-lookup"><span data-stu-id="4bd54-146">The consumer will communicate its data format to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider by using IAccessor::CreateAccessor on the table-valued parameter rowset object.</span></span> <span data-ttu-id="4bd54-147">当从使用者缓冲区读取数据时，访问接口将验证所有可写入和非默认列是否至少可用于一个取值函数句柄，并使用相应的句柄来读取列数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-147">When reading data from the consumer buffer, the provider verifies that all the writable and non-default columns are available through at least one accessor handle, and uses the corresponding handles to read columns data.</span></span> <span data-ttu-id="4bd54-148">为了避免混乱，在表值参数行集列与绑定之间应具有一对一的对应关系。</span><span class="sxs-lookup"><span data-stu-id="4bd54-148">To avoid ambiguity, there should be a one-to-one correspondence between a table-valued parameter rowset column and a binding.</span></span> <span data-ttu-id="4bd54-149">与同一列的重复绑定将导致错误。</span><span class="sxs-lookup"><span data-stu-id="4bd54-149">Duplicate bindings to the same column will result in an error.</span></span> <span data-ttu-id="4bd54-150">此外，每个取值函数都应按顺序拥有 DBBindings 的 iOrdinal\*\* 成员。</span><span class="sxs-lookup"><span data-stu-id="4bd54-150">Also, each accessor is expected to have the *iOrdinal* member of DBBindings in sequence.</span></span> <span data-ttu-id="4bd54-151">对于 IRowset::GetData 的调用数将与每行的取值函数数量相同，调用的顺序将基于 iOrdinal 值的顺序（从低值到高值）\*\*。</span><span class="sxs-lookup"><span data-stu-id="4bd54-151">There will be as many calls to IRowset::GetData as the number of accessors per row, and the order of calls will be based on the order of *iOrdinal* value from lower to higher values.</span></span>  
  
 <span data-ttu-id="4bd54-152">访问接口应实现由表值参数行集对象显示的大多数接口。</span><span class="sxs-lookup"><span data-stu-id="4bd54-152">The provider is expected to implement most of the interfaces exposed by the table-valued parameter rowset object.</span></span> <span data-ttu-id="4bd54-153">使用者将使用最少的接口实现行集对象 (IRowset)。</span><span class="sxs-lookup"><span data-stu-id="4bd54-153">The consumer will implement a rowset object with minimal interfaces (IRowset).</span></span> <span data-ttu-id="4bd54-154">由于盲聚合 (blind aggregation)，因此，表值参数行集对象将实现剩下的所必需的行集对象接口。</span><span class="sxs-lookup"><span data-stu-id="4bd54-154">Because of blind aggregation, the remaining mandatory rowset object interfaces will be implemented by the table-valued parameter rowset object.</span></span>  
  
 <span data-ttu-id="4bd54-155">对于任何其他行集对象（如对于任何 OLE DB 访问接口获得的行集对象），使用者提供的行集必须按照 OLE DB 规范要求实现所有必需的行集对象接口。</span><span class="sxs-lookup"><span data-stu-id="4bd54-155">For any other rowset object, such as rowset objects obtained for any OLE DB provider, the consumer-provided rowset must implement all the mandatory rowset object interfaces as specified in the OLE DB specification.</span></span>  
  
 <span data-ttu-id="4bd54-156">在执行时，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口将回调行集对象以提取行并读取列数据。</span><span class="sxs-lookup"><span data-stu-id="4bd54-156">At the time of execution, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB Provider will call back to the rowset object to fetch rows and read column data.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4bd54-157">另请参阅</span><span class="sxs-lookup"><span data-stu-id="4bd54-157">See Also</span></span>  
 <span data-ttu-id="4bd54-158">[表值参数 &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span><span class="sxs-lookup"><span data-stu-id="4bd54-158">[Table-Valued Parameters &#40;OLE DB&#41;](table-valued-parameters-ole-db.md) </span></span>  
 [<span data-ttu-id="4bd54-159">使用表值参数 (OLE DB)</span><span class="sxs-lookup"><span data-stu-id="4bd54-159">Use Table-Valued Parameters &#40;OLE DB&#41;</span></span>](../native-client-ole-db-how-to/use-table-valued-parameters-ole-db.md)  
  

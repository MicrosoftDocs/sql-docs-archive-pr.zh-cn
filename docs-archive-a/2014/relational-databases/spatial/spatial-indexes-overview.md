---
title: 空间索引概述 | Microsoft Docs
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- spatial indexes [SQL Server]
ms.assetid: b1ae7b78-182a-459e-ab28-f743e43f8293
author: MladjoA
ms.author: mlandzic
ms.openlocfilehash: 36406bd60b4204469aca3d20862020870a8832fe
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87587759"
---
# <a name="spatial-indexes-overview"></a><span data-ttu-id="53be7-102">空间索引概述</span><span class="sxs-lookup"><span data-stu-id="53be7-102">Spatial Indexes Overview</span></span>
  [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="53be7-103">支持空间数据和空间索引。</span><span class="sxs-lookup"><span data-stu-id="53be7-103">supports spatial data and spatial indexes.</span></span> <span data-ttu-id="53be7-104">“空间索引”  是一种扩展索引，允许您对空间列编制索引。</span><span class="sxs-lookup"><span data-stu-id="53be7-104">A *spatial index* is a type of extended index that allows you to index a spatial column.</span></span> <span data-ttu-id="53be7-105">空间列是包含空间数据类型（如 `geometry` 或 `geography`）的数据的表列。</span><span class="sxs-lookup"><span data-stu-id="53be7-105">A spatial column is a table column that contains data of a spatial data type, such as `geometry` or `geography`.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="53be7-106">有关 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]中引入的空间功能的详细说明和示例（包括影响空间索引的功能），请下载白皮书 [SQL Server 2012 中的新空间功能](https://go.microsoft.com/fwlink/?LinkId=226407)。</span><span class="sxs-lookup"><span data-stu-id="53be7-106">For a detailed description and examples of spatial features introduced in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], including features that affect spatial indexes, download the white paper, [New Spatial Features in SQL Server 2012](https://go.microsoft.com/fwlink/?LinkId=226407).</span></span>

##  <a name="about-spatial-indexes"></a><a name="about"></a> <span data-ttu-id="53be7-107">关于空间索引</span><span class="sxs-lookup"><span data-stu-id="53be7-107">About Spatial Indexes</span></span>

###  <a name="decomposing-indexed-space-into-a-grid-hierarchy"></a><a name="decompose"></a> <span data-ttu-id="53be7-108">将索引空间分解成网格层次结构</span><span class="sxs-lookup"><span data-stu-id="53be7-108">Decomposing Indexed Space into a Grid Hierarchy</span></span>
 <span data-ttu-id="53be7-109">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，空间索引使用 B 树构建而成，也就是说，这些索引必须按 B 树的线性顺序表示二维空间数据。</span><span class="sxs-lookup"><span data-stu-id="53be7-109">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes are built using B-trees, which means that the indexes must represent the 2-dimensional spatial data in the linear order of B-trees.</span></span> <span data-ttu-id="53be7-110">因此，将数据读入空间索引之前， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 先实现对空间的分层均匀分解。</span><span class="sxs-lookup"><span data-stu-id="53be7-110">Therefore, before reading data into a spatial index, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] implements a hierarchical uniform decomposition of space.</span></span> <span data-ttu-id="53be7-111">索引创建过程会将空间  分解成一个四级  网格层次结构。</span><span class="sxs-lookup"><span data-stu-id="53be7-111">The index-creation process *decomposes* the space into a four-level *grid hierarchy*.</span></span> <span data-ttu-id="53be7-112">这些级别指的是  第 1 级（顶级）、  第 2 级、  第 3 级和  第 4 级。</span><span class="sxs-lookup"><span data-stu-id="53be7-112">These levels are referred to as *level 1* (the top level), *level 2*, *level 3*, and *level 4*.</span></span>

 <span data-ttu-id="53be7-113">每个后续级别都会进一步分解其上一级，因此上一级别的每个单元都包含下一级别的整个网格。</span><span class="sxs-lookup"><span data-stu-id="53be7-113">Each successive level further decomposes the level above it, so each upper-level cell contains a complete grid at the next level.</span></span> <span data-ttu-id="53be7-114">在给定级别上，所有网格沿两个轴都有相同数目的单元（例如 4x4 或 8x8），并且单元的大小都相同。</span><span class="sxs-lookup"><span data-stu-id="53be7-114">On a given level, all the grids have the same number of cells along both axes (for example, 4x4 or 8x8), and the cells are all one size.</span></span>

 <span data-ttu-id="53be7-115">下图显示了网格层次结构每个级别的右上角单元被分解成 4x4 网格的情况。</span><span class="sxs-lookup"><span data-stu-id="53be7-115">The following illustration shows the decomposition for the upper-right cell at each level of the grid hierarchy into a 4x4 grid.</span></span> <span data-ttu-id="53be7-116">事实上，所有单元都是以这种方式分解的。</span><span class="sxs-lookup"><span data-stu-id="53be7-116">In reality, all the cells are decomposed in this way.</span></span> <span data-ttu-id="53be7-117">因此，以此为例，将一个空间分解成四个级别的 4x4 网格实际上会总共产生 65,536 个第四级单元。</span><span class="sxs-lookup"><span data-stu-id="53be7-117">Thus, for example, decomposing a space into four levels of 4x4 grids actually produces a total of 65,536 level-four cells.</span></span>

 <span data-ttu-id="53be7-118">![递归分割的四个级别](../../database-engine/media/spndx-recursive-levels-telescoped.gif "递归分割的四个级别")</span><span class="sxs-lookup"><span data-stu-id="53be7-118">![Four-levels of recursive tessellation](../../database-engine/media/spndx-recursive-levels-telescoped.gif "Four-levels of recursive tessellation")</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-119">针对空间索引进行的空间分解与应用程序数据使用的度量单位无关。</span><span class="sxs-lookup"><span data-stu-id="53be7-119">The decomposition of space for a spatial index is independent of the unit of measurement that the application data uses.</span></span>

 <span data-ttu-id="53be7-120">网格层次结构的单元是利用多种 Hilbert 空间填充曲线以线性方式编号的。</span><span class="sxs-lookup"><span data-stu-id="53be7-120">Grid hierarchy cells are numbered in a linear fashion by using a variation of the Hilbert space-filling curve.</span></span> <span data-ttu-id="53be7-121">然而，出于演示目的，这里使用的是简单的按行编号，而不是由 Hilbert 曲线实际产生的编号。</span><span class="sxs-lookup"><span data-stu-id="53be7-121">For the purpose of illustration, however, this discussion uses a simple row-wise numbering, instead of the numbering that is actually produced by the Hilbert curve.</span></span> <span data-ttu-id="53be7-122">在下图中，几个表示建筑物的多边形和表示街道的线已经放进了一个 4x4 的 1 级网格中。</span><span class="sxs-lookup"><span data-stu-id="53be7-122">In the following illustration, several polygons that represent buildings, and lines that represent streets, have already been placed into a 4x4, level-1 grid.</span></span> <span data-ttu-id="53be7-123">第 1 级单元的编号为 1 到 16，编号从左上角的单元开始。</span><span class="sxs-lookup"><span data-stu-id="53be7-123">The level-1 cells are numbered from 1 through 16, starting with the upper-left cell.</span></span>

 <span data-ttu-id="53be7-124">![放置在 4x4 第 1 级网格上的多边形和直线](../../database-engine/media/spndx-level-1-objects.gif "放置在 4x4 第 1 级网格上的多边形和直线")</span><span class="sxs-lookup"><span data-stu-id="53be7-124">![Polygons and lines placed into a 4x4 level-1 grid](../../database-engine/media/spndx-level-1-objects.gif "Polygons and lines placed into a 4x4 level-1 grid")</span></span>

#### <a name="grid-density"></a><span data-ttu-id="53be7-125">网格密度</span><span class="sxs-lookup"><span data-stu-id="53be7-125">Grid Density</span></span>
 <span data-ttu-id="53be7-126">沿网格轴的单元数目确定了网格的 *“密度”* ：单元数目越大，网格的密度越大。</span><span class="sxs-lookup"><span data-stu-id="53be7-126">The number of cells along the axes of a grid determines its *density*: the larger the number, the denser the grid.</span></span> <span data-ttu-id="53be7-127">例如，8x8 网格（产生 64 个单元）的密度就大于 4x4 网格（产生 16 个单元）的密度。</span><span class="sxs-lookup"><span data-stu-id="53be7-127">For example, an 8x8 grid (which produces 64 cells), is denser than a 4x4 grid (which produces 16 cells).</span></span> <span data-ttu-id="53be7-128">网格密度是以每个级别为基础定义的。</span><span class="sxs-lookup"><span data-stu-id="53be7-128">Grid density is defined on a per-level basis.</span></span>

 <span data-ttu-id="53be7-129">空间索引的 [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句支持 GRIDS 子句，使用该子句可以在不同级别指定不同的网格密度。</span><span class="sxs-lookup"><span data-stu-id="53be7-129">The [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a GRIDS clause that enables you to specify different grid densities at different levels.</span></span> <span data-ttu-id="53be7-130">可以使用下列关键字之一指定给定级别的网格密度。</span><span class="sxs-lookup"><span data-stu-id="53be7-130">The grid density for a given level is specified by using one of the following keywords.</span></span>

|<span data-ttu-id="53be7-131">关键字</span><span class="sxs-lookup"><span data-stu-id="53be7-131">Keyword</span></span>|<span data-ttu-id="53be7-132">网格配置</span><span class="sxs-lookup"><span data-stu-id="53be7-132">Grid configuration</span></span>|<span data-ttu-id="53be7-133">单元数目</span><span class="sxs-lookup"><span data-stu-id="53be7-133">Number of cells</span></span>|
|-------------|------------------------|---------------------|
|<span data-ttu-id="53be7-134">LOW</span><span class="sxs-lookup"><span data-stu-id="53be7-134">LOW</span></span>|<span data-ttu-id="53be7-135">4X4</span><span class="sxs-lookup"><span data-stu-id="53be7-135">4X4</span></span>|<span data-ttu-id="53be7-136">16</span><span class="sxs-lookup"><span data-stu-id="53be7-136">16</span></span>|
|<span data-ttu-id="53be7-137">MEDIUM</span><span class="sxs-lookup"><span data-stu-id="53be7-137">MEDIUM</span></span>|<span data-ttu-id="53be7-138">8X8</span><span class="sxs-lookup"><span data-stu-id="53be7-138">8X8</span></span>|<span data-ttu-id="53be7-139">64</span><span class="sxs-lookup"><span data-stu-id="53be7-139">64</span></span>|
|<span data-ttu-id="53be7-140">HIGH</span><span class="sxs-lookup"><span data-stu-id="53be7-140">HIGH</span></span>|<span data-ttu-id="53be7-141">16X16</span><span class="sxs-lookup"><span data-stu-id="53be7-141">16X16</span></span>|<span data-ttu-id="53be7-142">256</span><span class="sxs-lookup"><span data-stu-id="53be7-142">256</span></span>|

 <span data-ttu-id="53be7-143">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，当数据库兼容级别设置为 100 或更低时，在所有级别上默认值为 MEDIUM。</span><span class="sxs-lookup"><span data-stu-id="53be7-143">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], when the database compatibility level is set to 100 or lower, then the default is MEDIUM on all levels.</span></span> <span data-ttu-id="53be7-144">当数据库兼容级别设置为 110 或更高时，默认值为自动网格方案。</span><span class="sxs-lookup"><span data-stu-id="53be7-144">When the database compatibility level is set to 110 or higher, then the default is an auto grid scheme.</span></span>

 <span data-ttu-id="53be7-145">您可以通过指定非默认的网格密度控制分解过程。</span><span class="sxs-lookup"><span data-stu-id="53be7-145">You can control the decomposition process by specifying non-default grid densities.</span></span> <span data-ttu-id="53be7-146">例如，在不同级别指定不同网格密度对于基于索引空间的大小和空间列中的对象来优化索引可能非常有用。</span><span class="sxs-lookup"><span data-stu-id="53be7-146">For example, different grid densities on different levels might be useful for fine tuning an index based on the size of the indexed space and the objects in the spatial column.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-147">当数据库兼容级别设置为 100 或更低时，空间索引的网格密度显示在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目录视图的 level_1_grid、level_2_grid、level_3_grid 和 level_4_grid 列中。</span><span class="sxs-lookup"><span data-stu-id="53be7-147">The grid densities of a spatial index are visible in the level_1_grid, level_2_grid, level_3_grid, and level_4_grid columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view when the database compatibility level is set to 100 or lower.</span></span> <span data-ttu-id="53be7-148">`GEOMETRY_AUTO_GRID` / `GEOGRAPHY_AUTO_GRID` 分割方案选项不填充这些列。</span><span class="sxs-lookup"><span data-stu-id="53be7-148">The `GEOMETRY_AUTO_GRID`/`GEOGRAPHY_AUTO_GRID` tessellation scheme options do not populate these columns.</span></span> <span data-ttu-id="53be7-149">`NULL`当使用自动网格选项时，spatial_index_tessellations 目录视图具有这些列的值。</span><span class="sxs-lookup"><span data-stu-id="53be7-149">sys.spatial_index_tessellations catalog view has `NULL` values for these columns when the auto grid options are used.</span></span>

###  <a name="tessellation"></a><a name="tessellation"></a><span data-ttu-id="53be7-150">镶嵌</span><span class="sxs-lookup"><span data-stu-id="53be7-150">Tessellation</span></span>
 <span data-ttu-id="53be7-151">将索引空间分解成网格层次结构后，空间索引将逐行读取空间列中的数据。</span><span class="sxs-lookup"><span data-stu-id="53be7-151">After decomposition of an indexed space into a grid hierarchy, the spatial index reads the data from the spatial column, row by row.</span></span> <span data-ttu-id="53be7-152">读取空间对象（或实例）的数据后，空间索引将为该对象执行 \*\* 分割过程。</span><span class="sxs-lookup"><span data-stu-id="53be7-152">After reading the data for a spatial object (or instance), the spatial index performs a *tessellation process* for that object.</span></span> <span data-ttu-id="53be7-153">分割过程通过将对象与其接触的网格单元集（\*\* 接触单元）相关联使该对象适合网格层次结构。</span><span class="sxs-lookup"><span data-stu-id="53be7-153">The tessellation processfits the object into the grid hierarchy by associating the object with a set of grid cells that it touches (*touched cells*).</span></span> <span data-ttu-id="53be7-154">从网格层次结构的第 1 级开始，分割过程以“广度优先” \*\* 方式对整个级别进行处理。</span><span class="sxs-lookup"><span data-stu-id="53be7-154">Starting at level 1 of the grid hierarchy, the tessellation process proceeds *breadth first* across the level.</span></span> <span data-ttu-id="53be7-155">在可能的情况下，此过程可以连续处理所有四个级别，一次处理一个级别。</span><span class="sxs-lookup"><span data-stu-id="53be7-155">Potentially, the process can continue through all four levels, one level at a time.</span></span>

 <span data-ttu-id="53be7-156">分割过程的输出为对象的空间索引中所记录的接触单元集。</span><span class="sxs-lookup"><span data-stu-id="53be7-156">The output of the tessellation process is a set of touched cells that are recorded in the spatial index for the object.</span></span> <span data-ttu-id="53be7-157">通过引用这些已记录单元，空间索引可以确定该对象在空间中相对于空间列中也存储在索引中的其他对象的位置。</span><span class="sxs-lookup"><span data-stu-id="53be7-157">By referring to these recorded cells, the spatial index can locate the object in space relative to other objects in the spatial column that are also stored in the index.</span></span>

#### <a name="tessellation-rules"></a><span data-ttu-id="53be7-158">分割规则</span><span class="sxs-lookup"><span data-stu-id="53be7-158">Tessellation Rules</span></span>
 <span data-ttu-id="53be7-159">为了限制为对象记录的接触单元数，分割过程采用了几个分割规则。</span><span class="sxs-lookup"><span data-stu-id="53be7-159">To limit the number of touched cells that are recorded for an object, the tessellation process applies several tessellation rules.</span></span> <span data-ttu-id="53be7-160">这些规则确定分割过程的深度以及在索引中记录哪些接触单元。</span><span class="sxs-lookup"><span data-stu-id="53be7-160">These rules determine the depth of the tessellation process and which of the touched cells are recorded in the index.</span></span>

 <span data-ttu-id="53be7-161">这些规则如下：</span><span class="sxs-lookup"><span data-stu-id="53be7-161">These rules are as follows:</span></span>

-   <span data-ttu-id="53be7-162">覆盖规则</span><span class="sxs-lookup"><span data-stu-id="53be7-162">The covering rule</span></span>

     <span data-ttu-id="53be7-163">如果一个对象完全盖住了某个单元，则称该单元由该对象所“覆盖” \*\* 。</span><span class="sxs-lookup"><span data-stu-id="53be7-163">If the object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="53be7-164">被覆盖的单元会参与计数，但不进行分割。</span><span class="sxs-lookup"><span data-stu-id="53be7-164">A covered cell is counted and is not tessellated.</span></span> <span data-ttu-id="53be7-165">此规则应用于网格层次结构的所有级别。</span><span class="sxs-lookup"><span data-stu-id="53be7-165">This rule applies at all levels of the grid hierarchy.</span></span> <span data-ttu-id="53be7-166">覆盖规则简化了分割过程，并减少了空间索引记录的数据量。</span><span class="sxs-lookup"><span data-stu-id="53be7-166">The covering rule simplifies the tessellation process and reduces the amount of data that a spatial index records.</span></span>

-   <span data-ttu-id="53be7-167">每对象单元数规则</span><span class="sxs-lookup"><span data-stu-id="53be7-167">The cells-per-object rule</span></span>

     <span data-ttu-id="53be7-168">此规则强制执行\*\* 每个对象的单元数限制，该限制确定每个对象可以具有的最大单元数（级别 1 例外）。</span><span class="sxs-lookup"><span data-stu-id="53be7-168">This rule enforces the *cells-per-object limit*, which determines the maximum number of cells that can be counted for each object, except on level 1.</span></span> <span data-ttu-id="53be7-169">在较低级别上，每个对象的单元数规则控制可以记录有关该对象的信息量。</span><span class="sxs-lookup"><span data-stu-id="53be7-169">At lower levels, the cells-per-object rule controls the amount of information that can be recorded about the object.</span></span>

-   <span data-ttu-id="53be7-170">最深单元规则</span><span class="sxs-lookup"><span data-stu-id="53be7-170">The deepest-cell rule</span></span>

     <span data-ttu-id="53be7-171">最深单元规则通过只记录已为对象分割的最底部单元来生成该对象的最近似对象。</span><span class="sxs-lookup"><span data-stu-id="53be7-171">The deepest-cell rule generates the best approximation of an object by recording only the bottom-most cells that have been tessellated for the object.</span></span> <span data-ttu-id="53be7-172">父单元不计入每对象单元数，这些单元不记录在索引中。</span><span class="sxs-lookup"><span data-stu-id="53be7-172">Parent cells do not contribute to the cells-per-object count, and they are not recorded in the index.</span></span>

 <span data-ttu-id="53be7-173">这些分割规则依次逐步应用于每个网格级别。</span><span class="sxs-lookup"><span data-stu-id="53be7-173">These tessellation rules are applied recursively on each grid level.</span></span> <span data-ttu-id="53be7-174">此部分的其余内容更详细地介绍了这些分割规则。</span><span class="sxs-lookup"><span data-stu-id="53be7-174">The rest of this section describes the tessellation rules in more detail.</span></span>

#### <a name="covering-rule"></a><span data-ttu-id="53be7-175">覆盖规则</span><span class="sxs-lookup"><span data-stu-id="53be7-175">Covering Rule</span></span>
 <span data-ttu-id="53be7-176">如果一个对象完全盖住了某个单元，则称该单元由该对象所“覆盖” \*\* 。</span><span class="sxs-lookup"><span data-stu-id="53be7-176">If an object completely covers a cell, that cell is said to be *covered* by the object.</span></span> <span data-ttu-id="53be7-177">例如，在下图中，一个第 2 级单元 15.11 完全由八边形的中间部分所覆盖。</span><span class="sxs-lookup"><span data-stu-id="53be7-177">For example, in the following illustration, one of the second-level cells, 15.11, is completely covered by the middle portion of an octagon.</span></span>

 <span data-ttu-id="53be7-178">![表面优化](../../database-engine/media/spndx-opt-covering.gif "表面优化")</span><span class="sxs-lookup"><span data-stu-id="53be7-178">![Covering optimization](../../database-engine/media/spndx-opt-covering.gif "Covering optimization")</span></span>

 <span data-ttu-id="53be7-179">被覆盖的单元会参与计数并记录在索引中，但不再进行分割。</span><span class="sxs-lookup"><span data-stu-id="53be7-179">A covered cell is counted and recorded in the index, and the cell is not tessellated any further.</span></span>

#### <a name="cells-per-object-rule"></a><span data-ttu-id="53be7-180">每对象单元数规则</span><span class="sxs-lookup"><span data-stu-id="53be7-180">Cells-Per-Object Rule</span></span>
 <span data-ttu-id="53be7-181">每个对象的分割程度主要取决于空间索引的\*\* 每对象单元数限制。</span><span class="sxs-lookup"><span data-stu-id="53be7-181">The extent of tessellation of each object depends primarily on the *cells-per-object limit* of the spatial index.</span></span> <span data-ttu-id="53be7-182">此限制确定了对于每个对象分割可以计数的最大单元数。</span><span class="sxs-lookup"><span data-stu-id="53be7-182">This limit defines the maximum number of cells that tessellation can count per object.</span></span> <span data-ttu-id="53be7-183">然而，请注意，每对象单元数规则不对第 1 级强制执行，因此可能超出此限制。</span><span class="sxs-lookup"><span data-stu-id="53be7-183">Note, however, that the cells-per-object rule is not enforced for level 1, so it is possible to exceed this limit.</span></span> <span data-ttu-id="53be7-184">如果第 1 级计数达到（或超出）每对象单元数限制，则在较低级别不再进行分割。</span><span class="sxs-lookup"><span data-stu-id="53be7-184">If the level-1 count reaches, or exceeds, the cells-per-object limit, no further tessellation occurs at the lower levels.</span></span>

 <span data-ttu-id="53be7-185">只要计数低于每对象单元数限制，分割过程就将继续。</span><span class="sxs-lookup"><span data-stu-id="53be7-185">As long as the count is less than the cells-per-object limit, the tessellation process continues.</span></span> <span data-ttu-id="53be7-186">从编号最低的接触单元（例如上图中的单元 15.6）开始，此过程将测试每个单元以评估是对其进行计数还是进行分割。</span><span class="sxs-lookup"><span data-stu-id="53be7-186">Starting with the lowest-number touched cell (for example, cell 15.6 in the preceding illustration), the process tests each cell to evaluate whether to count it or tessellate it.</span></span> <span data-ttu-id="53be7-187">如果分割某单元将超出每对象单元数限制，将对该单元进行计数而不进行分割。</span><span class="sxs-lookup"><span data-stu-id="53be7-187">If tessellating a cell would exceed the cells-per-object limit, the cell is counted and not tessellated.</span></span> <span data-ttu-id="53be7-188">否则，将对该单元进行分割，而对由对象接触的较低级别的单元进行计数。</span><span class="sxs-lookup"><span data-stu-id="53be7-188">Otherwise, the cell is tessellated, and the lower-level cells that are touched by the object are counted.</span></span> <span data-ttu-id="53be7-189">分割过程将以这种方式在整个级别的广度范围内继续进行。</span><span class="sxs-lookup"><span data-stu-id="53be7-189">The tessellation process continues in this way, breadth-wise, across the level.</span></span> <span data-ttu-id="53be7-190">此过程对低级别网格的分割单元依次逐步进行重复，直至达到限制或不再有要计数的单元为止。</span><span class="sxs-lookup"><span data-stu-id="53be7-190">This process is repeated recursively for the lower-level grids of the tessellated cells until the limit is reached or there are no more cells to count.</span></span>

 <span data-ttu-id="53be7-191">例如，上图显示了一个完全适合第 1 级网格的单元 15 的八边形。</span><span class="sxs-lookup"><span data-stu-id="53be7-191">For example, consider the preceding illustration, which shows an octagon that fits completely into cell 15 of the level-1 grid.</span></span> <span data-ttu-id="53be7-192">在此图中，单元 15 已进行分割，将八边形分成了九个二级单元。</span><span class="sxs-lookup"><span data-stu-id="53be7-192">In the figure, cell 15 has been tessellated, dissecting the octagon into nine level-2 cells.</span></span> <span data-ttu-id="53be7-193">此图假定每对象单元数限制为 9 或更大。</span><span class="sxs-lookup"><span data-stu-id="53be7-193">This illustration assumes that the cells-per-object limit is 9 or more.</span></span> <span data-ttu-id="53be7-194">然而，如果每对象单元数限制为 8 或更小，则单元 15 将不进行分割，而只为该对象对单元 15 进行计数。</span><span class="sxs-lookup"><span data-stu-id="53be7-194">If the cells-per-object limit were 8 or less, however, cell 15 would not be tessellated, and only that cell 15 would be counted for the object.</span></span>

 <span data-ttu-id="53be7-195">默认情况下，每对象单元数限制为每个对象 16 个单元，这将在大多数空间索引的空间和精度之间提供一个令人满意的折中方案。</span><span class="sxs-lookup"><span data-stu-id="53be7-195">By default, the cells-per-object limit is 16 cells per object, which provides a satisfactory trade-off between space and precision for most spatial indexes.</span></span> <span data-ttu-id="53be7-196">但是， [CREATE CELLS INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql) [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句支持 CELLS_PER_OBJECT `=` *n*子句，该子句可用于指定1到8192之间的每对象单元数限制（包括1和）。</span><span class="sxs-lookup"><span data-stu-id="53be7-196">However, the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement supports a CELLS_PER_OBJECT`=`*n* clause that enables you to specify a cells-per-object limit between 1 and 8192, inclusive.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-197">空间索引的 **cells_per_object** 设置显示在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目录视图中。</span><span class="sxs-lookup"><span data-stu-id="53be7-197">The **cells_per_object** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="deepest-cell-rule"></a><span data-ttu-id="53be7-198">最深单元规则</span><span class="sxs-lookup"><span data-stu-id="53be7-198">Deepest-Cell Rule</span></span>
 <span data-ttu-id="53be7-199">最深单元规则利用每个较低级别单元属于其上级单元这一事实：第 4 级单元属于第 3 级单元，第 3 级单元属于第 2 级单元，第 2 级单元属于第 1 级单元。</span><span class="sxs-lookup"><span data-stu-id="53be7-199">The deepest-cell rule exploits the fact that every lower-level cell belongs to the cell above it: a level-4 cell belongs to a level-3 cell, a level-3 cell belongs to a level-2 cell, and a level-2 cell belongs to a level-1 cell.</span></span> <span data-ttu-id="53be7-200">例如，属于单元 1.1.1.1 的对象也属于单元 1.1.1、1.1 和 1。</span><span class="sxs-lookup"><span data-stu-id="53be7-200">For example, an object that belongs to cell 1.1.1.1 also belongs to cell 1.1.1, cell 1.1, and cell 1.</span></span> <span data-ttu-id="53be7-201">这种单元层次结构关系的知识内置到查询处理器。</span><span class="sxs-lookup"><span data-stu-id="53be7-201">Knowledge of such cell-hierarchy relationships is built into the query processor.</span></span> <span data-ttu-id="53be7-202">因此，只有最深级别的单元需要记录在索引中，从而最大限度地减少了索引需要存储的信息。</span><span class="sxs-lookup"><span data-stu-id="53be7-202">Therefore, only the deepest-level cells need to be recorded in the index, minimizing the information that the index needs to store.</span></span>

 <span data-ttu-id="53be7-203">在下图中，相对较小的菱形多边形被分割。</span><span class="sxs-lookup"><span data-stu-id="53be7-203">In the following illustration, a relatively small diamond-shaped polygon is tessellated.</span></span> <span data-ttu-id="53be7-204">索引使用默认的每对象单元数限制 16，此对象较小，未达到该限制。</span><span class="sxs-lookup"><span data-stu-id="53be7-204">The index uses the default cells-per-object limit of 16, which is not reached for this small object.</span></span> <span data-ttu-id="53be7-205">因此，分割一直下至第 4 级。</span><span class="sxs-lookup"><span data-stu-id="53be7-205">Therefore, tessellation continues down to level 4.</span></span> <span data-ttu-id="53be7-206">此多边形驻留在以下的第 1 级到第 3 级的单元中：4、4.4 以及 4.4.10 和 4.4.14。</span><span class="sxs-lookup"><span data-stu-id="53be7-206">The polygon resides in the following level-1 through level-3 cells: 4, 4.4, and 4.4.10 and 4.4.14.</span></span> <span data-ttu-id="53be7-207">然而，使用最深单元规则，分割将仅对十二个位于第 4 级的单元进行计数：4.4.10.13-15 以及 4.4.14.1-3、4.4.14.5-7 和 4.4.14.9-11。</span><span class="sxs-lookup"><span data-stu-id="53be7-207">However, using the deepest-cell rule, the tessellation counts only the twelve level-4 cells: 4.4.10.13-15 and 4.4.14.1-3, 4.4.14.5-7, and 4.4.14.9-11.</span></span>

 <span data-ttu-id="53be7-208">![最深单元优化](../../database-engine/media/spndx-opt-deepest-cell.gif "最深单元优化")</span><span class="sxs-lookup"><span data-stu-id="53be7-208">![Deepest-cell optimization](../../database-engine/media/spndx-opt-deepest-cell.gif "Deepest-cell optimization")</span></span>

###  <a name="tessellation-schemes"></a><a name="schemes"></a><span data-ttu-id="53be7-209">分割方案</span><span class="sxs-lookup"><span data-stu-id="53be7-209">Tessellation Schemes</span></span>
 <span data-ttu-id="53be7-210">空间索引的行为部分取决于“分割方案” \*\*。</span><span class="sxs-lookup"><span data-stu-id="53be7-210">The behavior of a spatial index depends partly on its *tessellation scheme*.</span></span> <span data-ttu-id="53be7-211">分割方案特定于数据类型。</span><span class="sxs-lookup"><span data-stu-id="53be7-211">The tessellation scheme is data-type specific.</span></span> <span data-ttu-id="53be7-212">在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，空间索引支持两种分割方案：</span><span class="sxs-lookup"><span data-stu-id="53be7-212">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], spatial indexes support two tessellation schemes:</span></span>

-   <span data-ttu-id="53be7-213">*几何网格分割*，它是数据类型的方案 `geometry` 。</span><span class="sxs-lookup"><span data-stu-id="53be7-213">*Geometry grid tessellation*, which is the scheme for the `geometry` data type.</span></span>

-   <span data-ttu-id="53be7-214">*地理网格分割*，适用于数据类型的列 `geography` 。</span><span class="sxs-lookup"><span data-stu-id="53be7-214">*Geography grid tessellation*, which applies to columns of the `geography` data type.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-215">空间索引的 **tessellation_scheme** 设置显示在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目录视图中。</span><span class="sxs-lookup"><span data-stu-id="53be7-215">The **tessellation_scheme** setting of a spatial index is visible in the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="geometry-grid-tessellation-scheme"></a><span data-ttu-id="53be7-216">几何图形网格分割方案</span><span class="sxs-lookup"><span data-stu-id="53be7-216">Geometry Grid Tessellation Scheme</span></span>
 <span data-ttu-id="53be7-217">GEOMETRY_AUTO_GRID 分割是 `geometry` 和更高版本的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 数据类型的默认分割方案。</span><span class="sxs-lookup"><span data-stu-id="53be7-217">GEOMETRY_AUTO_GRID tessellation is the default tessellation scheme for the `geometry` data type for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] and later.</span></span>  <span data-ttu-id="53be7-218">GEOMETRY_GRID 分割是 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中 geometry 数据类型的唯一可用分割方案。</span><span class="sxs-lookup"><span data-stu-id="53be7-218">GEOMETRY_GRID tessellation is the only tessellation scheme available for geometry data types in [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="53be7-219">本节讨论了与使用空间索引有关的几何图形网格分割的几个方面：支持的方法和边界框。</span><span class="sxs-lookup"><span data-stu-id="53be7-219">This section discusses aspects of geometry grid tessellation that are relevant to working with spatial indexes: supported methods and bounding boxes.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-220">您可以使用[CREATE 空间 INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)语句的 using (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) 子句显式指定此分割方案 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="53be7-220">You can explicitly specify this tessellation scheme by using the USING (GEOMETRY_AUTO_GRID/GEOMETRY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="the-bounding-box"></a><span data-ttu-id="53be7-221">边界框</span><span class="sxs-lookup"><span data-stu-id="53be7-221">The Bounding Box</span></span>
 <span data-ttu-id="53be7-222">几何图形数据占有的平面可以是无限的。</span><span class="sxs-lookup"><span data-stu-id="53be7-222">Geometric data occupies a plane that can be infinite.</span></span> <span data-ttu-id="53be7-223">然而，在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]中，空间索引需要有限空间。</span><span class="sxs-lookup"><span data-stu-id="53be7-223">In [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], however, a spatial index requires a finite space.</span></span> <span data-ttu-id="53be7-224">为了建立有限空间以用于分解，几何图形网格分割方案需要矩形“边界框” \*\*。</span><span class="sxs-lookup"><span data-stu-id="53be7-224">To establish a finite space for decomposition, the geometry grid tessellation scheme requires a rectangular *bounding box*.</span></span> <span data-ttu-id="53be7-225">边界框由四个坐标定义： `(` _x 最小值_**、最**_小值_和最大值 `)` `(` _x-max_**（**_y-最大_值）， `)` 它们存储为空间索引的属性。</span><span class="sxs-lookup"><span data-stu-id="53be7-225">The bounding box is defined by four coordinates, `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)`, which are stored as properties of the spatial index.</span></span> <span data-ttu-id="53be7-226">这些坐标所表示的意义如下：</span><span class="sxs-lookup"><span data-stu-id="53be7-226">These coordinates represent the following:</span></span>

-   <span data-ttu-id="53be7-227">\*\* x-min 是边界框左下角的 x 坐标。</span><span class="sxs-lookup"><span data-stu-id="53be7-227">*x-min* is the x-coordinate of the lower-left corner of the bounding box.</span></span>

-   <span data-ttu-id="53be7-228">\*\* y-min 是左下角的 y 坐标。</span><span class="sxs-lookup"><span data-stu-id="53be7-228">*y-min* is the y-coordinate of the lower-left corner.</span></span>

-   <span data-ttu-id="53be7-229">\*\* x-max 是右上角的 x 坐标。</span><span class="sxs-lookup"><span data-stu-id="53be7-229">*x-max* is the x-coordinate of the upper-right corner.</span></span>

-   <span data-ttu-id="53be7-230">\*\* y-max 是右上角的 y 坐标。</span><span class="sxs-lookup"><span data-stu-id="53be7-230">*y-max* is the y-coordinate of upper-right corner.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-231">这些坐标由[CREATE 空间索引](/sql/t-sql/statements/create-spatial-index-transact-sql)语句的 BOUNDING_BOX 子句指定 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="53be7-231">These coordinates are specified by the BOUNDING_BOX clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

 <span data-ttu-id="53be7-232">`(` _X 最小值_**、** 最_小值_ `)` 和最大 `(` _x-max_**,**_y_ `)` 坐标确定边界框的位置和尺寸。</span><span class="sxs-lookup"><span data-stu-id="53be7-232">The `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates determine the placement and dimensions of the bounding box.</span></span> <span data-ttu-id="53be7-233">边界框的外部空间视作一个编号为 0 的单元。</span><span class="sxs-lookup"><span data-stu-id="53be7-233">The space outside of the bounding box is treated as a single cell that is numbered 0.</span></span>

 <span data-ttu-id="53be7-234">空间索引将分解边界框的内部空间。</span><span class="sxs-lookup"><span data-stu-id="53be7-234">The spatial index decomposes the space inside the bounding box.</span></span> <span data-ttu-id="53be7-235">网格层次结构的第 1 级网格将填充边界框。</span><span class="sxs-lookup"><span data-stu-id="53be7-235">The level-1 grid of the grid hierarchy fills the bounding box.</span></span> <span data-ttu-id="53be7-236">若要在网格层次结构中放置几何对象，空间索引会将该对象的坐标与边界框的坐标进行比较。</span><span class="sxs-lookup"><span data-stu-id="53be7-236">To place a geometric object in the grid hierarchy, the spatial index compares the coordinates of the object to the bounding-box coordinates.</span></span>

 <span data-ttu-id="53be7-237">下图显示了由 `(` 边界框的_x 最小_**值、** 最_小_值和最大 `)` `(` _x-max_**,**_y_ `)` 坐标定义的点。</span><span class="sxs-lookup"><span data-stu-id="53be7-237">The following illustration shows the points defined by the `(`_x-min_**,**_y-min_`)` and `(`_x-max_**,**_y-max_`)` coordinates of the bounding box.</span></span> <span data-ttu-id="53be7-238">网格层次结构的顶级显示为 4x4 网格。</span><span class="sxs-lookup"><span data-stu-id="53be7-238">The top-level of the grid hierarchy is shown as a 4x4 grid.</span></span> <span data-ttu-id="53be7-239">出于演示的目的，这里省略了较低级别。</span><span class="sxs-lookup"><span data-stu-id="53be7-239">For the purpose of illustration, the lower levels are omitted.</span></span> <span data-ttu-id="53be7-240">边界框的外部空间用零 (0) 指示。</span><span class="sxs-lookup"><span data-stu-id="53be7-240">The space outside of the bounding box is indicated by a zero (0).</span></span> <span data-ttu-id="53be7-241">请注意，对象“A”部分超出了边界框，对象“B”完全位于边界框外部，即单元 0 中。</span><span class="sxs-lookup"><span data-stu-id="53be7-241">Note that object 'A' extends partly beyond the box, and object 'B' lies completely outside the box in cell 0.</span></span>

 <span data-ttu-id="53be7-242">![显示坐标和单元 0 的边界框。](../../database-engine/media/spndx-bb-4x4-objects.gif "显示坐标和单元 0 的边界框。")</span><span class="sxs-lookup"><span data-stu-id="53be7-242">![Bounding box showing coordinates and cell 0.](../../database-engine/media/spndx-bb-4x4-objects.gif "Bounding box showing coordinates and cell 0.")</span></span>

 <span data-ttu-id="53be7-243">边界框与应用程序空间数据的某些部分相对应。</span><span class="sxs-lookup"><span data-stu-id="53be7-243">A bounding box corresponds to some portion of an application's spatial data.</span></span> <span data-ttu-id="53be7-244">索引的边界框是完全包含存储在空间列中的数据还是只包含其中部分数据取决于应用程序。</span><span class="sxs-lookup"><span data-stu-id="53be7-244">Whether the bounding-box of the index completely contains the data stored in the spatial column, or only contains a portion, is up to the application.</span></span> <span data-ttu-id="53be7-245">只有针对完全位于边界框内部的对象的计算操作才会受益于空间索引。</span><span class="sxs-lookup"><span data-stu-id="53be7-245">Only operations computed on objects that are entirely inside of the bounding box benefit from the spatial index.</span></span> <span data-ttu-id="53be7-246">因此，若要获得 `geometry` 列的空间索引所能提供的最大优势，您需要指定一个包含所有或大多数对象的边界框。</span><span class="sxs-lookup"><span data-stu-id="53be7-246">Therefore, to gain the greatest advantage from a spatial index on a `geometry` column, you need to specify a bounding-box that contains all or most of the objects.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-247">空间索引的网格密度显示在 [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) 目录视图的 bounding_box_xmin、bounding_box_ymin、bounding_box_xmax 和 bounding_box_ymax 列中。</span><span class="sxs-lookup"><span data-stu-id="53be7-247">The grid densities of a spatial index are visible in the bounding_box_xmin, bounding_box_ymin, bounding_box_xmax, and bounding_box_ymax columns of the [sys.spatial_index_tessellations](/sql/relational-databases/system-catalog-views/sys-spatial-index-tessellations-transact-sql) catalog view.</span></span>

#### <a name="the-geography-grid-tessellation-scheme"></a><span data-ttu-id="53be7-248">地理网格分割方案</span><span class="sxs-lookup"><span data-stu-id="53be7-248">The Geography Grid Tessellation Scheme</span></span>
 <span data-ttu-id="53be7-249">此分割方案仅适用于 `geography` 列。</span><span class="sxs-lookup"><span data-stu-id="53be7-249">This tessellation scheme applies only to a `geography` column.</span></span> <span data-ttu-id="53be7-250">此部分总结了地理网格分割支持的方法，并讨论了如何将测量空间投影到平面上，该平面随后将分解成网格层次结构。</span><span class="sxs-lookup"><span data-stu-id="53be7-250">This section summarizes the methods that are supported by geography grid tessellation and discusses how geodetic space is projected onto a plane, which is then decomposed into a grid hierarchy.</span></span>

> [!NOTE]
>  <span data-ttu-id="53be7-251">您可以使用[CREATE 空间 INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)语句的 using (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) 子句显式指定此分割方案 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="53be7-251">You can explicitly specify this tessellation scheme by using the USING (GEOGRAPHY_AUTO_GRID/GEOGRAPHY_GRID) clause of the [CREATE SPATIAL INDEX](/sql/t-sql/statements/create-spatial-index-transact-sql)[!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span>

##### <a name="projection-of-the-geodetic-space-onto-a-plane"></a><span data-ttu-id="53be7-252">将测量空间投影到平面上</span><span class="sxs-lookup"><span data-stu-id="53be7-252">Projection of the Geodetic Space onto a Plane</span></span>
 <span data-ttu-id="53be7-253">对 `geography` 实例（对象）的计算将包含对象的空间视作测量椭圆体。</span><span class="sxs-lookup"><span data-stu-id="53be7-253">Computations on `geography` instances (objects) treat the space containing the objects as a geodetic ellipsoid.</span></span> <span data-ttu-id="53be7-254">若要分解此空间，地理网格分割方案将椭圆体表面分为上半球和下半球，然后执行下列步骤：</span><span class="sxs-lookup"><span data-stu-id="53be7-254">To decompose this space, the geography grid tessellation scheme divides the surface of the ellipsoid into its upper and lower hemispheres and then performs the following steps:</span></span>

1.  <span data-ttu-id="53be7-255">将每个半球投影在四边形棱锥图面上。</span><span class="sxs-lookup"><span data-stu-id="53be7-255">Projects each hemisphere onto the facets of a quadrilateral pyramid.</span></span>

2.  <span data-ttu-id="53be7-256">将两个棱锥图平展开。</span><span class="sxs-lookup"><span data-stu-id="53be7-256">Flattens the two pyramids.</span></span>

3.  <span data-ttu-id="53be7-257">联接平展的棱锥图以形成非欧几里得平面。</span><span class="sxs-lookup"><span data-stu-id="53be7-257">Joins the flattened pyramids to form a non-Euclidean plane.</span></span>

 <span data-ttu-id="53be7-258">下图显示了此三步分解过程的示意图。</span><span class="sxs-lookup"><span data-stu-id="53be7-258">The following illustration shows a schematic view of the three-step decomposition process.</span></span> <span data-ttu-id="53be7-259">在棱锥图中，虚线表示每个棱锥图的四个面的边界。</span><span class="sxs-lookup"><span data-stu-id="53be7-259">In the pyramids, the dotted lines represent the boundaries of the four facets of each pyramid.</span></span> <span data-ttu-id="53be7-260">步骤 1 和 2 显示测量椭圆体，使用一条绿色水平线表示赤道经线，使用一系列绿色垂直线表示若干条纬线。</span><span class="sxs-lookup"><span data-stu-id="53be7-260">Steps 1 and 2 illustrate the geodetic ellipsoid, using a green horizontal line to represent the equatorial longitude line and a series of green vertical lines to represent several latitude lines.</span></span> <span data-ttu-id="53be7-261">步骤 1 显示要投影在两个半球上的棱锥图。</span><span class="sxs-lookup"><span data-stu-id="53be7-261">Step 1 shows the pyramids being projected over the two hemispheres.</span></span> <span data-ttu-id="53be7-262">步骤 2 显示要平展的棱锥图。</span><span class="sxs-lookup"><span data-stu-id="53be7-262">Step 2 shows the pyramids being flattened.</span></span> <span data-ttu-id="53be7-263">步骤 3 显示平展的棱锥图，这些棱锥图已组合起来形成一个平面，显示出许多投影的经线。</span><span class="sxs-lookup"><span data-stu-id="53be7-263">Step 3 illustrates the flattened pyramids, after they have been combined to form a plane, showing a number of projected longitude lines.</span></span> <span data-ttu-id="53be7-264">请注意，这些投影线伸直后长度不一，具体取决于它们落在棱锥图上的位置。</span><span class="sxs-lookup"><span data-stu-id="53be7-264">Notice that these projected lines are straightened and vary in length, depending on where they fall on the pyramids.</span></span>

 <span data-ttu-id="53be7-265">![椭圆体在平面上的投影](../../database-engine/media/spndx-geodetic-projection.gif "椭圆体在平面上的投影")</span><span class="sxs-lookup"><span data-stu-id="53be7-265">![Projection of the ellipsoid onto a plane](../../database-engine/media/spndx-geodetic-projection.gif "Projection of the ellipsoid onto a plane")</span></span>

 <span data-ttu-id="53be7-266">空间投影到平面上之后，此平面将会分解成四级网格层次结构。</span><span class="sxs-lookup"><span data-stu-id="53be7-266">Once the space has been projected onto the plane, the plane is decomposed into the four-level grid hierarchy.</span></span> <span data-ttu-id="53be7-267">不同级别可以使用不同的网格密度。</span><span class="sxs-lookup"><span data-stu-id="53be7-267">Different levels can use different grid densities.</span></span> <span data-ttu-id="53be7-268">下图显示了已分解成一个 4x4 的 1 级网格后的平面。</span><span class="sxs-lookup"><span data-stu-id="53be7-268">The following illustration shows the plane after it has been decomposed into a 4x4 level-1 grid.</span></span> <span data-ttu-id="53be7-269">出于演示目的，这里省略了网格层次结构的较低级别。</span><span class="sxs-lookup"><span data-stu-id="53be7-269">For the purposes of illustration, the lower-levels of the grid hierarchy are omitted.</span></span> <span data-ttu-id="53be7-270">事实上，此平面完全分解成了一个四级网格层次结构。</span><span class="sxs-lookup"><span data-stu-id="53be7-270">In actuality, the plane is fully decomposed into a four-level grid hierarchy.</span></span> <span data-ttu-id="53be7-271">分解过程完成后，将逐行从 geography 列读取地理数据，并为每个对象依次执行分割过程。</span><span class="sxs-lookup"><span data-stu-id="53be7-271">After the decomposition process finishes, the geographic data is read, row by row, from the geography column, and the tessellation process is performed for each object in turn.</span></span>

 <span data-ttu-id="53be7-272">![第 1 级地理网格](../../database-engine/media/spndx-geodetic-level1grid.gif "第 1 级地理网格")</span><span class="sxs-lookup"><span data-stu-id="53be7-272">![Level-1 geography grid](../../database-engine/media/spndx-geodetic-level1grid.gif "Level-1 geography grid")</span></span>

##  <a name="methods-supported-by-spatial-indexes"></a><a name="methods"></a> <span data-ttu-id="53be7-273">空间索引支持的方法</span><span class="sxs-lookup"><span data-stu-id="53be7-273">Methods Supported by Spatial Indexes</span></span>

###  <a name="geometry-methods-supported-by-spatial-indexes"></a><a name="geometry"></a><span data-ttu-id="53be7-274">空间索引支持的几何图形方法</span><span class="sxs-lookup"><span data-stu-id="53be7-274">Geometry Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="53be7-275">空间索引在某些情况下支持以下面向集合的 geometry 方法：STContains()、STDistance()、STEquals()、STIntersects()、STOverlaps()、STTouches() 和 STWithin()。</span><span class="sxs-lookup"><span data-stu-id="53be7-275">Spatial indexes support the following set-oriented geometry methods under certain conditions: STContains(), STDistance(), STEquals(), STIntersects(), STOverlaps(), STTouches(), and STWithin().</span></span> <span data-ttu-id="53be7-276">若要使空间索引支持这些方法，必须在查询的 WHERE 或 JOIN ON 子句中使用这些方法，并且必须在采用如下常规形式的谓词中执行这些方法：</span><span class="sxs-lookup"><span data-stu-id="53be7-276">To be supported by a spatial index, these methods must be used within the WHERE or JOIN ON clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="53be7-277">*geometry1*。*method_name* (*geometry2*) *comparison_operator \* \* valid_number*</span><span class="sxs-lookup"><span data-stu-id="53be7-277">*geometry1*.*method_name*(*geometry2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="53be7-278">若要返回非 NULL 结果， *geometry1* 和 *geometry2* 必须具有相同的 [空间引用标识符 (SRID)](../spatial/spatial-reference-identifiers-srids.md)。</span><span class="sxs-lookup"><span data-stu-id="53be7-278">To return a non-null result, *geometry1* and *geometry2* must have the same [spatial reference identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="53be7-279">否则，该方法将返回 NULL。</span><span class="sxs-lookup"><span data-stu-id="53be7-279">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="53be7-280">空间索引支持以下谓词形式：</span><span class="sxs-lookup"><span data-stu-id="53be7-280">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="53be7-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="53be7-281">*geometry1*.[STContains](/sql/t-sql/spatial-geometry/stcontains-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="53be7-282">*geometry1*。[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type) (*geometry2*) <*号*</span><span class="sxs-lookup"><span data-stu-id="53be7-282">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) < *number*</span></span>

-   <span data-ttu-id="53be7-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *number*</span><span class="sxs-lookup"><span data-stu-id="53be7-283">*geometry1*.[STDistance](/sql/t-sql/spatial-geometry/stdistance-geometry-data-type)(*geometry2*) <= *number*</span></span>

-   <span data-ttu-id="53be7-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="53be7-284">*geometry1*.[STEquals](/sql/t-sql/spatial-geometry/stequals-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="53be7-285">*geometry1*）的数据的表列。[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span><span class="sxs-lookup"><span data-stu-id="53be7-285">*geometry1*.[STIntersects](/sql/t-sql/spatial-geometry/stintersects-geometry-data-type)(*geometry2*)= 1</span></span>

-   <span data-ttu-id="53be7-286">*geometry1.*</span><span class="sxs-lookup"><span data-stu-id="53be7-286">*geometry1.*</span></span> <span data-ttu-id="53be7-287">[STOverlaps (geometry2) = 1](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) \*\*</span><span class="sxs-lookup"><span data-stu-id="53be7-287">[STOverlaps](/sql/t-sql/spatial-geometry/stoverlaps-geometry-data-type) *(geometry2) = 1*</span></span>

-   <span data-ttu-id="53be7-288">*geometry1*[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="53be7-288">*geometry1*.[STTouches](/sql/t-sql/spatial-geometry/sttouches-geometry-data-type)(*geometry2*) = 1</span></span>

-   <span data-ttu-id="53be7-289">*geometry1*[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*) = 1</span><span class="sxs-lookup"><span data-stu-id="53be7-289">*geometry1*.[STWithin](/sql/t-sql/spatial-geometry/stwithin-geometry-data-type)(*geometry2*)= 1</span></span>

###  <a name="geography-methods-supported-by-spatial-indexes"></a><a name="geography"></a><span data-ttu-id="53be7-290">空间索引支持的地域方法</span><span class="sxs-lookup"><span data-stu-id="53be7-290">Geography Methods Supported by Spatial Indexes</span></span>
 <span data-ttu-id="53be7-291">在某些条件下，空间索引支持以下面向集合的地理方法：STIntersects()、STEquals() 和 STDistance()。</span><span class="sxs-lookup"><span data-stu-id="53be7-291">Under certain conditions, spatial indexes support the following set-oriented geography methods: STIntersects(),STEquals(), and STDistance().</span></span> <span data-ttu-id="53be7-292">若要使空间索引支持这些方法，必须在查询的 WHERE 子句中使用这些方法，并且必须在采用如下常规形式的谓词中执行这些方法。</span><span class="sxs-lookup"><span data-stu-id="53be7-292">To be supported by a spatial index, these methods must be used within the WHERE clause of a query, and they must occur within a predicate of the following general form:</span></span>

 <span data-ttu-id="53be7-293">*geography1*.*method_name*(*geography2*)*comparison_operator\*\*valid_number*</span><span class="sxs-lookup"><span data-stu-id="53be7-293">*geography1*.*method_name*(*geography2*)*comparison_operator\*\*valid_number*</span></span>

 <span data-ttu-id="53be7-294">若要返回非 NULL 结果， *geography1* 和 *geography2* 必须具有相同的 [空间引用标识符 (SRID)](../spatial/spatial-reference-identifiers-srids.md)。</span><span class="sxs-lookup"><span data-stu-id="53be7-294">To return a non-null result, *geography1* and *geography2* must have the same [Spatial Reference Identifier (SRID)](../spatial/spatial-reference-identifiers-srids.md).</span></span> <span data-ttu-id="53be7-295">否则，该方法将返回 NULL。</span><span class="sxs-lookup"><span data-stu-id="53be7-295">Otherwise, the method returns NULL.</span></span>

 <span data-ttu-id="53be7-296">空间索引支持以下谓词形式：</span><span class="sxs-lookup"><span data-stu-id="53be7-296">Spatial indexes support the following predicate forms:</span></span>

-   <span data-ttu-id="53be7-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*) = 1</span><span class="sxs-lookup"><span data-stu-id="53be7-297">*geography1*.[STIntersects](/sql/t-sql/spatial-geography/stintersects-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="53be7-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*) = 1</span><span class="sxs-lookup"><span data-stu-id="53be7-298">*geography1*.[STEquals](/sql/t-sql/spatial-geography/stequals-geography-data-type)(*geography2*)= 1</span></span>

-   <span data-ttu-id="53be7-299">*geography1*。[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type) (*geography2*) <*号*</span><span class="sxs-lookup"><span data-stu-id="53be7-299">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) < *number*</span></span>

-   <span data-ttu-id="53be7-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *number*</span><span class="sxs-lookup"><span data-stu-id="53be7-300">*geography1*.[STDistance](/sql/t-sql/spatial-geography/stdistance-geography-data-type)(*geography2*) <= *number*</span></span>

### <a name="queries-that-use-spatial-indexes"></a><span data-ttu-id="53be7-301">使用空间索引的查询</span><span class="sxs-lookup"><span data-stu-id="53be7-301">Queries that use Spatial Indexes</span></span>
 <span data-ttu-id="53be7-302">仅 `WHERE` 子句中包含索引空间运算符的查询支持空间索引。</span><span class="sxs-lookup"><span data-stu-id="53be7-302">Spatial indexes are only supported in queries that include an indexed spatial operator in the `WHERE` clause.</span></span> <span data-ttu-id="53be7-303">示例语法如下：</span><span class="sxs-lookup"><span data-stu-id="53be7-303">For example syntax such as:</span></span>

```
[spatial object].SpatialMethod([reference spatial object]) [ = | < ] [const literal or variable]
```

 <span data-ttu-id="53be7-304">查询优化器可理解空间操作的交换性（即 `@a.STIntersects(@b) = @b.STInterestcs(@a)` ）。</span><span class="sxs-lookup"><span data-stu-id="53be7-304">The query optimizer understands the commutativity of spatial operations (that `@a.STIntersects(@b) = @b.STInterestcs(@a)` ).</span></span> <span data-ttu-id="53be7-305">但是，如果比较的开头不包含空间运算符，将不会使用空间索引（例如， `WHERE 1 = spatial op` 将不会使用空间索引）。</span><span class="sxs-lookup"><span data-stu-id="53be7-305">However, the spatial index will not be used if the beginning of a comparison does not contain the spatial operator (for example `WHERE 1 = spatial op` will not use the spatial index).</span></span> <span data-ttu-id="53be7-306">要使用空间索引，请重写比较（例如 `WHERE spatial op = 1`）。</span><span class="sxs-lookup"><span data-stu-id="53be7-306">To use the spatial index, rewrite the comparison (for example `WHERE spatial op = 1`).</span></span>

 <span data-ttu-id="53be7-307">与任何其他索引一样，在支持使用空间索引时，系统将根据开销选择是否使用空间索引，因此，即使使用空间索引的所有要求都得到满足，查询优化器也可能不选用空间索引。</span><span class="sxs-lookup"><span data-stu-id="53be7-307">As with any other index, when a spatial index is supported, the use of the spatial index is chosen based on cost, so the query optimizer might not choose to use the spatial index even though all requirements for using it are met.</span></span> <span data-ttu-id="53be7-308">可使用显示计划查看是否使用了空间索引，在必要时，可提供查询提示以强制使用所需的查询计划。</span><span class="sxs-lookup"><span data-stu-id="53be7-308">Use showplan to see if the spatial index was used and if necessary provide query hints to force a desired query plan.</span></span>

 <span data-ttu-id="53be7-309">邻近点查询类型也支持空间索引，但必须要编写特定的查询语法。</span><span class="sxs-lookup"><span data-stu-id="53be7-309">The nearest neighbor type of query also supports spatial indexes however only if a specific query syntax is written.</span></span> <span data-ttu-id="53be7-310">正确的语法为：</span><span class="sxs-lookup"><span data-stu-id="53be7-310">The appropriate syntax is:</span></span>

```
SELECT TOP(K) [WITH TIES] * 
FROM <Table> AS T [WITH(INDEX(<SpatialIndex>))]
WHERE <SpatialColumn>.STDistance(@reference_object) IS NOT NULL
ORDER BY <SpatialColumn>.STDistance(@reference_object) [;]
```

## <a name="see-also"></a><span data-ttu-id="53be7-311">另请参阅</span><span class="sxs-lookup"><span data-stu-id="53be7-311">See Also</span></span>
 [<span data-ttu-id="53be7-312">空间数据 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="53be7-312">Spatial Data &#40;SQL Server&#41;</span></span>](../spatial/spatial-data-sql-server.md)



---
title: 使用数据库镜像 | Microsoft Docs
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- SQL Server Native Client, database mirroring
- data access [SQL Server Native Client], database mirroring
- database mirroring [SQL Server], connecting clients to
- SQLNCLI, database mirroring
- SQL Server Native Client ODBC driver, database mirroring
- SQL Server Native Client OLE DB provider, database mirroring
ms.assetid: 71b15712-7972-4465-9274-e0ddc271eedc
author: rothja
ms.author: jroth
ms.openlocfilehash: 389036322137abcc9a40e36c697e8d45e39a7de5
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578850"
---
# <a name="using-database-mirroring"></a><span data-ttu-id="51e14-102">使用数据库镜像</span><span class="sxs-lookup"><span data-stu-id="51e14-102">Using Database Mirroring</span></span>
    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../../includes/ssnotedepfutureavoid-md.md)] <span data-ttu-id="51e14-103">改为使用 [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="51e14-103">Use [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] instead.</span></span>  
  
 <span data-ttu-id="51e14-104">在 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 中引入的数据库镜像是一种提高数据库可用性和改善数据冗余性的解决方案。</span><span class="sxs-lookup"><span data-stu-id="51e14-104">Database mirroring, introduced in [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], is a solution for increasing database availability and data redundancy.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="51e14-105">Native Client 为数据库镜像提供隐式支持，因此，在为数据库配置后，开发人员无需编写任何代码或采取任何其他措施。</span><span class="sxs-lookup"><span data-stu-id="51e14-105">Native Client provides implicit support for database mirroring, so the developer does not need to write any code or take any other action once it has been configured for the database.</span></span>  
  
 <span data-ttu-id="51e14-106">数据库镜像是按数据库实现的，它在备用服务器上保留一份 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 产品数据库的副本。</span><span class="sxs-lookup"><span data-stu-id="51e14-106">Database mirroring, which is implemented on a per-database basis, keeps a copy of a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] production database on a standby server.</span></span> <span data-ttu-id="51e14-107">该服务器根据数据库镜像会话的配置和状态，充当热备用或温备用服务器。</span><span class="sxs-lookup"><span data-stu-id="51e14-107">This server is either a hot or warm standby server, depending on the configuration and state of the database mirroring session.</span></span> <span data-ttu-id="51e14-108">热备用服务器支持快速故障转移且不会丢失已提交事务，温备用服务器支持强制服务（可能丢失数据）。</span><span class="sxs-lookup"><span data-stu-id="51e14-108">A hot standby server supports rapid failover with no loss of committed transactions, and a warm standby server supports forcing service (with possible data loss).</span></span>  
  
 <span data-ttu-id="51e14-109">生产数据库称为 "*主体数据库*"，备用副本称为 "*镜像数据库*"。</span><span class="sxs-lookup"><span data-stu-id="51e14-109">The production database is called the *principal database*, and the standby copy is called the *mirror database*.</span></span> <span data-ttu-id="51e14-110">主体数据库和镜像数据库必须位于单独的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例（服务器实例）中，并且应位于单独的计算机中（如果可能）。</span><span class="sxs-lookup"><span data-stu-id="51e14-110">The principal database and mirror database must reside on separate instances of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (server instances), and they should reside on separate computers if possible.</span></span>  
  
 <span data-ttu-id="51e14-111">生产服务器实例称为“主体服务器”，而备用服务器实例称为“镜像服务器”，两个实例相互通信\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="51e14-111">The production server instance, called the *principal server*, communicates with the standby server instance, called the *mirror server*.</span></span> <span data-ttu-id="51e14-112">主体服务器和镜像服务器充当数据库镜像*会话*中的伙伴。</span><span class="sxs-lookup"><span data-stu-id="51e14-112">The principal and mirror servers act as partners within a database mirroring *session*.</span></span> <span data-ttu-id="51e14-113">如果主体服务器失败，镜像服务器可以通过称为“故障转移”的过程将其数据库转为主体数据库\*\*。</span><span class="sxs-lookup"><span data-stu-id="51e14-113">If the principal server fails, the mirror server can make its database into the principal database through a process called *failover*.</span></span> <span data-ttu-id="51e14-114">例如，Partner_A 和 Partner_B 为两个伙伴服务器，主数据库最初位于主服务器 Partner_A 上，镜像数据库位于镜像服务器 Partner_B 上。</span><span class="sxs-lookup"><span data-stu-id="51e14-114">For example, Partner_A and Partner_B are two partner servers, with the principal database initially on Partner_A as principal server, and the mirror database residing on Partner_B as the mirror server.</span></span> <span data-ttu-id="51e14-115">如果 Partner_A 脱机，则 Partner_B 上的数据库便可通过故障转移而成为当前主数据库。</span><span class="sxs-lookup"><span data-stu-id="51e14-115">If Partner_A goes offline, the database on Partner_B can fail over to become the current principal database.</span></span> <span data-ttu-id="51e14-116">Partner_A 重新加入镜像会话后，它将成为镜像服务器，而其数据库将成为镜像数据库。</span><span class="sxs-lookup"><span data-stu-id="51e14-116">When Partner_A rejoins the mirroring session, it becomes the mirror server and its database becomes the mirror database.</span></span>  
  
 <span data-ttu-id="51e14-117">备用数据库镜像配置提供不同级别的性能和数据安全，并支持不同形式的故障转移。</span><span class="sxs-lookup"><span data-stu-id="51e14-117">Alternative database mirroring configurations offer different levels of performance and data safety, and support different forms of failover.</span></span> <span data-ttu-id="51e14-118">有关详细信息，请参阅[数据库镜像 (SQL Server)](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="51e14-118">For more information, see [Database Mirroring &#40;SQL Server&#41;](../../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span></span>  
  
 <span data-ttu-id="51e14-119">指定镜像数据库名称时可以使用别名。</span><span class="sxs-lookup"><span data-stu-id="51e14-119">It is possible to use an alias when specifying the mirror database name.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="51e14-120">有关与镜像数据库之间的初始连接尝试和重新连接尝试的信息，请参阅[将客户端连接到数据库镜像会话 (SQL Server)](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="51e14-120">For information about initial connection attempts and reconnection attempts to a mirrored database, see [Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md).</span></span>  
  
## <a name="programming-considerations"></a><span data-ttu-id="51e14-121">编程注意事项</span><span class="sxs-lookup"><span data-stu-id="51e14-121">Programming Considerations</span></span>  
 <span data-ttu-id="51e14-122">当主体数据库服务器失败时，客户端应用程序则接收错误以响应 API 调用，这指示与数据库之间的连接已丢失。</span><span class="sxs-lookup"><span data-stu-id="51e14-122">When the principal database server fails, the client application receives errors in response to API calls, which indicate that the connection to the database has been lost.</span></span> <span data-ttu-id="51e14-123">发生此种情况时，对数据库执行的任何未提交的更改将丢失，并回滚当前事务。</span><span class="sxs-lookup"><span data-stu-id="51e14-123">When this happens, any uncommitted changes to the database are lost and the current transaction is rolled back.</span></span> <span data-ttu-id="51e14-124">如果发生这种情况，应用程序应关闭连接（或释放数据源对象），然后再重新打开它。</span><span class="sxs-lookup"><span data-stu-id="51e14-124">If this occurs, the application should close the connection (or release the data source object) and re-open it.</span></span> <span data-ttu-id="51e14-125">连接将以透明方式重新定向到镜像数据库，该数据库现在充当主体服务器。</span><span class="sxs-lookup"><span data-stu-id="51e14-125">The connection is transparently re-directed to the mirror database, which now acts as the principal server.</span></span>  
  
 <span data-ttu-id="51e14-126">建立连接时，主体服务器将其故障转移伙伴的标识发送到客户端，以便在发生故障转移时使用。</span><span class="sxs-lookup"><span data-stu-id="51e14-126">When a connection is established, the principal server sends the identity of its failover partner to the client to be used when failover occurs.</span></span> <span data-ttu-id="51e14-127">当应用程序在主体服务器失败后尝试建立连接时，客户端不知道故障转移伙伴的标识。</span><span class="sxs-lookup"><span data-stu-id="51e14-127">Where an application tried to establish a connection after the principal server failed, the client does not know the identity of the failover partner.</span></span> <span data-ttu-id="51e14-128">为使客户端能够处理这种情况，初始化属性和关联的连接字符串关键字允许客户端自己指定故障转移伙伴的标识。</span><span class="sxs-lookup"><span data-stu-id="51e14-128">To allow clients the opportunity to cope with this scenario, an initialization property and an associated connection string keyword allow the client to specify the identity of the failover partner on its own.</span></span> <span data-ttu-id="51e14-129">客户端属性仅在此种情况下使用；如果主体服务器可用，则不使用此属性。</span><span class="sxs-lookup"><span data-stu-id="51e14-129">The client attribute is used only in this scenario; if the principal server is available, it is not used.</span></span> <span data-ttu-id="51e14-130">如果客户端提供的故障转移伙伴服务器未引用充当故障转移伙伴的服务器，该服务器将拒绝连接。</span><span class="sxs-lookup"><span data-stu-id="51e14-130">If the failover partner server supplied by the client does not refer to a server acting as a failover partner, the connection is refused by the server.</span></span> <span data-ttu-id="51e14-131">若要使应用程序适应配置更改，可以通过在建立连接后检测该属性来确定实际故障转移伙伴的标识。</span><span class="sxs-lookup"><span data-stu-id="51e14-131">To allow applications to adapt to configuration changes, the identity of the actual failover partner can be determined by inspecting the attribute after the connection has been established.</span></span> <span data-ttu-id="51e14-132">如果首次尝试建立连接失败，则应考虑缓存伙伴信息，以更新连接字符串或设计重试策略。</span><span class="sxs-lookup"><span data-stu-id="51e14-132">You should consider caching the partner information to update the connection string or devise a retry strategy in the event that the first attempt at making a connection fails.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="51e14-133">如果希望在 DSN、连接字符串或连接属性/特性中使用此功能，必须显式指定连接要使用的数据库。</span><span class="sxs-lookup"><span data-stu-id="51e14-133">You must explicitly specify the database to be used by a connection if you want to use this feature in a DSN, connection string, or connection property/attribute.</span></span> <span data-ttu-id="51e14-134">否则，[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client 将不会尝试故障转移到伙伴数据库。</span><span class="sxs-lookup"><span data-stu-id="51e14-134">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client will not attempt to failover to the partner database if this is not done.</span></span>  
>   
>  <span data-ttu-id="51e14-135">镜像是面向数据库的功能。</span><span class="sxs-lookup"><span data-stu-id="51e14-135">Mirroring is a feature of the database.</span></span> <span data-ttu-id="51e14-136">使用多个数据库的应用程序可能无法利用此功能。</span><span class="sxs-lookup"><span data-stu-id="51e14-136">Applications that use multiple databases might not be able to exploit this feature.</span></span>  
>   
>  <span data-ttu-id="51e14-137">此外，服务器名称不区分大小写，而数据库名称区分大小写。</span><span class="sxs-lookup"><span data-stu-id="51e14-137">In addition, server names are case insensitive, but database names are case sensitive.</span></span> <span data-ttu-id="51e14-138">因此，应确保在 DSN 和连接字符串中使用相同的大小写。</span><span class="sxs-lookup"><span data-stu-id="51e14-138">You should therefore make sure that you use the same casing in DSNs and connection strings.</span></span>  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="51e14-139">SQL Server Native Client OLE DB 访问接口</span><span class="sxs-lookup"><span data-stu-id="51e14-139">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="51e14-140">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供程序通过连接和连接字符串属性支持数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="51e14-140">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="51e14-141">已向 DBPROPSET_SQLSERVERDBINIT 属性集添加 SSPROP_INIT_FAILOVERPARTNER 属性，`FailoverPartner` 关键字是 DBPROP_INIT_PROVIDERSTRING 的新连接字符串属性。</span><span class="sxs-lookup"><span data-stu-id="51e14-141">The SSPROP_INIT_FAILOVERPARTNER property has been added to the DBPROPSET_SQLSERVERDBINIT property set, and the `FailoverPartner` keyword is a new connection string attribute for DBPROP_INIT_PROVIDERSTRING.</span></span> <span data-ttu-id="51e14-142">有关详细信息，请参阅将[连接字符串关键字用于 SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md)。</span><span class="sxs-lookup"><span data-stu-id="51e14-142">For more information, see [Using Connection String Keywords with SQL Server Native Client](../applications/using-connection-string-keywords-with-sql-server-native-client.md).</span></span>  
  
 <span data-ttu-id="51e14-143">只要加载了提供程序，就会保留故障转移缓存，无论是在调用**CoUninitialize**之前还是在应用程序引用由 Native OLE DB Client 管理的某个对象 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] （例如数据源对象）时，都是如此。</span><span class="sxs-lookup"><span data-stu-id="51e14-143">The failover cache is maintained as long as the provider is loaded, which is until **CoUninitialize** is called or as long as the application has a reference to some object managed by the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider such as a data source object.</span></span>  
  
 <span data-ttu-id="51e14-144">有关 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB 提供程序对数据库镜像的支持的详细信息，请参阅[初始化和授权属性](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="51e14-144">For details about [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider support for database mirroring, see [Initialization and Authorization Properties](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="51e14-145">SQL Server Native Client ODBC 驱动程序</span><span class="sxs-lookup"><span data-stu-id="51e14-145">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="51e14-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驱动程序通过连接和连接字符串属性支持数据库镜像。</span><span class="sxs-lookup"><span data-stu-id="51e14-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports database mirroring through connection and connection string attributes.</span></span> <span data-ttu-id="51e14-147">具体而言，添加了 SQL_COPT_SS_FAILOVER_PARTNER 特性以便与[SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md)和[SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md)函数一起使用;`Failover_Partner`关键字已添加为新的连接字符串属性。</span><span class="sxs-lookup"><span data-stu-id="51e14-147">Specifically, the SQL_COPT_SS_FAILOVER_PARTNER attribute has been added for use with the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) and [SQLGetConnectAttr](../../native-client-odbc-api/sqlgetconnectattr.md) functions; and the `Failover_Partner` keyword has been added as a new connection string attribute.</span></span>  
  
 <span data-ttu-id="51e14-148">只要应用程序至少分配有一个环境句柄，故障转移缓存就会一直保留。</span><span class="sxs-lookup"><span data-stu-id="51e14-148">The failover cache is maintained as long as the application has at least one environment handle allocated.</span></span> <span data-ttu-id="51e14-149">相反，当释放最后一个环境句柄时，将丢失故障转移缓存。</span><span class="sxs-lookup"><span data-stu-id="51e14-149">Conversely, it is lost when the last environment handle is deallocated.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="51e14-150">ODBC 驱动程序管理器已得以改进，能够支持指定故障转移服务器名称。</span><span class="sxs-lookup"><span data-stu-id="51e14-150">The ODBC Driver Manager has been enhanced to support the specification of the failover server name.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="51e14-151">另请参阅</span><span class="sxs-lookup"><span data-stu-id="51e14-151">See Also</span></span>  
 <span data-ttu-id="51e14-152">[SQL Server Native Client 功能](sql-server-native-client-features.md) </span><span class="sxs-lookup"><span data-stu-id="51e14-152">[SQL Server Native Client Features](sql-server-native-client-features.md) </span></span>  
 <span data-ttu-id="51e14-153">[将客户端连接到数据库镜像会话 (SQL Server)](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="51e14-153">[Connect Clients to a Database Mirroring Session &#40;SQL Server&#41;](../../../database-engine/database-mirroring/connect-clients-to-a-database-mirroring-session-sql-server.md) </span></span>  
 [<span data-ttu-id="51e14-154">数据库镜像 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="51e14-154">Database Mirroring &#40;SQL Server&#41;</span></span>](../../../database-engine/database-mirroring/database-mirroring-sql-server.md)  
  
  

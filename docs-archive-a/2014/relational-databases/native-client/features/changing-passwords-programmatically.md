---
title: 以编程方式更改密码 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- data access [SQL Server Native Client], password expiration
- SQL Server Native Client ODBC driver, passwords
- SQL Server Native Client OLE DB provider, passwords
- passwords [SQL Server], expiration
- SQLNCLI, password expiration
- expiration [SQL Server Native Client]
- passwords [SQL Server], modifying
- expired passwords [SQL Server Native Client]
- SQL Server Native Client, password expiration
- modifying passwords
ms.assetid: 624ad949-5fed-4ce5-b319-878549f9487b
author: rothja
ms.author: jroth
ms.openlocfilehash: 86085f8ba7c54cfcab1a3c7f6e8ade30ecf9d0da
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87688879"
---
# <a name="changing-passwords-programmatically"></a><span data-ttu-id="acc6a-102">以编程方式更改密码</span><span class="sxs-lookup"><span data-stu-id="acc6a-102">Changing Passwords Programmatically</span></span>
  <span data-ttu-id="acc6a-103">在 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] 之前，如果用户的密码过期，则只有管理员能对其进行重置。</span><span class="sxs-lookup"><span data-stu-id="acc6a-103">Before [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], when a user's password expired, only an administrator could reset it.</span></span> <span data-ttu-id="acc6a-104">从开始 [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] ， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] native client 支持通过 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] native client OLE DB 访问接口和 native client ODBC 驱动程序以编程方式处理密码过期 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] ，并通过对**SQL Server 登录**对话框进行更改。</span><span class="sxs-lookup"><span data-stu-id="acc6a-104">Beginning with [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client supports handling password expiration programmatically through both the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider and the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver, and through changes to the **SQL Server Login** dialog boxes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="acc6a-105">如果可能，请在运行时提示用户输入他们的凭据，并避免用持久化格式存储他们的凭据。</span><span class="sxs-lookup"><span data-stu-id="acc6a-105">When possible, prompt users to enter their credentials at run time and avoid storing their credentials in a persisted format.</span></span> <span data-ttu-id="acc6a-106">如果必须保留其凭据，应使用 [Win32 加密 API](https://go.microsoft.com/fwlink/?LinkId=64532) 来加密这些凭据。</span><span class="sxs-lookup"><span data-stu-id="acc6a-106">If you must persist their credentials, you should encrypt them using the [Win32 crypto API](https://go.microsoft.com/fwlink/?LinkId=64532).</span></span> <span data-ttu-id="acc6a-107">有关密码使用的详细信息，请参阅[强密码](../../security/strong-passwords.md)。</span><span class="sxs-lookup"><span data-stu-id="acc6a-107">For more information about the use of passwords, see [Strong Passwords](../../security/strong-passwords.md).</span></span>  
  
## <a name="sql-server-login-error-codes"></a><span data-ttu-id="acc6a-108">SQL Server 登录错误代码</span><span class="sxs-lookup"><span data-stu-id="acc6a-108">SQL Server Login Error Codes</span></span>  
 <span data-ttu-id="acc6a-109">当由于身份验证问题而导致无法连接时，以下 SQL Server 错误代码之一可供应用程序使用，以帮助诊断和恢复。</span><span class="sxs-lookup"><span data-stu-id="acc6a-109">When a connection cannot be made because of authentication problems, one of the following SQL Server error codes will be available to the application to assist diagnosis and recovery.</span></span>  
  
|<span data-ttu-id="acc6a-110">SQL Server 错误代码</span><span class="sxs-lookup"><span data-stu-id="acc6a-110">SQL Server Error Code</span></span>|<span data-ttu-id="acc6a-111">错误消息</span><span class="sxs-lookup"><span data-stu-id="acc6a-111">Error Message</span></span>|  
|---------------------------|-------------------|  
|<span data-ttu-id="acc6a-112">15113</span><span class="sxs-lookup"><span data-stu-id="acc6a-112">15113</span></span>|<span data-ttu-id="acc6a-113">用户 '%.\*ls' 登录失败。原因: 密码验证失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-113">Login failed for user '%.\*ls' Reason: Password validation failed.</span></span> <span data-ttu-id="acc6a-114">帐户已锁定。</span><span class="sxs-lookup"><span data-stu-id="acc6a-114">The account is locked out.</span></span>|  
|<span data-ttu-id="acc6a-115">18463</span><span class="sxs-lookup"><span data-stu-id="acc6a-115">18463</span></span>|<span data-ttu-id="acc6a-116">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-116">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-117">原因: 密码更改失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-117">Reason: Password change failed.</span></span> <span data-ttu-id="acc6a-118">此时无法使用密码。</span><span class="sxs-lookup"><span data-stu-id="acc6a-118">The password cannot be used at this time.</span></span>|  
|<span data-ttu-id="acc6a-119">18464</span><span class="sxs-lookup"><span data-stu-id="acc6a-119">18464</span></span>|<span data-ttu-id="acc6a-120">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-120">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-121">原因: 密码更改失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-121">Reason: Password change failed.</span></span> <span data-ttu-id="acc6a-122">该密码太短，不符合策略要求。</span><span class="sxs-lookup"><span data-stu-id="acc6a-122">The password does not meet policy requirements because it is too short.</span></span>|  
|<span data-ttu-id="acc6a-123">18465</span><span class="sxs-lookup"><span data-stu-id="acc6a-123">18465</span></span>|<span data-ttu-id="acc6a-124">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-124">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-125">原因: 密码更改失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-125">Reason: Password change failed.</span></span> <span data-ttu-id="acc6a-126">密码太长，不符合策略要求。</span><span class="sxs-lookup"><span data-stu-id="acc6a-126">The password does not meet policy requirements because it is too long.</span></span>|  
|<span data-ttu-id="acc6a-127">18466</span><span class="sxs-lookup"><span data-stu-id="acc6a-127">18466</span></span>|<span data-ttu-id="acc6a-128">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-128">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-129">原因: 密码更改失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-129">Reason: Password change failed.</span></span> <span data-ttu-id="acc6a-130">该密码不够复杂，不符合策略要求。</span><span class="sxs-lookup"><span data-stu-id="acc6a-130">The password does not meet policy requirements because it is not complex enough.</span></span>|  
|<span data-ttu-id="acc6a-131">18467</span><span class="sxs-lookup"><span data-stu-id="acc6a-131">18467</span></span>|<span data-ttu-id="acc6a-132">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-132">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-133">原因: 密码更改失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-133">Reason: Password change failed.</span></span> <span data-ttu-id="acc6a-134">该密码不符合密码筛选器 DLL 的要求。</span><span class="sxs-lookup"><span data-stu-id="acc6a-134">The password does not meet the requirements of the password filter DLL.</span></span>|  
|<span data-ttu-id="acc6a-135">18468</span><span class="sxs-lookup"><span data-stu-id="acc6a-135">18468</span></span>|<span data-ttu-id="acc6a-136">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-136">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-137">原因: 密码更改失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-137">Reason: Password change failed.</span></span> <span data-ttu-id="acc6a-138">在密码验证过程中出错。</span><span class="sxs-lookup"><span data-stu-id="acc6a-138">An unexpected error occurred during password validation.</span></span>|  
|<span data-ttu-id="acc6a-139">18487</span><span class="sxs-lookup"><span data-stu-id="acc6a-139">18487</span></span>|<span data-ttu-id="acc6a-140">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-140">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-141">原因: 该帐户的密码已过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-141">Reason: The password of the account has expired.</span></span>|  
|<span data-ttu-id="acc6a-142">18488</span><span class="sxs-lookup"><span data-stu-id="acc6a-142">18488</span></span>|<span data-ttu-id="acc6a-143">用户 "%.\*ls" 登录失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-143">Login failed for user '%.\*ls'.</span></span> <span data-ttu-id="acc6a-144">原因: 该帐户的密码必须更改。</span><span class="sxs-lookup"><span data-stu-id="acc6a-144">Reason: The password of the account must be changed.</span></span>|  
  
## <a name="sql-server-native-client-ole-db-provider"></a><span data-ttu-id="acc6a-145">SQL Server Native Client OLE DB 访问接口</span><span class="sxs-lookup"><span data-stu-id="acc6a-145">SQL Server Native Client OLE DB Provider</span></span>  
 <span data-ttu-id="acc6a-146">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供程序通过用户界面和以编程方式支持密码过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-146">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration though a user interface and programmatically.</span></span>  
  
### <a name="ole-db-user-interface-password-expiration"></a><span data-ttu-id="acc6a-147">OLE DB 用户界面密码过期</span><span class="sxs-lookup"><span data-stu-id="acc6a-147">OLE DB User Interface Password Expiration</span></span>  
 <span data-ttu-id="acc6a-148">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供程序通过对**SQL Server 登录**对话框进行更改来支持密码过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-148">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration through changes made to the **SQL Server Login** dialog boxes.</span></span> <span data-ttu-id="acc6a-149">如果将 DBPROP_INIT_PROMPT 的值设置为 DBPROMPT_NOPROMPT，则在密码已过期的情况下初始连接尝试将失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-149">If the value of DBPROP_INIT_PROMPT is set to DBPROMPT_NOPROMPT, the initial connection attempt will fail if the password has expired.</span></span>  
  
 <span data-ttu-id="acc6a-150">如果 DBPROP_INIT_PROMPT 已设置为任何其他值，则无论密码是否已过期，用户都会看到“SQL Server 登录”对话框\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-150">If DBPROP_INIT_PROMPT has been set to any other value, the user sees the **SQL Server Login** dialog, regardless of whether or not the password has expired.</span></span> <span data-ttu-id="acc6a-151">用户可单击“选项”按钮，再选中“更改密码”进行更改\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-151">The user can click on the **Options** button and check **Change Password** to change the password.</span></span>  
  
 <span data-ttu-id="acc6a-152">如果用户单击“确定”且密码已过期，则 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 会提示用户使用“更改 SQL Server 密码”对话框输入并确认新密码\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-152">If the user clicks OK and the password has expired, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prompts the user to enter and confirm a new password using the **Change SQL Server Password** dialog.</span></span>  
  
#### <a name="ole-db-prompt-behavior-and-locked-accounts"></a><span data-ttu-id="acc6a-153">OLE DB 提示行为和锁定的帐户</span><span class="sxs-lookup"><span data-stu-id="acc6a-153">OLE DB Prompt Behavior and Locked Accounts</span></span>  
 <span data-ttu-id="acc6a-154">连接尝试可能会由于帐户被锁定而失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-154">Connection attempts may fail due to the account being locked.</span></span> <span data-ttu-id="acc6a-155">如果在显示“SQL Server 登录”对话框后发生此情况，则向用户显示服务器错误消息，且连接尝试中止\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-155">If this occurs following the display of the **SQL Server Login** dialog, the server error message is displayed to the user and the connection attempt is aborted.</span></span> <span data-ttu-id="acc6a-156">如果在显示“更改 SQL Server 密码”对话框后用户输入错误的旧密码值，也会出现这种情况\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-156">It may also occur following the display of the **Change SQL Server Password** dialog if the user enters a bad value for the old password.</span></span> <span data-ttu-id="acc6a-157">在这种情况下，将显示相同的错误消息，并且连接尝试将中止。</span><span class="sxs-lookup"><span data-stu-id="acc6a-157">In this case the same error message is displayed, and the connection attempt is aborted.</span></span>  
  
#### <a name="ole-db-connection-pooling-password-expiration-and-locked-accounts"></a><span data-ttu-id="acc6a-158">OLE DB 连接池、密码过期和锁定的帐户</span><span class="sxs-lookup"><span data-stu-id="acc6a-158">OLE DB Connection Pooling, Password Expiration, and Locked Accounts</span></span>  
 <span data-ttu-id="acc6a-159">当连接在连接池中仍处于活动状态时，帐户可能被锁定或其密码可能已过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-159">An account may be locked or its password may expire while the connection is still active in a connection pool.</span></span> <span data-ttu-id="acc6a-160">服务器会在以下两种情况下检查密码是否已过期以及帐户是否已锁定。</span><span class="sxs-lookup"><span data-stu-id="acc6a-160">The server checks for expired passwords and locked accounts on two occasions.</span></span> <span data-ttu-id="acc6a-161">第一种情况是首次创建连接时。</span><span class="sxs-lookup"><span data-stu-id="acc6a-161">The first is when a connection is first created.</span></span> <span data-ttu-id="acc6a-162">第二种情况是从相应池中获取相应连接以重置连接时。</span><span class="sxs-lookup"><span data-stu-id="acc6a-162">The second occasion is upon connection reset, when the connection is taken from the pool.</span></span>  
  
 <span data-ttu-id="acc6a-163">如果重置尝试失败，则将从相应池中删除相应连接且返回一个错误。</span><span class="sxs-lookup"><span data-stu-id="acc6a-163">When the reset attempt fails, the connection is removed from the pool and an error is returned.</span></span>  
  
### <a name="ole-db-programmatic-password-expiration"></a><span data-ttu-id="acc6a-164">OLE DB 编程密码过期</span><span class="sxs-lookup"><span data-stu-id="acc6a-164">OLE DB Programmatic Password Expiration</span></span>  
 <span data-ttu-id="acc6a-165">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供程序通过添加已添加到) 属性集 VT_BSTR DBPROPSET_SQLSERVERDBINIT 属性的 SSPROP_AUTH_OLD_PASSWORD (类型来支持密码过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-165">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration through the addition of the SSPROP_AUTH_OLD_PASSWORD (type VT_BSTR) property that has been added to the DBPROPSET_SQLSERVERDBINIT property set.</span></span>  
  
 <span data-ttu-id="acc6a-166">现有“密码”属性是指 DBPROP_AUTH_PASSWORD，用于存储新密码。</span><span class="sxs-lookup"><span data-stu-id="acc6a-166">The existing "Password" property refers to DBPROP_AUTH_PASSWORD and is used to store the new password.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="acc6a-167">在连接字符串中，“旧密码”属性会设置 SSPROP_AUTH_OLD_PASSWORD，它是当前（有可能是过期的）密码，通过提供程序字符串属性无法得到该密码。</span><span class="sxs-lookup"><span data-stu-id="acc6a-167">In the connection string, the "Old Password" property sets SSPROP_AUTH_OLD_PASSWORD, which is the current (possibly expired) password that is not available via a provider string property.</span></span>  
  
 <span data-ttu-id="acc6a-168">访问接口不保留此属性的值。</span><span class="sxs-lookup"><span data-stu-id="acc6a-168">The provider does not persist the value of this property.</span></span> <span data-ttu-id="acc6a-169">如果设置此属性，则访问接口不使用连接池进行首次连接，原因是将进行新连接。</span><span class="sxs-lookup"><span data-stu-id="acc6a-169">When this property is set, the provider does not use the connection pool for the first connection because a new connection will occur.</span></span> <span data-ttu-id="acc6a-170">如果密码更改成功，则不能重新使用当前连接，原因是当前连接仍包含旧密码，这些密码在密码更改后失效。</span><span class="sxs-lookup"><span data-stu-id="acc6a-170">If the password change is successful, the current connection cannot be reused since it still contains the old password, which will be invalid after the password change.</span></span> <span data-ttu-id="acc6a-171">此外，如果登录成功，则访问接口将清除此属性。</span><span class="sxs-lookup"><span data-stu-id="acc6a-171">Also, if the login succeeds, the provider clears this property.</span></span> <span data-ttu-id="acc6a-172">如果随后尝试检索旧密码，则将返回 VT_EMPTY。</span><span class="sxs-lookup"><span data-stu-id="acc6a-172">Subsequent attempts to retrieve the old password return VT_EMPTY.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="acc6a-173">不得保留 SSPROP_AUTH_OLD_PASSWORD，因为只有在密码过期时才使用它。</span><span class="sxs-lookup"><span data-stu-id="acc6a-173">SSPROP_AUTH_OLD_PASSWORD should never be persisted since it is only used when a password has expired.</span></span>  
  
 <span data-ttu-id="acc6a-174">请注意，只要设置“旧密码”属性，访问接口就会假定正在尝试更改密码，除非还指定了 Windows 身份验证，这种情况下 Windows 身份验证始终优先。</span><span class="sxs-lookup"><span data-stu-id="acc6a-174">Note that whenever the "Old Password" property is set, the provider assumes that an attempt to change the password is being made, unless Windows Authentication is also specified, in which case it always takes precedence.</span></span>  
  
 <span data-ttu-id="acc6a-175">如果使用 Windows 身份验证，则指定旧密码会产生 DB_E_ERRORSOCCURRED 或 DB_S_ERRORSOCCURRED（具体取决于是将旧密码指定为 REQUIRED 还是 OPTIONAL），并且在 dwStatus 中返回 DBPROPSTATUS_CONFLICTINGBADVALUE 的状态值\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-175">If Windows Authentication is used, specifying the old password results in either DB_E_ERRORSOCCURRED or DB_S_ERRORSOCCURRED depending on whether the old password was specified as REQUIRED or OPTIONAL respectively, and the status value of DBPROPSTATUS_CONFLICTINGBADVALUE is returned in *dwStatus*.</span></span> <span data-ttu-id="acc6a-176">在调用 IDBInitialize::Initialize 时进行检测\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-176">This is detected when **IDBInitialize::Initialize** is called.</span></span>  
  
 <span data-ttu-id="acc6a-177">如果更改密码的尝试意外失败，则服务器将返回错误代码 18468。</span><span class="sxs-lookup"><span data-stu-id="acc6a-177">If an attempt to change the password fails unexpectedly, the server returns error code 18468.</span></span> <span data-ttu-id="acc6a-178">将从连接尝试返回标准的 OLEDB 错误。</span><span class="sxs-lookup"><span data-stu-id="acc6a-178">A standard OLEDB error is returned from the connection attempt.</span></span>  
  
 <span data-ttu-id="acc6a-179">若要详细了解 DBPROPSET_SQLSERVERDBINIT 属性集，请参阅[初始化和授权属性](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md)。</span><span class="sxs-lookup"><span data-stu-id="acc6a-179">For more information about the DBPROPSET_SQLSERVERDBINIT property set, see [Initialization and Authorization Properties](../../native-client-ole-db-data-source-objects/initialization-and-authorization-properties.md).</span></span>  
  
## <a name="sql-server-native-client-odbc-driver"></a><span data-ttu-id="acc6a-180">SQL Server Native Client ODBC 驱动程序</span><span class="sxs-lookup"><span data-stu-id="acc6a-180">SQL Server Native Client ODBC Driver</span></span>  
 <span data-ttu-id="acc6a-181">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native Client OLE DB 提供程序通过用户界面和以编程方式支持密码过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-181">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports password expiration though a user interface and programmatically.</span></span>  
  
### <a name="odbc-user-interface-password-expiration"></a><span data-ttu-id="acc6a-182">ODBC 用户界面密码过期</span><span class="sxs-lookup"><span data-stu-id="acc6a-182">ODBC User Interface Password Expiration</span></span>  
 <span data-ttu-id="acc6a-183">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驱动程序通过对**SQL Server 登录**对话框进行更改来支持密码过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-183">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports password expiration through changes made to the **SQL Server Login** dialog boxes.</span></span>  
  
 <span data-ttu-id="acc6a-184">如果调用[SQLDriverConnect](../../native-client-odbc-api/sqldriverconnect.md)并将**DriverCompletion**的值设置为 SQL_DRIVER_NOPROMPT，则如果密码已过期，则初始连接尝试将失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-184">If [SQLDriverConnect](../../native-client-odbc-api/sqldriverconnect.md) is called and the value of **DriverCompletion** is set to SQL_DRIVER_NOPROMPT, the initial connection attempt fails if the password has expired.</span></span> <span data-ttu-id="acc6a-185">SQLSTATE 值28000和本机错误代码值18487由对**SQLError**或**SQLGetDiagRec**的后续调用返回。</span><span class="sxs-lookup"><span data-stu-id="acc6a-185">The SQLSTATE value 28000 and the native error code value 18487 are returned by subsequent calls to **SQLError** or **SQLGetDiagRec**.</span></span>  
  
 <span data-ttu-id="acc6a-186">如果**DriverCompletion**已设置为任何其他值，则无论密码是否已过期，用户都会看到**SQL Server 登录**对话框。</span><span class="sxs-lookup"><span data-stu-id="acc6a-186">If **DriverCompletion** has been set to any other value, the user sees the **SQL Server Login** dialog, regardless of whether or not the password has expired.</span></span> <span data-ttu-id="acc6a-187">用户可单击“选项”按钮，再选中“更改密码”进行更改\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-187">The user can click on the **Options** button and check **Change Password** to change the password.</span></span>  
  
 <span data-ttu-id="acc6a-188">如果用户单击 "确定" 且密码已过期，则 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 会提示使用 "**更改 SQL Server 密码**" 对话框输入并确认新密码。</span><span class="sxs-lookup"><span data-stu-id="acc6a-188">If the user clicks OK and the password has expired, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] prompts to enter and confirm a new password using the **Change SQL Server Password** dialog.</span></span>  
  
#### <a name="odbc-prompt-behavior-and-locked-accounts"></a><span data-ttu-id="acc6a-189">ODBC 提示行为和锁定的帐户</span><span class="sxs-lookup"><span data-stu-id="acc6a-189">ODBC Prompt Behavior and Locked Accounts</span></span>  
 <span data-ttu-id="acc6a-190">连接尝试可能会由于帐户被锁定而失败。</span><span class="sxs-lookup"><span data-stu-id="acc6a-190">Connection attempts may fail due to the account being locked.</span></span> <span data-ttu-id="acc6a-191">如果在显示“SQL Server 登录”对话框后发生此情况，则向用户显示服务器错误消息，且连接尝试中止\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-191">If this occurs following the display of the **SQL Server Login** dialog, the server error message is displayed to the user and the connection attempt is aborted.</span></span> <span data-ttu-id="acc6a-192">如果在显示“更改 SQL Server 密码”对话框后用户输入错误的旧密码值，也会出现这种情况\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="acc6a-192">It may also occur following the display of the **Change SQL Server Password** dialog if the user enters a bad value for the old password.</span></span> <span data-ttu-id="acc6a-193">在这种情况下，将显示相同的错误消息，并且连接尝试将中止。</span><span class="sxs-lookup"><span data-stu-id="acc6a-193">In this case the same error message is displayed, and the connection attempt is aborted.</span></span>  
  
#### <a name="odbc-connection-pooling-password-expiry-and-locked-accounts"></a><span data-ttu-id="acc6a-194">ODBC 连接池、密码过期和锁定的帐户</span><span class="sxs-lookup"><span data-stu-id="acc6a-194">ODBC Connection Pooling, Password Expiry, and Locked Accounts</span></span>  
 <span data-ttu-id="acc6a-195">当连接在连接池中仍处于活动状态时，帐户可能被锁定或其密码可能已过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-195">An account may be locked or its password may expire while the connection is still active in a connection pool.</span></span> <span data-ttu-id="acc6a-196">服务器会在以下两种情况下检查密码是否已过期以及帐户是否已锁定。</span><span class="sxs-lookup"><span data-stu-id="acc6a-196">The server checks for expired passwords and locked accounts on two occasions.</span></span> <span data-ttu-id="acc6a-197">第一种情况是首次创建连接时。</span><span class="sxs-lookup"><span data-stu-id="acc6a-197">The first is when a connection is first created.</span></span> <span data-ttu-id="acc6a-198">第二种情况是从相应池中获取相应连接以重置连接时。</span><span class="sxs-lookup"><span data-stu-id="acc6a-198">The second occasion is upon connection reset, when the connection is taken from the pool.</span></span>  
  
 <span data-ttu-id="acc6a-199">如果重置尝试失败，则将从相应池中删除相应连接且返回一个错误。</span><span class="sxs-lookup"><span data-stu-id="acc6a-199">When the reset attempt fails, the connection is removed from the pool and an error is returned.</span></span>  
  
### <a name="odbc-programmatic-password-expiration"></a><span data-ttu-id="acc6a-200">ODBC 编程密码过期</span><span class="sxs-lookup"><span data-stu-id="acc6a-200">ODBC Programmatic Password Expiration</span></span>  
 <span data-ttu-id="acc6a-201">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驱动程序通过添加 SQL_COPT_SS_OLDPWD 属性（在使用[SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md)函数连接到服务器之前设置）来支持密码过期。</span><span class="sxs-lookup"><span data-stu-id="acc6a-201">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver supports password expiration through the addition of the SQL_COPT_SS_OLDPWD attribute which is set before connecting to the server using the [SQLSetConnectAttr](../../native-client-odbc-api/sqlsetconnectattr.md) function.</span></span>  
  
 <span data-ttu-id="acc6a-202">连接句柄的 SQL_COPT_SS_OLDPWD 属性是指已过期的密码。</span><span class="sxs-lookup"><span data-stu-id="acc6a-202">The SQL_COPT_SS_OLDPWD attribute of the connection handle refers to the expired password.</span></span> <span data-ttu-id="acc6a-203">对于此属性，没有连接字符串属性，原因是如果有的话会影响连接池。</span><span class="sxs-lookup"><span data-stu-id="acc6a-203">There is no connection string attribute for this attribute, as this would interfere with connection pooling.</span></span> <span data-ttu-id="acc6a-204">如果登录成功，则驱动程序将清除此属性。</span><span class="sxs-lookup"><span data-stu-id="acc6a-204">If the login succeeds, the driver clears this attribute.</span></span>  
  
 <span data-ttu-id="acc6a-205">[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]此功能的四种情况下，Native CLIENT ODBC 驱动程序将返回 SQL_ERROR：密码过期、密码策略冲突、帐户锁定以及使用 Windows 身份验证时设置旧密码属性的时间。</span><span class="sxs-lookup"><span data-stu-id="acc6a-205">The [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver returns SQL_ERROR in four cases for this feature: password expiration, password policy conflict, account lockout, and when the old password property is set while using Windows Authentication.</span></span> <span data-ttu-id="acc6a-206">调用[SQLGetDiagField](../../native-client-odbc-api/sqlgetdiagfield.md)时，驱动程序将向用户返回相应的错误消息。</span><span class="sxs-lookup"><span data-stu-id="acc6a-206">The driver returns the appropriate error messages to the user when [SQLGetDiagField](../../native-client-odbc-api/sqlgetdiagfield.md) is invoked.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="acc6a-207">另请参阅</span><span class="sxs-lookup"><span data-stu-id="acc6a-207">See Also</span></span>  
 [<span data-ttu-id="acc6a-208">SQL Server Native Client 功能</span><span class="sxs-lookup"><span data-stu-id="acc6a-208">SQL Server Native Client Features</span></span>](sql-server-native-client-features.md)  
  
  

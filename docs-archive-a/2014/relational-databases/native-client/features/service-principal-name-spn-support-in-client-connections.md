---
title: 客户端连接中的服务主体名称 (SPN) 支持 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client, SPNs
- ODBC, SPNs
- OLE DB, SPNs
- SPNs [SQL Server]
ms.assetid: 96598c69-ce9a-4090-aacb-d546591e8af7
author: rothja
ms.author: jroth
ms.openlocfilehash: 10a64baa17bd070d9354beaf6ff8c2e460682318
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87578858"
---
# <a name="service-principal-name-spn-support-in-client-connections"></a><span data-ttu-id="3eeec-102">客户端连接中的服务主体名称 (SPN) 支持</span><span class="sxs-lookup"><span data-stu-id="3eeec-102">Service Principal Name (SPN) Support in Client Connections</span></span>
  <span data-ttu-id="3eeec-103">从 [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)] 开始，扩展了对服务主体名称 (SPN) 的支持，从而能够在所有协议中相互进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="3eeec-103">Beginning with [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)], support for service principal names (SPNs) has been extended to enable mutual authentication across all protocols.</span></span> <span data-ttu-id="3eeec-104">在先前版本的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 中，如果已使用 Active Directory 注册 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例的默认 SPN，则仅对使用 TCP 的 Kerberos 支持 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-104">In previous versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], SPNs were only supported for Kerberos over TCP when the default SPN for the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance was registered with Active Directory.</span></span>  
  
 <span data-ttu-id="3eeec-105">身份验证协议可使用 SPN 来确定运行 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例时使用的帐户。</span><span class="sxs-lookup"><span data-stu-id="3eeec-105">SPNs are used by the authentication protocol to determine the account in which a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance runs.</span></span> <span data-ttu-id="3eeec-106">如果实例帐户已知，则 Kerberos 身份验证可用于通过客户端和服务器提供相互身份验证。</span><span class="sxs-lookup"><span data-stu-id="3eeec-106">If the instance account is known, Kerberos authentication can be used to provide mutual authentication by the client and server.</span></span> <span data-ttu-id="3eeec-107">如果实例帐户未知，则使用仅通过服务器提供客户端的身份验证的 NTLM 身份验证。</span><span class="sxs-lookup"><span data-stu-id="3eeec-107">If the instance account is not known, NTLM authentication, which only provides authentication of the client by the server, is used.</span></span> <span data-ttu-id="3eeec-108">目前， [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client 执行身份验证查找，并从实例名和网络连接属性派生 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-108">Currently, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client performs the authentication lookup, deriving the SPN from the instance name and network connection properties.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="3eeec-109">实例将尝试在启动时注册 SPN，或者可手动对其进行注册。</span><span class="sxs-lookup"><span data-stu-id="3eeec-109">instances will attempt to register SPNs on startup, or they can be registered manually.</span></span> <span data-ttu-id="3eeec-110">但是，如果尝试注册 SPN 的帐户的访问权限不足，则注册将失败。</span><span class="sxs-lookup"><span data-stu-id="3eeec-110">However, registration will fail if there are insufficient access rights for the account that attempts to register the SPNs.</span></span>  
  
 <span data-ttu-id="3eeec-111">域和计算机帐户在 Active Directory 中自动注册。</span><span class="sxs-lookup"><span data-stu-id="3eeec-111">Domain and computer accounts are registered automatically in Active Directory.</span></span> <span data-ttu-id="3eeec-112">这些帐户可以用作 SPN，管理员也可以定义自己的 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-112">These can be used as SPNs, or administators can define their own SPNs.</span></span> [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="3eeec-113">可通过允许客户端直接指定要使用的 SPN，从而使安全身份验证更易于管理且更可靠。</span><span class="sxs-lookup"><span data-stu-id="3eeec-113">makes secure authentication more manageable and reliable by allowing clients to directly specify the SPN to use.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="3eeec-114">只有在使用 Windows 集成安全性进行连接时，才使用客户端应用程序指定的 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-114">An SPN specified by a client application is only used when a connection is made with Windows integrated security.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="3eeec-115">**[!INCLUDE[msCoName](../../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** 是一款诊断工具，可帮助解决与 Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]相关的连接问题。</span><span class="sxs-lookup"><span data-stu-id="3eeec-115">**[!INCLUDE[msCoName](../../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** is a diagnostic tool that helps troubleshoot Kerberos related connectivity issues with [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="3eeec-116">有关详细信息，请参阅 [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046)。</span><span class="sxs-lookup"><span data-stu-id="3eeec-116">For more information, see [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="3eeec-117">**[!INCLUDE[msCoName](../../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** 是一款诊断工具，可帮助解决与 Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]相关的连接问题。</span><span class="sxs-lookup"><span data-stu-id="3eeec-117">**[!INCLUDE[msCoName](../../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]** is a diagnostic tool that helps troubleshoot Kerberos related connectivity issues with [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="3eeec-118">有关详细信息，请参阅 [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046)。</span><span class="sxs-lookup"><span data-stu-id="3eeec-118">For more information, see [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span></span>  
  
 <span data-ttu-id="3eeec-119">有关 Kerberos 的详细信息，请参阅下列文章：</span><span class="sxs-lookup"><span data-stu-id="3eeec-119">For more information about Kerberos, see the following articles:</span></span>  
  
-   [<span data-ttu-id="3eeec-120">Kerberos Technical Supplement for Windows（针对 Windows 的 Kerberos 技术补充信息）</span><span class="sxs-lookup"><span data-stu-id="3eeec-120">Kerberos Technical Supplement for Windows</span></span>](https://go.microsoft.com/fwlink/?LinkId=101449)  
  
-   [<span data-ttu-id="3eeec-121">Microsoft Kerberos</span><span class="sxs-lookup"><span data-stu-id="3eeec-121">Microsoft Kerberos</span></span>](https://go.microsoft.com/fwlink/?LinkID=100758)  
  
## <a name="usage"></a><span data-ttu-id="3eeec-122">使用情况</span><span class="sxs-lookup"><span data-stu-id="3eeec-122">Usage</span></span>  
 <span data-ttu-id="3eeec-123">下表介绍了客户端应用程序可启用安全身份验证的最常见应用场景。</span><span class="sxs-lookup"><span data-stu-id="3eeec-123">The following table describes the most common scenarios in which client applications can enable secure authentication.</span></span>  
  
|<span data-ttu-id="3eeec-124">方案</span><span class="sxs-lookup"><span data-stu-id="3eeec-124">Scenario</span></span>|<span data-ttu-id="3eeec-125">说明</span><span class="sxs-lookup"><span data-stu-id="3eeec-125">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="3eeec-126">早期应用程序不指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-126">A legacy application does not specify an SPN.</span></span>|<span data-ttu-id="3eeec-127">该兼容应用场景可确保不会对针对先前版本 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]开发的应用程序的行为进行任何更改。</span><span class="sxs-lookup"><span data-stu-id="3eeec-127">This compatibility scenario guarantees that there will be no behavior change for applications developed for previous versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="3eeec-128">如果未指定 SPN，则应用程序使用已生成的 SPN，但不能识别使用哪个身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="3eeec-128">If no SPN is specified, the application relies on generated SPNs and has no knowledge of which authentication method is used.</span></span>|  
|<span data-ttu-id="3eeec-129">使用 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client 当前版本的客户端应用程序将连接字符串中的 SPN 指定为域用户或计算机帐户、特定于实例的 SPN 或用户定义的字符串。</span><span class="sxs-lookup"><span data-stu-id="3eeec-129">A client application using the current version of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client specifies an SPN in the connection string as a domain user or computer account, as an instance-specific SPN, or as a user-defined string.</span></span>|<span data-ttu-id="3eeec-130">在访问接口、初始化或连接字符串中可使用 `ServerSPN` 关键字进行以下操作：</span><span class="sxs-lookup"><span data-stu-id="3eeec-130">The `ServerSPN` keyword can be used in a provider, initialization, or connection string to do the following:</span></span><br /><br /> <span data-ttu-id="3eeec-131">-指定实例用于连接的帐户 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="3eeec-131">-   Specify the account used by the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance for a connection.</span></span> <span data-ttu-id="3eeec-132">这可简化对 Kerberos 身份验证的访问。</span><span class="sxs-lookup"><span data-stu-id="3eeec-132">This simplifies access to Kerberos authentication.</span></span> <span data-ttu-id="3eeec-133">如果 Kerberos 密钥发行中心 (KDC) 存在且指定了正确的帐户，则使用 Kerberos 身份验证的可能性大于 NTLM。</span><span class="sxs-lookup"><span data-stu-id="3eeec-133">If a Kerberos Key Distribution Center (KDC) is present and the correct account is specified, Kerberos authentication is more likely to be used than NTLM.</span></span> <span data-ttu-id="3eeec-134">KDC 通常与域控制器在同一台计算机上。</span><span class="sxs-lookup"><span data-stu-id="3eeec-134">The KDC usually resides on the same computer as the domain controller.</span></span><br /><span data-ttu-id="3eeec-135">-指定用于查找实例的服务帐户的 SPN [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="3eeec-135">-   Specify an SPN to look up the service account for the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="3eeec-136">对于每个 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例，会生成两个可用于此目的的默认 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-136">For every [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance, two default SPNs are generated that can be used for this purpose.</span></span> <span data-ttu-id="3eeec-137">但是，不能保证 Active Directory 中存在这些密钥，因此这种情况下无法保证 Kerberos 身份验证。</span><span class="sxs-lookup"><span data-stu-id="3eeec-137">These keys are not guaranteed to be present in Active Directory, however, so in this situation Kerberos authentication is not guaranteed.</span></span><br /><span data-ttu-id="3eeec-138">-指定将用于查找实例的服务帐户的 SPN [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="3eeec-138">-   Specify an SPN that will be used to look up the service account for the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="3eeec-139">此 SPN 可以是任何映射到服务帐户的用户定义字符串。</span><span class="sxs-lookup"><span data-stu-id="3eeec-139">This can be any user-defined string that maps to the service account.</span></span> <span data-ttu-id="3eeec-140">这种情况下，必须手动在 KDC 中注册密钥，且密钥必须满足用户定义的 SPN 的规则。</span><span class="sxs-lookup"><span data-stu-id="3eeec-140">In this case, the key must be registered manually in the KDC and must satisfy the rules for a user-defined SPN.</span></span><br /><br /> <span data-ttu-id="3eeec-141">`FailoverPartnerSPN` 关键字可用于为故障转移伙伴服务器指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-141">The `FailoverPartnerSPN` keyword can be used to specify the SPN for the failover partner server.</span></span> <span data-ttu-id="3eeec-142">帐户和 Active Directory 键值的范围与您可为主体服务器指定的值相同。</span><span class="sxs-lookup"><span data-stu-id="3eeec-142">The range of account and Active Directory key values is the same as the values you can specify for the principal server.</span></span>|  
|<span data-ttu-id="3eeec-143">ODBC 应用程序将 SPN 指定为主体服务器或故障转移伙伴服务器的连接属性。</span><span class="sxs-lookup"><span data-stu-id="3eeec-143">An ODBC application specifies an SPN as a connection attribute for the principal server or failover partner server.</span></span>|<span data-ttu-id="3eeec-144">连接属性 `SQL_COPT_SS_SERVER_SPN` 可用于为与主体服务器的连接指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-144">The connection attribute `SQL_COPT_SS_SERVER_SPN` can be used to specify the SPN for a connection to the principal server.</span></span><br /><br /> <span data-ttu-id="3eeec-145">连接属性 `SQL_COPT_SS_FAILOVER_PARTNER_SPN` 可用于为故障转移伙伴服务器指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-145">The connection attribute `SQL_COPT_SS_FAILOVER_PARTNER_SPN` can be used to specify the SPN for the failover partner server.</span></span>|  
|<span data-ttu-id="3eeec-146">OLE DB 应用程序将 SPN 指定为主体服务器或故障转移伙伴服务器的数据源初始化属性。</span><span class="sxs-lookup"><span data-stu-id="3eeec-146">An OLE DB application specifies an SPN as a data source initialization property for the principal server or for a failover partner server.</span></span>|<span data-ttu-id="3eeec-147">`SSPROP_INIT_SERVER_SPN` 属性集中的连接属性 `DBPROPSET_SQLSERVERDBINIT` 可用于为连接指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-147">The connection property `SSPROP_INIT_SERVER_SPN` in the `DBPROPSET_SQLSERVERDBINIT` property set can be used to specify the SPN for a connection.</span></span><br /><br /> <span data-ttu-id="3eeec-148">`SSPROP_INIT_FAILOVER_PARTNER_SPN` 中的连接属性 `DBPROPSET_SQLSERVERDBINIT` 可用于为故障转移伙伴服务器指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-148">The connection property `SSPROP_INIT_FAILOVER_PARTNER_SPN` in the `DBPROPSET_SQLSERVERDBINIT` can be used to specify the SPN for the failover partner server.</span></span>|  
|<span data-ttu-id="3eeec-149">用户在 ODBC 数据源名称 (DSN) 中为服务器或故障转移伙伴服务器指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-149">A user specifies an SPN for a server or failover partner server in an ODBC data source name (DSN).</span></span>|<span data-ttu-id="3eeec-150">可在 ODBC DSN 中通过 DSN 设置对话框指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-150">The SPN can be specified in an ODBC DSN through the DSN setup dialog boxes.</span></span>|  
|<span data-ttu-id="3eeec-151">用户在 OLE DB 的 **“数据链接”** 或 **“登录”** 对话框中为服务器或故障转移伙伴服务器指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-151">The user specifies an SPN for a server or failover partner server in an OLE DB **Data Link** or **Login** dialog box.</span></span>|<span data-ttu-id="3eeec-152">可在 **“数据链接”** 或 **“登录”** 对话框中指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-152">The SPN can be specified in a **Data Link** or **Login** dialog box.</span></span> <span data-ttu-id="3eeec-153">**“登录”** 对话框可用于 ODBC 或 OLE DB。</span><span class="sxs-lookup"><span data-stu-id="3eeec-153">The **Login** dialog box can be used with either ODBC or OLE DB.</span></span>|  
|<span data-ttu-id="3eeec-154">ODBC 应用程序确定用于建立连接的身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="3eeec-154">An ODBC application determines the authentication method used to establish a connection.</span></span>|<span data-ttu-id="3eeec-155">连接成功打开后，应用程序可查询连接属性 `SQL_COPT_SS_INTEGRATED_AUTHENTICATION_METHOD`，从而确定使用了哪个身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="3eeec-155">When a connection has been opened successfully, an application can query the connection attribute `SQL_COPT_SS_INTEGRATED_AUTHENTICATION_METHOD` to determine which authentication method was used.</span></span> <span data-ttu-id="3eeec-156">值将包括但不限于 `NTLM` 和`Kerberos`。</span><span class="sxs-lookup"><span data-stu-id="3eeec-156">The values will include, but are not limited to, `NTLM` and `Kerberos`.</span></span>|  
|<span data-ttu-id="3eeec-157">OLE DB 应用程序确定用于建立连接的身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="3eeec-157">An OLE DB application determines the authentication method used to establish a connection.</span></span>|<span data-ttu-id="3eeec-158">连接成功打开后，应用程序可查询 `SSPROP_AUTHENTICATION_METHOD` 属性集中的连接属性 `DBPROPSET_SQLSERVERDATASOURCEINFO`，从而确定使用了哪个身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="3eeec-158">When a connection has been opened successfully, an application can query the connection property `SSPROP_AUTHENTICATION_METHOD` in the `DBPROPSET_SQLSERVERDATASOURCEINFO` property set to determine which authentication method was used.</span></span> <span data-ttu-id="3eeec-159">值将包括但不限于 `NTLM` 和`Kerberos`。</span><span class="sxs-lookup"><span data-stu-id="3eeec-159">The values will include, but are not limited to, `NTLM` and `Kerberos`.</span></span>|  
  
## <a name="failover"></a><span data-ttu-id="3eeec-160">故障转移</span><span class="sxs-lookup"><span data-stu-id="3eeec-160">Failover</span></span>  
 <span data-ttu-id="3eeec-161">SPN 未存储在故障转移缓存中，因此不能在连接之间传递 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-161">SPNs are not stored in the failover cache and therefore cannot be passed between connections.</span></span> <span data-ttu-id="3eeec-162">在连接字符串或连接属性中指定时，SPN 将用于对主体和伙伴的所有连接尝试。</span><span class="sxs-lookup"><span data-stu-id="3eeec-162">SPNs will be used on all connection attempts to the principal and partner when specified in the connection string or connection attributes.</span></span>  
  
## <a name="connection-pooling"></a><span data-ttu-id="3eeec-163">连接池</span><span class="sxs-lookup"><span data-stu-id="3eeec-163">Connection Pooling</span></span>  
 <span data-ttu-id="3eeec-164">应用程序应注意在部分而不是所有连接字符串中指定 SPN 可能会导致池碎片。</span><span class="sxs-lookup"><span data-stu-id="3eeec-164">Applications should be aware that specifying SPNs in some but not all connection strings can contribute to pool fragmentation.</span></span>  
  
 <span data-ttu-id="3eeec-165">应用程序可用编程方式指定 SPN 作为连接属性，而不是指定连接字符串关键字。</span><span class="sxs-lookup"><span data-stu-id="3eeec-165">Applications can programmatically specify SPNs as connection attributes, instead of specifying connection string keywords.</span></span> <span data-ttu-id="3eeec-166">这有助于管理连接池碎片。</span><span class="sxs-lookup"><span data-stu-id="3eeec-166">This can help manage connection pool fragmentation.</span></span>  
  
 <span data-ttu-id="3eeec-167">应用程序应注意可通过设置相应的连接属性覆盖连接字符串中的 SPN，但连接池使用的连接字符串将连接字符串值用于池。</span><span class="sxs-lookup"><span data-stu-id="3eeec-167">Applications should be aware that SPNs in connection strings can be overridden by setting the corresponding connection attributes, but connection strings used by connection pooling will use the connection string values for pooling purposes.</span></span>  
  
## <a name="down-level-server-behavior"></a><span data-ttu-id="3eeec-168">下级服务器行为</span><span class="sxs-lookup"><span data-stu-id="3eeec-168">Down-Level Server Behavior</span></span>  
 <span data-ttu-id="3eeec-169">新的连接行为由客户端实现，因此这种行为不特定于某个版本的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="3eeec-169">The new connection behavior is implemented by the client; therefore, it is not specific to a version of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
## <a name="linked-servers-and-delegation"></a><span data-ttu-id="3eeec-170">链接服务器和委托</span><span class="sxs-lookup"><span data-stu-id="3eeec-170">Linked Servers and Delegation</span></span>  
 <span data-ttu-id="3eeec-171">创建链接服务器时，[sp_addlinkedserver](/sql/relational-databases/system-stored-procedures/sp-addlinkedserver-transact-sql) 的  参数可用于指定服务器和故障转移伙伴的 SPN`@provstr`。</span><span class="sxs-lookup"><span data-stu-id="3eeec-171">When linked servers are created, the `@provstr` parameter of [sp_addlinkedserver](/sql/relational-databases/system-stored-procedures/sp-addlinkedserver-transact-sql) can be used to specify the server and failover partner SPNs.</span></span> <span data-ttu-id="3eeec-172">这样做的好处与在客户端连接字符串中指定 SPN 相同：建立使用 Kerberos 身份验证的连接更简单、更可靠。</span><span class="sxs-lookup"><span data-stu-id="3eeec-172">The benefits of doing this are the same as specifying SPNs in client connection strings: It is simpler and more reliable to establish connections that use Kerberos authentication.</span></span>  
  
 <span data-ttu-id="3eeec-173">使用链接服务器的委托要求 Kerberos 身份验证。</span><span class="sxs-lookup"><span data-stu-id="3eeec-173">Delegation with linked servers requires Kerberos authentication.</span></span>  
  
## <a name="management-aspects-of-spns-specified-by-applications"></a><span data-ttu-id="3eeec-174">应用程序指定的 SPN 的管理方面</span><span class="sxs-lookup"><span data-stu-id="3eeec-174">Management Aspects of SPNs Specified by Applications</span></span>  
 <span data-ttu-id="3eeec-175">选择在应用程序中通过连接字符串还是以编程方式通过连接属性指定 SPN（而不是依赖于默认访问接口生成的 SPN）时，请考虑以下因素：</span><span class="sxs-lookup"><span data-stu-id="3eeec-175">When choosing whether to specify SPNs in an application (through connection strings) or programmatically through connection properties (rather than relying on the defalt provider generated SPNs), consider the following factors:</span></span>  
  
-   <span data-ttu-id="3eeec-176">安全性：指定的 SPN 是否会泄露受保护的信息？</span><span class="sxs-lookup"><span data-stu-id="3eeec-176">Security: Does the specified SPN disclose information that is protected?</span></span>  
  
-   <span data-ttu-id="3eeec-177">可靠性：若要能够使用默认 SPN，[!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例运行时使用的服务帐户必须具有足够的特权才能对 KDC 更新 Active Directory。</span><span class="sxs-lookup"><span data-stu-id="3eeec-177">Reliability: To enable the use of default SPNs, the service account in which the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance runs must have sufficient privileges to update the Active Directory on the KDC.</span></span>  
  
-   <span data-ttu-id="3eeec-178">方便性和位置透明性：如果应用程序的数据库移到其他 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例，则将如何影响该应用程序的 SPN？</span><span class="sxs-lookup"><span data-stu-id="3eeec-178">Convenience and location transparency: How will an application's SPNs be affected if its database moves to a different [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance?</span></span> <span data-ttu-id="3eeec-179">如果使用数据库镜像，则这种情况适用于主体服务器及其故障转移伙伴。</span><span class="sxs-lookup"><span data-stu-id="3eeec-179">This applies to both the principal server and its failover partner if you use database mirroring.</span></span> <span data-ttu-id="3eeec-180">如果服务器更改意味着必须更改 SPN，则这种情况将如何影响应用程序？</span><span class="sxs-lookup"><span data-stu-id="3eeec-180">If a server change means that SPNs must be changed, how will this affect applications?</span></span> <span data-ttu-id="3eeec-181">是否将管理所有更改？</span><span class="sxs-lookup"><span data-stu-id="3eeec-181">Will any changes be managed?</span></span>  
  
## <a name="specifying-the-spn"></a><span data-ttu-id="3eeec-182">指定 SPN</span><span class="sxs-lookup"><span data-stu-id="3eeec-182">Specifying the SPN</span></span>  
 <span data-ttu-id="3eeec-183">您可以使用对话框和代码指定 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-183">You can specify an SPN in dialog boxes and in code.</span></span> <span data-ttu-id="3eeec-184">本节论述了可以指定 SPN 的方式。</span><span class="sxs-lookup"><span data-stu-id="3eeec-184">This section discusses how you can specify an SPN.</span></span>  
  
 <span data-ttu-id="3eeec-185">SPN 的最大长度是 260 个字符。</span><span class="sxs-lookup"><span data-stu-id="3eeec-185">The maximum length for an SPN is 260 characters.</span></span>  
  
 <span data-ttu-id="3eeec-186">以下是 SPN 在连接字符串或连接属性中使用的语法：</span><span class="sxs-lookup"><span data-stu-id="3eeec-186">The syntax that SPNs use in connection string or connection attributes is as follows:</span></span>  
  
|<span data-ttu-id="3eeec-187">语法</span><span class="sxs-lookup"><span data-stu-id="3eeec-187">Syntax</span></span>|<span data-ttu-id="3eeec-188">说明</span><span class="sxs-lookup"><span data-stu-id="3eeec-188">Description</span></span>|  
|------------|-----------------|  
|<span data-ttu-id="3eeec-189">MSSQLSvc/*fqdn*</span><span class="sxs-lookup"><span data-stu-id="3eeec-189">MSSQLSvc/*fqdn*</span></span>|<span data-ttu-id="3eeec-190">使用除 TCP 之外的协议时访问接口生成的用于默认实例的默认 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-190">The provider-generated, default SPN for a default instance when a protocol other than TCP is used.</span></span><br /><br /> <span data-ttu-id="3eeec-191">*fqdn*为完全限定的域名。</span><span class="sxs-lookup"><span data-stu-id="3eeec-191">*fqdn* is a fully-qualified domain name.</span></span>|  
|<span data-ttu-id="3eeec-192">MSSQLSvc/*fqdn*:*port*</span><span class="sxs-lookup"><span data-stu-id="3eeec-192">MSSQLSvc/*fqdn*:*port*</span></span>|<span data-ttu-id="3eeec-193">使用 TCP 时访问接口生成的默认 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-193">The provider-generated, default SPN when TCP is used.</span></span><br /><br /> <span data-ttu-id="3eeec-194">*port* 是 TCP 端口号。</span><span class="sxs-lookup"><span data-stu-id="3eeec-194">*port* is a TCP port number.</span></span>|  
|<span data-ttu-id="3eeec-195">MSSQLSvc/*fqdn*：*InstanceName*</span><span class="sxs-lookup"><span data-stu-id="3eeec-195">MSSQLSvc/*fqdn*:*InstanceName*</span></span>|<span data-ttu-id="3eeec-196">使用除 TCP 之外的协议时访问接口生成的用于命名实例的默认 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-196">The provider-generated, default SPN for a named instance when a protocol other than TCP is used.</span></span><br /><br /> <span data-ttu-id="3eeec-197">InstanceName 为 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 实例名\*\*。</span><span class="sxs-lookup"><span data-stu-id="3eeec-197">*InstanceName* is a [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] instance name.</span></span>|  
|<span data-ttu-id="3eeec-198">HOST/*fqdn*</span><span class="sxs-lookup"><span data-stu-id="3eeec-198">HOST/*fqdn*</span></span><br /><br /> <span data-ttu-id="3eeec-199">HOST/*MachineName*</span><span class="sxs-lookup"><span data-stu-id="3eeec-199">HOST/*MachineName*</span></span>|<span data-ttu-id="3eeec-200">映射到内置计算机帐户的 SPN，这些内置计算机帐户由 Windows 自动注册。</span><span class="sxs-lookup"><span data-stu-id="3eeec-200">The SPN that maps to built-in computer accounts that are automatically registered by Windows.</span></span>|  
|<span data-ttu-id="3eeec-201">*用户名* @*域*</span><span class="sxs-lookup"><span data-stu-id="3eeec-201">*Username*@*Domain*</span></span>|<span data-ttu-id="3eeec-202">域帐户的直接规范。</span><span class="sxs-lookup"><span data-stu-id="3eeec-202">Direct specification of a domain account.</span></span><br /><br /> <span data-ttu-id="3eeec-203">*Username* 为 Windows 用户帐户名。</span><span class="sxs-lookup"><span data-stu-id="3eeec-203">*Username* is a Windows user account name.</span></span><br /><br /> <span data-ttu-id="3eeec-204">*Domain* 为 Windows 域名或完全限定的域名。</span><span class="sxs-lookup"><span data-stu-id="3eeec-204">*Domain* is a Windows domain name or fully-qualified domain name.</span></span>|  
|<span data-ttu-id="3eeec-205">*MachineName* $@*域*</span><span class="sxs-lookup"><span data-stu-id="3eeec-205">*MachineName*$@*Domain*</span></span>|<span data-ttu-id="3eeec-206">计算机帐户的直接规范。</span><span class="sxs-lookup"><span data-stu-id="3eeec-206">Direct specification of a computer account.</span></span><br /><br /> <span data-ttu-id="3eeec-207"> (如果要连接到的服务器在 "本地系统" 或 "网络服务" 帐户下运行，若要获取 Kerberos 身份验证， `ServerSPN` 可以采用*MachineName* $@ *域*格式。 ) </span><span class="sxs-lookup"><span data-stu-id="3eeec-207">(If the server you are connecting to is running under LOCAL SYSTEM or NETWORK SERVICE accounts, to get Kerberos authentication, `ServerSPN` can be in the *MachineName*$@*Domain* format.)</span></span>|  
|<span data-ttu-id="3eeec-208">*KDCKey* /*MachineName*</span><span class="sxs-lookup"><span data-stu-id="3eeec-208">*KDCKey*/*MachineName*</span></span>|<span data-ttu-id="3eeec-209">用户指定的 SPN。</span><span class="sxs-lookup"><span data-stu-id="3eeec-209">A user-specified SPN.</span></span><br /><br /> <span data-ttu-id="3eeec-210">*KDCKey* 为符合 KDC 密钥的规则的字母数字字符串。</span><span class="sxs-lookup"><span data-stu-id="3eeec-210">*KDCKey* is an alphanumeric string that conforms to the rules for a KDC key.</span></span>|  
  
## <a name="odbc-and-ole-db-syntax-supporting-spns"></a><span data-ttu-id="3eeec-211">支持 SPN 的 ODBC 和 OLE DB 语法</span><span class="sxs-lookup"><span data-stu-id="3eeec-211">ODBC and OLE DB Syntax Supporting SPNs</span></span>  
 <span data-ttu-id="3eeec-212">有关特定于语法的信息，请参阅以下主题：</span><span class="sxs-lookup"><span data-stu-id="3eeec-212">For syntax-specific information, see the following topics:</span></span>  
  
-   [<span data-ttu-id="3eeec-213">客户端连接中的服务主体名称 (SPN) (ODBC)</span><span class="sxs-lookup"><span data-stu-id="3eeec-213">Service Principal Names &#40;SPNs&#41; in Client Connections &#40;ODBC&#41;</span></span>](../odbc/service-principal-names-spns-in-client-connections-odbc.md)  
  
-   [<span data-ttu-id="3eeec-214">客户端连接中的服务主体名称 (SPN) (OLE DB)</span><span class="sxs-lookup"><span data-stu-id="3eeec-214">Service Principal Names &#40;SPNs&#41; in Client Connections &#40;OLE DB&#41;</span></span>](../ole-db/service-principal-names-spns-in-client-connections-ole-db.md)  
  
 <span data-ttu-id="3eeec-215">有关演示此功能的示例应用程序的信息，请参阅 [SQL Server 数据编程示例](https://msftdpprodsamples.codeplex.com/)。</span><span class="sxs-lookup"><span data-stu-id="3eeec-215">For information about sample applications that demonstrate this feature, see [SQL Server Data Programmability Samples](https://msftdpprodsamples.codeplex.com/).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="3eeec-216">另请参阅</span><span class="sxs-lookup"><span data-stu-id="3eeec-216">See Also</span></span>  
 [<span data-ttu-id="3eeec-217">SQL Server Native Client 功能</span><span class="sxs-lookup"><span data-stu-id="3eeec-217">SQL Server Native Client Features</span></span>](sql-server-native-client-features.md)  
  

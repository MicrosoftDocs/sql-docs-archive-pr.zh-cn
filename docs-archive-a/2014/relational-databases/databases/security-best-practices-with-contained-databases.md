---
title: 针对包含数据库的安全最佳做法 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: security
ms.topic: conceptual
helpviewer_keywords:
- contained database, threats
ms.assetid: 026ca5fc-95da-46b6-b882-fa20f765b51d
author: stevestein
ms.author: sstein
ms.openlocfilehash: 8a4a933b99090d29f38156c56c9efa56b73af5a1
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87682879"
---
# <a name="security-best-practices-with-contained-databases"></a><span data-ttu-id="7e3a7-102">针对包含数据库的安全性最佳方法</span><span class="sxs-lookup"><span data-stu-id="7e3a7-102">Security Best Practices with Contained Databases</span></span>
  <span data-ttu-id="7e3a7-103">包含的数据库面临着一些独有的威胁， [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 管理员应该了解并缓解这些威胁。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-103">Contained databases have some unique threats that should be understood and mitigated by [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] administrators.</span></span> <span data-ttu-id="7e3a7-104">大部分威胁与 `USER WITH PASSWORD` 身份验证过程相关，该过程会将身份验证的范围从[!INCLUDE[ssDE](../../includes/ssde-md.md)]级别转到数据库级别。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-104">Most of the threats are related to the `USER WITH PASSWORD` authentication process, which moves the authentication boundary from the [!INCLUDE[ssDE](../../includes/ssde-md.md)] level to the database level.</span></span>  
  
## <a name="threats-related-to-users"></a><span data-ttu-id="7e3a7-105">与用户相关的威胁</span><span class="sxs-lookup"><span data-stu-id="7e3a7-105">Threats Related to Users</span></span>  
 <span data-ttu-id="7e3a7-106">如果包含数据库中具有权限的用户（ `ALTER ANY USER` 如**db_owner**和**db_securityadmin**固定数据库角色的成员），则可以在管理员不知道或权限的情况下向数据库授予访问权限 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-106">Users in a contained database that have the `ALTER ANY USER` permission, such as members of the **db_owner** and **db_securityadmin** fixed database roles, can grant access to the database without the knowledge or permission if the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrator.</span></span> <span data-ttu-id="7e3a7-107">授予用户对包含数据库的访问权限会增加整个 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例受到攻击的可能性。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-107">Granting users access to a contained database increases the potential attack surface area against the whole [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance.</span></span> <span data-ttu-id="7e3a7-108">管理员应了解访问控制的这种委托，而且在为包含数据库中的用户授予 `ALTER ANY USER` 权限时要非常谨慎。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-108">Administrators should understand this delegation of access control, and be very careful about granting users in the contained database the `ALTER ANY USER` permission.</span></span> <span data-ttu-id="7e3a7-109">所有数据库所有者都拥有 `ALTER ANY USER` 权限。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-109">All database owners have the `ALTER ANY USER` permission.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="7e3a7-110">管理员应该定期审核包含数据库中的用户。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-110">administrators should periodically audit the users in a contained database.</span></span>  
  
### <a name="accessing-other-databases-using-the-guest-account"></a><span data-ttu-id="7e3a7-111">使用 guest 帐户访问其他数据库</span><span class="sxs-lookup"><span data-stu-id="7e3a7-111">Accessing Other Databases Using the guest Account</span></span>  
 <span data-ttu-id="7e3a7-112">数据库所有者和拥有 `ALTER ANY USER` 权限的数据库用户可以创建包含数据库用户。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-112">Database owners and database users with the `ALTER ANY USER` permission can create contained database users.</span></span> <span data-ttu-id="7e3a7-113">在连接到 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例上包含的数据库后，如果其他数据库启用了 [!INCLUDE[ssDE](../../includes/ssde-md.md)]guest **帐户，包含数据库的用户就可以访问** 上的其他数据库。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-113">After connecting to a contained database on an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], a contained database user can access other databases on the [!INCLUDE[ssDE](../../includes/ssde-md.md)], if the other databases have enabled the **guest** account.</span></span>  
  
### <a name="creating-a-duplicate-user-in-another-database"></a><span data-ttu-id="7e3a7-114">在另一个数据库中创建重复用户</span><span class="sxs-lookup"><span data-stu-id="7e3a7-114">Creating a Duplicate User in Another Database</span></span>  
 <span data-ttu-id="7e3a7-115">某些应用程序可能要求用户可以访问多个数据库。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-115">Some applications might require that a user to have access to more than one database.</span></span> <span data-ttu-id="7e3a7-116">可以通过在每个数据库中创建相同的包含的数据库来做到这点。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-116">This can be done by creating identical contained database users in each database.</span></span> <span data-ttu-id="7e3a7-117">在创建带密码的第二个用户时，使用 SID 选项。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-117">Use the SID option when creating the second user with password.</span></span> <span data-ttu-id="7e3a7-118">下面的示例在两个数据库中创建两个完全相同的用户。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-118">The following example creates two identical users in two databases.</span></span>  
  
```  
USE DB1;  
GO  
CREATE USER Carlo WITH PASSWORD = '<strong password>';   
-- Return the SID of the user  
SELECT SID FROM sys.database_principals WHERE name = 'Carlo';  
  
-- Change to the second database  
USE DB2;  
GO  
CREATE USER Carlo WITH PASSWORD = '<same password>', SID = <SID from DB1>;  
GO  
```  
  
 <span data-ttu-id="7e3a7-119">若要执行跨数据库查询，必须在调用数据库上设置 `TRUSTWORTHY` 选项。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-119">To execute a cross-database query, you must set the `TRUSTWORTHY` option on the calling database.</span></span> <span data-ttu-id="7e3a7-120">例如，如果以上定义的用户 (Carlo) 在 DB1 中，要执行 `SELECT * FROM db2.dbo.Table1;`，则 `TRUSTWORTHY` 设置对于数据库 DB1 必须为 on。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-120">For example if the user (Carlo) defined above is in DB1, to execute `SELECT * FROM db2.dbo.Table1;` then the `TRUSTWORTHY` setting must be on for database DB1.</span></span> <span data-ttu-id="7e3a7-121">执行以下代码以将 `TRUSTWORHTY` 设置为 on。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-121">Execute the following code to set the `TRUSTWORHTY` setting on.</span></span>  
  
```  
ALTER DATABASE DB1 SET TRUSTWORTHY ON;  
```  
  
### <a name="creating-a-user-that-duplicates-a-login"></a><span data-ttu-id="7e3a7-122">创建复制登录名的用户</span><span class="sxs-lookup"><span data-stu-id="7e3a7-122">Creating a User that Duplicates a Login</span></span>  
 <span data-ttu-id="7e3a7-123">如果创建了一个有密码的包含数据库用户，所使用的名称与 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登录名相同，而且在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登录名进行连接时将包含的数据库指定为初始目录，则 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登录名将无法连接。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-123">If a contained database user with password is created, using the same name as a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login, and if the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login connects specifying the contained database as the initial catalog, then the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login will be unable to connect.</span></span> <span data-ttu-id="7e3a7-124">该连接将被判定为包含数据库上的具有密码主体的包含数据库用户发起，而不是基于 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登录名的用户发起。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-124">The connection will be evaluated as the contained database user with password principal on the contained database instead of as a user based on the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login.</span></span> <span data-ttu-id="7e3a7-125">这可能导致 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登录名遭遇到拒绝服务。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-125">This could cause an intentional or accidental denial of service for the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login.</span></span>  
  
-   <span data-ttu-id="7e3a7-126">最佳做法是， **sysadmin** 固定服务器角色的成员应该始终考虑在连接时不使用初始目录选项。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-126">As a best practice, members of the **sysadmin** fixed server role should consider always connecting without using the initial catalog option.</span></span> <span data-ttu-id="7e3a7-127">这样会使登录名连接到 master 数据库，并可避免数据库所有者滥用登录名的可能性。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-127">This connects the login to the master database and avoids any attempts by a database owner to misuse the login attempt.</span></span> <span data-ttu-id="7e3a7-128">然后，管理员可以使用语句更改为包含的数据库 `USE` *\<database>* 。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-128">Then the administrator can change to the contained database by using the `USE`*\<database>* statement.</span></span> <span data-ttu-id="7e3a7-129">您也可以将登录操作的默认数据库设置为包含的数据库，这样会先登录到 **master**数据库，然后再转而登录到包含的数据库。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-129">You can also set the default database of the login to the contained database, which completes the login to **master**, and then transfers the login to the contained database.</span></span>  
  
-   <span data-ttu-id="7e3a7-130">最佳做法是，创建有密码的包含数据库用户时，其名称不得与 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 登录名相同。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-130">As a best practice, do not create contained database users with passwords who have the same name as [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] logins.</span></span>  
  
-   <span data-ttu-id="7e3a7-131">如果存在重复的登录名，则连接到**master**数据库而不指定初始目录，然后执行 `USE` 命令以更改为包含的数据库。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-131">If the duplicate login exists, connect to the **master** database without specifying an initial catalog, and then execute the `USE` command to change to the contained database.</span></span>  
  
-   <span data-ttu-id="7e3a7-132">存在包含的数据库时，非包含数据库的用户应连接到 [!INCLUDE[ssDE](../../includes/ssde-md.md)] ，但不要使用初始目录，或者将非包含数据库的数据库名称指定为初始目录。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-132">When contained databases are present, users of databases that are not contained databases should connect to the [!INCLUDE[ssDE](../../includes/ssde-md.md)] without using an initial catalog or by specifying the database name of a non-contained database as the initial catalog.</span></span> <span data-ttu-id="7e3a7-133">这样就避免了连接到包含的数据库而导致 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 管理员的直接控制减弱。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-133">This avoids connecting to the contained database which is under less direct control by the [!INCLUDE[ssDE](../../includes/ssde-md.md)] administrators.</span></span>  
  
### <a name="increasing-access-by-changing-the-containment-status-of-a-database"></a><span data-ttu-id="7e3a7-134">通过更改数据库的包含状态来增加访问</span><span class="sxs-lookup"><span data-stu-id="7e3a7-134">Increasing Access by Changing the Containment Status of a Database</span></span>  
 <span data-ttu-id="7e3a7-135">具有权限的登录名（ `ALTER ANY DATABASE` 如**dbcreator**固定服务器角色的成员）以及非包含数据库中具有权限的用户（ `CONTROL DATABASE` 如**db_owner**固定数据库角色的成员）都可以更改数据库的包含设置。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-135">Logins that have the `ALTER ANY DATABASE` permission, such as members of the **dbcreator** fixed server role, and users in a non-contained database that have the `CONTROL DATABASE` permission, such as members of the **db_owner** fixed database role, can change the containment setting of a database.</span></span> <span data-ttu-id="7e3a7-136">如果数据库的包含设置从 `NONE` 更改为 `PARTIAL` 或 `FULL`，则可以通过创建有密码的包含数据库用户来授予用户访问权限。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-136">If the containment setting of a database is changed from `NONE` to either `PARTIAL` or `FULL`, then user access can be granted by creating contained database users with passwords.</span></span> <span data-ttu-id="7e3a7-137">这样就可以在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 管理员不知情或不允许的情况下提供访问。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-137">This could provide access without the knowledge or consent of the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrators.</span></span> <span data-ttu-id="7e3a7-138">若要防止包含任何数据库，请将 [!INCLUDE[ssDE](../../includes/ssde-md.md)] `contained database authentication` 选项设置为0。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-138">To prevent any databases from being contained, set the [!INCLUDE[ssDE](../../includes/ssde-md.md)]`contained database authentication` option to 0.</span></span> <span data-ttu-id="7e3a7-139">若要阻止有密码的包含数据库用户连接到选定的包含的数据库，请使用登录触发器取消有密码的包含数据库用户进行的登录尝试。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-139">To prevent connections by contained database users with passwords on selected contained databases, use login triggers to cancel login attempts by contained database users with passwords.</span></span>  
  
### <a name="attaching-a-contained-database"></a><span data-ttu-id="7e3a7-140">附加包含的数据库</span><span class="sxs-lookup"><span data-stu-id="7e3a7-140">Attaching a Contained Database</span></span>  
 <span data-ttu-id="7e3a7-141">通过附加包含的数据库，管理员会向用户授予针对 [!INCLUDE[ssDE](../../includes/ssde-md.md)]实例的不必要的访问权限。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-141">By attaching a contained database, an administrator could give unwanted users access to the instance of the [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span> <span data-ttu-id="7e3a7-142">担心这种风险的管理员可以使数据库以 `RESTRICTED_USER` 模式联机，这样会阻止对有密码的包含数据库用户进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-142">An administrator concerned about this risk can bring the database online in `RESTRICTED_USER` mode, which prevents authentication for contained database users with passwords.</span></span> <span data-ttu-id="7e3a7-143">只有通过登录授权的主体才能够访问 [!INCLUDE[ssDE](../../includes/ssde-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-143">Only principals authorized through logins will be able to access the [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span>  
  
 <span data-ttu-id="7e3a7-144">用户是使用在其创建时有效的密码要求创建的，并且在附加数据库时不重新检查密码。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-144">Users are created using the password requirements in effect at the time that they are created and passwords are not rechecked when a database is attached.</span></span> <span data-ttu-id="7e3a7-145">通过将一个允许使用弱密码的包含数据库附加到一个具有更严格密码策略的系统上，管理员可能允许在附加 [!INCLUDE[ssDE](../../includes/ssde-md.md)]上使用不满足当前密码策略的密码。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-145">By attaching a contained database which allowed weak passwords to a system with a stricter password policy, an administrator could permit passwords that do not meet the current password policy on the attaching [!INCLUDE[ssDE](../../includes/ssde-md.md)].</span></span> <span data-ttu-id="7e3a7-146">通过要求对附加数据库重置所有密码，管理员可以避免保留弱密码。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-146">Administrators can avoid retaining the weak passwords by requiring that all passwords be reset for the attached database.</span></span>  
  
### <a name="password-policies"></a><span data-ttu-id="7e3a7-147">密码策略</span><span class="sxs-lookup"><span data-stu-id="7e3a7-147">Password Policies</span></span>  
 <span data-ttu-id="7e3a7-148">可以要求数据库中的密码是强密码，但不能通过可靠的密码策略来保护这些密码。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-148">Passwords in a database can be required to be strong passwords, but cannot be protected by robust password policies.</span></span> <span data-ttu-id="7e3a7-149">尽可能地使用 Windows 身份验证，以便利用 Windows 提供的更加广泛的密码策略。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-149">Use Windows Authentication whenever possible to take advantage of the more extensive password policies available from Windows.</span></span>  
  
### <a name="kerberos-authentication"></a><span data-ttu-id="7e3a7-150">Kerberos 身份验证</span><span class="sxs-lookup"><span data-stu-id="7e3a7-150">Kerberos Authentication</span></span>  
 <span data-ttu-id="7e3a7-151">有密码的包含数据库用户不能使用 Kerberos 身份验证。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-151">Contained database users with passwords cannot use Kerberos Authentication.</span></span> <span data-ttu-id="7e3a7-152">尽可能使用 Windows 身份验证，以便利用 Kerberos 等 Windows 功能。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-152">When possible, use Windows Authentication to take advantage of Windows features such as Kerberos.</span></span>  
  
### <a name="offline-dictionary-attack"></a><span data-ttu-id="7e3a7-153">脱机字典攻击</span><span class="sxs-lookup"><span data-stu-id="7e3a7-153">Offline Dictionary Attack</span></span>  
 <span data-ttu-id="7e3a7-154">有密码的包含数据库用户的密码哈希值存储在包含的数据库中。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-154">The password hashes for contained database users with passwords are stored in the contained database.</span></span> <span data-ttu-id="7e3a7-155">任何具有数据库文件访问权限的人都可以对未审核系统上有密码的包含数据库用户进行字典攻击。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-155">Anyone with access to the database files could perform a dictionary attack against the contained database users with passwords on an unaudited system.</span></span> <span data-ttu-id="7e3a7-156">若要减轻这种威胁，请限制对数据库文件的访问，或者只允许使用 Windows 身份验证连接到包含的数据库。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-156">To mitigate this threat, restrict access to the database files, or only permit connections to contained databases by using Windows Authentication.</span></span>  
  
## <a name="escaping-a-contained-database"></a><span data-ttu-id="7e3a7-157">避免使用包含的数据库</span><span class="sxs-lookup"><span data-stu-id="7e3a7-157">Escaping a Contained Database</span></span>  
 <span data-ttu-id="7e3a7-158">如果某个数据库为部分包含，则 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 管理员应该定期审核包含的数据库中用户和模块的能力。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-158">If a database is partially contained, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] administrators should periodically audit the capabilities of the users and modules in contained databases.</span></span>  
  
## <a name="denial-of-service-through-auto_close"></a><span data-ttu-id="7e3a7-159">通过 AUTO_CLOSE 拒绝服务</span><span class="sxs-lookup"><span data-stu-id="7e3a7-159">Denial of Service Through AUTO_CLOSE</span></span>  
 <span data-ttu-id="7e3a7-160">不要将包含的数据库配置为自动关闭。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-160">Do not configure contained databases to auto close.</span></span> <span data-ttu-id="7e3a7-161">如果关闭，打开数据库对用户进行身份验证会消耗额外的资源，并可能导致拒绝服务攻击。</span><span class="sxs-lookup"><span data-stu-id="7e3a7-161">If closed, opening the database to authenticate a user consumes additional resources and could contribute to a denial of service attack.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7e3a7-162">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7e3a7-162">See Also</span></span>  
 <span data-ttu-id="7e3a7-163">[包含的数据库](contained-databases.md) </span><span class="sxs-lookup"><span data-stu-id="7e3a7-163">[Contained Databases](contained-databases.md) </span></span>  
 [<span data-ttu-id="7e3a7-164">迁移到部分包含的数据库</span><span class="sxs-lookup"><span data-stu-id="7e3a7-164">Migrate to a Partially Contained Database</span></span>](migrate-to-a-partially-contained-database.md)  
  
  

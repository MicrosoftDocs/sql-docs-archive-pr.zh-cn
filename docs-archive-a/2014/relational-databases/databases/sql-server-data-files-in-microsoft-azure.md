---
title: SQL Server Azure 中的数据文件 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
ms.assetid: 38ffd9c2-18a5-43d2-b674-e425addec4e4
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 21f960a50ed48ff2b146d96b73a1609d73b35c32
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87682871"
---
# <a name="sql-server-data-files-in-azure"></a><span data-ttu-id="1d5e6-102">Azure 中的 SQL Server 数据文件</span><span class="sxs-lookup"><span data-stu-id="1d5e6-102">SQL Server Data Files in Azure</span></span>
  <span data-ttu-id="1d5e6-103">SQL Server Azure 中的数据文件，可以对作为 Azure Blob 存储的 SQL Server 数据库文件提供本机支持。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-103">SQL Server Data Files in Azure enables native support for SQL Server database files stored as Azure Blobs.</span></span> <span data-ttu-id="1d5e6-104">通过此功能，你可以在本地或 Azure 中的虚拟机上运行的 SQL Server 中创建数据库，并在 Azure Blob 存储中为数据创建专用存储位置。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-104">It allows you to create a database in SQL Server running in on-premises or in a virtual machine in Azure with a dedicated storage location for your data in Azure Blob Storage.</span></span> <span data-ttu-id="1d5e6-105">此增强功能使用分离和附加操作，简化了计算机之间的数据库移动。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-105">This enhancement especially simplifies to move databases between machines by using detach and attach operations.</span></span> <span data-ttu-id="1d5e6-106">此外，它还允许从或向 Azure 存储还原，为数据库备份文件提供备用存储位置。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-106">In addition, it provides an alternative storage location for your database backup files by allowing you to restore from or to Azure Storage.</span></span> <span data-ttu-id="1d5e6-107">因此，它在数据虚拟化、数据移动、安全性和可用性、轻松降低成本以及维护方面都具备优势，可实现高可用性和弹性扩展，支持几种混合解决方案。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-107">Therefore, it enables several hybrid solutions by providing several benefits for data virtualization, data movement, security and availability, and any easy low costs and maintenance for high-availability and elastic scaling.</span></span>  
  
 <span data-ttu-id="1d5e6-108">本主题介绍在 Azure 存储服务中存储 SQL Server 数据文件的核心概念和注意事项。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-108">This topic introduces concepts and considerations that are central to storing SQL Server data files in Azure Storage Service.</span></span>  
  
 <span data-ttu-id="1d5e6-109">有关如何使用此新功能的实际动手体验，请参阅[教程：在 Azure 存储服务中 SQL Server 数据文件](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-109">For a practical hands-on experience on how to use this new feature, see [Tutorial: SQL Server Data Files in Azure Storage service](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).</span></span>  
  
 <span data-ttu-id="1d5e6-110">下图演示了此增强功能使你能够将 SQL Server 数据库文件存储为 Azure 存储中的 Azure blob，而不管服务器驻留在何处。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-110">The following diagram demonstrates that this enhancement enables you to store SQL Server database files as Azure blobs in Azure Storage regardless of where your server resides.</span></span>  
  
 <span data-ttu-id="1d5e6-111">![SQL Server 与 Azure 存储集成](../../database-engine/media/sql-server-dbfiles-stored-as-blobs.gif "SQL Server 与 Azure 存储集成")</span><span class="sxs-lookup"><span data-stu-id="1d5e6-111">![SQL Server Integration with Azure Storage](../../database-engine/media/sql-server-dbfiles-stored-as-blobs.gif "SQL Server Integration with Azure Storage")</span></span>  
  
## <a name="benefits-of-using-sql-server-data-files-in-azure"></a><span data-ttu-id="1d5e6-112">在 Azure 中使用 SQL Server 数据文件的好处</span><span class="sxs-lookup"><span data-stu-id="1d5e6-112">Benefits of using SQL Server Data Files in Azure</span></span>  
  
-   <span data-ttu-id="1d5e6-113">**迁移方便快捷优势：** 此功能在本地计算机之间以及在本地与云环境中的计算机之间一次迁移一个数据库，从而简化了迁移过程，而无需进行任何应用程序更改。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-113">**Easy and fast migration benefits:** This feature simplifies the migration process by moving one database at a time between machines in on-premises as well as between on-premises and cloud environments without any application changes.</span></span> <span data-ttu-id="1d5e6-114">因此，它能在保持现有本地基础架构不变的情况下支持增量迁移。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-114">Therefore, it supports an incremental migration while maintaining your existing on-premises infrastructure in place.</span></span> <span data-ttu-id="1d5e6-115">此外，在应用程序需要在本地环境多个位置运行时，对集中数据存储的访问权限可以简化应用程序逻辑。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-115">In addition, having access to a centralized data storage simplifies the application logic when an application needs to run in multiple locations in an on-premises environment.</span></span> <span data-ttu-id="1d5e6-116">在某些情况下，可能需要在地理上分散的位置快速设置计算机中心，以便从很多不同来源收集数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-116">In some cases, you may need to rapidly setup computer centers in geographically dispersed locations, which gather data from many different sources.</span></span> <span data-ttu-id="1d5e6-117">通过使用这项新的增强功能，你可以将多个数据库存储为 Azure blob，然后运行 Transact-sql 脚本在本地计算机或虚拟机上创建数据库，而不是将数据从一个位置移动到另一个位置。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-117">By using this new enhancement, instead of moving data from one location to another, you can store many databases as Azure blobs, and then run Transact-SQL scripts to create databases on the local machines or virtual machines.</span></span>  
  
-   <span data-ttu-id="1d5e6-118">**成本和无限制存储优势：** 利用此功能，你可以在 Azure 中使用无限制的站外存储，同时利用本地计算资源。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-118">**Cost and limitless storage benefits:** This feature enables you to have limitless off-site storage in Azure while leveraging on-premises compute resources.</span></span> <span data-ttu-id="1d5e6-119">当你使用 Azure 作为存储位置时，可以轻松地将精力集中在应用程序逻辑上，而不会产生硬件管理开销。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-119">When you use Azure as a storage location, you can easily focus on the application logic without the overhead of hardware management.</span></span> <span data-ttu-id="1d5e6-120">如果丢失一个本地计算节点，无需进行任何数据移动操作即可设置新节点。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-120">If you lose a computation node on-premises, you can set up a new one without any data movement.</span></span>  
  
-   <span data-ttu-id="1d5e6-121">**高可用性和灾难恢复优势：** 使用 Azure 中的 SQL Server 数据文件可简化高可用性和灾难恢复解决方案。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-121">**High availability and disaster recovery benefits:** Using SQL Server Data Files in Azure feature might simplify the high availability and disaster recovery solutions.</span></span> <span data-ttu-id="1d5e6-122">例如，如果 Azure 中的虚拟机或 SQL Server 的实例发生故障，则可以通过只重新建立指向 Azure Blob 的链接，在新计算机中重新创建数据库。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-122">For example, if a virtual machine in Azure or an instance of SQL Server crashes, you can re-create your databases in a new machine by just re-establishing links to Azure Blobs.</span></span>  
  
-   <span data-ttu-id="1d5e6-123">**安全性优势：** 通过此新增强功能可将计算实例与存储实例分离。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-123">**Security benefits:** This new enhancement allows you to separate a compute instance from a storage instance.</span></span> <span data-ttu-id="1d5e6-124">您可以仅在计算实例而不在存储实例中对完全加密的数据库进行解密。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-124">You can have a fully encrypted database with decryption only occurring on compute instance but not in a storage instance.</span></span> <span data-ttu-id="1d5e6-125">换句话说，使用此新增强功能，您可以使用透明数据加密 (TDE) 证书（此证书与数据在物理上是分离的）来加密在公共云中的所有数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-125">In other words, using this new enhancement, you can encrypt all data in public cloud using Transparent Data Encryption (TDE)  certificates, which are physically separated from the data.</span></span> <span data-ttu-id="1d5e6-126">TDE 密钥可存储在主数据库中，该数据库存储在物理上安全的本地计算机中，并在本地备份。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-126">The TDE keys can be stored in the master database, which is stored locally in your physically secure on-premises machine and backed up locally.</span></span> <span data-ttu-id="1d5e6-127">你可以使用这些本地密钥来加密驻留在 Azure 存储中的数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-127">You can use these local keys to encrypt the data, which resides in Azure Storage.</span></span> <span data-ttu-id="1d5e6-128">即使您的云存储帐户凭据被盗，数据仍然安全，因为 TDE 证书始终驻留在本地。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-128">If your cloud storage account credentials are stolen, your data still stays secure as the TDE certificates always reside in on-premises.</span></span>  
  
## <a name="concepts-and-requirements"></a><span data-ttu-id="1d5e6-129">概念和要求</span><span class="sxs-lookup"><span data-stu-id="1d5e6-129">Concepts and Requirements</span></span>  
  
### <a name="azure-storage-concepts"></a><span data-ttu-id="1d5e6-130">Azure 存储概念</span><span class="sxs-lookup"><span data-stu-id="1d5e6-130">Azure Storage Concepts</span></span>  
 <span data-ttu-id="1d5e6-131">使用“Azure 中的 SQL Server 数据文件”功能时，需要在 Azure 中创建一个存储帐户和一个容器。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-131">When using SQL Server Data Files in Azure feature, you need to create a storage account and a container in Azure.</span></span> <span data-ttu-id="1d5e6-132">然后，需要创建一个 SQL Server 凭据，其中包括有关容器策略的信息以及访问容器所需的共享访问签名。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-132">Then, you need to create a SQL Server credential, which includes information on the policy of the container as well as a shared access signature that is necessary to access the container.</span></span>  
  
 <span data-ttu-id="1d5e6-133">在 Azure 中，存储帐户表示用于访问 Blob 的最高级别的命名空间。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-133">In Azure, a storage account represents the highest level of the namespace for accessing Blobs.</span></span> <span data-ttu-id="1d5e6-134">一个存储帐户可含有无限数量的容器，前提是总大小在 500 TB 以内。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-134">A storage account can contain an unlimited number of containers, as long as their total size is under 500 TB.</span></span> <span data-ttu-id="1d5e6-135">有关存储限制的最新信息，请参阅 [Azure 订阅与服务限制、配额和约束](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-135">For the latest information on storage limits, see [Azure Subscription and Service Limits, Quotas, and Constraints](https://azure.microsoft.com/documentation/articles/azure-subscription-service-limits/).</span></span> <span data-ttu-id="1d5e6-136">容器提供一组 Blob 集。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-136">A container provides a grouping of a set of Blobs.</span></span> <span data-ttu-id="1d5e6-137">所有 Blob 必须都在一个容器中。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-137">All Blobs must be in a container.</span></span> <span data-ttu-id="1d5e6-138">一个帐户可以包含无限数量的容器。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-138">An account can contain an unlimited number of containers.</span></span> <span data-ttu-id="1d5e6-139">同样，一个容器可以存储无限数量的 Blob。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-139">Similarly, a container can store an unlimited number of Blobs as well.</span></span> <span data-ttu-id="1d5e6-140">可将两类 Blob 存储到 Azure 存储中：块 Blob 和页 Blob。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-140">There are two types of blobs that can be stored in Azure Storage: block and page blobs.</span></span> <span data-ttu-id="1d5e6-141">这一新功能使用页 Blob，页 Blob 最大可到 1 TB，当文件字节数经常修改时更为高效。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-141">This new feature uses Page blobs, which can be up to 1TB in size, and are more efficient when ranges of bytes in a file are modified frequently.</span></span> <span data-ttu-id="1d5e6-142">你可以使用以下 URL 格式访问 Blob： `http://storageaccount.blob.core.windows.net/<container>/<blob>`。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-142">You can access Blobs using the following URL format: `http://storageaccount.blob.core.windows.net/<container>/<blob>`.</span></span>  
  
### <a name="azure-billing-considerations"></a><span data-ttu-id="1d5e6-143">Azure 计费注意事项</span><span class="sxs-lookup"><span data-stu-id="1d5e6-143">Azure Billing Considerations</span></span>  
 <span data-ttu-id="1d5e6-144">在决策制定和规划过程中，估计使用 Azure 服务的成本是一项非常重要的工作。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-144">Estimating the cost of using Azure Services is an important matter in the decision making and planning process.</span></span> <span data-ttu-id="1d5e6-145">在 Azure 存储中存储 SQL Server 数据文件时，需要支付与存储和事务相关的成本。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-145">When storing SQL Server data files in Azure Storage, you need to pay costs associated with storage and transactions.</span></span> <span data-ttu-id="1d5e6-146">此外，要实现“Azure 存储中的 SQL Server 数据文件”功能，需要每 45 到 60 秒隐式进行一次 Blob 续租。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-146">In addition, the implementation of SQL Server Data Files in Azure Storage feature requires a renewal of Blob lease every 45 to 60 seconds implicitly.</span></span> <span data-ttu-id="1d5e6-147">这也会对每个数据库文件（如 .mdf 或 .ldf）造成事务成本。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-147">This also results in transaction costs per database file, such as .mdf or .ldf.</span></span> <span data-ttu-id="1d5e6-148">根据我们的估计，基于当前定价模型，两个数据库文件（.mdf 和 .ldf）的续租成本大约为每个月 2 美分。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-148">Based on our estimations, the cost of renewing leases for two database files (.mdf and .ldf) would be about 2 cents per month according to the current pricing model.</span></span> <span data-ttu-id="1d5e6-149">建议使用 [Azure 定价](https://azure.microsoft.com/pricing/) 页面上的信息来帮助估计每月与使用 Azure 存储和 Azure 虚拟机相关的成本。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-149">We recommend that you use the information on the [Azure Pricing](https://azure.microsoft.com/pricing/) page to help estimate the monthly costs associated with the use of Azure Storage and Azure Virtual Machines.</span></span>  
  
### <a name="sql-server-concepts"></a><span data-ttu-id="1d5e6-150">SQL 服务器概念</span><span class="sxs-lookup"><span data-stu-id="1d5e6-150">SQL Server Concepts</span></span>  
 <span data-ttu-id="1d5e6-151">使用此新增强功能时，需要执行以下操作：</span><span class="sxs-lookup"><span data-stu-id="1d5e6-151">When using this new enhancement, you are required to do the followings:</span></span>  
  
-   <span data-ttu-id="1d5e6-152">必须创建容器策略并生成共享访问签名 (SAS) 密钥。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-152">You must create a policy on a container and also generate a shared access signature (SAS) key.</span></span>  
  
-   <span data-ttu-id="1d5e6-153">对于数据或日志文件使用的每个容器，都必须创建名称与容器路径匹配的 SQL Server 凭据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-153">For each container used by a data or a log file, you must create a SQL Server Credential whose name matches the container path.</span></span>  
  
-   <span data-ttu-id="1d5e6-154">必须在 SQL Server 凭据存储中存储有关 Azure 存储容器、其关联策略名称以及 SAS 密钥的信息。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-154">You must store the information regarding Azure Storage container, its associated policy name, and SAS key in the SQL Server credential store.</span></span>  
  
 <span data-ttu-id="1d5e6-155">下面的示例假定已创建了一个 Azure 存储容器，并且已创建了具有读取、写入、列出权限的策略。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-155">The following example assumes that an Azure Storage container has been created, and a policy has been created with read, write, list, rights.</span></span> <span data-ttu-id="1d5e6-156">创建容器策略会生成一个 SAS 密钥，它以未加密状态安全存储在内存中，SQL Server 需要使用它来访问容器中的 Blob 文件。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-156">Creating a policy on a container generates a SAS key which is safe to keep unencrypted in memory and needed by SQL Server to access the blob files in the container.</span></span> <span data-ttu-id="1d5e6-157">在下面的代码段中，将 `'your SAS key'` 替换为类似于以下内容的项： `'sr=c&si=<MYPOLICYNAME>&sig=<THESHAREDACCESSSIGNATURE>'`。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-157">In the following code snippet, replace `'your SAS key'` with an entry similar to the following: `'sr=c&si=<MYPOLICYNAME>&sig=<THESHAREDACCESSSIGNATURE>'`.</span></span> <span data-ttu-id="1d5e6-158">有关详细信息，请参阅[创建和使用共享访问签名](https://msdn.microsoft.com/library/azure/jj721951.aspx)</span><span class="sxs-lookup"><span data-stu-id="1d5e6-158">For more information, see [Create and Use a Shared Access Signature](https://msdn.microsoft.com/library/azure/jj721951.aspx)</span></span>  
  
```sql
-- Create a credential  
CREATE CREDENTIAL [https://testdb.blob.core.windows.net/data]  
WITH IDENTITY='SHARED ACCESS SIGNATURE',  
SECRET = 'your SAS key'  
  
-- Create database with data and log files in Azure container.  
CREATE DATABASE testdb   
ON  
( NAME = testdb_dat,  
    FILENAME = 'https://testdb.blob.core.windows.net/data/TestData.mdf' )  
 LOG ON  
( NAME = testdb_log,  
    FILENAME =  'https://testdb.blob.core.windows.net/data/TestLog.ldf')
```  
  
> [!IMPORTANT]
> <span data-ttu-id="1d5e6-159">如果当前存在任何对容器中数据文件的引用，则尝试删除相应的 SQL Server 凭据会失败。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-159">If there are any active references to data files in a container, attempts to delete the corresponding SQL Server credential fails.</span></span>  
  
### <a name="security"></a><span data-ttu-id="1d5e6-160">安全性</span><span class="sxs-lookup"><span data-stu-id="1d5e6-160">Security</span></span>  
 <span data-ttu-id="1d5e6-161">以下是在 Azure 存储中存储 SQL Server 数据文件时的安全注意事项和要求。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-161">The following are security considerations and requirements when storing SQL Server Data Files in Azure Storage.</span></span>  
  
-   <span data-ttu-id="1d5e6-162">为 Azure Blob 存储服务创建容器时，建议将访问权限设置为“私有”。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-162">When creating a container for the Azure Blob storage service, we recommend that you set the access to private.</span></span> <span data-ttu-id="1d5e6-163">将访问权限设置为“私有”后，只有 Azure 帐户所有者才可读取容器和 Blob 数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-163">When you set the access to private, container and blob data can be read by the Azure account owner only.</span></span>  
  
-   <span data-ttu-id="1d5e6-164">在 Azure 存储中存储 SQL Server 数据库文件时，需要使用共享访问签名，它是授予对容器、Blob、队列和表的受限访问权限的 URI。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-164">When storing SQL Server database files in Azure Storage, you need to use a shared access signature, a URI that grants restricted access rights to containers, blobs, queues, and tables.</span></span> <span data-ttu-id="1d5e6-165">通过使用共享访问签名，可以让 SQL Server 在不共享 Azure 存储帐户密钥的情况下访问存储帐户中的资源。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-165">By using a shared access signature, you can enable SQL Server to access resources in your storage account without sharing your Azure storage account key.</span></span>  
  
-   <span data-ttu-id="1d5e6-166">此外，建议对数据库继续实施传统的本地安全做法。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-166">In addition, we recommend that you continue implementing the traditional on-premises security practices for your databases.</span></span>  
  
### <a name="installation-prerequisites"></a><span data-ttu-id="1d5e6-167">安装先决条件</span><span class="sxs-lookup"><span data-stu-id="1d5e6-167">Installation Prerequisites</span></span>  
 <span data-ttu-id="1d5e6-168">下面是在 Azure 中存储 SQL Server 数据文件时的安装先决条件。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-168">The followings are installation prerequisites when storing SQL Server Data Files in Azuree.</span></span>  
  
-   <span data-ttu-id="1d5e6-169">**本地 SQL Server：** SQL Server 2014 版本包括此功能。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-169">**SQL Server on-premises:** SQL Server 2014 version includes this feature.</span></span> <span data-ttu-id="1d5e6-170">要了解如何下载 SQL Server 2014，请参阅 [SQL Server 2014](https://www.microsoft.com/sqlserver/sql-server-2014.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-170">To learn how to download SQL Server 2014, see [SQL Server 2014](https://www.microsoft.com/sqlserver/sql-server-2014.aspx).</span></span>  
  
-   <span data-ttu-id="1d5e6-171">在 Azure 虚拟机中运行的 SQL Server：如果要在 Azure 虚拟机上安装 SQL Server，请安装 SQL Server 2014 或更新现有实例。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-171">SQL Server running in an Azure virtual machine: If you are installing SQL Server on an Azure Virtual Machine, install SQL Server 2014, or update your existing instance.</span></span> <span data-ttu-id="1d5e6-172">同样，还可以使用 SQL Server 2014 平台映像在 Azure 中创建新的虚拟机。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-172">Similarly, you can also create a new virtual machine in Azure using SQL Server 2014 platform image.</span></span> <span data-ttu-id="1d5e6-173">要了解如何下载 SQL Server 2014，请参阅 [SQL Server 2014](https://www.microsoft.com/sqlserver/sql-server-2014.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-173">To learn how to download SQL Server 2014, see [SQL Server 2014](https://www.microsoft.com/sqlserver/sql-server-2014.aspx).</span></span>  
  
###  <a name="limitations"></a><a name="bkmk_Limitations"></a> <span data-ttu-id="1d5e6-174">限制</span><span class="sxs-lookup"><span data-stu-id="1d5e6-174">Limitations</span></span>  
  
-   <span data-ttu-id="1d5e6-175">在此功能的当前版本中， `FileStream` 不支持在 Azure 存储中存储数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-175">In the current release of this feature, storing `FileStream` data in Azure Storage is not supported.</span></span> <span data-ttu-id="1d5e6-176">你可以 `Filestream` 在 Azure 存储集成的本地数据库中存储数据，但不能使用 Azure 存储在计算机之间移动 Filestream 数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-176">You can store `Filestream` data in an Azure Storage integrated local database but you cannot move Filestream data between machines using Azure Storage.</span></span> <span data-ttu-id="1d5e6-177">对于 `FileStream` 数据，建议继续使用传统方法在不同计算机之间移动与 Filestream 关联的文件（.mdf，.ldf）。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-177">For `FileStream` data, we recommend that you continue using the traditional techniques to move the files (.mdf, .ldf) associated with Filestream between different machines.</span></span>  
  
-   <span data-ttu-id="1d5e6-178">目前，此新增强功能不支持多个 SQL Server 实例同时访问 Azure 存储中的相同数据库文件。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-178">Currently, this new enhancement does not support more than one SQL Server instance accessing the same database files in Azure Storage at the same time.</span></span> <span data-ttu-id="1d5e6-179">如果 ServerA 处于联机状态并且包含一个活动数据库文件，ServerB 意外启动并且也包含一个指向相同数据文件的数据库，则第二个服务器将无法启动该数据库，并显示错误代码 5120，指示无法打开物理文件“%.ls”\* **。操作系统错误 %d：“%ls”** 。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-179">If ServerA is online with an active database file and if ServerB is accidentally started, and it also has a database which points to the same data file, the second server will fail to start the database with an error code **5120 Unable to open the physical file "%.\*ls". Operating system error %d: "%ls"**.</span></span>  
  
-   <span data-ttu-id="1d5e6-180">只有 .mdf、.ldf 和 .ndf 文件才可以通过使用 Azure 功能中的 SQL Server 数据文件存储在 Azure 存储中。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-180">Only .mdf, .ldf, and .ndf files can be stored in Azure Storage by using the SQL Server Data Files in Azure feature.</span></span>  
  
-   <span data-ttu-id="1d5e6-181">使用“Azure 中的 SQL Server 数据文件”功能时，存储帐户不支持异地复制。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-181">When using the SQL Server Data Files in Azure feature, geo-replication for your storage account is not supported.</span></span> <span data-ttu-id="1d5e6-182">如果对存储帐户进行地理复制并发生地理故障转移，则可能出现数据库损坏。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-182">If a storage account is geo-replicated and a geo-failover happened, database corruption could occur.</span></span>  
  
-   <span data-ttu-id="1d5e6-183">每个 Blob 最大可为 1 TB。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-183">Each Blob can be up to maximum 1 TB in size.</span></span> <span data-ttu-id="1d5e6-184">这就对可存储在 Azure 存储中的单个数据库的数据和日志文件设定了一个上限。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-184">This creates an upper limit on individual database data and log files that can be stored in Azure Storage.</span></span>  
  
-   <span data-ttu-id="1d5e6-185">无法使用“Azure 存储中的 SQL Server 数据文件”功能在 Azure Blob 中存储内存 OLTP 数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-185">It is not possible to store In-Memory OLTP data in Azure Blob using the SQL Server Data Files in Azure Storage feature.</span></span> <span data-ttu-id="1d5e6-186">这是因为内存中 OLTP 依赖于 `FileStream` 和，在此功能的当前版本中， `FileStream` 不支持在 Azure 存储中存储数据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-186">This is because In-Memory OLTP has a dependency on `FileStream` and, in the current release of this feature, storing `FileStream` data in Azure Storage is not supported.</span></span>  
  
-   <span data-ttu-id="1d5e6-187">使用 Azure 功能中的 SQL Server 数据文件时，SQL Server 使用数据库中的排序规则集执行所有 URL 或文件路径比较 `master` 。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-187">When using SQL Server Data Files in Azure feature, SQL Server performs all URL or file path comparisons using the Collation set in the `master` database.</span></span>  
  
-   <span data-ttu-id="1d5e6-188">只要不在主数据库中添加新数据库文件，就支持 `AlwaysOn Availability Groups`。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-188">`AlwaysOn Availability Groups` are supported as long as you do not add new database files to the primary database.</span></span> <span data-ttu-id="1d5e6-189">如果某个数据库操作需要在主数据库中创建新文件，请首先在辅助节点上禁用 AlwaysOn 可用性组。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-189">If a database operation requires a new file to be created in the primary database, first disable AlwaysOn Availability Groups in the secondary node.</span></span> <span data-ttu-id="1d5e6-190">然后对主数据库执行该数据库操作，并在主节点中备份该数据库。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-190">Then, perform the database operation on the primary database and backup the database in the primary node.</span></span> <span data-ttu-id="1d5e6-191">接下来，将数据库还原到辅助节点，并在辅助节点上启用 AlwaysOn 可用性组。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-191">Next, restore the database to the secondary node, and enable AlwaysOn Availability Groups in the secondary node.</span></span> <span data-ttu-id="1d5e6-192">请注意，使用 Azure 功能中的 SQL Server 数据文件时，不支持 AlwaysOn 故障转移群集实例。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-192">Note that AlwaysOn Failover Cluster Instances is not supported when using the SQL Server Data Files in Azure feature.</span></span>  
  
-   <span data-ttu-id="1d5e6-193">在正常操作期间，SQL Server 使用临时租约来保留用于存储的 Blob，并且每 45 到 60 秒续租每个 Blob。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-193">During normal operation, SQL Server uses temporary leases to reserve Blobs for storage with a renewal of each Blob lease every 45 to 60 seconds.</span></span> <span data-ttu-id="1d5e6-194">如果服务器崩溃，启动另一个配置为使用相同 Blob 的 SQL Server 实例，则新实例将等待 60 秒，以待现有 Blob 租约过期。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-194">If a server crashes and another instance of SQL Server configured to use the same blobs is started, the new instance will wait up to 60 seconds for the existing lease on the Blob to expire.</span></span> <span data-ttu-id="1d5e6-195">如果要将数据库附加到另一个实例，又无法在 60 秒内等待租约过期，则可显式中断 Blob 租约，以免执行附加操作时发生任何故障。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-195">If you want to attach the database to another instance and you cannot wait for the lease to expire within 60 seconds, you can explicitly break the lease on the Blob to avoid any failures in attach operations.</span></span>  
  
## <a name="tools-and-programming-reference-support"></a><span data-ttu-id="1d5e6-196">工具和编程参考支持</span><span class="sxs-lookup"><span data-stu-id="1d5e6-196">Tools and programming reference support</span></span>  
 <span data-ttu-id="1d5e6-197">本节介绍在 Azure 存储中存储 SQL Server 数据文件时可使用的工具和编程参考库。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-197">This section describes which tools and programming reference libraries can be used when storing SQL Server data files in Azure Storage.</span></span>  
  
### <a name="powershell-support"></a><span data-ttu-id="1d5e6-198">PowerShell 支持</span><span class="sxs-lookup"><span data-stu-id="1d5e6-198">PowerShell support</span></span>  
 <span data-ttu-id="1d5e6-199">在 SQL Server 2014 中，通过引用 Blob 存储 URL 路径而不是文件路径，可以使用 PowerShell cmdlet 将 SQL Server 的数据文件存储在 Azure Blob 存储服务中。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-199">In SQL Server 2014, you can use PowerShell cmdlets to store SQL Server data files in Azure Blob Storage service by referencing a Blob Storage URL path instead of a file path.</span></span> <span data-ttu-id="1d5e6-200">您可以使用以下 URL 格式访问 Blob`: http://storageaccount.blob.core.windows.net/<container>/<blob>` 。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-200">You can access Blobs using the following URL format`: http://storageaccount.blob.core.windows.net/<container>/<blob>` .</span></span>  
  
### <a name="sql-server-object-and-performance-counters-support"></a><span data-ttu-id="1d5e6-201">SQL Server 对象和性能计数器支持</span><span class="sxs-lookup"><span data-stu-id="1d5e6-201">SQL Server Object and performance counters support</span></span>  
 <span data-ttu-id="1d5e6-202">从 SQL Server 2014 起，增加了一个与“Azure 存储中的 SQL Server 数据文件”功能结合使用的新 SQL Server 对象。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-202">Starting with SQL Server 2014, a new SQL Server object has been added to be used with SQL Server Data Files in Azure Storage feature.</span></span> <span data-ttu-id="1d5e6-203">这个新的 SQL Server 对象称为 [SQL Server, HTTP_STORAGE_OBJECT](../performance-monitor/sql-server-http-storage-object.md)。系统监视器可使用它在用 Azure 存储运行 SQL Server 时监视活动。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-203">The new SQL Server object is called as [SQL Server, HTTP_STORAGE_OBJECT](../performance-monitor/sql-server-http-storage-object.md) and it can be used by System Monitor to monitor activity when running SQL Server with Azure Storage.</span></span>  
  
### <a name="sql-server-management-studio-support"></a><span data-ttu-id="1d5e6-204">SQL Server Management Studio 支持</span><span class="sxs-lookup"><span data-stu-id="1d5e6-204">SQL Server Management Studio support</span></span>  
 <span data-ttu-id="1d5e6-205">使用 SQL Server Management Studio 时，您可通过多个对话框窗口使用此功能。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-205">SQL Server Management Studio allows you to use this feature via several dialog windows.</span></span> <span data-ttu-id="1d5e6-206">例如，您可以在几个对话框窗口（如“新建数据库” `https://teststorageaccnt.blob.core.windows.net/testcontainer/` 、 **“附加数据库”** 和 **“还原数据库”**）中的 **“路径”** 中键入存储容器的 URL 路径（如 \*\*\*\*）。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-206">For example, you can type the URL path of the storage container, such as `https://teststorageaccnt.blob.core.windows.net/testcontainer/` as a **Path** in several dialog windows, such as **New Database**, **Attach Database**, and **Restore Database**.</span></span> <span data-ttu-id="1d5e6-207">有关详细信息，请参阅[教程：在 Azure 存储服务中 SQL Server 数据文件](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-207">For more information, see [Tutorial: SQL Server Data Files in Azure Storage service](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).</span></span>  
  
### <a name="sql-server-management-objects-support"></a><span data-ttu-id="1d5e6-208">SQL Server 管理对象支持</span><span class="sxs-lookup"><span data-stu-id="1d5e6-208">SQL Server Management Objects support</span></span>  
 <span data-ttu-id="1d5e6-209">使用“Azure 中的 SQL Server 数据文件”功能时，支持所有 SQL Server 管理对象 (SMO)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-209">When using the SQL Server Data Files in Azure feature, all SQL Server Management Objects (SMO) are supported.</span></span> <span data-ttu-id="1d5e6-210">如果 SMO 对象需要文件路径，请使用 BLOB URL 格式而不是本地文件路径，如 `https://teststorageaccnt.blob.core.windows.net/testcontainer/`。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-210">If an SMO object requires a file path, use the BLOB URL format instead of a local file path, such as `https://teststorageaccnt.blob.core.windows.net/testcontainer/`.</span></span> <span data-ttu-id="1d5e6-211">有关 SQL Server 管理对象的详细信息，请参阅 SQL Server 联机丛书中的 [SQL Server 管理对象 (SMO) 编程指南](../server-management-objects-smo/sql-server-management-objects-smo-programming-guide.md)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-211">For more information about SQL Server Management Objects (SMO), see [SQL Server Management Objects &#40;SMO&#41; Programming Guide](../server-management-objects-smo/sql-server-management-objects-smo-programming-guide.md) in SQL Server Books Online.</span></span>  
  
### <a name="transact-sql-support"></a><span data-ttu-id="1d5e6-212">Transact-SQL 支持</span><span class="sxs-lookup"><span data-stu-id="1d5e6-212">Transact-SQL support</span></span>  
 <span data-ttu-id="1d5e6-213">此新功能在 Transact-SQL 外围应用中引入了以下更改：</span><span class="sxs-lookup"><span data-stu-id="1d5e6-213">This new feature has introduced the following change in the Transact-SQL surface area:</span></span>  
  
-   <span data-ttu-id="1d5e6-214">**sys.master_files** 系统视图中新增一个 **int**列，即 **credential_id** 。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-214">A new **int** column, **credential_id**, in the **sys.master_files** system view.</span></span> <span data-ttu-id="1d5e6-215">**credential_id** 列用于实现将支持 Azure 存储的数据文件交叉引用回为其创建的凭据的 sys.credentials。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-215">The **credential_id** column is used to enable Azure Storage enabled data files to be cross-referenced back to sys.credentials for the credentials created for them.</span></span> <span data-ttu-id="1d5e6-216">您可以使用它来排除故障，如当有数据库文件使用凭据时无法删除凭据。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-216">You can use it for troubleshooting, such as a credential cannot be deleted when there is a database file which uses it.</span></span>  
  
##  <a name="troubleshooting-for-sql-server-data-files-in-azure"></a><a name="bkmk_Troubleshooting"></a><span data-ttu-id="1d5e6-217">排查 Azure 中的 SQL Server 数据文件问题</span><span class="sxs-lookup"><span data-stu-id="1d5e6-217">Troubleshooting for SQL Server Data Files in Azure</span></span>  
 <span data-ttu-id="1d5e6-218">为避免不受支持的功能或限制造成的错误，首先请查看 [Limitations](sql-server-data-files-in-microsoft-azure.md#bkmk_Limitations)。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-218">To avoid errors due to unsupported features or limitations, first review [Limitations](sql-server-data-files-in-microsoft-azure.md#bkmk_Limitations).</span></span>  
  
 <span data-ttu-id="1d5e6-219">下面列出了使用“Azure 存储中的 SQL Server 数据文件”功能时可能遇到的错误。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-219">The list of errors that you might get when using the SQL Server Data Files in Azure Storage feature are as follows.</span></span>  
  
 <span data-ttu-id="1d5e6-220">**身份验证错误**</span><span class="sxs-lookup"><span data-stu-id="1d5e6-220">**Authentication errors**</span></span>  
  
-   <span data-ttu-id="1d5e6-221">*凭据 '%.\*ls' 被某活动数据库文件使用，因此无法删除它。*  </span><span class="sxs-lookup"><span data-stu-id="1d5e6-221">*Cannot drop the credential '%.\*ls' because it is used by an active database file.* </span></span>  
    <span data-ttu-id="1d5e6-222">解决方法：尝试删除 Azure 存储中活动数据库文件仍在使用的凭据时，可能会看到此错误。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-222">Resolution: You may see this error when you try to drop a credential that is still being used by an active database file in Azure Storage.</span></span> <span data-ttu-id="1d5e6-223">要删除凭据，必须先删除拥有此数据库文件的关联 Blob。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-223">To drop the credential, first you must delete the associated blob that has this database file.</span></span> <span data-ttu-id="1d5e6-224">要删除具有活动租约的 Blob，必须先中断租约。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-224">To delete a blob that has an active lease, you must first break the lease.</span></span>  
  
-   <span data-ttu-id="1d5e6-225">*未在容器上正确创建共享访问签名。*  </span><span class="sxs-lookup"><span data-stu-id="1d5e6-225">*Shared Access Signature has not been created on the container correctly.* </span></span>  
     <span data-ttu-id="1d5e6-226">解决方法：确保已在容器上正确创建了共享访问签名。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-226">Resolution: Make sure that you have created a Shared Access Signature on the container correctly.</span></span> <span data-ttu-id="1d5e6-227">查看[教程： SQL Server Azure 存储服务中的数据文件](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)中的第2课中提供的说明。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-227">Review the instructions given in Lesson 2 in [Tutorial: SQL Server Data Files in Azure Storage service](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).</span></span>  
  
-   <span data-ttu-id="1d5e6-228">*尚未正确创建 SQL Server 凭据。*  </span><span class="sxs-lookup"><span data-stu-id="1d5e6-228">*SQL Server credential has not been not created correctly.* </span></span>  
    <span data-ttu-id="1d5e6-229">解决方法：确保已对“标识”字段使用了“共享访问签名”，并正确创建了机密。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-229">Resolution: Make sure that you have used 'Shared Access Signature' for the **Identity** field and created a secret correctly.</span></span> <span data-ttu-id="1d5e6-230">查看[教程： SQL Server Azure 存储服务中的数据文件](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)中的第3课中提供的说明。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-230">Review the instructions given in Lesson 3 in [Tutorial: SQL Server Data Files in Azure Storage service](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).</span></span>  
  
 <span data-ttu-id="1d5e6-231">**租赁 Blob 错误：**</span><span class="sxs-lookup"><span data-stu-id="1d5e6-231">**Lease blob errors:**</span></span>  
  
-   <span data-ttu-id="1d5e6-232">在使用相同 Blob 文件的 SQL Server 实例崩溃之后，尝试启动另一个 SQL Server 时发生错误。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-232">Error when trying to start SQL Server after another instance using the same blob files has crashed.</span></span> <span data-ttu-id="1d5e6-233">解决方案：在正常操作期间，SQL Server 使用临时租约来保留用于存储的 Blob，并且每 45 到 60 秒续租每个 Blob。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-233">Resolution: During normal operation, SQL Server uses temporary leases to reserve Blobs for storage with a renewal of each Blob lease every 45 to 60 seconds.</span></span> <span data-ttu-id="1d5e6-234">如果服务器崩溃，启动另一个配置为使用相同 Blob 的 SQL Server 实例，则新实例将等待 60 秒，以待现有 Blob 租约过期。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-234">If a server crashes and another instance of SQL Server configured to use the same blobs is started, the new instance will wait up to 60 seconds for the existing lease on the Blob to expire.</span></span> <span data-ttu-id="1d5e6-235">如果要将数据库附加到另一个实例，又无法在 60 秒内等待租约过期，则可显式中断 Blob 租约，以免执行附加操作时发生任何故障。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-235">If you want to attach the database to another instance and you cannot wait for the lease to expire within 60 seconds, you can explicitly break the lease on the Blob to avoid any failures in attach operations.</span></span>  
  
 <span data-ttu-id="1d5e6-236">**数据库错误**</span><span class="sxs-lookup"><span data-stu-id="1d5e6-236">**Database errors**</span></span>  
  
1.  <span data-ttu-id="1d5e6-237">*创建数据库时出错* </span><span class="sxs-lookup"><span data-stu-id="1d5e6-237">*Errors when creating a database* </span></span>  
    <span data-ttu-id="1d5e6-238">解决方法：查看[教程： SQL Server Azure 存储服务中的数据文件](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)中的第4课中提供的说明。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-238">Resolution: Review the instructions given in Lesson 4 in [Tutorial: SQL Server Data Files in Azure Storage service](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).</span></span>  
  
2.  <span data-ttu-id="1d5e6-239">*运行 Alter 语句时出错* </span><span class="sxs-lookup"><span data-stu-id="1d5e6-239">*Errors when running the Alter statement* </span></span>  
    <span data-ttu-id="1d5e6-240">解决方法：确保在数据库联机时执行 Alter Database 语句。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-240">Resolution: Make sure to execute the Alter Database statement when the database is online.</span></span> <span data-ttu-id="1d5e6-241">将数据文件复制到 Azure 存储时，始终创建页 Blob 而不是块 Blob。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-241">When copying the data files to Azure Storage, always create a page blob not a block blob.</span></span> <span data-ttu-id="1d5e6-242">否则，ALTER Database 将失败。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-242">Otherwise, ALTER Database will fail.</span></span> <span data-ttu-id="1d5e6-243">查看[教程：在 Azure 存储服务中 SQL Server 数据文件](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)中第7课中提供的说明。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-243">Review the instructions given in Lesson 7 in [Tutorial: SQL Server Data Files in Azure Storage service](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md).</span></span>  
  
3.  <span data-ttu-id="1d5e6-244">*错误代码5120无法打开物理文件 "%. \*ls "。操作系统错误% d： "% ls"* </span><span class="sxs-lookup"><span data-stu-id="1d5e6-244">*Error code 5120 Unable to open the physical file "%.\*ls". Operating system error %d: "%ls"* </span></span>  
    <span data-ttu-id="1d5e6-245">解决方法：目前，此新增强功能不支持多个 SQL Server 实例同时访问 Azure 存储中的相同数据库文件。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-245">Resolution: Currently, this new enhancement does not support more than one SQL Server instance accessing the same database files in Azure Storage at the same time.</span></span> <span data-ttu-id="1d5e6-246">如果 ServerA 处于联机状态并且包含一个活动数据库文件，ServerB 意外启动并且也包含一个指向相同数据文件的数据库，则第二个服务器将无法启动该数据库，并显示错误代码 5120，指示无法打开物理文件“%.ls”\* *。操作系统错误 %d：“%ls”* 。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-246">If ServerA is online with an active database file and if ServerB is accidentally started, and it also has a database which points to the same data file, the second server will fail to start the database with an error *code 5120 Unable to open the physical file "%.\*ls". Operating system error %d: "%ls"*.</span></span>  
  
     <span data-ttu-id="1d5e6-247">要解决此问题，首先需要确定是否需要 ServerA 访问 Azure 存储中的数据库文件。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-247">To resolve this issue, first determine if you need ServerA to access the database file in Azure Storage or not.</span></span> <span data-ttu-id="1d5e6-248">如果不需要，只需删除 ServerA 与 Azure 存储中数据库文件之间的任何连接。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-248">If not, simply remove any connection between ServerA and the database files in Azure Storage.</span></span> <span data-ttu-id="1d5e6-249">为此，请按照下列步骤进行操作：</span><span class="sxs-lookup"><span data-stu-id="1d5e6-249">To do this, follow these steps:</span></span>  
  
    1.  <span data-ttu-id="1d5e6-250">使用 ALTER Database 语句将 ServerA 的文件路径设置为本地文件夹。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-250">Set the file path of Server A to a local folder by using the ALTER Database statement.</span></span>  
  
    2.  <span data-ttu-id="1d5e6-251">在 ServerA 中将数据库设置为脱机状态。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-251">Set the database offline in Server A.</span></span>  
  
    3.  <span data-ttu-id="1d5e6-252">然后，将数据库文件从 Azure 存储复制到 Server A 中的本地文件夹。这可确保 ServerA 仍有一个本地数据库副本。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-252">Then, copy database files from Azure Storage to the local folder in Server A. This ensures that ServerA still has a copy of the database locally.</span></span>  
  
    4.  <span data-ttu-id="1d5e6-253">将数据库设置为联机状态。</span><span class="sxs-lookup"><span data-stu-id="1d5e6-253">Set the database online.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1d5e6-254">另请参阅</span><span class="sxs-lookup"><span data-stu-id="1d5e6-254">See Also</span></span>  
 [<span data-ttu-id="1d5e6-255">教程：Azure 存储服务中的 SQL Server 数据文件</span><span class="sxs-lookup"><span data-stu-id="1d5e6-255">Tutorial: SQL Server Data Files in Azure Storage service</span></span>](../tutorial-use-azure-blob-storage-service-with-sql-server-2016.md)  

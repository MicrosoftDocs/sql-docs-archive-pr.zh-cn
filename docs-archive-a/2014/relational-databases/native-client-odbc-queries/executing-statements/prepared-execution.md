---
title: 已准备好的执行 |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- deferred statement preparation
- prepared execution [ODBC]
- SQLPrepare function
- ODBC applications, statements
- SQLExecute function
- statements [ODBC], prepared execution
ms.assetid: f3a9d32b-6cd7-4f0c-b38d-c8ccc4ee40c3
author: rothja
ms.author: jroth
ms.openlocfilehash: 33ab9f35cd9d3eaf04e688a89390b5eb3f00ae58
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87577600"
---
# <a name="prepared-execution"></a><span data-ttu-id="e4b71-102">准备好的执行</span><span class="sxs-lookup"><span data-stu-id="e4b71-102">Prepared Execution</span></span>
  <span data-ttu-id="e4b71-103">ODBC API 会定义准备好的执行，以此来减少反复执行 [!INCLUDE[tsql](../../../includes/tsql-md.md)] 语句时所需的分析和编译开销。</span><span class="sxs-lookup"><span data-stu-id="e4b71-103">The ODBC API defines prepared execution as a way to reduce the parsing and compiling overhead associated with repeatedly executing a [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement.</span></span> <span data-ttu-id="e4b71-104">该应用程序生成一个包含 SQL 语句的字符串，然后分两个阶段执行该语句。</span><span class="sxs-lookup"><span data-stu-id="e4b71-104">The application builds a character string containing an SQL statement and then executes it in two stages.</span></span> <span data-ttu-id="e4b71-105">它将调用[SQLPrepare 函数](https://go.microsoft.com/fwlink/?LinkId=59360)一次，以将语句分析并编译为执行计划 [!INCLUDE[ssDE](../../../includes/ssde-md.md)] 。</span><span class="sxs-lookup"><span data-stu-id="e4b71-105">It calls [SQLPrepare Function](https://go.microsoft.com/fwlink/?LinkId=59360) once to have the statement parsed and compiled into an execution plan by the [!INCLUDE[ssDE](../../../includes/ssde-md.md)].</span></span> <span data-ttu-id="e4b71-106">然后，它会在每次执行准备好的执行计划时调用**SQLExecute** 。</span><span class="sxs-lookup"><span data-stu-id="e4b71-106">It then calls **SQLExecute** for each execution of the prepared execution plan.</span></span> <span data-ttu-id="e4b71-107">这节省了每次执行的分析和编译开销。</span><span class="sxs-lookup"><span data-stu-id="e4b71-107">This saves the parsing and compiling overhead on each execution.</span></span> <span data-ttu-id="e4b71-108">应用程序通常使用准备好的执行来重复执行相同的参数化 SQL 语句。</span><span class="sxs-lookup"><span data-stu-id="e4b71-108">Prepared execution is commonly used by applications to repeatedly execute the same, parameterized SQL statement.</span></span>  
  
 <span data-ttu-id="e4b71-109">对于多数数据库中的需要执行三次或四次以上的语句，准备好的执行要比直接执行更快速。这主要是因为准备好的执行仅需编译一次语句，而直接执行的语句在每次执行时都需要编译。</span><span class="sxs-lookup"><span data-stu-id="e4b71-109">For most databases, prepared execution is faster than direct execution for statements executed more than three or four times primarily because the statement is compiled only once, while statements executed directly are compiled each time they are executed.</span></span> <span data-ttu-id="e4b71-110">准备好的执行还可以减少网络流量，因为驱动程序在每次执行语句时都可以向数据源发送执行计划标识符及参数值，而不是整个 SQL 语句。</span><span class="sxs-lookup"><span data-stu-id="e4b71-110">Prepared execution can also provide a reduction in network traffic because the driver can send an execution plan identifier and the parameter values, rather than an entire SQL statement, to the data source each time the statement is executed.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]<span data-ttu-id="e4b71-111">通过改进的算法来检测和重复使用**SQLExecDirect**的执行计划，从而减少了直接执行和准备好的执行之间的性能差异。</span><span class="sxs-lookup"><span data-stu-id="e4b71-111">reduces the performance difference between direct and prepared execution through improved algorithms for detecting and reusing execution plans from **SQLExecDirect**.</span></span> <span data-ttu-id="e4b71-112">这使直接执行的语句也具备了准备好的执行的某些性能优势。</span><span class="sxs-lookup"><span data-stu-id="e4b71-112">This makes some of the performance benefits of prepared execution available to statements executed directly.</span></span> <span data-ttu-id="e4b71-113">有关详细信息，请参阅[直接执行](direct-execution.md)。</span><span class="sxs-lookup"><span data-stu-id="e4b71-113">For more information, see [Direct Execution](direct-execution.md).</span></span>  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] <span data-ttu-id="e4b71-114">还提供针对准备好的执行的本机支持。</span><span class="sxs-lookup"><span data-stu-id="e4b71-114">also provides native support for prepared execution.</span></span> <span data-ttu-id="e4b71-115">执行计划建立在**SQLPrepare**上，并在调用**SQLExecute**时执行。</span><span class="sxs-lookup"><span data-stu-id="e4b71-115">An execution plan is built on **SQLPrepare** and later executed when **SQLExecute** is called.</span></span> <span data-ttu-id="e4b71-116">由于在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] **SQLPrepare**上生成临时存储过程不是必需的，因此**tempdb**中的系统表不会产生额外的开销。</span><span class="sxs-lookup"><span data-stu-id="e4b71-116">Because [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is not required to build temporary stored procedures on **SQLPrepare**, there is no extra overhead on the system tables in **tempdb**.</span></span>  
  
 <span data-ttu-id="e4b71-117">出于性能方面的原因，语句准备会推迟到调用**SQLExecute**或元属性操作 (例如，在 ODBC) 中执行[SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md)或[SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md) 。</span><span class="sxs-lookup"><span data-stu-id="e4b71-117">For performance reasons, the statement preparation is deferred until **SQLExecute** is called or a metaproperty operation (such as [SQLDescribeCol](../../native-client-odbc-api/sqldescribecol.md) or [SQLDescribeParam](../../native-client-odbc-api/sqldescribeparam.md) in ODBC) is performed.</span></span> <span data-ttu-id="e4b71-118">此选项为默认行为。</span><span class="sxs-lookup"><span data-stu-id="e4b71-118">This is the default behavior.</span></span> <span data-ttu-id="e4b71-119">正在准备的语句如有任何错误，需等到执行该语句或执行元属性操作后才会发现。</span><span class="sxs-lookup"><span data-stu-id="e4b71-119">Any errors in the statement being prepared are not known until the statement is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="e4b71-120">将 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC 驱动程序特定的语句属性 SQL_SOPT_SS_DEFER_PREPARE 设置为 SQL_DP_OFF 可以关闭此默认行为。</span><span class="sxs-lookup"><span data-stu-id="e4b71-120">Setting the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver-specific statement attribute SQL_SOPT_SS_DEFER_PREPARE to SQL_DP_OFF can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="e4b71-121">在延迟准备的情况下，在调用**SQLExecute**之前调用**SQLDescribeCol**或**SQLDescribeParam**会生成到服务器的额外往返。</span><span class="sxs-lookup"><span data-stu-id="e4b71-121">In case of deferred prepare, calling either **SQLDescribeCol** or **SQLDescribeParam** before calling **SQLExecute** generates an extra roundtrip to the server.</span></span> <span data-ttu-id="e4b71-122">在**SQLDescribeCol**上，驱动程序从查询中删除 WHERE 子句，并将其发送到服务器，并将 FMTONLY 设置为 ON，以获取查询返回的第一个结果集中的列的说明。</span><span class="sxs-lookup"><span data-stu-id="e4b71-122">On **SQLDescribeCol**, the driver removes the WHERE clause from the query and sends it to the server with SET FMTONLY ON to get the description of the columns in the first result set returned by the query.</span></span> <span data-ttu-id="e4b71-123">在**SQLDescribeParam**上，驱动程序调用服务器来获取查询中任何参数标记所引用的表达式或列的说明。</span><span class="sxs-lookup"><span data-stu-id="e4b71-123">On **SQLDescribeParam**, the driver calls the server to get a description of the expressions or columns referenced by any parameter markers in the query.</span></span> <span data-ttu-id="e4b71-124">此方法也存在一些限制，如无法解析子查询中的参数。</span><span class="sxs-lookup"><span data-stu-id="e4b71-124">This method also has some restrictions, such as not being able to resolve parameters in subqueries.</span></span>  
  
 <span data-ttu-id="e4b71-125">与 Native Client ODBC 驱动程序的过度使用**SQLPrepare**会 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 降低性能，尤其是在连接到早期版本的 SQL Server 时。</span><span class="sxs-lookup"><span data-stu-id="e4b71-125">Excess use of **SQLPrepare** with the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Native Client ODBC driver degrades performance, especially when connected to earlier versions of SQL Server.</span></span> <span data-ttu-id="e4b71-126">不应对执行一次的语句使用准备好的执行。</span><span class="sxs-lookup"><span data-stu-id="e4b71-126">Prepared execution should not be used for statements executed a single time.</span></span> <span data-ttu-id="e4b71-127">对于执行一次的语句，准备好的执行要比直接执行慢，因为它需要多进行一次从客户端到服务器的网络往返。</span><span class="sxs-lookup"><span data-stu-id="e4b71-127">Prepared execution is slower than direct execution for a single execution of a statement because it requires an extra network roundtrip from the client to the server.</span></span> <span data-ttu-id="e4b71-128">在早期版本的 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 中，它还生成临时存储过程。</span><span class="sxs-lookup"><span data-stu-id="e4b71-128">On earlier versions of [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] it also generates a temporary stored procedure.</span></span>  
  
 <span data-ttu-id="e4b71-129">预定义语句不能用于在 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] 上创建临时对象。</span><span class="sxs-lookup"><span data-stu-id="e4b71-129">Prepared statements cannot be used to create temporary objects on [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="e4b71-130">使用[SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md)时使用的一些早期 ODBC 应用程序**SQLPrepare** 。</span><span class="sxs-lookup"><span data-stu-id="e4b71-130">Some early ODBC applications used **SQLPrepare** any time [SQLBindParameter](../../native-client-odbc-api/sqlbindparameter.md) was used.</span></span> <span data-ttu-id="e4b71-131">**SQLBindParameter**不需要使用**SQLPrepare**，它可与**SQLExecDirect**一起使用。</span><span class="sxs-lookup"><span data-stu-id="e4b71-131">**SQLBindParameter** does not require the use of **SQLPrepare**, it can be used with **SQLExecDirect**.</span></span> <span data-ttu-id="e4b71-132">例如，使用**SQLExecDirect**和**SQLBindParameter**从仅执行一次的存储过程检索返回代码或输出参数。</span><span class="sxs-lookup"><span data-stu-id="e4b71-132">For example, use **SQLExecDirect** with **SQLBindParameter** to retrieve the return code or output parameters from a stored procedure that is only executed one time.</span></span> <span data-ttu-id="e4b71-133">不要将**SQLPrepare**与**SQLBindParameter**一起使用，除非将多次执行相同的语句。</span><span class="sxs-lookup"><span data-stu-id="e4b71-133">Do not use **SQLPrepare** with **SQLBindParameter** unless the same statement will be executed multiple times.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e4b71-134">另请参阅</span><span class="sxs-lookup"><span data-stu-id="e4b71-134">See Also</span></span>  
 [<span data-ttu-id="e4b71-135">&#40;ODBC&#41;执行语句</span><span class="sxs-lookup"><span data-stu-id="e4b71-135">Executing Statements &#40;ODBC&#41;</span></span>](executing-statements-odbc.md)  
  
  

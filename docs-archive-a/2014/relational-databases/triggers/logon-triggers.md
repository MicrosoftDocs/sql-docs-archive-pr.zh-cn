---
title: 登录触发器 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
f1_keywords:
- logon triggers
- login triggers
helpviewer_keywords:
- triggers [SQL Server], logon
ms.assetid: 2f0ebb2f-de10-482d-9806-1a5de5b312b8
author: rothja
ms.author: jroth
ms.openlocfilehash: cda0be25f07ed2ee283b9707884041e7c6e4692f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87590617"
---
# <a name="logon-triggers"></a><span data-ttu-id="2da05-102">登录触发器</span><span class="sxs-lookup"><span data-stu-id="2da05-102">Logon Triggers</span></span>
  <span data-ttu-id="2da05-103">登录触发器将为响应 LOGON 事件而激发存储过程。</span><span class="sxs-lookup"><span data-stu-id="2da05-103">Logon triggers fire stored procedures in response to a LOGON event.</span></span> <span data-ttu-id="2da05-104">与 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例建立用户会话时将引发此事件。</span><span class="sxs-lookup"><span data-stu-id="2da05-104">This event is raised when a user session is established with an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2da05-105">登录触发器将在登录的身份验证阶段完成之后且用户会话实际建立之前激发。</span><span class="sxs-lookup"><span data-stu-id="2da05-105">Logon triggers fire after the authentication phase of logging in finishes, but before the user session is actually established.</span></span> <span data-ttu-id="2da05-106">因此，来自触发器内部且通常将到达用户的所有消息（例如错误消息和来自 PRINT 语句的消息）会传送到 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 错误日志。</span><span class="sxs-lookup"><span data-stu-id="2da05-106">Therefore, all messages originating inside the trigger that would typically reach the user, such as error messages and messages from the PRINT statement, are diverted to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="2da05-107">如果身份验证失败，将不激发登录触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-107">Logon triggers do not fire if authentication fails.</span></span>  
  
 <span data-ttu-id="2da05-108">可以使用登录触发器来审核和控制服务器会话，例如通过跟踪登录活动、限制 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的登录名或限制特定登录名的会话数。</span><span class="sxs-lookup"><span data-stu-id="2da05-108">You can use logon triggers to audit and control server sessions, such as by tracking login activity, restricting logins to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], or limiting the number of sessions for a specific login.</span></span> <span data-ttu-id="2da05-109">例如，在以下代码中，如果登录名 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] login_test *已经创建了三个用户会话，登录触发器将拒绝由该登录名启动的* 登录尝试。</span><span class="sxs-lookup"><span data-stu-id="2da05-109">For example, in the following code, the logon trigger denies log in attempts to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiated by login *login_test* if there are already three user sessions created by that login.</span></span>  
  
 [!code-sql[TriggerDDL#LogonTrigger1](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#logontrigger1)]  
  
 <span data-ttu-id="2da05-110">请注意，LOGON 事件对应于 AUDIT_LOGIN SQL Trace 事件，该事件可在 [事件通知](../service-broker/event-notifications.md)中使用。</span><span class="sxs-lookup"><span data-stu-id="2da05-110">Note that the LOGON event corresponds to the AUDIT_LOGIN SQL Trace event, which can be used in [Event Notifications](../service-broker/event-notifications.md).</span></span> <span data-ttu-id="2da05-111">触发器与事件通知的主要区别在于触发器随事件同步引发，而事件通知是异步的。</span><span class="sxs-lookup"><span data-stu-id="2da05-111">The primary difference between triggers and event notifications is that triggers are raised synchronously with events, whereas event notifications are asynchronous.</span></span> <span data-ttu-id="2da05-112">也就是说，例如，如果要停止建立会话，则必须使用登录触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-112">This means, for example, that if you want to stop a session from being established, you must use a logon trigger.</span></span> <span data-ttu-id="2da05-113">AUDIT_LOGIN 事件的事件通知不能用于此目的。</span><span class="sxs-lookup"><span data-stu-id="2da05-113">An event notification on an AUDIT_LOGIN event cannot be used for this purpose.</span></span>  
  
## <a name="specifying-first-and-last-trigger"></a><span data-ttu-id="2da05-114">指定第一个和最后一个触发器</span><span class="sxs-lookup"><span data-stu-id="2da05-114">Specifying First and Last Trigger</span></span>  
 <span data-ttu-id="2da05-115">可以对 LOGON 事件定义多个触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-115">Multiple triggers can be defined on the LOGON event.</span></span> <span data-ttu-id="2da05-116">通过使用 [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) 系统存储过程，可以将这些触发器中的任何一个指定为针对某事件激发的第一个或最后一个触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-116">Any one of these triggers can be designated the first or last trigger to be fired on an event by using the [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) system stored procedure.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="2da05-117">不保证其余触发器的执行顺序。</span><span class="sxs-lookup"><span data-stu-id="2da05-117">does not guarantee the execution order of the remaining triggers.</span></span>  
  
## <a name="managing-transactions"></a><span data-ttu-id="2da05-118">管理事务</span><span class="sxs-lookup"><span data-stu-id="2da05-118">Managing Transactions</span></span>  
 <span data-ttu-id="2da05-119">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 激发登录触发器之前， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 会创建独立于任何用户事务的隐式事务。</span><span class="sxs-lookup"><span data-stu-id="2da05-119">Before [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fires a logon trigger, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an implicit transaction that is independent from any user transaction.</span></span> <span data-ttu-id="2da05-120">因此，第一个登录触发器开始激发时，事务计数为 1。</span><span class="sxs-lookup"><span data-stu-id="2da05-120">Therefore, when the first logon trigger starts firing, the transaction count is 1.</span></span> <span data-ttu-id="2da05-121">所有登录触发器完成执行后，将提交事务。</span><span class="sxs-lookup"><span data-stu-id="2da05-121">After all the logon triggers finish executing, the transaction commits.</span></span> <span data-ttu-id="2da05-122">与其他类型的触发器一样，如果登录触发器完成执行后事务计数为 0， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 将返回错误。</span><span class="sxs-lookup"><span data-stu-id="2da05-122">As with other types of triggers, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] returns an error if a logon trigger finishes execution with a transaction count of 0.</span></span> <span data-ttu-id="2da05-123">ROLLBACK TRANSACTION 语句将事务计数重置为 0，即使该语句在嵌套事务中执行也会如此。</span><span class="sxs-lookup"><span data-stu-id="2da05-123">The ROLLBACK TRANSACTION statement resets the transaction count to 0, even if the statement is issued inside a nested transaction.</span></span> <span data-ttu-id="2da05-124">COMMIT TRANSACTION 可能将事务计数递减到 0。</span><span class="sxs-lookup"><span data-stu-id="2da05-124">COMMIT TRANSACTION might decrement the transaction count to 0.</span></span> <span data-ttu-id="2da05-125">因此，建议不要在登录触发器中发出 COMMIT TRANSACTION 语句。</span><span class="sxs-lookup"><span data-stu-id="2da05-125">Therefore, we advise against issuing COMMIT TRANSACTION statements inside logon triggers.</span></span>  
  
 <span data-ttu-id="2da05-126">如果要在登录触发器中使用 ROLLBACK TRANSACTION 语句，请注意以下事项：</span><span class="sxs-lookup"><span data-stu-id="2da05-126">Consider the following when you are using a ROLLBACK TRANSACTION statement inside logon triggers:</span></span>  
  
-   <span data-ttu-id="2da05-127">将回滚对 ROLLBACK TRANSACTION 点所做的任何数据修改。</span><span class="sxs-lookup"><span data-stu-id="2da05-127">Any data modifications made up to the point of ROLLBACK TRANSACTION are rolled back.</span></span> <span data-ttu-id="2da05-128">这些修改包括当前触发器所做的修改以及对同一事件执行的先前触发器所做的修改。</span><span class="sxs-lookup"><span data-stu-id="2da05-128">These modifications include those made by the current trigger and those made by previous triggers that executed on the same event.</span></span> <span data-ttu-id="2da05-129">此特定事件的任何其余触发器将不会执行。</span><span class="sxs-lookup"><span data-stu-id="2da05-129">Any remaining triggers for the specific event are not executed.</span></span>  
  
-   <span data-ttu-id="2da05-130">当前触发器继续执行显示在 ROLLBACK 语句之后的所有剩余语句。</span><span class="sxs-lookup"><span data-stu-id="2da05-130">The current trigger continues to execute any remaining statements that appear after the ROLLBACK statement.</span></span> <span data-ttu-id="2da05-131">如果这些语句中的任意语句修改数据，则不回滚这些修改。</span><span class="sxs-lookup"><span data-stu-id="2da05-131">If any of these statements modify data, the modifications are not rolled back.</span></span>  
  
 <span data-ttu-id="2da05-132">如果在针对 LOGON 事件执行触发器的过程中满足下列任何一个条件，将不会建立用户会话：</span><span class="sxs-lookup"><span data-stu-id="2da05-132">A user session is not established if any one of the following conditions occur during execution of a trigger on a LOGON event:</span></span>  
  
-   <span data-ttu-id="2da05-133">原始隐式事务回滚或失败。</span><span class="sxs-lookup"><span data-stu-id="2da05-133">The original implicit transaction is rolled back or fails.</span></span>  
  
-   <span data-ttu-id="2da05-134">触发器正文中出现严重级别大于 20 的错误。</span><span class="sxs-lookup"><span data-stu-id="2da05-134">An error that has severity greater than 20 is raised inside the trigger body.</span></span>  
  
## <a name="disabling-a-logon-trigger"></a><span data-ttu-id="2da05-135">禁用登录触发器</span><span class="sxs-lookup"><span data-stu-id="2da05-135">Disabling a Logon Trigger</span></span>  
 <span data-ttu-id="2da05-136">登录触发器可以有效地阻止所有用户（包括 `sysadmin` 固定服务器角色的成员）与[!INCLUDE[ssDE](../../../includes/ssde-md.md)]的成功连接。</span><span class="sxs-lookup"><span data-stu-id="2da05-136">A logon trigger can effectively prevent successful connections to the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] for all users, including members of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="2da05-137">在登录触发器正在阻止连接时，`sysadmin` 固定服务器角色的成员可通过使用专用管理员连接，或者通过以最小配置模式 (-f) 启动[!INCLUDE[ssDE](../../../includes/ssde-md.md)]，来进行连接。</span><span class="sxs-lookup"><span data-stu-id="2da05-137">When a logon trigger is preventing connections, members of the `sysadmin` fixed server role can connect by using the dedicated administrator connection, or by starting the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] in minimal configuration mode (-f).</span></span> <span data-ttu-id="2da05-138">有关详细信息，请参阅 [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md)。</span><span class="sxs-lookup"><span data-stu-id="2da05-138">For more information, see [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="2da05-139">Related Tasks</span><span class="sxs-lookup"><span data-stu-id="2da05-139">Related Tasks</span></span>  
  
|<span data-ttu-id="2da05-140">任务</span><span class="sxs-lookup"><span data-stu-id="2da05-140">Task</span></span>|<span data-ttu-id="2da05-141">主题</span><span class="sxs-lookup"><span data-stu-id="2da05-141">Topic</span></span>|  
|----------|-----------|  
|<span data-ttu-id="2da05-142">说明如何创建登录触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-142">Describes how to create logon triggers.</span></span> <span data-ttu-id="2da05-143">登录触发器可从任何数据库创建，但在服务器级注册，并驻留在 **master** 数据库中。</span><span class="sxs-lookup"><span data-stu-id="2da05-143">Logon triggers can be created from any database, but are registered at the server level and reside in the **master** database.</span></span>|[<span data-ttu-id="2da05-144">CREATE TRIGGER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="2da05-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-trigger-transact-sql)|  
|<span data-ttu-id="2da05-145">说明如何修改登录触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-145">Describes how to modify logon triggers.</span></span>|[<span data-ttu-id="2da05-146">ALTER TRIGGER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="2da05-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-trigger-transact-sql)|  
|<span data-ttu-id="2da05-147">说明如何删除登录触发器。</span><span class="sxs-lookup"><span data-stu-id="2da05-147">Describes how to delete logon triggers.</span></span>|[<span data-ttu-id="2da05-148">DROP TRIGGER (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="2da05-148">DROP TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/drop-trigger-transact-sql)|  
|<span data-ttu-id="2da05-149">说明如何返回有关登录触发器的信息。</span><span class="sxs-lookup"><span data-stu-id="2da05-149">Describes how to return information about logon triggers.</span></span>|[<span data-ttu-id="2da05-150">sys.server_triggers (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="2da05-150">sys.server_triggers &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-triggers-transact-sql)<br /><br /> [<span data-ttu-id="2da05-151">sys.server_trigger_events (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="2da05-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-trigger-events-transact-sql)|  
|<span data-ttu-id="2da05-152">说明如何捕获登录触发器事件数据。</span><span class="sxs-lookup"><span data-stu-id="2da05-152">Describes how to capture logon trigger event data.</span></span>||  
  
## <a name="see-also"></a><span data-ttu-id="2da05-153">另请参阅</span><span class="sxs-lookup"><span data-stu-id="2da05-153">See Also</span></span>  
 [<span data-ttu-id="2da05-154">DDL 触发器</span><span class="sxs-lookup"><span data-stu-id="2da05-154">DDL Triggers</span></span>](../triggers/ddl-triggers.md)  
  
  

---
title: 使用 EVENTDATA 函数 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- EVENTDATA function
- DDL triggers, EVENTDATA function
ms.assetid: 675b8320-9c73-4526-bd2f-91ba42c1b604
author: rothja
ms.author: jroth
ms.openlocfilehash: 57fb59a3954fb00ab943944c58cccd352c7270d2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87590614"
---
# <a name="use-the-eventdata-function"></a><span data-ttu-id="e36c4-102">使用 EVENTDATA 函数</span><span class="sxs-lookup"><span data-stu-id="e36c4-102">Use the EVENTDATA Function</span></span>
  <span data-ttu-id="e36c4-103">使用 EVENTDATA 函数，可以捕获有关激发 DDL 触发器的事件的信息。</span><span class="sxs-lookup"><span data-stu-id="e36c4-103">Information about an event that fires a DDL trigger is captured by using the EVENTDATA function.</span></span> <span data-ttu-id="e36c4-104">此函数返回 `xml` 值。</span><span class="sxs-lookup"><span data-stu-id="e36c4-104">This function returns an `xml` value.</span></span> <span data-ttu-id="e36c4-105">XML 架构包括下列信息：</span><span class="sxs-lookup"><span data-stu-id="e36c4-105">The XML schema includes information about the following:</span></span>  
  
-   <span data-ttu-id="e36c4-106">事件时间。</span><span class="sxs-lookup"><span data-stu-id="e36c4-106">The time of the event.</span></span>  
  
-   <span data-ttu-id="e36c4-107">在执行触发器时，连接的系统进程 ID (SPID)。</span><span class="sxs-lookup"><span data-stu-id="e36c4-107">The System Process ID (SPID) of the connection when the trigger executed.</span></span>  
  
-   <span data-ttu-id="e36c4-108">激发触发器的事件类型。</span><span class="sxs-lookup"><span data-stu-id="e36c4-108">The type of event that fired the trigger.</span></span>  
  
 <span data-ttu-id="e36c4-109">根据事件类型，该架构还包括其他信息，例如事件在其中发生的数据库、发生事件的相关对象以及事件的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 语句。</span><span class="sxs-lookup"><span data-stu-id="e36c4-109">Depending on the event type, the schema then includes additional information such as the database in which the event occurred, the object against which the event occurred, and the [!INCLUDE[tsql](../../includes/tsql-md.md)] statement of the event.</span></span> <span data-ttu-id="e36c4-110">有关详细信息，请参阅 [DDL Triggers](ddl-triggers.md)。</span><span class="sxs-lookup"><span data-stu-id="e36c4-110">For more information, see [DDL Triggers](ddl-triggers.md).</span></span>  
  
 <span data-ttu-id="e36c4-111">例如，将在 [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] 示例数据库中创建以下 DDL 触发器：</span><span class="sxs-lookup"><span data-stu-id="e36c4-111">For example, the following DDL trigger is created in the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database:</span></span>  
  
```  
CREATE TRIGGER safety   
ON DATABASE   
FOR CREATE_TABLE   
AS   
    PRINT 'CREATE TABLE Issued.'  
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)')  
   RAISERROR ('New tables cannot be created in this database.', 16, 1)   
   ROLLBACK  
;  
```  
  
 <span data-ttu-id="e36c4-112">然后运行以下 `CREATE TABLE` 语句：</span><span class="sxs-lookup"><span data-stu-id="e36c4-112">The following `CREATE TABLE` statement is then run:</span></span>  
  
 `CREATE TABLE NewTable (Column1 int);`  
  
 <span data-ttu-id="e36c4-113">DDL 触发器中的 `EVENTDATA()` 语句将捕获不允许使用的 `CREATE TABLE` 语句文本。</span><span class="sxs-lookup"><span data-stu-id="e36c4-113">The `EVENTDATA()` statement in the DDL trigger captures the text of the `CREATE TABLE` statement that is not allowed.</span></span> <span data-ttu-id="e36c4-114">这是通过对 EVENTDATA 生成的数据使用 XQuery 语句 `xml` 并检索元素实现的 \<CommandText> 。</span><span class="sxs-lookup"><span data-stu-id="e36c4-114">This is achieved by using an XQuery statement against the `xml` data that is generated by EVENTDATA and retrieving the \<CommandText> element.</span></span> <span data-ttu-id="e36c4-115">有关详细信息，请参阅 [XQuery 语言参考 (SQL Server)](/sql/xquery/xquery-language-reference-sql-server)。</span><span class="sxs-lookup"><span data-stu-id="e36c4-115">For more information, see [XQuery Language Reference &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="e36c4-116">EVENTDATA 将捕获 CREATE_SCHEMA 事件的数据以及相应 CREATE SCHEMA 定义的 <schema_element>（如果存在）。</span><span class="sxs-lookup"><span data-stu-id="e36c4-116">EVENTDATA captures the data of CREATE_SCHEMA events as well as the <schema_element> of the corresponding CREATE SCHEMA definition, if any exists.</span></span> <span data-ttu-id="e36c4-117">此外，EVENTDATA 将 <schema_element> 定义识别为单独的事件。</span><span class="sxs-lookup"><span data-stu-id="e36c4-117">Additionally, EVENTDATA recognizes the <schema_element> definition as a separate event.</span></span> <span data-ttu-id="e36c4-118">因此，针对 CREATE_SCHEMA 事件和由 CREATE_SCHEMA 定义的 <schema_element> 表示的事件创建的 DDL 触发器可能两次返回相同的事件数据，如 `TSQLCommand` 数据。</span><span class="sxs-lookup"><span data-stu-id="e36c4-118">Therefore, a DDL trigger created on both a CREATE_SCHEMA event, and an event represented by the <schema_element> of the CREATE SCHEMA definition, may return the same event data twice, such as the `TSQLCommand` data.</span></span> <span data-ttu-id="e36c4-119">例如，针对 CREATE_SCHEMA 事件和 CREATE_TABLE 事件创建的 DDL 触发器，将运行下列批处理：</span><span class="sxs-lookup"><span data-stu-id="e36c4-119">For example, consider a DDL trigger that is created on both the CREATE_SCHEMA and CREATE_TABLE events and the following batch is run:</span></span>  
>   
>  `CREATE SCHEMA s`  
>   
>  `CREATE TABLE t1 (col1 int)`  
>   
>  <span data-ttu-id="e36c4-120">如果应用程序检索 CREATE_TABLE 事件的 `TSQLCommand` 数据，则注意，此数据可能出现两次：一次是在 CREATE_SCHEMA 事件发生时，另一次是在 CREATE_TABLE 事件发生时。</span><span class="sxs-lookup"><span data-stu-id="e36c4-120">If the application retrieves the `TSQLCommand` data of the CREATE_TABLE event, be aware that this data may appear two times: once when the CREATE_SCHEMA event occurs, and again when the CREATE_TABLE event occurs.</span></span> <span data-ttu-id="e36c4-121">应避免同时针对 CREATE_SCHEMA 事件和任何相应 CREATE SCHEMA 定义的 <schema_element> 文本创建 DDL 触发器，或者将逻辑置于应用程序中，这样，就不会将同一事件处理两次了。</span><span class="sxs-lookup"><span data-stu-id="e36c4-121">Avoid creating DDL triggers on both the CREATE_SCHEMA events and the <schema_element> texts of any corresponding CREATE SCHEMA definitions, or build logic into your application so that the same event is not processed twice.</span></span>  
  
## <a name="alter-table-and-alter-database-events"></a><span data-ttu-id="e36c4-122">ALTER TABLE 和 ALTER DATABASE 事件</span><span class="sxs-lookup"><span data-stu-id="e36c4-122">ALTER TABLE and ALTER DATABASE Events</span></span>  
 <span data-ttu-id="e36c4-123">ALTER_TABLE 和 ALTER_DATABASE 事件的事件数据还包括以下内容：受 DDL 语句影响的其他对象的名称和类型以及对这些对象执行的操作。</span><span class="sxs-lookup"><span data-stu-id="e36c4-123">The event data for the ALTER_TABLE and ALTER_DATABASE events also includes the names and types of other objects affected by the DDL statement and the action performed on these objects.</span></span> <span data-ttu-id="e36c4-124">ALTER_TABLE 事件数据包括以下内容：受 ALTER TABLE 语句影响的列、约束或触发器的名称以及对受影响的对象执行的操作（创建、更改、删除、启用或禁用）。</span><span class="sxs-lookup"><span data-stu-id="e36c4-124">The ALTER_TABLE event data includes the names of the columns, constraints, or triggers affected by the ALTER TABLE statement and the action (create, alter, drop, enable, or disable) performed on the affected objects.</span></span> <span data-ttu-id="e36c4-125">ALTER_DATABASE 事件数据包括以下内容：受 ALTER DATABASE 语句影响的任何文件或文件组的名称以及对受影响的对象执行的操作（创建、更改或删除）。</span><span class="sxs-lookup"><span data-stu-id="e36c4-125">The ALTER_DATABASE event data includes the names of any files or filegroups affected by the ALTER DATABASE statement and the action (create, alter, or drop) performed on the affected objects.</span></span>  
  
 <span data-ttu-id="e36c4-126">例如，在 AdventureWorks 示例数据库中创建以下 DDL 触发器：</span><span class="sxs-lookup"><span data-stu-id="e36c4-126">For example, create the following DDL trigger in the AdventureWorks sample database:</span></span>  
  
```  
CREATE TRIGGER ColumnChanges  
ON DATABASE   
FOR ALTER_TABLE  
AS  
-- Detect whether a column was created/altered/dropped.  
SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'nvarchar(max)')  
RAISERROR ('Table schema cannot be modified in this database.', 16, 1);  
ROLLBACK;  
```  
  
 <span data-ttu-id="e36c4-127">然后，执行以下违反约束的 ALTER TABLE 语句：</span><span class="sxs-lookup"><span data-stu-id="e36c4-127">Then execute the following ALTER TABLE statement that violates a constraint:</span></span>  
  
```  
ALTER TABLE Person.Address ALTER COLUMN ModifiedDate date;   
```  
  
 <span data-ttu-id="e36c4-128">DDL 触发器中的 EVENTDATA() 语句将捕获不允许使用的 `ALTER TABLE` 语句的文本。</span><span class="sxs-lookup"><span data-stu-id="e36c4-128">The EVENTDATA() statement in the DDL trigger captures the text of the `ALTER TABLE` statement that is not permitted.</span></span>  
  
## <a name="example"></a><span data-ttu-id="e36c4-129">示例</span><span class="sxs-lookup"><span data-stu-id="e36c4-129">Example</span></span>  
 <span data-ttu-id="e36c4-130">您可以使用 EVENTDATA 函数来创建事件日志。</span><span class="sxs-lookup"><span data-stu-id="e36c4-130">You can use the EVENTDATA function to create a log of events.</span></span> <span data-ttu-id="e36c4-131">在下面的示例中，创建了一个表来存储事件信息。</span><span class="sxs-lookup"><span data-stu-id="e36c4-131">In the following example, a table is created to store event information.</span></span> <span data-ttu-id="e36c4-132">然后，针对当任何数据库级 DDL 事件发生时，使用以下信息填充表的当前数据库创建 DDL 触发器：</span><span class="sxs-lookup"><span data-stu-id="e36c4-132">A DDL trigger is then created on the current database that populates the table with the following information whenever any database-level DDL event occurs:</span></span>  
  
-   <span data-ttu-id="e36c4-133">事件时间（使用 GETDATE 函数）。</span><span class="sxs-lookup"><span data-stu-id="e36c4-133">The time of the event (using the GETDATE function).</span></span>  
  
-   <span data-ttu-id="e36c4-134">其会话上发生事件的数据库用户（使用 CURRENT_USER 函数）。</span><span class="sxs-lookup"><span data-stu-id="e36c4-134">The database user against whose session the event occurred (using the CURRENT_USER function).</span></span>  
  
-   <span data-ttu-id="e36c4-135">事件类型。</span><span class="sxs-lookup"><span data-stu-id="e36c4-135">The type of the event.</span></span>  
  
-   <span data-ttu-id="e36c4-136">包括事件的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 语句。</span><span class="sxs-lookup"><span data-stu-id="e36c4-136">The [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that comprised the event.</span></span>  
  
 <span data-ttu-id="e36c4-137">此外，通过对 EVENTDATA 生成的 `xml` 数据使用 XQuery 来捕获最后两项。</span><span class="sxs-lookup"><span data-stu-id="e36c4-137">Again, the last two items are captured by using XQuery against the `xml` data that is generated by EVENTDATA.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE TABLE ddl_log (PostTime datetime, DB_User nvarchar(100), Event nvarchar(100), TSQL nvarchar(2000));  
GO  
CREATE TRIGGER log   
ON DATABASE   
FOR DDL_DATABASE_LEVEL_EVENTS   
AS  
DECLARE @data XML  
SET @data = EVENTDATA()  
INSERT ddl_log   
   (PostTime, DB_User, Event, TSQL)   
   VALUES   
   (GETDATE(),   
   CONVERT(nvarchar(100), CURRENT_USER),   
   @data.value('(/EVENT_INSTANCE/EventType)[1]', 'nvarchar(100)'),   
   @data.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'nvarchar(2000)') ) ;  
GO  
--Test the trigger  
CREATE TABLE TestTable (a int)  
DROP TABLE TestTable ;  
GO  
SELECT * FROM ddl_log ;  
GO  
```  
  
> [!NOTE]  
>  <span data-ttu-id="e36c4-138">若要返回事件数据，建议您使用 XQuery `value()` 方法来替代 `query()` 方法。</span><span class="sxs-lookup"><span data-stu-id="e36c4-138">To return event data, we recommend that you use the XQuery `value()` method instead of the `query()` method.</span></span> <span data-ttu-id="e36c4-139">`query()` 方法可在输出中返回 XML 和以“and”符转义的回车符和换行符 (CRLF) 实例，而 `value()` 方法无法在输出中呈现 CRLF 实例。</span><span class="sxs-lookup"><span data-stu-id="e36c4-139">The `query()` method returns XML and ampersand-escaped carriage return and line-feed (CRLF) instances in the output, while the `value()` method renders CRLF instances invisible in the output.</span></span>  
  
 <span data-ttu-id="e36c4-140">[!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] 示例数据库还提供了类似的 DDL 触发器示例。</span><span class="sxs-lookup"><span data-stu-id="e36c4-140">A similar DDL trigger example is provided with the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database.</span></span> <span data-ttu-id="e36c4-141">若要获得示例，请使用 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]找到 Database Triggers 文件夹。</span><span class="sxs-lookup"><span data-stu-id="e36c4-141">To obtain the example, locate the Database Triggers folder by using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="e36c4-142">此文件夹位于 **数据库的** Programmability [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] 文件夹下。</span><span class="sxs-lookup"><span data-stu-id="e36c4-142">This folder is located under the **Programmability** folder of the [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] database.</span></span> <span data-ttu-id="e36c4-143">右键单击“ddlDatabaseTriggerLog”并选择“将数据库触发器脚本编写为”。</span><span class="sxs-lookup"><span data-stu-id="e36c4-143">Right-click **ddlDatabaseTriggerLog** and select **Script Database Trigger as**.</span></span> <span data-ttu-id="e36c4-144">默认情况下，DDL 触发器 ddlDatabaseTriggerLog 处于禁用状态。</span><span class="sxs-lookup"><span data-stu-id="e36c4-144">By default, DDL trigger **ddlDatabaseTriggerLog** is disabled.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e36c4-145">另请参阅</span><span class="sxs-lookup"><span data-stu-id="e36c4-145">See Also</span></span>  
 <span data-ttu-id="e36c4-146">[DDL 事件](../triggers/ddl-events.md) </span><span class="sxs-lookup"><span data-stu-id="e36c4-146">[DDL Events](../triggers/ddl-events.md) </span></span>  
 [<span data-ttu-id="e36c4-147">DDL 事件组</span><span class="sxs-lookup"><span data-stu-id="e36c4-147">DDL Event Groups</span></span>](../triggers/ddl-event-groups.md)  
  
  

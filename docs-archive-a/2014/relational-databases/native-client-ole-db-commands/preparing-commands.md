---
title: 准备命令 | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client OLE DB provider, commands
- prepared statements [SQL Server Native Client]
- commands [OLE DB]
- command preparation [SQL Server Native Client]
ms.assetid: 09ec0c6c-0a44-4766-b9b7-5092f676ee54
author: rothja
ms.author: jroth
ms.openlocfilehash: e06e6afab622953452a00751e3a55d49fc7b8ec7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87687879"
---
# <a name="preparing-commands"></a><span data-ttu-id="4d2af-102">准备命令</span><span class="sxs-lookup"><span data-stu-id="4d2af-102">Preparing Commands</span></span>
  <span data-ttu-id="4d2af-103">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口支持命令准备，以优化多次执行的单个命令。不过，命令准备会带来开销，使用者不必准备执行次数多于一次的命令。</span><span class="sxs-lookup"><span data-stu-id="4d2af-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports command preparation for optimized multiple execution of a single command; however, command preparation generates overhead, and a consumer does not need to prepare a command to execute it more than once.</span></span> <span data-ttu-id="4d2af-104">一般而言，如果命令的执行次数超过三次，则应当进行准备。</span><span class="sxs-lookup"><span data-stu-id="4d2af-104">In general, a command should be prepared if it will be executed more than three times.</span></span>  
  
 <span data-ttu-id="4d2af-105">出于性能方面的考虑，命令准备会延迟至命令执行之时。</span><span class="sxs-lookup"><span data-stu-id="4d2af-105">For performance reasons, the command preparation is deferred until the command is executed.</span></span> <span data-ttu-id="4d2af-106">此选项为默认行为。</span><span class="sxs-lookup"><span data-stu-id="4d2af-106">This is the default behavior.</span></span> <span data-ttu-id="4d2af-107">待准备命令中的任何错误，直到执行命令或执行元属性操作时才会发现。</span><span class="sxs-lookup"><span data-stu-id="4d2af-107">Any errors in the command being prepared are not known until the command is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="4d2af-108">将 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 属性 SSPROP_DEFERPREPARE 设置为 FALSE 可以关闭此默认行为。</span><span class="sxs-lookup"><span data-stu-id="4d2af-108">Setting the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] property SSPROP_DEFERPREPARE to FALSE can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="4d2af-109">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 中，直接执行命令（即不提前准备命令）时，会创建并缓存一个执行计划。</span><span class="sxs-lookup"><span data-stu-id="4d2af-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], when a command is executed directly (without preparing it first), an execution plan is created and cached.</span></span> <span data-ttu-id="4d2af-110">如果再次执行该 SQL 语句，则 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 会采用有效的算法将新的语句与缓存中的现有执行计划进行匹配，然后再次使用该语句的执行计划。</span><span class="sxs-lookup"><span data-stu-id="4d2af-110">If the SQL statement is executed again, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] has an efficient algorithm to match the new statement with the existing execution plan in the cache, and reuses the execution plan for that statement.</span></span>  
  
 <span data-ttu-id="4d2af-111">对于准备好的命令，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 为准备和执行命令语句提供了本机支持。</span><span class="sxs-lookup"><span data-stu-id="4d2af-111">For prepared commands, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides native support for preparing and executing command statements.</span></span> <span data-ttu-id="4d2af-112">在准备语句时，[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 创建一个执行计划，进行缓存，然后将该执行计划的句柄返回访问接口。</span><span class="sxs-lookup"><span data-stu-id="4d2af-112">When you prepare a statement, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an execution plan, caches it, and returns a handle to this execution plan to the provider.</span></span> <span data-ttu-id="4d2af-113">随后，访问接口使用该句柄来重复执行该语句。</span><span class="sxs-lookup"><span data-stu-id="4d2af-113">The provider then uses this handle to execute the statement repeatedly.</span></span> <span data-ttu-id="4d2af-114">不创建存储过程。</span><span class="sxs-lookup"><span data-stu-id="4d2af-114">No stored procedures are created.</span></span> <span data-ttu-id="4d2af-115">由于句柄会直接识别 SQL 语句的执行计划，而不用将语句与缓存中的现有语句进行匹配（如直接执行那样），因此，如果知道语句将多次执行，那么准备语句比直接执行语句更高效。</span><span class="sxs-lookup"><span data-stu-id="4d2af-115">Because the handle directly identifies the execution plan for an SQL statement instead of matching the statement to the execution plan in the cache (as is the case for direct execution), it is more efficient to prepare a statement than to execute it directly, if you know the statement will be executed more than a few times.</span></span>  
  
 <span data-ttu-id="4d2af-116">在 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] 中，无法使用预定义语句创建临时对象，也无法引用创建临时对象（如临时表）的系统存储过程。</span><span class="sxs-lookup"><span data-stu-id="4d2af-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the prepared statements cannot be used to create temporary objects and cannot reference system stored procedures that create temporary objects, such as temporary tables.</span></span> <span data-ttu-id="4d2af-117">必须直接执行这些过程。</span><span class="sxs-lookup"><span data-stu-id="4d2af-117">These procedures must be executed directly.</span></span>  
  
 <span data-ttu-id="4d2af-118">始终不应准备某些命令。</span><span class="sxs-lookup"><span data-stu-id="4d2af-118">Some commands should never be prepared.</span></span> <span data-ttu-id="4d2af-119">例如，不应对指定存储过程执行的命令进行准备，也不应准备包含对 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 存储过程创建无效的文本的命令。</span><span class="sxs-lookup"><span data-stu-id="4d2af-119">For example, commands that specify stored procedure execution or include invalid text for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] stored procedure creation should not be prepared.</span></span>  
  
 <span data-ttu-id="4d2af-120">如果创建了临时存储过程，则 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口会执行临时存储过程，并返回结果，就好像执行语句本身一样。</span><span class="sxs-lookup"><span data-stu-id="4d2af-120">If a temporary stored procedure is created, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider executes the temporary stored procedure, returning results as if the statement itself was executed.</span></span>  
  
 <span data-ttu-id="4d2af-121">临时存储过程的创建由特定于 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口的初始化属性 SSPROP_INIT_USEPROCFORPREP 控制。</span><span class="sxs-lookup"><span data-stu-id="4d2af-121">Temporary stored procedure creation is controlled by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider -specific initialization property SSPROP_INIT_USEPROCFORPREP.</span></span> <span data-ttu-id="4d2af-122">如果属性值为 SSPROPVAL_USEPROCFORPREP_ON 或 SSPROPVAL_USEPROCFORPREP_ON_DROP，则 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口会在准备命令时尝试创建存储过程。</span><span class="sxs-lookup"><span data-stu-id="4d2af-122">If the property value is either SSPROPVAL_USEPROCFORPREP_ON or SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider attempts to create a stored procedure when a command is prepared.</span></span> <span data-ttu-id="4d2af-123">如果应用程序用户拥有足够的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 权限，存储过程将创建成功。</span><span class="sxs-lookup"><span data-stu-id="4d2af-123">Stored procedure creation succeeds if the application user has sufficient [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permissions.</span></span>  
  
 <span data-ttu-id="4d2af-124">对于很少断开连接的使用者，临时存储过程的创建可能需要大量的 tempdb（即在其中创建临时对象的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 系统数据库）资源\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="4d2af-124">For consumers that infrequently disconnect, creation of temporary stored procedures can require significant resources of **tempdb**, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] system database in which temporary objects are created.</span></span> <span data-ttu-id="4d2af-125">如果 SSPROP_INIT_USEPROCFORPREP 的值为 SSPROPVAL_USEPROCFORPREP_ ON，那么由 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口创建的临时存储过程，仅当创建命令的会话断开与 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例的连接时才会删除。</span><span class="sxs-lookup"><span data-stu-id="4d2af-125">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ ON, temporary stored procedures created by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider are dropped only when the session that created the command loses its connection to the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="4d2af-126">如果该连接为数据源初始化时创建的默认连接，则临时存储过程仅当数据源变成未初始化状态时才删除。</span><span class="sxs-lookup"><span data-stu-id="4d2af-126">If that connection is the default connection created on data source initialization, the temporary stored procedure is dropped only when the data source becomes uninitialized.</span></span>  
  
 <span data-ttu-id="4d2af-127">如果 SSPROP_INIT_USEPROCFORPREP 的值为 SSPROPVAL_USEPROCFORPREP_ON_DROP，那么当发生以下情况之一时，会删除 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB 访问接口临时存储过程：</span><span class="sxs-lookup"><span data-stu-id="4d2af-127">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider temporary stored procedures are dropped when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="4d2af-128">使用者使用 ICommandText::SetCommandText 指示新的命令\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="4d2af-128">The consumer uses **ICommandText::SetCommandText** to indicate a new command.</span></span>  
  
-   <span data-ttu-id="4d2af-129">使用者使用 ICommandPrepare::Unprepare 指示它不再需要命令文本\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="4d2af-129">The consumer uses **ICommandPrepare::Unprepare** to indicate that it no longer requires the command text.</span></span>  
  
-   <span data-ttu-id="4d2af-130">使用者使用临时存储过程释放对命令对象的所有引用。</span><span class="sxs-lookup"><span data-stu-id="4d2af-130">The consumer releases all references to the command object using the temporary stored procedure.</span></span>  
  
 <span data-ttu-id="4d2af-131">命令对象在 tempdb 中最多具有一个临时存储过程\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="4d2af-131">A command object has at most one temporary stored procedure in **tempdb**.</span></span> <span data-ttu-id="4d2af-132">任何现有的临时存储过程都表示特定命令对象的当前命令文本。</span><span class="sxs-lookup"><span data-stu-id="4d2af-132">Any existing temporary stored procedure represents the current command text of a specific command object.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4d2af-133">另请参阅</span><span class="sxs-lookup"><span data-stu-id="4d2af-133">See Also</span></span>  
 [<span data-ttu-id="4d2af-134">命令</span><span class="sxs-lookup"><span data-stu-id="4d2af-134">Commands</span></span>](commands.md)  
  
  

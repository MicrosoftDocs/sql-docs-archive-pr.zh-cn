---
title: 事务日志 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 01/04/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- transaction logs [SQL Server], about
- databases [SQL Server], transaction logs
- logs [SQL Server], transaction logs
ms.assetid: d7be5ac5-4c8e-4d0a-b114-939eb97dac4d
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 025ef22e6dee1fcfaa1225a4709fa01b6c326b12
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87580726"
---
# <a name="the-transaction-log-sql-server"></a><span data-ttu-id="7f9bd-102">事务日志 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7f9bd-102">The Transaction Log (SQL Server)</span></span>
  <span data-ttu-id="7f9bd-103">每个 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库都具有事务日志，用于记录所有事务以及每个事务对数据库所做的修改。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-103">Every [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database has a transaction log that records all transactions and the database modifications made by each transaction.</span></span> <span data-ttu-id="7f9bd-104">必须定期截断事务日志以避免它被填满。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-104">The transaction log must be truncated on a regular basis to keep it from filling up.</span></span> <span data-ttu-id="7f9bd-105">但是，一些因素可能延迟日志截断，因此监视日志大小很重要。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-105">However, some factors can delay log truncation, so monitoring log size is important.</span></span> <span data-ttu-id="7f9bd-106">某些操作可以最小日志量进行记录以减少其对事务日志大小的影响。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-106">Some operations can be minimally logged to reduce their impact on transaction log size.</span></span>  
  
 <span data-ttu-id="7f9bd-107">事务日志是数据库的重要组件，如果系统出现故障，则可能需要使用事务日志将数据库恢复到一致状态。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-107">The transaction log is a critical component of the database and, if there is a system failure, the transaction log might be required to bring your database back to a consistent state.</span></span> <span data-ttu-id="7f9bd-108">删除或移动事务日志以前，必须完全了解此操作带来的后果。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-108">The transaction log should never be deleted or moved unless you fully understand the ramifications of doing this.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7f9bd-109">检查点会创建一些正常点，在数据库恢复期间将从这些正常点开始应用事务日志。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-109">Known good points from which to begin applying transaction logs during database recovery are created by checkpoints.</span></span> <span data-ttu-id="7f9bd-110">有关详细信息，请参阅[数据库检查点 (SQL Server)](database-checkpoints-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-110">For more information, see [Database Checkpoints &#40;SQL Server&#41;](database-checkpoints-sql-server.md).</span></span>  
  
 <span data-ttu-id="7f9bd-111">**本主题内容：**</span><span class="sxs-lookup"><span data-stu-id="7f9bd-111">**In this Topic:**</span></span>  
  
-   [<span data-ttu-id="7f9bd-112">优点：事务日志支持的操作</span><span class="sxs-lookup"><span data-stu-id="7f9bd-112">Benefits: Operations Supported by the Transaction Log</span></span>](#Benefits)  
  
-   [<span data-ttu-id="7f9bd-113">事务日志截断</span><span class="sxs-lookup"><span data-stu-id="7f9bd-113">Transaction Log Truncation</span></span>](#Truncation)  
  
-   [<span data-ttu-id="7f9bd-114">可能延迟日志截断的因素</span><span class="sxs-lookup"><span data-stu-id="7f9bd-114">Factors That Can Delay Log Truncation</span></span>](#FactorsThatDelayTruncation)  
  
-   [<span data-ttu-id="7f9bd-115">可按最小方式记录的操作</span><span class="sxs-lookup"><span data-stu-id="7f9bd-115">Operations That Can Be Minimally Logged</span></span>](#MinimallyLogged)  
  
-   [<span data-ttu-id="7f9bd-116">相关任务</span><span class="sxs-lookup"><span data-stu-id="7f9bd-116">Related Tasks</span></span>](#RelatedTasks)  
  
##  <a name="benefits-operations-supported-by-the-transaction-log"></a><a name="Benefits"></a><span data-ttu-id="7f9bd-117">优点：事务日志支持的操作</span><span class="sxs-lookup"><span data-stu-id="7f9bd-117">Benefits: Operations Supported by the Transaction Log</span></span>  
 <span data-ttu-id="7f9bd-118">事务日志支持以下操作：</span><span class="sxs-lookup"><span data-stu-id="7f9bd-118">The transaction log supports the following operations:</span></span>  
  
-   <span data-ttu-id="7f9bd-119">恢复个别的事务。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-119">Recovery of individual transactions.</span></span>  
  
-   <span data-ttu-id="7f9bd-120">在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 启动时恢复所有未完成的事务。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-120">Recovery of all incomplete transactions when [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is started.</span></span>  
  
-   <span data-ttu-id="7f9bd-121">将还原的数据库、文件、文件组或页前滚至故障点。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-121">Rolling a restored database, file, filegroup, or page forward to the point of failure.</span></span>  
  
-   <span data-ttu-id="7f9bd-122">支持事务复制。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-122">Supporting transactional replication.</span></span>  
  
-   <span data-ttu-id="7f9bd-123">支持高可用性和灾难恢复解决方案： [!INCLUDE[ssHADR](../../includes/sshadr-md.md)]、数据库镜像和日志传送。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-123">Supporting high availability and disaster recovery solutions: [!INCLUDE[ssHADR](../../includes/sshadr-md.md)], database mirroring, and log shipping.</span></span>  
  
##  <a name="transaction-log-truncation"></a><a name="Truncation"></a> <span data-ttu-id="7f9bd-124">事务日志截断</span><span class="sxs-lookup"><span data-stu-id="7f9bd-124">Transaction Log Truncation</span></span>  
 <span data-ttu-id="7f9bd-125">日志截断将释放日志文件的空间，以便由事务日志重新使用。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-125">Log truncation frees space in the log file for reuse by the transaction log.</span></span> <span data-ttu-id="7f9bd-126">日志截断主要用于阻止日志填充。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-126">Log truncation is essential to keep the log from filling.</span></span> <span data-ttu-id="7f9bd-127">日志截断可从 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库的逻辑事务日志中删除不活动的虚拟日志文件，释放逻辑日志中的空间以便物理事务日志重用这些空间。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-127">Log truncation deletes inactive virtual log files from the logical transaction log of a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database, freeing space in the logical log for reuse by the Physical transaction log.</span></span> <span data-ttu-id="7f9bd-128">如果事务日志从不截断，它最终将填满分配给物理日志文件的所有磁盘空间。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-128">If a transaction log were never truncated, it would eventually fill all the disk space that is allocated to its physical log files.</span></span>  
  
 <span data-ttu-id="7f9bd-129">为了避免这个问题，除非由于某些原因延迟日志截断，否则将在以下事件后自动进行截断：</span><span class="sxs-lookup"><span data-stu-id="7f9bd-129">To avoid this problem, unless log truncation is being delayed for some reason, truncation occurs automatically after the following events:</span></span>  
  
-   <span data-ttu-id="7f9bd-130">简单恢复模式下，在检查点之后发生。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-130">Under the simple recovery model, after a checkpoint.</span></span>  
  
-   <span data-ttu-id="7f9bd-131">在完整恢复模式或大容量日志恢复模式下，如果自上一次备份后生成检查点，则在日志备份后进行截断（除非是仅复制日志备份）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-131">Under the full recovery model or bulk-logged recovery model, if a checkpoint has occurred since the previous backup, truncation occurs after a log backup (unless it is a copy-only log backup).</span></span>  
  
 <span data-ttu-id="7f9bd-132">有关详细信息，请参阅本主题后面的[可能延迟日志截断的因素](#FactorsThatDelayTruncation)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-132">For more information, see [Factors That Can Delay Log Truncation](#FactorsThatDelayTruncation), later in this topic.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7f9bd-133">日志截断并不减小物理日志文件的大小。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-133">Log truncation does not reduce the size of the physical log file.</span></span> <span data-ttu-id="7f9bd-134">若要减少物理日志文件的物理大小，需要收缩日志文件。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-134">To reduce the physical size of a physical log file, you need to shrink the log file.</span></span> <span data-ttu-id="7f9bd-135">有关收缩物理日志文件大小的信息，请参阅 [管理事务日志文件的大小](manage-the-size-of-the-transaction-log-file.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-135">For information about shrinking the size of the physical log file, see [Manage the Size of the Transaction Log File](manage-the-size-of-the-transaction-log-file.md).</span></span>  
  
##  <a name="factors-that-can-delay-log-truncation"></a><a name="FactorsThatDelayTruncation"></a><span data-ttu-id="7f9bd-136">可能延迟日志截断的因素</span><span class="sxs-lookup"><span data-stu-id="7f9bd-136">Factors That Can Delay Log Truncation</span></span>  
 <span data-ttu-id="7f9bd-137">在日志记录长时间处于活动状态时，事务日志截断将延迟，事务日志可能填满。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-137">When log records remain active for a long time transaction log truncation is delayed, and potentially the transaction log can fill up.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="7f9bd-138">有关如何响应已满事务日志的信息，请参阅[解决事务日志已满的问题（SQL Server 错误 9002）](troubleshoot-a-full-transaction-log-sql-server-error-9002.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-138">For information about how to respond to a full transaction log, see [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](troubleshoot-a-full-transaction-log-sql-server-error-9002.md).</span></span>  
  
 <span data-ttu-id="7f9bd-139">日志截断会由于多种因素发生延迟。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-139">Log truncation can be delayed by a variety of factors.</span></span> <span data-ttu-id="7f9bd-140">可以查询 **sys.databases** 目录视图的 **log_reuse_wait** 和 [log_reuse_wait_desc](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql) 列来发现是哪些因素（如果有）阻止截断日志。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-140">You can discover what, if anything, is preventing log truncation by querying the **log_reuse_wait** and **log_reuse_wait_desc** columns of the [sys.databases](/sql/relational-databases/system-catalog-views/sys-databases-transact-sql) catalog view.</span></span> <span data-ttu-id="7f9bd-141">下表对这些列的值进行了说明。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-141">The following table describes the values of these columns.</span></span>  
  
|<span data-ttu-id="7f9bd-142">log_reuse_wait 值</span><span class="sxs-lookup"><span data-stu-id="7f9bd-142">log_reuse_wait value</span></span>|<span data-ttu-id="7f9bd-143">log_reuse_wait_desc 值</span><span class="sxs-lookup"><span data-stu-id="7f9bd-143">log_reuse_wait_desc value</span></span>|<span data-ttu-id="7f9bd-144">说明</span><span class="sxs-lookup"><span data-stu-id="7f9bd-144">Description</span></span>|  
|----------------------------|----------------------------------|-----------------|  
|<span data-ttu-id="7f9bd-145">0</span><span class="sxs-lookup"><span data-stu-id="7f9bd-145">0</span></span>|<span data-ttu-id="7f9bd-146">NOTHING</span><span class="sxs-lookup"><span data-stu-id="7f9bd-146">NOTHING</span></span>|<span data-ttu-id="7f9bd-147">当前有一个或多个可重复使用的虚拟日志文件。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-147">Currently there are one or more reusable virtual log files.</span></span>|  
|<span data-ttu-id="7f9bd-148">1</span><span class="sxs-lookup"><span data-stu-id="7f9bd-148">1</span></span>|<span data-ttu-id="7f9bd-149">CHECKPOINT</span><span class="sxs-lookup"><span data-stu-id="7f9bd-149">CHECKPOINT</span></span>|<span data-ttu-id="7f9bd-150">自上次日志截断之后，尚未生成检查点，或者日志头尚未跨一个虚拟日志文件移动。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-150">No checkpoint has occurred since the last log truncation, or the head of the log has not yet moved beyond a virtual log file.</span></span> <span data-ttu-id="7f9bd-151">（所有恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-151">(All recovery models)</span></span><br /><br /> <span data-ttu-id="7f9bd-152">这是日志截断延迟的常见原因。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-152">This is a routine reason for delaying log truncation.</span></span> <span data-ttu-id="7f9bd-153">有关详细信息，请参阅[数据库检查点 (SQL Server)](database-checkpoints-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-153">For more information, see [Database Checkpoints &#40;SQL Server&#41;](database-checkpoints-sql-server.md).</span></span>|  
|<span data-ttu-id="7f9bd-154">2</span><span class="sxs-lookup"><span data-stu-id="7f9bd-154">2</span></span>|<span data-ttu-id="7f9bd-155">LOG_BACKUP</span><span class="sxs-lookup"><span data-stu-id="7f9bd-155">LOG_BACKUP</span></span>|<span data-ttu-id="7f9bd-156">在截断事务日志前，需要进行日志备份。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-156">A log backup is required before the transaction log can be truncated.</span></span> <span data-ttu-id="7f9bd-157">（仅限完整恢复模式或大容量日志恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-157">(Full or bulk-logged recovery models only)</span></span><br /><br /> <span data-ttu-id="7f9bd-158">完成下一个日志备份后，一些日志空间可能变为可重复使用。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-158">When the next log backup is completed, some log space might become reusable.</span></span>|  
|<span data-ttu-id="7f9bd-159">3</span><span class="sxs-lookup"><span data-stu-id="7f9bd-159">3</span></span>|<span data-ttu-id="7f9bd-160">ACTIVE_BACKUP_OR_RESTORE</span><span class="sxs-lookup"><span data-stu-id="7f9bd-160">ACTIVE_BACKUP_OR_RESTORE</span></span>|<span data-ttu-id="7f9bd-161">数据备份或还原正在进行（所有恢复模式）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-161">A data backup or a restore is in progress (all recovery models).</span></span><br /><br /> <span data-ttu-id="7f9bd-162">如果数据备份阻止了日志截断，则取消备份操作可能有助于解决备份直接导致的此问题。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-162">If a data backup is preventing log truncation, canceling the backup operation might help the immediate problem.</span></span>|  
|<span data-ttu-id="7f9bd-163">4</span><span class="sxs-lookup"><span data-stu-id="7f9bd-163">4</span></span>|<span data-ttu-id="7f9bd-164">ACTIVE_TRANSACTION</span><span class="sxs-lookup"><span data-stu-id="7f9bd-164">ACTIVE_TRANSACTION</span></span>|<span data-ttu-id="7f9bd-165">事务处于活动状态（所有恢复模式）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-165">A transaction is active (all recovery models).</span></span><br /><br /> <span data-ttu-id="7f9bd-166">一个长时间运行的事务可能存在于日志备份的开头。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-166">A long-running transaction might exist at the start of the log backup.</span></span> <span data-ttu-id="7f9bd-167">在这种情况下，可能需要进行另一个日志备份才能释放空间。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-167">In this case, freeing the space might require another log backup.</span></span> <span data-ttu-id="7f9bd-168">请注意，长时间运行的事务将阻止所有恢复模式下的日志截断，包括简单恢复模式，在该模式下，事务日志通常在每个自动检查点上进行截断。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-168">Note that a long-running transactions prevent log truncation under all recovery models, including the simple recovery model, under which the transaction log is generally truncated on each automatic checkpoint.</span></span><br /><br /> <span data-ttu-id="7f9bd-169">延迟事务。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-169">A transaction is deferred.</span></span> <span data-ttu-id="7f9bd-170">“延迟的事务  ”是有效的活动事务，因为某些资源不可用，其回滚受阻。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-170">A *deferred transaction* is effectively an active transaction whose rollback is blocked because of some unavailable resource.</span></span> <span data-ttu-id="7f9bd-171">有关导致事务延迟的原因以及如何使它们摆脱延迟状态的信息，请参阅[延迟的事务 (SQL Server)](../backup-restore/deferred-transactions-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-171">For information about the causes of deferred transactions and how to move them out of the deferred state, see [Deferred Transactions &#40;SQL Server&#41;](../backup-restore/deferred-transactions-sql-server.md).</span></span> <br /><br /><span data-ttu-id="7f9bd-172">长时间运行的事务也可能会填满 tempdb 的事务日志。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-172">Long-running transactions might also fill up tempdb's transaction log.</span></span> <span data-ttu-id="7f9bd-173">Tempdb 由用户事务隐式用于内部对象，例如用于排序的工作表、用于哈希的工作文件、游标工作表，以及行版本控制。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-173">Tempdb is used implicitly by user transactions for internal objects such as work tables for sorting, work files for hashing, cursor work tables, and row versioning.</span></span> <span data-ttu-id="7f9bd-174">即使用户事务只包括读取数据 () 选择查询，也可以在 "用户事务" 下创建和使用内部对象。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-174">Even if the user transaction includes only reading data (SELECT queries), internal objects may be created and used under user transactions.</span></span> <span data-ttu-id="7f9bd-175">然后就会填充 tempdb 事务日志。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-175">Then the tempdb transaction log can be filled.</span></span>|  
|<span data-ttu-id="7f9bd-176">5</span><span class="sxs-lookup"><span data-stu-id="7f9bd-176">5</span></span>|<span data-ttu-id="7f9bd-177">DATABASE_MIRRORING</span><span class="sxs-lookup"><span data-stu-id="7f9bd-177">DATABASE_MIRRORING</span></span>|<span data-ttu-id="7f9bd-178">数据库镜像暂停，或者在高性能模式下，镜像数据库明显滞后于主体数据库。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-178">Database mirroring is paused, or under high-performance mode, the mirror database is significantly behind the principal database.</span></span> <span data-ttu-id="7f9bd-179">（仅限完整恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-179">(Full recovery model only)</span></span><br /><br /> <span data-ttu-id="7f9bd-180">有关详细信息，请参阅[数据库镜像 (SQL Server)](../../database-engine/database-mirroring/database-mirroring-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-180">For more information, see [Database Mirroring &#40;SQL Server&#41;](../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span></span>|  
|<span data-ttu-id="7f9bd-181">6</span><span class="sxs-lookup"><span data-stu-id="7f9bd-181">6</span></span>|<span data-ttu-id="7f9bd-182">复制</span><span class="sxs-lookup"><span data-stu-id="7f9bd-182">REPLICATION</span></span>|<span data-ttu-id="7f9bd-183">在事务复制过程中，与发布相关的事务仍未传递到分发数据库。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-183">During transactional replications, transactions relevant to the publications are still undelivered to the distribution database.</span></span> <span data-ttu-id="7f9bd-184">（仅限完整恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-184">(Full recovery model only)</span></span><br /><br /> <span data-ttu-id="7f9bd-185">有关事务复制的信息，请参阅 [SQL Server Replication](../../relational-databases/replication/sql-server-replication.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-185">For information about transactional replication, see [SQL Server Replication](../../relational-databases/replication/sql-server-replication.md).</span></span>|  
|<span data-ttu-id="7f9bd-186">7</span><span class="sxs-lookup"><span data-stu-id="7f9bd-186">7</span></span>|<span data-ttu-id="7f9bd-187">DATABASE_SNAPSHOT_CREATION</span><span class="sxs-lookup"><span data-stu-id="7f9bd-187">DATABASE_SNAPSHOT_CREATION</span></span>|<span data-ttu-id="7f9bd-188">正在创建数据库快照。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-188">A database snapshot is being created.</span></span> <span data-ttu-id="7f9bd-189">（所有恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-189">(All recovery models)</span></span><br /><br /> <span data-ttu-id="7f9bd-190">这是日志截断延迟的常见原因，通常也是主要原因。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-190">This is a routine, and typically brief, cause of delayed log truncation.</span></span>|  
|<span data-ttu-id="7f9bd-191">8</span><span class="sxs-lookup"><span data-stu-id="7f9bd-191">8</span></span>|<span data-ttu-id="7f9bd-192">LOG_SCAN</span><span class="sxs-lookup"><span data-stu-id="7f9bd-192">LOG_SCAN</span></span>|<span data-ttu-id="7f9bd-193">发生日志扫描。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-193">A log scan is occurring.</span></span> <span data-ttu-id="7f9bd-194">（所有恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-194">(All recovery models)</span></span><br /><br /> <span data-ttu-id="7f9bd-195">这是日志截断延迟的常见原因，通常也是主要原因。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-195">This is a routine, and typically brief, cause of delayed log truncation.</span></span>|  
|<span data-ttu-id="7f9bd-196">9</span><span class="sxs-lookup"><span data-stu-id="7f9bd-196">9</span></span>|<span data-ttu-id="7f9bd-197">AVAILABILITY_REPLICA</span><span class="sxs-lookup"><span data-stu-id="7f9bd-197">AVAILABILITY_REPLICA</span></span>|<span data-ttu-id="7f9bd-198">可用性组的辅助副本正将此数据库的事务日志记录应用到相应的辅助数据库。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-198">A secondary replica of an availability group is applying transaction log records of this database to a corresponding secondary database.</span></span> <span data-ttu-id="7f9bd-199">（完整恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-199">(Full recovery model)</span></span><br /><br /> <span data-ttu-id="7f9bd-200">有关详细信息，请参阅[SQL Server&#41;AlwaysOn 可用性组概述 &#40;](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-200">For more information, see [Overview of AlwaysOn Availability Groups &#40;SQL Server&#41;](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).</span></span>|  
|<span data-ttu-id="7f9bd-201">10</span><span class="sxs-lookup"><span data-stu-id="7f9bd-201">10</span></span>|-|<span data-ttu-id="7f9bd-202">仅供内部使用</span><span class="sxs-lookup"><span data-stu-id="7f9bd-202">For internal use only</span></span>|  
|<span data-ttu-id="7f9bd-203">11</span><span class="sxs-lookup"><span data-stu-id="7f9bd-203">11</span></span>|-|<span data-ttu-id="7f9bd-204">仅供内部使用</span><span class="sxs-lookup"><span data-stu-id="7f9bd-204">For internal use only</span></span>|  
|<span data-ttu-id="7f9bd-205">12</span><span class="sxs-lookup"><span data-stu-id="7f9bd-205">12</span></span>|-|<span data-ttu-id="7f9bd-206">仅供内部使用</span><span class="sxs-lookup"><span data-stu-id="7f9bd-206">For internal use only</span></span>|  
|<span data-ttu-id="7f9bd-207">13</span><span class="sxs-lookup"><span data-stu-id="7f9bd-207">13</span></span>|<span data-ttu-id="7f9bd-208">OLDEST_PAGE</span><span class="sxs-lookup"><span data-stu-id="7f9bd-208">OLDEST_PAGE</span></span>|<span data-ttu-id="7f9bd-209">如果将数据库配置为使用间接检查点，数据库中最早的页可能比检查点 LSN 早。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-209">If a database is configured to use indirect checkpoints, the oldest page on the database might be older than the checkpoint LSN.</span></span> <span data-ttu-id="7f9bd-210">在这种情况下，最早的页可以延迟日志截断。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-210">In this case, the oldest page can delay log truncation.</span></span> <span data-ttu-id="7f9bd-211">（所有恢复模式）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-211">(All recovery models)</span></span><br /><br /> <span data-ttu-id="7f9bd-212">有关间接检查点的信息，请参阅[数据库检查点 (SQL Server)](database-checkpoints-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-212">For information about indirect checkpoints, see [Database Checkpoints &#40;SQL Server&#41;](database-checkpoints-sql-server.md).</span></span>|  
|<span data-ttu-id="7f9bd-213">14</span><span class="sxs-lookup"><span data-stu-id="7f9bd-213">14</span></span>|<span data-ttu-id="7f9bd-214">OTHER_TRANSIENT</span><span class="sxs-lookup"><span data-stu-id="7f9bd-214">OTHER_TRANSIENT</span></span>|<span data-ttu-id="7f9bd-215">当前未使用此值。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-215">This value is currently not used.</span></span>|  
|<span data-ttu-id="7f9bd-216">16</span><span class="sxs-lookup"><span data-stu-id="7f9bd-216">16</span></span>|<span data-ttu-id="7f9bd-217">XTP_CHECKPOINT</span><span class="sxs-lookup"><span data-stu-id="7f9bd-217">XTP_CHECKPOINT</span></span>|<span data-ttu-id="7f9bd-218">当数据库具有内存优化的文件组时，可能不会截断事务日志，直至触发自动 [!INCLUDE[hek_2](../../includes/hek-2-md.md)] 检查点（每当发生 512 MB 的日志增长就会出现这种情况）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-218">When a database has a memory-optimized filegroup, the transaction log may not truncate until automatic [!INCLUDE[hek_2](../../includes/hek-2-md.md)] checkpoint is triggered (which happens at every 512 MB of log growth).</span></span><br /><br /> <span data-ttu-id="7f9bd-219">注意：若要在 512 MB 大小之前截断事务日志，请针对相关数据库手动触发检查点命令。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-219">Note: To truncate transaction log before 512 MB size, fire the Checkpoint command manually against the database in question.</span></span>|  
  
##  <a name="operations-that-can-be-minimally-logged"></a><a name="MinimallyLogged"></a><span data-ttu-id="7f9bd-220">可按最小方式记录的操作</span><span class="sxs-lookup"><span data-stu-id="7f9bd-220">Operations That Can Be Minimally Logged</span></span>  
 <span data-ttu-id="7f9bd-221">最小日志记录是指只记录在不支持时间点恢复的情况下恢复事务所需的信息。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-221">*Minimal logging* involves logging only the information that is required to recover the transaction without supporting point-in-time recovery.</span></span> <span data-ttu-id="7f9bd-222">本主题介绍在大容量日志恢复模式下（以及简单恢复模式下）按最小方式记录、但在运行备份时例外的操作。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-222">This topic identifies the operations that are minimally logged under the bulk-logged recovery model (as well as under the simple recovery model, except when a backup is running).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7f9bd-223">内存优化表不支持最小日志记录。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-223">Minimal logging is not supported for memory-optimized tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="7f9bd-224">在完整恢复模式下，所有大容量操作都将被完整地记录下来。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-224">Under the full recovery model, all bulk operations are fully logged.</span></span> <span data-ttu-id="7f9bd-225">但是，可以通过将数据库暂时切换到用于大容量操作的大容量日志恢复模式，最小化一组大容量操作的日志记录。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-225">However, you can minimize logging for a set of bulk operations by switching the database to the bulk-logged recovery model temporarily for bulk operations.</span></span> <span data-ttu-id="7f9bd-226">最小日志记录比完整日志记录更为有效，并在大容量事务期间，降低了大规模大容量操作填满可用的事务日志空间的可能性。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-226">Minimal logging is more efficient than full logging, and it reduces the possibility of a large-scale bulk operation filling the available transaction log space during a bulk transaction.</span></span> <span data-ttu-id="7f9bd-227">不过，如果在最小日志记录生效时数据库损坏或丢失，则无法将数据库恢复到故障点。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-227">However, if the database is damaged or lost when minimal logging is in effect, you cannot recover the database to the point of failure.</span></span>  
  
 <span data-ttu-id="7f9bd-228">下列操作在完整恢复模式下执行完整日志记录，而在简单和大容量日志恢复模式下按最小方式记录日志：</span><span class="sxs-lookup"><span data-stu-id="7f9bd-228">The following operations, which are fully logged under the full recovery model, are minimally logged under the simple and bulk-logged recovery model:</span></span>  
  
-   <span data-ttu-id="7f9bd-229">批量导入操作（[bcp](../../tools/bcp-utility.md)、[BULK INSERT](/sql/t-sql/statements/bulk-insert-transact-sql) 和 [INSERT...SELECT](/sql/t-sql/statements/insert-transact-sql)）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-229">Bulk import operations ([bcp](../../tools/bcp-utility.md), [BULK INSERT](/sql/t-sql/statements/bulk-insert-transact-sql), and [INSERT... SELECT](/sql/t-sql/statements/insert-transact-sql)).</span></span> <span data-ttu-id="7f9bd-230">有关在何时对大容量导入表按最小方式进行记录的详细信息，请参阅 [Prerequisites for Minimal Logging in Bulk Import](../import-export/prerequisites-for-minimal-logging-in-bulk-import.md)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-230">For more information about when bulk import into a table is minimally logged, see [Prerequisites for Minimal Logging in Bulk Import](../import-export/prerequisites-for-minimal-logging-in-bulk-import.md).</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="7f9bd-231">启用事务复制时，将完全记录 BULK INSERT 操作，即使处于大容量日志恢复模式下。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-231">When transactional replication is enabled, BULK INSERT operations are fully logged even under the Bulk Logged recovery model.</span></span>  
  
-   <span data-ttu-id="7f9bd-232">SELECT [INTO](/sql/t-sql/queries/select-into-clause-transact-sql)操作。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-232">SELECT [INTO](/sql/t-sql/queries/select-into-clause-transact-sql) operations.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="7f9bd-233">启用事务复制时，将完全记录 SELECT INTO 操作，即使处于大容量日志恢复模式下。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-233">When transactional replication is enabled, SELECT INTO operations are fully logged even under the Bulk Logged recovery model.</span></span>  
  
-   <span data-ttu-id="7f9bd-234">插入或追加新数据时，使用 [UPDATE](/sql/t-sql/queries/update-transact-sql) 语句中的 .WRITE 子句部分更新到大型值数据类型。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-234">Partial updates to large value data types, using the .WRITE clause in the [UPDATE](/sql/t-sql/queries/update-transact-sql) statement when inserting or appending new data.</span></span> <span data-ttu-id="7f9bd-235">注意，在更新现有值时没有使用最小日志记录。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-235">Note that minimal logging is not used when existing values are updated.</span></span> <span data-ttu-id="7f9bd-236">有关大型值数据类型的详细信息，请参阅[数据类型 (Transact-SQL)](/sql/t-sql/data-types/data-types-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-236">For more information about large value data types, see [Data Types &#40;Transact-SQL&#41;](/sql/t-sql/data-types/data-types-transact-sql).</span></span>  
  
-   <span data-ttu-id="7f9bd-237">[WRITETEXT](/sql/t-sql/queries/writetext-transact-sql)在[UPDATETEXT](/sql/t-sql/queries/updatetext-transact-sql) `text` 、 `ntext` 和数据类型列中插入或追加新数据时，WRITETEXT 和 UPDATETEXT 语句 `image` 。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-237">[WRITETEXT](/sql/t-sql/queries/writetext-transact-sql) and [UPDATETEXT](/sql/t-sql/queries/updatetext-transact-sql) statements when inserting or appending new data into the `text`, `ntext`, and `image` data type columns.</span></span> <span data-ttu-id="7f9bd-238">注意，在更新现有值时没有使用最小日志记录。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-238">Note that minimal logging is not used when existing values are updated.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="7f9bd-239">不推荐使用 WRITETEXT 语句和 UPDATETEXT 语句，因此应该避免在新的应用程序中使用这些语句。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-239">The WRITETEXT and UPDATETEXT statements are deprecated, so you should avoid using them in new applications.</span></span>  
  
-   <span data-ttu-id="7f9bd-240">如果数据库设置为简单或大容量日志恢复模式，则无论是脱机还是联机执行操作，都会按最小方式记录一些索引 DDL 操作。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-240">If the database is set to the simple or bulk-logged recovery model, some index DDL operations are minimally logged whether the operation is executed offline or online.</span></span> <span data-ttu-id="7f9bd-241">按最小方式记录的索引操作如下：</span><span class="sxs-lookup"><span data-stu-id="7f9bd-241">The minimally logged index operations are as follows:</span></span>  
  
    -   <span data-ttu-id="7f9bd-242">[CREATE INDEX](/sql/t-sql/statements/create-index-transact-sql) 操作（包括索引视图）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-242">[CREATE INDEX](/sql/t-sql/statements/create-index-transact-sql) operations (including indexed views).</span></span>  
  
    -   <span data-ttu-id="7f9bd-243">[ALTER INDEX](/sql/t-sql/statements/alter-index-transact-sql) REBUILD 或 DBCC DBREINDEX 操作。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-243">[ALTER INDEX](/sql/t-sql/statements/alter-index-transact-sql) REBUILD or DBCC DBREINDEX operations.</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="7f9bd-244">不推荐使用 DBCC DBREINDEX 语句，因此应该避免在新的应用程序中使用该语句。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-244">The DBCC DBREINDEX statement is deprecated so you should avoid using it in new applications.</span></span>  
  
    -   <span data-ttu-id="7f9bd-245">DROP INDEX 新堆重新生成（如果适用）。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-245">DROP INDEX new heap rebuild (if applicable).</span></span>  
  
        > [!NOTE]  
        >  <span data-ttu-id="7f9bd-246">[DROP INDEX](/sql/t-sql/statements/drop-index-transact-sql) 操作期间将始终完整记录索引页的释放操作。</span><span class="sxs-lookup"><span data-stu-id="7f9bd-246">Index page deallocation during a [DROP INDEX](/sql/t-sql/statements/drop-index-transact-sql) operation is always fully logged.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="7f9bd-247">相关任务</span><span class="sxs-lookup"><span data-stu-id="7f9bd-247">Related Tasks</span></span>  
 `Managing the transaction log`  
  
-   [<span data-ttu-id="7f9bd-248">管理事务日志文件的大小</span><span class="sxs-lookup"><span data-stu-id="7f9bd-248">Manage the Size of the Transaction Log File</span></span>](manage-the-size-of-the-transaction-log-file.md)  
  
-   [<span data-ttu-id="7f9bd-249">解决事务日志已满的问题（SQL Server 错误 9002）</span><span class="sxs-lookup"><span data-stu-id="7f9bd-249">Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;</span></span>](troubleshoot-a-full-transaction-log-sql-server-error-9002.md)  
  
 <span data-ttu-id="7f9bd-250">**备份事务日志（完整恢复模式）**</span><span class="sxs-lookup"><span data-stu-id="7f9bd-250">**Backing Up the Transaction Log (Full Recovery Model)**</span></span>  
  
-   [<span data-ttu-id="7f9bd-251">备份事务日志 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7f9bd-251">Back Up a Transaction Log &#40;SQL Server&#41;</span></span>](../backup-restore/back-up-a-transaction-log-sql-server.md)  
  
 <span data-ttu-id="7f9bd-252">**还原事务日志（完整恢复模式）**</span><span class="sxs-lookup"><span data-stu-id="7f9bd-252">**Restoring the Transaction Log (Full Recovery Model)**</span></span>  
  
-  [<span data-ttu-id="7f9bd-253">还原事务日志备份</span><span class="sxs-lookup"><span data-stu-id="7f9bd-253">Restore a Transaction Log Backup</span></span>](../backup-restore/restore-a-transaction-log-backup-sql-server.md)   
  
## <a name="see-also"></a><span data-ttu-id="7f9bd-254">另请参阅</span><span class="sxs-lookup"><span data-stu-id="7f9bd-254">See Also</span></span>  
 <span data-ttu-id="7f9bd-255">[控制事务持续性](control-transaction-durability.md) </span><span class="sxs-lookup"><span data-stu-id="7f9bd-255">[Control Transaction Durability](control-transaction-durability.md) </span></span>  
 <span data-ttu-id="7f9bd-256">[在大容量导入中按最小方式记录日志的前提条件](../import-export/prerequisites-for-minimal-logging-in-bulk-import.md) </span><span class="sxs-lookup"><span data-stu-id="7f9bd-256">[Prerequisites for Minimal Logging in Bulk Import](../import-export/prerequisites-for-minimal-logging-in-bulk-import.md) </span></span>  
 <span data-ttu-id="7f9bd-257">[SQL Server 数据库的备份和还原](../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span><span class="sxs-lookup"><span data-stu-id="7f9bd-257">[Back Up and Restore of SQL Server Databases](../backup-restore/back-up-and-restore-of-sql-server-databases.md) </span></span>  
 <span data-ttu-id="7f9bd-258">[数据库检查点 (SQL Server)](database-checkpoints-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="7f9bd-258">[Database Checkpoints &#40;SQL Server&#41;](database-checkpoints-sql-server.md) </span></span>  
 <span data-ttu-id="7f9bd-259">[查看或更改数据库的属性](../databases/view-or-change-the-properties-of-a-database.md) </span><span class="sxs-lookup"><span data-stu-id="7f9bd-259">[View or Change the Properties of a Database](../databases/view-or-change-the-properties-of-a-database.md) </span></span>  
 [<span data-ttu-id="7f9bd-260">恢复模式 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="7f9bd-260">Recovery Models &#40;SQL Server&#41;</span></span>](../backup-restore/recovery-models-sql-server.md)  
  
  

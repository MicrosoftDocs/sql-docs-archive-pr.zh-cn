---
title: 数据库检查点 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 10/13/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: supportability
ms.topic: conceptual
helpviewer_keywords:
- automatic checkpoints
- transaction logs [SQL Server], checkpoints
- logs [SQL Server], active
- pages [SQL Server], dirty
- MinLSN
- checkpoints [SQL Server]
- pages [SQL Server], flushing
- dirty pages
- transaction logs [SQL Server], active logs
- recovery interval option [SQL Server]
- buffer cache [SQL Server]
- logs [SQL Server], checkpoints
- Minimum Recovery LSN
- flushing pages
- active logs
ms.assetid: 98a80238-7409-4708-8a7d-5defd9957185
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 5776d4a23223637c50ac40098fa44342d5cd94a9
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87580736"
---
# <a name="database-checkpoints-sql-server"></a><span data-ttu-id="e645a-102">数据库检查点 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e645a-102">Database Checkpoints (SQL Server)</span></span>
  <span data-ttu-id="e645a-103">本节提供 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库检查点的概述。</span><span class="sxs-lookup"><span data-stu-id="e645a-103">This topic provides an overview of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database checkpoints.</span></span> <span data-ttu-id="e645a-104"> “检查点”会创建一个已知的正常点，在意外关闭或崩溃后进行恢复的过程中， [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 可以从该点开始应用日志中所包含的更改。</span><span class="sxs-lookup"><span data-stu-id="e645a-104">A *checkpoint* creates a known good point from which the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] can start applying changes contained in the log during recovery after an unexpected shutdown or crash.</span></span>  
  
  
##  <a name="overview-of-checkpoints"></a><a name="Overview"></a><span data-ttu-id="e645a-105">检查点概述</span><span class="sxs-lookup"><span data-stu-id="e645a-105">Overview of Checkpoints</span></span>  
 <span data-ttu-id="e645a-106">出于性能方面的考虑，[!INCLUDE[ssDE](../../includes/ssde-md.md)] 对内存（缓冲区缓存）中的数据库页进行修改，但在每次更改后不将这些页写入磁盘。</span><span class="sxs-lookup"><span data-stu-id="e645a-106">For performance reasons, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] performs modifications to database pages in memory-in the buffer cache-and does not write these pages to disk after every change.</span></span> <span data-ttu-id="e645a-107">相反， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 定期发出对每个数据库的检查点命令。</span><span class="sxs-lookup"><span data-stu-id="e645a-107">Rather, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] periodically issues a checkpoint on each database.</span></span> <span data-ttu-id="e645a-108">\*\* “检查点”将当前内存中已修改的页（称为“脏页” \*\*）和事务日志信息从内存写入磁盘，并记录有关事务日志的信息。</span><span class="sxs-lookup"><span data-stu-id="e645a-108">A *checkpoint* writes the current in-memory modified pages (known as *dirty pages*) and transaction log information from memory to disk and, also, records information about the transaction log.</span></span>  
  
 <span data-ttu-id="e645a-109">[!INCLUDE[ssDE](../../includes/ssde-md.md)] 支持几种类型的检查点：自动、间接、手动和内部。</span><span class="sxs-lookup"><span data-stu-id="e645a-109">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] supports several types of checkpoints: automatic, indirect, manual, and internal.</span></span> <span data-ttu-id="e645a-110">下表总结了检查点类型。</span><span class="sxs-lookup"><span data-stu-id="e645a-110">The following table summarizes the types of checkpoints.</span></span>  
  
|<span data-ttu-id="e645a-111">名称</span><span class="sxs-lookup"><span data-stu-id="e645a-111">Name</span></span>|[!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="e645a-112">接口</span><span class="sxs-lookup"><span data-stu-id="e645a-112">Interface</span></span>|<span data-ttu-id="e645a-113">说明</span><span class="sxs-lookup"><span data-stu-id="e645a-113">Description</span></span>|  
|----------|----------------------------------|-----------------|  
|<span data-ttu-id="e645a-114">自动</span><span class="sxs-lookup"><span data-stu-id="e645a-114">Automatic</span></span>|<span data-ttu-id="e645a-115">EXEC sp_configure **" `recovery interval` "、" *`seconds`* "**</span><span class="sxs-lookup"><span data-stu-id="e645a-115">EXEC sp_configure **'`recovery interval`','*`seconds`*'**</span></span>|<span data-ttu-id="e645a-116">自动在后台发出，以满足服务器配置选项建议的时间上限 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="e645a-116">Issued automatically in the background to meet the upper time limit suggested by the `recovery interval` server configuration option.</span></span> <span data-ttu-id="e645a-117">运行自动检查点直到完成。</span><span class="sxs-lookup"><span data-stu-id="e645a-117">Automatic checkpoints run to completion.</span></span>  <span data-ttu-id="e645a-118">基于未完成的写操作数和 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 是否检测到写入滞后时间超过 20 毫秒的写操作增加，来调控自动检查点。</span><span class="sxs-lookup"><span data-stu-id="e645a-118">Automatic checkpoints are throttled based on the number of outstanding writes and whether the [!INCLUDE[ssDE](../../includes/ssde-md.md)] detects an increase in write latency above 20 milliseconds.</span></span><br /><br /> <span data-ttu-id="e645a-119">有关详细信息，请参阅 [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)。</span><span class="sxs-lookup"><span data-stu-id="e645a-119">For more information, see [Configure the recovery interval Server Configuration Option](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md).</span></span>|  
|<span data-ttu-id="e645a-120">间接</span><span class="sxs-lookup"><span data-stu-id="e645a-120">Indirect</span></span>|<span data-ttu-id="e645a-121">更改数据库 .。。将 TARGET_RECOVERY_TIME **=** _target_recovery_time_设置为 {秒 &#124; 分钟}</span><span class="sxs-lookup"><span data-stu-id="e645a-121">ALTER DATABASE ... SET TARGET_RECOVERY_TIME **=**_target_recovery_time_ { SECONDS &#124; MINUTES }</span></span>|<span data-ttu-id="e645a-122">在后台发出，以满足给定数据库的用户指定的目标恢复时间要求。</span><span class="sxs-lookup"><span data-stu-id="e645a-122">Issued in the background to meet a user-specified target recovery time for a given database.</span></span> <span data-ttu-id="e645a-123">默认目标恢复时间为 0，这将导致对数据库使用自动检查点试探方法。</span><span class="sxs-lookup"><span data-stu-id="e645a-123">The default target recovery time is 0, which causes automatic checkpoint heuristics to be used on the database.</span></span> <span data-ttu-id="e645a-124">如果您使用 ALTER DATABASE 并将 TARGET_RECOVERY_TIME 设置为 >0，则将使用此值替代为服务器实例指定的恢复间隔。</span><span class="sxs-lookup"><span data-stu-id="e645a-124">If you have used ALTER DATABASE to set TARGET_RECOVERY_TIME to >0, this value is used, rather than the recovery interval specified for the server instance.</span></span><br /><br /> <span data-ttu-id="e645a-125">有关详细信息，请参阅 [更改数据库的目标恢复时间 (SQL Server)](change-the-target-recovery-time-of-a-database-sql-server.md)服务器配置选项。</span><span class="sxs-lookup"><span data-stu-id="e645a-125">For more information, see [Change the Target Recovery Time of a Database &#40;SQL Server&#41;](change-the-target-recovery-time-of-a-database-sql-server.md).</span></span>|  
|<span data-ttu-id="e645a-126">手动</span><span class="sxs-lookup"><span data-stu-id="e645a-126">Manual</span></span>|<span data-ttu-id="e645a-127">CHECKPOINT [ *checkpoint_duration* ]</span><span class="sxs-lookup"><span data-stu-id="e645a-127">CHECKPOINT [ *checkpoint_duration* ]</span></span>|<span data-ttu-id="e645a-128">执行 [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT 命令时发出。</span><span class="sxs-lookup"><span data-stu-id="e645a-128">Issued when you execute a [!INCLUDE[tsql](../../includes/tsql-md.md)] CHECKPOINT command.</span></span> <span data-ttu-id="e645a-129">在连接的当前数据库中执行手动检查点操作。</span><span class="sxs-lookup"><span data-stu-id="e645a-129">The manual checkpoint occurs in the current database for your connection.</span></span> <span data-ttu-id="e645a-130">默认情况下，手动检查点运行至完成。</span><span class="sxs-lookup"><span data-stu-id="e645a-130">By default, manual checkpoints run to completion.</span></span> <span data-ttu-id="e645a-131">调控方式与自动检查点的调控方式相同。</span><span class="sxs-lookup"><span data-stu-id="e645a-131">Throttling works the same way as for automatic checkpoints.</span></span>  <span data-ttu-id="e645a-132">（可选） *checkpoint_duration* 参数指定完成检查点所需的时间（秒）。</span><span class="sxs-lookup"><span data-stu-id="e645a-132">Optionally, the *checkpoint_duration* parameter specifies a requested amount of time, in seconds, for the checkpoint to complete.</span></span><br /><br /> <span data-ttu-id="e645a-133">有关详细信息，请参阅 [检查点 (Transact-SQL)](/sql/t-sql/language-elements/checkpoint-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="e645a-133">For more information, see [CHECKPOINT &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/checkpoint-transact-sql).</span></span>|  
|<span data-ttu-id="e645a-134">内部</span><span class="sxs-lookup"><span data-stu-id="e645a-134">Internal</span></span>|<span data-ttu-id="e645a-135">无。</span><span class="sxs-lookup"><span data-stu-id="e645a-135">None.</span></span>|<span data-ttu-id="e645a-136">由各种服务器操作（如备份和数据库快照创建）发出，以确保磁盘映像与日志的当前状态匹配。</span><span class="sxs-lookup"><span data-stu-id="e645a-136">Issued by various server operations such as backup and database-snapshot creation to guarantee that disk images match the current state of the log.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="e645a-137">`-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 高级设置选项允许数据库管理员基于某些检查点类型 I/O 子系统的吞吐量来调控检查点 I/O 行为。</span><span class="sxs-lookup"><span data-stu-id="e645a-137">The `-k`[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] advanced setup option enables a database administrator to throttle checkpoint I/O behavior based on the throughput of the I/O subsystem for some types of checkpoints.</span></span> <span data-ttu-id="e645a-138">`-k`设置选项适用于自动检查点和任何其他调控的手动和内部检查点。</span><span class="sxs-lookup"><span data-stu-id="e645a-138">The `-k` setup option applies to automatic checkpoints and any otherwise unthrottled manual and internal checkpoints.</span></span>  
  
 <span data-ttu-id="e645a-139">对于自动、手动和内部检查点，在数据库恢复期间只有在最新检查点后所做的修改需要前滚。</span><span class="sxs-lookup"><span data-stu-id="e645a-139">For automatic, manual, and internal checkpoints, only modifications made after the latest checkpoint need to be rolled forward during database recovery.</span></span> <span data-ttu-id="e645a-140">这将减少恢复数据库所需的时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-140">This reduces the time required to recover a database.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="e645a-141">长时间运行的未提交的事务会增加所有类型的检查点的恢复时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-141">Long-running uncommitted transactions increase recovery time for all types of checkpoints.</span></span>  
  
  
  
###  <a name="interaction-of-the-target_recovery_time-and-recovery-interval-options"></a><a name="InteractionBwnSettings"></a> <span data-ttu-id="e645a-142">TARGET_RECOVERY_TIME 和“recovery interval”选项的相互影响</span><span class="sxs-lookup"><span data-stu-id="e645a-142">Interaction of the TARGET_RECOVERY_TIME and 'recovery interval' Options</span></span>  
 <span data-ttu-id="e645a-143">下表总结了服务器范围**sp_configure " `recovery interval` "** 设置和数据库特定的 ALTER database .。。TARGET_RECOVERY_TIME 设置。</span><span class="sxs-lookup"><span data-stu-id="e645a-143">The following table summarizes the interaction between the server-wide **sp_configure'`recovery interval`'** setting and the database-specific ALTER DATABASE ... TARGET_RECOVERY_TIME setting.</span></span>  
  
|<span data-ttu-id="e645a-144">target_recovery_time</span><span class="sxs-lookup"><span data-stu-id="e645a-144">TARGET_RECOVERY_TIME</span></span>|<span data-ttu-id="e645a-145">'recovery interval'</span><span class="sxs-lookup"><span data-stu-id="e645a-145">'recovery interval'</span></span>|<span data-ttu-id="e645a-146">使用的检查点类型</span><span class="sxs-lookup"><span data-stu-id="e645a-146">Type of Checkpoint Used</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="e645a-147">0</span><span class="sxs-lookup"><span data-stu-id="e645a-147">0</span></span>|<span data-ttu-id="e645a-148">0</span><span class="sxs-lookup"><span data-stu-id="e645a-148">0</span></span>|<span data-ttu-id="e645a-149">目标恢复间隔为 1 分钟的自动检查点。</span><span class="sxs-lookup"><span data-stu-id="e645a-149">automatic checkpoints whose target recovery interval is 1 minute.</span></span>|  
|<span data-ttu-id="e645a-150">0</span><span class="sxs-lookup"><span data-stu-id="e645a-150">0</span></span>|<span data-ttu-id="e645a-151">>0</span><span class="sxs-lookup"><span data-stu-id="e645a-151">>0</span></span>|<span data-ttu-id="e645a-152">自动检查点，其目标恢复间隔由 **sp_configurerecovery interval** 选项的用户定义的设置指定。</span><span class="sxs-lookup"><span data-stu-id="e645a-152">Automatic checkpoints whose target recovery interval is specified by the user defined setting of the **sp_configurerecovery interval** option.</span></span>|  
|<span data-ttu-id="e645a-153">>0</span><span class="sxs-lookup"><span data-stu-id="e645a-153">>0</span></span>|<span data-ttu-id="e645a-154">不适用。</span><span class="sxs-lookup"><span data-stu-id="e645a-154">Not applicable.</span></span>|<span data-ttu-id="e645a-155">间接检查点，其目标恢复时间由 TARGET_RECOVERY_TIME 设置确定，以秒为单位。</span><span class="sxs-lookup"><span data-stu-id="e645a-155">Indirect checkpoints whose target recovery time is determined by the TARGET_RECOVERY_TIME setting, expressed in seconds.</span></span>|  
  
###  <a name="automatic-checkpoints"></a><a name="AutomaticChkpt"></a><span data-ttu-id="e645a-156">自动检查点</span><span class="sxs-lookup"><span data-stu-id="e645a-156">Automatic Checkpoints</span></span>  
 <span data-ttu-id="e645a-157">每当日志记录数达到 [!INCLUDE[ssDE](../../includes/ssde-md.md)] 其可以在服务器配置选项指定的时间内处理的估计值时，将发生自动检查点 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="e645a-157">An automatic checkpoint occurs each time that  the number of log records reaches the number the [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates it can process during the time specified in the `recovery interval` server configuration option.</span></span> <span data-ttu-id="e645a-158">在没有用户定义的目标恢复时间的每个数据库中， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 生成自动检查点。</span><span class="sxs-lookup"><span data-stu-id="e645a-158">In every database without a user-defined target recovery time, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] generates automatic checkpoints.</span></span> <span data-ttu-id="e645a-159">自动检查点的频率取决于 `recovery interval` advanced server 配置选项，该选项指定给定的服务器实例在系统重新启动期间用于恢复数据库的最长时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-159">The frequency of automatic checkpoints depends on the `recovery interval` advanced server configuration option, which specifies the maximum time that a given server instance should use to recover a database during a system restart.</span></span> <span data-ttu-id="e645a-160">[!INCLUDE[ssDE](../../includes/ssde-md.md)] 将估计它可在恢复间隔内处理的最大日志记录数。</span><span class="sxs-lookup"><span data-stu-id="e645a-160">The [!INCLUDE[ssDE](../../includes/ssde-md.md)] estimates the maximum number of log records it can process within the recovery interval.</span></span> <span data-ttu-id="e645a-161">使用自动检查点的数据库达到此最大日志记录数后， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 将对该数据库发出一个检查点命令。</span><span class="sxs-lookup"><span data-stu-id="e645a-161">When a database that is using automatic checkpoints reaches this maximum number of log records, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] issues an checkpoint on the database.</span></span> <span data-ttu-id="e645a-162">自动检查点之间的时间间隔可以变化很大。</span><span class="sxs-lookup"><span data-stu-id="e645a-162">The time interval between automatic checkpoints can be highly variable.</span></span> <span data-ttu-id="e645a-163">具有大量事务工作负荷的数据库的检查点生成频率将高于主要用于只读操作的数据库的检查点生成频率。</span><span class="sxs-lookup"><span data-stu-id="e645a-163">A database with a substantial transaction workload will have more frequent checkpoints than a database that is used primarily for read-only operations.</span></span>  
  
 <span data-ttu-id="e645a-164">此外，在简单恢复模式下，如果日志填充 70％，则自动检查点还将排队。</span><span class="sxs-lookup"><span data-stu-id="e645a-164">Also, under the simple recovery model, an automatic checkpoint is also queued if the log becomes 70 percent full.</span></span>  
  
 <span data-ttu-id="e645a-165">在简单恢复模式下，除非某些因素延迟了日志截断，否则自动检查点将截断事务日志中没有使用的部分。</span><span class="sxs-lookup"><span data-stu-id="e645a-165">Under the simple recovery model, unless some factor is delaying log truncation, an automatic checkpoint truncates the unused section of the transaction log.</span></span> <span data-ttu-id="e645a-166">相反，在完整恢复模式或大容量日志恢复模式下，一旦建立了日志备份链，自动检查点将不导致日志截断。</span><span class="sxs-lookup"><span data-stu-id="e645a-166">In contrast, under the full and bulk-logged recovery models, once a log backup chain has been established, automatic checkpoints do not cause log truncation.</span></span> <span data-ttu-id="e645a-167">有关详细信息，请参阅 [事务日志 (SQL Server)](the-transaction-log-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="e645a-167">For more information, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="e645a-168">在系统崩溃后恢复给定数据库所需的时间主要取决于重做崩溃时的脏页所需的随机 I/O 量。</span><span class="sxs-lookup"><span data-stu-id="e645a-168">After a system crash, the length of time required to recover a given database is largely dependent on the amount of random I/O needed to redo pages that were dirty at the time of the crash.</span></span> <span data-ttu-id="e645a-169">这意味着该 `recovery interval` 设置是不可靠的。</span><span class="sxs-lookup"><span data-stu-id="e645a-169">This means that the `recovery interval` setting is unreliable.</span></span> <span data-ttu-id="e645a-170">它不能确定准确的恢复持续时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-170">It cannot determine an accurate recovery duration.</span></span> <span data-ttu-id="e645a-171">此外，正在执行自动检查点操作时，数据的常规 I/O 活动显著增加并且无法预测。</span><span class="sxs-lookup"><span data-stu-id="e645a-171">Furthermore, when an automatic checkpoint is in progress, the general I/O activity for data increases significantly and quite unpredictably.</span></span>  
  
  
####  <a name="impact-of-recovery-interval-on-recovery-performance"></a><a name="PerformanceImpact"></a><span data-ttu-id="e645a-172">恢复间隔对恢复性能的影响</span><span class="sxs-lookup"><span data-stu-id="e645a-172">Impact of Recovery Interval on Recovery Performance</span></span>  
 <span data-ttu-id="e645a-173">对于使用短事务 (OLTP) 系统进行联机事务处理， `recovery interval` 确定恢复时间的主要因素。</span><span class="sxs-lookup"><span data-stu-id="e645a-173">For an online transaction processing (OLTP) system using short transactions, `recovery interval` is the primary factor determining recovery time.</span></span> <span data-ttu-id="e645a-174">但是，该 `recovery interval` 选项不影响撤消长时间运行的事务所需的时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-174">However, the `recovery interval` option does not affect the time required to undo a long-running transaction.</span></span> <span data-ttu-id="e645a-175">恢复具有长时间运行事务的数据库所需的时间可能比选项中指定的时间长得多 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="e645a-175">Recovery of a database with a long-running transaction can take much longer than the specified in the `recovery interval` option.</span></span> <span data-ttu-id="e645a-176">例如，如果长时间运行的事务在服务器实例禁用前花费了两个小时来执行更新，则实际恢复所需的时间比 `recovery interval` 恢复长事务的值长。</span><span class="sxs-lookup"><span data-stu-id="e645a-176">For example, if a long-running transaction took two hours to perform updates before the server instance became disabled, the actual recovery takes considerably longer than the `recovery interval` value to recover the long transaction.</span></span> <span data-ttu-id="e645a-177">有关长时间运行的事务对恢复时间的影响的详细信息，请参阅 [事务日志 (SQL Server)](the-transaction-log-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="e645a-177">For more information about the impact of a long running transaction on recovery time, see [The Transaction Log &#40;SQL Server&#41;](the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="e645a-178">通常情况下，默认值提供了最佳恢复性能。</span><span class="sxs-lookup"><span data-stu-id="e645a-178">Typically, the default values provides optimal recovery performance.</span></span> <span data-ttu-id="e645a-179">但是，在以下情况下更改恢复间隔可能会提高性能：</span><span class="sxs-lookup"><span data-stu-id="e645a-179">However, changing the recovery interval might improve performance in the following circumstances:</span></span>  
  
-   <span data-ttu-id="e645a-180">如果例行恢复所需的时间在长时间运行的事务未回滚时超过 1 分钟。</span><span class="sxs-lookup"><span data-stu-id="e645a-180">If recovery routinely takes significantly longer than 1 minute when long-running transactions are not being rolled back.</span></span>  
  
-   <span data-ttu-id="e645a-181">如果您注意到频繁的检查点操作损害了数据库的性能。</span><span class="sxs-lookup"><span data-stu-id="e645a-181">If you notice that frequent checkpoints are impairing performance on a database.</span></span>  
  
 <span data-ttu-id="e645a-182">如果您决定增大 `recovery interval` 设置，我们建议一点一点逐渐增大该值并评估每次增大对恢复性能的影响。</span><span class="sxs-lookup"><span data-stu-id="e645a-182">If you decide to increase the `recovery interval` setting, we recommend increasing it gradually by small increments and evaluating the effect of each incremental increase on recovery performance.</span></span> <span data-ttu-id="e645a-183">此方法非常重要，因为在 `recovery interval` 设置增加时，数据库恢复需要更长的时间来完成。</span><span class="sxs-lookup"><span data-stu-id="e645a-183">This approach is important because as the `recovery interval` setting increases, database recovery takes that many times longer to complete.</span></span> <span data-ttu-id="e645a-184">例如，如果更改 `recovery interval` 10，则完成恢复所用的时间大约比设置为零时长10倍 `recovery interval` 。</span><span class="sxs-lookup"><span data-stu-id="e645a-184">For example, if you change `recovery interval` 10, recovery takes approximately 10 times longer to complete than when `recovery interval` is set to zero.</span></span>  
  
  
###  <a name="indirect-checkpoints"></a><a name="IndirectChkpt"></a><span data-ttu-id="e645a-185">间接检查点</span><span class="sxs-lookup"><span data-stu-id="e645a-185">Indirect Checkpoints</span></span>  
 <span data-ttu-id="e645a-186">间接检查点是 [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]中引入的新检查点类型，它提供自动检查点的可配置数据库级替代方法。</span><span class="sxs-lookup"><span data-stu-id="e645a-186">Indirect checkpoints, new in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)], provide a configurable database-level alternative to automatic checkpoints.</span></span> <span data-ttu-id="e645a-187">在系统崩溃时，间接检查点与自动检查点相比，恢复时间可能更短更可预测。</span><span class="sxs-lookup"><span data-stu-id="e645a-187">In the event of a system crash, indirect checkpoints provide potentially faster, more predictable recovery time than automatic checkpoints.</span></span> <span data-ttu-id="e645a-188">间接检查点具有以下优点：</span><span class="sxs-lookup"><span data-stu-id="e645a-188">Indirect checkpoints offer the following advantages:</span></span>  
  
-   <span data-ttu-id="e645a-189">为间接检查点配置的数据库上的联机事务工作负荷可能导致性能下降。</span><span class="sxs-lookup"><span data-stu-id="e645a-189">An online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="e645a-190">间接检查点确保损坏页的数量低于特定阙值，以便在目标恢复时间内完成数据库恢复。</span><span class="sxs-lookup"><span data-stu-id="e645a-190">Indirect checkpoints make sure that the number of dirty pages are below a certain threshold so that the database recovery completes within the target recovery time.</span></span> <span data-ttu-id="e645a-191">与利用损坏页数量的间接检查点相反，恢复间隔配置选项使用事务数量来确定恢复时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-191">The recovery interval configuration option uses the number of transactions to determine the recovery time as opposed to indirect checkpoints which makes use of number of dirty pages.</span></span> <span data-ttu-id="e645a-192">当在接收大量 DML 操作的数据库上启用了间接检查点时，后台写入线程可以开始积极刷新磁盘的脏缓冲区，以确保执行恢复所需的时间在数据库所设目标恢复时间范围内。</span><span class="sxs-lookup"><span data-stu-id="e645a-192">When indirect checkpoints are enabled on a database receiving a large number of DML operations, the background writer can start aggressively flushing dirty buffers to disk to ensure that the time required to perform recovery is within the target recovery time set of the database.</span></span> <span data-ttu-id="e645a-193">这可能造成某些系统上出现额外的 I/O 活动，如果磁盘子系统在 I/O 阙值之上或附近运行，则这会导致性能瓶颈。</span><span class="sxs-lookup"><span data-stu-id="e645a-193">This can cause additional I/O activity on certain systems which can contribute to a performance bottleneck if the disk subsystem is operating above or nearing the I/O threshold.</span></span>  
  
-   <span data-ttu-id="e645a-194">间接检查点使您可以通过控制 REDO 期间随机 I/O 的开销来可靠控制数据库恢复时间。</span><span class="sxs-lookup"><span data-stu-id="e645a-194">Indirect checkpoints enable you to reliably control database recovery time by factoring in the cost of random I/O during REDO.</span></span> <span data-ttu-id="e645a-195">这使服务器实例不超过给定数据库的恢复时间上限（长时间运行的事务导致过多 UNDO 时间时除外）。</span><span class="sxs-lookup"><span data-stu-id="e645a-195">This enables a server instance to stay within an upper-bound on recovery times for a given database (except when a long-running transaction causes excessive UNDO times).</span></span>  
  
-   <span data-ttu-id="e645a-196">间接检查点通过在后台不断地将脏页写入磁盘来减小与检查点有关的 I/O 蜂值。</span><span class="sxs-lookup"><span data-stu-id="e645a-196">Indirect checkpoints reduce checkpoint-related I/O spiking by continually writing dirty pages to disk in the background.</span></span>  
  
 <span data-ttu-id="e645a-197">但是，为间接检查点配置的数据库上的联机事务工作负荷可能导致性能下降。</span><span class="sxs-lookup"><span data-stu-id="e645a-197">However, an online transactional workload on a database that is configured for indirect checkpoints could experience performance degradation.</span></span> <span data-ttu-id="e645a-198">这是因为间接检查点使用的后台写入线程有时增加了服务器实例的总写入负荷。</span><span class="sxs-lookup"><span data-stu-id="e645a-198">This is because the background writer used by indirect checkpoint sometimes increases the total write load for a server instance.</span></span>  
  
  
###  <a name="internal-checkpoints"></a><a name="EventsCausingChkpt"></a><span data-ttu-id="e645a-199">内部检查点</span><span class="sxs-lookup"><span data-stu-id="e645a-199">Internal Checkpoints</span></span>  
 <span data-ttu-id="e645a-200">内部检查点由各种服务器组件生成，以确保磁盘映像与日志的当前状态匹配。</span><span class="sxs-lookup"><span data-stu-id="e645a-200">Internal Checkpoints are generated by various server components to guarantee that disk images match the current state of the log.</span></span> <span data-ttu-id="e645a-201">生成内部检查点以响应下列事件：</span><span class="sxs-lookup"><span data-stu-id="e645a-201">Internal checkpoint are generated in response to the following events:</span></span>  
  
-   <span data-ttu-id="e645a-202">已经使用 ALTER DATABASE 添加或删除了数据库文件。</span><span class="sxs-lookup"><span data-stu-id="e645a-202">Database files have been added or removed by using ALTER DATABASE.</span></span>  
  
-   <span data-ttu-id="e645a-203">进行了数据库备份。</span><span class="sxs-lookup"><span data-stu-id="e645a-203">A database backup is taken.</span></span>  
  
-   <span data-ttu-id="e645a-204">创建了数据库快照，不管 DBCC CHECK 是显式还是内部执行。</span><span class="sxs-lookup"><span data-stu-id="e645a-204">A database snapshot is created, whether explicitly or internally for DBCC CHECK.</span></span>  
  
-   <span data-ttu-id="e645a-205">执行了需要关闭数据库的活动。</span><span class="sxs-lookup"><span data-stu-id="e645a-205">An activity requiring a database shutdown is performed.</span></span> <span data-ttu-id="e645a-206">例如，AUTO_CLOSE 设置为 ON 并且关闭了数据库的最后一个用户连接，或者执行了需要重新启动数据库的数据库选项更改。</span><span class="sxs-lookup"><span data-stu-id="e645a-206">For example, AUTO_CLOSE is ON and the last user connection to the database is closed, or a database option change is made that requires a restart of the database.</span></span>  
  
-   <span data-ttu-id="e645a-207">通过停止 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) 服务停止了 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的实例。</span><span class="sxs-lookup"><span data-stu-id="e645a-207">An instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is stopped by stopping the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (MSSQLSERVER) service .</span></span> <span data-ttu-id="e645a-208">任一操作都会在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例的每个数据库中生成一个检查点。</span><span class="sxs-lookup"><span data-stu-id="e645a-208">Either action  causes a checkpoint in each database in the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>  
  
-   <span data-ttu-id="e645a-209">使 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 故障转移群集实例 (FCI) 脱机。</span><span class="sxs-lookup"><span data-stu-id="e645a-209">Bringing a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] failover cluster instance (FCI) offline.</span></span>  
  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="e645a-210">相关任务</span><span class="sxs-lookup"><span data-stu-id="e645a-210">Related Tasks</span></span>  
 <span data-ttu-id="e645a-211">**更改服务器实例的恢复间隔**</span><span class="sxs-lookup"><span data-stu-id="e645a-211">**To change the recovery interval on a server instance**</span></span>  
  
-   [<span data-ttu-id="e645a-212">Configure the recovery interval Server Configuration Option</span><span class="sxs-lookup"><span data-stu-id="e645a-212">Configure the recovery interval Server Configuration Option</span></span>](../../database-engine/configure-windows/configure-the-recovery-interval-server-configuration-option.md)  
  
 <span data-ttu-id="e645a-213">**配置数据库的间接检查点**</span><span class="sxs-lookup"><span data-stu-id="e645a-213">**To configure indirect checkpoints on a database**</span></span>  
  
-   [<span data-ttu-id="e645a-214">更改数据库的目标恢复时间 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e645a-214">Change the Target Recovery Time of a Database &#40;SQL Server&#41;</span></span>](change-the-target-recovery-time-of-a-database-sql-server.md)  
  
 <span data-ttu-id="e645a-215">**对数据库发出手动检查点命令**</span><span class="sxs-lookup"><span data-stu-id="e645a-215">**To issue a manual checkpoint on a database**</span></span>  
  
-   [<span data-ttu-id="e645a-216">检查点 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="e645a-216">CHECKPOINT &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/language-elements/checkpoint-transact-sql)  
  
  
##  <a name="related-content"></a><a name="RelatedContent"></a> <span data-ttu-id="e645a-217">相关内容</span><span class="sxs-lookup"><span data-stu-id="e645a-217">Related Content</span></span>  
  
-   <span data-ttu-id="e645a-218">[事务日志物理体系结构](https://technet.microsoft.com/library/ms179355.aspx) （ [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] 联机丛书中）</span><span class="sxs-lookup"><span data-stu-id="e645a-218">[Transaction Log Physical Architecture](https://technet.microsoft.com/library/ms179355.aspx) (in [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)] Books Oline)</span></span>  
  
  
## <a name="see-also"></a><span data-ttu-id="e645a-219">另请参阅</span><span class="sxs-lookup"><span data-stu-id="e645a-219">See Also</span></span>  
 [<span data-ttu-id="e645a-220">事务日志 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e645a-220">The Transaction Log &#40;SQL Server&#41;</span></span>](the-transaction-log-sql-server.md)  
  
  

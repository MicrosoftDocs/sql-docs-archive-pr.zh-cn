---
title: 诊断记录和字段 |Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- header records [ODBC]
- SQL Server Native Client ODBC driver, errors
- messages [ODBC], diagnostic records
- ODBC error handling, diagnostic records
- SQLGetDiagField function
- diagnostic records [ODBC]
- errors [ODBC], diagnostic records
- fields [ODBC]
- status information [ODBC]
ms.assetid: 4949530c-62d1-4f1a-b592-144244444ce0
author: rothja
ms.author: jroth
ms.openlocfilehash: 4fe52b211eb6d5a0e4d875264609d036702b2b0b
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87692389"
---
# <a name="diagnostic-records-and-fields"></a><span data-ttu-id="fd757-102">诊断记录和字段</span><span class="sxs-lookup"><span data-stu-id="fd757-102">Diagnostic Records and Fields</span></span>
  <span data-ttu-id="fd757-103">诊断记录与 ODBC 环境、连接、语句或描述符句柄关联。</span><span class="sxs-lookup"><span data-stu-id="fd757-103">Diagnostic records are associated with ODBC environment, connection, statement, or descriptor handles.</span></span> <span data-ttu-id="fd757-104">当任何 ODBC 函数产生的返回代码不是 SQL_SUCCESS 或 SQL_INVALID_HANDLE 时，该函数调用的句柄就有相关联的诊断记录，其中包含信息性或错误性消息。</span><span class="sxs-lookup"><span data-stu-id="fd757-104">When any ODBC function raises a return code other than SQL_SUCCESS or SQL_INVALID_HANDLE, the handle called by the function has associated diagnostic records that contain informational or error messages.</span></span> <span data-ttu-id="fd757-105">这些记录会一直保留，直到要通过该句柄调用其他函数，那时，记录就会被丢弃。</span><span class="sxs-lookup"><span data-stu-id="fd757-105">These records are retained until another function is called using that handle, at which time they are discarded.</span></span> <span data-ttu-id="fd757-106">与一个句柄任一次调用相关联的诊断记录数目不受限制。</span><span class="sxs-lookup"><span data-stu-id="fd757-106">There is no limit to the number of diagnostic records that can be associated with a handle at any one time.</span></span>  
  
 <span data-ttu-id="fd757-107">有两种类型的诊断记录：标题和状态。</span><span class="sxs-lookup"><span data-stu-id="fd757-107">There are two types of diagnostic records: header and status.</span></span> <span data-ttu-id="fd757-108">标题记录为记录 0；状态记录为记录 1 及更大数字。</span><span class="sxs-lookup"><span data-stu-id="fd757-108">The header record is record 0; when there are status records, they are records 1 and later.</span></span> <span data-ttu-id="fd757-109">诊断记录包含适用于标题记录和状态记录的不同字段。</span><span class="sxs-lookup"><span data-stu-id="fd757-109">Diagnostic records contain different fields for the header record and the status records.</span></span> <span data-ttu-id="fd757-110">ODBC 组件还可以定义自己的诊断记录字段。</span><span class="sxs-lookup"><span data-stu-id="fd757-110">ODBC components can also define their own diagnostic record fields.</span></span>  
  
 <span data-ttu-id="fd757-111">标题记录中的字段包含有关函数执行的一般信息，包括返回代码、行计数、状态记录数和所执行的语句的类型。</span><span class="sxs-lookup"><span data-stu-id="fd757-111">Fields in the header record contain general information about a function's execution, including the return code, row count, number of status records, and type of statement executed.</span></span> <span data-ttu-id="fd757-112">除非 ODBC 函数返回 SQL_INVALID_HANDLE，否则，总是会创建标题记录。</span><span class="sxs-lookup"><span data-stu-id="fd757-112">The header record is always created unless an ODBC function returns SQL_INVALID_HANDLE.</span></span> <span data-ttu-id="fd757-113">有关标头记录中字段的完整列表，请参阅[SQLGetDiagField](../native-client-odbc-api/sqlgetdiagfield.md)。</span><span class="sxs-lookup"><span data-stu-id="fd757-113">For a complete list of fields in the header record, see [SQLGetDiagField](../native-client-odbc-api/sqlgetdiagfield.md).</span></span>  
  
 <span data-ttu-id="fd757-114">状态记录中的字段包含关于 ODBC 驱动程序管理器、驱动程序或数据源返回的特定错误或警告的信息，包括 SQLSTATE、本机错误号、诊断消息、列号和行号。</span><span class="sxs-lookup"><span data-stu-id="fd757-114">Fields in the status records contain information about specific errors or warnings returned by the ODBC Driver Manager, driver, or data source, including the SQLSTATE, native error number, diagnostic message, column number, and row number.</span></span> <span data-ttu-id="fd757-115">仅当函数返回 SQL_ERROR, SQL_SUCCESS_WITH_INFO、SQL_NO_DATA、SQL_NEED_DATA 或 SQL_STILL_EXECUTING 时，才会创建状态记录。</span><span class="sxs-lookup"><span data-stu-id="fd757-115">Status records are created only if the function returns SQL_ERROR, SQL_SUCCESS_WITH_INFO, SQL_NO_DATA, SQL_NEED_DATA, or SQL_STILL_EXECUTING.</span></span> <span data-ttu-id="fd757-116">有关状态记录中字段的完整列表，请参阅**SQLGetDiagField**。</span><span class="sxs-lookup"><span data-stu-id="fd757-116">For a complete list of fields in the status records, see **SQLGetDiagField**.</span></span>  
  
 <span data-ttu-id="fd757-117">**SQLGetDiagRec**检索单个诊断记录及其 ODBC SQLSTATE、本机错误号和诊断消息字段。</span><span class="sxs-lookup"><span data-stu-id="fd757-117">**SQLGetDiagRec** retrieves a single diagnostic record along with its ODBC SQLSTATE, native error number, and diagnostic-message fields.</span></span> <span data-ttu-id="fd757-118">此功能类似于 ODBC 2。_x_**SQLError**函数。</span><span class="sxs-lookup"><span data-stu-id="fd757-118">This functionality is similar to the ODBC 2._x_**SQLError** function.</span></span> <span data-ttu-id="fd757-119">ODBC 3 中最简单的错误处理函数。*x*重复调用**SQLGetDiagRec** ，并将*RecNumber*参数设置为1，并按1递增*RecNumber* ，直到**SQLGetDiagRec**返回 SQL_NO_DATA。</span><span class="sxs-lookup"><span data-stu-id="fd757-119">The simplest error-handling function in ODBC 3.*x* is to repeatedly call **SQLGetDiagRec** starting with the *RecNumber* parameter set to 1 and incrementing *RecNumber* by 1 until **SQLGetDiagRec** returns SQL_NO_DATA.</span></span> <span data-ttu-id="fd757-120">这与 ODBC 2 等效。*x*应用程序调用**SQLError** ，直到返回 SQL_NO_DATA_FOUND。</span><span class="sxs-lookup"><span data-stu-id="fd757-120">This is equivalent to an ODBC 2.*x* application calling **SQLError** until it returns SQL_NO_DATA_FOUND.</span></span>  
  
 <span data-ttu-id="fd757-121">ODBC 3。*x*比 ODBC 2 支持更多的诊断信息。*x*。</span><span class="sxs-lookup"><span data-stu-id="fd757-121">ODBC 3.*x* supports much more diagnostic information than ODBC 2.*x*.</span></span> <span data-ttu-id="fd757-122">此信息存储在使用**SQLGetDiagField**检索的诊断记录的其他字段中。</span><span class="sxs-lookup"><span data-stu-id="fd757-122">This information is stored in additional fields in diagnostic records retrieved by using **SQLGetDiagField**.</span></span>  
  
 <span data-ttu-id="fd757-123">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]Native CLIENT ODBC 驱动程序具有特定于驱动程序的诊断字段，可以通过**SQLGetDiagField**进行检索。</span><span class="sxs-lookup"><span data-stu-id="fd757-123">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver has driver-specific diagnostic fields that can be retrieved with **SQLGetDiagField**.</span></span> <span data-ttu-id="fd757-124">这些特定于驱动程序的字段的标签在 sqlncli.h 中定义。</span><span class="sxs-lookup"><span data-stu-id="fd757-124">Labels for these driver-specific fields are defined in sqlncli.h.</span></span> <span data-ttu-id="fd757-125">使用这些标签可以检索与每条诊断记录关联的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 状态、严重级别、服务器名称、过程名称和行号。</span><span class="sxs-lookup"><span data-stu-id="fd757-125">Use these labels to retrieve the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] state, severity level, server name, procedure name, and line number associated with each diagnostic record.</span></span> <span data-ttu-id="fd757-126">此外，sqlncli.msi 包含驱动程序用于标识 Transact-sql 语句的代码定义（如果应用程序调用*DiagIdentifier*设置为 SQL_DIAG_DYNAMIC_FUNCTION_CODE 的**SQLGetDiagField** ）。</span><span class="sxs-lookup"><span data-stu-id="fd757-126">Also, sqlncli.h contains definitions of the codes the driver uses to identify Transact-SQL statements if an application calls **SQLGetDiagField** with *DiagIdentifier* set to SQL_DIAG_DYNAMIC_FUNCTION_CODE.</span></span>  
  
 <span data-ttu-id="fd757-127">ODBC 驱动程序管理器使用它从底层驱动程序缓存的错误信息来处理**SQLGetDiagField** 。</span><span class="sxs-lookup"><span data-stu-id="fd757-127">**SQLGetDiagField** is processed by the ODBC Driver Manager using error information it caches from the underlying driver.</span></span> <span data-ttu-id="fd757-128">在成功连接之前，ODBC 驱动程序管理器不会缓存特定于驱动程序的诊断字段。</span><span class="sxs-lookup"><span data-stu-id="fd757-128">The ODBC Driver Manager does not cache driver-specific diagnostic fields until after a successful connection has been made.</span></span> <span data-ttu-id="fd757-129">如果在成功完成连接之前调用以获取特定于驱动程序的诊断字段， **SQLGetDiagField**将返回 SQL_ERROR。</span><span class="sxs-lookup"><span data-stu-id="fd757-129">**SQLGetDiagField** returns SQL_ERROR if it is called to get driver-specific diagnostic fields before a successful connection has been completed.</span></span> <span data-ttu-id="fd757-130">如果 ODBC 连接函数返回 SQL_SUCCESS_WITH_INFO，则该连接函数特定于驱动程序的诊断字段尚不可用。</span><span class="sxs-lookup"><span data-stu-id="fd757-130">If an ODBC connect function returns SQL_SUCCESS_WITH_INFO, the driver-specific diagnostic fields for the connect function are not yet available.</span></span> <span data-ttu-id="fd757-131">只有在连接函数之后执行了另一个 ODBC 函数调用之后，才能开始为特定于驱动程序的诊断字段调用**SQLGetDiagField** 。</span><span class="sxs-lookup"><span data-stu-id="fd757-131">You can start calling **SQLGetDiagField** for driver-specific diagnostic fields only after you have made another ODBC function call after the connect function.</span></span>  
  
 <span data-ttu-id="fd757-132">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]使用**SQLGetDiagRec**返回的信息，可以有效地使用 Native Client ODBC 驱动程序报告的大多数错误进行诊断。</span><span class="sxs-lookup"><span data-stu-id="fd757-132">Most errors reported by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver can be effectively diagnosed using only the information returned by **SQLGetDiagRec**.</span></span> <span data-ttu-id="fd757-133">不过，在有些情况下，特定于驱动程序的诊断字段返回的信息对于诊断错误非常重要。</span><span class="sxs-lookup"><span data-stu-id="fd757-133">In some cases, however, the information returned by the driver-specific diagnostic fields is important in diagnosing an error.</span></span> <span data-ttu-id="fd757-134">当使用 Native Client ODBC 驱动程序为应用程序编写 ODBC 错误处理程序时 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，最好也使用**SQLGetDiagField**来检索至少 SQL_DIAG_SS_MSGSTATE 和 SQL_DIAG_SS_SEVERITY 特定于驱动程序的字段。</span><span class="sxs-lookup"><span data-stu-id="fd757-134">When coding an ODBC error handler for applications using the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver, it is a good idea to also use **SQLGetDiagField** to retrieve at least the SQL_DIAG_SS_MSGSTATE and SQL_DIAG_SS_SEVERITY driver-specific fields.</span></span> <span data-ttu-id="fd757-135">如果特定错误可以在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代码的多个位置引发，SQL_DIAG_SS_MSGSTATE 会为 Microsoft 支持工程师专门指示错误的引发位置，有时，这有助于诊断问题。</span><span class="sxs-lookup"><span data-stu-id="fd757-135">If a particular error can be raised at several locations in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] code, SQL_DIAG_SS_MSGSTATE indicates to a Microsoft support engineer specifically where an error was raised, which sometimes aids in diagnosing a problem.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="fd757-136">另请参阅</span><span class="sxs-lookup"><span data-stu-id="fd757-136">See Also</span></span>  
 [<span data-ttu-id="fd757-137">处理错误和消息</span><span class="sxs-lookup"><span data-stu-id="fd757-137">Handling Errors and Messages</span></span>](handling-errors-and-messages.md)  
  
  

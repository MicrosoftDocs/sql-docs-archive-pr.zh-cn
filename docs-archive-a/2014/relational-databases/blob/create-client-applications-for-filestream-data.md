---
title: 为 FILESTREAM 数据创建客户端应用程序 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: filestream
ms.topic: conceptual
helpviewer_keywords:
- FILESTREAM [SQL Server], Win32
ms.assetid: 8a02aff6-e54c-40c6-a066-2083e9b090aa
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: d7170ff88c0c7c9fd40c372467d2e3fd407a90cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87576842"
---
# <a name="create-client-applications-for-filestream-data"></a><span data-ttu-id="d274b-102">为 FILESTREAM 数据创建客户端应用程序</span><span class="sxs-lookup"><span data-stu-id="d274b-102">Create Client Applications for FILESTREAM Data</span></span>
  <span data-ttu-id="d274b-103">可以使用 Win32 在 FILESTREAM BLOB 中读取和写入数据。</span><span class="sxs-lookup"><span data-stu-id="d274b-103">You can use Win32 to read and write data to a FILESTREAM BLOB.</span></span> <span data-ttu-id="d274b-104">您需要执行以下步骤：</span><span class="sxs-lookup"><span data-stu-id="d274b-104">The following steps are required:</span></span>  
  
-   <span data-ttu-id="d274b-105">读取 FILESTREAM 文件路径。</span><span class="sxs-lookup"><span data-stu-id="d274b-105">Read the FILESTREAM file path.</span></span>  
  
-   <span data-ttu-id="d274b-106">读取当前事务上下文。</span><span class="sxs-lookup"><span data-stu-id="d274b-106">Read the current transaction context.</span></span>  
  
-   <span data-ttu-id="d274b-107">获取 Win32 句柄，并使用该句柄在 FILESTREAM BLOB 中读取和写入数据。</span><span class="sxs-lookup"><span data-stu-id="d274b-107">Obtain a Win32 handle and use the handle to read and write data to the FILESTREAM BLOB.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="d274b-108">本主题中的示例需要在 [创建启用 FILESTREAM 的数据库](create-a-filestream-enabled-database.md) 和 [创建表以存储 FILESTREAM 数据](create-a-table-for-storing-filestream-data.md)中创建的启用了 FILESTREAM 的数据库和表。</span><span class="sxs-lookup"><span data-stu-id="d274b-108">The examples in this topic require the FILESTREAM-enabled database and table that are created in [Create a FILESTREAM-Enabled Database](create-a-filestream-enabled-database.md) and [Create a Table for Storing FILESTREAM Data](create-a-table-for-storing-filestream-data.md).</span></span>  
  
##  <a name="functions-for-working-with-filestream-data"></a><a name="func"></a> <span data-ttu-id="d274b-109">用于使用 FILESTREAM 数据的函数</span><span class="sxs-lookup"><span data-stu-id="d274b-109">Functions for Working with FILESTREAM Data</span></span>  
 <span data-ttu-id="d274b-110">使用 FILESTREAM 来存储二进制大型对象 (BLOB) 数据时，可使用 Win32 API 来处理文件。</span><span class="sxs-lookup"><span data-stu-id="d274b-110">When you use FILESTREAM to store binary large object (BLOB) data, you can use Win32 APIs to work with the files.</span></span> <span data-ttu-id="d274b-111">为了支持在 Win32 应用程序中处理 FILESTREAM BLOB 数据， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 提供了以下函数和 API：</span><span class="sxs-lookup"><span data-stu-id="d274b-111">To support working with FILESTREAM BLOB data in Win32 applications, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides the following functions and API:</span></span>  
  
-   <span data-ttu-id="d274b-112">[PathName](/sql/relational-databases/system-functions/pathname-transact-sql) 可将路径作为标记返回给 BLOB。</span><span class="sxs-lookup"><span data-stu-id="d274b-112">[PathName](/sql/relational-databases/system-functions/pathname-transact-sql) returns a path as a token to a BLOB.</span></span> <span data-ttu-id="d274b-113">应用程序可使用此标记来获取 Win32 句柄并对 BLOB 数据进行操作。</span><span class="sxs-lookup"><span data-stu-id="d274b-113">An application uses this token to obtain a Win32 handle and operate on BLOB data.</span></span>  
  
     <span data-ttu-id="d274b-114">在包含 FILESTREAM 数据的数据库属于某一 AlwaysOn 可用性组时，PathName 函数返回虚拟网络名称 (VNN)，而非计算机名称。</span><span class="sxs-lookup"><span data-stu-id="d274b-114">When the database that contains FILESTREAM data belongs to an AlwaysOn availability group, then the PathName function returns a virtual network name (VNN) instead of a computer name.</span></span>  
  
-   <span data-ttu-id="d274b-115">[GET_FILESTREAM_TRANSACTION_CONTEXT()](/sql/t-sql/functions/get-filestream-transaction-context-transact-sql) 可返回表示会话当前事务的标记。</span><span class="sxs-lookup"><span data-stu-id="d274b-115">[GET_FILESTREAM_TRANSACTION_CONTEXT()](/sql/t-sql/functions/get-filestream-transaction-context-transact-sql) returns a token that represents the current transaction of a session.</span></span> <span data-ttu-id="d274b-116">应用程序使用此标记可将 FILESTREAM 文件系统流式处理操作绑定到该事务。</span><span class="sxs-lookup"><span data-stu-id="d274b-116">An application uses this token to bind FILESTREAM file system streaming operations to the transaction.</span></span>  
  
-   <span data-ttu-id="d274b-117">[OpenSqlFilestream API](access-filestream-data-with-opensqlfilestream.md) 可获取 Win32 文件句柄。</span><span class="sxs-lookup"><span data-stu-id="d274b-117">The [OpenSqlFilestream API](access-filestream-data-with-opensqlfilestream.md) obtains a Win32 file handle.</span></span> <span data-ttu-id="d274b-118">应用程序使用句柄来流式传输 FILESTREAM 数据，然后可以将句柄传递给以下 Win32 API：[ReadFile](https://go.microsoft.com/fwlink/?LinkId=86422)、[WriteFile](https://go.microsoft.com/fwlink/?LinkId=86423)、[TransmitFile](https://go.microsoft.com/fwlink/?LinkId=86424)、[SetFilePointer](https://go.microsoft.com/fwlink/?LinkId=86425)、[SetEndOfFile](https://go.microsoft.com/fwlink/?LinkId=86426) 或 [FlushFileBuffers](https://go.microsoft.com/fwlink/?LinkId=86427)。</span><span class="sxs-lookup"><span data-stu-id="d274b-118">The application uses the handle to stream the FILESTREAM data, and can then pass the handle to the following Win32 APIs: [ReadFile](https://go.microsoft.com/fwlink/?LinkId=86422), [WriteFile](https://go.microsoft.com/fwlink/?LinkId=86423), [TransmitFile](https://go.microsoft.com/fwlink/?LinkId=86424), [SetFilePointer](https://go.microsoft.com/fwlink/?LinkId=86425), [SetEndOfFile](https://go.microsoft.com/fwlink/?LinkId=86426), or [FlushFileBuffers](https://go.microsoft.com/fwlink/?LinkId=86427).</span></span> <span data-ttu-id="d274b-119">如果应用程序使用此句柄来调用任何其他 API，则会返回 ERROR_ACCESS_DENIED 错误。</span><span class="sxs-lookup"><span data-stu-id="d274b-119">If the application calls any other API by using the handle, an ERROR_ACCESS_DENIED error is returned.</span></span> <span data-ttu-id="d274b-120">应用程序应使用 [CloseHandle](https://go.microsoft.com/fwlink/?LinkId=86428)来关闭此句柄。</span><span class="sxs-lookup"><span data-stu-id="d274b-120">The application should close the handle by using [CloseHandle](https://go.microsoft.com/fwlink/?LinkId=86428).</span></span>  
  
 <span data-ttu-id="d274b-121">所有 FILESTREAM 数据容器访问都是在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 事务中执行的。</span><span class="sxs-lookup"><span data-stu-id="d274b-121">All FILESTREAM data container access is performed in a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] transaction.</span></span> [!INCLUDE[tsql](../../includes/tsql-md.md)] <span data-ttu-id="d274b-122">语句以保持 SQL 数据和 FILESTREAM 数据之间的一致性。</span><span class="sxs-lookup"><span data-stu-id="d274b-122">statements can be executed in the same transaction to maintain consistency between SQL data and FILESTREAM data.</span></span>  
  
##  <a name="steps-for-accessing-filestream-data"></a><a name="steps"></a> <span data-ttu-id="d274b-123">访问 FILESTREAM 数据的步骤</span><span class="sxs-lookup"><span data-stu-id="d274b-123">Steps for Accessing FILESTREAM Data</span></span>  
  
###  <a name="reading-the-filestream-file-path"></a><a name="path"></a> <span data-ttu-id="d274b-124">读取 FILESTREAM 文件路径</span><span class="sxs-lookup"><span data-stu-id="d274b-124">Reading the FILESTREAM File Path</span></span>  
 <span data-ttu-id="d274b-125">FILESTREAM 表中的每个单元都具有关联的文件路径。</span><span class="sxs-lookup"><span data-stu-id="d274b-125">Each cell in a FILESTREAM table has a file path that is associated with it.</span></span> <span data-ttu-id="d274b-126">若要读取该路径，请在 [!INCLUDE[tsql](../../includes/tsql-md.md)] 语句中使用 `PathName` 列的 `varbinary(max)` 属性。</span><span class="sxs-lookup"><span data-stu-id="d274b-126">To read the path, use the `PathName` property of a `varbinary(max)` column in a [!INCLUDE[tsql](../../includes/tsql-md.md)] statement.</span></span> <span data-ttu-id="d274b-127">下面的示例说明了如何读取 `varbinary(max)` 列的文件路径。</span><span class="sxs-lookup"><span data-stu-id="d274b-127">The following example shows how to read the file path of a `varbinary(max)` column.</span></span>  
  
 [!code-sql[FILESTREAM#FS_PathName](../../snippets/tsql/SQL15/tsql/filestream/transact-sql/filestream.sql#fs_pathname)]  
  
###  <a name="reading-the-transaction-context"></a><a name="trx"></a> <span data-ttu-id="d274b-128">读取事务上下文</span><span class="sxs-lookup"><span data-stu-id="d274b-128">Reading the Transaction Context</span></span>  
 <span data-ttu-id="d274b-129">要获取当前事务上下文，请使用 [!INCLUDE[tsql](../../includes/tsql-md.md)] [GET_FILESTREAM_TRANSACTION_CONTEXT()](/sql/t-sql/functions/get-filestream-transaction-context-transact-sql) 函数。</span><span class="sxs-lookup"><span data-stu-id="d274b-129">To obtain the current transaction context, use the [!INCLUDE[tsql](../../includes/tsql-md.md)] [GET_FILESTREAM_TRANSACTION_CONTEXT()](/sql/t-sql/functions/get-filestream-transaction-context-transact-sql) function.</span></span> <span data-ttu-id="d274b-130">下面的示例说明了如何开始执行事务并读取当前事务上下文。</span><span class="sxs-lookup"><span data-stu-id="d274b-130">The following example shows how to begin a transaction and read the current transaction context.</span></span>  
  
 [!code-sql[FILESTREAM#FS_GET_TRANSACTION_CONTEXT](../../snippets/tsql/SQL15/tsql/filestream/transact-sql/filestream.sql#fs_get_transaction_context)]  
  
###  <a name="obtaining-a-win32-file-handle"></a><a name="handle"></a> <span data-ttu-id="d274b-131">获取 Win32 文件句柄</span><span class="sxs-lookup"><span data-stu-id="d274b-131">Obtaining a Win32 File Handle</span></span>  
 <span data-ttu-id="d274b-132">若要获取 Win32 文件句柄，请调用 OpenSqlFilestream API。</span><span class="sxs-lookup"><span data-stu-id="d274b-132">To obtain a Win32 file handle, call the OpenSqlFilestream API.</span></span> <span data-ttu-id="d274b-133">此 API 是从 sqlncli.dll 文件中导出的。</span><span class="sxs-lookup"><span data-stu-id="d274b-133">This API is exported from the sqlncli.dll file.</span></span> <span data-ttu-id="d274b-134">返回的句柄可以传递给以下任何 Win32 API：[ReadFile](https://go.microsoft.com/fwlink/?LinkId=86422)、[WriteFile](https://go.microsoft.com/fwlink/?LinkId=86423)、[TransmitFile](https://go.microsoft.com/fwlink/?LinkId=86424)、[SetFilePointer](https://go.microsoft.com/fwlink/?LinkId=86425)、[SetEndOfFile](https://go.microsoft.com/fwlink/?LinkId=86426) 或 [FlushFileBuffers](https://go.microsoft.com/fwlink/?LinkId=86427)。</span><span class="sxs-lookup"><span data-stu-id="d274b-134">The returned handle can be passed to any of the following Win32 APIs: [ReadFile](https://go.microsoft.com/fwlink/?LinkId=86422), [WriteFile](https://go.microsoft.com/fwlink/?LinkId=86423), [TransmitFile](https://go.microsoft.com/fwlink/?LinkId=86424), [SetFilePointer](https://go.microsoft.com/fwlink/?LinkId=86425), [SetEndOfFile](https://go.microsoft.com/fwlink/?LinkId=86426), or [FlushFileBuffers](https://go.microsoft.com/fwlink/?LinkId=86427).</span></span> <span data-ttu-id="d274b-135">下面的示例说明了如何获取 Win32 文件句柄并使用它在 FILESTREAM BLOB 中读取和写入数据。</span><span class="sxs-lookup"><span data-stu-id="d274b-135">The following examples show you how to obtain a Win32 File handle and use it to read and write data to a FILESTREAM BLOB.</span></span>  
  
 [!code-csharp[FILESTREAM#FS_CS_ReadAndWriteBLOB](../../snippets/tsql/SQL15/tsql/filestream/cs/filestream.cs#fs_cs_readandwriteblob)]  
  
 [!code-vb[FILESTREAM#FS_VB_ReadAndWriteBLOB](../../snippets/tsql/SQL15/tsql/filestream/vb/filestream.vb#fs_vb_readandwriteblob)]  
  
 [!code-cpp[FILESTREAM#FS_CPP_WriteBLOB](../../snippets/tsql/SQL15/tsql/filestream/cpp/filestream.cpp#fs_cpp_writeblob)]  
  
##  <a name="best-practices-for-application-design-and-implementation"></a><a name="best"></a> <span data-ttu-id="d274b-136">应用程序设计和实现的最佳实践</span><span class="sxs-lookup"><span data-stu-id="d274b-136">Best Practices for Application Design and Implementation</span></span>  
  
-   <span data-ttu-id="d274b-137">设计和实现使用 FILESTREAM 的应用程序时，应考虑下列准则：</span><span class="sxs-lookup"><span data-stu-id="d274b-137">When you are designing and implementing applications that use FILESTREAM, consider the following guidelines:</span></span>  
  
-   <span data-ttu-id="d274b-138">使用 NULL 代替 0x 来表示未初始化的 FILESTREAM 列。</span><span class="sxs-lookup"><span data-stu-id="d274b-138">Use NULL instead of 0x to represent a non-initialized FILESTREAM column.</span></span> <span data-ttu-id="d274b-139">0x 值会导致创建文件，而 NULL 不会。</span><span class="sxs-lookup"><span data-stu-id="d274b-139">The 0x value causes a file to be created, and NULL does not.</span></span>  
  
-   <span data-ttu-id="d274b-140">避免在包含非空 FILESTREAM 列的表中执行插入和删除操作。</span><span class="sxs-lookup"><span data-stu-id="d274b-140">Avoid insert and delete operations in tables that contain nonnull FILESTREAM columns.</span></span> <span data-ttu-id="d274b-141">插入和删除操作会修改用于垃圾收集的 FILESTREAM 表。</span><span class="sxs-lookup"><span data-stu-id="d274b-141">Insert and delete operations can modify the FILESTREAM tables that are used for garbage collection.</span></span> <span data-ttu-id="d274b-142">这可能导致应用程序的性能随着时间的推移而下降。</span><span class="sxs-lookup"><span data-stu-id="d274b-142">This can cause an application's performance to decrease over time.</span></span>  
  
-   <span data-ttu-id="d274b-143">在使用复制的应用程序中，使用 NEWSEQUENTIALID() 代替 NEWID()。</span><span class="sxs-lookup"><span data-stu-id="d274b-143">In applications that use replication, use NEWSEQUENTIALID() instead of NEWID().</span></span> <span data-ttu-id="d274b-144">在这些应用程序中生成 GUID 时，NEWSEQUENTIALID() 比 NEWID() 的性能更好。</span><span class="sxs-lookup"><span data-stu-id="d274b-144">NEWSEQUENTIALID() performs better than NEWID() for GUID generation in these applications.</span></span>  
  
-   <span data-ttu-id="d274b-145">FILESTREAM API 是专门为了以 Win32 流方式访问数据而设计的。</span><span class="sxs-lookup"><span data-stu-id="d274b-145">The FILESTREAM API is designed for Win32 streaming access to data.</span></span> <span data-ttu-id="d274b-146">应避免使用 [!INCLUDE[tsql](../../includes/tsql-md.md)] 读取或写入超过 2 MB 的 FILESTREAM 二进制大型对象 (BLOB)。</span><span class="sxs-lookup"><span data-stu-id="d274b-146">Avoid using [!INCLUDE[tsql](../../includes/tsql-md.md)] to read or write FILESTREAM binary large objects (BLOBs) that are larger than 2 MB.</span></span> <span data-ttu-id="d274b-147">如果必须从 [!INCLUDE[tsql](../../includes/tsql-md.md)]读取或写入 BLOB 数据，请确保尝试从 Win32 打开 FILESTREAM BLOB 之前所有的 BLOB 数据都已占用。</span><span class="sxs-lookup"><span data-stu-id="d274b-147">If you must read or write BLOB data from [!INCLUDE[tsql](../../includes/tsql-md.md)], make sure that all BLOB data is consumed before you try to open the FILESTREAM BLOB from Win32.</span></span> <span data-ttu-id="d274b-148">无法占用所有的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 数据可能会导致任何后续的 FILESTREAM 打开或关闭操作失败。</span><span class="sxs-lookup"><span data-stu-id="d274b-148">Failure to consume all the [!INCLUDE[tsql](../../includes/tsql-md.md)] data might cause any successive FILESTREAM open or close operations to fail.</span></span>  
  
-   <span data-ttu-id="d274b-149">避免使用向 FILESTREAM BLOB 中更新、追加或预置数据的 [!INCLUDE[tsql](../../includes/tsql-md.md)] 语句。</span><span class="sxs-lookup"><span data-stu-id="d274b-149">Avoid [!INCLUDE[tsql](../../includes/tsql-md.md)] statements that update, append or prepend data to the FILESTREAM BLOB.</span></span> <span data-ttu-id="d274b-150">这会导致 BLOB 数据被假脱机保存到 tempdb 数据库中，然后回到新物理文件中。</span><span class="sxs-lookup"><span data-stu-id="d274b-150">This causes the BLOB data to be spooled into the tempdb database and then back into a new physical file.</span></span>  
  
-   <span data-ttu-id="d274b-151">避免将小型 BLOB 更新追加到 FILESTREAM BLOB 中。</span><span class="sxs-lookup"><span data-stu-id="d274b-151">Avoid appending small BLOB updates to a FILESTREAM BLOB.</span></span> <span data-ttu-id="d274b-152">每次追加都会导致复制基础 FILESTREAM 文件。</span><span class="sxs-lookup"><span data-stu-id="d274b-152">Each append causes the underlying FILESTREAM files to be copied.</span></span> <span data-ttu-id="d274b-153">如果应用程序必须追加小型 BLOB，请将 BLOB 写入 `varbinary(max)` 列，然后在 BLOB 数达到预设的限制时对 FILESTREAM BLOB 执行单次写入操作。</span><span class="sxs-lookup"><span data-stu-id="d274b-153">If an application has to append small BLOBs, write the BLOBs into a `varbinary(max)` column, and then perform a single write operation to the FILESTREAM BLOB when the number of BLOBs reaches a predetermined limit.</span></span>  
  
-   <span data-ttu-id="d274b-154">避免在应用程序中检索大量 BLOB 文件的数据长度。</span><span class="sxs-lookup"><span data-stu-id="d274b-154">Avoid retrieving the data length of lots of BLOB files in an application.</span></span> <span data-ttu-id="d274b-155">这是非常耗时的操作，因为大小未存储在 [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)]中。</span><span class="sxs-lookup"><span data-stu-id="d274b-155">This is a time-consuming operation because the size is not stored in the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="d274b-156">如果必须确定 BLOB 文件的长度，请使用 [!INCLUDE[tsql](../../includes/tsql-md.md)] DATALENGTH() 函数确定 BLOB 的大小（如果它是关闭的）。</span><span class="sxs-lookup"><span data-stu-id="d274b-156">If you must determine the length of a BLOB file, use the [!INCLUDE[tsql](../../includes/tsql-md.md)] DATALENGTH() function to determine the size of the BLOB if it is closed.</span></span> <span data-ttu-id="d274b-157">DATALENGTH() 不会打开 BLOB 文件来确定其大小。</span><span class="sxs-lookup"><span data-stu-id="d274b-157">DATALENGTH() does not open the BLOB file to determine its size.</span></span>  
  
-   <span data-ttu-id="d274b-158">如果应用程序使用 Message Block1 (SMB1) 协议，则应以 60 KB 的倍数读取 FILESTREAM BLOB 数据以优化性能。</span><span class="sxs-lookup"><span data-stu-id="d274b-158">If an application uses Message Block1 (SMB1) protocol, FILESTREAM BLOB data should be read in 60-KB multiples to optimize performance.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d274b-159">另请参阅</span><span class="sxs-lookup"><span data-stu-id="d274b-159">See Also</span></span>  
 <span data-ttu-id="d274b-160">[避免与 FILESTREAM 应用程序中的数据库操作冲突](avoid-conflicts-with-database-operations-in-filestream-applications.md) </span><span class="sxs-lookup"><span data-stu-id="d274b-160">[Avoid Conflicts with Database Operations in FILESTREAM Applications](avoid-conflicts-with-database-operations-in-filestream-applications.md) </span></span>  
 <span data-ttu-id="d274b-161">[使用 OpenSqlFilestream 访问 FILESTREAM 数据](access-filestream-data-with-opensqlfilestream.md) </span><span class="sxs-lookup"><span data-stu-id="d274b-161">[Access FILESTREAM Data with OpenSqlFilestream](access-filestream-data-with-opensqlfilestream.md) </span></span>  
 <span data-ttu-id="d274b-162">[二进制大型对象 &#40;Blob&#41; 数据 &#40;SQL Server&#41;](binary-large-object-blob-data-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="d274b-162">[Binary Large Object &#40;Blob&#41; Data &#40;SQL Server&#41;](binary-large-object-blob-data-sql-server.md) </span></span>  
 [<span data-ttu-id="d274b-163">对 FILESTREAM 数据进行部分更新</span><span class="sxs-lookup"><span data-stu-id="d274b-163">Make Partial Updates to FILESTREAM Data</span></span>](make-partial-updates-to-filestream-data.md)  
  
  

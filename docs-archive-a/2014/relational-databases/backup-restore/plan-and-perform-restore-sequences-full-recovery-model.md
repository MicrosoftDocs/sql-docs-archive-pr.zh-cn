---
title: 计划和执行还原顺序（完整恢复模式）| Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- restore sequences [SQL Server], planning for
- full recovery model [SQL Server], planning restore sequences
ms.assetid: 9cbefaf8-d2b6-41c9-83fc-b3807a841fe2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 85558c0a6361837b5645b9fc38ad040254265d72
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87589176"
---
# <a name="plan-and-perform-restore-sequences-full-recovery-model"></a><span data-ttu-id="8ac11-102">计划和执行还原顺序（完整恢复模式）</span><span class="sxs-lookup"><span data-stu-id="8ac11-102">Plan and Perform Restore Sequences (Full Recovery Model)</span></span>
  <span data-ttu-id="8ac11-103">本主题说明如何为通常使用完整恢复模式的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库计划和执行一个还原顺序。</span><span class="sxs-lookup"><span data-stu-id="8ac11-103">This topic explains how to plan and perform a restore sequence for a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] databases that ordinarily uses the full recovery model.</span></span> <span data-ttu-id="8ac11-104">“还原顺序”  是一个或多个 [RESTORE](/sql/t-sql/statements/restore-statements-transact-sql) 语句的顺序。</span><span class="sxs-lookup"><span data-stu-id="8ac11-104">A *restore sequence* is a sequence of one or more [RESTORE](/sql/t-sql/statements/restore-statements-transact-sql) statements.</span></span> <span data-ttu-id="8ac11-105">通常，还原顺序会初始化要还原的数据库、文件和/或页的内容（数据复制阶段），前滚记录的事务（重做阶段）以及回滚未提交的事务（撤消阶段）。</span><span class="sxs-lookup"><span data-stu-id="8ac11-105">Typically, a restore sequences initializes the contents of the database, files, and/or pages being restored (the data-copy phase), rolls forward logged transactions (the redo phase), and rolls back uncommitted transactions (the undo phase).</span></span>  
  
 <span data-ttu-id="8ac11-106">在简单情况下，还原操作只需要一个完整数据库备份、一个差异数据库备份和后续日志备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-106">In simple cases, a restore sequence requires only a full database backup, a differential database backup, and the subsequent log backups.</span></span> <span data-ttu-id="8ac11-107">在这些情况下，很容易构造一个正确的还原顺序。</span><span class="sxs-lookup"><span data-stu-id="8ac11-107">In these cases, constructing a correct restore sequence is easy.</span></span> <span data-ttu-id="8ac11-108">例如，若要将整个数据库还原到故障点，请首先备份活动事务日志（日志的尾部  ）。</span><span class="sxs-lookup"><span data-stu-id="8ac11-108">For example, to restore a whole database to the point of a failure, start by backing up the active transaction log (the *tail* of the log).</span></span> <span data-ttu-id="8ac11-109">然后，按备份的创建顺序还原最新的完整数据库备份、最新的差异备份（如果有）以及所有后续日志备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-109">Then, restore the most recent full database backup, the most recent differential backup (if any), and all subsequent log backups in the order in which they were taken.</span></span>  
  
 <span data-ttu-id="8ac11-110">在更复杂的情况下，构造一个正确的还原顺序可能是个复杂的过程。</span><span class="sxs-lookup"><span data-stu-id="8ac11-110">In more complex cases, constructing a correct restore sequence can be a complex process.</span></span> <span data-ttu-id="8ac11-111">例如，还原顺序可能需要多个文件备份，或者需要将数据还原到特定时间点。</span><span class="sxs-lookup"><span data-stu-id="8ac11-111">For example, a restore sequence might require multiple file backups or restoring data to a specific point in time.</span></span> <span data-ttu-id="8ac11-112">在非常复杂的情况下，您甚至可能需要遍历跨一个或多个恢复分叉的分叉恢复路径。</span><span class="sxs-lookup"><span data-stu-id="8ac11-112">In very complex cases, you might even have to traverse a forked recovery path that spans one or more recovery forks.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="8ac11-113">恢复路径  是使数据库到达特定时间点（称为恢复点）的一组数据和日志备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-113">A *recovery path* is the sequence of data and log backups that have brought a database to a particular point in time (known as a recovery point).</span></span> <span data-ttu-id="8ac11-114">恢复路径是一组特定的转换，这些转换随着时间的变化对数据库进行演变并保持数据库的一致性。</span><span class="sxs-lookup"><span data-stu-id="8ac11-114">A recovery path is a specific set of transformations that have evolved the database over time, yet have maintained the consistency of the database.</span></span> <span data-ttu-id="8ac11-115">恢复路径描述从“起点”(LSN,GUID) 到“终点”(LSN,GUID) 的一组 LSN。</span><span class="sxs-lookup"><span data-stu-id="8ac11-115">A recovery path describes a range of LSNs from a start point (LSN,GUID) to an end point (LSN,GUID).</span></span> <span data-ttu-id="8ac11-116">恢复路径中的 LSN 可以从起点到终点遍历一个或多个恢复分支。</span><span class="sxs-lookup"><span data-stu-id="8ac11-116">The range of LSNs in a recovery path can traverse one or more recovery branches from start to end.</span></span>  
  
## <a name="to-plan-a-restore-sequence"></a><span data-ttu-id="8ac11-117">计划还原顺序</span><span class="sxs-lookup"><span data-stu-id="8ac11-117">To Plan a Restore Sequence</span></span>  
 <span data-ttu-id="8ac11-118">启动还原顺序之前，请执行下列步骤：</span><span class="sxs-lookup"><span data-stu-id="8ac11-118">Before you start a restore sequence, follow these steps:</span></span>  
  
1.  <span data-ttu-id="8ac11-119">创建数据库的结尾日志备份（如果可以）。</span><span class="sxs-lookup"><span data-stu-id="8ac11-119">Create a tail-log backup of the database, if you can.</span></span> <span data-ttu-id="8ac11-120">有关详细信息，请参阅[结尾日志备份 (SQL Server)](tail-log-backups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-120">For more information, see [Tail-Log Backups &#40;SQL Server&#41;](tail-log-backups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="8ac11-121">确定目标恢复点。</span><span class="sxs-lookup"><span data-stu-id="8ac11-121">Determine the target recovery point.</span></span>  
  
     <span data-ttu-id="8ac11-122">目标恢复点可以是事务日志备份中的任何时间点或标记。</span><span class="sxs-lookup"><span data-stu-id="8ac11-122">The target recovery point can be any point in time or mark within a transaction log backup.</span></span> <span data-ttu-id="8ac11-123">有关详细信息，请参阅[将 SQL Server 数据库还原到某个时间点（完整恢复模式）](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md)或[使用标记的事务一致恢复相关数据库（完全恢复模式）](use-marked-transactions-to-recover-related-databases-consistently.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-123">For more information, see [Restore a SQL Server Database to a Point in Time &#40;Full Recovery Model&#41;](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md) or [Use Marked Transactions to Recover Related Databases Consistently &#40;Full Recovery Model&#41;](use-marked-transactions-to-recover-related-databases-consistently.md).</span></span>  
  
3.  <span data-ttu-id="8ac11-124">确定要执行的还原类型。</span><span class="sxs-lookup"><span data-stu-id="8ac11-124">Determine the type of restore you want to perform.</span></span> <span data-ttu-id="8ac11-125">有关详细信息，请参阅 [还原和恢复概述 (SQL Server)](restore-and-recovery-overview-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-125">For more information, see [Restore and Recovery Overview &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md).</span></span>  
  
4.  <span data-ttu-id="8ac11-126">标识您需要的备份，并确保必要的介质集和备份设备可用。</span><span class="sxs-lookup"><span data-stu-id="8ac11-126">Identify which backups you require and make sure that the necessary media sets and backup devices are available.</span></span> <span data-ttu-id="8ac11-127">有关详细信息，请参阅[备份设备 (SQL Server)](backup-devices-sql-server.md)和[媒体集、媒体簇和备份集 (SQL Server)](media-sets-media-families-and-backup-sets-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-127">For more information, see [Backup Devices &#40;SQL Server&#41;](backup-devices-sql-server.md) and [Media Sets, Media Families, and Backup Sets &#40;SQL Server&#41;](media-sets-media-families-and-backup-sets-sql-server.md).</span></span>  
  
## <a name="to-perform-a-restore-sequence"></a><span data-ttu-id="8ac11-128">执行还原顺序</span><span class="sxs-lookup"><span data-stu-id="8ac11-128">To Perform a Restore Sequence</span></span>  
 <span data-ttu-id="8ac11-129">若要执行还原顺序，请执行下列步骤：</span><span class="sxs-lookup"><span data-stu-id="8ac11-129">To perform a restore sequence, follow these steps:</span></span>  
  
1.  <span data-ttu-id="8ac11-130">若要启动该顺序，请还原一个或多个数据备份（例如数据库备份、部分备份、一个或多个文件备份）。</span><span class="sxs-lookup"><span data-stu-id="8ac11-130">To start the sequence, restore a one or more data backups, such as: a database backup, a partial backup, one or more file backups.</span></span>  
  
2.  <span data-ttu-id="8ac11-131">也可以还原基于这些完整备份的最新差异备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-131">Optionally, restore the latest differential backups that are based on these full backups.</span></span>  
  
     <span data-ttu-id="8ac11-132">对于计划还原的每个完整备份，确定它是否是任何差异备份的基础。</span><span class="sxs-lookup"><span data-stu-id="8ac11-132">For each full backup that you plan to restore, determine whether it is the base for any differential backups.</span></span> <span data-ttu-id="8ac11-133">如果是，还原最新的差异备份（如果可以）。</span><span class="sxs-lookup"><span data-stu-id="8ac11-133">If so, restore most recent differential backup, if you can.</span></span> <span data-ttu-id="8ac11-134">有关详细信息，请参阅 [差异备份 (SQL Server)](differential-backups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-134">For more information, see [Differential Backups &#40;SQL Server&#41;](differential-backups-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="8ac11-135">通过按顺序还原日志备份、完成包含恢复点的备份来前滚数据库。</span><span class="sxs-lookup"><span data-stu-id="8ac11-135">Roll forward the database by restoring log backups in sequence, finishing with the backup that contains the recovery point.</span></span> <span data-ttu-id="8ac11-136">是否必须应用所有日志备份取决于日志备份包含什么样的目标恢复点，如下所示：</span><span class="sxs-lookup"><span data-stu-id="8ac11-136">Whether you have to apply all the log backups depends on what log backup contains the target recovery point, as follows:</span></span>  
  
    -   <span data-ttu-id="8ac11-137">如果恢复点是故障点，则必须还原自上一次还原数据（完整或差异）备份以来创建的所有日志备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-137">If the recovery point is the point of a failure, you must restore every log backup that was created since the last data (full or differential) backup you restored.</span></span> <span data-ttu-id="8ac11-138">有关详细信息，请参阅[应用事务日志备份 (SQL Server)](transaction-log-backups-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-138">For more information, see [Apply Transaction Log Backups &#40;SQL Server&#41;](transaction-log-backups-sql-server.md).</span></span>  
  
    -   <span data-ttu-id="8ac11-139">对于时点还原，您可能不需要最新的日志备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-139">For a point-in-time restore, you might not require the most recent log backups.</span></span> <span data-ttu-id="8ac11-140">如果使用 [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)]，数据库恢复顾问确保仅选择需要恢复到指定时点的那些备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-140">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], the Database Recovery Advisor ensures that only backups that are required to restore to your specified point in time are selected.</span></span> <span data-ttu-id="8ac11-141">这些备份构成了为您的时点还原建议的还原计划。</span><span class="sxs-lookup"><span data-stu-id="8ac11-141">These backups make up the recommended restore plan for your point-in-time restore.</span></span> <span data-ttu-id="8ac11-142">有关详细信息，请参阅[将 SQL Server 数据库还原到某个时间点（完整恢复模式）](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md)。</span><span class="sxs-lookup"><span data-stu-id="8ac11-142">For more information, see [Restore a SQL Server Database to a Point in Time &#40;Full Recovery Model&#41;](restore-a-sql-server-database-to-a-point-in-time-full-recovery-model.md).</span></span>  
  
## <a name="restarting-a-restore-sequence"></a><span data-ttu-id="8ac11-143">重新启动还原顺序</span><span class="sxs-lookup"><span data-stu-id="8ac11-143">Restarting a Restore Sequence</span></span>  
 <span data-ttu-id="8ac11-144">如果还原顺序的结果有问题，则可以退出，并从头开始重新启动还原顺序。</span><span class="sxs-lookup"><span data-stu-id="8ac11-144">If you encounter a problem with the outcome of a restore sequence, you can quit it and restart the restore sequence over from the start.</span></span> <span data-ttu-id="8ac11-145">例如，如果意外还原了过多的日志备份并超过了想要的恢复点，则必须重新开始还原顺序，直至包含目标恢复点的日志备份。</span><span class="sxs-lookup"><span data-stu-id="8ac11-145">For example, if you accidentally restore too many log backups and overshoot the intended recovery point, you must restart the restore sequence up to log backup that contains the target recovery point.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8ac11-146">另请参阅</span><span class="sxs-lookup"><span data-stu-id="8ac11-146">See Also</span></span>  
 <span data-ttu-id="8ac11-147">[备份概述 (SQL Server)](backup-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="8ac11-147">[Backup Overview &#40;SQL Server&#41;](backup-overview-sql-server.md) </span></span>  
 <span data-ttu-id="8ac11-148">[还原和恢复概述 (SQL Server)](restore-and-recovery-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="8ac11-148">[Restore and Recovery Overview &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span></span>  
 <span data-ttu-id="8ac11-149">[完整数据库还原（完整恢复模式）](complete-database-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="8ac11-149">[Complete Database Restores &#40;Full Recovery Model&#41;](complete-database-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="8ac11-150">[联机还原 (SQL Server)](online-restore-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="8ac11-150">[Online Restore &#40;SQL Server&#41;](online-restore-sql-server.md) </span></span>  
 <span data-ttu-id="8ac11-151">[文件还原（完整恢复模式）](file-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="8ac11-151">[File Restores &#40;Full Recovery Model&#41;](file-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="8ac11-152">[还原页 (SQL Server)](restore-pages-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="8ac11-152">[Restore Pages &#40;SQL Server&#41;](restore-pages-sql-server.md) </span></span>  
 [<span data-ttu-id="8ac11-153">段落还原 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="8ac11-153">Piecemeal Restores &#40;SQL Server&#41;</span></span>](piecemeal-restores-sql-server.md)  
  
  

---
title: 差异备份 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- differential backups
- differential backups, about
ms.assetid: 123bb7af-1367-4bde-bfcb-76d36799b905
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 5c057e0d41cb46adef0ec1e01c3406190db900e4
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87590222"
---
# <a name="differential-backups-sql-server"></a><span data-ttu-id="e265a-102">差异备份 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e265a-102">Differential Backups (SQL Server)</span></span>
  <span data-ttu-id="e265a-103">此备份和还原主题与所有 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库相关。</span><span class="sxs-lookup"><span data-stu-id="e265a-103">This backup and restore topic is relevant for all [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] databases.</span></span>  
  
 <span data-ttu-id="e265a-104">差异备份基于最新的、以前的完整数据备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-104">A differential backup is based on the most recent, previous full data backup.</span></span> <span data-ttu-id="e265a-105">差异备份仅捕获自该次完整备份后发生更改的数据。</span><span class="sxs-lookup"><span data-stu-id="e265a-105">A differential backup captures only the data that has changed since that full backup.</span></span> <span data-ttu-id="e265a-106">差异备份所基于的完整备份称为差异的“基准”  。</span><span class="sxs-lookup"><span data-stu-id="e265a-106">The full backup upon which a differential backup is based is known as the *base* of the differential.</span></span> <span data-ttu-id="e265a-107">完整备份（仅复制备份除外）可以用作一系列差异备份的基准，包括数据库备份、部分备份和文件备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-107">Full backups, except for copy-only backups, can serve as the base for a series of differential backups, including database backups, partial backups, and file backups.</span></span> <span data-ttu-id="e265a-108">文件差异备份的基准备份可以包含在完整备份、文件备份或部分备份中。</span><span class="sxs-lookup"><span data-stu-id="e265a-108">The base backup for a file differential backup can be contained within a full backup, a file backup, or a partial backup.</span></span>  
  
  
##  <a name="benefits"></a><a name="Benefits"></a> <span data-ttu-id="e265a-109">优势</span><span class="sxs-lookup"><span data-stu-id="e265a-109">Benefits</span></span>  
  
-   <span data-ttu-id="e265a-110">与创建完整备份相比，创建差异备份的速度可能非常快。</span><span class="sxs-lookup"><span data-stu-id="e265a-110">Creating a differential backups can be very fast compared to creating a full backup.</span></span> <span data-ttu-id="e265a-111">差异备份只记录自差异备份所基于的完整备份后更改的数据。</span><span class="sxs-lookup"><span data-stu-id="e265a-111">A differential backup records only the data that has changed since the full backup upon the differential backup is based.</span></span> <span data-ttu-id="e265a-112">这有助于频繁地进行数据备份，减少数据丢失的风险。</span><span class="sxs-lookup"><span data-stu-id="e265a-112">This facilitates taking frequent data backups, which decrease the risk of data loss.</span></span> <span data-ttu-id="e265a-113">但是，在还原差异备份之前，必须先还原其基准。</span><span class="sxs-lookup"><span data-stu-id="e265a-113">However, before you restore a differential backup, you must restore its base.</span></span> <span data-ttu-id="e265a-114">因此，从差异备份进行还原必然要比从完整备份进行还原需要更多的步骤和时间，因为这需要两个备份文件。</span><span class="sxs-lookup"><span data-stu-id="e265a-114">Therefore restoring from a differential backup will necessarily take more steps and time than restoring from a full backup because two backup files are required.</span></span>  
  
-   <span data-ttu-id="e265a-115">如果数据库的某个子集比该数据库的其余部分修改得更为频繁，则差异数据库备份特别有用。</span><span class="sxs-lookup"><span data-stu-id="e265a-115">Differential database backups are especially useful if a subset of a database is modified more frequently than the rest of the database.</span></span> <span data-ttu-id="e265a-116">在这些情况下，使用差异数据库备份，您可以频繁执行备份，并且不会产生完整数据库备份的开销。</span><span class="sxs-lookup"><span data-stu-id="e265a-116">In these cases, differential database backups enable you back up frequently without the overhead of full database backups.</span></span>  
  
-   <span data-ttu-id="e265a-117">在完整恢复模式下，使用差异备份可以减少必须还原的日志备份的数量。</span><span class="sxs-lookup"><span data-stu-id="e265a-117">Under the full recovery model, using differential backups can reduce the number of log backups that you have to restore.</span></span>  
  
##  <a name="overview-of-differential-backups"></a><a name="Overview"></a> <span data-ttu-id="e265a-118">差异备份概述</span><span class="sxs-lookup"><span data-stu-id="e265a-118">Overview of Differential Backups</span></span>  
 <span data-ttu-id="e265a-119">差异备份捕获在创建差异基准和创建差异备份之间发生更改的任何 *盘区* （物理上连续的八个页的集合）的状态。</span><span class="sxs-lookup"><span data-stu-id="e265a-119">A differential backup captures the state of any *extents* (collections of eight physically contiguous pages) that have changed between when the differential base was created and the when differential backup is created.</span></span> <span data-ttu-id="e265a-120">这意味着，给定差异备份的大小取决于自建立差异基准后更改的数据量。</span><span class="sxs-lookup"><span data-stu-id="e265a-120">This means that the size of a given differential backup depends on the amount of data that has changed since the base.</span></span> <span data-ttu-id="e265a-121">通常，差异基准越旧，新的差异备份就越大。</span><span class="sxs-lookup"><span data-stu-id="e265a-121">Generally, the older a base is, the larger a new differential backup will be.</span></span> <span data-ttu-id="e265a-122">在一系列差异备份中，频繁更新的区可能在每个差异备份中包含不同的数据。</span><span class="sxs-lookup"><span data-stu-id="e265a-122">In a series of differential backups, a frequently updated extent is likely to contain different data in each differential backup.</span></span>  
  
 <span data-ttu-id="e265a-123">下图显示的是差异备份的工作原理。</span><span class="sxs-lookup"><span data-stu-id="e265a-123">The following illustration shows how a differential backup works.</span></span> <span data-ttu-id="e265a-124">该图显示了二十四个数据区，其中的六个已发生更改。</span><span class="sxs-lookup"><span data-stu-id="e265a-124">The figure shows 24 data extents, 6 of which have changed.</span></span> <span data-ttu-id="e265a-125">差异备份只包含这六个数据区。</span><span class="sxs-lookup"><span data-stu-id="e265a-125">The differential backup contains only these 6 data extents.</span></span> <span data-ttu-id="e265a-126">差异备份操作取决于位图页，此页针对每个区包含一位。</span><span class="sxs-lookup"><span data-stu-id="e265a-126">The differential backup operation relies on a bitmap page that contains a bit for every extent.</span></span> <span data-ttu-id="e265a-127">对于自建立差异基准后更新的每个区，该位在位图中设置为 1。</span><span class="sxs-lookup"><span data-stu-id="e265a-127">For each extent updated since the base, the bit is set to 1 in the bitmap.</span></span>  
  
 <span data-ttu-id="e265a-128">![差异位图标识更改的区](../../database-engine/media/bnr-how-diff-backups-work.gif "差异位图标识更改的区")</span><span class="sxs-lookup"><span data-stu-id="e265a-128">![Differential bitmap identifies changed extents](../../database-engine/media/bnr-how-diff-backups-work.gif "Differential bitmap identifies changed extents")</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="e265a-129">仅复制备份不能更新差异位图。</span><span class="sxs-lookup"><span data-stu-id="e265a-129">The differential bitmap is not updated by a copy-only backup.</span></span> <span data-ttu-id="e265a-130">因此，仅复制备份不会影响后续差异备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-130">Therefore, a copy-only backup does not affect subsequent differential backups.</span></span>  
  
 <span data-ttu-id="e265a-131">在建立基准之后立即执行的差异备份通常明显小于差异基准。</span><span class="sxs-lookup"><span data-stu-id="e265a-131">A differential backup that is taken fairly soon after its base is usually significantly smaller than the differential base.</span></span> <span data-ttu-id="e265a-132">这可以节省存储空间和备份时间。</span><span class="sxs-lookup"><span data-stu-id="e265a-132">This saves storage space and backup time.</span></span> <span data-ttu-id="e265a-133">但是，当数据库随着时间的推移发生更改时，数据库与特定差异基准之间的差异将增大。</span><span class="sxs-lookup"><span data-stu-id="e265a-133">However, as a database changes over time, the difference between the database and a specific differential base increases.</span></span> <span data-ttu-id="e265a-134">差异备份与其基准间隔的时间越长，差异备份可能就越大。</span><span class="sxs-lookup"><span data-stu-id="e265a-134">The longer the time between a differential backup and its base, the larger the differential backup is likely to be.</span></span> <span data-ttu-id="e265a-135">这意味着差异备份的大小最终会接近差异基准的大小。</span><span class="sxs-lookup"><span data-stu-id="e265a-135">This means that the differential backups can eventually approach the differential base in size.</span></span> <span data-ttu-id="e265a-136">较大的差异备份将失去备份更快、更小的优势。</span><span class="sxs-lookup"><span data-stu-id="e265a-136">A large differential backup loses the advantages of a faster and smaller backup.</span></span>  
  
 <span data-ttu-id="e265a-137">当差异备份的大小增大时，还原差异备份会显著延长还原数据库所需的时间。</span><span class="sxs-lookup"><span data-stu-id="e265a-137">As the differential backups increase in size, restoring a differential backup can significantly increase the time that is required to restore a database.</span></span> <span data-ttu-id="e265a-138">因此，建议按设定的间隔执行新的完整备份，以便为数据建立新的差异基准。</span><span class="sxs-lookup"><span data-stu-id="e265a-138">Therefore, we recommend that you take a new full backup at set intervals to establish a new differential base for the data.</span></span> <span data-ttu-id="e265a-139">例如，您可以每周执行一次整个数据库的完整备份（即完整数据库备份），然后在该周内执行一系列常规的差异数据库备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-139">For example, you might take a weekly full backup of the whole database (that is, a full database backup) followed by a regular series of differential database backups during the week.</span></span>  
  
 <span data-ttu-id="e265a-140">在还原过程中，还原差异备份之前，必须先还原其基准。</span><span class="sxs-lookup"><span data-stu-id="e265a-140">At restore time, before you restore a differential backup, you must restore its base.</span></span> <span data-ttu-id="e265a-141">然后只需还原最新的差异备份，即可将数据库前滚到创建差异备份的时间。</span><span class="sxs-lookup"><span data-stu-id="e265a-141">Then, restore only the most recent differential backup to bring the database forward to the time when that differential backup was created.</span></span> <span data-ttu-id="e265a-142">通常，应该先还原最新的完整备份，然后再还原基于该完整备份的最新差异备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-142">Typically, you would restore the most recent full backup followed by the most recent differential backup that is based on that full backup.</span></span>  
  
## <a name="differential-backups-of-databases-with-memory-optimized-tables"></a><span data-ttu-id="e265a-143">具有内存优化表的数据库的差异备份</span><span class="sxs-lookup"><span data-stu-id="e265a-143">Differential Backups of Databases with Memory-Optimized Tables</span></span>  
 <span data-ttu-id="e265a-144">有关具有内存优化表的数据库的差异备份的详细信息，请参阅 [备份具有内存优化表的数据库](../in-memory-oltp/memory-optimized-tables.md)。</span><span class="sxs-lookup"><span data-stu-id="e265a-144">For information about differential backups and databases with memory-optimized tables, see [Backing Up a Database with Memory-Optimized Tables](../in-memory-oltp/memory-optimized-tables.md).</span></span>  
  
##  <a name="differential-backups-of-read-only-databases"></a><a name="ReadOnlyDbs"></a> <span data-ttu-id="e265a-145">对只读数据库进行差异备份</span><span class="sxs-lookup"><span data-stu-id="e265a-145">Differential Backups of Read-Only Databases</span></span>  
 <span data-ttu-id="e265a-146">对于只读数据库，单独使用完整备份比同时使用完整备份和差异备份更容易管理。</span><span class="sxs-lookup"><span data-stu-id="e265a-146">For read-only databases, full backups used alone are easier to manage than when they are used with differential backups.</span></span> <span data-ttu-id="e265a-147">当数据库为只读时，备份和其他操作无法更改文件中包含的元数据。</span><span class="sxs-lookup"><span data-stu-id="e265a-147">When a database is read-only, backup and other operations cannot change the metadata that is contained in the file.</span></span> <span data-ttu-id="e265a-148">因此，差异备份所要求的元数据（如差异备份开始的日志序列号，即差异基准 LSN）存储在 **master** 数据库中。</span><span class="sxs-lookup"><span data-stu-id="e265a-148">Therefore, metadata that is required by a differential backup, such as the log sequence number at which the differential backup begins (the differential base LSN) is stored in the **master** database.</span></span> <span data-ttu-id="e265a-149">如果在数据库只读时采用的是差异基准，则差异位图指示的更改多于在基准备份之后实际发生的更改。</span><span class="sxs-lookup"><span data-stu-id="e265a-149">If the differential base is taken when the database is read-only, the differential bitmap indicates more changes than have actually occurred since the base backup.</span></span> <span data-ttu-id="e265a-150">额外的数据由备份读取，但不会写入到备份中，因为存储在 **backupset** 系统表中的 [differential_base_lsn](/sql/relational-databases/system-tables/backupset-transact-sql) 用于确定在基准之后是否实际更改了数据。</span><span class="sxs-lookup"><span data-stu-id="e265a-150">The extra data is read by backup, but is not written to the backup, because the **differential_base_lsn** stored in the [backupset](/sql/relational-databases/system-tables/backupset-transact-sql) system table is used to determine whether the data has actually changed since the base.</span></span>  
  
 <span data-ttu-id="e265a-151">重新构建、还原只读数据库或者分离再重新附加只读数据库后，会丢失差异基准信息。</span><span class="sxs-lookup"><span data-stu-id="e265a-151">When a read-only database is rebuilt, restored, or detached and attached, the differential-base information is lost.</span></span> <span data-ttu-id="e265a-152">这是因为 **master** 数据库与用户数据库不同步。</span><span class="sxs-lookup"><span data-stu-id="e265a-152">This occurs because the **master** database is not synchronized with the user database.</span></span> <span data-ttu-id="e265a-153">[!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 无法检测或防止此问题的出现。</span><span class="sxs-lookup"><span data-stu-id="e265a-153">The [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] cannot detect or prevent this problem.</span></span> <span data-ttu-id="e265a-154">所有后续差异备份都不是基于最新的完整备份，从而可能会出现出人意料的结果。</span><span class="sxs-lookup"><span data-stu-id="e265a-154">Any later differential backups are not based on the most recent full backup and could provide unexpected results.</span></span> <span data-ttu-id="e265a-155">若要建立新的差异基准，建议先创建完整数据库备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-155">To establish a new differential base, we recommend that you create a full database backup.</span></span>  
  
### <a name="best-practices-for-using-differential-backups-with-a-read-only-database"></a><span data-ttu-id="e265a-156">对只读数据库进行差异备份的最佳方法</span><span class="sxs-lookup"><span data-stu-id="e265a-156">Best Practices for Using Differential Backups with a Read-Only Database</span></span>  
 <span data-ttu-id="e265a-157">创建只读数据库的完整数据库备份之后，如果要创建后续差异备份，则请备份 **master** 数据库。</span><span class="sxs-lookup"><span data-stu-id="e265a-157">After you create a full database backup of a read-only database, if you intend to create a subsequent differential backup, back up the **master** database.</span></span>  
  
 <span data-ttu-id="e265a-158">如果 **master** 数据库丢失，请在还原用户数据库的任何差异备份之前，将其还原。</span><span class="sxs-lookup"><span data-stu-id="e265a-158">If the **master** database is lost, restore it before you restore any differential backup of a user database.</span></span>  
  
 <span data-ttu-id="e265a-159">如果分离和附加计划稍后对其使用差异备份的只读数据库，则应尽快执行此只读数据库和 **master** 数据库的完整数据库备份。</span><span class="sxs-lookup"><span data-stu-id="e265a-159">If you detach and attach a read-only database for which you plan to later use differential backups, as soon as it is practical, take a full database backup of both the read-only database and of the **master** database.</span></span>  
  
##  <a name="related-tasks"></a><a name="RelatedTasks"></a> <span data-ttu-id="e265a-160">相关任务</span><span class="sxs-lookup"><span data-stu-id="e265a-160">Related Tasks</span></span>  
  
-   [<span data-ttu-id="e265a-161">创建差异数据库备份 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e265a-161">Create a Differential Database Backup &#40;SQL Server&#41;</span></span>](create-a-differential-database-backup-sql-server.md)  
  
-   [<span data-ttu-id="e265a-162">还原差异数据库备份 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e265a-162">Restore a Differential Database Backup &#40;SQL Server&#41;</span></span>](restore-a-differential-database-backup-sql-server.md)  
  
  
## <a name="see-also"></a><span data-ttu-id="e265a-163">另请参阅</span><span class="sxs-lookup"><span data-stu-id="e265a-163">See Also</span></span>  
 <span data-ttu-id="e265a-164">[备份概述 (SQL Server)](backup-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="e265a-164">[Backup Overview &#40;SQL Server&#41;](backup-overview-sql-server.md) </span></span>  
 <span data-ttu-id="e265a-165">[完整数据库备份 (SQL Server)](full-database-backups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="e265a-165">[Full Database Backups &#40;SQL Server&#41;](full-database-backups-sql-server.md) </span></span>  
 <span data-ttu-id="e265a-166">[完整数据库还原（完整恢复模式）](complete-database-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="e265a-166">[Complete Database Restores &#40;Full Recovery Model&#41;](complete-database-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="e265a-167">[完整数据库还原（简单恢复模式）](complete-database-restores-simple-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="e265a-167">[Complete Database Restores &#40;Simple Recovery Model&#41;](complete-database-restores-simple-recovery-model.md) </span></span>  
 [<span data-ttu-id="e265a-168">事务日志备份 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e265a-168">Transaction Log Backups &#40;SQL Server&#41;</span></span>](transaction-log-backups-sql-server.md)  
  
  

---
title: 联机索引操作准则 | Microsoft Docs
ms.custom: ''
ms.date: 11/11/2016
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- clustered indexes, online operations
- online index operations
- indexes [SQL Server], online operations
- disk space [SQL Server], indexes
- nonclustered indexes [SQL Server], online operations
- transaction logs [SQL Server], indexes
ms.assetid: d82942e0-4a86-4b34-a65f-9f143ebe85ce
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 907fe6a826607fe1cb403ad9b8debe6faf6771fc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87590803"
---
# <a name="guidelines-for-online-index-operations"></a><span data-ttu-id="654a0-102">联机索引操作准则</span><span class="sxs-lookup"><span data-stu-id="654a0-102">Guidelines for Online Index Operations</span></span>
  <span data-ttu-id="654a0-103">执行联机索引操作时，请按照下列指南进行：</span><span class="sxs-lookup"><span data-stu-id="654a0-103">When you perform online index operations, the following guidelines apply:</span></span>  
  
-   <span data-ttu-id="654a0-104">如果基础表包含下列大型对象 (LOB) 数据类型： `image` 、 **ntext**和，则必须创建、重新生成或脱机删除聚集索引 `text` 。</span><span class="sxs-lookup"><span data-stu-id="654a0-104">Clustered indexes must be created, rebuilt, or dropped offline when the underlying table contains the following large object (LOB) data types: `image`, **ntext**, and `text`.</span></span>  
  
-   <span data-ttu-id="654a0-105">无法为本地临时表联机创建、重新生成或删除索引。</span><span class="sxs-lookup"><span data-stu-id="654a0-105">Indexes on local temp tables cannot be created, rebuilt, or dropped online.</span></span> <span data-ttu-id="654a0-106">全局临时表的索引则没有此限制。</span><span class="sxs-lookup"><span data-stu-id="654a0-106">This restriction does not apply to indexes on global temp tables.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="654a0-107">在 [!INCLUDE[msCoName](../../includes/msconame-md.md)][!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的各版本中均不提供联机索引操作。</span><span class="sxs-lookup"><span data-stu-id="654a0-107">Online index operations are not available in every edition of [!INCLUDE[msCoName](../../includes/msconame-md.md)][!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="654a0-108">有关各个版本支持的功能列表 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ，请参阅 SQL Server 2014 的各个[版本支持的功能](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md)。</span><span class="sxs-lookup"><span data-stu-id="654a0-108">For a list of features that are supported by the editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], see [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="654a0-109">下表显示了可以联机执行的索引操作以及不能联机操作的索引。</span><span class="sxs-lookup"><span data-stu-id="654a0-109">The following table shows the index operations that can be performed online and the indexes that are excluded from these online operations.</span></span> <span data-ttu-id="654a0-110">其中还包括其他限制。</span><span class="sxs-lookup"><span data-stu-id="654a0-110">Additional restrictions are also included.</span></span>  
  
|<span data-ttu-id="654a0-111">联机索引操作</span><span class="sxs-lookup"><span data-stu-id="654a0-111">Online index operation</span></span>|<span data-ttu-id="654a0-112">不能执行联机操作的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-112">Excluded indexes</span></span>|<span data-ttu-id="654a0-113">其他限制</span><span class="sxs-lookup"><span data-stu-id="654a0-113">Other restrictions</span></span>|  
|----------------------------|----------------------|------------------------|  
|<span data-ttu-id="654a0-114">ALTER INDEX REBUILD</span><span class="sxs-lookup"><span data-stu-id="654a0-114">ALTER INDEX REBUILD</span></span>|<span data-ttu-id="654a0-115">禁用的聚集索引或禁用的索引视图</span><span class="sxs-lookup"><span data-stu-id="654a0-115">Disabled clustered index or disabled indexed view</span></span><br /><br /> <span data-ttu-id="654a0-116">XML 索引</span><span class="sxs-lookup"><span data-stu-id="654a0-116">XML index</span></span> <br /><br /><span data-ttu-id="654a0-117">列存储索引</span><span class="sxs-lookup"><span data-stu-id="654a0-117">Columnstore index</span></span><br /><br /> <span data-ttu-id="654a0-118">对本地临时表的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-118">Index on a local temp table</span></span>|<span data-ttu-id="654a0-119">当表中包含不能执行联机操作的索引时，指定关键字 ALL 可能会导致操作失败。</span><span class="sxs-lookup"><span data-stu-id="654a0-119">Specifying the keyword ALL may cause the operation to fail when the table contains an excluded index.</span></span><br /><br /> <span data-ttu-id="654a0-120">有关重新生成禁用索引的其他限制。</span><span class="sxs-lookup"><span data-stu-id="654a0-120">Additional restrictions on rebuilding disabled indexes apply.</span></span> <span data-ttu-id="654a0-121">有关详细信息，请参阅 [禁用索引和约束](disable-indexes-and-constraints.md)。</span><span class="sxs-lookup"><span data-stu-id="654a0-121">For more information, see [Disable Indexes and Constraints](disable-indexes-and-constraints.md).</span></span>|  
|<span data-ttu-id="654a0-122">CREATE INDEX</span><span class="sxs-lookup"><span data-stu-id="654a0-122">CREATE INDEX</span></span>|<span data-ttu-id="654a0-123">XML 索引</span><span class="sxs-lookup"><span data-stu-id="654a0-123">XML index</span></span><br /><br /> <span data-ttu-id="654a0-124">视图的初始唯一聚集索引</span><span class="sxs-lookup"><span data-stu-id="654a0-124">Initial unique clustered index on a view</span></span><br /><br /> <span data-ttu-id="654a0-125">对本地临时表的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-125">Index on a local temp table</span></span>||  
|<span data-ttu-id="654a0-126">CREATE INDEX WITH DROP_EXISTING</span><span class="sxs-lookup"><span data-stu-id="654a0-126">CREATE INDEX WITH DROP_EXISTING</span></span>|<span data-ttu-id="654a0-127">禁用的聚集索引或禁用的索引视图</span><span class="sxs-lookup"><span data-stu-id="654a0-127">Disabled clustered index or disabled indexed view</span></span><br /><br /> <span data-ttu-id="654a0-128">对本地临时表的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-128">Index on a local temp table</span></span><br /><br /> <span data-ttu-id="654a0-129">XML 索引</span><span class="sxs-lookup"><span data-stu-id="654a0-129">XML index</span></span>||  
|<span data-ttu-id="654a0-130">DROP INDEX</span><span class="sxs-lookup"><span data-stu-id="654a0-130">DROP INDEX</span></span>|<span data-ttu-id="654a0-131">已禁用的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-131">Disabled index</span></span><br /><br /> <span data-ttu-id="654a0-132">XML 索引</span><span class="sxs-lookup"><span data-stu-id="654a0-132">XML index</span></span><br /><br /> <span data-ttu-id="654a0-133">非聚集索引</span><span class="sxs-lookup"><span data-stu-id="654a0-133">Nonclustered index</span></span><br /><br /> <span data-ttu-id="654a0-134">对本地临时表的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-134">Index on a local temp table</span></span>|<span data-ttu-id="654a0-135">无法在一条语句中指定多个索引。</span><span class="sxs-lookup"><span data-stu-id="654a0-135">Multiple indexes cannot be specified within a single statement.</span></span>|  
|<span data-ttu-id="654a0-136">ALTER TABLE ADD CONSTRAINT（PRIMARY KEY 或 UNIQUE 约束）</span><span class="sxs-lookup"><span data-stu-id="654a0-136">ALTER TABLE ADD CONSTRAINT (PRIMARY KEY or UNIQUE)</span></span>|<span data-ttu-id="654a0-137">对本地临时表的索引</span><span class="sxs-lookup"><span data-stu-id="654a0-137">Index on a local temp table</span></span><br /><br /> <span data-ttu-id="654a0-138">聚集索引</span><span class="sxs-lookup"><span data-stu-id="654a0-138">Clustered index</span></span>|<span data-ttu-id="654a0-139">每次只允许一个子句。</span><span class="sxs-lookup"><span data-stu-id="654a0-139">Only one subclause is allowed at a time.</span></span> <span data-ttu-id="654a0-140">例如，无法在同一个 ALTER TABLE 语句中添加和删除 PRIMARY KEY 或 UNIQUE 约束。</span><span class="sxs-lookup"><span data-stu-id="654a0-140">For example, you cannot add and drop PRIMARY KEY or UNIQUE constraints in the same ALTER TABLE statement.</span></span>|  
||||  
  
 <span data-ttu-id="654a0-141">在联机索引操作过程中，不能修改、截断或删除基础表。</span><span class="sxs-lookup"><span data-stu-id="654a0-141">The underlying table cannot be modified, truncated, or dropped while an online index operation is in process.</span></span>  
  
 <span data-ttu-id="654a0-142">在创建或删除聚集索引时指定的联机选项设置（ON 或 OFF）适用于任何必须重新生成的非聚集索引。</span><span class="sxs-lookup"><span data-stu-id="654a0-142">The online option setting (ON or OFF) specified when you create or drop a clustered index is applied to any nonclustered indexes that must be rebuilt.</span></span> <span data-ttu-id="654a0-143">例如，如果聚集索引是使用 CREATE INDEX WITH DROP_EXISTING、ONLINE=ON 联机生成的，则所有关联的非聚集索引也将联机重新生成。</span><span class="sxs-lookup"><span data-stu-id="654a0-143">For example, if the clustered index is built online by using CREATE INDEX WITH DROP_EXISTING, ONLINE=ON, all associated nonclustered indexes are re-created online also.</span></span>  
  
 <span data-ttu-id="654a0-144">联机创建或重新生成 UNIQUE 索引时，索引生成器和并发用户事务可能会尝试插入相同的键，从而违反唯一性。</span><span class="sxs-lookup"><span data-stu-id="654a0-144">When you create or rebuild a UNIQUE index online, the index builder and a concurrent user transaction may try to insert the same key, therefore violating uniqueness.</span></span> <span data-ttu-id="654a0-145">如果在源表中的原始行移至新的索引之前，用户输入的行插入到了新的索引（目标），则联机索引操作将失败。</span><span class="sxs-lookup"><span data-stu-id="654a0-145">If a row entered by a user is inserted into the new index (target) before the original row from the source table is moved to the new index, the online index operation will fail.</span></span>  
  
 <span data-ttu-id="654a0-146">虽然并不常见，但联机索引操作在与数据库更新进行交互时会因为用户或应用程序的活动而导致死锁。</span><span class="sxs-lookup"><span data-stu-id="654a0-146">Although not common, the online index operation can cause a deadlock when it interacts with database updates because of user or application activities.</span></span> <span data-ttu-id="654a0-147">在这些少数情况下， [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 会选择用户或应用程序活动作为死锁牺牲品。</span><span class="sxs-lookup"><span data-stu-id="654a0-147">In these rare cases, the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] will select the user or application activity as a deadlock victim.</span></span>  
  
 <span data-ttu-id="654a0-148">只有在创建多个新的非聚集索引或重新组织非聚集索引时，才能对同一个表或视图执行并发联机索引 DDL 操作。</span><span class="sxs-lookup"><span data-stu-id="654a0-148">You can perform concurrent online index DDL operations on the same table or view only when you are creating multiple new nonclustered indexes, or reorganizing nonclustered indexes.</span></span> <span data-ttu-id="654a0-149">同一时间执行的所有其他联机索引操作都将失败。</span><span class="sxs-lookup"><span data-stu-id="654a0-149">All other online index operations performed at the same time fail.</span></span> <span data-ttu-id="654a0-150">例如，对同一个表联机重新生成现有的索引时，不能联机创建新的索引。</span><span class="sxs-lookup"><span data-stu-id="654a0-150">For example, you cannot create a new index online while rebuilding an existing index online on the same table.</span></span>  
  
 <span data-ttu-id="654a0-151">索引包含一列大型对象类型，且在同一事务中在联机操作前存在更新操作时，不能执行此联机操作。</span><span class="sxs-lookup"><span data-stu-id="654a0-151">An online operation cannot be performed when an index contains a column of the large object type, and in the same transaction there are update operations before this online operation.</span></span> <span data-ttu-id="654a0-152">要解决这个问题，请将联机操作放在事务外部或将它放在事务中所有更新操作之前。</span><span class="sxs-lookup"><span data-stu-id="654a0-152">To work around this issue, place the online operation outside the transaction or place it before any updates in the transaction.</span></span>  
  
## <a name="disk-space-considerations"></a><span data-ttu-id="654a0-153">磁盘空间注意事项</span><span class="sxs-lookup"><span data-stu-id="654a0-153">Disk Space Considerations</span></span>  
 <span data-ttu-id="654a0-154">通常，联机索引操作和脱机索引操作对磁盘空间的要求相同。</span><span class="sxs-lookup"><span data-stu-id="654a0-154">Generally, disk space requirements are the same for online and offline index operations.</span></span> <span data-ttu-id="654a0-155">一种例外情况是，临时映射索引需要更多的磁盘空间。</span><span class="sxs-lookup"><span data-stu-id="654a0-155">An exception is additional disk space required by the temporary mapping index.</span></span> <span data-ttu-id="654a0-156">此临时索引是在联机索引操作（创建、重新生成或删除聚集索引）中使用的。</span><span class="sxs-lookup"><span data-stu-id="654a0-156">This temporary index is used in online index operations that create, rebuild, or drop a clustered index.</span></span> <span data-ttu-id="654a0-157">删除联机聚集索引与创建联机聚集索引需要的空间同样多。</span><span class="sxs-lookup"><span data-stu-id="654a0-157">Dropping a clustered index online requires as much space as creating a clustered index online.</span></span> <span data-ttu-id="654a0-158">有关详细信息，请参阅 [Disk Space Requirements for Index DDL Operations](disk-space-requirements-for-index-ddl-operations.md)。</span><span class="sxs-lookup"><span data-stu-id="654a0-158">For more information, see [Disk Space Requirements for Index DDL Operations](disk-space-requirements-for-index-ddl-operations.md).</span></span>  
  
## <a name="performance-considerations"></a><span data-ttu-id="654a0-159">性能注意事项</span><span class="sxs-lookup"><span data-stu-id="654a0-159">Performance Considerations</span></span>  
 <span data-ttu-id="654a0-160">虽然联机索引操作允许进行并发的用户更新活动，但如果更新活动量很大，索引操作将花费较长的时间。</span><span class="sxs-lookup"><span data-stu-id="654a0-160">Although online index operations permit concurrent user update activity, the index operations will take longer if the update activity is very heavy.</span></span> <span data-ttu-id="654a0-161">通常，无论并发更新活动的级别如何，联机索引操作都将比相应的脱机索引操作更慢。</span><span class="sxs-lookup"><span data-stu-id="654a0-161">Typically, online index operations will be slower than equivalent offline index operations regardless of the concurrent update activity level.</span></span>  
  
 <span data-ttu-id="654a0-162">由于源结构和目标结构都是在联机索引操作过程中维护的，则插入、更新和删除事务所使用的资源会增加，有可能会增长一倍。</span><span class="sxs-lookup"><span data-stu-id="654a0-162">Because both the source and target structures are maintained during the online index operation, the resource usage for insert, update, and delete transactions is increased, potentially up to double.</span></span> <span data-ttu-id="654a0-163">这会导致在索引操作过程中性能降低和使用较多的资源，尤其是 CPU 时间。</span><span class="sxs-lookup"><span data-stu-id="654a0-163">This could cause a decrease in performance and greater resource usage, especially CPU time, during the index operation.</span></span> <span data-ttu-id="654a0-164">联机索引操作将完整记入日志。</span><span class="sxs-lookup"><span data-stu-id="654a0-164">Online index operations are fully logged.</span></span>  
  
 <span data-ttu-id="654a0-165">尽管建议联机操作，但仍应评估环境和特定的需要是否满足。</span><span class="sxs-lookup"><span data-stu-id="654a0-165">Although we recommend online operations, you should evaluate your environment and specific requirements.</span></span> <span data-ttu-id="654a0-166">脱机执行索引操作可能是最好的。</span><span class="sxs-lookup"><span data-stu-id="654a0-166">It may be optimal to run index operations offline.</span></span> <span data-ttu-id="654a0-167">这样做可能会在操作过程中限制用户对数据的访问，但是操作将更快地完成并使用较少的资源。</span><span class="sxs-lookup"><span data-stu-id="654a0-167">In doing this, users have restricted access to the data during the operation, but the operation finishes faster and uses fewer resources.</span></span>  
  
 <span data-ttu-id="654a0-168">在运行 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]的多处理器计算机上，索引语句可能会像其他查询那样，使用多个处理器来执行与索引语句关联的扫描和排序操作。</span><span class="sxs-lookup"><span data-stu-id="654a0-168">On multiprocessor computers that are running [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], index statements may use more processors to perform the scan and sort operations associated with the index statement just like other queries do.</span></span> <span data-ttu-id="654a0-169">可以使用 MAXDOP 索引选项控制专用于联机索引操作的处理器数量。</span><span class="sxs-lookup"><span data-stu-id="654a0-169">You can use the MAXDOP index option to control the number of processors dedicated to the online index operation.</span></span> <span data-ttu-id="654a0-170">通过这种方式，可以在那些并发用户间平衡索引操作所使用的资源。</span><span class="sxs-lookup"><span data-stu-id="654a0-170">In this way, you can balance the resources that are used by index operation with those of the concurrent users.</span></span> <span data-ttu-id="654a0-171">有关详细信息，请参阅 [配置并行索引操作](configure-parallel-index-operations.md)。</span><span class="sxs-lookup"><span data-stu-id="654a0-171">For more information, see [Configure Parallel Index Operations](configure-parallel-index-operations.md).</span></span> <span data-ttu-id="654a0-172">有关支持并行索引操作的 SQL Server 版本的详细信息，请参阅[SQL Server 2014 的各个版本支持的功能](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md)。</span><span class="sxs-lookup"><span data-stu-id="654a0-172">For more information about the editions of SQL Server that support Parallel indexed operations, see [Features Supported by the Editions of SQL Server 2014](../../getting-started/features-supported-by-the-editions-of-sql-server-2014.md).</span></span>  
  
 <span data-ttu-id="654a0-173">由于索引操作的最后阶段持有 S 锁或 Sch-M 锁，因此当在显式用户事务（例如 BEGIN TRANSACTION...COMMIT 块）内运行联机索引操作时必须小心。</span><span class="sxs-lookup"><span data-stu-id="654a0-173">Because an S-lock or Sch-M lock is held in the final phase of the index operation, be careful when you run an online index operation inside an explicit user transaction, such as BEGIN TRANSACTION...COMMIT block.</span></span> <span data-ttu-id="654a0-174">此操作会造成在事务结束之前一直持有锁，从而妨碍用户并发。</span><span class="sxs-lookup"><span data-stu-id="654a0-174">Doing this causes the lock to be held until the end of the transaction, therefore impeding user concurrency.</span></span>  
  
 <span data-ttu-id="654a0-175">若允许通过 `MAX DOP > 1` 和 `ALLOW_PAGE_LOCKS = OFF` 选项运行联机索引重新生成，可能会增加碎片。</span><span class="sxs-lookup"><span data-stu-id="654a0-175">Online index rebuilding may increase fragmentation when it is allowed to run with `MAX DOP > 1` and `ALLOW_PAGE_LOCKS = OFF` options.</span></span> <span data-ttu-id="654a0-176">有关详细信息，请参阅 [工作方式：联机索引重新生成 - 可能造成碎片增加](https://blogs.msdn.com/b/psssql/archive/2012/09/05/how-it-works-online-index-rebuild-can-cause-increased-fragmentation.aspx)。</span><span class="sxs-lookup"><span data-stu-id="654a0-176">For more information, see [How It Works: Online Index Rebuild - Can Cause Increased Fragmentation](https://blogs.msdn.com/b/psssql/archive/2012/09/05/how-it-works-online-index-rebuild-can-cause-increased-fragmentation.aspx).</span></span>  
  
## <a name="transaction-log-considerations"></a><span data-ttu-id="654a0-177">事务日志注意事项</span><span class="sxs-lookup"><span data-stu-id="654a0-177">Transaction Log Considerations</span></span>  
 <span data-ttu-id="654a0-178">脱机或联机执行大范围的索引操作，会生成大型数据负载，这些负载会造成事务日志快速填充。</span><span class="sxs-lookup"><span data-stu-id="654a0-178">Large-scale index operations, performed offline or online, can generate large data loads that can cause the transaction log to quickly fill.</span></span> <span data-ttu-id="654a0-179">为确保索引操作可以回滚，事务日志直到索引操作完成后才可以截断，但是，可以在索引操作过程中备份日志。</span><span class="sxs-lookup"><span data-stu-id="654a0-179">To make sure that the index operation can be rolled back, the transaction log cannot be truncated until the index operation has been completed; however, the log can be backed up during the index operation.</span></span> <span data-ttu-id="654a0-180">因此，事务日志必须具有足够的空间来存储索引操作事务和所有的并发用户事务，以满足索引操作过程的需要。</span><span class="sxs-lookup"><span data-stu-id="654a0-180">Therefore, the transaction log must have sufficient space to store both the index operation transactions and any concurrent user transactions for the duration of the index operation.</span></span> <span data-ttu-id="654a0-181">有关详细信息，请参阅 [Transaction Log Disk Space for Index Operations](transaction-log-disk-space-for-index-operations.md)。</span><span class="sxs-lookup"><span data-stu-id="654a0-181">For more information, see [Transaction Log Disk Space for Index Operations](transaction-log-disk-space-for-index-operations.md).</span></span>  
  
## <a name="related-content"></a><span data-ttu-id="654a0-182">相关内容</span><span class="sxs-lookup"><span data-stu-id="654a0-182">Related Content</span></span>  
 [<span data-ttu-id="654a0-183">联机索引操作的工作方式</span><span class="sxs-lookup"><span data-stu-id="654a0-183">How Online Index Operations Work</span></span>](how-online-index-operations-work.md)  
  
 [<span data-ttu-id="654a0-184">联机执行索引操作</span><span class="sxs-lookup"><span data-stu-id="654a0-184">Perform Index Operations Online</span></span>](perform-index-operations-online.md)  
  
 [<span data-ttu-id="654a0-185">ALTER INDEX (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="654a0-185">ALTER INDEX &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-index-transact-sql)  
  
 [<span data-ttu-id="654a0-186">CREATE INDEX (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="654a0-186">CREATE INDEX &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-index-transact-sql)  
  
  

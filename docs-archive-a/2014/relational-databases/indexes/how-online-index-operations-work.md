---
title: 联机索引操作的工作方式 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: table-view-index
ms.topic: conceptual
helpviewer_keywords:
- online index operations
- source indexes [SQL Server]
- preexisting indexes [SQL Server]
- target indexes [SQL Server]
- temporary mapping index [SQL Server]
- index temporary mappings [SQL Server]
ms.assetid: eef0c9d1-790d-46e4-a758-d0bf6742e6ae
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 9b74690c9dfb980787087899200ffb45c2c4b6b6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87590790"
---
# <a name="how-online-index-operations-work"></a><span data-ttu-id="71d25-102">联机索引操作的工作方式</span><span class="sxs-lookup"><span data-stu-id="71d25-102">How Online Index Operations Work</span></span>
  <span data-ttu-id="71d25-103">本主题将定义联机索引操作中存在的结构，并显示与这些结构相关联的活动。</span><span class="sxs-lookup"><span data-stu-id="71d25-103">This topic defines the structures that exist during an online index operation and shows the activities associated with these structures.</span></span>  
  
## <a name="online-index-structures"></a><span data-ttu-id="71d25-104">联机索引结构</span><span class="sxs-lookup"><span data-stu-id="71d25-104">Online Index Structures</span></span>  
 <span data-ttu-id="71d25-105">为了在索引数据定义语言 (DDL) 操作期间允许执行并发用户活动，在在线索引操作期间使用了以下结构：源和预先存在的索引、目标以及一个临时映射索引（用于在线重新生成堆或删除聚集索引）。</span><span class="sxs-lookup"><span data-stu-id="71d25-105">To allow for concurrent user activity during an index data definition language (DDL) operation, the following structures are used during the online index operation: source and preexisting indexes, target, and for rebuilding a heap or dropping a clustered index online, a temporary mapping index.</span></span>  
  
-   <span data-ttu-id="71d25-106">**源和预先存在的索引**</span><span class="sxs-lookup"><span data-stu-id="71d25-106">**Source and preexisting indexes**</span></span>  
  
     <span data-ttu-id="71d25-107">源是指原始表或聚集索引数据。</span><span class="sxs-lookup"><span data-stu-id="71d25-107">The source is the original table or clustered index data.</span></span> <span data-ttu-id="71d25-108">预先存在的索引是指与源结构相关联的任何非聚集索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-108">Preexisting indexes are any nonclustered indexes that are associated with the source structure.</span></span> <span data-ttu-id="71d25-109">例如，如果联机索引操作正在重新生成一个与四个非聚集索引相关联的聚集索引，则源就是现有的聚集索引，而预先存在的索引就是这些非聚集索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-109">For example, if the online index operation is rebuilding a clustered index that has four associated nonclustered indexes, the source is the existing clustered index and the preexisting indexes are the nonclustered indexes.</span></span>  
  
     <span data-ttu-id="71d25-110">多个用户可以同时对预先存在的索引执行选择、插入、更新和删除操作。</span><span class="sxs-lookup"><span data-stu-id="71d25-110">The preexisting indexes are available to concurrent users for select, insert, update, and delete operations.</span></span> <span data-ttu-id="71d25-111">这包括通过触发器和引用完整性约束执行的大容量插入（支持但不建议执行）和隐式更新。</span><span class="sxs-lookup"><span data-stu-id="71d25-111">This includes bulk inserts (supported but not recommended) and implicit updates by triggers and referential integrity constraints.</span></span> <span data-ttu-id="71d25-112">所有预先存在的索引都可进行查询和搜索。</span><span class="sxs-lookup"><span data-stu-id="71d25-112">All preexisting indexes are available for queries and searches.</span></span> <span data-ttu-id="71d25-113">这意味着查询优化器可以选择预先存在的索引，如有必要，还可以在索引提示中指定预先存在的索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-113">This means they may be selected by the query optimizer and, if necessary, specified in index hints.</span></span>  
  
-   <span data-ttu-id="71d25-114">**Target**</span><span class="sxs-lookup"><span data-stu-id="71d25-114">**Target**</span></span>  
  
     <span data-ttu-id="71d25-115">目标是指正在创建或重新生成的新索引（或堆）或一组新索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-115">The target or targets is the new index (or heap) or a set of new indexes that is being created or rebuilt.</span></span> <span data-ttu-id="71d25-116">在索引操作期间，用户对源的插入、更新和删除操作是由 [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] 应用到目标的。</span><span class="sxs-lookup"><span data-stu-id="71d25-116">User insert, update, and delete operations to the source are applied by the [!INCLUDE[ssDEnoversion](../../includes/ssdenoversion-md.md)] to the target during the index operation.</span></span> <span data-ttu-id="71d25-117">例如，如果联机索引操作正在重新生成一个聚集索引，则目标就是重新生成的聚集索引， [!INCLUDE[ssDE](../../includes/ssde-md.md)] 在聚集索引重新生成后不会重新生成非聚集索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-117">For example, if the online index operation is rebuilding a clustered index, the target is the rebuilt clustered index; the [!INCLUDE[ssDE](../../includes/ssde-md.md)] does not rebuild nonclustered indexes when a clustered index is rebuilt.</span></span>  
  
     <span data-ttu-id="71d25-118">提交索引操作之前，在处理 SELECT 语句时不搜索目标索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-118">The target index is not searched while processing SELECT statements until the index operation is committed.</span></span> <span data-ttu-id="71d25-119">在内部，索引被标记为只写。</span><span class="sxs-lookup"><span data-stu-id="71d25-119">Internally, the index is marked as write-only.</span></span>  
  
-   <span data-ttu-id="71d25-120">**临时映射索引**</span><span class="sxs-lookup"><span data-stu-id="71d25-120">**Temporary mapping index**</span></span>  
  
     <span data-ttu-id="71d25-121">用于创建、删除或重新生成聚集索引的联机索引操作还需要用到临时映射索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-121">Online index operations that create, drop, or rebuild a clustered index also require a temporary mapping index.</span></span> <span data-ttu-id="71d25-122">此临时索引由并发事务用来确定当更新或删除了基础表中的行以后，要从正在生成的新索引中删除哪些记录。</span><span class="sxs-lookup"><span data-stu-id="71d25-122">This temporary index is used by concurrent transactions to determine which records to delete in the new indexes that are being built when rows in the underlying table are updated or deleted.</span></span> <span data-ttu-id="71d25-123">此非聚集索引是在创建新聚集索引（或堆）的步骤中创建的，不需要执行单独的排序操作。</span><span class="sxs-lookup"><span data-stu-id="71d25-123">This nonclustered index is created in the same step as the new clustered index (or heap) and does not require a separate sort operation.</span></span> <span data-ttu-id="71d25-124">并发事务还会在它们的所有插入、更新和删除操作中维护临时映射索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-124">Concurrent transactions also maintain the temporary mapping index in all their insert, update, and delete operations.</span></span>  
  
## <a name="online-index-activities"></a><span data-ttu-id="71d25-125">联机索引活动</span><span class="sxs-lookup"><span data-stu-id="71d25-125">Online Index Activities</span></span>  
 <span data-ttu-id="71d25-126">在简单的联机索引操作 [例如对非索引表（堆）创建聚集索引] 期间，源和目标将经历三个阶段：准备阶段、生成阶段和最后阶段。</span><span class="sxs-lookup"><span data-stu-id="71d25-126">During a simple online index operation, such as creating a clustered index on a nonindexed table (heap), the source and target go through three phases: preparation, build, and final.</span></span>  
  
 <span data-ttu-id="71d25-127">下图显示了联机创建初始聚集索引的过程。</span><span class="sxs-lookup"><span data-stu-id="71d25-127">The following illustration shows the process for creating an initial clustered index online.</span></span> <span data-ttu-id="71d25-128">源对象（即堆）没有其他索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-128">The source object (the heap) has no other indexes.</span></span> <span data-ttu-id="71d25-129">图中分别显示了每个阶段的源结构活动和目标结构活动；另外还显示了并发的用户选择、插入、更新和删除操作。</span><span class="sxs-lookup"><span data-stu-id="71d25-129">The source and target structure activities are shown for each phase; concurrent user select, insert, update, and delete operations are also shown.</span></span> <span data-ttu-id="71d25-130">准备、生成和最后阶段均与每个阶段使用的锁模式一起指明。</span><span class="sxs-lookup"><span data-stu-id="71d25-130">The preparation, build, and final phases are indicated together with the lock modes used in each phase.</span></span>  
  
 <span data-ttu-id="71d25-131">![在联机索引操作期间执行的活动](../../database-engine/media/online-index.gif "在联机索引操作期间执行的活动")</span><span class="sxs-lookup"><span data-stu-id="71d25-131">![Activities performed during online index operation](../../database-engine/media/online-index.gif "Activities performed during online index operation")</span></span>  
  
## <a name="source-structure-activities"></a><span data-ttu-id="71d25-132">源结构活动</span><span class="sxs-lookup"><span data-stu-id="71d25-132">Source Structure Activities</span></span>  
 <span data-ttu-id="71d25-133">下表列出了索引操作每个阶段中涉及源结构的活动以及相应的锁定策略。</span><span class="sxs-lookup"><span data-stu-id="71d25-133">The following table lists the activities involving the source structures during each phase of the index operation and the corresponding locking strategy.</span></span>  
  
|<span data-ttu-id="71d25-134">阶段</span><span class="sxs-lookup"><span data-stu-id="71d25-134">Phase</span></span>|<span data-ttu-id="71d25-135">源活动</span><span class="sxs-lookup"><span data-stu-id="71d25-135">Source activity</span></span>|<span data-ttu-id="71d25-136">源锁</span><span class="sxs-lookup"><span data-stu-id="71d25-136">Source locks</span></span>|  
|-----------|---------------------|------------------|  
|<span data-ttu-id="71d25-137">准备工作</span><span class="sxs-lookup"><span data-stu-id="71d25-137">Preparation</span></span><br /><br /> <span data-ttu-id="71d25-138">很短的阶段</span><span class="sxs-lookup"><span data-stu-id="71d25-138">Very short phase</span></span>|<span data-ttu-id="71d25-139">准备系统元数据以创建新的空索引结构。</span><span class="sxs-lookup"><span data-stu-id="71d25-139">System metadata preparation to create the new empty index structure.</span></span><br /><br /> <span data-ttu-id="71d25-140">定义表的一个快照。</span><span class="sxs-lookup"><span data-stu-id="71d25-140">A snapshot of the table is defined.</span></span> <span data-ttu-id="71d25-141">即，使用行版本控制提供事务级读一致性。</span><span class="sxs-lookup"><span data-stu-id="71d25-141">That is, row versioning is used to provide transaction-level read consistency.</span></span><br /><br /> <span data-ttu-id="71d25-142">对源执行的并发用户写操作将被阻塞一段很短的时间。</span><span class="sxs-lookup"><span data-stu-id="71d25-142">Concurrent user write operations on the source are blocked for a very short period.</span></span><br /><br /> <span data-ttu-id="71d25-143">不允许执行并发 DDL 操作（创建多个非聚集索引除外）。</span><span class="sxs-lookup"><span data-stu-id="71d25-143">No concurrent DDL operations are allowed except creating multiple nonclustered indexes.</span></span>|<span data-ttu-id="71d25-144">对表的 S（共享）\*</span><span class="sxs-lookup"><span data-stu-id="71d25-144">S (Shared) on the table\*</span></span><br /><br /> <span data-ttu-id="71d25-145">IS（意向共享）</span><span class="sxs-lookup"><span data-stu-id="71d25-145">IS (Intent Shared)</span></span><br /><br /> <span data-ttu-id="71d25-146">INDEX_BUILD_INTERNAL_RESOURCE\*\*</span><span class="sxs-lookup"><span data-stu-id="71d25-146">INDEX_BUILD_INTERNAL_RESOURCE\*\*</span></span>|  
|<span data-ttu-id="71d25-147">构建</span><span class="sxs-lookup"><span data-stu-id="71d25-147">Build</span></span><br /><br /> <span data-ttu-id="71d25-148">主要阶段</span><span class="sxs-lookup"><span data-stu-id="71d25-148">Main phase</span></span>|<span data-ttu-id="71d25-149">在大容量加载操作中对数据进行扫描、排序、合并并将数据插入到目标中。</span><span class="sxs-lookup"><span data-stu-id="71d25-149">The data is scanned, sorted, merged, and inserted into the target in bulk load operations.</span></span><br /><br /> <span data-ttu-id="71d25-150">并发的用户选择、插入、更新和删除操作将被同时应用到预先存在的索引和所有正在生成的新索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-150">Concurrent user select, insert, update, and delete operations are applied to both the preexisting indexes and any new indexes being built.</span></span>|<span data-ttu-id="71d25-151">IS</span><span class="sxs-lookup"><span data-stu-id="71d25-151">IS</span></span><br /><br /> <span data-ttu-id="71d25-152">INDEX_BUILD_INTERNAL_RESOURCE\*\*</span><span class="sxs-lookup"><span data-stu-id="71d25-152">INDEX_BUILD_INTERNAL_RESOURCE\*\*</span></span>|  
|<span data-ttu-id="71d25-153">最后</span><span class="sxs-lookup"><span data-stu-id="71d25-153">Final</span></span><br /><br /> <span data-ttu-id="71d25-154">很短的阶段</span><span class="sxs-lookup"><span data-stu-id="71d25-154">Very short phase</span></span>|<span data-ttu-id="71d25-155">必须完成所有未提交的更新事务，这一阶段才能开始。</span><span class="sxs-lookup"><span data-stu-id="71d25-155">All uncommitted update transactions must complete before this phase starts.</span></span> <span data-ttu-id="71d25-156">根据获取的锁，所有新的用户读/写事务将被阻塞一段很短的时间，直到此阶段完成为止。</span><span class="sxs-lookup"><span data-stu-id="71d25-156">Depending on the acquired lock, all new user read or write transactions are blocked for a very short period until this phase is completed.</span></span><br /><br /> <span data-ttu-id="71d25-157">系统元数据将被更新以便用目标替换源。</span><span class="sxs-lookup"><span data-stu-id="71d25-157">System metadata is updated to replace the source with the target.</span></span><br /><br /> <span data-ttu-id="71d25-158">如有必要，源将被删除。</span><span class="sxs-lookup"><span data-stu-id="71d25-158">The source is dropped if it is required.</span></span> <span data-ttu-id="71d25-159">例如，在重新生成或删除聚集索引之后。</span><span class="sxs-lookup"><span data-stu-id="71d25-159">For example, after rebuilding or dropping a clustered index.</span></span>|<span data-ttu-id="71d25-160">INDEX_BUILD_INTERNAL_RESOURCE\*\*</span><span class="sxs-lookup"><span data-stu-id="71d25-160">INDEX_BUILD_INTERNAL_RESOURCE\*\*</span></span><br /><br /> <span data-ttu-id="71d25-161">如果创建的是非聚集索引，则为对表的 S。\*</span><span class="sxs-lookup"><span data-stu-id="71d25-161">S on the table if creating a nonclustered index.\*</span></span><br /><br /> <span data-ttu-id="71d25-162">如果删除了任何源结构（索引或表），则为 SCH-M（架构修改）。\*</span><span class="sxs-lookup"><span data-stu-id="71d25-162">SCH-M (Schema Modification) if any source structure (index or table) is dropped.\*</span></span>|  
  
 <span data-ttu-id="71d25-163">\* 索引操作将等待任何未提交的更新事务完成后，才会获取对表的 S 锁或 SCH-M 锁。</span><span class="sxs-lookup"><span data-stu-id="71d25-163">\* The index operation will wait for any uncommitted update transactions to complete before acquiring the S lock or SCH-M lock on the table.</span></span>  
  
 <span data-ttu-id="71d25-164">\*\* 在索引操作执行过程中，资源锁 INDEX_BUILD_INTERNAL_RESOURCE 将阻止对源和预先存在的结构执行并发数据定义语言 (DDL) 操作。</span><span class="sxs-lookup"><span data-stu-id="71d25-164">\*\* The resource lock INDEX_BUILD_INTERNAL_RESOURCE prevents the execution of concurrent data definition language (DDL) operations on the source and preexisting structures while the index operation is in progress.</span></span> <span data-ttu-id="71d25-165">例如，此锁将会阻止为同一表同时重新生成两个索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-165">For example, this lock prevents concurrent rebuild of two indexes on the same table.</span></span> <span data-ttu-id="71d25-166">虽然此资源锁与 Sch-M 锁相关联，但它不会阻止数据操作语句。</span><span class="sxs-lookup"><span data-stu-id="71d25-166">Although this resource lock is associated with the Sch-M lock, it does not prevent data manipulation statements.</span></span>  
  
 <span data-ttu-id="71d25-167">上一个表显示了在涉及单个索引的联机索引操作生成阶段获取的单个共享锁（S 锁）。</span><span class="sxs-lookup"><span data-stu-id="71d25-167">The previous table shows a single Shared (S) lock acquired during the build phase of an online index operation that involves a single index.</span></span> <span data-ttu-id="71d25-168">当在单个联机索引操作中（例如，在为包含一个或多个非聚集索引的表创建初始聚集索引的过程中）生成或重新生成聚集索引和非聚集索引后，在生成阶段将获取两个短期 S 锁，然后再获取长期意向共享 (IS) 锁。</span><span class="sxs-lookup"><span data-stu-id="71d25-168">When clustered and nonclustered indexes are built, or rebuilt, in a single online index operation (for example, during the initial clustered index creation on a table that contains one or more nonclustered indexes) two short-term S locks are acquired during the build phase followed by long-term Intent Shared (IS) locks.</span></span> <span data-ttu-id="71d25-169">首先获取一个 S 锁以创建聚集索引，当完成聚集索引的创建后，再获取第二个短期 S 锁以创建非聚集索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-169">One S lock is acquired first for the clustered index creation and when creating the clustered index is completed, a second short-term S lock is acquired for creating the nonclustered indexes.</span></span> <span data-ttu-id="71d25-170">创建完非聚集索引后，S 锁会降级为 IS 锁，直到联机索引操作的最后阶段。</span><span class="sxs-lookup"><span data-stu-id="71d25-170">After the nonclustered indexes are created, the S lock is downgraded to an IS lock until the final phase of the online index operation.</span></span>  
  
### <a name="target-structure-activities"></a><span data-ttu-id="71d25-171">目标结构活动</span><span class="sxs-lookup"><span data-stu-id="71d25-171">Target Structure Activities</span></span>  
 <span data-ttu-id="71d25-172">下表列出了索引操作每个阶段中涉及目标结构的活动以及相应的锁定策略。</span><span class="sxs-lookup"><span data-stu-id="71d25-172">The following table lists the activities that involve the target structure during each phase of the index operation and the corresponding locking strategy.</span></span>  
  
|<span data-ttu-id="71d25-173">阶段</span><span class="sxs-lookup"><span data-stu-id="71d25-173">Phase</span></span>|<span data-ttu-id="71d25-174">目标活动</span><span class="sxs-lookup"><span data-stu-id="71d25-174">Target activity</span></span>|<span data-ttu-id="71d25-175">目标锁</span><span class="sxs-lookup"><span data-stu-id="71d25-175">Target locks</span></span>|  
|-----------|---------------------|------------------|  
|<span data-ttu-id="71d25-176">准备工作</span><span class="sxs-lookup"><span data-stu-id="71d25-176">Preparation</span></span>|<span data-ttu-id="71d25-177">创建新索引并将其设置为只写。</span><span class="sxs-lookup"><span data-stu-id="71d25-177">New index is created and set to write-only.</span></span>|<span data-ttu-id="71d25-178">IS</span><span class="sxs-lookup"><span data-stu-id="71d25-178">IS</span></span>|  
|<span data-ttu-id="71d25-179">构建</span><span class="sxs-lookup"><span data-stu-id="71d25-179">Build</span></span>|<span data-ttu-id="71d25-180">从源插入数据。</span><span class="sxs-lookup"><span data-stu-id="71d25-180">Data is inserted from source.</span></span><br /><br /> <span data-ttu-id="71d25-181">应用已应用到源的用户修改（插入、更新、删除）。</span><span class="sxs-lookup"><span data-stu-id="71d25-181">User modifications (inserts, updates, deletes) applied to the source are applied.</span></span><br /><br /> <span data-ttu-id="71d25-182">此活动对用户是透明的。</span><span class="sxs-lookup"><span data-stu-id="71d25-182">This activity is transparent to the user.</span></span>|<span data-ttu-id="71d25-183">IS</span><span class="sxs-lookup"><span data-stu-id="71d25-183">IS</span></span>|  
|<span data-ttu-id="71d25-184">最后</span><span class="sxs-lookup"><span data-stu-id="71d25-184">Final</span></span>|<span data-ttu-id="71d25-185">将更新索引元数据。</span><span class="sxs-lookup"><span data-stu-id="71d25-185">Index metadata is updated.</span></span><br /><br /> <span data-ttu-id="71d25-186">索引将被设置为读/写状态。</span><span class="sxs-lookup"><span data-stu-id="71d25-186">Index is set to read/write status.</span></span>|<span data-ttu-id="71d25-187">S</span><span class="sxs-lookup"><span data-stu-id="71d25-187">S</span></span><br /><br /> <span data-ttu-id="71d25-188">或</span><span class="sxs-lookup"><span data-stu-id="71d25-188">or</span></span><br /><br /> <span data-ttu-id="71d25-189">SCH-M</span><span class="sxs-lookup"><span data-stu-id="71d25-189">SCH-M</span></span>|  
  
 <span data-ttu-id="71d25-190">在完成索引操作之前，不能通过用户发出的 SELECT 语句来访问目标。</span><span class="sxs-lookup"><span data-stu-id="71d25-190">The target is not accessed by SELECT statements issued by the user until the index operation is completed.</span></span>  
  
 <span data-ttu-id="71d25-191">完成准备阶段和最后阶段之后，存储在过程缓存中的查询和更新计划将失效。</span><span class="sxs-lookup"><span data-stu-id="71d25-191">After the preparation and final phase is completed, the query and update plans that are stored in the procedure cache are invalidated.</span></span> <span data-ttu-id="71d25-192">随后的查询将使用新的索引。</span><span class="sxs-lookup"><span data-stu-id="71d25-192">Subsequent queries will use the new index.</span></span>  
  
 <span data-ttu-id="71d25-193">为联机索引操作所涉及的表声明的游标仅在联机索引阶段有效。</span><span class="sxs-lookup"><span data-stu-id="71d25-193">The lifetime of a cursor declared on a table that is involved in an online index operation is limited by the online index phases.</span></span> <span data-ttu-id="71d25-194">更新游标在每个阶段均无效。</span><span class="sxs-lookup"><span data-stu-id="71d25-194">Update cursors are invalidated at each phase.</span></span> <span data-ttu-id="71d25-195">只读游标在最后阶段之后才失效。</span><span class="sxs-lookup"><span data-stu-id="71d25-195">Read-only cursors are invalidated only after the final phase.</span></span>  
  
## <a name="related-content"></a><span data-ttu-id="71d25-196">相关内容</span><span class="sxs-lookup"><span data-stu-id="71d25-196">Related Content</span></span>  
 [<span data-ttu-id="71d25-197">联机执行索引操作</span><span class="sxs-lookup"><span data-stu-id="71d25-197">Perform Index Operations Online</span></span>](perform-index-operations-online.md)  
  
 [<span data-ttu-id="71d25-198">联机索引操作准则</span><span class="sxs-lookup"><span data-stu-id="71d25-198">Guidelines for Online Index Operations</span></span>](guidelines-for-online-index-operations.md)  
  
  

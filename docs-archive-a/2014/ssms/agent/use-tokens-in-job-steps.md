---
title: 在作业步骤中使用标记 | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ssms
ms.topic: conceptual
helpviewer_keywords:
- job steps [SQL Server Agent]
- security [SQL Server Agent], enabling alert job step tokens
- SQL Server Agent jobs, job steps
- tokens [SQL Server]
- escape macros [SQL Server Agent]
ms.assetid: 105bbb66-0ade-4b46-b8e4-f849e5fc4d43
author: stevestein
ms.author: sstein
ms.openlocfilehash: 9d90b6660dd4b65e4e1d9b832b39ffaa275c83bc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87694203"
---
# <a name="use-tokens-in-job-steps"></a><span data-ttu-id="67061-102">在作业步骤中使用标记</span><span class="sxs-lookup"><span data-stu-id="67061-102">Use Tokens in Job Steps</span></span>
  [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="67061-103">通过代理，你可以在 [!INCLUDE[tsql](../../includes/tsql-md.md)] 作业步骤脚本中使用标记。</span><span class="sxs-lookup"><span data-stu-id="67061-103">Agent allows you to use tokens in [!INCLUDE[tsql](../../includes/tsql-md.md)] job step scripts.</span></span> <span data-ttu-id="67061-104">如果在编写作业步骤时使用标记，则可以为您提供编写软件程序时使用变量所提供的灵活性。</span><span class="sxs-lookup"><span data-stu-id="67061-104">Using tokens when you write your job steps gives you the same flexibility that variables provide when you write software programs.</span></span> <span data-ttu-id="67061-105">在作业步骤脚本中插入令牌之后， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理便会在运行时 [!INCLUDE[tsql](../../includes/tsql-md.md)] 子系统执行作业步骤之前替换此不标记。</span><span class="sxs-lookup"><span data-stu-id="67061-105">After you insert a token in a job step script, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent replaces the token at run time, before the job step is executed by the [!INCLUDE[tsql](../../includes/tsql-md.md)] subsystem.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="67061-106">从 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] Service Pack 1 开始， [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理作业步骤的标记语法已发生更改。</span><span class="sxs-lookup"><span data-stu-id="67061-106">Starting with [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] Service Pack 1, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job step token syntax changed.</span></span> <span data-ttu-id="67061-107">因此，作业步骤中使用的所有标记现在必须附带转义宏，否则，这些作业步骤将会失败。</span><span class="sxs-lookup"><span data-stu-id="67061-107">As a result, an escape macro must now accompany all tokens used in job steps, or else those job steps will fail.</span></span> <span data-ttu-id="67061-108">下列部分说明了使用转义宏和更新使用标记的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理作业步骤：“了解标记用法”、“[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理标记和宏”以及“更新作业步骤以使用宏”。</span><span class="sxs-lookup"><span data-stu-id="67061-108">Using escape macros and updating your [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job steps that use tokens are described in the following sections, "Understanding Using Tokens," "[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent Tokens and Macros," and "Updating Job Steps to Use Macros."</span></span> <span data-ttu-id="67061-109">此外，使用方括号调用 [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] 代理作业步骤标记的 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 语法（例如，“`[DATE]`”）也已发生更改。</span><span class="sxs-lookup"><span data-stu-id="67061-109">In addition, the [!INCLUDE[ssVersion2000](../../includes/ssversion2000-md.md)] syntax, which used square brackets to call out [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job step tokens (for example, "`[DATE]`") has also changed.</span></span> <span data-ttu-id="67061-110">现在，必须用括号将令牌名称括起来，并在令牌语法的开头加上美元符号 (`$`)。</span><span class="sxs-lookup"><span data-stu-id="67061-110">You must now enclose token names in parentheses and place a dollar sign (`$`) at the beginning of the token syntax.</span></span> <span data-ttu-id="67061-111">例如：</span><span class="sxs-lookup"><span data-stu-id="67061-111">For example:</span></span>  
>   
>  <span data-ttu-id="67061-112">`$(ESCAPE_` *宏名* `(DATE))`</span><span class="sxs-lookup"><span data-stu-id="67061-112">`$(ESCAPE_` *macro name* `(DATE))`</span></span>  
  
## <a name="understanding-using-tokens"></a><span data-ttu-id="67061-113">了解标记用法</span><span class="sxs-lookup"><span data-stu-id="67061-113">Understanding Using Tokens</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="67061-114">对 Windows 事件日志拥有写入权限的任何 Windows 用户都可以访问由 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理警报或 WMI 警报激活的作业步骤。</span><span class="sxs-lookup"><span data-stu-id="67061-114">Any Windows user with write permissions on the Windows Event Log can access job steps that are activated by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent alerts or WMI alerts.</span></span> <span data-ttu-id="67061-115">为了防范此安全隐患，默认情况下，可以在由警报激活的作业中使用的特定 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理标记已被禁用。</span><span class="sxs-lookup"><span data-stu-id="67061-115">To avoid this security risk, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent tokens that can be used in jobs activated by alerts are disabled by default.</span></span> <span data-ttu-id="67061-116">这些标记包括： **DBN**、 **SVR**、 **a-ERR**、**严重性**、 **a-MSG**和\**WMI (*`property`\*) \*\*。</span><span class="sxs-lookup"><span data-stu-id="67061-116">These tokens are: **A-DBN**, **A-SVR**, **A-ERR**, **A-SEV**, **A-MSG**., and **WMI(*`property`*)**.</span></span> <span data-ttu-id="67061-117">请注意，在此版本中，对标记的使用扩展至所有警报。</span><span class="sxs-lookup"><span data-stu-id="67061-117">Note that in this release, use of tokens is extended to all alerting.</span></span>  
>   
>  <span data-ttu-id="67061-118">如果您需要使用这些标记，请首先确保只有可信任的 Windows 安全组（如 Administrators 组）成员才对安装 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的计算机的事件日志拥有写入权限。</span><span class="sxs-lookup"><span data-stu-id="67061-118">If you need to use these tokens, first ensure that only members of trusted Windows security groups, such as the Administrators group, have write permissions on the Event Log of the computer where [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] resides.</span></span> <span data-ttu-id="67061-119">然后在对象资源管理器中右键单击“SQL Server 代理”\*\*\*\*，选择“属性”\*\*\*\*，并在“警报系统”\*\*\*\* 页上选择“为警报的所有作业响应替换标记”\*\*\*\* 以启用这些标记。</span><span class="sxs-lookup"><span data-stu-id="67061-119">Then, right-click **SQL Server Agent** in Object Explorer, select **Properties**, and on the **Alert System** page, select **Replace tokens for all job responses to alerts** to enable these tokens.</span></span>  
  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="67061-120">代理标记替换简单且有效： [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理以准确的文字字符串值替换标记。</span><span class="sxs-lookup"><span data-stu-id="67061-120">Agent token replacement is simple and efficient: [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent replaces an exact literal string value for the token.</span></span> <span data-ttu-id="67061-121">所有标记都是区分大小写的。</span><span class="sxs-lookup"><span data-stu-id="67061-121">All tokens are case-sensitive.</span></span> <span data-ttu-id="67061-122">您的作业步骤必须考虑到这一点，并且将所用标记正确地用引号引起来或将替换字符串转换为正确的数据类型。</span><span class="sxs-lookup"><span data-stu-id="67061-122">Your job steps must take this into account and correctly quote the tokens you use or convert the replacement string to the correct data type.</span></span>  
  
 <span data-ttu-id="67061-123">例如，您可以在作业步骤中使用以下语句输出数据库的名称：</span><span class="sxs-lookup"><span data-stu-id="67061-123">For example, you might use the following statement to print the name of the database in a job step:</span></span>  
  
 `PRINT N'Current database name is $(ESCAPE_SQUOTE(A-DBN))' ;`  
  
 <span data-ttu-id="67061-124">在此示例中，针对 **A-DBN** 标记插入 **ESCAPE_SQUOTE** 宏。</span><span class="sxs-lookup"><span data-stu-id="67061-124">In this example, the **ESCAPE_SQUOTE** macro is inserted with the **A-DBN** token.</span></span> <span data-ttu-id="67061-125">运行时， **A-DBN** 标记将替换为相应的数据库名称。</span><span class="sxs-lookup"><span data-stu-id="67061-125">At run time, the **A-DBN** token will be replaced with the appropriate database name.</span></span> <span data-ttu-id="67061-126">转义宏将转义可能会在标记替换字符串中意外传递的任何单引号。</span><span class="sxs-lookup"><span data-stu-id="67061-126">The escape macro escapes any single quotation marks that may be inadvertently passed in the token replacement string.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="67061-127">代理在最终字符串中将一个单引号替换为两个单引号。</span><span class="sxs-lookup"><span data-stu-id="67061-127">Agent will replace one single quotation mark with two single quotation marks in the final string.</span></span>  
  
 <span data-ttu-id="67061-128">例如，如果用来替换标记的已传递字符串为 `AdventureWorks2012'SELECT @@VERSION --`，则由 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理作业步骤执行的命令将为：</span><span class="sxs-lookup"><span data-stu-id="67061-128">For example, if the string passed to replace the token is `AdventureWorks2012'SELECT @@VERSION --`, the command executed by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job step will be:</span></span>  
  
 `PRINT N'Current database name is AdventureWorks2012''SELECT @@VERSION --' ;`  
  
 <span data-ttu-id="67061-129">在这种情况下，不会执行已插入的语句 `SELECT @@VERSION`。</span><span class="sxs-lookup"><span data-stu-id="67061-129">In this case, the inserted statement, `SELECT @@VERSION`, does not execute.</span></span> <span data-ttu-id="67061-130">相反，多余的单引号会导致服务器将已插入语句作为字符串进行分析。</span><span class="sxs-lookup"><span data-stu-id="67061-130">Instead, the extra single quotation mark causes the server to parse the inserted statement as a string.</span></span> <span data-ttu-id="67061-131">如果标记替换字符串不包含单引号，则不会转义任何字符，并且包含此标记的作业步骤会按预期方式执行。</span><span class="sxs-lookup"><span data-stu-id="67061-131">If the token replacement string does not contain a single quotation mark, no characters are escaped and the job step containing the token executes as intended.</span></span>  
  
 <span data-ttu-id="67061-132">若要在作业步骤中调试标记使用，请使用 `PRINT N'$(ESCAPE_SQUOTE(SQLDIR))'` 之类的输出语句并将作业步骤输出保存到文件或表。</span><span class="sxs-lookup"><span data-stu-id="67061-132">To debug token usage in your job steps, use print statements such as `PRINT N'$(ESCAPE_SQUOTE(SQLDIR))'` and save job step output to a file or table.</span></span> <span data-ttu-id="67061-133">可以使用“作业步骤属性”\*\*\*\* 对话框的“高级”\*\*\*\* 页指定作业步骤输出文件或表。</span><span class="sxs-lookup"><span data-stu-id="67061-133">Use the **Advanced** page of the **Job Step Properties** dialog box to specify a job step output file or table.</span></span>  
  
## <a name="sql-server-agent-tokens-and-macros"></a><span data-ttu-id="67061-134">SQL Server 代理标记和宏</span><span class="sxs-lookup"><span data-stu-id="67061-134">SQL Server Agent Tokens and Macros</span></span>  
 <span data-ttu-id="67061-135">下列各表列出并说明了 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理支持的标记和宏。</span><span class="sxs-lookup"><span data-stu-id="67061-135">The following tables list and describe the tokens and macros that [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent supports.</span></span>  
  
### <a name="sql-server-agent-tokens"></a><span data-ttu-id="67061-136">SQL Server 代理标记</span><span class="sxs-lookup"><span data-stu-id="67061-136">SQL Server Agent Tokens</span></span>  
  
|<span data-ttu-id="67061-137">标记</span><span class="sxs-lookup"><span data-stu-id="67061-137">Token</span></span>|<span data-ttu-id="67061-138">说明</span><span class="sxs-lookup"><span data-stu-id="67061-138">Description</span></span>|  
|-----------|-----------------|  
|<span data-ttu-id="67061-139">**(A-DBN)**</span><span class="sxs-lookup"><span data-stu-id="67061-139">**(A-DBN)**</span></span>|<span data-ttu-id="67061-140">数据库名称。</span><span class="sxs-lookup"><span data-stu-id="67061-140">Database name.</span></span> <span data-ttu-id="67061-141">如果作业由某个警报运行，则在作业步骤中，数据库名称值将自动替换此标记。</span><span class="sxs-lookup"><span data-stu-id="67061-141">If the job is run by an alert, the database name value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="67061-142">**(A-SVR)**</span><span class="sxs-lookup"><span data-stu-id="67061-142">**(A-SVR)**</span></span>|<span data-ttu-id="67061-143">服务器名称。</span><span class="sxs-lookup"><span data-stu-id="67061-143">Server name.</span></span> <span data-ttu-id="67061-144">如果作业由某个警报运行，则在作业步骤中，服务器名称值将自动替换此标记。</span><span class="sxs-lookup"><span data-stu-id="67061-144">If the job is run by an alert, the server name value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="67061-145">**(A-ERR)**</span><span class="sxs-lookup"><span data-stu-id="67061-145">**(A-ERR)**</span></span>|<span data-ttu-id="67061-146">错误号。</span><span class="sxs-lookup"><span data-stu-id="67061-146">Error number.</span></span> <span data-ttu-id="67061-147">如果作业由某个警报运行，则在作业步骤中，错误号值将自动替换此标记。</span><span class="sxs-lookup"><span data-stu-id="67061-147">If the job is run by an alert, the error number value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="67061-148">**(A-SEV)**</span><span class="sxs-lookup"><span data-stu-id="67061-148">**(A-SEV)**</span></span>|<span data-ttu-id="67061-149">错误严重性。</span><span class="sxs-lookup"><span data-stu-id="67061-149">Error severity.</span></span> <span data-ttu-id="67061-150">如果作业由某个警报运行，则在作业步骤中，错误严重性值将自动替换此标记。</span><span class="sxs-lookup"><span data-stu-id="67061-150">If the job is run by an alert, the error severity value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="67061-151">**(A-MSG)**</span><span class="sxs-lookup"><span data-stu-id="67061-151">**(A-MSG)**</span></span>|<span data-ttu-id="67061-152">消息正文。</span><span class="sxs-lookup"><span data-stu-id="67061-152">Message text.</span></span> <span data-ttu-id="67061-153">如果作业由某个警报运行，则在作业步骤中，消息正文值将自动替换此标记。</span><span class="sxs-lookup"><span data-stu-id="67061-153">If the job is run by an alert, the message text value automatically replaces this token in the job step.</span></span>|  
|<span data-ttu-id="67061-154">\*\* (日期) \*\*</span><span class="sxs-lookup"><span data-stu-id="67061-154">**(DATE)**</span></span>|<span data-ttu-id="67061-155">当前日期（以 YYYYMMDD 格式表示）。</span><span class="sxs-lookup"><span data-stu-id="67061-155">Current date (in YYYYMMDD format).</span></span>|  
|<span data-ttu-id="67061-156">\*\* (指令) \*\*</span><span class="sxs-lookup"><span data-stu-id="67061-156">**(INST)**</span></span>|<span data-ttu-id="67061-157">实例名。</span><span class="sxs-lookup"><span data-stu-id="67061-157">Instance name.</span></span> <span data-ttu-id="67061-158">对于默认实例，此标记将具有默认实例名称：MSSQLSERVER。</span><span class="sxs-lookup"><span data-stu-id="67061-158">For a default instance, this token will have the default instance name: MSSQLSERVER.</span></span>|  
|<span data-ttu-id="67061-159">\*\* (JOBID) \*\*</span><span class="sxs-lookup"><span data-stu-id="67061-159">**(JOBID)**</span></span>|<span data-ttu-id="67061-160">作业 ID。</span><span class="sxs-lookup"><span data-stu-id="67061-160">Job ID.</span></span>|  
|<span data-ttu-id="67061-161">**(MACH)**</span><span class="sxs-lookup"><span data-stu-id="67061-161">**(MACH)**</span></span>|<span data-ttu-id="67061-162">计算机名称。</span><span class="sxs-lookup"><span data-stu-id="67061-162">Computer name.</span></span>|  
|<span data-ttu-id="67061-163">**(MSSA)**</span><span class="sxs-lookup"><span data-stu-id="67061-163">**(MSSA)**</span></span>|<span data-ttu-id="67061-164">主 SQLServerAgent 服务名称。</span><span class="sxs-lookup"><span data-stu-id="67061-164">Master SQLServerAgent service name.</span></span>|  
|<span data-ttu-id="67061-165">**(OSCMD)**</span><span class="sxs-lookup"><span data-stu-id="67061-165">**(OSCMD)**</span></span>|<span data-ttu-id="67061-166">用于运行 **CmdExec** 作业步骤的程序的前缀。</span><span class="sxs-lookup"><span data-stu-id="67061-166">Prefix for the program used to run **CmdExec** job steps.</span></span>|  
|<span data-ttu-id="67061-167">**(SQLDIR)**</span><span class="sxs-lookup"><span data-stu-id="67061-167">**(SQLDIR)**</span></span>|<span data-ttu-id="67061-168">安装 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的目录。</span><span class="sxs-lookup"><span data-stu-id="67061-168">The directory in which [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] is installed.</span></span> <span data-ttu-id="67061-169">默认情况下，此值为 C:\Program Files\Microsoft SQL Server\MSSQL。</span><span class="sxs-lookup"><span data-stu-id="67061-169">By default, this value is C:\Program Files\Microsoft SQL Server\MSSQL.</span></span>|  
|<span data-ttu-id="67061-170">**(SQLLOGDIR)**</span><span class="sxs-lookup"><span data-stu-id="67061-170">**(SQLLOGDIR)**</span></span>|<span data-ttu-id="67061-171">SQL Server 错误日志文件夹路径的替换标记 – 例如 $(ESCAPE_SQUOTE(SQLLOGDIR))。</span><span class="sxs-lookup"><span data-stu-id="67061-171">Replacement token for the SQL Server error log folder path - for example, $(ESCAPE_SQUOTE(SQLLOGDIR)).</span></span>|  
|<span data-ttu-id="67061-172">**(STEPCT)**</span><span class="sxs-lookup"><span data-stu-id="67061-172">**(STEPCT)**</span></span>|<span data-ttu-id="67061-173">此步骤已执行的次数（不包括重试）。</span><span class="sxs-lookup"><span data-stu-id="67061-173">A count of the number of times this step has executed (excluding retries).</span></span> <span data-ttu-id="67061-174">步骤命令可以使用它来强制终止多步骤循环。</span><span class="sxs-lookup"><span data-stu-id="67061-174">Can be used by the step command to force termination of a multistep loop.</span></span>|  
|<span data-ttu-id="67061-175">\*\* (STEPID) \*\*</span><span class="sxs-lookup"><span data-stu-id="67061-175">**(STEPID)**</span></span>|<span data-ttu-id="67061-176">步骤 ID。</span><span class="sxs-lookup"><span data-stu-id="67061-176">Step ID.</span></span>|  
|<span data-ttu-id="67061-177">**(SRVR)**</span><span class="sxs-lookup"><span data-stu-id="67061-177">**(SRVR)**</span></span>|<span data-ttu-id="67061-178">运行 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的计算机的名称。</span><span class="sxs-lookup"><span data-stu-id="67061-178">Name of the computer running [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="67061-179">如果 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例是命名实例，此值将包含实例名。</span><span class="sxs-lookup"><span data-stu-id="67061-179">If the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance is a named instance, this includes the instance name.</span></span>|  
|<span data-ttu-id="67061-180">\*\* (时间) \*\*</span><span class="sxs-lookup"><span data-stu-id="67061-180">**(TIME)**</span></span>|<span data-ttu-id="67061-181">当前时间（以 HHMMSS 格式表示）。</span><span class="sxs-lookup"><span data-stu-id="67061-181">Current time (in HHMMSS format).</span></span>|  
|<span data-ttu-id="67061-182">**(STRTTM)**</span><span class="sxs-lookup"><span data-stu-id="67061-182">**(STRTTM)**</span></span>|<span data-ttu-id="67061-183">作业开始执行的时间（以 HHMMSS 格式表示）。</span><span class="sxs-lookup"><span data-stu-id="67061-183">The time (in HHMMSS format) that the job began executing.</span></span>|  
|<span data-ttu-id="67061-184">**(STRTDT)**</span><span class="sxs-lookup"><span data-stu-id="67061-184">**(STRTDT)**</span></span>|<span data-ttu-id="67061-185">作业开始执行的日期（以 YYYYMMDD 格式表示）。</span><span class="sxs-lookup"><span data-stu-id="67061-185">The date (in YYYYMMDD format) that the job began executing.</span></span>|  
|<span data-ttu-id="67061-186">(WMI(property))\*\*\*\* \*\* \*\*\*\*</span><span class="sxs-lookup"><span data-stu-id="67061-186">**(WMI(** *property* **))**</span></span>|<span data-ttu-id="67061-187">对于为响应 WMI 警报而运行的作业，属性值由 property \*\* 指定。</span><span class="sxs-lookup"><span data-stu-id="67061-187">For jobs that run in response to WMI alerts, the value of the property specified by *property*.</span></span> <span data-ttu-id="67061-188">例如，`$(WMI(DatabaseName))` 为导致警报运行的 WMI 事件提供 **DatabaseName** 属性值。</span><span class="sxs-lookup"><span data-stu-id="67061-188">For example, `$(WMI(DatabaseName))` provides the value of the **DatabaseName** property for the WMI event that caused the alert to run.</span></span>|  
  
### <a name="sql-server-agent-escape-macros"></a><span data-ttu-id="67061-189">SQL Server 代理转义宏</span><span class="sxs-lookup"><span data-stu-id="67061-189">SQL Server Agent Escape Macros</span></span>  
  
|<span data-ttu-id="67061-190">转义宏</span><span class="sxs-lookup"><span data-stu-id="67061-190">Escape Macros</span></span>|<span data-ttu-id="67061-191">说明</span><span class="sxs-lookup"><span data-stu-id="67061-191">Description</span></span>|  
|-------------------|-----------------|  
|<span data-ttu-id="67061-192">**$(ESCAPE_SQUOTE(** *token_name* **))**</span><span class="sxs-lookup"><span data-stu-id="67061-192">**$(ESCAPE_SQUOTE(** *token_name* **))**</span></span>|<span data-ttu-id="67061-193">转义标记替换字符串中的单引号 (')。</span><span class="sxs-lookup"><span data-stu-id="67061-193">Escapes single quotation marks (') in the token replacement string.</span></span> <span data-ttu-id="67061-194">将一个单引号替换为两个单引号。</span><span class="sxs-lookup"><span data-stu-id="67061-194">Replaces one single quotation mark with two single quotation marks.</span></span>|  
|<span data-ttu-id="67061-195">**$(ESCAPE_DQUOTE(** *token_name* **))**</span><span class="sxs-lookup"><span data-stu-id="67061-195">**$(ESCAPE_DQUOTE(** *token_name* **))**</span></span>|<span data-ttu-id="67061-196">转义标记替换字符串中的双引号 (")。</span><span class="sxs-lookup"><span data-stu-id="67061-196">Escapes double quotation marks (") in the token replacement string.</span></span> <span data-ttu-id="67061-197">将一个双引号替换为两个双引号。</span><span class="sxs-lookup"><span data-stu-id="67061-197">Replaces one double quotation mark with two double quotation marks.</span></span>|  
|<span data-ttu-id="67061-198">**$(ESCAPE_RBRACKET(** *token_name* **))**</span><span class="sxs-lookup"><span data-stu-id="67061-198">**$(ESCAPE_RBRACKET(** *token_name* **))**</span></span>|<span data-ttu-id="67061-199">转义标记替换字符串中的右方括号 (])。</span><span class="sxs-lookup"><span data-stu-id="67061-199">Escapes right brackets (]) in the token replacement string.</span></span> <span data-ttu-id="67061-200">将一个右方括号替换为两个右方括号。</span><span class="sxs-lookup"><span data-stu-id="67061-200">Replaces one right bracket with two right brackets.</span></span>|  
|<span data-ttu-id="67061-201">**$(ESCAPE_NONE(** *token_name* **))**</span><span class="sxs-lookup"><span data-stu-id="67061-201">**$(ESCAPE_NONE(** *token_name* **))**</span></span>|<span data-ttu-id="67061-202">替换标记而不转义字符串中的任何字符。</span><span class="sxs-lookup"><span data-stu-id="67061-202">Replaces token without escaping any characters in the string.</span></span> <span data-ttu-id="67061-203">提供此宏是为了在仅需要来自受信任用户的标记替换字符串的环境中支持向后兼容。</span><span class="sxs-lookup"><span data-stu-id="67061-203">This macro is provided to support backward compatibility in environments where token replacement strings are only expected from trusted users.</span></span> <span data-ttu-id="67061-204">有关详细信息，请参阅本主题后面的“更新作业步骤以使用宏”。</span><span class="sxs-lookup"><span data-stu-id="67061-204">For more information, see "Updating Job Steps to Use Macros," later in this topic.</span></span>|  
  
## <a name="updating-job-steps-to-use-macros"></a><span data-ttu-id="67061-205">更新作业步骤以使用宏</span><span class="sxs-lookup"><span data-stu-id="67061-205">Updating Job Steps to Use Macros</span></span>  
 <span data-ttu-id="67061-206">从 [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] Service Pack 1 开始，包含不带转义宏的标记的作业步骤将失败，并返回错误消息，指示作业步骤包含一个或多个必须在作业运行之前使用宏进行更新的标记。</span><span class="sxs-lookup"><span data-stu-id="67061-206">Beginning with [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] Service Pack 1, job steps that contain tokens without escape macros will fail and return an error message indicating the job step contains one or more tokens that must be updated with a macro before the job can run.</span></span>  
  
 <span data-ttu-id="67061-207">[!INCLUDE[msCoName](../../includes/msconame-md.md)] 知识库文章 915845： [在 SQL Server 2005 Service Pack 1 中使用标记的 SQL Server 代理作业步骤将失败](https://support.microsoft.com/kb/915845)提供的脚本。可以使用此脚本通过 **ESCAPE_NONE** 宏更新所有使用标记的作业步骤。</span><span class="sxs-lookup"><span data-stu-id="67061-207">A script is provided with [!INCLUDE[msCoName](../../includes/msconame-md.md)] Knowledge Base article 915845: [SQL Server Agent Job Steps That Use Tokens Fail in SQL Server 2005 Service Pack 1](https://support.microsoft.com/kb/915845).You can use this script to update all of your job steps that use tokens with the **ESCAPE_NONE** macro.</span></span> <span data-ttu-id="67061-208">使用此脚本之后，我们建议你尽快查看使用标记的作业步骤，并将 **ESCAPE_NONE** 宏替换为适用于作业步骤上下文的转义宏。</span><span class="sxs-lookup"><span data-stu-id="67061-208">After using this script, we recommend that you review your job steps that use tokens as soon as possible, and replace the **ESCAPE_NONE** macro with an escape macro that is appropriate for the job step context.</span></span>  
  
 <span data-ttu-id="67061-209">下表说明 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 代理如何处理标记替换。</span><span class="sxs-lookup"><span data-stu-id="67061-209">The following table describes how token replacement is handled by [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent.</span></span> <span data-ttu-id="67061-210">若要启用或禁用警报标记替换，请在对象资源管理器中右键单击“SQL Server 代理”\*\*\*\*，选择“属性”\*\*\*\*，然后在“警报系统”\*\*\*\* 页上选中或清除“为警报的所有作业响应替换标记”\*\*\*\* 复选框。</span><span class="sxs-lookup"><span data-stu-id="67061-210">To turn alert token replacement on or off, right-click **SQL Server Agent** in Object Explorer, select **Properties**, and on the **Alert System** page, select or clear the **Replace tokens for all job responses to alerts** check box.</span></span>  
  
|<span data-ttu-id="67061-211">标记语法</span><span class="sxs-lookup"><span data-stu-id="67061-211">Token syntax</span></span>|<span data-ttu-id="67061-212">启用警报标记替换</span><span class="sxs-lookup"><span data-stu-id="67061-212">Alert token replacement on</span></span>|<span data-ttu-id="67061-213">禁用警报标记替换</span><span class="sxs-lookup"><span data-stu-id="67061-213">Alert token replacement off</span></span>|  
|------------------|--------------------------------|---------------------------------|  
|<span data-ttu-id="67061-214">使用转义宏</span><span class="sxs-lookup"><span data-stu-id="67061-214">ESCAPE macro used</span></span>|<span data-ttu-id="67061-215">成功替换作业中的所有标记。</span><span class="sxs-lookup"><span data-stu-id="67061-215">All tokens in jobs are successfully replaced.</span></span>|<span data-ttu-id="67061-216">不替换由警报激活的标记。</span><span class="sxs-lookup"><span data-stu-id="67061-216">Tokens activated by alerts are not replaced.</span></span> <span data-ttu-id="67061-217">这些标记是 **-DBN**、 **SVR**、 **a-ERR**、**严重性**、 **a-MSG**和\**WMI (*`property`\*) \*\*。</span><span class="sxs-lookup"><span data-stu-id="67061-217">These tokens are **A-DBN**, **A-SVR**, **A-ERR**, **A-SEV**, **A-MSG**, and **WMI(*`property`*)**.</span></span> <span data-ttu-id="67061-218">成功替换其他静态标记。</span><span class="sxs-lookup"><span data-stu-id="67061-218">Other static tokens are replaced successfully.</span></span>|  
|<span data-ttu-id="67061-219">不使用转义宏</span><span class="sxs-lookup"><span data-stu-id="67061-219">No ESCAPE macro used</span></span>|<span data-ttu-id="67061-220">任何包含标记的作业均失败。</span><span class="sxs-lookup"><span data-stu-id="67061-220">Any jobs containing tokens fail.</span></span>|<span data-ttu-id="67061-221">任何包含标记的作业均失败。</span><span class="sxs-lookup"><span data-stu-id="67061-221">Any jobs containing tokens fail.</span></span>|  
  
## <a name="token-syntax-update-examples"></a><span data-ttu-id="67061-222">标记语法更新示例</span><span class="sxs-lookup"><span data-stu-id="67061-222">Token Syntax Update Examples</span></span>  
  
### <a name="a-using-tokens-in-non-nested-strings"></a><span data-ttu-id="67061-223">A.</span><span class="sxs-lookup"><span data-stu-id="67061-223">A.</span></span> <span data-ttu-id="67061-224">在非嵌套字符串中使用标记</span><span class="sxs-lookup"><span data-stu-id="67061-224">Using tokens in non-nested strings</span></span>  
 <span data-ttu-id="67061-225">以下示例显示如何使用相应的转义宏更新简单的非嵌套脚本。</span><span class="sxs-lookup"><span data-stu-id="67061-225">The following example shows how to update a simple non-nested script with the appropriate escape macro.</span></span> <span data-ttu-id="67061-226">在运行更新脚本之前，以下作业步骤脚本使用作业步骤标记输出相应的数据库名称：</span><span class="sxs-lookup"><span data-stu-id="67061-226">Before running the update script, the following job step script uses a job step token to print the appropriate database name:</span></span>  
  
 `PRINT N'Current database name is $(A-DBN)' ;`  
  
 <span data-ttu-id="67061-227">在运行更新脚本之后，在 `ESCAPE_NONE` 标记之前插入 `A-DBN` 宏。</span><span class="sxs-lookup"><span data-stu-id="67061-227">After running the update script, an `ESCAPE_NONE` macro is inserted before the `A-DBN` token.</span></span> <span data-ttu-id="67061-228">由于使用单引号分隔输出字符串，因此必须通过插入 `ESCAPE_SQUOTE` 宏来更新作业步骤，如下所示：</span><span class="sxs-lookup"><span data-stu-id="67061-228">Because single quotation marks are used to delimit the print string, you must update the job step by inserting the `ESCAPE_SQUOTE` macro as follows:</span></span>  
  
 `PRINT N'Current database name is $(ESCAPE_SQUOTE(A-DBN))' ;`  
  
### <a name="b-using-tokens-in-nested-strings"></a><span data-ttu-id="67061-229">B.</span><span class="sxs-lookup"><span data-stu-id="67061-229">B.</span></span> <span data-ttu-id="67061-230">在嵌套字符串中使用标记</span><span class="sxs-lookup"><span data-stu-id="67061-230">Using tokens in nested strings</span></span>  
 <span data-ttu-id="67061-231">对于在嵌套字符串或语句中使用标记的作业步骤脚本，应将嵌套语句重写为多个语句，然后插入相应的转义宏。</span><span class="sxs-lookup"><span data-stu-id="67061-231">In job step scripts where tokens are used in nested strings or statements, the nested statements should be rewritten as multiple statements before inserting the appropriate escape macros.</span></span>  
  
 <span data-ttu-id="67061-232">例如，请看以下作业步骤，此步骤使用 `A-MSG` 标记并且尚未使用转义宏进行更新：</span><span class="sxs-lookup"><span data-stu-id="67061-232">For example, consider the following job step, which uses the `A-MSG` token and has not been updated with an escape macro:</span></span>  
  
 `PRINT N'Print ''$(A-MSG)''' ;`  
  
 <span data-ttu-id="67061-233">在运行更新脚本之后，针对此标记插入 `ESCAPE_NONE` 宏。</span><span class="sxs-lookup"><span data-stu-id="67061-233">After running the update script, an `ESCAPE_NONE` macro is inserted with the token.</span></span> <span data-ttu-id="67061-234">但在这种情况下，必须按如下方式在不使用嵌套的情况下重写脚本，并插入 `ESCAPE_SQUOTE` 宏以正确转义可能在标记替换字符串中传递的分隔符：</span><span class="sxs-lookup"><span data-stu-id="67061-234">However, in this case, you would have to rewrite the script without using nesting as follows and insert the `ESCAPE_SQUOTE` macro to properly escape delimiters that may be passed in the token replacement string:</span></span>  
  
 `DECLARE @msgString nvarchar(max)`  
  
 `SET @msgString = '$(ESCAPE_SQUOTE(A-MSG))'`  
  
 `SET @msgString = QUOTENAME(@msgString,'''')`  
  
 `PRINT N'Print ' + @msgString ;`  
  
 <span data-ttu-id="67061-235">另请注意，在此示例中 QUOTENAME 函数设置引号字符。</span><span class="sxs-lookup"><span data-stu-id="67061-235">Note also in this example that the QUOTENAME function sets the quote character.</span></span>  
  
### <a name="c-using-tokens-with-the-escape_none-macro"></a><span data-ttu-id="67061-236">C.</span><span class="sxs-lookup"><span data-stu-id="67061-236">C.</span></span> <span data-ttu-id="67061-237">将标记与 ESCAPE_NONE 宏配合使用</span><span class="sxs-lookup"><span data-stu-id="67061-237">Using tokens with the ESCAPE_NONE macro</span></span>  
 <span data-ttu-id="67061-238">以下示例是从 `job_id` 表中检索 `sysjobs` 并使用 `JOBID` 标记填充 `@JobID` 变量（在脚本的前面部分已声明为 binary 数据类型）的脚本的一部分。</span><span class="sxs-lookup"><span data-stu-id="67061-238">The following example is part of a script that retrieves the `job_id` from the `sysjobs` table and uses the `JOBID` token to populate the `@JobID` variable, which was declared earlier in the script as a binary data type.</span></span> <span data-ttu-id="67061-239">注意，由于 binary 数据类型不需要分隔符，因此将 `ESCAPE_NONE` 宏与 `JOBID` 标记配合使用。</span><span class="sxs-lookup"><span data-stu-id="67061-239">Note that because no delimiters are required for binary data types, the `ESCAPE_NONE` macro is used with the `JOBID` token.</span></span> <span data-ttu-id="67061-240">运行更新脚本之后，无需更新此作业步骤。</span><span class="sxs-lookup"><span data-stu-id="67061-240">You would not need to update this job step after running the update script.</span></span>  
  
 `SELECT * FROM msdb.dbo.sysjobs`  
  
 `WHERE @JobID = CONVERT(uniqueidentifier, $(ESCAPE_NONE(JOBID))) ;`  
  
## <a name="see-also"></a><span data-ttu-id="67061-241">另请参阅</span><span class="sxs-lookup"><span data-stu-id="67061-241">See Also</span></span>  
 <span data-ttu-id="67061-242">[执行作业](implement-jobs.md) </span><span class="sxs-lookup"><span data-stu-id="67061-242">[Implement Jobs](implement-jobs.md) </span></span>  
 [<span data-ttu-id="67061-243">管理作业步骤</span><span class="sxs-lookup"><span data-stu-id="67061-243">Manage Job Steps</span></span>](manage-job-steps.md)  
  
  

---
title: 角色切换后登录名和作业的管理 (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- role switching [SQL Server]
ms.assetid: fc2fc949-746f-40c7-b5d4-3fd51ccfbd7b
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 9c099bf9ea271b5ea93fdebfe8f35c98864bca09
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87586279"
---
# <a name="management-of-logins-and-jobs-after-role-switching-sql-server"></a><span data-ttu-id="2206d-102">角色切换后登录名和作业的管理 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="2206d-102">Management of Logins and Jobs After Role Switching (SQL Server)</span></span>
  <span data-ttu-id="2206d-103">在为 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 数据库部署高可用性或灾难恢复解决方案时，重新生成为 master 或 msdb 数据库中的数据库存储的相关信息十分重要\*\*\*\*\*\*\*\*。</span><span class="sxs-lookup"><span data-stu-id="2206d-103">When deploying a high-availability or disaster-recovery solution for a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] database, it is important to reproduce relevant information that is stored for the database in the **master** or **msdb** databases.</span></span> <span data-ttu-id="2206d-104">通常，相关信息包括主/主体数据库的作业以及连接到数据库所需的用户或进程的登录名。</span><span class="sxs-lookup"><span data-stu-id="2206d-104">Typically, the relevant information includes the jobs of the primary/principal database and the logins of users or processes that need to connect to the database.</span></span> <span data-ttu-id="2206d-105">您应该在承载辅助/镜像数据库的任何 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 实例上复制此信息。</span><span class="sxs-lookup"><span data-stu-id="2206d-105">You should duplicate this information on any instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] that hosts a secondary/mirror database.</span></span> <span data-ttu-id="2206d-106">如果可能，角色切换后最好在新的主/主体数据库中以编程方式重新生成此信息。</span><span class="sxs-lookup"><span data-stu-id="2206d-106">If possible after roles are switched, it is best to programmatically reproduce the information on the new primary/principal database.</span></span>  
  
## <a name="logins"></a><span data-ttu-id="2206d-107">登录名</span><span class="sxs-lookup"><span data-stu-id="2206d-107">Logins</span></span>  
 <span data-ttu-id="2206d-108">在承载数据库副本的每个服务器实例上，您都应该重新生成有权访问主体数据库的登录名。</span><span class="sxs-lookup"><span data-stu-id="2206d-108">On every server instances that hosts a copy of the database, you should reproduce the logins that have permission to access the principal database.</span></span> <span data-ttu-id="2206d-109">当主/主体角色切换时，只有其登录名在新的主/主体服务器实例上存在的用户才可以访问新的主/主体数据库。</span><span class="sxs-lookup"><span data-stu-id="2206d-109">When the primary/principal role switches, only users whose logins exist on the new primary/principal server instance can access the new primary/principal database.</span></span> <span data-ttu-id="2206d-110">其登录名未在新的主/主体服务器实例上定义的用户是孤立用户，并且无法访问该数据库。</span><span class="sxs-lookup"><span data-stu-id="2206d-110">Users whose logins are not defined on the new primary/principal server instance are orphaned and cannot access the database.</span></span>  
  
 <span data-ttu-id="2206d-111">如果某个用户是孤立用户，请在新的主/主体服务器实例上创建该登录名，并且运行 [sp_change_users_login](/sql/relational-databases/system-stored-procedures/sp-change-users-login-transact-sql)。</span><span class="sxs-lookup"><span data-stu-id="2206d-111">If a user is orphaned, create the login on the new primary/principal server instance and run [sp_change_users_login](/sql/relational-databases/system-stored-procedures/sp-change-users-login-transact-sql).</span></span> <span data-ttu-id="2206d-112">有关详细信息，请参阅 [孤立用户故障排除 (SQL Server)](troubleshoot-orphaned-users-sql-server.md)。</span><span class="sxs-lookup"><span data-stu-id="2206d-112">For more information, see [Troubleshoot Orphaned Users &#40;SQL Server&#41;](troubleshoot-orphaned-users-sql-server.md).</span></span>  
  
###  <a name="logins-of-applications-that-use-sql-server-authentication-or-a-local-windows-login"></a><a name="SSauthentication"></a> <span data-ttu-id="2206d-113">使用 SQL Server 身份验证或本地 Windows 登录名的应用程序的登录名</span><span class="sxs-lookup"><span data-stu-id="2206d-113">Logins Of Applications That Use SQL Server Authentication or a Local Windows Login</span></span>  
 <span data-ttu-id="2206d-114">如果某一应用程序使用 SQL Server 身份验证或本地 Windows 登录名，则不匹配的 SID 可能会阻止该应用程序的登录名在 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的远程实例上解析。</span><span class="sxs-lookup"><span data-stu-id="2206d-114">If an application uses SQL Server Authentication or a local Windows login, mismatched SIDs can prevent the application's login from resolving on a remote instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2206d-115">不匹配的 SID 将导致该登录名成为远程服务器实例上的孤立用户。</span><span class="sxs-lookup"><span data-stu-id="2206d-115">The mismatched SIDs cause the login to become an orphaned user on the remote server instance.</span></span> <span data-ttu-id="2206d-116">当应用程序连接到发生故障转移后的镜像数据库或日志传送数据库，或是连接到从备份初始化的复制订阅服务器数据库时，就可能会发生此问题。</span><span class="sxs-lookup"><span data-stu-id="2206d-116">This issue can occur when an application connects to a mirrored or log shipping database after a failover or to a replication subscriber database that was initialized from a backup.</span></span>  
  
 <span data-ttu-id="2206d-117">为了避免此问题，我们建议您在设置此类应用程序时采取预防措施，以便使用由 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的远程实例承载的数据库。</span><span class="sxs-lookup"><span data-stu-id="2206d-117">To prevent this issue, we recommend that you take preventative measures when you set up such an application to use a database that is hosted by a remote instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2206d-118">预防措施包括将登录名和密码从 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的本地实例传输到 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]的远程实例。</span><span class="sxs-lookup"><span data-stu-id="2206d-118">Prevention involves transferring the logins and the passwords from the local instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] to the remote instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2206d-119">有关如何避免此问题的详细信息，请参阅知识库文章 918992 —[如何在 SQL Server 实例间传输登录名和密码](https://support.microsoft.com/kb/918992/)。</span><span class="sxs-lookup"><span data-stu-id="2206d-119">For more information about how to prevent this issue, see KB article 918992 -[How to transfer logins and passwords between instances of SQL Server](https://support.microsoft.com/kb/918992/)).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2206d-120">这个问题会影响不同计算机上的 Windows 本地帐户。</span><span class="sxs-lookup"><span data-stu-id="2206d-120">This problem affects Windows local accounts on different computers.</span></span> <span data-ttu-id="2206d-121">但是，这个问题不会在域帐户上发生，因为 SID 在每台计算机上都是相同的。</span><span class="sxs-lookup"><span data-stu-id="2206d-121">However, this problem does not occur for domain accounts because the SID is the same on each of the computers.</span></span>  
  
 <span data-ttu-id="2206d-122">有关详细信息，请参阅 [与数据库镜像和日志传送有关的孤立用户](https://blogs.msdn.com/b/sqlserverfaq/archive/2009/04/13/orphaned-users-with-database-mirroring-and-log-shipping.aspx) （数据库引擎博客）。</span><span class="sxs-lookup"><span data-stu-id="2206d-122">For more information, see [Orphaned Users with Database Mirroring and Log Shipping](https://blogs.msdn.com/b/sqlserverfaq/archive/2009/04/13/orphaned-users-with-database-mirroring-and-log-shipping.aspx) (a Database Engine blog).</span></span>  
  
## <a name="jobs"></a><span data-ttu-id="2206d-123">作业</span><span class="sxs-lookup"><span data-stu-id="2206d-123">Jobs</span></span>  
 <span data-ttu-id="2206d-124">作业（如备份作业）需要特殊考虑。</span><span class="sxs-lookup"><span data-stu-id="2206d-124">Jobs, such as backup jobs, require special consideration.</span></span> <span data-ttu-id="2206d-125">通常，在角色切换后，数据库所有者或系统管理员必须为新的主/主体数据库重新创建作业。</span><span class="sxs-lookup"><span data-stu-id="2206d-125">Typically, after a role switch, the database owner or system administrator must re-create the jobs for the new primary/principal database.</span></span>  
  
 <span data-ttu-id="2206d-126">如果以前的主/主体服务器实例可用，则应该在该 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]实例上删除原始作业。</span><span class="sxs-lookup"><span data-stu-id="2206d-126">When the former primary/principal server instance is available, you should delete the original jobs on that instanceof [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2206d-127">请注意，当前镜像数据库上的作业失败，因为它处于 RESTORING 状态，以致不可用。</span><span class="sxs-lookup"><span data-stu-id="2206d-127">Note that jobs on the current mirror database fail because it is in the RESTORING state, making it unavailable.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="2206d-128">[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] 的不同实例的配置可能不同，如具有不同的驱动器号等。</span><span class="sxs-lookup"><span data-stu-id="2206d-128">Different instances of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] might be configured differently, with different drive letters or such.</span></span> <span data-ttu-id="2206d-129">每个伙伴的作业必须允许任何这类不同的配置。</span><span class="sxs-lookup"><span data-stu-id="2206d-129">The jobs for each partner must allow for any such differences.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2206d-130">另请参阅</span><span class="sxs-lookup"><span data-stu-id="2206d-130">See Also</span></span>  
 <span data-ttu-id="2206d-131">[当数据库在其他服务器实例上可用时管理元数据 (SQL Server)](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md) </span><span class="sxs-lookup"><span data-stu-id="2206d-131">[Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md) </span></span>  
 [<span data-ttu-id="2206d-132">孤立用户故障排除 (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="2206d-132">Troubleshoot Orphaned Users &#40;SQL Server&#41;</span></span>](troubleshoot-orphaned-users-sql-server.md)  
  
  

---
title: 为 Kerberos 约束委派配置 Analysis Services |Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: analysis-services
ms.topic: conceptual
ms.assetid: 6d751477-6bf1-48b4-8833-5a631bbe7650
author: minewiskan
ms.author: owend
ms.openlocfilehash: 03b852acb4868cd384ef34948c6aff70541638a0
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/04/2020
ms.locfileid: "87689186"
---
# <a name="configure-analysis-services-for-kerberos-constrained-delegation"></a><span data-ttu-id="f0efd-102">Kerberos 约束委派配置 Analysis Services</span><span class="sxs-lookup"><span data-stu-id="f0efd-102">Configure Analysis Services for Kerberos constrained delegation</span></span>
  <span data-ttu-id="f0efd-103">在配置 Analysis Services 以使用 Kerberos 身份验证时，您很可能希望实现以下两个结果中的一个或全部两个：在查询数据时让 Analysis Services 模拟某个用户标识；或者让 Analysis Services 将某个用户标识委托给下级服务。</span><span class="sxs-lookup"><span data-stu-id="f0efd-103">When configuring Analysis Services for Kerberos authentication, you are most likely interested in achieving one or both of the following outcomes: having Analysis Services impersonate a user identity when querying data; or having Analysis Services delegate a user identity to a down-level service.</span></span> <span data-ttu-id="f0efd-104">每个方案都具有稍有不同的配置要求。</span><span class="sxs-lookup"><span data-stu-id="f0efd-104">Each scenario calls for slightly different configuration requirements.</span></span> <span data-ttu-id="f0efd-105">这两个方案都要求进行验证，以便确保正确完成配置。</span><span class="sxs-lookup"><span data-stu-id="f0efd-105">Both scenarios require verification to ensure configuration was done properly.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="f0efd-106">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** 是一款诊断工具，可帮助解决与 Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]相关的连接问题。</span><span class="sxs-lookup"><span data-stu-id="f0efd-106">**[!INCLUDE[msCoName](../../includes/msconame-md.md)] Kerberos Configuration Manager for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]** is a diagnostic tool that helps troubleshoot Kerberos related connectivity issues with [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="f0efd-107">有关详细信息，请参阅 [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-107">For more information, see [Microsoft Kerberos Configuration Manager for SQL Server](https://www.microsoft.com/download/details.aspx?id=39046).</span></span>  
  
 <span data-ttu-id="f0efd-108">本主题包含以下各节：</span><span class="sxs-lookup"><span data-stu-id="f0efd-108">This topic contains the following sections:</span></span>  
  
-   [<span data-ttu-id="f0efd-109">允许 Analysis Services 模拟某个用户标识</span><span class="sxs-lookup"><span data-stu-id="f0efd-109">Allow Analysis Services to impersonate a user identity</span></span>](#bkmk_impersonate)  
  
-   [<span data-ttu-id="f0efd-110">配置 Analysis Services 以实现可信委托</span><span class="sxs-lookup"><span data-stu-id="f0efd-110">Configure Analysis Services for trusted delegation</span></span>](#bkmk_delegate)  
  
-   [<span data-ttu-id="f0efd-111">测试模拟的标识或委托的标识</span><span class="sxs-lookup"><span data-stu-id="f0efd-111">Test for impersonated or delegated identity</span></span>](#bkmk_test)  
  
> [!NOTE]  
>  <span data-ttu-id="f0efd-112">如果与 Analysis Services 的连接是单跃点，或者您的解决方案使用 SharePoint Secure Store Service 或 Reporting Services 提供的存储的凭据，则委托不是必需的。</span><span class="sxs-lookup"><span data-stu-id="f0efd-112">Delegation is not required if the connection to Analysis Services is a single hop, or your solution uses stored credentials provided by SharePoint Secure Store Service or Reporting Services.</span></span> <span data-ttu-id="f0efd-113">如果所有连接都是从 Excel 到 Analysis Services 数据库的直接连接或是以存储的凭据为基础，则可以直接使用 Kerberos（或 NTLM）而无需配置约束委托。</span><span class="sxs-lookup"><span data-stu-id="f0efd-113">If all connections are direct connections from Excel to an Analysis Services database, or based on stored credentials, you can use Kerberos (or NTLM) without having to configure constrained delegation.</span></span>  
>   
>  <span data-ttu-id="f0efd-114">如果用户标识必须流经多个计算机连接 (称为 "双跃点" ) ，则需要 Kerberos 约束委派。</span><span class="sxs-lookup"><span data-stu-id="f0efd-114">Kerberos constrained delegation is required if the user identity has to flow over multiple computer connections (known as "double-hop").</span></span> <span data-ttu-id="f0efd-115">在 Analysis Services 数据访问针对用户标识是有条件的，并且连接请求来自某一委托服务，则使用下一节中的核对清单确保 Analysis Services 能够模拟原始调用方。</span><span class="sxs-lookup"><span data-stu-id="f0efd-115">When Analysis Services data access is contingent upon user identity, and the connection request is from a delegating service, use the checklist in the next section to ensure that Analysis Services is able to impersonate the original caller.</span></span> <span data-ttu-id="f0efd-116">有关 Analysis Services 身份验证流的详细信息，请参阅 [Microsoft BI 身份验证和身份委托](https://go.microsoft.com/fwlink/?LinkID=286576)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-116">For more information about Analysis Services authentication flows, see [Microsoft BI Authentication and Identity Delegation](https://go.microsoft.com/fwlink/?LinkID=286576).</span></span>  
>   
>  <span data-ttu-id="f0efd-117">作为一项最佳安全配置，Microsoft 始终建议约束委派而不是非约束委派。</span><span class="sxs-lookup"><span data-stu-id="f0efd-117">As a security best practice, Microsoft always recommends constrained delegation over unconstrained delegation.</span></span> <span data-ttu-id="f0efd-118">由于非约束委托允许服务标识在 *任何* 下游计算机、服务或应用程序上模拟另一个用户（正好与那些经由约束委托明确定义的服务相反），因此是一个主要的安全风险。</span><span class="sxs-lookup"><span data-stu-id="f0efd-118">Unconstrained delegation is a major security risk because it allows the service identity to impersonate another user on *any* downstream computer, service, or application (as opposed to just those services explicitly defined via constrained delegation).</span></span>  
  
##  <a name="allow-analysis-services-to-impersonate-a-user-identity"></a><a name="bkmk_impersonate"></a><span data-ttu-id="f0efd-119">允许 Analysis Services 模拟用户标识</span><span class="sxs-lookup"><span data-stu-id="f0efd-119">Allow Analysis Services to impersonate a user identity</span></span>  
 <span data-ttu-id="f0efd-120">为了允许上级服务（例如 Reporting Services、IIS 或 SharePoint）模拟 Analysis Services 上的用户标识，您必须针对这些服务配置 Kerberos 约束委派。</span><span class="sxs-lookup"><span data-stu-id="f0efd-120">To allow up-level services such as Reporting Services, IIS, or SharePoint to impersonate a user identity on Analysis Services, you must configure Kerberos constrained delegation for those services.</span></span> <span data-ttu-id="f0efd-121">在此方案中，Analysis Services 使用委托服务提供的标识模拟当前用户，并且基于该用户标识的角色成员身份返回结果。</span><span class="sxs-lookup"><span data-stu-id="f0efd-121">In this scenario, Analysis Services impersonates the current user using the identity provided by the delegating service, returning results based on role membership of that user identity.</span></span>  
  
|<span data-ttu-id="f0efd-122">任务</span><span class="sxs-lookup"><span data-stu-id="f0efd-122">Task</span></span>|<span data-ttu-id="f0efd-123">说明</span><span class="sxs-lookup"><span data-stu-id="f0efd-123">Description</span></span>|  
|----------|-----------------|  
|<span data-ttu-id="f0efd-124">步骤 1：确认帐户是否适合委托</span><span class="sxs-lookup"><span data-stu-id="f0efd-124">Step 1: Verify that accounts are suitable for delegation</span></span>|<span data-ttu-id="f0efd-125">请确保用于运行服务的帐户在 Active Directory 中具有正确的属性。</span><span class="sxs-lookup"><span data-stu-id="f0efd-125">Ensure that the accounts used to run the services have the correct properties in Active Directory.</span></span> <span data-ttu-id="f0efd-126">Active Directory 中的服务帐户不得标记为敏感帐户，也不得明确从委托方案中排除。</span><span class="sxs-lookup"><span data-stu-id="f0efd-126">Service accounts in Active Directory must not be marked as sensitive accounts, or specifically excluded from delegation scenarios.</span></span> <span data-ttu-id="f0efd-127">有关详细信息，请参阅 [理解用户帐户](https://go.microsoft.com/fwlink/?LinkId=235818)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-127">For more information, see [Understanding User Accounts](https://go.microsoft.com/fwlink/?LinkId=235818).</span></span><br /><br /> <span data-ttu-id="f0efd-128">\*\* \* \* 重要 \* 说明 \* \*\* ：通常，所有帐户和服务器都必须属于同一个林中的同一个 Active Directory 域或受信任的域。</span><span class="sxs-lookup"><span data-stu-id="f0efd-128">**\*\* Important \*\*** Generally, all accounts and servers must belong to the same Active Directory domain or to trusted domains in the same forest.</span></span> <span data-ttu-id="f0efd-129">但是，因为 Windows Server 2012 支持跨域边界的委托，如果域功能级别是 Windows Server 2012，您可以配置跨域边界的 Kerberos 约束委派。</span><span class="sxs-lookup"><span data-stu-id="f0efd-129">However, because Windows Server 2012 supports delegation across domain boundaries, you can configure Kerberos constrained delegation across a domain boundary if the domain functional level is Windows Server 2012.</span></span> <span data-ttu-id="f0efd-130">另一种替代方法是，配置 Analysis Services 进行 HTTP 访问并对客户端连接使用 IIS 身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="f0efd-130">Another alternative is to configure Analysis Services for HTTP access and use IIS authentication methods on the client connection.</span></span> <span data-ttu-id="f0efd-131">有关详细信息，请参阅 [在 Internet Information Services (IIS) 8.0 上配置对 Analysis Services 的 HTTP 访问](configure-http-access-to-analysis-services-on-iis-8-0.md)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-131">For more information, see [Configure HTTP Access to Analysis Services on Internet Information Services &#40;IIS&#41; 8.0](configure-http-access-to-analysis-services-on-iis-8-0.md).</span></span>|  
|<span data-ttu-id="f0efd-132">步骤 2：注册 SPN</span><span class="sxs-lookup"><span data-stu-id="f0efd-132">Step 2: Register the SPN</span></span>|<span data-ttu-id="f0efd-133">在设置约束委派前，您必须为 Analysis Services 实例注册服务主体名称 (SPN)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-133">Before setting up constrained delegation, you must register a Service Principle Name (SPN) for the Analysis Services instance.</span></span> <span data-ttu-id="f0efd-134">在为中间层服务配置 Kerberos 约束委派时，将需要 Analysis Services SPN。</span><span class="sxs-lookup"><span data-stu-id="f0efd-134">You will need the Analysis Services SPN when configuring Kerberos constrained delegation for middle tier services.</span></span> <span data-ttu-id="f0efd-135">有关说明，请参阅 [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md) 。</span><span class="sxs-lookup"><span data-stu-id="f0efd-135">See [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md) for instructions.</span></span><br /><br /> <span data-ttu-id="f0efd-136">服务主体名称 (SPN) 指定域中为 Kerberos 身份验证配置的服务的唯一标识。</span><span class="sxs-lookup"><span data-stu-id="f0efd-136">A Service Principle Name (SPN) specifies the unique identity of a service in a domain configured for Kerberos authentication.</span></span> <span data-ttu-id="f0efd-137">使用集成安全性的客户端连接通常请求 SPN 作为 SSPI 身份验证的一部分。</span><span class="sxs-lookup"><span data-stu-id="f0efd-137">Client connections using integrated security often request an SPN as part of SSPI authentication.</span></span> <span data-ttu-id="f0efd-138">该请求被转发到 Active Directory 域控制器 (DC)，并且由 KDC 授予一个票证（如果客户端提供的 SPN 在 Active Directory 中有匹配的 SPN 注册）。</span><span class="sxs-lookup"><span data-stu-id="f0efd-138">The request is forwarded to an Active Directory Domain Controller (DC), with the KDC granting a ticket if the SPN presented by the client has a matching SPN registration in Active Directory.</span></span>|  
|<span data-ttu-id="f0efd-139">步骤 3：配置约束委派</span><span class="sxs-lookup"><span data-stu-id="f0efd-139">Step 3: Configure constrained delegation</span></span>|<span data-ttu-id="f0efd-140">在验证要使用的帐户和为这些帐户注册 SPN 后，下一步是为约束委派配置上级服务（例如 IIS、Reporting Services 或 SharePoint Web 服务），并且将 Analysis Services SPN 作为允许委托的特定服务列出。</span><span class="sxs-lookup"><span data-stu-id="f0efd-140">After validating the accounts you want to use and registering SPNs for those accounts, your next step is to configure up-level services, such as IIS, Reporting Services, or SharePoint web services for constrained delegation, specifying the Analysis Services SPN as the specific service for which delegation is allowed.</span></span><br /><br /> <span data-ttu-id="f0efd-141">在 SharePoint 中运行的服务（例如 SharePoint 模式下的 Excel Services 或 Reporting Services）常常承载使用 Analysis Services 多维或表格数据的工作簿和报表。</span><span class="sxs-lookup"><span data-stu-id="f0efd-141">Services that run in SharePoint, such as Excel Services or Reporting Services in SharePoint mode, often host workbooks and reports that consume Analysis Services multidimensional or tabular data.</span></span> <span data-ttu-id="f0efd-142">为这些服务配置约束委派是一个常见的配置任务，并且是支持从 Excel Services 执行数据刷新所必需的。</span><span class="sxs-lookup"><span data-stu-id="f0efd-142">Configuring constrained delegation for these services is a common configuration task, and necessary for supporting data refresh from Excel Services.</span></span> <span data-ttu-id="f0efd-143">以下链接提供 SharePoint 服务以及其他服务的说明，这些服务可能存在针对 Analysis Services 数据的下游数据连接请求：</span><span class="sxs-lookup"><span data-stu-id="f0efd-143">The following links provide instructions for SharePoint services, as well as other services likely to present a downstream data connection request for Analysis Services data:</span></span><br /><br /> <span data-ttu-id="f0efd-144">[Excel Services 的标识委托 (SharePoint Server 2010)](https://go.microsoft.com/fwlink/?LinkId=299826) 或 [如何配置 SharePoint Server 2010 中的 Excel Services 的 Kerberos 身份验证](https://support.microsoft.com/kb/2466519)</span><span class="sxs-lookup"><span data-stu-id="f0efd-144">[Identity delegation for Excel Services (SharePoint Server 2010)](https://go.microsoft.com/fwlink/?LinkId=299826) or [How to configure Excel Services in SharePoint Server 2010 for Kerberos authentication](https://support.microsoft.com/kb/2466519)</span></span><br /><br /> [<span data-ttu-id="f0efd-145">针对 PerformancePoint Services 的标识委托 (SharePoint Server 2010)</span><span class="sxs-lookup"><span data-stu-id="f0efd-145">Identity delegation for PerformancePoint Services (SharePoint Server 2010)</span></span>](https://go.microsoft.com/fwlink/?LinkId=299827)<br /><br /> [<span data-ttu-id="f0efd-146">针对 SQL Server Reporting Services 的标识委托 (SharePoint Server 2010)</span><span class="sxs-lookup"><span data-stu-id="f0efd-146">Identity delegation for SQL Server Reporting Services (SharePoint Server 2010)</span></span>](https://go.microsoft.com/fwlink/?LinkId=299828)<br /><br /> <span data-ttu-id="f0efd-147">对于 IIS 7.0，请参阅 [配置 Windows 身份验证 (IIS 7.0)](https://technet.microsoft.com/library/cc754628\(v=ws.10\).aspx) 或 [如何配置 SQL Server 2008 Analysis Services 和 SQL 服务器 2005 Analysis Services 使用 Kerberos 身份验证](https://support.microsoft.com/kb/917409)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-147">For IIS 7.0 see [Configure Windows Authentication (IIS 7.0)](https://technet.microsoft.com/library/cc754628\(v=ws.10\).aspx) or [How to configure SQL Server 2008 Analysis Services and SQL Server 2005 Analysis Services to use Kerberos authentication](https://support.microsoft.com/kb/917409).</span></span>|  
|<span data-ttu-id="f0efd-148">步骤 4：测试连接</span><span class="sxs-lookup"><span data-stu-id="f0efd-148">Step 4: Test connections</span></span>|<span data-ttu-id="f0efd-149">测试时，请基于不同标识从远程计算机连接，并使用与业务用户相同的应用程序来查询 Analysis Services。</span><span class="sxs-lookup"><span data-stu-id="f0efd-149">When testing, connect from remote computers, under different identities, and query Analysis Services using the same applications as business users.</span></span> <span data-ttu-id="f0efd-150">您可以使用 SQL Server Profiler 来监视连接。</span><span class="sxs-lookup"><span data-stu-id="f0efd-150">You can use SQL Server Profiler to monitor the connection.</span></span> <span data-ttu-id="f0efd-151">您应该会看到发出请求的用户标识。</span><span class="sxs-lookup"><span data-stu-id="f0efd-151">You should see the user identity on the request.</span></span> <span data-ttu-id="f0efd-152">有关详细信息，请参阅本节中的 [测试模拟的标识或委托的标识](#bkmk_test) 。</span><span class="sxs-lookup"><span data-stu-id="f0efd-152">For more information, see [Test for impersonated or delegated identity](#bkmk_test) in this section.</span></span>|  
  
##  <a name="configure-analysis-services-for-trusted-delegation"></a><a name="bkmk_delegate"></a><span data-ttu-id="f0efd-153">为受信任的委派配置 Analysis Services</span><span class="sxs-lookup"><span data-stu-id="f0efd-153">Configure Analysis Services for trusted delegation</span></span>  
 <span data-ttu-id="f0efd-154">通过将 Analysis Services 配置为使用 Kerberos 约束委派，可允许服务模拟下级服务（例如关系数据库引擎）上的客户端标识，然后就可以像直接连接客户端一样查询数据。</span><span class="sxs-lookup"><span data-stu-id="f0efd-154">Configuring Analysis Services for Kerberos constrained delegation allows the service to impersonate a client identity on a down-level service, such as the relational database engine, so that data can be queried as if the client was connected directly.</span></span>  
  
 <span data-ttu-id="f0efd-155">针对 Analysis Services 的委托方案被限制为针对 `DirectQuery` 模式配置的表格模型。</span><span class="sxs-lookup"><span data-stu-id="f0efd-155">Delegation scenarios for Analysis Services are limited to tabular models configured for `DirectQuery` mode.</span></span> <span data-ttu-id="f0efd-156">这是 Analysis Services 可以将委托的凭据传递到其他服务的唯一情形。</span><span class="sxs-lookup"><span data-stu-id="f0efd-156">This is the only scenario in which Analysis Services can pass delegated credentials to another service.</span></span> <span data-ttu-id="f0efd-157">在所有其他情形中（如在前一节中提到的 SharePoint 情形），Analysis Services 位于委托链的接受端。</span><span class="sxs-lookup"><span data-stu-id="f0efd-157">In all other scenarios, such as SharePoint scenarios mentioned in the previous section, Analysis Services is on the receiving end of the delegation chain.</span></span> <span data-ttu-id="f0efd-158">有关 DirectQuery 的详细信息，请参阅[DirectQuery 模式（SSAS 表格）](../tabular-models/directquery-mode-ssas-tabular.md)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-158">For more information about DirectQuery, see [DirectQuery Mode &#40;SSAS Tabular&#41;](../tabular-models/directquery-mode-ssas-tabular.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="f0efd-159">一个常见的误解是 ROLAP 存储、处理操作或对远程分区的访问会以某种方式引入对约束委托的要求。</span><span class="sxs-lookup"><span data-stu-id="f0efd-159">A common misconception is that ROLAP storage, processing operations, or access to remote partitions somehow introduce requirements for constrained delegation.</span></span> <span data-ttu-id="f0efd-160">事实并非如此。</span><span class="sxs-lookup"><span data-stu-id="f0efd-160">This is not the case.</span></span> <span data-ttu-id="f0efd-161">所有这些操作均由服务帐户（也称为处理帐户）代表其自身来直接执行。</span><span class="sxs-lookup"><span data-stu-id="f0efd-161">All of these operations are executed directly by the service account (also referred to as the processing account), on its own behalf.</span></span> <span data-ttu-id="f0efd-162">在 Analysis Services 中，如果将这些操作的权限直接授予该服务帐户（例如，授予关系数据库的 db_datareader 权限以便服务可以处理数据），则这些操作无需委托。</span><span class="sxs-lookup"><span data-stu-id="f0efd-162">Delegation is not required for these operations in Analysis Services, given that permissions for such operations are granted directly to the service account (for example, granting db_datareader permissions on the relational database so that the service can process data).</span></span> <span data-ttu-id="f0efd-163">有关服务器操作和权限的详细信息，请参阅[配置服务帐户 (Analysis Services)](configure-service-accounts-analysis-services.md)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-163">For more information about server operations and permissions, see [Configure Service Accounts &#40;Analysis Services&#41;](configure-service-accounts-analysis-services.md).</span></span>  
  
 <span data-ttu-id="f0efd-164">本节说明如何针对信任的委托设置 Analysis Services。</span><span class="sxs-lookup"><span data-stu-id="f0efd-164">This section explains how to set up Analysis Services for trusted delegation.</span></span> <span data-ttu-id="f0efd-165">在您完成此任务后，Analysis Services 将能够将委托的凭据传递给 SQL Server，以支持在表格解决方案中使用的 DirectQuery 模式。</span><span class="sxs-lookup"><span data-stu-id="f0efd-165">After you complete this task, Analysis Services will be able to pass delegated credentials to SQL Server, in support of DirectQuery mode used in Tabular solutions.</span></span>  
  
 <span data-ttu-id="f0efd-166">开始之前：</span><span class="sxs-lookup"><span data-stu-id="f0efd-166">Before you start:</span></span>  
  
-   <span data-ttu-id="f0efd-167">确认启动了 Analysis Services。</span><span class="sxs-lookup"><span data-stu-id="f0efd-167">Verify that Analysis Services is started.</span></span>  
  
-   <span data-ttu-id="f0efd-168">确认为 Analysis Services 注册的 SPN 有效。</span><span class="sxs-lookup"><span data-stu-id="f0efd-168">Verify the SPN registered for Analysis Services is valid.</span></span> <span data-ttu-id="f0efd-169">有关说明，请参阅 [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-169">For instructions, see [SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md)</span></span>  
  
 <span data-ttu-id="f0efd-170">在两个先决条件均得到满足后，继续执行以下步骤。</span><span class="sxs-lookup"><span data-stu-id="f0efd-170">When both prerequisites are satisfied, continue with the following steps.</span></span> <span data-ttu-id="f0efd-171">请注意，若要设置约束委派，您必须是域管理员。</span><span class="sxs-lookup"><span data-stu-id="f0efd-171">Note that you must be a domain administrator to set up constrained delegation.</span></span>  
  
1.  <span data-ttu-id="f0efd-172">在“Active Directory 用户和计算机”中，找到 Analysis Services 按其运行的服务帐户。</span><span class="sxs-lookup"><span data-stu-id="f0efd-172">In Active Directory Users and Computers, find the service account under which Analysis Services runs.</span></span> <span data-ttu-id="f0efd-173">右键单击该服务帐户，然后选择 **“属性”**。</span><span class="sxs-lookup"><span data-stu-id="f0efd-173">Right-click the service account and choose **Properties**.</span></span>  
  
     <span data-ttu-id="f0efd-174">出于说明目的，以下屏幕快照使用 OlapSvc 和 SQLSvc 分别表示 Analysis Services 和 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="f0efd-174">For illustrative purposes, the following screenshots use OlapSvc and SQLSvc to represent Analysis Services and SQL Server, respectively.</span></span>  
  
     <span data-ttu-id="f0efd-175">OlapSvc 是为针对 SQLSvc 的约束委派将配置的帐户。</span><span class="sxs-lookup"><span data-stu-id="f0efd-175">OlapSvc is the account that will be configured for constrained delegation to SQLSvc.</span></span> <span data-ttu-id="f0efd-176">在您完成此任务后，OlapSvc 将有权将服务票证上的委托的凭据传递给 SQLSvc，并且在请求数据时模拟原始调用方。</span><span class="sxs-lookup"><span data-stu-id="f0efd-176">When you complete this task, OlapSvc will have permission to pass delegated credentials on a service ticket to SQLSvc, impersonating the original caller when requesting data.</span></span>  
  
2.  <span data-ttu-id="f0efd-177">在“委托”选项卡上，选择 **“仅信任此用户对指定服务的委托”**，后跟 **“仅使用 Kerberos”**。</span><span class="sxs-lookup"><span data-stu-id="f0efd-177">On the Delegation tab, select **Trust this user for delegation to specified services only**, followed by **Use Kerberos only**.</span></span> <span data-ttu-id="f0efd-178">单击“添加” \*\*\*\* 以指定允许 Analysis Services 委托凭据的服务。</span><span class="sxs-lookup"><span data-stu-id="f0efd-178">Click **Add** to specify which service Analysis Services is permitted to delegate credentials.</span></span>  
  
     <span data-ttu-id="f0efd-179">只有在将用户帐户 (OlapSvc) 分配给某一服务 (Analysis Services) 并且为该服务注册了 SPN 的情况下，“委托”选项卡才会出现。</span><span class="sxs-lookup"><span data-stu-id="f0efd-179">Delegation tab appears only when the user account (OlapSvc) is assigned to a service (Analysis Services), and the service has an SPN registered for it.</span></span> <span data-ttu-id="f0efd-180">SPN 注册要求该服务正在运行。</span><span class="sxs-lookup"><span data-stu-id="f0efd-180">SPN registration requires that the service is running.</span></span>  
  
     <span data-ttu-id="f0efd-181">![SSAS_Kerberos_1_AccountProperties](../media/ssas-kerberos-1-accountproperties.gif "SSAS_Kerberos_1_AccountProperties")</span><span class="sxs-lookup"><span data-stu-id="f0efd-181">![SSAS_Kerberos_1_AccountProperties](../media/ssas-kerberos-1-accountproperties.gif "SSAS_Kerberos_1_AccountProperties")</span></span>  
  
3.  <span data-ttu-id="f0efd-182">在“添加服务”页上，单击 **“用户或计算机”**。</span><span class="sxs-lookup"><span data-stu-id="f0efd-182">On the Add Services page, click **Users or Computers**.</span></span>  
  
     <span data-ttu-id="f0efd-183">![SSAS_Kerberos_2_](../media/ssas-kerberos-2.gif "SSAS_Kerberos_2_")</span><span class="sxs-lookup"><span data-stu-id="f0efd-183">![SSAS_Kerberos_2_](../media/ssas-kerberos-2.gif "SSAS_Kerberos_2_")</span></span>  
  
4.  <span data-ttu-id="f0efd-184">在“选择用户或计算机”页上，输入用于运行 SQL Server 实例并且向 Analysis Services 表格模型数据库提供数据的帐户。</span><span class="sxs-lookup"><span data-stu-id="f0efd-184">On the Select Users or Computer page, enter the account used to run the SQL Server instance providing data to Analysis Services tabular model databases.</span></span> <span data-ttu-id="f0efd-185">单击 **“确定”** 接受该服务帐户。</span><span class="sxs-lookup"><span data-stu-id="f0efd-185">Click **OK** to accept the service account.</span></span>  
  
     <span data-ttu-id="f0efd-186">如果您不能选择想要的帐户，则确认 SQL Server 正在运行并且为该帐户注册了 SPN。</span><span class="sxs-lookup"><span data-stu-id="f0efd-186">If you cannot select the account you want, verify that SQL Server is running and has an SPN registered for that account.</span></span> <span data-ttu-id="f0efd-187">有关针对数据库引擎的 SPN 的详细信息，请参阅 [Register a Service Principal Name for Kerberos Connections](../../database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections.md)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-187">For more information about SPNs for the database engine, see [Register a Service Principal Name for Kerberos Connections](../../database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections.md).</span></span>  
  
     <span data-ttu-id="f0efd-188">![SSAS_Kerberos_3_SelectUsers](../media/ssas-kerberos-3-selectusers.gif "SSAS_Kerberos_3_SelectUsers")</span><span class="sxs-lookup"><span data-stu-id="f0efd-188">![SSAS_Kerberos_3_SelectUsers](../media/ssas-kerberos-3-selectusers.gif "SSAS_Kerberos_3_SelectUsers")</span></span>  
  
5.  <span data-ttu-id="f0efd-189">该 SQL Server 实例现在应出现在“添加服务”中。</span><span class="sxs-lookup"><span data-stu-id="f0efd-189">The SQL Server instance should now appear in Add Services.</span></span> <span data-ttu-id="f0efd-190">也在使用该帐户的任何服务也将出现在该列表中。</span><span class="sxs-lookup"><span data-stu-id="f0efd-190">Any service also using that account will also appear in the list.</span></span> <span data-ttu-id="f0efd-191">选择您要使用的 SQL Server 实例。</span><span class="sxs-lookup"><span data-stu-id="f0efd-191">Choose the SQL Server instance you want to use.</span></span> <span data-ttu-id="f0efd-192">单击 **“确定”** 接受该实例。</span><span class="sxs-lookup"><span data-stu-id="f0efd-192">Click **OK** to accept the instance.</span></span>  
  
     <span data-ttu-id="f0efd-193">![SSAS_Kerberos_4_](../media/ssas-kerberos-4.gif "SSAS_Kerberos_4_")</span><span class="sxs-lookup"><span data-stu-id="f0efd-193">![SSAS_Kerberos_4_](../media/ssas-kerberos-4.gif "SSAS_Kerberos_4_")</span></span>  
  
6.  <span data-ttu-id="f0efd-194">该 Analysis Services 服务帐户的属性页现在应类似于以下屏幕快照。</span><span class="sxs-lookup"><span data-stu-id="f0efd-194">The properties page of the Analysis Services service account should now look similar to the following screenshot.</span></span> <span data-ttu-id="f0efd-195">\*\*\*\* 单击“确定”以保存你的更改。</span><span class="sxs-lookup"><span data-stu-id="f0efd-195">Click **OK** to save your changes.</span></span>  
  
     <span data-ttu-id="f0efd-196">![SSAS_Kerberos_5_Finished](../media/ssas-kerberos-5-finished.gif "SSAS_Kerberos_5_Finished")</span><span class="sxs-lookup"><span data-stu-id="f0efd-196">![SSAS_Kerberos_5_Finished](../media/ssas-kerberos-5-finished.gif "SSAS_Kerberos_5_Finished")</span></span>  
  
7.  <span data-ttu-id="f0efd-197">通过基于不同标识从远程客户端计算机进行连接来测试委托是否成功和查询表格模型。</span><span class="sxs-lookup"><span data-stu-id="f0efd-197">Test for successful delegation by connecting from a remote client computer, under a different identity, and query the tabular model.</span></span> <span data-ttu-id="f0efd-198">您应在 SQL Server Profiler 中看到针对请求的用户标识。</span><span class="sxs-lookup"><span data-stu-id="f0efd-198">You should see the user identity on the request in SQL Server Profiler.</span></span>  
  
##  <a name="test-for-impersonated-or-delegated-identity"></a><a name="bkmk_test"></a><span data-ttu-id="f0efd-199">测试模拟或委托的标识</span><span class="sxs-lookup"><span data-stu-id="f0efd-199">Test for impersonated or delegated identity</span></span>  
 <span data-ttu-id="f0efd-200">使用 SQL Server Profiler 可监视正查询数据的用户的标识。</span><span class="sxs-lookup"><span data-stu-id="f0efd-200">Use SQL Server Profiler to monitor the identity of the user who is querying data.</span></span>  
  
1.  <span data-ttu-id="f0efd-201">在 Analysis Services 实例上启动 **SQL Server Profiler** ，然后开始一个新跟踪。</span><span class="sxs-lookup"><span data-stu-id="f0efd-201">Start **SQL Server Profiler** on the Analysis Services instance and then start a new trace.</span></span>  
  
2.  <span data-ttu-id="f0efd-202">在“事件选择”中，确认在“安全审核”部分中选中了 `Audit Login` 和 `Audit Logout`。</span><span class="sxs-lookup"><span data-stu-id="f0efd-202">In Events Selection, verify that `Audit Login` and `Audit Logout` are checked in the Security Audit section.</span></span>  
  
3.  <span data-ttu-id="f0efd-203">通过某一应用程序服务（例如 SharePoint 或 Reporting Services）从远程客户端计算机连接到 Analysis Services。</span><span class="sxs-lookup"><span data-stu-id="f0efd-203">Connect to Analysis Services via an application service (such as SharePoint or Reporting Services) from a remote client computer.</span></span> <span data-ttu-id="f0efd-204">Audit Login 事件将显示连接到 Analysis Services 的用户的标识。</span><span class="sxs-lookup"><span data-stu-id="f0efd-204">The Audit Login event will show the identity of the user connecting to Analysis Services.</span></span>  
  
 <span data-ttu-id="f0efd-205">彻底的测试将要求使用可捕获网络上的 Kerberos 请求和响应的网络监视工具。</span><span class="sxs-lookup"><span data-stu-id="f0efd-205">Thorough testing will require the use of network monitoring tools that can capture Kerberos requests and responses on the network.</span></span> <span data-ttu-id="f0efd-206">针对 Kerberos 筛选的网络监视器实用工具 (netmon.exe) 可用于此任务。</span><span class="sxs-lookup"><span data-stu-id="f0efd-206">The Network Monitor utility (netmon.exe), filtered for Kerberos, can be used for this task.</span></span> <span data-ttu-id="f0efd-207">有关使用 Netmon 3.4 和测试 Kerberos 身份验证所用的其他工具的详细信息，请参阅 [配置 Kerberos 身份验证：核心配置 (SharePoint Server 2010)](https://technet.microsoft.com/library/gg502602\(v=office.14\).aspx)。</span><span class="sxs-lookup"><span data-stu-id="f0efd-207">For more information about using Netmon 3.4 and other tools for testing Kerberos authentication, see [Configuring Kerberos authentication: Core configuration (SharePoint Server 2010)](https://technet.microsoft.com/library/gg502602\(v=office.14\).aspx).</span></span>  
  
 <span data-ttu-id="f0efd-208">另外，请参阅 [Active Directory 中最易令人混淆的对话框](https://www.itprotoday.com/active-directory/most-confusing-dialog-box-active-directory) ，查看对 Active Directory 对象的属性对话框的“委托”选项卡中对每个选项的详尽描述。</span><span class="sxs-lookup"><span data-stu-id="f0efd-208">Additionally, see [The Most Confusing Dialog Box in Active Directory](https://www.itprotoday.com/active-directory/most-confusing-dialog-box-active-directory) for a thorough description of each option in the Delegation tab of the Active Directory object's property dialog box.</span></span> <span data-ttu-id="f0efd-209">这篇文章也说明了如何使用 LDP 测试和解释测试结果。</span><span class="sxs-lookup"><span data-stu-id="f0efd-209">This article also explains how to use LDP to test and interpret test results.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="f0efd-210">另请参阅</span><span class="sxs-lookup"><span data-stu-id="f0efd-210">See Also</span></span>  
 <span data-ttu-id="f0efd-211">[Microsoft BI 身份验证和身份委托](https://go.microsoft.com/fwlink/?LinkID=286576) </span><span class="sxs-lookup"><span data-stu-id="f0efd-211">[Microsoft BI Authentication and Identity Delegation](https://go.microsoft.com/fwlink/?LinkID=286576) </span></span>  
 <span data-ttu-id="f0efd-212">[使用 Kerberos 的相互身份验证](https://go.microsoft.com/fwlink/?LinkId=299283) </span><span class="sxs-lookup"><span data-stu-id="f0efd-212">[Mutual Authentication Using Kerberos](https://go.microsoft.com/fwlink/?LinkId=299283) </span></span>  
 <span data-ttu-id="f0efd-213">[连接到 Analysis Services](connect-to-analysis-services.md) </span><span class="sxs-lookup"><span data-stu-id="f0efd-213">[Connect to Analysis Services](connect-to-analysis-services.md) </span></span>  
 <span data-ttu-id="f0efd-214">[Analysis Services 实例的 SPN 注册](spn-registration-for-an-analysis-services-instance.md) </span><span class="sxs-lookup"><span data-stu-id="f0efd-214">[SPN registration for an Analysis Services instance](spn-registration-for-an-analysis-services-instance.md) </span></span>  
 [<span data-ttu-id="f0efd-215">连接字符串属性 (Analysis Services)</span><span class="sxs-lookup"><span data-stu-id="f0efd-215">Connection String Properties &#40;Analysis Services&#41;</span></span>](connection-string-properties-analysis-services.md)  
  
  
